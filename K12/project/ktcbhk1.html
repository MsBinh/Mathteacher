<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<title>GI·ªÆA K·ª≤ 1 ƒê·ªÄ 1</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta name="description" content="H·ªá th·ªëng d·∫°y h·ªçc To√°n tr·ª±c tuy·∫øn ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng - L·ªõp To√°n Th·∫ßy B√¨nh">
<meta name="keywords" content="to√°n, h·ªçc tr·ª±c tuy·∫øn, l·ªõp 12, √¥n thi, firebase, real-time, canvas, b·∫£ng v·∫Ω">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

<!-- MathJax -->
<script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']]
      },
      svg: { fontCache: 'global' },
      startup: {
        ready: function () {
          MathJax.startup.defaultReady();
          MathJax.startup.promise.then(() => {
            console.log('MathJax ready');
          });
        }
      }
    };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ===== RESET & BASE ===== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #333;
    min-height: 100vh;
}

/* ===== TOPBAR ===== */
.topbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 70px;
    background: linear-gradient(135deg, #1a237e, #283593);
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 25px;
    z-index: 10000;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border-bottom: 3px solid #3949ab;
}

.topbar-title {
    font-size: 1.4rem;
    font-weight: bold;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 10px;
}

.topbar-title::before {
    content: "üßÆ";
    font-size: 1.6rem;
}

.topbar-controls {
    display: flex;
    align-items: center;
    gap: 12px;
}

.topbar-controls select,
.topbar-controls button {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    background: rgba(255,255,255,0.15);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    border: 1px solid rgba(255,255,255,0.1);
}

.topbar-controls select:hover,
.topbar-controls button:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.topbar-controls select option {
    background: #283593;
    color: white;
}

/* ===== SCROLL PROGRESS ===== */
.scroll-progress {
    position: fixed;
    top: 70px;
    left: 0;
    width: 100%;
    height: 3px;
    background: #e0e0e0;
    z-index: 9999;
}

.scroll-progress-bar {
    height: 100%;
    background: linear-gradient(135deg, #1a237e, #3949ab);
    width: 0%;
    transition: width 0.3s ease;
}

/* ===== PAGE CONTAINER (SCROLL MODE) ===== */
.page-container {
    position: fixed;
    top: 73px; /* topbar + progress */
    left: 0;
    right: 0;
    bottom: 0;
    background: white;
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -5px 30px rgba(0,0,0,0.1);
    overflow-y: auto;
    padding: 20px;
    z-index: 1;
}

/* ===== SLIDES CONTAINER ===== */
.slides {
    font-size: 1.4rem;
    color: #2c3e50;
    max-width: 1200px;
    margin: 0 auto;
    padding-bottom: 50px;
}

/* ===== SLIDE SECTIONS (thay th·∫ø Reveal slides) ===== */
.slide-section {
    padding: 30px 40px;
    margin-bottom: 20px;
    background: linear-gradient(135deg, #f8f9ff 0%, #eef1ff 100%);
    border-radius: 14px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
    min-height: 200px;
}

.slide-section.active-section {
    background: linear-gradient(135deg, #f0f2ff 0%, #e6e9ff 100%);
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    border-left: 6px solid #ffd54f;
    transform: translateY(-2px);
}

.slide-section h2 {
    color: #1a237e;
    margin-bottom: 25px;
    border-bottom: 3px solid #1a237e;
    padding-bottom: 15px;
    font-weight: 700;
}

.slide-section h3 {
    color: #3949ab;
    margin: 20px 0 15px 0;
    font-weight: 600;
}

.slide-section p, .slide-section li {
    color: #34495e;
    line-height: 1.6;
    margin-bottom: 15px;
}

.slide-section ul, .slide-section ol {
    margin-left: 30px;
    margin-bottom: 20px;
}

/* ===== QUESTION STYLES ===== */
.question {
    margin: 25px 0;
    padding: 20px;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
    border-radius: 15px;
    border-left: 6px solid #1a237e;
    color: #2c3e50;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    transition: transform 0.3s ease;
}

.question:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
}

.question-title {
    margin-bottom: 20px;
    font-weight: 700;
    color: #1a237e;
    font-size: 1.1em;
    line-height: 1.5;
}

.option-row {
    margin: 12px 0;
    padding: 12px 15px;
    background: rgba(255,255,255,0.9);
    border-radius: 10px;
    color: #2c3e50;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
}

.option-row:hover {
    background: rgba(255,255,255,1);
    border-color: #1a237e;
    transform: translateX(5px);
}

.option-row label {
    margin-left: 10px;
    cursor: pointer;
    font-weight: 500;
    flex: 1;
}

.option-row input[type="radio"] {
    transform: scale(1.2);
    margin-right: 8px;
    cursor: pointer;
}

.answer-check {
    margin-top: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

.answer-check input {
    padding: 12px 15px;
    border: 2px solid #ddd;
    border-radius: 10px;
    background: white;
    color: #2c3e50;
    width: 250px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.answer-check input:focus {
    outline: none;
    border-color: #1a237e;
    box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
}

.answer-check button {
    padding: 12px 25px;
    background: linear-gradient(135deg, #1a237e, #3949ab);
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.answer-check button:hover {
    background: linear-gradient(135deg, #3949ab, #1a237e);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(26, 35, 126, 0.3);
}

/* ===== SLIDE MENU ===== */
.slide-menu {
    position: fixed;
    top: 0;
    left: -400px;
    width: 400px;
    height: 100vh;
    background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
    z-index: 11000;
    transition: left 0.4s ease;
    box-shadow: 5px 0 25px rgba(0,0,0,0.3);
    color: white;
}

.slide-menu.active {
    left: 0;
}

.menu-header {
    padding: 25px;
    background: rgba(0,0,0,0.2);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid rgba(255,255,255,0.1);
}

.menu-header h3 {
    color: white;
    margin: 0;
    font-size: 1.4rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 2rem;
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    transition: background 0.3s ease;
}

.close-btn:hover {
    background: rgba(255,255,255,0.1);
}

.menu-content {
    padding: 20px;
    height: calc(100% - 80px);
    overflow-y: auto;
}

.slide-item {
    padding: 15px 20px;
    margin-bottom: 10px;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: white;
    border: 1px solid rgba(255,255,255,0.1);
}

.slide-item:hover {
    background: rgba(255,255,255,0.2);
    transform: translateX(10px);
}

.slide-item.active {
    background: rgba(255,255,255,0.25);
    border-left: 5px solid #ffd54f;
    font-weight: 600;
}

.slide-number {
    display: inline-block;
    width: 35px;
    height: 35px;
    text-align: center;
    line-height: 35px;
    margin-right: 15px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    font-weight: bold;
}

.menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 10500;
    display: none;
    backdrop-filter: blur(5px);
}

.menu-overlay.active {
    display: block;
}

/* ===== CANVAS DRAWING ===== */
#drawCanvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9000;
    display: none;
    pointer-events: none;
    background: transparent;
}

.toolbar {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.9);
    padding: 15px 25px;
    border-radius: 15px;
    display: none;
    align-items: center;
    gap: 15px;
    z-index: 9100;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
}

.toolbar select,
.toolbar input,
.toolbar button {
    padding: 8px 15px;
    border: none;
    border-radius: 8px;
    background: white;
    color: #333;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
}

.toolbar select:hover,
.toolbar input:hover,
.toolbar button:hover {
    background: #f0f0f0;
    transform: translateY(-2px);
}

.toolbar input[type="color"] {
    padding: 4px;
    height: 40px;
    width: 60px;
}

.toolbar input[type="range"] {
    width: 100px;
}

/* ===== MODAL SYSTEM ===== */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 12000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    color: #333;
    padding: 30px;
    border-radius: 20px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.2);
    animation: modalAppear 0.4s ease;
    position: relative;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-content-scrollable {
    max-width: 900px;
    display: flex;
    flex-direction: column;
    max-height: 85vh;
    overflow-y: hidden;
}

.modal-close {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.modal-close:hover {
    background: #f0f0f0;
    color: #333;
}

@keyframes modalAppear {
    from {
        opacity: 0;
        transform: scale(0.8) translateY(-50px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

/* ===== TABLES ===== */
.table-container {
    max-height: 60vh;
    overflow-y: auto;
    border-radius: 15px;
    border: 2px solid #f0f0f0;
    position: relative;
}

.table-container::-webkit-scrollbar {
    width: 8px;
}

.table-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.table-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

.table-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

th, td {
    padding: 15px;
    border: 1px solid #e0e0e0;
    text-align: left;
    color: #333;
}

th {
    background: linear-gradient(135deg, #1a237e, #3949ab);
    color: white;
    position: sticky;
    top: 0;
    font-weight: 600;
    z-index: 10;
}

tr:nth-child(even) {
    background: #f8f9ff;
}

tr:hover {
    background: #e8eaff;
    transform: scale(1.01);
    transition: all 0.2s ease;
}

/* ===== TEACHER MONITOR ===== */
#teacher-monitor {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 25px 80px rgba(0,0,0,0.3);
    z-index: 20000;
    width: 95vw;
    height: 85vh;
    overflow: auto;
    color: #333;
    border: 1px solid rgba(255,255,255,0.2);
}

/* ===== FIREBASE STATUS ===== */
.firebase-status {
    position: fixed;
    top: 75px;
    right: 15px;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.85rem;
    z-index: 10001;
    font-weight: 600;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
}

.firebase-connected {
    background: rgba(40, 167, 69, 0.9);
    color: white;
}

.firebase-disconnected {
    background: rgba(220, 53, 69, 0.9);
    color: white;
}

/* ===== NOTIFICATION SYSTEM ===== */
.notification {
    position: fixed;
    top: 80px;
    right: 20px;
    padding: 15px 25px;
    border-radius: 10px;
    color: white;
    font-weight: 600;
    z-index: 100000;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    transform: translateX(400px);
    transition: transform 0.4s ease;
}

.notification.show {
    transform: translateX(0);
}

.notification.success {
    background: linear-gradient(135deg, #28a745, #20c997);
}

.notification.error {
    background: linear-gradient(135deg, #dc3545, #c82333);
}

.notification.warning {
    background: linear-gradient(135deg, #ffc107, #e0a800);
    color: #000;
}

.notification.info {
    background: linear-gradient(135deg, #17a2b8, #138496);
}

/* ===== SOLUTION BOX ===== */
.solution-title {
    color: #1976d2;
    font-weight: 700;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.solution-title::before {
    content: "üí°";
    font-size: 1.2em;
}

.solution-content {
    color: #1565c0;
    line-height: 1.6;
}

.solution-box { 
    display: none; 
}

/* ===== OPTION ICON ===== */
.option-icon {
    margin-left: 10px;
    font-weight: bold;
    font-size: 1.1em;
    min-width: 20px;
    display: inline-block;
}

/* ===== CONFIRM MODAL ===== */
.confirm-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 13000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.confirm-modal.active {
    display: flex;
}

.confirm-content {
    background: white;
    padding: 30px;
    border-radius: 15px;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.confirm-content h3 {
    color: #1a237e;
    margin-bottom: 15px;
}

.confirm-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
}

.confirm-buttons button {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.confirm-yes {
    background: #dc3545;
    color: white;
}

.confirm-no {
    background: #6c757d;
    color: white;
}

.confirm-yes:hover {
    background: #c82333;
    transform: translateY(-2px);
}

.confirm-no:hover {
    background: #5a6268;
    transform: translateY(-2px);
}

/* ===== BUTTON VISIBILITY BY ROLE ===== */
body.student-role #classManagementBtn,
body.student-role #teacherMonitorBtn,
body.student-role #create-class-btn,
body.student-role #assign-student-btn-main,
body.student-role #view-student-codes-btn {
    display: none !important;
}

body.teacher-role #classManagementBtn,
body.teacher-role #teacherMonitorBtn,
body.teacher-role #create-class-btn,
body.teacher-role #assign-student-btn-main,
body.teacher-role #view-student-codes-btn {
    display: inline-block !important;
}

/* ===== DARK MODE ===== */
.dark-mode body,
.dark-mode .page-container {
    background: #000 !important;
    color: #fff !important;
}

.dark-mode .slide-section {
    background: rgba(20, 20, 20, 0.9) !important;
    color: #fff !important;
    border-left: 6px solid #00bcd4 !important;
}

.dark-mode .slide-section h1,
.dark-mode .slide-section h2,
.dark-mode .slide-section h3,
.dark-mode .slide-section p,
.dark-mode .slide-section li,
.dark-mode .slide-section strong {
    color: #fff !important;
    font-weight: 700 !important;
}

.dark-mode .question {
    background: rgba(20, 20, 20, 0.9) !important;
    color: #fff !important;
    border-left: 6px solid #00bcd4 !important;
}

.dark-mode .option-row {
    background: rgba(40,40,40,0.9) !important;
    color: #fff !important;
    border: 1px solid #555 !important;
}

.dark-mode .option-row:hover {
    background: rgba(80,80,80,1) !important;
}

.dark-mode .topbar {
    background: linear-gradient(135deg, #000, #333) !important;
}

.dark-mode .topbar-controls button {
    background: rgba(255,255,255,0.15) !important;
    color: #fff !important;
}

.dark-mode .slide-menu {
    background: #111 !important;
}

.dark-mode .MathJax {
    color: #fff !important;
}

.dark-mode #toggleStyleBtn {
    background: linear-gradient(135deg, #4caf50, #2e7d32) !important;
    color: #fff !important;
}

/* ===== TABLES IN DARK MODE ===== */
.dark-mode .slide-section table {
    background: #000 !important;
    color: #fff !important;
}

.dark-mode .slide-section table th {
    background: linear-gradient(135deg, #1a237e, #3949ab) !important;
    color: #fff !important;
}

.dark-mode .slide-section table td {
    background: #111 !important;
    color: #fff !important;
}

/* ===== RESPONSIVE DESIGN ===== */
@media (max-width: 1024px) {
    .slides {
        font-size: 1.3rem !important;
    }
    .slide-section {
        padding: 15px 20px !important;
    }
}

@media (max-width: 768px) {
    .topbar {
        padding: 0 10px;
        height: auto;
        flex-direction: column;
        gap: 5px;
        padding: 10px;
    }
    
    .topbar-title {
        font-size: 1.1rem;
        padding: 5px 0;
    }
    
    .topbar-controls {
        gap: 5px;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .topbar-controls button, .topbar-controls select {
        padding: 6px 10px;
        font-size: 0.85rem;
    }
    
    .page-container {
        top: 120px;
        border-radius: 0;
        padding: 10px;
    }
    
    .scroll-progress {
        top: 120px;
    }
    
    .slide-section {
        padding: 15px !important;
        margin-bottom: 15px !important;
        border-radius: 10px;
    }
    
    .slides {
        font-size: 1.2rem !important;
    }
    
    .slide-menu { 
        width: 300px; 
        left: -300px; 
    }
    
    .modal-content {
        padding: 20px;
        width: 95%;
    }
    
    .modal-content-scrollable {
        max-width: 95%;
    }
    
    #class-management-modal .modal-content-scrollable {
        max-height: 90vh !important;
        padding: 15px !important;
    }
}

@media (max-width: 480px) {
    .slides {
        font-size: 1.1rem !important;
    }
    
    .slide-section h2 {
        font-size: 1.5em !important;
    }
    
    .answer-check input {
        width: 100%;
    }
}

/* ===== LOADING SPINNER ===== */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #1a237e;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ===== FULLSCREEN STYLES ===== */
body:fullscreen .topbar,
body:-webkit-full-screen .topbar,
body:-moz-full-screen .topbar,
body:-ms-fullscreen .topbar {
    display: none;
}

body:fullscreen .page-container,
body:-webkit-full-screen .page-container,
body:-moz-full-screen .page-container,
body:-ms-fullscreen .page-container {
    top: 0;
    height: 100vh;
    border-radius: 0;
}

body:fullscreen .scroll-progress,
body:-webkit-full-screen .scroll-progress,
body:-moz-full-screen .scroll-progress,
body:-ms-fullscreen .scroll-progress {
    top: 0;
}

/* ===== LOGIN LOCK ===== */
.not-logged-in .page-container,
.not-logged-in .topbar-controls select,
.not-logged-in .topbar-controls button:not(#loginBtn),
.not-logged-in #scoreBtn,
.not-logged-in #studentInteractBtn,
.not-logged-in #teacherMonitorBtn,
.not-logged-in #classManagementBtn {
    pointer-events: none;
    opacity: 0.5;
}

.not-logged-in .modal,
.not-logged-in .modal-content,
.not-logged-in #login-modal,
.not-logged-in #login-modal * {
    pointer-events: auto !important;
    opacity: 1 !important;
}

.not-logged-in .slide-section {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    text-align: center !important;
}
/* Th√™m v√†o cu·ªëi ph·∫ßn CSS */
/* ===== MOBILE OPTIMIZATIONS ===== */
@media (max-width: 768px) {
    /* Topbar ho√†n to√†n mobile-friendly */
    .topbar {
        height: auto;
        min-height: 70px;
        padding: 10px 15px;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .topbar-title {
        font-size: 1.2rem;
        width: 100%;
        text-align: center;
        justify-content: center;
        padding: 5px 0;
    }
    
    .topbar-controls {
        width: 100%;
        overflow-x: auto;
        padding-bottom: 5px;
        -webkit-overflow-scrolling: touch;
        justify-content: flex-start;
        gap: 8px;
    }
    
    .topbar-controls::-webkit-scrollbar {
        height: 4px;
    }
    
    .topbar-controls button, 
    .topbar-controls select {
        font-size: 0.9rem;
        padding: 8px 12px;
        white-space: nowrap;
        flex-shrink: 0;
    }
    
    /* Mobile-specific buttons */
    .mobile-only {
        display: block !important;
    }
    
    .desktop-only {
        display: none !important;
    }
    
    /* Page container adjustment */
    .page-container {
        top: 120px;
        padding: 10px;
        border-radius: 0;
    }
    
    .scroll-progress {
        top: 120px;
    }
    
    /* Slide sections mobile optimized */
    .slide-section {
        padding: 20px 15px !important;
        margin-bottom: 15px;
        border-radius: 12px;
        min-height: auto;
    }
    
    .slide-section h2 {
        font-size: 1.4rem;
        margin-bottom: 15px;
        padding-bottom: 10px;
    }
    
    .slide-section h3 {
        font-size: 1.2rem;
        margin: 15px 0 10px;
    }
    
    /* Questions mobile optimization */
    .question {
        padding: 15px;
        margin: 15px 0;
    }
    
    .question-title {
        font-size: 1rem;
        line-height: 1.5;
    }
    
    .option-row {
        padding: 10px;
        margin: 8px 0;
        flex-wrap: wrap;
    }
    
    .option-row label {
        font-size: 0.95rem;
        margin-left: 8px;
    }
    
    .option-row input[type="radio"] {
        transform: scale(1.1);
    }
    
    .answer-check {
        flex-direction: column;
        gap: 10px;
    }
    
    .answer-check input {
        width: 100% !important;
        font-size: 1rem;
        padding: 12px;
    }
    
    .answer-check button {
        width: 100%;
        padding: 12px;
    }
    
    /* Mobile slide menu */
    .slide-menu {
        width: 85vw !important;
        max-width: 320px;
        left: -85vw;
    }
    
    .slide-item {
        padding: 12px 15px;
        font-size: 0.95rem;
    }
    
    .slide-number {
        width: 30px;
        height: 30px;
        line-height: 30px;
        margin-right: 10px;
        font-size: 0.9rem;
    }
    
    /* Modal optimization for mobile */
    .modal-content {
        width: 95vw !important;
        max-width: 95vw !important;
        padding: 20px 15px;
        margin: 10px;
        border-radius: 15px;
    }
    
    .modal-content-scrollable {
        max-height: 85vh;
        padding: 15px !important;
    }
    
    /* Tables mobile optimization */
    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    table {
        min-width: 600px; /* Force horizontal scroll on small screens */
        font-size: 13px;
    }
    
    th, td {
        padding: 10px 8px;
    }
    
    /* Teacher monitor mobile */
    #teacher-monitor {
        width: 98vw;
        height: 90vh;
        padding: 15px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    
    /* Canvas toolbar mobile */
    .toolbar {
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 95vw;
        padding: 12px 15px;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
    }
    
    .toolbar select,
    .toolbar input,
    .toolbar button {
        padding: 8px 12px;
        font-size: 0.9rem;
    }
    
    /* Mobile keyboard friendly */
    input, textarea, select {
        font-size: 16px !important; /* Prevent iOS zoom */
    }
    
    /* Touch-friendly buttons */
    button, 
    .option-row,
    .slide-item {
        min-height: 44px; /* Apple's recommended minimum touch target */
    }
    
    /* Safe area for iPhone X+ */
    @supports (padding: max(0px)) {
        .page-container,
        .topbar {
            padding-left: max(15px, env(safe-area-inset-left));
            padding-right: max(15px, env(safe-area-inset-right));
        }
        
        .topbar {
            padding-top: max(10px, env(safe-area-inset-top));
        }
        
        .page-container {
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
    }
}

@media (max-width: 480px) {
    .topbar-controls {
        gap: 5px;
    }
    
    .topbar-controls button {
        padding: 8px 10px;
        font-size: 0.85rem;
        min-width: 44px;
    }
    
    .slides {
        font-size: 1.1rem !important;
    }
    
    .slide-section h2 {
        font-size: 1.3rem;
    }
    
    .question {
        padding: 12px;
    }
    
    /* Hide non-essential buttons on very small screens */
    #fullscreenBtn,
    #toggleStyleBtn {
        display: none;
    }
    
    /* Compact login form */
    #login-modal .modal-content {
        padding: 20px 15px;
    }
    
    #login-code,
    #student-name {
        font-size: 16px; /* Prevent iOS zoom */
        padding: 12px;
    }
    
    /* Mobile score display */
    #score-result {
        bottom: 70px;
        right: 10px;
        left: 10px;
        max-width: none;
        width: calc(100% - 20px);
    }
}

/* Mobile gestures support */
@media (hover: none) and (pointer: coarse) {
    /* Better touch feedback */
    button:active,
    .option-row:active,
    .slide-item:active {
        opacity: 0.7;
        transform: scale(0.98);
    }
    
    /* Disable hover effects on touch devices */
    .option-row:hover {
        transform: none;
        background: inherit;
    }
}

/* Landscape mode optimization */
@media (max-height: 500px) and (orientation: landscape) {
    .topbar {
        height: 60px;
    }
    
    .page-container {
        top: 63px;
    }
    
    .scroll-progress {
        top: 60px;
    }
    
    .slide-section {
        padding: 15px !important;
        min-height: auto;
    }
    
    .toolbar {
        bottom: 10px;
        padding: 10px 15px;
    }
}
</style>

</head>
<body class="not-logged-in">
<!-- ===== TOPBAR ===== -->
<div class="topbar">
    <div class="topbar-title">L·ªöP TO√ÅN TH·∫¶Y B√åNH</div>
    <div class="topbar-controls">
        <button id="slideMenuBtn">üìã DS B√†i</button>
        <select id="selectExam">
            <option value="mm">-- Ch·ªçn ƒë·ªÅ --</option>
            <option value="gk1de1.html">ƒê·ªÅ 1: Gi·ªØa HK1</option>
            <option value="gk1de2.html">ƒê·ªÅ 2:Gi·ªØa HK1</option>
            <option value="PTMPDT.html">PTMP:DS</option>
            <option value="hk1de7.html">ƒê·ªÅ 7: HK1</option>
        </select>
        <button id="studentInteractBtn">üéÆ T∆∞∆°ng t√°c</button>
        <button id="teacherMonitorBtn">üëÅÔ∏è Theo d√µi</button>
        <button id="loginBtn">üîë ƒêƒÉng nh·∫≠p</button>
        <button id="scoreBtn">üìä T√≠nh ƒëi·ªÉm</button>
        <button id="toggleMenu">‚úèÔ∏è B·∫£ng v·∫Ω</button>
        <button id="classManagementBtn">üè´ Qu·∫£n l√Ω L·ªõp</button>
        <button id="toggleStyleBtn">üåô Ch·∫ø ƒë·ªô t·ªëi</button>
        <button id="fullscreenBtn">üì∫ Fullscreen</button>
    </div>
</div>

<!-- Scroll Progress Bar -->
<div class="scroll-progress">
    <div class="scroll-progress-bar" id="scrollProgress"></div>
</div>

<!-- Firebase Status -->
<div id="firebaseStatus" class="firebase-status firebase-disconnected">
    <span class="loading-spinner"></span> ƒêang k·∫øt n·ªëi...
</div>

<!-- Notification -->
<div id="notification" class="notification"></div>

<!-- ===== MAIN CONTENT (SCROLL MODE) ===== -->
<div class="page-container">
    <div class="slides" id="slides-container">
        <section class="slide-section active-section" id="section-0">
            <h2 style="text-align: center; color: #666; margin-top: 50px;">
                üßÆ L·ªöP TO√ÅN TH·∫¶Y B√åNH
            </h2>
            <p style="text-align: center; color: #888; font-size: 1.2em;">
                Vui l√≤ng ƒëƒÉng nh·∫≠p v√† ch·ªçn m·ªôt ƒë·ªÅ t·ª´ menu ƒë·ªÉ b·∫Øt ƒë·∫ßu.
            </p>
        </section>
    </div>
</div>

<!-- ===== SLIDE MENU ===== -->
<div class="slide-menu" id="slideMenu">
    <div class="menu-header">
        <h3>üìã Danh s√°ch B√†i</h3>
        <button class="close-btn" id="closeSlideMenu">√ó</button>
    </div>
    <div class="menu-content">
        <div class="slide-list" id="slideList">
            <!-- Dynamic content -->
        </div>
    </div>
</div>
<div class="menu-overlay" id="menuOverlay"></div>

<!-- ===== CANVAS ===== -->
<canvas id="drawCanvas"></canvas>
<div class="toolbar" id="drawToolbar">
    <a href="index.html" title="V·ªÅ trang ch·ªß">
        <button id="homeBtn" style="font-size:22px;">üè†</button>
    </a>
    <select id="tool">
        <option value="pen">‚úèÔ∏è B√∫t</option>
        <option value="line">üìè ƒê∆∞·ªùng</option>
        <option value="rect">‚¨õ Ch·ªØ nh·∫≠t</option>
        <option value="parallelogram">‚ñ± B√¨nh h√†nh</option>
        <option value="circle">‚ö™ Tr√≤n</option>
        <option value="dashedLineBtn">‚Äì ‚Äì</option>
        <option value="ellipseBtn">‚¨≠ Elip</option>
        <option value="box">üì¶ H·ªôp 3D</option>
        <option value="pyramid3">üî∫ Ch√≥p tam gi√°c</option>
        <option value="pyramid4">üî≤ Ch√≥p t·ª© gi√°c</option>
        <option value="sphere">‚öΩ C·∫ßu</option>
    </select>
    <input id="draw-width" max="10" min="1" type="range" value="2"/>
    <input id="colorPicker" type="color" value="#6b21a8">
    <button id="undoBtn" title="Undo">‚Ü©Ô∏è</button>
    <button id="clearBtn">üßπ Xo√°</button>
    <button id="saveBtn">üíæ L∆∞u</button>
    <button id="exitBtn">‚ùå Tho√°t</button>
</div>

<!-- ===== MODALS ===== -->

<!-- Login Modal -->
<div class="modal" id="login-modal">
    <div class="modal-content">
        <button class="modal-close" id="close-modal">√ó</button>
        <h3>üîê ƒêƒÉng nh·∫≠p h·ªá th·ªëng</h3>
        <form id="code-login-form">
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">M√£ ƒëƒÉng nh·∫≠p:</label>
                <input id="login-code" placeholder="Nh·∫≠p m√£ h·ªçc sinh/gi√°o vi√™n" required type="text"/>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">H·ªç t√™n:</label>
                <input id="student-name" placeholder="Nh·∫≠p h·ªç t√™n c·ªßa b·∫°n" type="text"/>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
                <button type="submit" style="flex: 1;">üöÄ ƒêƒÉng nh·∫≠p</button>
            </div>
        </form>
        <div id="auth-status" style="margin-top: 15px;"></div>
        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
            <p style="margin: 0; font-size: 0.9em; color: #666;">
                <strong>H∆∞·ªõng d·∫´n:</strong><br>
                ‚Ä¢ Gi√°o vi√™n: c·∫•p m√£ g·ªìm m√£ v√† h·ªç t√™n<br>
                ‚Ä¢ H·ªçc sinh nh·∫≠p ch√≠nh x√°c c·∫£ 2
            </p>
        </div>
    </div>
</div>

<!-- Class Management Modal -->
<div class="modal" id="class-management-modal">
    <div class="modal-content modal-content-scrollable">
        <button class="modal-close" id="close-class-management">√ó</button>
        <h3>üè´ Qu·∫£n l√Ω L·ªõp v√† H·ªçc sinh</h3>
        
        <div style="display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap;">
            <button id="create-class-btn" style="flex: 1; min-width: 120px; padding: 12px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 10px; font-weight: 600;">
                ‚ûï T·∫°o L·ªõp M·ªõi
            </button>
            <button id="assign-student-btn-main" style="flex: 1; min-width: 120px; padding: 12px; background: linear-gradient(135deg, #17a2b8, #138496); color: white; border: none; border-radius: 10px; font-weight: 600;">
                üéì C·∫•p M√£ HS
            </button>
            <button id="view-student-codes-btn" style="flex: 1; min-width: 120px; padding: 12px; background: linear-gradient(135deg, #6f42c1, #5a2d91); color: white; border: none; border-radius: 10px; font-weight: 600;">
                üìã DS M√£ HS
            </button>
            <button id="refresh-classes-btn" style="flex: 1; min-width: 120px; padding: 12px; background: linear-gradient(135deg, #ffc107, #e0a800); color: #000; border: none; border-radius: 10px; font-weight: 600;">
                üîÑ L√†m m·ªõi
            </button>
            <button id="class-poll-btn" style="flex: 1; min-width: 120px; padding: 12px; background: linear-gradient(135deg, #ffc107, #e0a800); color: #000; border: none; border-radius: 10px; font-weight: 600;">
                üó≥Ô∏è Poll L·ªõp
            </button>
            <button id="class-sync-btn" style="flex: 1; min-width: 120px; padding: 12px; background: linear-gradient(135deg, #6f42c1, #5a2d91); color: white; border: none; border-radius: 10px; font-weight: 600;">
                üîÑ ƒê·ªìng b·ªô Slide
            </button>
            <button id="view-poll-results-btn" style="flex: 1; min-width: 120px; padding: 12px; background: linear-gradient(135deg, #17a2b8, #138496); color: white; border: none; border-radius: 10px; font-weight: 600;">
                üìä Xem K·∫øt qu·∫£ Poll
            </button>
            <button id="view-interactions-btn" style="flex: 1; min-width: 120px; padding: 12px; background: linear-gradient(135deg, #fd7e14, #e55a00); color: white; border: none; border-radius: 10px; font-weight: 600;">
                üí¨ Xem T∆∞∆°ng t√°c
            </button>
        </div>

        <!-- Class List -->
        <div style="margin-bottom: 25px;">
            <h4 style="color: #1a237e; margin-bottom: 15px;">üìö Danh s√°ch L·ªõp h·ªçc</h4>
            <div class="table-container" style="max-height: 300px;">
                <table>
                    <thead>
                        <tr>
                            <th>T√™n L·ªõp</th>
                            <th>M√£ L·ªõp</th>
                            <th>S·ªë HS</th>
                            <th>Ng√†y t·∫°o</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="classes-list-body">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                                ƒêang t·∫£i danh s√°ch l·ªõp...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Student List -->
        <div>
            <h4 style="color: #1a237e; margin-bottom: 15px;">üë• Danh s√°ch H·ªçc sinh</h4>
            <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                <input type="text" id="search-student-global" placeholder="üîç T√¨m h·ªçc sinh..." style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                <select id="filter-class" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                    <option value="all">T·∫•t c·∫£ l·ªõp</option>
                </select>
            </div>
            <div class="table-container" style="max-height: 400px;">
                <table>
                    <thead>
                        <tr>
                            <th>M√£ HS</th>
                            <th>H·ªç t√™n</th>
                            <th>L·ªõp</th>
                            <th>L·∫ßn cu·ªëi ho·∫°t ƒë·ªông</th>
                            <th>T·ªïng b√†i l√†m</th>
                            <th>ƒêi·ªÉm TB</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="students-list-body">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 20px; color: #666;">
                                ƒêang t·∫£i danh s√°ch h·ªçc sinh...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Create Class Modal -->
<div class="modal" id="create-class-modal">
    <div class="modal-content" style="max-width: 500px;">
        <button class="modal-close" id="cancel-create-class">√ó</button>
        <h3>üè´ T·∫°o L·ªõp M·ªõi</h3>
        <form id="create-class-form">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n l·ªõp:</label>
                <input type="text" id="class-name" placeholder="V√≠ d·ª•: 12A1, To√°n N√¢ng cao..." required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">M√¥ t·∫£:</label>
                <textarea id="class-description" placeholder="M√¥ t·∫£ v·ªÅ l·ªõp h·ªçc..." style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; height: 80px;"></textarea>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="submit" style="padding: 12px 25px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 8px; font-weight: 600;">
                    üè´ T·∫°o L·ªõp
                </button>
                <button type="button" id="cancel-create-class-btn" style="padding: 12px 25px; background: #6c757d; color: white; border: none; border-radius: 8px;">H·ªßy</button>
            </div>
        </form>
    </div>
</div>

<!-- Assign Student Modal -->
<div class="modal" id="assign-student-modal">
    <div class="modal-content" style="max-width: 600px;">
        <button class="modal-close" id="cancel-assign-student">√ó</button>
        <h3>üéì C·∫•p M√£ H·ªçc Sinh</h3>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ch·ªçn l·ªõp:</label>
            <select id="select-class-for-student" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                <option value="">-- Ch·ªçn l·ªõp --</option>
            </select>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Th√¥ng tin h·ªçc sinh:</label>
            <input type="text" id="student-fullname" placeholder="H·ªç v√† t√™n h·ªçc sinh" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px;">
            <input type="email" id="student-email" placeholder="Email (tu·ª≥ ch·ªçn)" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
        </div>

        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; color: #1a237e;">M√£ h·ªçc sinh s·∫Ω ƒë∆∞·ª£c t·∫°o:</h4>
            <div id="generated-student-code" style="font-family: monospace; font-size: 1.2em; font-weight: bold; color: #1a237e; background: white; padding: 10px; border-radius: 6px; text-align: center;">
                HS_XXXXXX
            </div>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button id="generate-student-code-btn" style="padding: 12px 25px; background: linear-gradient(135deg, #17a2b8, #138496); color: white; border: none; border-radius: 8px; font-weight: 600;">
                üé≤ T·∫°o M√£
            </button>
            <button id="assign-student-btn" style="padding: 12px 25px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 8px; font-weight: 600;">
                ‚úÖ C·∫•p M√£
            </button>
        </div>
    </div>
</div>

<!-- Student Codes Modal -->
<div class="modal" id="student-codes-modal">
    <div class="modal-content" style="max-width: 800px;">
        <button class="modal-close" id="close-student-codes">√ó</button>
        <h3>üìã Danh s√°ch M√£ H·ªçc Sinh</h3>
        
        <div style="display: flex; gap: 15px; margin-bottom: 20px;">
            <select id="filter-class-codes" style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                <option value="all">T·∫•t c·∫£ l·ªõp</option>
            </select>
            <button id="export-codes-btn" style="padding: 10px 20px; background: linear-gradient(135deg, #6f42c1, #5a2d91); color: white; border: none; border-radius: 8px; font-weight: 600;">
                üì§ Xu·∫•t Excel
            </button>
        </div>

        <div class="table-container" style="max-height: 500px;">
            <table>
                <thead>
                    <tr>
                        <th>M√£ HS</th>
                        <th>H·ªç t√™n</th>
                        <th>L·ªõp</th>
                        <th>Ng√†y c·∫•p</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>M·∫≠t kh·∫©u</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="student-codes-list">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px; color: #666;">
                            ƒêang t·∫£i danh s√°ch m√£ h·ªçc sinh...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div class="confirm-modal" id="confirm-delete-modal">
    <div class="confirm-content">
        <h3>‚ö†Ô∏è X√°c nh·∫≠n X√≥a</h3>
        <p id="confirm-delete-message">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?</p>
        <div class="confirm-buttons">
            <button class="confirm-yes" id="confirm-delete-yes">X√≥a</button>
            <button class="confirm-no" id="confirm-delete-no">H·ªßy</button>
        </div>
    </div>
</div>

<!-- Teacher Monitor -->
<div id="teacher-monitor">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h3 style="margin: 0; color: #1a237e;">üìä B·∫£ng theo d√µi h·ªçc sinh - REAL TIME</h3>
        <div>
            <button id="monitor-create-session" style="background: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-right: 10px;">
                üÜî T·∫°o l·ªõp
            </button>
            <button id="monitor-start-poll" style="background: #ffc107; color: black; border: none; padding: 8px 15px; border-radius: 5px; margin-right: 10px;">
                üó≥Ô∏è Poll
            </button>
            <button id="monitor-sync-slides" style="background: #6f42c1; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-right: 10px;">
                üîÑ ƒê·ªìng b·ªô
            </button>
            <button id="closeMonitor" style="background: #ff4757; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600;">
                ‚úï ƒê√≥ng
            </button>
        </div>
    </div>
    
    <div style="margin-bottom: 20px; display: flex; gap: 30px; align-items: center;">
        <div>
            <strong>M√£ l·ªõp:</strong> <code id="monitor-session-code" style="background: #1a237e; color: white; padding: 5px 10px; border-radius: 5px;">Ch∆∞a c√≥</code>
        </div>
        <div>
            <strong>H·ªçc sinh online:</strong> <span id="live-student-count" style="font-size: 1.2em; font-weight: bold; color: #1a237e;">0</span>
        </div>
    </div>

    <!-- Filter -->
    <div style="display: flex; gap: 15px; margin-bottom: 20px;">
        <input type="text" id="search-student" placeholder="üîç T√¨m theo t√™n h·ªçc sinh..." style="padding: 12px; border: 2px solid #ddd; border-radius: 10px; flex: 1; font-size: 1rem;">
        <select id="filter-status" style="padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem;">
            <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="active">ƒêang l√†m b√†i</option>
            <option value="finished">ƒê√£ ho√†n th√†nh</option>
            <option value="not-started">Ch∆∞a b·∫Øt ƒë·∫ßu</option>
        </select>
    </div>

    <!-- Results Table -->
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th style="text-align: left;">H·ªçc sinh</th>
                    <th style="text-align: center;">Tr·∫°ng th√°i</th>
                    <th style="text-align: center;">ƒêi·ªÉm s·ªë</th>
                    <th style="text-align: center;">Th·ªùi gian l√†m</th>
                    <th style="text-align: center;">Ti·∫øn ƒë·ªô</th>
                    <th style="text-align: center;">Chi ti·∫øt</th>
                </tr>
            </thead>
            <tbody id="student-results-body">
                <tr>
                    <td colspan="6" style="text-align: center; padding: 30px; color: #666;">
                        <div style="font-size: 1.2em; margin-bottom: 10px;">üìä</div>
                        Ch∆∞a c√≥ h·ªçc sinh n√†o tham gia l·ªõp h·ªçc
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Statistics -->
    <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%); border-radius: 15px; border: 2px solid #e0e0e0;">
        <h4 style="margin-top: 0; color: #1a237e; margin-bottom: 20px;">üìà Th·ªëng k√™ t·ªïng quan l·ªõp h·ªçc</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px;">
            <div style="text-align: center; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <div style="font-size: 2em; font-weight: bold; color: #17a2b8;" id="stats-total">0</div>
                <div style="font-size: 0.9em; color: #6c757d; font-weight: 600;">T·ªïng s·ªë HS</div>
            </div>
            <div style="text-align: center; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <div style="font-size: 2em; font-weight: bold; color: #28a745;" id="stats-completed">0</div>
                <div style="font-size: 0.9em; color: #6c757d; font-weight: 600;">ƒê√£ ho√†n th√†nh</div>
            </div>
            <div style="text-align: center; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <div style="font-size: 2em; font-weight: bold; color: #ffc107;" id="stats-average">0.0</div>
                <div style="font-size: 0.9em; color: #6c757d; font-weight: 600;">ƒêi·ªÉm TB</div>
            </div>
            <div style="text-align: center; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <div style="font-size: 2em; font-weight: bold; color: #dc3545;" id="stats-failed">0</div>
                <div style="font-size: 0.9em; color: #6c757d; font-weight: 600;">D∆∞·ªõi 5 ƒëi·ªÉm</div>
            </div>
        </div>
    </div>

    <!-- Poll Results Area -->
    <div id="poll-results-area" style="display: none; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
        <h4 id="poll-results-title" style="color: #1a237e; margin-bottom: 15px;">üìä K·∫øt qu·∫£ kh·∫£o s√°t</h4>
        <canvas id="pollChartInMonitor" width="700" height="300"></canvas>
        <div id="poll-stats-in-monitor" style="margin-top: 15px;"></div>
    </div>
</div>

<!-- Poll Modal -->
<div class="modal" id="poll-modal">
    <div class="modal-content">
        <button class="modal-close" id="poll-close-btn">√ó</button>
        <h3 id="poll-title">üó≥Ô∏è Kh·∫£o s√°t nhanh</h3>
        <div id="poll-options"></div>
        <div style="margin-top:20px; display:flex; justify-content:space-between;">
            <button id="poll-submit-btn" style="background:linear-gradient(135deg, #28a745, #20c997); color:#fff; font-weight: 600;">‚úÖ G·ª≠i ph·∫£n h·ªìi</button>
        </div>
    </div>
</div>

<!-- Custom Modal -->
<div class="modal" id="custom-class-modal">
    <div class="modal-content" style="max-width: 500px;">
        <button class="modal-close" onclick="hideModal(this.closest('.modal'))">√ó</button>
        <div id="custom-class-content"></div>
    </div>
</div>

<script>
// ===== FIREBASE CONFIGURATION =====
const firebaseConfig = {
    apiKey: "AIzaSyDVRsgVDCKk5lIfCRxhSlWiBetNlZBukcc",
    authDomain: "daytoantructuyen-149d9.firebaseapp.com",
    databaseURL: "https://daytoantructuyen-149d9-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "daytoantructuyen-149d9",
    storageBucket: "daytoantructuyen-149d9.firebasestorage.app",
    messagingSenderId: "258454714393",
    appId: "1:258454714393:web:bcf66624668e516934d288"
};

// ===== GLOBAL VARIABLES =====
let examList = [];
let currentExam = null;
let currentQuestions = [];
let db = null;
let auth = null;
let currentSessionId = null;
let isTeacherLoggedIn = false;
let currentUser = null;
let pollChart = null;
let studentListeners = {};
let sessionCode = '';

// Score system
window.isScoreCalculated = false;
window.studentAnswers = {};
window.correctAnswers = {};

// Student management
let studentCodesMap = new Map();
let inactiveStudents = new Set();

// Modal system
let activeModal = null;

// Scroll tracking
let scrollObserver = null;

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
    console.log("üöÄ H·ªá th·ªëng L·ªõp To√°n Th·∫ßy B√¨nh kh·ªüi ƒë·ªông (Scroll Mode)...");
    
    if (initializeFirebase()) {
        // Load exam list
        loadExamList();
        
        // Setup all systems
        setupModalSystem();
        setupAuthentication();
        setupSessionManagement();
        setupPollSystem();
        setupStudentInteraction();
        
        // Setup scroll tracking
        setupScrollTracking();
        
        // Setup controls
        setupModalControls();
        setupSlideMenu();
        setupCanvas();
        setupFullscreen();
        
        // Setup class management
        setupClassManagement();
        setupStudentCodeManagement();
        
        // Setup exam selection
        document.getElementById('selectExam').addEventListener('change', handleExamSelection);
        
        // Setup score button
        document.getElementById('scoreBtn').addEventListener('click', function() {
            window.isScoreCalculated = false;
            window.calculateFinalScore();
        });
        
        // URL session parameter
        const urlParams = new URLSearchParams(window.location.search);
        const urlSessionCode = urlParams.get('session');
        if (urlSessionCode) {
            sessionCode = urlSessionCode.toUpperCase();
            document.getElementById('monitor-session-code').textContent = sessionCode;
        }
        
        // Show welcome screen
        showWelcomeScreen();
        
        showNotification('‚úÖ H·ªá th·ªëng ƒë√£ s·∫µn s√†ng! Vui l√≤ng ƒëƒÉng nh·∫≠p v√† ch·ªçn ƒë·ªÅ thi.', 'info');
        
        console.log("‚úÖ H·ªá th·ªëng kh·ªüi ƒë·ªông th√†nh c√¥ng v·ªõi ch·∫ø ƒë·ªô cu·ªôn");
        
    } else {
        showNotification('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn c∆° s·ªü d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.', 'error');
    }
});

// ===== FIREBASE INITIALIZATION =====
function initializeFirebase() {
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        // KH√îNG C√ì auth = firebase.auth() ‚Üê X√ìA D√íNG N√ÄY N·∫æU C√ì
        
        console.log("‚úÖ Firebase initialized successfully");
        
        // Gi·ªØ nguy√™n ph·∫ßn connection status
        db.ref('.info/connected').on('value', snap => {
            const statusElement = document.getElementById('firebaseStatus');
            if (snap.val() === true) {
                statusElement.innerHTML = "‚úÖ Firebase: ƒê√£ k·∫øt n·ªëi";
                statusElement.className = "firebase-status firebase-connected";
            } else {
                statusElement.innerHTML = '<span class="loading-spinner"></span> Firebase: ƒêang k·∫øt n·ªëi...';
                statusElement.className = "firebase-status firebase-disconnected";
            }
        });
        
        return true;
    } catch (error) {
        console.error("‚ùå Firebase initialization failed:", error);
        showNotification('L·ªói kh·ªüi t·∫°o Firebase: ' + error.message, 'error');
        return false;
    }
}

// ===== SCROLL TRACKING SYSTEM =====
function setupScrollTracking() {
    // IntersectionObserver to track active section
    scrollObserver = new IntersectionObserver(
        (entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // Remove active from all sections
                    document.querySelectorAll('.slide-section').forEach(section => {
                        section.classList.remove('active-section');
                    });
                    
                    // Add active to current section
                    entry.target.classList.add('active-section');
                    
                    // Update menu
                    updateActiveSlideInMenu(entry.target);
                    
                    // Update scroll progress
                    updateScrollProgress();
                    
                    // Update student progress
                    if (!isTeacherLoggedIn && sessionCode && currentUser) {
                        updateStudentProgressFromScroll(entry.target);
                    }
                }
            });
        },
        {
            root: document.querySelector('.page-container'),
            rootMargin: '-20% 0px -60% 0px',
            threshold: 0.1
        }
    );
    
    // Scroll event for progress bar
    const pageContainer = document.querySelector('.page-container');
    if (pageContainer) {
        pageContainer.addEventListener('scroll', updateScrollProgress);
    }
}

function updateScrollProgress() {
    const pageContainer = document.querySelector('.page-container');
    if (!pageContainer) return;
    
    const scrollTop = pageContainer.scrollTop;
    const scrollHeight = pageContainer.scrollHeight - pageContainer.clientHeight;
    const scrollPercentage = (scrollTop / scrollHeight) * 100;
    
    document.getElementById('scrollProgress').style.width = scrollPercentage + '%';
}

function updateStudentProgressFromScroll(section) {
    if (!sessionCode || !currentUser || isTeacherLoggedIn) return;
    
    const sections = document.querySelectorAll('.slide-section');
    const sectionIndex = Array.from(sections).indexOf(section);
    const totalSections = sections.length;
    const progress = Math.round((sectionIndex / (totalSections - 1)) * 100);
    
    db.ref(`sessions/${sessionCode}/students/${currentUser.uid}`).update({
        currentSlide: sectionIndex, 
        progress, 
        lastActivity: firebase.database.ServerValue.TIMESTAMP
    });
}

// ===== EXAM MANAGEMENT =====
async function loadExamList() {
    try {
        const response = await fetch('exam-list.json');
        if (!response.ok) throw new Error('Kh√¥ng t√¨m th·∫•y file exam-list.json');
        
        const data = await response.json();
        examList = data.exams;
        
        const selectMenu = document.getElementById('selectExam');
        selectMenu.innerHTML = '<option value="">-- Ch·ªçn ƒë·ªÅ --</option>';
        
        examList.forEach(exam => {
            const option = document.createElement('option');
            option.value = exam.id;
            option.textContent = exam.name;
            selectMenu.appendChild(option);
        });

        console.log("‚úÖ ƒê√£ t·∫£i danh s√°ch ƒë·ªÅ:", examList.length, "ƒë·ªÅ");

    } catch (error) {
        console.error("‚ùå L·ªói t·∫£i danh s√°ch ƒë·ªÅ:", error);
        showNotification('L·ªói t·∫£i danh s√°ch ƒë·ªÅ! Vui l√≤ng ki·ªÉm tra file exam-list.json', 'error');
    }
}

async function handleExamSelection() {
    const selectMenu = document.getElementById('selectExam');
    const selectedId = selectMenu.value;
    if (!selectedId) {
        resetToWelcomeScreen();
        return;
    }

    currentExam = examList.find(exam => exam.id === selectedId);
    if (!currentExam) return;

    try {
        showNotification(`üì• ƒêang t·∫£i ƒë·ªÅ: ${currentExam.name}...`, 'info');
        const response = await fetch(currentExam.file);
        if (!response.ok) throw new Error(`Kh√¥ng t·∫£i ƒë∆∞·ª£c file ${currentExam.file}`);
        
        currentQuestions = await response.json();
        
        // Render content
        renderContent(currentQuestions);
        
        document.title = `${currentExam.name} - L·ªõp To√°n Th·∫ßy B√¨nh`;
        showNotification(`‚úÖ ƒê√£ t·∫£i ƒë·ªÅ: ${currentExam.name}`, 'success');

    } catch (error) {
        console.error("‚ùå L·ªói khi t·∫£i n·ªôi dung ƒë·ªÅ:", error);
        showNotification(`L·ªói: ${error.message}`, 'error');
        resetToWelcomeScreen();
    }
}

// ===== CONTENT RENDERING =====
function showWelcomeScreen() {
    const slidesContainer = document.getElementById('slides-container');
    if (!slidesContainer) return;
    
    slidesContainer.innerHTML = `
        <section class="slide-section active-section" id="section-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; min-height: 70vh; display: flex; flex-direction: column; justify-content: center;">
            <h1 style="color: white; border: none; font-size: 3em; margin-bottom: 20px;">üßÆ L·ªöP TO√ÅN TH·∫¶Y B√åNH</h1>
            <h3 style="color: white; margin-bottom: 40px;">H·ªá Th·ªëng D·∫°y H·ªçc Tr·ª±c Tuy·∫øn To√†n Di·ªán</h3>
            
            <div style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 20px; max-width: 800px; margin: 0 auto;">
                <h4 style="color: white; margin-bottom: 20px;">üìö H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG</h4>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                        <div style="font-size: 2em; margin-bottom: 10px;">üîë</div>
                        <h5 style="color: white; margin-bottom: 10px;">1. ƒêƒÉng nh·∫≠p</h5>
                        <p style="color: rgba(255,255,255,0.9); font-size: 0.9em;">Nh·∫•n n√∫t "ƒêƒÉng nh·∫≠p" v√† nh·∫≠p m√£ h·ªçc sinh/gi√°o vi√™n</p>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                        <div style="font-size: 2em; margin-bottom: 10px;">üìù</div>
                        <h5 style="color: white; margin-bottom: 10px;">2. Ch·ªçn ƒë·ªÅ</h5>
                        <p style="color: rgba(255,255,255,0.9); font-size: 0.9em;">Ch·ªçn ƒë·ªÅ thi t·ª´ menu "Ch·ªçn ƒë·ªÅ" tr√™n thanh c√¥ng c·ª•</p>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                        <div style="font-size: 2em; margin-bottom: 10px;">üéØ</div>
                        <h5 style="color: white; margin-bottom: 10px;">3. L√†m b√†i</h5>
                        <p style="color: rgba(255,255,255,0.9); font-size: 0.9em;">L√†m b√†i v√† ki·ªÉm tra ƒë√°p √°n tr·ª±c ti·∫øp tr√™n h·ªá th·ªëng</p>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <p style="color: rgba(255,255,255,0.9); font-size: 0.9em;">
                        <strong>Gi√°o vi√™n:</strong> C√≥ th·ªÉ qu·∫£n l√Ω l·ªõp, t·∫°o poll, ƒë·ªìng b·ªô slide<br>
                        <strong>H·ªçc sinh:</strong> C√≥ th·ªÉ t∆∞∆°ng t√°c, xem ƒëi·ªÉm, tham gia poll
                    </p>
                </div>
            </div>
        </section>
    `;
    
    setTimeout(createSlideList, 100);
}

function resetToWelcomeScreen() {
    const slidesContainer = document.getElementById('slides-container');
    slidesContainer.innerHTML = `
        <section class="slide-section active-section" id="section-0">
            <h2 style="text-align: center; color: #666; margin-top: 50px;">
                üßÆ L·ªöP TO√ÅN TH·∫¶Y B√åNH
            </h2>
            <p style="text-align: center; color: #888; font-size: 1.2em;">
                Vui l√≤ng ch·ªçn m·ªôt ƒë·ªÅ t·ª´ menu ƒë·ªÉ b·∫Øt ƒë·∫ßu.
            </p>
        </section>
    `;
    
    setTimeout(createSlideList, 100);
}

// ===== COMPLETE CONTENT RENDERER =====
function renderContent(contentData) {
    const slidesContainer = document.getElementById('slides-container');
    slidesContainer.innerHTML = '';

    console.log("üìÑ Rendering content data:", contentData);

    // CASE 1: Lesson Collection (new JSON format)
    if (contentData.type === 'lesson_collection') {
        renderLessonCollection(contentData);
        return;
    }

    // CASE 2: Old format (array of questions)
    if (Array.isArray(contentData)) {
        contentData.forEach((item, index) => {
            const section = document.createElement('section');
            section.className = 'slide-section';
            section.id = `section-${index}`;
            
            let html = '';
            
            switch(item.type) {
                case 'welcome':
                    html = renderWelcomeSection(item);
                    break;
                    
                case 'multiple_choice':
                    html = renderMultipleChoiceQuestion(item);
                    break;
                    
                case 'true_false':
                    html = renderTrueFalseQuestion(item);
                    break;
                    
                case 'short_answer':
                    html = renderShortAnswerQuestion(item);
                    break;
                    
                case 'theory':
                    html = renderTheorySection(item);
                    break;
                    
                case 'mixed_quiz':
                    html = renderMixedQuizSection(item);
                    break;
                    
                default:
                    html = `<div style="padding: 30px; text-align: center; color: #666;">
                        <p>Kh√¥ng th·ªÉ hi·ªÉn th·ªã n·ªôi dung (lo·∫°i: ${item.type})</p>
                    </div>`;
            }
            
            section.innerHTML = html;
            slidesContainer.appendChild(section);
        });
        
        // Register with IntersectionObserver
        setTimeout(() => {
            document.querySelectorAll('.slide-section').forEach(section => {
                if (scrollObserver) {
                    scrollObserver.observe(section);
                }
            });
            
            // Activate first section
            const firstSection = document.querySelector('.slide-section');
            if (firstSection) {
                firstSection.classList.add('active-section');
            }
        }, 100);
        
        // MathJax typeset
        if (window.MathJax) {
            setTimeout(() => {
                MathJax.typesetPromise();
            }, 300);
        }
        
        // Create slide menu
        createSlideList();
        
        console.log(`‚úÖ ƒê√£ render ${contentData.length} section`);
        return;
    }

    // CASE 3: Invalid data
    slidesContainer.innerHTML = `
        <section class="slide-section active-section">
            <h2 style="color: #dc3545;">‚ö†Ô∏è L·ªói d·ªØ li·ªáu</h2>
            <p>Kh√¥ng th·ªÉ hi·ªÉn th·ªã n·ªôi dung. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng file.</p>
        </section>
    `;
}

// ===== RENDER FUNCTIONS FOR EACH CONTENT TYPE =====

function renderLessonCollection(lessonData) {
    const slidesContainer = document.getElementById('slides-container');
    let html = '';
    
    // 1. Cover Page
    html += `
        <section class="slide-section active-section" style="background: linear-gradient(135deg, #1a237e, #3949ab); color: white; text-align: center;">
            <div style="max-width: 800px; margin: 0 auto; padding: 40px 20px;">
                <h1 style="color: white; border: none; font-size: 2.5em; margin-bottom: 20px;">
                    ${lessonData.title || 'Chuy√™n ƒë·ªÅ To√°n h·ªçc'}
                </h1>
                <h3 style="color: rgba(255,255,255,0.9); font-weight: normal;">
                    ${lessonData.description || ''}
                </h3>
                
                <div style="margin-top: 40px; background: rgba(255,255,255,0.1); padding: 25px; border-radius: 15px; text-align: left;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        ${lessonData.author ? `
                        <div>
                            <strong>üë®‚Äçüè´ T√°c gi·∫£:</strong><br>
                            ${lessonData.author}
                        </div>
                        ` : ''}
                        
                        ${lessonData.metadata?.total_questions ? `
                        <div>
                            <strong>üìù S·ªë c√¢u h·ªèi:</strong><br>
                            ${lessonData.metadata.total_questions}
                        </div>
                        ` : ''}
                        
                        ${lessonData.metadata?.estimated_completion_time ? `
                        <div>
                            <strong>‚è±Ô∏è Th·ªùi l∆∞·ª£ng:</strong><br>
                            ${lessonData.metadata.estimated_completion_time}
                        </div>
                        ` : ''}
                        
                        ${lessonData.metadata?.target_audience ? `
                        <div>
                            <strong>üéØ ƒê·ªëi t∆∞·ª£ng:</strong><br>
                            ${lessonData.metadata.target_audience}
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <div style="margin-top: 40px;">
                    <button onclick="scrollToSection(1)" style="padding: 15px 30px; background: white; color: #1a237e; border: none; border-radius: 10px; font-size: 1.1em; font-weight: bold; cursor: pointer;">
                        üöÄ B·∫Øt ƒë·∫ßu h·ªçc
                    </button>
                </div>
            </div>
        </section>
    `;
    
    // 2. Render each section
    if (lessonData.sections && Array.isArray(lessonData.sections)) {
        lessonData.sections.forEach((section, sectionIndex) => {
            html += renderCollectionSection(section, sectionIndex + 1);
        });
    }
    
    slidesContainer.innerHTML = html;
    
    // Initialize
    setTimeout(() => {
        document.querySelectorAll('.slide-section').forEach(section => {
            if (scrollObserver) {
                scrollObserver.observe(section);
            }
        });
        
        MathJax.typesetPromise();
        createSlideList();
    }, 100);
}

function renderCollectionSection(section, sectionNumber) {
    let html = `
        <section class="slide-section" id="section-${sectionNumber}">
            <div style="background: linear-gradient(135deg, #f8f9ff, #eef1ff); padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                <h2 style="color: #1a237e; border-bottom: 3px solid #1a237e; padding-bottom: 10px;">
                    ${sectionNumber}. ${section.title || `Ch∆∞∆°ng ${sectionNumber}`}
                </h2>
                ${section.description ? `<p style="color: #666; font-size: 1.1em; margin-top: 10px;">${section.description}</p>` : ''}
            </div>
    `;
    
    // Render content items
    if (section.content && Array.isArray(section.content)) {
        section.content.forEach((item, itemIndex) => {
            const uniqueId = `s${sectionNumber}-i${itemIndex}`;
            html += renderCollectionContentItem(item, uniqueId);
        });
    }
    
    html += `</section>`;
    return html;
}

function renderCollectionContentItem(item, uniqueId) {
    let html = '<div style="margin-bottom: 30px;">';
    
    switch(item.type) {
        case 'definition':
            html += `
                <div class="theory-box" style="background: #e8f4f8; padding: 20px; border-radius: 12px; border-left: 5px solid #17a2b8;">
                    <h4 style="color: #17a2b8; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <span>üìò</span> ${item.title || 'ƒê·ªãnh nghƒ©a'}
                    </h4>
                    <div style="line-height: 1.6;">
                        ${item.content || ''}
                        ${item.formula ? `<div style="text-align: center; margin: 15px 0; font-size: 1.1em;">${item.formula}</div>` : ''}
                        ${item.note ? `<div style="background: rgba(255,255,255,0.7); padding: 10px; border-radius: 8px; margin-top: 10px;"><strong>Ch√∫ √Ω:</strong> ${item.note}</div>` : ''}
                    </div>
                </div>
            `;
            break;
            
        case 'theorem':
            html += `
                <div class="theory-box" style="background: #f0f7ff; padding: 20px; border-radius: 12px; border-left: 5px solid #4dabf7;">
                    <h4 style="color: #1c7ed6; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <span>üìñ</span> ${item.title || 'ƒê·ªãnh l√Ω'}
                    </h4>
                    ${item.content ? `<p style="margin-bottom: 15px;">${item.content}</p>` : ''}
                    
                    ${item.statements && Array.isArray(item.statements) ? `
                        <div style="margin: 15px 0;">
                            ${item.statements.map((stmt, idx) => `
                                <div style="margin-bottom: 10px; padding: 12px; background: white; border-radius: 8px;">
                                    <strong>${idx + 1}.</strong> ${stmt.content}
                                    ${stmt.proof ? `<div style="margin-top: 8px; padding-left: 20px; color: #666; font-size: 0.95em;"><em>Ch·ª©ng minh:</em> ${stmt.proof}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${item.note ? `<div style="background: rgba(255,255,255,0.7); padding: 10px; border-radius: 8px; margin-top: 15px;"><strong>Nh·∫≠n x√©t:</strong> ${item.note}</div>` : ''}
                </div>
            `;
            break;
            
        case 'true_false_quiz':
            html += renderTrueFalseQuizItem(item, uniqueId);
            break;
            
        case 'multiple_choice':
            html += renderMultipleChoiceSetItem(item, uniqueId);
            break;
            
        case 'short_answer':
            html += renderShortAnswerSetItem(item, uniqueId);
            break;
            
        case 'method':
            html += renderMethodItem(item, uniqueId);
            break;
            
        case 'mixed_quiz':
            html += renderMixedQuizItem(item, uniqueId);
            break;
            
        default:
            html += `<div style="color: #666; padding: 20px; text-align: center; background: #f8f9fa; border-radius: 10px;">
                Kh√¥ng th·ªÉ hi·ªÉn th·ªã lo·∫°i n·ªôi dung: ${item.type}
            </div>`;
    }
    
    html += '</div>';
    return html;
}

// ===== INDIVIDUAL RENDER FUNCTIONS =====

function renderWelcomeSection(item) {
    return `
        <div style="text-align: center; padding: 40px 20px;">
            <h1 style="color: ${item.color || '#1a237e'}; border: none; font-size: 2.5em;">
                ${item.title || 'Ch√†o m·ª´ng'}
            </h1>
            <h3 style="color: ${item.color || '#3949ab'};">${item.subtitle || ''}</h3>
            <div style="margin-top: 30px; font-size: 1.1em;">
                ${item.content || ''}
            </div>
            ${item.extraContent || ''}
        </div>
    `;
}

function renderMultipleChoiceQuestion(item) {
    let optionsHtml = '';
    for (const [key, value] of Object.entries(item.options || {})) {
        optionsHtml += `
            <div class="option-row">
                <input type="radio" name="${item.id}" value="${key}" id="${item.id}${key}">
                <label for="${item.id}${key}">${key}. ${value}</label>
                <span class="option-icon" id="icon-${item.id}-${key}"></span>
            </div>
        `;
    }
    
    let solutionHtml = '';
    if (item.solution) {
        solutionHtml = `
            <button onclick="toggleSolution('${item.id}')" style="margin-top: 10px; padding: 8px 15px; background: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer;">
                üëÅÔ∏è Xem gi·∫£i
            </button>
            <div id="solution-${item.id}" class="solution-box" style="display: none;">
                <div class="solution-title">H∆∞·ªõng d·∫´n gi·∫£i ${item.title}</div>
                <div class="solution-content">${item.solution}</div>
            </div>
        `;
    }
    
    return `
        <div class="question" id="${item.id}">
            <p class="question-title"><strong>${item.title}</strong> ${item.text}</p>
            ${item.image ? `<img src="${item.image}" style="max-width: 100%; margin: 15px 0; border-radius: 10px;">` : ''}
            <div class="options">${optionsHtml}</div>
            <div class="answer-check">
                <button onclick="checkAnswer('${item.id}', '${item.correct}')">‚úÖ Ki·ªÉm tra</button>
                <span id="result-${item.id}"></span>
            </div>
            ${solutionHtml}
        </div>
    `;
}

function renderTrueFalseQuestion(item) {
    // 1. T·∫°o danh s√°ch m·ªánh ƒë·ªÅ
    let statementsHtml = '';
    if (Array.isArray(item.statements)) {
        item.statements.forEach((stmt, idx) => {
            const letter = String.fromCharCode(97 + idx); // a, b, c, d

            statementsHtml += `
                <div class="option-row">
                    <div style="flex: 1;">
                        <strong>${letter})</strong> ${stmt}
                    </div>

                    <div style="display: flex; gap: 15px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="${item.id}_${letter}" value="True">
                            True
                        </label>

                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="${item.id}_${letter}" value="False">
                            False
                        </label>
                    </div>
                </div>
            `;
        });
    }

    // 2. T·∫°o ph·∫ßn xem l·ªùi gi·∫£i (n·∫øu c√≥)
    let solutionHtml = '';
    if (item.solution) {
        solutionHtml = `
            <button onclick="toggleSolution('${item.id}')" 
                style="margin-top: 10px; padding: 8px 15px; background: #17a2b8; 
                       color: white; border: none; border-radius: 5px;">
                üëÅÔ∏è Xem gi·∫£i
            </button>

            <div id="solution-${item.id}" class="solution-box" style="display: none;">
                <div class="solution-title">H∆∞·ªõng d·∫´n gi·∫£i ${item.title}</div>
                <div class="solution-content">${item.solution}</div>
            </div>
        `;
    }

    // 3. ƒê√ÅP √ÅN: Truy·ªÅn d∆∞·ªõi d·∫°ng JSON TH·∫¨T (kh√¥ng d√πng chu·ªói!)
    const answersArray = JSON.stringify(item.answers);  
    // ‚Üí Khi render s·∫Ω th√†nh: ["True","True","True","False"]

    return `
        <div class="question" id="${item.id}">
            <p class="question-title">
                <strong>${item.title}</strong> ${item.text}
            </p>

            ${item.image ? 
                `<img src="${item.image}" style="max-width:100%; margin: 15px 0; border-radius:10px;" 
                      onerror="this.style.display='none'">` 
            : ''}

            <div class="options">${statementsHtml}</div>

            <div class="answer-check">
                <button onclick='checkTrueFalseAnswer("${item.id}", ${answersArray})'>
                    ‚úÖ Ki·ªÉm tra
                </button>
                <span id="result-${item.id}"></span>
            </div>

            ${solutionHtml}
        </div>
    `;
}

function renderShortAnswerQuestion(item) {
    return `
        <div class="question" id="${item.id}">
            <p class="question-title"><strong>${item.title}</strong> ${item.text}</p>
            ${item.image ? `<img src="${item.image}" style="max-width: 100%; margin: 15px 0; border-radius: 10px;">` : ''}
            <div class="answer-check">
                <input id="input-${item.id}" placeholder="${item.placeholder || 'Nh·∫≠p k·∫øt qu·∫£...'}" type="text"/>
                <button onclick="checkShortAnswer('${item.id}', '${item.answer || ''}')">‚úÖ Ki·ªÉm tra</button>
                <span id="icon-${item.id}"></span>
            </div>
            <div id="result-${item.id}"></div>
            ${item.solution ? `
                <button onclick="toggleSolution('${item.id}')" style="margin-top: 10px; padding: 8px 15px; background: #17a2b8; color: white; border: none; border-radius: 5px;">
                    üëÅÔ∏è Xem gi·∫£i
                </button>
                <div id="solution-${item.id}" class="solution-box" style="display: none;">
                    <div class="solution-title">H∆∞·ªõng d·∫´n gi·∫£i ${item.title}</div>
                    <div class="solution-content">${item.solution}</div>
                </div>
            ` : ''}
        </div>
    `;
}

function renderTheorySection(item) {
    return `
        <div class="question" id="${item.id}">
            <h3 style="color: #1a237e; border-bottom: 3px solid #1a237e; padding-bottom: 10px;">
                ${item.title}
            </h3>
            <div style="font-size: 1.1em; line-height: 1.6; margin-top: 20px;">
                ${item.content}
            </div>
            ${item.example ? `
                <div class="solution-box" style="margin-top: 30px;">
                    <div class="solution-title">üìö V√≠ d·ª• minh h·ªça</div>
                    <div class="solution-content">${item.example}</div>
                </div>
            ` : ''}
        </div>
    `;
}

// ===== NEW FORMAT RENDERERS =====

function renderTrueFalseQuizItem(quizData, uniqueId) {
    let questionsHtml = '';
    
    quizData.questions.forEach((q, qIndex) => {
        questionsHtml += `
            <div class="tf-question" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="background: #1a237e; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                ${qIndex + 1}
                            </span>
                            <strong style="font-size: 1.05em;">${q.statement}</strong>
                        </div>
                        
                        <div style="display: flex; gap: 20px; margin: 15px 0 0 40px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <input type="radio" name="tf-${uniqueId}-${q.id}" value="true" style="transform: scale(1.2);">
                                <span style="font-weight: bold; color: #28a745;">ƒê√öNG</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <input type="radio" name="tf-${uniqueId}-${q.id}" value="false" style="transform: scale(1.2);">
                                <span style="font-weight: bold; color: #dc3545;">SAI</span>
                            </label>
                        </div>
                    </div>
                    
                    <button onclick="checkSingleTrueFalse('${uniqueId}', '${q.id}', ${q.answer})" 
                            style="margin-left: 15px; padding: 8px 15px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer; white-space: nowrap;">
                        Ki·ªÉm tra
                    </button>
                </div>
                
                <div id="tf-result-${uniqueId}-${q.id}" style="margin-top: 15px; min-height: 24px;"></div>
                
                <div id="tf-solution-${uniqueId}-${q.id}" style="display: none; margin-top: 15px; padding: 15px; background: #e8f4f8; border-radius: 8px;">
                    <div style="font-weight: bold; color: #17a2b8; margin-bottom: 8px;">üìù Gi·∫£i th√≠ch:</div>
                    <div>${q.explanation}</div>
                    ${q.proof ? `<div style="margin-top: 10px;"><em>Ch·ª©ng minh:</em> ${q.proof}</div>` : ''}
                </div>
            </div>
        `;
    });
    
    return `
        <div class="question" id="tf-quiz-${uniqueId}">
            <div style="background: linear-gradient(135deg, #f0f7ff, #e6f0ff); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="color: #1a237e; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                    <span>‚ùì</span> ${quizData.title || 'C√¢u h·ªèi ƒë√∫ng/sai'}
                </h4>
                <p style="color: #666;">${quizData.instructions || 'X√°c ƒë·ªãnh t√≠nh ƒë√∫ng/sai c·ªßa c√°c m·ªánh ƒë·ªÅ sau:'}</p>
            </div>
            
            ${questionsHtml}
            
            <div style="margin-top: 30px; text-align: center;">
                <button onclick="checkAllTrueFalse('${uniqueId}', ${JSON.stringify(quizData.questions.map(q => q.answer))})"
                        style="padding: 12px 30px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1em; cursor: pointer;">
                    ‚úÖ Ki·ªÉm tra t·∫•t c·∫£ (${quizData.questions.length} c√¢u)
                </button>
                
                ${quizData.scoring ? `
                    <div style="margin-top: 15px; color: #666; font-size: 0.9em;">
                        <em>ƒêi·ªÉm: ${quizData.scoring.points_per_correct}/c√¢u ƒë√∫ng | T·ªïng: ${quizData.scoring.total_points} ƒëi·ªÉm</em>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

function renderMultipleChoiceSetItem(item, uniqueId) {
    let html = `
        <div class="question" id="mc-set-${uniqueId}">
            <div style="background: linear-gradient(135deg, #f8f9ff, #eef1ff); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="color: #1a237e; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                    <span>üìù</span> ${item.title || 'B√†i t·∫≠p tr·∫Øc nghi·ªám'}
                </h4>
            </div>
    `;
    
    if (item.questions && Array.isArray(item.questions)) {
        item.questions.forEach((q, qIndex) => {
            let optionsHtml = '';
            for (const [key, value] of Object.entries(q.options || {})) {
                optionsHtml += `
                    <div style="margin: 8px 0; padding: 10px; background: white; border-radius: 8px; border: 2px solid #e0e0e0; cursor: pointer;"
                         onclick="selectMCOption(this, '${uniqueId}-${q.id}', '${key}')">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="background: #f0f0f0; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                ${key}
                            </span>
                            <span>${value}</span>
                        </div>
                        <span id="icon-${uniqueId}-${q.id}-${key}" style="margin-left: auto;"></span>
                    </div>
                `;
            }
            
            html += `
                <div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 12px;">
                    <div style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 15px;">
                        <span style="background: #1a237e; color: white; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            ${qIndex + 1}
                        </span>
                        <div style="flex: 1; font-size: 1.05em;">
                            ${q.question}
                            ${q.difficulty ? `<span style="font-size: 0.8em; padding: 2px 8px; background: ${getDifficultyColor(q.difficulty)}; color: white; border-radius: 10px; margin-left: 10px;">${q.difficulty}</span>` : ''}
                        </div>
                    </div>
                    
                    <div style="margin-left: 50px;">
                        ${optionsHtml}
                    </div>
                    
                    <div style="margin-top: 15px; margin-left: 50px;">
                        <button onclick="checkMCQuestion('${uniqueId}-${q.id}', '${q.correct}', '${q.solution || ''}')"
                                style="padding: 8px 20px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Ki·ªÉm tra c√¢u n√†y
                        </button>
                        <span id="result-${uniqueId}-${q.id}" style="margin-left: 15px;"></span>
                    </div>
                    
                    ${q.solution ? `
                        <div id="solution-${uniqueId}-${q.id}" style="display: none; margin-top: 15px; margin-left: 50px; padding: 15px; background: #e8f4f8; border-radius: 8px;">
                            <div style="font-weight: bold; color: #17a2b8; margin-bottom: 8px;">üìñ H∆∞·ªõng d·∫´n gi·∫£i:</div>
                            <div>${q.solution}</div>
                            ${q.step_by_step ? `
                                <div style="margin-top: 10px;">
                                    <strong>C√°c b∆∞·ªõc gi·∫£i:</strong>
                                    <ol style="margin: 5px 0 0 20px;">
                                        ${q.step_by_step.map(step => `<li>${step}</li>`).join('')}
                                    </ol>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        });
    }
    
    html += `</div>`;
    return html;
}

function renderShortAnswerSetItem(item, uniqueId) {
    let html = `
        <div class="question" id="sa-set-${uniqueId}">
            <div style="background: linear-gradient(135deg, #f0f7ff, #e6f0ff); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="color: #1a237e; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                    <span>‚úçÔ∏è</span> ${item.title || 'B√†i t·∫≠p t·ª± lu·∫≠n ng·∫Øn'}
                </h4>
            </div>
    `;
    
    if (item.questions && Array.isArray(item.questions)) {
        item.questions.forEach((q, qIndex) => {
            html += `
                <div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 12px;">
                    <div style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 15px;">
                        <span style="background: #1a237e; color: white; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            ${qIndex + 1}
                        </span>
                        <div style="flex: 1; font-size: 1.05em;">
                            ${q.question}
                        </div>
                    </div>
                    
                    <div style="margin-left: 50px;">
                        <input type="text" id="input-${uniqueId}-${q.id}" 
                               placeholder="${q.placeholder || 'Nh·∫≠p c√¢u tr·∫£ l·ªùi...'}"
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                        
                        ${q.hint ? `
                            <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 6px; color: #856404;">
                                <strong>üí° G·ª£i √Ω:</strong> ${q.hint}
                            </div>
                        ` : ''}
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
                            <button onclick="checkSAQuestion('${uniqueId}-${q.id}', '${q.answer}', ${JSON.stringify(q.accept_variations || [])}, '${q.solution || ''}')"
                                    style="padding: 10px 25px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Ki·ªÉm tra
                            </button>
                            <span id="result-${uniqueId}-${q.id}" style="margin-left: 10px;"></span>
                        </div>
                    </div>
                    
                    ${q.solution ? `
                        <div id="solution-${uniqueId}-${q.id}" style="display: none; margin-top: 15px; margin-left: 50px; padding: 15px; background: #e8f4f8; border-radius: 8px;">
                            <div style="font-weight: bold; color: #17a2b8; margin-bottom: 8px;">üìñ L·ªùi gi·∫£i:</div>
                            <div>${q.solution}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        });
    }
    
    html += `</div>`;
    return html;
}

function renderMethodItem(item, uniqueId) {
    let stepsHtml = '';
    if (item.steps && Array.isArray(item.steps)) {
        item.steps.forEach((step, idx) => {
            stepsHtml += `
                <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px; border-left: 4px solid #4dabf7;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="background: #4dabf7; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            ${idx + 1}
                        </span>
                        <strong style="color: #1a237e;">${step.title}</strong>
                    </div>
                    <div style="margin-left: 40px;">
                        <div><strong>C√¥ng th·ª©c/b∆∞·ªõc:</strong> ${step.content}</div>
                        ${step.explanation ? `<div style="margin-top: 8px; color: #666;">${step.explanation}</div>` : ''}
                    </div>
                </div>
            `;
        });
    }
    
    let exampleHtml = '';
    if (item.example) {
        exampleHtml = `
            <div style="margin-top: 30px; padding: 20px; background: #e8f4f8; border-radius: 12px;">
                <h5 style="color: #17a2b8; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span>üìö</span> V√≠ d·ª• minh h·ªça
                </h5>
                <div style="margin-bottom: 15px;">
                    <strong>B√†i to√°n:</strong> ${item.example.problem}
                </div>
                <div>
                    <strong>L·ªùi gi·∫£i:</strong>
                    ${Array.isArray(item.example.solution_steps) ? 
                        `<ol style="margin: 10px 0 0 20px;">${item.example.solution_steps.map(step => `<li>${step}</li>`).join('')}</ol>` :
                        `<div style="margin-top: 10px;">${item.example.solution_steps}</div>`
                    }
                </div>
                ${item.example.graph_characteristics ? `
                    <div style="margin-top: 15px;">
                        <strong>ƒê·∫∑c ƒëi·ªÉm ƒë·ªì th·ªã:</strong>
                        <ul style="margin: 5px 0 0 20px;">
                            ${Object.entries(item.example.graph_characteristics).map(([key, value]) => 
                                `<li><strong>${key}:</strong> ${value}</li>`
                            ).join('')}
                        </ul>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    return `
        <div class="theory-box" style="background: #f0f7ff; padding: 25px; border-radius: 12px; border: 2px solid #4dabf7;">
            <h4 style="color: #1a237e; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <span>üîß</span> ${item.title || 'Ph∆∞∆°ng ph√°p gi·∫£i'}
            </h4>
            
            ${item.problem_type ? `
                <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px;">
                    <strong>D·∫°ng to√°n:</strong> ${item.problem_type}
                </div>
            ` : ''}
            
            <div style="margin: 20px 0;">
                <h5 style="color: #3949ab; margin-bottom: 15px;">üìã C√°c b∆∞·ªõc gi·∫£i:</h5>
                ${stepsHtml}
            </div>
            
            ${exampleHtml}
        </div>
    `;
}

function renderMixedQuizItem(item, uniqueId) {
    let html = `
        <div class="question" id="mixed-${uniqueId}">
            <div style="background: linear-gradient(135deg, #f8f9ff, #eef1ff); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="color: #1a237e; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                    <span>üéØ</span> ${item.title || 'B√†i t·∫≠p t·ªïng h·ª£p'}
                </h4>
            </div>
    `;
    
    if (item.questions && Array.isArray(item.questions)) {
        item.questions.forEach((q, qIndex) => {
            if (q.type === 'true_false') {
                html += `
                    <div style="margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 12px;">
                        <div style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 15px;">
                            <span style="background: #1a237e; color: white; min-width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                ${qIndex + 1}
                            </span>
                            <div style="flex: 1; font-size: 1.05em;">
                                ${q.statement}
                            </div>
                        </div>
                        
                        <div style="margin-left: 50px; display: flex; gap: 20px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="radio" name="mixed-${uniqueId}-${q.id}" value="true"> ƒê√∫ng
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="radio" name="mixed-${uniqueId}-${q.id}" value="false"> Sai
                            </label>
                            <button onclick="checkMixedTF('${uniqueId}', '${q.id}', ${q.answer})"
                                    style="margin-left: auto; padding: 6px 15px; background: #17a2b8; color: white; border: none; border-radius: 6px;">
                                Ki·ªÉm tra
                            </button>
                        </div>
                        <div id="mixed-result-${uniqueId}-${q.id}" style="margin-top: 10px; margin-left: 50px;"></div>
                    </div>
                `;
            } else if (q.type === 'multiple_choice') {
                // Similar structure for MC
                // ... (omitted for brevity)
            }
        });
    }
    
    html += `</div>`;
    return html;
}

// ===== HELPER FUNCTIONS =====

function getDifficultyColor(difficulty) {
    switch(difficulty.toLowerCase()) {
        case 'easy': return '#28a745';
        case 'medium': return '#ffc107';
        case 'hard': return '#dc3545';
        default: return '#6c757d';
    }
}

// Scroll helper
window.scrollToSection = function(sectionNumber) {
    const section = document.getElementById(`section-${sectionNumber}`);
    if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
};
// ===== SLIDE MENU =====
function setupSlideMenu() {
    const slideMenu = document.getElementById('slideMenu');
    const slideMenuBtn = document.getElementById('slideMenuBtn');
    const closeSlideMenuBtn = document.getElementById('closeSlideMenu');
    const menuOverlay = document.getElementById('menuOverlay');
    
    function toggleSlideMenu() {
        slideMenu.classList.toggle('active');
        menuOverlay.classList.toggle('active');
    }
    slideMenuBtn.addEventListener('click', toggleSlideMenu);
    closeSlideMenuBtn.addEventListener('click', toggleSlideMenu);
    menuOverlay.addEventListener('click', toggleSlideMenu);
    
    createSlideList();
}

function createSlideList() {
    const slideList = document.getElementById('slideList');
    const sections = document.querySelectorAll('.slide-section');
    
    if (sections.length === 0) {
        slideList.innerHTML = `<div class="slide-item">Ch∆∞a c√≥ n·ªôi dung</div>`;
        return;
    }
    
    slideList.innerHTML = Array.from(sections).map((section, index) => {
        const title = section.querySelector('h2, h3, .question-title')?.textContent.substring(0, 30) || 
                     section.querySelector('p')?.textContent.substring(0, 30) || 
                     `B√†i ${index + 1}`;
        return `<div class="slide-item" data-section-index="${index}">
                    <span class="slide-number">${index + 1}</span>${title}
                </div>`;
    }).join('');

    slideList.querySelectorAll('.slide-item').forEach(item => {
        item.addEventListener('click', () => {
            const sectionIndex = parseInt(item.dataset.sectionIndex);
            const section = document.getElementById(`section-${sectionIndex}`);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                document.getElementById('slideMenu').classList.remove('active');
                document.getElementById('menuOverlay').classList.remove('active');
            }
        });
    });
    
    updateActiveSlideInMenu();
}

function updateActiveSlideInMenu(section = null) {
    if (!section) {
        section = document.querySelector('.slide-section.active-section');
    }
    
    if (!section) return;
    
    const sectionIndex = Array.from(document.querySelectorAll('.slide-section')).indexOf(section);
    
    document.querySelectorAll('.slide-item').forEach((item, index) => {
        item.classList.toggle('active', index === sectionIndex);
    });
}

// ===== MODAL SYSTEM =====
function setupModalSystem() {
    const modals = document.querySelectorAll('.modal, .confirm-modal');
    
    modals.forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                hideModal(this);
            }
        });
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && activeModal) {
            hideModal(activeModal);
        }
    });
    
    document.querySelectorAll('.modal-close, .confirm-no').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = this.closest('.modal, .confirm-modal');
            if (modal) hideModal(modal);
        });
    });
}

function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        if (activeModal) {
            hideModal(activeModal);
        }
        
        modal.classList.add('active');
        activeModal = modal;
    }
}

function hideModal(modal) {
    if (modal) {
        modal.classList.remove('active');
        if (modal === activeModal) {
            activeModal = null;
        }
    }
}

function hideAllModals() {
    document.querySelectorAll('.modal.active, .confirm-modal.active').forEach(modal => {
        hideModal(modal);
    });
}

function setupModalControls() {
    document.getElementById('loginBtn').addEventListener('click', () => { showModal('login-modal'); });
    document.getElementById('teacherMonitorBtn').addEventListener('click', () => {
        if (isTeacherLoggedIn) showModal('teacher-monitor');
        else showNotification('Ch·ªâ gi√°o vi√™n m·ªõi c√≥ quy·ªÅn truy c·∫≠p!', 'error');
    });
    document.getElementById('closeMonitor').addEventListener('click', () => { hideModal(document.getElementById('teacher-monitor')); });
}

// ===== AUTHENTICATION =====
// THAY TO√ÄN B·ªò H√ÄM setupAuthentication() C≈®:
function setupAuthentication() {
    document.getElementById('code-login-form').addEventListener('submit', async e => {
        e.preventDefault();
        const code = document.getElementById('login-code').value.trim();
        const name = document.getElementById('student-name').value.trim() || 'H·ªçc sinh';
        
        if (!code) {
            showNotification('Vui l√≤ng nh·∫≠p m√£ ƒëƒÉng nh·∫≠p', 'error');
            return;
        }

        try {
            if (code === 'admin79') {
                await loginAsTeacher(name);
            } else if (code.startsWith('HS')) {
                await loginAsStudent(code, name);
            } else {
                showNotification('M√£ ƒëƒÉng nh·∫≠p kh√¥ng h·ª£p l·ªá', 'error');
            }
        } catch (error) {
            console.error('Login error:', error);
            showNotification('L·ªói ƒëƒÉng nh·∫≠p: ' + error.message, 'error');
        }
    });
}
// THAY TH·∫æ H√ÄM loginAsTeacher V√Ä loginAsStudent C≈®:
async function loginAsTeacher(name) {
    isTeacherLoggedIn = true;
    currentUser = { uid: 'teacher_admin_79', name, role: 'teacher', code: 'admin79' };
    
    try {
        await db.ref('users/' + currentUser.uid).set({ 
            name, 
            role: 'teacher', 
            lastLogin: firebase.database.ServerValue.TIMESTAMP 
        });
    } catch (error) {
        console.warn("Kh√¥ng th·ªÉ l∆∞u teacher v√†o DB, v·∫´n ti·∫øp t·ª•c...");
    }
    
    document.body.classList.add('teacher-role');
    document.body.classList.remove('student-role');
    document.body.classList.remove('not-logged-in');
    
    showNotification(`‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng - GV: ${name}`, 'success');
    updateUIAfterLogin();
}

async function loginAsStudent(code, name) {
    try {
        const studentSnapshot = await db.ref(`studentCodes/${code}`).once('value');
        const studentData = studentSnapshot.val();
        
        if (!studentData) {
            showNotification('M√£ h·ªçc sinh kh√¥ng t·ªìn t·∫°i!', 'error');
            return;
        }
        
        if (studentData.name !== name) {
            showNotification('H·ªç t√™n kh√¥ng kh·ªõp v·ªõi m√£ h·ªçc sinh!', 'error');
            return;
        }

        // C·∫≠p nh·∫≠t last login
        try {
            await db.ref(`studentCodes/${code}`).update({
                lastLogin: firebase.database.ServerValue.TIMESTAMP
            });
        } catch (error) {
            console.warn("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t lastLogin");
        }

        isTeacherLoggedIn = false;
        currentUser = { 
            uid: 'student_' + code + '_' + Date.now(), 
            name, 
            role: 'student', 
            code,
            classCode: studentData.classCode,
            className: studentData.className
        };
        
        // L∆∞u v√†o users
        try {
            await db.ref('users/' + currentUser.uid).set({ 
                name, 
                role: 'student', 
                code, 
                lastLogin: firebase.database.ServerValue.TIMESTAMP 
            });
        } catch (error) {
            console.warn("Kh√¥ng th·ªÉ l∆∞u student v√†o users");
        }
        
        document.body.classList.add('student-role');
        document.body.classList.remove('teacher-role');
        document.body.classList.remove('not-logged-in');
        
        showNotification(`‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng - HS: ${name}`, 'success');
        updateUIAfterLogin();
        
        // H·ªèi m√£ l·ªõp (gi·ªØ nguy√™n nh∆∞ c≈©)
        const sessionToJoin = prompt("Nh·∫≠p m√£ l·ªõp h·ªçc ƒë·ªÉ tham gia (b·ªè tr·ªëng n·∫øu kh√¥ng c√≥):");
        if (sessionToJoin && sessionToJoin.trim() !== '') {
            sessionCode = sessionToJoin.toUpperCase();
            joinSessionAsStudent();
        }
        
    } catch (error) {
        console.error('Student login error:', error);
        showNotification('L·ªói ƒëƒÉng nh·∫≠p h·ªçc sinh: ' + error.message, 'error');
    }
}
function updateUIAfterLogin() {
    hideModal(document.getElementById('login-modal'));
    
    const loginBtn = document.getElementById('loginBtn');
    if (isTeacherLoggedIn) {
        loginBtn.innerHTML = 'üë®‚Äçüè´ ' + currentUser.name;
        loginBtn.style.background = '#28a745';
        document.getElementById('teacherMonitorBtn').style.display = 'inline-block';
        document.getElementById('classManagementBtn').style.display = 'inline-block';
    } else {
        loginBtn.innerHTML = 'üë§ ' + currentUser.name;
        document.getElementById('studentInteractBtn').style.display = 'inline-block';
    }
}

// ===== SESSION MANAGEMENT =====
function setupSessionManagement() {
    // This function is kept for compatibility
}

function generateSessionCode() {
    return Math.random().toString(36).substr(2, 6).toUpperCase();
}

async function createNewSession() {
    if (!isTeacherLoggedIn) return showNotification('Ch·ªâ gi√°o vi√™n m·ªõi c√≥ th·ªÉ t·∫°o l·ªõp h·ªçc', 'error');
    sessionCode = generateSessionCode();
    try {
        await db.ref('sessions/' + sessionCode).set({
            created: firebase.database.ServerValue.TIMESTAMP,
            teacher: currentUser.name,
            status: 'active',
            currentSlide: 0
        });
        document.getElementById('monitor-session-code').textContent = sessionCode;
        showNotification(`‚úÖ ƒê√£ t·∫°o l·ªõp h·ªçc! M√£ l·ªõp: <strong>${sessionCode}</strong>`, 'success');
        startMonitoringSession();
    } catch (error) {
        console.error('Error creating session:', error);
        showNotification('L·ªói t·∫°o l·ªõp h·ªçc: ' + error.message, 'error');
    }
}

function joinSessionAsStudent() {
    if (!sessionCode || !currentUser) return showNotification('Vui l√≤ng ƒëƒÉng nh·∫≠p v√† c√≥ m√£ l·ªõp h·ªçc', 'error');
    const studentRef = db.ref('sessions/' + sessionCode + '/students/' + currentUser.uid);
    studentRef.set({
        name: currentUser.name, code: currentUser.code,
        joined: firebase.database.ServerValue.TIMESTAMP,
        status: 'active', score: 0, progress: 0, currentSlide: 0,
        lastActivity: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
        showNotification(`‚úÖ ƒê√£ tham gia l·ªõp h·ªçc: ${sessionCode}`, 'success');
        listenToSessionChanges();
    }).catch(error => {
        console.error('Error joining session:', error);
        showNotification('L·ªói tham gia l·ªõp h·ªçc: ' + error.message, 'error');
    });
}

function listenToSessionChanges() {
    db.ref('sessions/' + sessionCode + '/currentSlide').on('value', snapshot => {
        const slideIndex = snapshot.val();
        if (slideIndex !== null && slideIndex !== undefined) {
            // Scroll to the section
            const section = document.getElementById(`section-${slideIndex}`);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    });
    
    db.ref('sessions/' + sessionCode + '/poll').on('value', snapshot => {
        const pollData = snapshot.val();
        if (pollData && pollData.active) showPoll(pollData);
        else hidePoll();
    });
}

function syncSlidesWithStudents() {
    if (!isTeacherLoggedIn || !sessionCode) return showNotification('Vui l√≤ng t·∫°o l·ªõp h·ªçc tr∆∞·ªõc', 'error');
    
    // Get current active section
    const activeSection = document.querySelector('.slide-section.active-section');
    if (!activeSection) return;
    
    const sections = document.querySelectorAll('.slide-section');
    const slideIndex = Array.from(sections).indexOf(activeSection);
    
    db.ref('sessions/' + sessionCode + '/currentSlide').set(slideIndex)
        .then(() => showNotification(`‚úÖ ƒê√£ ƒë·ªìng b·ªô b√†i ${slideIndex + 1}`, 'success'))
        .catch(error => showNotification('L·ªói ƒë·ªìng b·ªô b√†i: ' + error.message, 'error'));
}

// ===== CLASS MANAGEMENT =====
function setupClassManagement() {
    console.log("üîß Kh·ªüi t·∫°o qu·∫£n l√Ω l·ªõp...");
    
    document.getElementById('classManagementBtn').addEventListener('click', () => {
        if (!isTeacherLoggedIn) {
            showNotification('Ch·ªâ gi√°o vi√™n m·ªõi c√≥ quy·ªÅn qu·∫£n l√Ω l·ªõp!', 'error');
            return;
        }
        showModal('class-management-modal');
        loadClassesList();
        loadStudentsList();
    });

    document.getElementById('create-class-btn').addEventListener('click', () => {
        showModal('create-class-modal');
    });

    document.getElementById('create-class-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await createNewClass();
    });

    document.getElementById('refresh-classes-btn').addEventListener('click', () => {
        loadClassesList();
        loadStudentsList();
    });

    // Search and filter
    document.getElementById('search-student-global').addEventListener('input', loadStudentsList);
    document.getElementById('filter-class').addEventListener('change', loadStudentsList);
    
    // Additional buttons
    document.getElementById('class-poll-btn').addEventListener('click', startClassPoll);
    document.getElementById('class-sync-btn').addEventListener('click', syncClassSlides);
    document.getElementById('view-poll-results-btn').addEventListener('click', viewClassPollResults);
    document.getElementById('view-interactions-btn').addEventListener('click', viewClassInteractions);
}

async function createNewClass() {
    const className = document.getElementById('class-name').value.trim();
    const classDescription = document.getElementById('class-description').value.trim();

    if (!className) {
        showNotification('Vui l√≤ng nh·∫≠p t√™n l·ªõp!', 'error');
        return;
    }

    try {
        const classCode = generateClassCode();
        const classData = {
            name: className,
            description: classDescription,
            code: classCode,
            teacher: currentUser.name,
            teacherId: currentUser.uid,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            studentCount: 0,
            status: 'active'
        };

        await db.ref(`classes/${classCode}`).set(classData);
        
        hideModal(document.getElementById('create-class-modal'));
        document.getElementById('create-class-form').reset();
        
        showNotification(`‚úÖ ƒê√£ t·∫°o l·ªõp "${className}" v·ªõi m√£: ${classCode}`, 'success');
        loadClassesList();
        
    } catch (error) {
        console.error('L·ªói t·∫°o l·ªõp:', error);
        showNotification('‚ùå L·ªói khi t·∫°o l·ªõp!', 'error');
    }
}

function generateClassCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
        code += chars[Math.floor(Math.random() * chars.length)];
    }
    return code;
}

async function loadClassesList() {
    try {
        const snapshot = await db.ref('classes').orderByChild('createdAt').once('value');
        const classes = snapshot.val() || {};
        
        const tbody = document.getElementById('classes-list-body');
        let html = '';
        
        Object.entries(classes).forEach(([classCode, classData]) => {
            if (classData.teacherId !== currentUser.uid) return;
            
            const createDate = classData.createdAt ? 
                new Date(classData.createdAt).toLocaleDateString('vi-VN') : 'N/A';
            
            html += `
                <tr>
                    <td>
                        <strong>${classData.name}</strong>
                        ${classData.description ? `<br><small style="color: #666;">${classData.description}</small>` : ''}
                    </td>
                    <td><code style="background: #1a237e; color: white; padding: 4px 8px; border-radius: 4px;">${classCode}</code></td>
                    <td style="text-align: center;">
                        <span style="font-weight: bold; color: #1a237e;">${classData.studentCount || 0}</span>
                    </td>
                    <td>${createDate}</td>
                    <td style="text-align: center;">
                        <span class="status-active">üü¢ Ho·∫°t ƒë·ªông</span>
                    </td>
                    <td style="text-align: center;">
                        <button onclick="viewClassDetails('${classCode}')" style="padding: 6px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin: 2px;">
                            üëÅÔ∏è Xem
                        </button>
                        <button onclick="confirmDeleteClass('${classCode}')" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin: 2px;">
                            üóëÔ∏è X√≥a
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html || `
            <tr>
                <td colspan="6" style="text-align: center; padding: 30px; color: #666;">
                    Ch∆∞a c√≥ l·ªõp h·ªçc n√†o. H√£y t·∫°o l·ªõp ƒë·∫ßu ti√™n!
                </td>
            </tr>
        `;
        
        updateClassFilter(classes);
        
    } catch (error) {
        console.error('L·ªói t·∫£i danh s√°ch l·ªõp:', error);
        document.getElementById('classes-list-body').innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 30px; color: #dc3545;">
                    ‚ùå L·ªói khi t·∫£i danh s√°ch l·ªõp
                </td>
            </tr>
        `;
    }
}

function confirmDeleteClass(classCode) {
    document.getElementById('confirm-delete-message').textContent = 
        `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a l·ªõp n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`;
    
    document.getElementById('confirm-delete-yes').onclick = function() {
        deleteClass(classCode);
        hideModal(document.getElementById('confirm-delete-modal'));
    };
    
    showModal('confirm-delete-modal');
}

async function deleteClass(classCode) {
    try {
        await db.ref(`classes/${classCode}`).remove();
        showNotification('‚úÖ ƒê√£ x√≥a l·ªõp th√†nh c√¥ng!', 'success');
        loadClassesList();
    } catch (error) {
        console.error('L·ªói x√≥a l·ªõp:', error);
        showNotification('‚ùå L·ªói khi x√≥a l·ªõp!', 'error');
    }
}

function updateClassFilter(classes) {
    const filterSelect = document.getElementById('filter-class');
    let options = '<option value="all">T·∫•t c·∫£ l·ªõp</option>';
    
    Object.entries(classes).forEach(([classCode, classData]) => {
        if (classData.teacherId === currentUser.uid) {
            options += `<option value="${classCode}">${classData.name} (${classCode})</option>`;
        }
    });
    
    filterSelect.innerHTML = options;
}

// ===== STUDENT CODE MANAGEMENT =====
function setupStudentCodeManagement() {
    console.log("üîß Kh·ªüi t·∫°o qu·∫£n l√Ω m√£ h·ªçc sinh...");
    
    document.getElementById('assign-student-btn-main').addEventListener('click', () => {
        if (!isTeacherLoggedIn) {
            showNotification('Ch·ªâ gi√°o vi√™n m·ªõi c√≥ quy·ªÅn c·∫•p m√£!', 'error');
            return;
        }
        showModal('assign-student-modal');
        loadClassesForAssignment();
        generateStudentCode();
    });

    document.getElementById('view-student-codes-btn').addEventListener('click', () => {
        showModal('student-codes-modal');
        loadStudentCodesList();
    });

    document.getElementById('generate-student-code-btn').addEventListener('click', generateStudentCode);
    document.getElementById('assign-student-btn').addEventListener('click', assignStudentCode);
}

async function loadClassesForAssignment() {
    try {
        const snapshot = await db.ref('classes').once('value');
        const classes = snapshot.val() || {};
        const select = document.getElementById('select-class-for-student');
        
        let options = '<option value="">-- Ch·ªçn l·ªõp --</option>';
        
        Object.entries(classes).forEach(([classCode, classData]) => {
            if (classData.teacherId === currentUser.uid) {
                options += `<option value="${classCode}">${classData.name} (${classCode})</option>`;
            }
        });
        
        select.innerHTML = options;
        
    } catch (error) {
        console.error('L·ªói t·∫£i danh s√°ch l·ªõp:', error);
    }
}

function generateStudentCode() {
    const prefix = 'HS';
    const randomNum = Math.floor(100000 + Math.random() * 900000);
    const studentCode = `${prefix}${randomNum}`;
    
    document.getElementById('generated-student-code').textContent = studentCode;
    return studentCode;
}

function generatePassword(length = 6) {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let password = '';
    for (let i = 0; i < length; i++) {
        password += chars[Math.floor(Math.random() * chars.length)];
    }
    return password;
}

async function assignStudentCode() {
    const classCode = document.getElementById('select-class-for-student').value;
    const studentName = document.getElementById('student-fullname').value.trim();
    const studentCode = document.getElementById('generated-student-code').textContent;

    if (!classCode) {
        showNotification('Vui l√≤ng ch·ªçn l·ªõp!', 'error');
        return;
    }

    if (!studentName) {
        showNotification('Vui l√≤ng nh·∫≠p h·ªç t√™n h·ªçc sinh!', 'error');
        return;
    }

    try {
        const password = generatePassword();
        
        const studentCodeData = {
            code: studentCode,
            name: studentName,
            classCode: classCode,
            className: await getClassName(classCode),
            password: password,
            teacherId: currentUser.uid,
            teacherName: currentUser.name,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            status: 'active'
        };

        await db.ref(`studentCodes/${studentCode}`).set(studentCodeData);
        await updateStudentCountInClass(classCode);

        showNotification(`‚úÖ ƒê√£ c·∫•p m√£ ${studentCode} cho ${studentName} trong l·ªõp`, 'success');
        loadStudentCodesList();
        loadStudentsList();
        
        document.getElementById('student-fullname').value = '';
        document.getElementById('student-fullname').focus();
        generateStudentCode();

    } catch (error) {
        console.error('L·ªói c·∫•p m√£ h·ªçc sinh:', error);
        showNotification('‚ùå L·ªói khi c·∫•p m√£ h·ªçc sinh!', 'error');
    }
}

async function getClassName(classCode) {
    try {
        const snapshot = await db.ref(`classes/${classCode}/name`).once('value');
        return snapshot.val() || 'Unknown Class';
    } catch (error) {
        return 'Unknown Class';
    }
}

async function updateStudentCountInClass(classCode) {
    try {
        const snapshot = await db.ref('studentCodes').orderByChild('classCode').equalTo(classCode).once('value');
        const students = snapshot.val() || {};
        const studentCount = Object.keys(students).length;
        
        await db.ref(`classes/${classCode}/studentCount`).set(studentCount);
    } catch (error) {
        console.error('L·ªói c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng h·ªçc sinh:', error);
    }
}

async function loadStudentCodesList() {
    try {
        const snapshot = await db.ref('studentCodes').once('value');
        const studentCodes = snapshot.val() || {};
        
        const tbody = document.getElementById('student-codes-list');
        let html = '';
        
        Object.entries(studentCodes).forEach(([code, data]) => {
            if (data.teacherId !== currentUser.uid) return;
            
            const createDate = data.createdAt ? 
                new Date(data.createdAt).toLocaleDateString('vi-VN') : 'N/A';
            
            const status = '<span class="status-active">Ho·∫°t ƒë·ªông</span>';
            
            html += `
                <tr>
                    <td><strong>${code}</strong></td>
                    <td>${data.name}</td>
                    <td>${data.classCode}</td>
                    <td>${createDate}</td>
                    <td>${status}</td>
                    <td>${data.password}</td>
                    <td>
                        <button onclick="revokeStudentCode('${code}')" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            üîí Kh√≥a
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html || `
            <tr>
                <td colspan="7" style="text-align: center; padding: 30px; color: #666;">
                    Ch∆∞a c√≥ m√£ h·ªçc sinh n√†o ƒë∆∞·ª£c c·∫•p
                </td>
            </tr>
        `;
        
    } catch (error) {
        console.error('L·ªói t·∫£i danh s√°ch m√£ h·ªçc sinh:', error);
    }
}

async function revokeStudentCode(codeId) {
    try {
        await db.ref(`studentCodes/${codeId}/status`).set('revoked');
        showNotification(`‚úÖ ƒê√£ thu h·ªìi m√£ ${codeId}!`, 'success');
        loadStudentCodesList();
    } catch (error) {
        console.error('L·ªói thu h·ªìi m√£ h·ªçc sinh:', error);
        showNotification('‚ùå L·ªói khi thu h·ªìi m√£!', 'error');
    }
}

// ===== STUDENT LIST =====
async function loadStudentsList() {
    try {
        const searchTerm = document.getElementById('search-student-global').value.toLowerCase();
        const selectedClass = document.getElementById('filter-class').value;
        
        const [studentCodesSnapshot, usersSnapshot, attemptsSnapshot] = await Promise.all([
            db.ref('studentCodes').once('value'),
            db.ref('users').once('value'),
            db.ref('attempts').once('value')
        ]);
        
        const studentCodes = studentCodesSnapshot.val() || {};
        const allUsers = usersSnapshot.val() || {};
        const allAttempts = attemptsSnapshot.val() || {};
        
        const tbody = document.getElementById('students-list-body');
        let html = '';
        let studentCount = 0;

        const synchronizedStudents = new Map();

        // From studentCodes
        Object.entries(studentCodes).forEach(([code, codeData]) => {
            if (codeData.teacherId !== currentUser.uid) return;
            
            const studentId = `student_${code}`;
            synchronizedStudents.set(code, {
                code: code,
                name: codeData.name,
                classCode: codeData.classCode,
                className: codeData.className || 'Ch∆∞a c√≥ l·ªõp',
                status: codeData.status || 'active',
                createdAt: codeData.createdAt,
                lastLogin: null,
                attempts: [],
                totalScore: 0
            });
        });

        // From users
        Object.entries(allUsers).forEach(([userId, userData]) => {
            if (userData.role === 'student' && userData.code) {
                const code = userData.code;
                if (synchronizedStudents.has(code)) {
                    const student = synchronizedStudents.get(code);
                    student.lastLogin = userData.lastLogin;
                    student.status = userData.status || student.status;
                }
            }
        });

        // From attempts
        Object.values(allAttempts).forEach(sessionAttempts => {
            Object.entries(sessionAttempts).forEach(([studentId, attempt]) => {
                const code = attempt.code;
                if (synchronizedStudents.has(code)) {
                    const student = synchronizedStudents.get(code);
                    student.attempts.push(attempt);
                    student.totalScore += parseFloat(attempt.score) || 0;
                    
                    if (attempt.createdAt > (student.lastActivity || 0)) {
                        student.lastActivity = attempt.createdAt;
                    }
                }
            });
        });

        // Display
        synchronizedStudents.forEach((student, code) => {
            if (searchTerm && 
                !student.name.toLowerCase().includes(searchTerm) && 
                !student.code.toLowerCase().includes(searchTerm)) {
                return;
            }
            
            if (selectedClass !== 'all' && student.classCode !== selectedClass) {
                return;
            }
            
            studentCount++;
            
            const attemptCount = student.attempts.length;
            const avgScore = attemptCount > 0 ? (student.totalScore / attemptCount).toFixed(2) : '0.00';
            const lastActivity = student.lastActivity ? getTimeAgo(student.lastActivity) : 
                              student.lastLogin ? getTimeAgo(student.lastLogin) : 'Ch∆∞a ho·∫°t ƒë·ªông';
            
            html += `
                <tr>
                    <td><strong>${student.code}</strong></td>
                    <td>${student.name}</td>
                    <td>
                        ${student.classCode}
                        ${student.className !== 'Ch∆∞a c√≥ l·ªõp' ? `<br><small style="color: #666;">${student.className}</small>` : ''}
                    </td>
                    <td>${lastActivity}</td>
                    <td style="text-align: center;">
                        <span style="font-weight: bold; color: #1a237e;">${attemptCount}</span>
                    </td>
                    <td style="text-align: center;">
                        <span style="font-weight: bold; color: ${getScoreColor(parseFloat(avgScore))}">
                            ${avgScore}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <button onclick="viewStudentProfile('${code}')" style="padding: 6px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin: 2px;">
                            üìä
                        </button>
                        <button onclick="editStudent('${code}')" style="padding: 6px 12px; background: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin: 2px;">
                            ‚úèÔ∏è
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html || `
            <tr>
                <td colspan="7" style="text-align: center; padding: 30px; color: #666;">
                    Kh√¥ng t√¨m th·∫•y h·ªçc sinh n√†o.
                </td>
            </tr>
        `;
        
    } catch (error) {
        console.error('L·ªói t·∫£i danh s√°ch h·ªçc sinh:', error);
        document.getElementById('students-list-body').innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 30px; color: #dc3545;">
                    ‚ùå L·ªói khi t·∫£i danh s√°ch h·ªçc sinh
                </td>
            </tr>
        `;
    }
}

function getTimeAgo(timestamp) {
    if (!timestamp) return '--:--';
    
    const now = Date.now();
    const time = typeof timestamp === 'number' ? timestamp : timestamp;
    const diffMs = now - time;
    const diffMins = Math.floor(diffMs / 60000);
    
    if (diffMins < 1) return 'V·ª´a xong';
    if (diffMins < 60) return `${diffMins} ph√∫t tr∆∞·ªõc`;
    
    const diffHours = Math.floor(diffMins / 60);
    if (diffHours < 24) return `${diffHours} gi·ªù tr∆∞·ªõc`;
    
    const diffDays = Math.floor(diffHours / 24);
    return `${diffDays} ng√†y tr∆∞·ªõc`;
}

function getScoreColor(score) {
    if (score >= 8) return '#28a745';
    if (score >= 5) return '#ffc107';
    return '#dc3545';
}

async function viewStudentProfile(studentId) {
    try {
        const userSnapshot = await db.ref(`users/${studentId}`).once('value');
        const userData = userSnapshot.val();
        
        const attemptsSnapshot = await db.ref('attempts').once('value');
        const allAttempts = attemptsSnapshot.val() || {};
        
        let studentAttempts = [];
        Object.values(allAttempts).forEach(sessionAttempts => {
            if (sessionAttempts[studentId]) {
                studentAttempts.push(sessionAttempts[studentId]);
            }
        });
        
        const totalAttempts = studentAttempts.length;
        const totalScore = studentAttempts.reduce((sum, attempt) => sum + parseFloat(attempt.score || 0), 0);
        const avgScore = totalAttempts > 0 ? (totalScore / totalAttempts).toFixed(2) : '0.00';
        const bestScore = Math.max(...studentAttempts.map(a => parseFloat(a.score || 0)));
        const lastAttempt = studentAttempts.length > 0 ? 
            new Date(studentAttempts[studentAttempts.length - 1].createdAt).toLocaleDateString('vi-VN') : 'Ch∆∞a c√≥';
        
        const message = `
            üë§ <b>H·ªì s∆° H·ªçc sinh</b>
            üìõ T√™n: ${userData?.name || 'N/A'}
            üÜî M√£: ${userData?.code || 'N/A'}
            
            üìä <b>Th·ªëng k√™:</b>
            üìù T·ªïng b√†i l√†m: ${totalAttempts}
            üéØ ƒêi·ªÉm trung b√¨nh: ${avgScore}
            üèÜ ƒêi·ªÉm cao nh·∫•t: ${bestScore.toFixed(2)}
            ‚è∞ L·∫ßn cu·ªëi l√†m b√†i: ${lastAttempt}
        `;
        
        showNotification(message, 'info');
        
    } catch (error) {
        console.error('L·ªói xem h·ªì s∆° h·ªçc sinh:', error);
        showNotification('‚ùå L·ªói khi t·∫£i th√¥ng tin h·ªçc sinh!', 'error');
    }
}

async function editStudent(studentCode) {
    try {
        const snapshot = await db.ref(`studentCodes/${studentCode}`).once('value');
        const studentData = snapshot.val();
        
        if (!studentData) {
            showNotification('Kh√¥ng t√¨m th·∫•y h·ªçc sinh!', 'error');
            return;
        }

        const newName = prompt('Nh·∫≠p t√™n m·ªõi cho h·ªçc sinh:', studentData.name);
        if (!newName || newName.trim() === '') return;

        const newClassCode = prompt('Nh·∫≠p m√£ l·ªõp m·ªõi:', studentData.classCode);
        if (!newClassCode) return;

        await db.ref(`studentCodes/${studentCode}`).update({
            name: newName.trim(),
            classCode: newClassCode,
            className: await getClassName(newClassCode)
        });

        const userId = `student_${studentCode}`;
        await db.ref(`users/${userId}`).update({
            name: newName.trim(),
            classCode: newClassCode
        });

        await updateStudentCountInClass(studentData.classCode);
        await updateStudentCountInClass(newClassCode);

        showNotification(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin h·ªçc sinh ${studentCode}`, 'success');
        loadStudentsList();
        
    } catch (error) {
        console.error('L·ªói ch·ªânh s·ª≠a h·ªçc sinh:', error);
        showNotification('‚ùå L·ªói khi c·∫≠p nh·∫≠t th√¥ng tin h·ªçc sinh!', 'error');
    }
}

// ===== ANSWER CHECKING FUNCTIONS =====
window.toggleSolution = function(questionId) {
    const solution = document.getElementById('solution-' + questionId);
    if (solution) {
        solution.style.display = solution.style.display === 'none' ? 'block' : 'none';
    }
};

window.checkAnswer = function(qid, correct) {
    try {
        const container = document.getElementById(qid);
        if (!container) {
            console.error(`Kh√¥ng t√¨m th·∫•y container cho c√¢u h·ªèi: ${qid}`);
            showNotification('L·ªói: Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi!', 'error');
            return;
        }

        container.querySelectorAll('.option-icon').forEach(el => el.textContent = '');

        const chosen = container.querySelector(`input[name="${qid}"]:checked`);
        if (!chosen) {
            showNotification("H√£y ch·ªçn m·ªôt ƒë√°p √°n!", 'warning');
            playSound('wrong');
            return;
        }

        const chosenVal = chosen.value;
        const resultArea = container.querySelector(".answer-check");

        let feedback = resultArea.querySelector(".result");
        if (!feedback) {
            feedback = document.createElement("div");
            feedback.className = "result";
            feedback.style.marginTop = "10px";
            feedback.style.padding = "12px";
            feedback.style.background = "rgba(255,255,255,0.9)";
            feedback.style.borderRadius = "8px";
            feedback.style.border = "1px solid #e0e0e0";
            feedback.style.fontSize = "0.95em";
            resultArea.appendChild(feedback);
        }

        if (chosenVal === correct) {
            const userOption = chosen.closest('.option-row');
            const icon = userOption.querySelector('.option-icon');
            if (icon) icon.textContent = '‚úÖ';
            
            feedback.innerHTML = `
                <div style="color: #28a745; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                    <span>‚úÖ</span>
                    <span><b>Ch√≠nh x√°c!</b></span>
                </div>
                <div style="margin-top: 8px; padding: 8px; background: #d4edda; border-radius: 6px;">
                    ƒê√°p √°n c·ªßa b·∫°n: <b>${chosenVal}</b>
                </div>
            `;
            
            container.querySelectorAll('.option-row').forEach(row => {
                const radio = row.querySelector('input[type="radio"]');
                radio.disabled = true;
                if (radio.value === correct) {
                    row.style.background = 'linear-gradient(135deg, #d4edda, #c3e6cb)';
                    row.style.borderColor = '#28a745';
                }
            });
            
            playSound('correct');
            
            if (currentUser && sessionCode) {
                savePartial(qid, chosenVal, correct, true);
            }
            
            showNotification(`‚úÖ C√¢u ${qid}: Ch√≠nh x√°c! (+0.25 ƒëi·ªÉm)`, 'success');
            
        } else {
            const userOption = chosen.closest('.option-row');
            const correctOption = container.querySelector(`input[value="${correct}"]`).closest('.option-row');
            
            const userIcon = userOption?.querySelector('.option-icon');
            const correctIcon = correctOption?.querySelector('.option-icon');
            
            if (userIcon) userIcon.textContent = '‚ùå';
            if (correctIcon) correctIcon.textContent = '‚úÖ';
            
            feedback.innerHTML = `
                <div style="color: #dc3545; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                    <span>‚ùå</span>
                    <span><b>Sai r·ªìi.</b></span>
                </div>
                <div style="margin-top: 8px; padding: 8px; background: #f8d7da; border-radius: 6px;">
                    B·∫°n ch·ªçn: <b>${chosenVal}</b>
                </div>
                <div style="margin-top: 5px; padding: 8px; background: #d4edda; border-radius: 6px;">
                    ƒê√°p √°n ƒë√∫ng: <b style="color: #28a745">${correct}</b>
                </div>
            `;
            
            container.querySelectorAll('.option-row').forEach(row => {
                const radio = row.querySelector('input[type="radio"]');
                radio.disabled = true;
                const value = radio.value;
                if (value === correct) {
                    row.style.background = 'linear-gradient(135deg, #d4edda, #c3e6cb)';
                    row.style.borderColor = '#28a745';
                } else if (value === chosenVal) {
                    row.style.background = 'linear-gradient(135deg, #f8d7da, #f5c6cb)';
                    row.style.borderColor = '#dc3545';
                }
            });
            
            playSound('wrong');
            
            if (currentUser && sessionCode) {
                savePartial(qid, chosenVal, correct, false);
            }
            
            showNotification(`‚ùå C√¢u ${qid}: Ch∆∞a ch√≠nh x√°c`, 'error');
        }
        
    } catch (error) {
        console.error('L·ªói trong checkAnswer:', error);
        showNotification('C√≥ l·ªói x·∫£y ra khi ki·ªÉm tra ƒë√°p √°n!', 'error');
    }
};

window.checkTrueFalseAnswer = function(questionId, correctAnswers) {
    console.log("üîç === KI·ªÇM TRA TRUE/FALSE ===");
    console.log("Question:", questionId);
    console.log("Answers param:", correctAnswers);
    
    // 1. T√¨m container
    const container = document.getElementById(questionId);
    if (!container) {
        console.error("‚ùå Kh√¥ng t√¨m th·∫•y container v·ªõi ID:", questionId);
        showNotification("Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi!", "error");
        return;
    }
    console.log("‚úÖ Found container");
    
    // 2. Parse answers
    let answers = [];
    try {
        if (typeof correctAnswers === 'string') {
            // X·ª≠ l√Ω chu·ªói nh∆∞ "[True, True, True, False]"
            const clean = correctAnswers
                .replace(/^\[|\]$/g, '') // B·ªè []
                .replace(/"/g, '')       // B·ªè "
                .replace(/'/g, '');      // B·ªè '
            
            answers = clean.split(',').map(item => {
                const trimmed = item.trim().toLowerCase();
                return trimmed === 'true' || trimmed === 'ƒë√∫ng';
            });
        } else if (Array.isArray(correctAnswers)) {
            answers = correctAnswers.map(ans => {
                if (typeof ans === 'boolean') return ans;
                if (typeof ans === 'string') {
                    return ans.toLowerCase() === 'true' || ans === 'ƒê√∫ng';
                }
                return Boolean(ans);
            });
        }
    } catch (e) {
        console.error("‚ùå Parse answers error:", e);
        showNotification("L·ªói x·ª≠ l√Ω ƒë√°p √°n!", "error");
        return;
    }
    
    console.log("Parsed answers:", answers);
    
    // 3. T√¨m c√°c option rows
    const optionRows = container.querySelectorAll(".option-row");
    console.log("Found option rows:", optionRows.length);
    
    if (optionRows.length === 0) {
        console.error("‚ùå Kh√¥ng t√¨m th·∫•y .option-row trong container");
        console.log("Container children:", container.children);
        return;
    }
    
    // 4. Ki·ªÉm tra t·ª´ng c√¢u
    let allCorrect = true;
    let correctCount = 0;
    let feedbackHtml = '';
    
    optionRows.forEach((row, idx) => {
        console.log(`--- Row ${idx} ---`);
        
        // T√¨m c√°c radio buttons trong row
        const radios = row.querySelectorAll('input[type="radio"]');
        console.log(`Radio buttons found: ${radios.length}`);
        
        let selectedValue = null;
        radios.forEach(radio => {
            console.log(`  Radio: name="${radio.name}", value="${radio.value}", checked=${radio.checked}`);
            if (radio.checked) selectedValue = radio.value;
        });
        
        const expectedAnswer = idx < answers.length ? answers[idx] : false;
        const expectedText = expectedAnswer ? "True" : "False";
        const letter = String.fromCharCode(97 + idx); // a, b, c, d
        
        console.log(`Selected: ${selectedValue}, Expected: ${expectedText}`);
        
        if (selectedValue === null) {
            feedbackHtml += `<div style="color: #ffc107; margin: 5px 0;">${letter}) ‚≠ï Ch∆∞a ch·ªçn</div>`;
            allCorrect = false;
        } else if (selectedValue === expectedText) {
            correctCount++;
            feedbackHtml += `<div style="color: #28a745; margin: 5px 0;">${letter}) ‚úÖ ƒê√∫ng (${selectedValue})</div>`;
            
            // Highlight correct
            radios.forEach(radio => {
                if (radio.value === selectedValue) {
                    radio.parentElement.style.color = '#28a745';
                    radio.parentElement.style.fontWeight = 'bold';
                }
            });
        } else {
            feedbackHtml += `<div style="color: #dc3545; margin: 5px 0;">
                ${letter}) ‚ùå Sai (Ch·ªçn: ${selectedValue}, ƒê√°p √°n: ${expectedText})
            </div>`;
            allCorrect = false;
            
            // Highlight wrong and correct
            radios.forEach(radio => {
                if (radio.checked) {
                    radio.parentElement.style.color = '#dc3545';
                }
                if (radio.value === expectedText) {
                    radio.parentElement.style.color = '#28a745';
                    radio.parentElement.style.fontWeight = 'bold';
                }
            });
        }
        
        // Disable radios
        radios.forEach(radio => radio.disabled = true);
    });
    
    // 5. Hi·ªÉn th·ªã k·∫øt qu·∫£
    const score = correctCount * 0.25;
    const resultDiv = document.createElement('div');
    resultDiv.innerHTML = `
        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
            <h4 style="color: #1a237e; margin-bottom: 10px;">üìä K·∫øt qu·∫£:</h4>
            ${feedbackHtml}
            <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 8px;">
                <strong>ƒê√∫ng:</strong> ${correctCount}/4 c√¢u<br>
                <strong>ƒêi·ªÉm:</strong> <span style="color: ${allCorrect ? '#28a745' : '#ffc107'}">${score.toFixed(2)}/1.00</span><br>
                <strong>K·∫øt qu·∫£:</strong> ${allCorrect ? 'üéâ Ho√†n h·∫£o!' : 'C·∫ßn c·ªë g·∫Øng h∆°n!'}
            </div>
        </div>
    `;
    
    // X√≥a k·∫øt qu·∫£ c≈© n·∫øu c√≥
    const oldResult = container.querySelector('.true-false-result');
    if (oldResult) oldResult.remove();
    
    resultDiv.className = 'true-false-result';
    container.appendChild(resultDiv);
    
    // 6. Th√¥ng b√°o
    console.log(`‚úÖ Check completed: ${correctCount}/4 correct, score: ${score}`);
    if (allCorrect) {
        showNotification(`üéâ Ho√†n to√†n ch√≠nh x√°c! (${correctCount}/4)`, 'success');
    } else {
        showNotification(`ƒê√∫ng ${correctCount}/4 m·ªánh ƒë·ªÅ`, 'warning');
    }
};
window.checkShortAnswer = function(qid, correct) {
    const input = document.getElementById(`input-${qid}`);
    const icon = document.getElementById(`icon-${qid}`);
    const resultBox = input?.closest(".answer-check");

    if (!input) return;

    const userAnswer = input.value.trim();

    let feedback = resultBox.querySelector(".result");
    if (!feedback) {
        feedback = document.createElement("div");
        feedback.className = "result";
        feedback.style.marginTop = "10px";
        feedback.style.padding = "12px";
        feedback.style.borderRadius = "8px";
        feedback.style.background = "rgba(255,255,255,0.9)";
        feedback.style.border = "1px solid #e0e0e0";
        feedback.style.fontSize = "0.95em";
        resultBox.appendChild(feedback);
    }

    if (userAnswer === "") {
        icon.textContent = "‚ö†Ô∏è";
        feedback.innerHTML = "‚ùó <b>B√°o th·∫ßy ki·ªÉm tr·ª±c ti·∫øp v√¨ ch∆∞a gi·∫£i.</b>";
        playSound('wrong');
        return;
    }

    const normalizedUser = userAnswer.toLowerCase().replace(/\s+/g, '');
    const normalizedCorrect = correct.trim().toLowerCase().replace(/\s+/g, '');

    if (normalizedUser === normalizedCorrect) {
        icon.textContent = "‚úÖ";
        feedback.innerHTML = `
            <div style="color: #28a745; font-weight: bold;">
                üéØ <b>ƒê√∫ng r·ªìi!</b>
            </div>
            <div style="margin-top: 5px;">ƒê√°p √°n c·ªßa b·∫°n: <b>${userAnswer}</b></div>
        `;
        input.style.borderColor = '#28a745';
        input.style.background = '#d4edda';
        input.disabled = true;
        
        if (currentUser && sessionCode) {
            try { savePartial(qid, userAnswer, correct, true); } catch(e){}
        }
        playSound('correct');
        showNotification(`‚úÖ C√¢u ${qid}: Ch√≠nh x√°c!`, 'success');
    } else {
        icon.textContent = "‚ùå";
        feedback.innerHTML = `
            <div style="color: #dc3545; font-weight: bold;">
                ‚ùå <b>Sai r·ªìi.</b>
            </div>
            <div style="margin-top: 5px;">ƒê√°p √°n c·ªßa b·∫°n: <b>${userAnswer}</b></div>
            <div>ƒê√°p √°n ƒë√∫ng l√†: <b style="color: #28a745">${correct}</b></div>
        `;
        input.style.borderColor = '#dc3545';
        input.style.background = '#f8d7da';
        input.disabled = true;
        
        if (currentUser && sessionCode) {
            try { savePartial(qid, userAnswer, correct, false); } catch(e){}
        }
        playSound('wrong');
        showNotification(`‚ùå C√¢u ${qid}: Ch∆∞a ch√≠nh x√°c`, 'error');
    }
};

function playSound(type) {
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance();
        utterance.text = type === 'correct' ? 'Ch√≠nh x√°c!' : (type === 'partial' ? 'G·∫ßn ƒë√∫ng r·ªìi' : 'Sai r·ªìi!');
        utterance.lang = 'vi-VN';
        utterance.volume = 0.7;
        utterance.rate = 1.2;
        speechSynthesis.speak(utterance);
    }
}

// ===== SCORE SAVING =====
window.savePartial = async function(questionId, userAnswer, correctAnswer, isCorrect) {
    if (!currentUser || !sessionCode) return;

    try {
        await db.ref(`partialResults/${sessionCode}/${currentUser.uid}/${questionId}`).set({
            userAnswer,
            correctAnswer,
            isCorrect,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    } catch (err) {
        console.error("‚ùå L·ªói l∆∞u k·∫øt qu·∫£ t·ª´ng ph·∫ßn:", err);
    }
};

window.saveAttempt = async function(testId, detailsOrScore, maybeScore) {
    if (!currentUser || !sessionCode) {
        console.warn("‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi l∆∞u!");
        return;
    }

    let answers = {};
    let totalScore = 0;

    if (typeof detailsOrScore === 'object' && maybeScore !== undefined) {
        answers = detailsOrScore.studentAnswers || {};
        totalScore = parseFloat(maybeScore);
    } else {
        totalScore = parseFloat(detailsOrScore);
    }

    try {
        await db.ref(`attempts/${sessionCode}/${currentUser.uid}`).set({
            code: currentUser.code,
            name: currentUser.name,
            testId,
            score: totalScore,
            answers,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            sessionCode: sessionCode
        });
        
        console.log("‚úÖ ƒê√£ l∆∞u ƒëi·ªÉm:", totalScore);
        showNotification(`‚úÖ ƒê√£ l∆∞u k·∫øt qu·∫£: ${totalScore.toFixed(2)} ƒëi·ªÉm`, 'success');
    } catch (err) {
        console.error("‚ùå L·ªói l∆∞u:", err);
        showNotification('‚ùå L·ªói khi l∆∞u k·∫øt qu·∫£', 'error');
    }
};

// ===== FINAL SCORE CALCULATION =====
window.calculateFinalScore = async function() {
    if (isTeacherLoggedIn) {
        showNotification("Gi√°o vi√™n kh√¥ng t√≠nh ƒëi·ªÉm.", "info");
        return;
    }
    
    if (!currentUser || !sessionCode) {
        showNotification("Vui l√≤ng ƒëƒÉng nh·∫≠p v√† tham gia l·ªõp h·ªçc.", "warning");
        return;
    }

    window.isScoreCalculated = false;
    
    const studentAnswers = {};
    const correctAnswers = {};
    let totalScore = 0;

    // Collect correct answers
    document.querySelectorAll('.question').forEach(q => {
        const qid = q.id;
        if (!qid) return;
        
        const btn = q.querySelector('button[onclick*="check"]');
        const onclickStr = btn ? (btn.getAttribute('onclick') || '') : '';

        if (onclickStr.includes('checkTrueFalseAnswer')) {
            const arrMatch = onclickStr.match(/\[(.*?)\]/);
            if (arrMatch) {
                const arr = arrMatch[1].split(',').map(s => s.replace(/['"\s\[\]]/g, '').trim());
                if (arr.length) correctAnswers[qid] = arr;
            }
        } else if (onclickStr.includes('checkShortAnswer')) {
            const m = onclickStr.match(/checkShortAnswer\(['"]([^'"]+)['"]\s*,\s*['"]([^'"]+)['"]\)/);
            if (m) correctAnswers[m[1]] = m[2];
        } else if (onclickStr.includes('checkAnswer')) {
            const m = onclickStr.match(/checkAnswer\(['"]([^'"]+)['"]\s*,\s*['"]([A-Za-z0-9]+)['"]\)/);
            if (m) correctAnswers[m[1]] = m[2].toString().toUpperCase();
        }

        if (!correctAnswers[qid]) {
            const dataCorrect = q.getAttribute('data-correct');
            if (dataCorrect) {
                try { 
                    correctAnswers[qid] = JSON.parse(dataCorrect); 
                } catch(e) { 
                    correctAnswers[qid] = dataCorrect; 
                }
            }
        }
    });

    // Collect student answers
    for (let i = 1; i <= 12; i++) {
        const name = 'q' + i;
        const selected = document.querySelector(`input[name="${name}"]:checked`);
        studentAnswers[name] = selected ? selected.value.trim() : '';
    }

    for (let i = 13; i <= 16; i++) {
        const sub = [];
        ['a','b','c','d'].forEach(letter => {
            const sel = document.querySelector(`input[name="q${i}${letter}"]:checked`);
            sub.push(sel ? sel.value.trim() : '');
        });
        studentAnswers['q' + i] = sub;
    }

    for (let i = 17; i <= 22; i++) {
        const el = document.getElementById(`input-q${i}`);
        studentAnswers['q' + i] = el ? el.value.trim().replace(',', '.') : '';
    }

    // Calculate score
    for (let i = 1; i <= 22; i++) {
        const key = 'q' + i;
        const userAns = studentAnswers[key];
        const corr = correctAnswers[key];
        
        if (i >= 1 && i <= 12) {
            if (!corr) continue;
            if (userAns && String(userAns).toUpperCase() === String(corr).toUpperCase()) {
                totalScore += 0.25;
            }
        } else if (i >= 13 && i <= 16) {
            if (!Array.isArray(corr) || !Array.isArray(userAns)) continue;
            
            let correctCount = 0;
            for (let j = 0; j < corr.length && j < userAns.length; j++) {
                const exp = String(corr[j]).toLowerCase();
                const u = String(userAns[j]).toLowerCase();
                if (u && (u === exp || 
                    (exp.startsWith('t') && u.startsWith('t')) || 
                    (exp.startsWith('ƒë') && u.startsWith('ƒë')))) {
                    correctCount++;
                }
            }
            
            if (correctCount === 1) totalScore += 0.1;
            else if (correctCount === 2) totalScore += 0.25;
            else if (correctCount === 3) totalScore += 0.5;
            else if (correctCount === 4) totalScore += 1;
        } else if (i >= 17 && i <= 22) {
            if (typeof corr === 'undefined') continue;
            
            const userNum = parseFloat((userAns || '').toString().replace(',', '.'));
            const corrNum = parseFloat((corr || '').toString().replace(',', '.'));
            
            if (!isNaN(userNum) && !isNaN(corrNum)) {
                if (Math.abs(userNum - corrNum) < 0.001) {
                    totalScore += 0.5;
                }
            } else {
                if ((userAns || '').toString().trim().toLowerCase() === 
                    (corr || '').toString().trim().toLowerCase()) {
                    totalScore += 0.5;
                }
            }
        }
    }

    // Display result
    const finalScore = totalScore.toFixed(2);
    let resultBox = document.getElementById('score-result');
    
    if (!resultBox) {
        resultBox = document.createElement('div');
        resultBox.id = 'score-result';
        resultBox.style.cssText = `
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            background: rgba(0,0,0,0.9); 
            color: #fff; 
            padding: 20px; 
            border-radius: 12px; 
            z-index: 99999; 
            font-size: 16px;
            max-width: 300px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 2px solid ${finalScore >= 5 ? '#28a745' : '#dc3545'};
        `;
        document.body.appendChild(resultBox);
    }
    
    const scoreColor = finalScore >= 8 ? '#28a745' : finalScore >= 5 ? '#ffc107' : '#dc3545';
    const scoreEmoji = finalScore >= 8 ? 'üèÜ' : finalScore >= 5 ? '‚úÖ' : '‚ùå';
    
    resultBox.innerHTML = `
        <div style="text-align: center; margin-bottom: 10px;">
            <div style="font-size: 2em;">${scoreEmoji}</div>
            <div style="font-size: 1.2em; font-weight: bold; color: ${scoreColor};">
                ${finalScore} / 10.00
            </div>
        </div>
        <div style="font-size: 0.9em; text-align: center;">
            ${finalScore >= 8 ? 'Xu·∫•t s·∫Øc! üéâ' : finalScore >= 5 ? 'ƒê·∫°t y√™u c·∫ßu! üëç' : 'C·∫ßn c·ªë g·∫Øng th√™m! üí™'}
        </div>
    `;

    try { 
        playSound(finalScore >= 5 ? 'correct' : 'wrong'); 
    } catch(e){}
    
    if (currentUser && sessionCode && typeof saveAttempt === 'function') {
        await saveAttempt(document.title || 'de1', { studentAnswers, correctAnswers }, finalScore);
        resultBox.innerHTML += `
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3); font-size: 0.8em; text-align: center;">
                ‚úÖ K·∫øt qu·∫£ ƒë√£ l∆∞u v√†o h·ªá th·ªëng
            </div>
        `;
    } else {
        resultBox.innerHTML += `
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3); font-size: 0.8em; text-align: center;">
                ‚ÑπÔ∏è Ch∆∞a ƒëƒÉng nh·∫≠p ‚Äî k·∫øt qu·∫£ ch·ªâ hi·ªÉn th·ªã t·∫°m th·ªùi
            </div>
        `;
    }

    console.log('=== correctAnswers ===', correctAnswers);
    console.log('=== studentAnswers ===', studentAnswers);
    console.log('=== totalScore ===', finalScore);
    
    window.isScoreCalculated = true;
    
    if (currentUser && sessionCode) {
        await db.ref(`sessions/${sessionCode}/students/${currentUser.uid}`).update({
            score: parseFloat(finalScore),
            status: 'finished',
            finished: firebase.database.ServerValue.TIMESTAMP
        });
    }
};

// ===== NOTIFICATION SYSTEM =====
function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    notification.innerHTML = message;
    notification.className = `notification ${type}`;
    notification.classList.add('show');
    setTimeout(() => { notification.classList.remove('show'); }, 6000);
}

// ===== CANVAS DRAWING =====
function setupCanvas() {
    const canvas = document.getElementById("drawCanvas");
    const ctx = canvas.getContext("2d");
    const toggleBtn = document.getElementById("toggleMenu");
    const toolbar = document.getElementById("drawToolbar");
    const exitBtn = document.getElementById("exitBtn");

    let isDrawMode = false;
    let isDrawing = false;
    let history = [];
    let currentTool = "pen";
    let startX, startY, lastX, lastY;
    let imageBeforeShape;

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        ctx.lineJoin = "round";
        ctx.lineCap = "round";
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    toggleBtn.onclick = () => {
        isDrawMode = !isDrawMode;
        canvas.style.display = isDrawMode ? "block" : "none";
        toolbar.style.display = isDrawMode ? "flex" : "none";
        canvas.style.pointerEvents = isDrawMode ? "auto" : "none";
    };
    exitBtn.onclick = toggleBtn.onclick;

    document.getElementById("tool").onchange = e => currentTool = e.target.value;
    document.getElementById("clearBtn").onclick = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        history = [];
    };
    document.getElementById("saveBtn").onclick = () => {
        const link = document.createElement("a");
        link.download = "ban_ve.png";
        link.href = canvas.toDataURL();
        link.click();
    };
    document.getElementById("undoBtn").onclick = () => {
        if (history.length > 0) ctx.putImageData(history.pop(), 0, 0);
    };

    const getPos = e => {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches && e.touches[0];
        const clientX = touch ? touch.clientX : e.clientX;
        const clientY = touch ? touch.clientY : e.clientY;
        return { 
            x: (clientX - rect.left) * (canvas.width / rect.width), 
            y: (clientY - rect.top) * (canvas.height / rect.height) 
        };
    };

    const startDraw = e => {
        if (!isDrawMode) return;
        e.preventDefault();
        history.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
        isDrawing = true;
        const pos = getPos(e);
        startX = lastX = pos.x;
        startY = lastY = pos.y;
        if (currentTool !== 'pen') {
            imageBeforeShape = ctx.getImageData(0, 0, canvas.width, canvas.height);
        }
        ctx.beginPath();
    };

    const drawMove = e => {
        if (!isDrawing || !isDrawMode) return;
        e.preventDefault();
        ctx.strokeStyle = document.getElementById("colorPicker").value;
        ctx.lineWidth = document.getElementById("draw-width").value;
        const pos = getPos(e);
        
        if (currentTool !== "pen" && imageBeforeShape) {
            ctx.putImageData(imageBeforeShape, 0, 0);
        }

        ctx.beginPath();
        switch (currentTool) {
            case "pen":
                ctx.moveTo(lastX, lastY); 
                ctx.lineTo(pos.x, pos.y); 
                ctx.stroke();
                [lastX, lastY] = [pos.x, pos.y];
                break;
            case "line":
                ctx.moveTo(startX, startY); 
                ctx.lineTo(pos.x, pos.y); 
                ctx.stroke();
                break;
            case "dashedLineBtn":
                ctx.setLineDash([8, 6]); 
                ctx.moveTo(startX, startY); 
                ctx.lineTo(pos.x, pos.y); 
                ctx.stroke(); 
                ctx.setLineDash([]);
                break;
            case "rect":
                ctx.strokeRect(startX, startY, pos.x - startX, pos.y - startY);
                break;
            case "circle":
                ctx.arc(startX, startY, Math.hypot(pos.x - startX, pos.y - startY), 0, Math.PI * 2); 
                ctx.stroke();
                break;
            case "ellipseBtn":
                ctx.ellipse(startX, startY, Math.abs(pos.x - startX), Math.abs(pos.y - startY), 0, 0, Math.PI * 2); 
                ctx.stroke();
                break;
            case "parallelogram":
                const width_p = pos.x - startX, height_p = pos.y - startY, offset_p = width_p * 0.3;
                ctx.moveTo(startX + offset_p, startY); 
                ctx.lineTo(startX + width_p + offset_p, startY);
                ctx.lineTo(startX + width_p - offset_p, startY + height_p); 
                ctx.lineTo(startX - offset_p, startY + height_p);
                ctx.closePath(); 
                ctx.stroke();
                break;
            case "box":
                const w = pos.x - startX, h = pos.y - startY, d = Math.min(Math.abs(w), Math.abs(h)) * 0.4;
                ctx.strokeRect(startX, startY, w, h); 
                ctx.strokeRect(startX + d, startY - d, w, h);
                [[startX, startY, startX + d, startY - d], 
                 [startX + w, startY, startX + w + d, startY - d],
                 [startX, startY + h, startX + d, startY + h - d], 
                 [startX + w, startY + h, startX + w + d, startY + h - d]].forEach(c => {
                    ctx.moveTo(c[0], c[1]); 
                    ctx.lineTo(c[2], c[3]);
                });
                ctx.stroke();
                break;
            case "pyramid3":
                const baseLeft = { x: startX, y: pos.y }; 
                const baseRight = { x: pos.x, y: pos.y };
                const apex = { x: (startX + pos.x) / 2, y: startY };
                ctx.moveTo(apex.x, apex.y); 
                ctx.lineTo(baseLeft.x, baseLeft.y); 
                ctx.lineTo(baseRight.x, baseRight.y); 
                ctx.closePath(); 
                ctx.stroke();
                break;
            case "pyramid4":
                const w4 = pos.x - startX, h4 = pos.y - startY;
                const apex4 = {x: startX + w4 / 2, y: startY - h4 };
                ctx.strokeRect(startX, startY, w4, h4);
                [[startX, startY], [startX+w4, startY], [startX, startY+h4], [startX+w4, startY+h4]].forEach(([bx,by]) => {
                    ctx.moveTo(apex4.x, apex4.y); 
                    ctx.lineTo(bx,by);
                });
                ctx.stroke();
                break;
            case "sphere":
                const rs = Math.abs(pos.x-startX);
                ctx.arc(startX, startY, rs, 0, Math.PI * 2); 
                ctx.stroke();
                ctx.beginPath(); 
                ctx.setLineDash([6,4]);
                ctx.ellipse(startX, startY, rs, rs / 2.5, 0, 0, Math.PI*2); 
                ctx.stroke();
                ctx.setLineDash([]);
                break;
        }
    };

    const endDraw = () => { 
        if(isDrawing) { 
            isDrawing = false; 
            ctx.beginPath();
        }
    };

    canvas.addEventListener("mousedown", startDraw);
    canvas.addEventListener("mousemove", drawMove);
    canvas.addEventListener("mouseup", endDraw);
    canvas.addEventListener("mouseleave", endDraw);
    canvas.addEventListener("touchstart", startDraw, { passive: false });
    canvas.addEventListener("touchmove", drawMove, { passive: false });
    canvas.addEventListener("touchend", endDraw);
}

// ===== FULLSCREEN =====
function setupFullscreen() {
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    if (!fullscreenBtn) return;
    
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    
    document.addEventListener('fullscreenchange', updateFullscreenButton);
}

function toggleFullscreen() {
    if (!document.fullscreenElement) {
        if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen();
        }
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
    }
}

function updateFullscreenButton() {
    const btn = document.getElementById('fullscreenBtn');
    if (document.fullscreenElement) {
        btn.textContent = 'üì∫ Exit';
    } else {
        btn.textContent = 'üì∫ Fullscreen';
    }
}

// F11 shortcut
document.addEventListener('keydown', function(e) {
    if (e.key === 'F11') {
        e.preventDefault();
        toggleFullscreen();
    }
});

// ===== DARK MODE =====
document.addEventListener("DOMContentLoaded", () => {
    const toggleBtn = document.getElementById("toggleStyleBtn");
    let isDark = localStorage.getItem('darkMode') === "True";

    if (isDark) {
        document.documentElement.classList.add("dark-mode");
        toggleBtn.textContent = "‚òÄÔ∏è Ch·∫ø ƒë·ªô s√°ng";
    }

    toggleBtn.addEventListener("click", () => {
        isDark = !isDark;
        document.documentElement.classList.toggle("dark-mode", isDark);
        toggleBtn.textContent = isDark ? "‚òÄÔ∏è Ch·∫ø ƒë·ªô s√°ng" : "üåô Ch·∫ø ƒë·ªô t·ªëi";
        
        localStorage.setItem('darkMode', isDark);

        if (window.MathJax) {
            MathJax.typesetPromise();
        }
    });
});

// ===== POLL SYSTEM =====
function setupPollSystem() {
    document.getElementById('poll-submit-btn').addEventListener('click', submitPollResponse);
}

function startPoll() {
    if (!isTeacherLoggedIn || !sessionCode) return showNotification('Vui l√≤ng ƒëƒÉng nh·∫≠p GV v√† t·∫°o l·ªõp', 'error');
    const question = prompt('Nh·∫≠p c√¢u h·ªèi kh·∫£o s√°t:');
    if (!question) return;
    const options = prompt('Nh·∫≠p c√°c l·ª±a ch·ªçn, c√°ch nhau b·ªüi d·∫•u ph·∫©y (vd: A,B,C):')?.split(',') || [];
    if (options.length < 2) return showNotification('C·∫ßn √≠t nh·∫•t 2 l·ª±a ch·ªçn!', 'error');

    const pollData = {
        question, 
        options: options.map(o => o.trim()), 
        active: true,
        created: firebase.database.ServerValue.TIMESTAMP
    };
    
    db.ref('sessions/' + sessionCode + '/poll').set(pollData)
        .then(() => showNotification('‚úÖ Kh·∫£o s√°t ƒë√£ b·∫Øt ƒë·∫ßu!', 'success'));
}

function showPoll(pollData) {
    document.getElementById('poll-title').textContent = pollData.question;
    const optionsDiv = document.getElementById('poll-options');
    optionsDiv.innerHTML = pollData.options.map((option, index) =>
        `<div class="poll-option" data-index="${index}">${String.fromCharCode(65 + index)}. ${option}</div>`
    ).join('');
    
    optionsDiv.querySelectorAll('.poll-option').forEach(el => {
        el.onclick = () => {
            optionsDiv.querySelectorAll('.poll-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
        };
    });
    showModal('poll-modal');
}

function hidePoll() {
    hideModal(document.getElementById('poll-modal'));
}

function submitPollResponse() {
    const selectedOption = document.querySelector('.poll-option.selected');
    if (!selectedOption) return showNotification('Vui l√≤ng ch·ªçn m·ªôt ph∆∞∆°ng √°n!', 'warning');
    if (!sessionCode || !currentUser) return showNotification('Vui l√≤ng ƒëƒÉng nh·∫≠p!', 'error');

    const responseIndex = parseInt(selectedOption.dataset.index);
    db.ref(`sessions/${sessionCode}/poll/responses/${currentUser.uid}`).set({
        name: currentUser.name, choice: responseIndex
    }).then(() => {
        showNotification('‚úÖ ƒê√£ g·ª≠i ph·∫£n h·ªìi!', 'success');
        hidePoll();
    });
}

// ===== STUDENT INTERACTION =====
function setupStudentInteraction() {
    document.getElementById('studentInteractBtn').addEventListener('click', () => {
        if (!currentUser || !sessionCode) return showNotification('Vui l√≤ng ƒëƒÉng nh·∫≠p v√† v√†o l·ªõp!', 'error');
        const choice = prompt(`Ch·ªçn t∆∞∆°ng t√°c:\n1-‚úã Gi∆° tay\n2-‚ùì ƒê·∫∑t c√¢u h·ªèi\n3-üÜò C·∫ßn h·ªó tr·ª£`);
        if (choice === '1') sendInteraction('hand_raised');
        else if (choice === '2') {
            const question = prompt('Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n:');
            if (question) sendInteraction('question', question);
        } else if (choice === '3') sendInteraction('need_help');
    });
}

function sendInteraction(type, content = '') {
    const interactionData = { 
        student: currentUser.name, 
        type, 
        timestamp: firebase.database.ServerValue.TIMESTAMP 
    };
    if (content) interactionData.content = content;
    
    db.ref('sessions/' + sessionCode + '/interactions').push(interactionData)
        .then(() => showNotification('‚úÖ ƒê√£ g·ª≠i t∆∞∆°ng t√°c!', 'success'));
}

// ===== TEACHER MONITORING =====
function startMonitoringSession() {
    if (!sessionCode) return;
    db.ref('sessions/' + sessionCode + '/students').on('value', snapshot => updateStudentMonitor(snapshot.val()));
    db.ref('sessions/' + sessionCode + '/interactions').on('child_added', snapshot => showInteractionAlert(snapshot.val()));
}

function updateStudentMonitor(students) {
    const tbody = document.getElementById('student-results-body');
    const stats = {
        total: document.getElementById('stats-total'),
        completed: document.getElementById('stats-completed'),
        average: document.getElementById('stats-average'),
        failed: document.getElementById('stats-failed')
    };
    const liveCount = document.getElementById('live-student-count');
    
    if (!students || Object.keys(students).length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px; color: #666;">Ch∆∞a c√≥ h·ªçc sinh n√†o tham gia.</td></tr>`;
        Object.values(stats).forEach(el => el.textContent = '0');
        liveCount.textContent = '0';
        return;
    }
    
    let html = '';
    let total = 0, completed = 0, totalScore = 0, failed = 0;
    
    Object.entries(students).forEach(([studentId, student]) => {
        total++;
        const studentScore = student.score || 0;
        if (student.status === 'finished') {
             completed++;
             totalScore += studentScore;
        }
        if (studentScore < 1) failed++;
        
        const timeSpent = student.joined && student.finished ? calculateTimeSpent(student.joined, student.finished) : '--:--';
        
        let status = student.status || 'not-started';
        let statusText = getStatusText(status);
        
        if (inactiveStudents.has(studentId)) {
            statusText = '‚ùå Kh√¥ng ho·∫°t ƒë·ªông';
        }
        
        html += `
            <tr>
                <td><strong>${student.name}</strong><br><small>${student.code}</small></td>
                <td style="text-align: center;"><span class="status-${status}">${statusText}</span></td>
                <td style="text-align: center; font-weight: bold;">${studentScore.toFixed(2)}</td>
                <td style="text-align: center;">${timeSpent}</td>
                <td style="text-align: center;">
                    <div style="background: #e0e0e0; border-radius: 5px; height: 8px;"><div style="background: linear-gradient(135deg, #1a237e, #3949ab); height: 100%; border-radius: 5px; width: ${student.progress || 0}%;"></div></div>
                    <small>${student.progress || 0}%</small>
                </td>
                <td style="text-align: center;"><button onclick="viewStudentDetail('${studentId}')" style="padding: 5px 10px; border: none; background: #17a2b8; color: white; border-radius: 5px; cursor: pointer;">üìä</button></td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    stats.total.textContent = total;
    stats.completed.textContent = completed;
    stats.average.textContent = completed > 0 ? (totalScore / completed).toFixed(1) : '0.0';
    stats.failed.textContent = failed;
    liveCount.textContent = total;
}

function getStatusText(status) {
    return { 
        'active': 'ƒêang l√†m', 
        'finished': 'ƒê√£ n·ªôp', 
        'not-started': 'Ch∆∞a b·∫Øt ƒë·∫ßu' 
    }[status] || '...';
}

function calculateTimeSpent(startTime, endTime) {
    const diff = endTime - startTime;
    const minutes = Math.floor(diff / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);
    return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

function showInteractionAlert(interaction) {
    if (!isTeacherLoggedIn) return;
    
    let message = '';
    let type = 'warning';
    
    switch(interaction.type) {
        case 'hand_raised': 
            message = `‚úã ${interaction.student} ƒëang gi∆° tay!`;
            type = 'info';
            break;
        case 'question': 
            message = `‚ùì ${interaction.student}: ${interaction.content}`;
            type = 'warning';
            break;
        case 'need_help': 
            message = `üÜò ${interaction.student} c·∫ßn h·ªó tr·ª£ g·∫•p!`;
            type = 'error';
            break;
        default: return;
    }
    
    showNotification(message, type);
    
    if (document.getElementById('class-management-modal').classList.contains('active')) {
        setTimeout(viewClassInteractions, 1000);
    }
}

window.viewStudentDetail = function(studentId) {
    showNotification('T√≠nh nƒÉng xem chi ti·∫øt h·ªçc sinh ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.', 'info');
};

// ===== ADDITIONAL FUNCTIONS FROM ORIGINAL CODE =====

// Start monitoring session button
document.getElementById('monitor-create-session').addEventListener('click', createNewSession);
document.getElementById('monitor-start-poll').addEventListener('click', startPoll);
document.getElementById('monitor-sync-slides').addEventListener('click', syncSlidesWithStudents);

// Cancel buttons
document.getElementById('cancel-create-class-btn').addEventListener('click', function() {
    hideModal(document.getElementById('create-class-modal'));
});

// Export codes button
document.getElementById('export-codes-btn').addEventListener('click', function() {
    showNotification('T√≠nh nƒÉng xu·∫•t Excel ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!', 'info');
});

// Class poll functions (simplified versions)
async function startClassPoll() {
    showNotification('T√≠nh nƒÉng poll l·ªõp ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
}

async function syncClassSlides() {
    showNotification('T√≠nh nƒÉng ƒë·ªìng b·ªô l·ªõp ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
}

async function viewClassPollResults() {
    showNotification('T√≠nh nƒÉng xem k·∫øt qu·∫£ poll ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
}

async function viewClassInteractions() {
    showNotification('T√≠nh nƒÉng xem t∆∞∆°ng t√°c ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
}
// D√ÅN H√ÄM saveAttempt M·ªöI V√ÄO ƒê√ÇY:
window.saveAttempt = async function(testId, detailsOrScore, maybeScore) {
    if (!currentUser || !sessionCode) {
        console.warn("‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi l∆∞u!");
        return;
    }

    let answers = {};
    let totalScore = 0;

    if (typeof detailsOrScore === 'object' && maybeScore !== undefined) {
        answers = detailsOrScore.studentAnswers || {};
        totalScore = parseFloat(maybeScore);
    } else {
        totalScore = parseFloat(detailsOrScore);
    }

    try {
        // L∆∞u v√†o attempts
        await db.ref(`attempts/${sessionCode}/${currentUser.uid}`).set({
            code: currentUser.code,
            name: currentUser.name,
            testId,
            score: totalScore,
            answers,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            sessionCode: sessionCode,
            testName: currentExam?.name
        });
        
        // L∆∞u v√†o l·ªãch s·ª≠ c√° nh√¢n
        await saveStudentAttempt(testId, totalScore, answers);
        
        console.log("‚úÖ ƒê√£ l∆∞u ƒëi·ªÉm v√† l·ªãch s·ª≠:", totalScore);
        showNotification(`‚úÖ ƒê√£ l∆∞u k·∫øt qu·∫£: ${totalScore.toFixed(2)} ƒëi·ªÉm`, 'success');
        
    } catch (err) {
        console.error("‚ùå L·ªói l∆∞u:", err);
        showNotification('‚ùå L·ªói khi l∆∞u k·∫øt qu·∫£', 'error');
    }
};

// V√Ä TH√äM C√ÅC H√ÄM H·ªñ TR·ª¢ NGAY SAU ƒê√ì
async function saveStudentAttempt(testId, score, details) {
    if (!currentUser) return;
    
    const attemptData = {
        testId: testId,
        testName: currentExam?.name || testId,
        score: parseFloat(score),
        details: details || {},
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        completedTime: new Date().toLocaleString('vi-VN'),
        timeSpent: calculateTimeSpent(sessionStartTime, Date.now()),
        device: getDeviceInfo(),
        questions: currentQuestions || []
    };
    
    try {
        // L∆∞u v√†o l·ªãch s·ª≠ c√° nh√¢n
        await db.ref(`studentHistory/${currentUser.code}`).push(attemptData);
        
        // C·∫≠p nh·∫≠t th·ªëng k√™
        await updateStudentStatistics(score);
        
        console.log('‚úÖ ƒê√£ l∆∞u l·ªãch s·ª≠ l√†m b√†i');
        
    } catch (error) {
        console.error('Error saving attempt:', error);
        // Fallback: l∆∞u v√†o localStorage
        saveToLocalStorage(attemptData);
    }
}
// ===== NEW TRUE/FALSE FUNCTIONS FOR LESSON COLLECTION =====

// ===== NEW TRUE/FALSE FUNCTIONS FOR LESSON COLLECTION =====

window.checkSingleTrueFalse = function(uniqueId, questionId, correctAnswer) {
    const selected = document.querySelector(`input[name="tf-${uniqueId}-${questionId}"]:checked`);
    const resultEl = document.getElementById(`tf-result-${uniqueId}-${questionId}`);
    const solutionEl = document.getElementById(`tf-solution-${uniqueId}-${questionId}`);
    
    if (!selected) {
        resultEl.innerHTML = '<span style="color: #ffc107;">‚ö†Ô∏è H√£y ch·ªçn ƒê√∫ng ho·∫∑c Sai</span>';
        return;
    }
    
    const userAnswer = selected.value === 'true';
    const isCorrect = userAnswer === correctAnswer;
    
    if (isCorrect) {
        resultEl.innerHTML = '<span style="color: #28a745;">‚úÖ Ch√≠nh x√°c!</span>';
        // Highlight selected radio
        selected.parentElement.style.color = '#28a745';
        selected.parentElement.style.fontWeight = 'bold';
        selected.parentElement.style.borderColor = '#28a745';
    } else {
        resultEl.innerHTML = `<span style="color: #dc3545;">‚ùå Sai! ƒê√°p √°n: ${correctAnswer ? 'ƒê√öNG' : 'SAI'}</span>`;
        selected.parentElement.style.color = '#dc3545';
        selected.parentElement.style.borderColor = '#dc3545';
    }
    
    // Show solution
    if (solutionEl) {
        solutionEl.style.display = 'block';
    }
    
    // Disable radio after checking
    selected.disabled = true;
    
    // Save result
    if (currentUser) {
        savePartial(`tf-${uniqueId}-${questionId}`, userAnswer, correctAnswer, isCorrect);
    }
    
    // Play sound
    playSound(isCorrect ? 'correct' : 'wrong');
};

window.checkAllTrueFalse = function(uniqueId, correctAnswers) {
    const quizEl = document.getElementById(`tf-quiz-${uniqueId}`);
    if (!quizEl) return;
    
    const questions = quizEl.querySelectorAll('.tf-question');
    let score = 0;
    let total = questions.length;
    
    questions.forEach((questionEl, index) => {
        const radioName = `tf-${uniqueId}-${index}`;
        const selected = questionEl.querySelector(`input[name="${radioName}"]:checked`);
        const resultEl = questionEl.querySelector(`[id^="tf-result"]`);
        const solutionEl = questionEl.querySelector(`[id^="tf-solution"]`);
        
        if (selected) {
            const userAnswer = selected.value === 'true';
            const isCorrect = userAnswer === correctAnswers[index];
            
            if (isCorrect) {
                score++;
                if (resultEl) {
                    resultEl.innerHTML = '<span style="color: #28a745;">‚úÖ ƒê√∫ng</span>';
                }
                selected.parentElement.style.color = '#28a745';
                selected.parentElement.style.fontWeight = 'bold';
            } else {
                if (resultEl) {
                    resultEl.innerHTML = `<span style="color: #dc3545;">‚ùå Sai (ƒê√°p √°n: ${correctAnswers[index] ? 'ƒê√∫ng' : 'Sai'})</span>`;
                }
                selected.parentElement.style.color = '#dc3545';
            }
            
            if (solutionEl) {
                solutionEl.style.display = 'block';
            }
            
            // Disable all radios in this question
            questionEl.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.disabled = true;
            });
        } else {
            // No answer selected
            if (resultEl) {
                resultEl.innerHTML = '<span style="color: #ffc107;">‚≠ï Ch∆∞a ch·ªçn</span>';
            }
        }
    });
    
    // Show final score
    const percentage = (score / total * 100).toFixed(1);
    const finalScoreDiv = document.createElement('div');
    finalScoreDiv.innerHTML = `
        <div style="margin-top: 30px; padding: 20px; background: ${score === total ? '#d4edda' : '#fff3cd'}; border-radius: 12px; border: 2px solid ${score === total ? '#28a745' : '#ffc107'};">
            <h4 style="color: ${score === total ? '#155724' : '#856404'}; margin-bottom: 15px;">üìä K·∫æT QU·∫¢:</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                    <div style="font-size: 2em; font-weight: bold; color: #1a237e;">${score}/${total}</div>
                    <div style="font-size: 0.9em; color: #666;">S·ªë c√¢u ƒë√∫ng</div>
                </div>
                <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                    <div style="font-size: 2em; font-weight: bold; color: ${getScoreColor(percentage)}">${percentage}%</div>
                    <div style="font-size: 0.9em; color: #666;">T·ªâ l·ªá ƒë√∫ng</div>
                </div>
                <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                    <div style="font-size: 2em; font-weight: bold; color: ${score === total ? '#28a745' : '#ffc107'}">${(score * 0.25).toFixed(2)}</div>
                    <div style="font-size: 0.9em; color: #666;">ƒêi·ªÉm s·ªë</div>
                </div>
            </div>
            <div style="margin-top: 15px; text-align: center;">
                ${score === total ? 
                    '<span style="color: #28a745; font-weight: bold;">üéâ Xu·∫•t s·∫Øc! T·∫•t c·∫£ ƒë·ªÅu ƒë√∫ng!</span>' :
                    score >= total * 0.7 ?
                    '<span style="color: #ffc107; font-weight: bold;">üëç Kh√° t·ªët! H√£y √¥n l·∫°i c√°c c√¢u sai.</span>' :
                    '<span style="color: #dc3545; font-weight: bold;">üí™ C·∫ßn c·ªë g·∫Øng h∆°n! Xem l·∫°i l√Ω thuy·∫øt.</span>'
                }
            </div>
        </div>
    `;
    
    // Remove existing score display if any
    const existingScore = quizEl.querySelector('.score-display');
    if (existingScore) existingScore.remove();
    
    finalScoreDiv.classList.add('score-display');
    quizEl.appendChild(finalScoreDiv);
    
    // Save overall result
    if (currentUser) {
        const answers = {};
        questions.forEach((q, idx) => {
            const selected = q.querySelector(`input[name="tf-${uniqueId}-${idx}"]:checked`);
            answers[`q${idx}`] = selected ? (selected.value === 'true') : null;
        });
        
        savePartial(`tf-quiz-${uniqueId}`, answers, correctAnswers, score === total);
    }
    
    // Play sound based on score
    if (score === total) {
        playSound('correct');
        showNotification(`üéâ Ho√†n h·∫£o! ${score}/${total} c√¢u ƒë√∫ng!`, 'success');
    } else if (score >= total * 0.7) {
        playSound('partial');
        showNotification(`üëç T·ªët l·∫Øm! ƒê√∫ng ${score}/${total} c√¢u`, 'warning');
    } else {
        playSound('wrong');
        showNotification(`üí™ C·ªë g·∫Øng nh√©! ƒê√∫ng ${score}/${total} c√¢u`, 'error');
    }
};

// Helper function
function getScoreColor(percentage) {
    if (percentage >= 80) return '#28a745';
    if (percentage >= 50) return '#ffc107';
    return '#dc3545';
}
// ===== NEW TRUE/FALSE FUNCTIONS FOR LESSON COLLECTION =====

window.checkSingleTrueFalse = function(uniqueId, questionId, correctAnswer) {
    const selected = document.querySelector(`input[name="tf-${uniqueId}-${questionId}"]:checked`);
    const resultEl = document.getElementById(`tf-result-${uniqueId}-${questionId}`);
    const solutionEl = document.getElementById(`tf-solution-${uniqueId}-${questionId}`);
    
    if (!selected) {
        resultEl.innerHTML = '<span style="color: #ffc107;">‚ö†Ô∏è H√£y ch·ªçn ƒê√∫ng ho·∫∑c Sai</span>';
        return;
    }
    
    const userAnswer = selected.value === 'true';
    const isCorrect = userAnswer === correctAnswer;
    
    if (isCorrect) {
        resultEl.innerHTML = '<span style="color: #28a745;">‚úÖ Ch√≠nh x√°c!</span>';
        // Highlight selected radio
        selected.parentElement.style.color = '#28a745';
        selected.parentElement.style.fontWeight = 'bold';
        selected.parentElement.style.borderColor = '#28a745';
    } else {
        resultEl.innerHTML = `<span style="color: #dc3545;">‚ùå Sai! ƒê√°p √°n: ${correctAnswer ? 'ƒê√öNG' : 'SAI'}</span>`;
        selected.parentElement.style.color = '#dc3545';
        selected.parentElement.style.borderColor = '#dc3545';
    }
    
    // Show solution
    if (solutionEl) {
        solutionEl.style.display = 'block';
    }
    
    // Disable radio after checking
    selected.disabled = true;
    
    // Save result
    if (currentUser) {
        savePartial(`tf-${uniqueId}-${questionId}`, userAnswer, correctAnswer, isCorrect);
    }
    
    // Play sound
    playSound(isCorrect ? 'correct' : 'wrong');
};

window.checkAllTrueFalse = function(uniqueId, correctAnswers) {
    const quizEl = document.getElementById(`tf-quiz-${uniqueId}`);
    if (!quizEl) return;
    
    const questions = quizEl.querySelectorAll('.tf-question');
    let score = 0;
    let total = questions.length;
    
    questions.forEach((questionEl, index) => {
        const radioName = `tf-${uniqueId}-${index}`;
        const selected = questionEl.querySelector(`input[name="${radioName}"]:checked`);
        const resultEl = questionEl.querySelector(`[id^="tf-result"]`);
        const solutionEl = questionEl.querySelector(`[id^="tf-solution"]`);
        
        if (selected) {
            const userAnswer = selected.value === 'true';
            const isCorrect = userAnswer === correctAnswers[index];
            
            if (isCorrect) {
                score++;
                if (resultEl) {
                    resultEl.innerHTML = '<span style="color: #28a745;">‚úÖ ƒê√∫ng</span>';
                }
                selected.parentElement.style.color = '#28a745';
                selected.parentElement.style.fontWeight = 'bold';
            } else {
                if (resultEl) {
                    resultEl.innerHTML = `<span style="color: #dc3545;">‚ùå Sai (ƒê√°p √°n: ${correctAnswers[index] ? 'ƒê√∫ng' : 'Sai'})</span>`;
                }
                selected.parentElement.style.color = '#dc3545';
            }
            
            if (solutionEl) {
                solutionEl.style.display = 'block';
            }
            
            // Disable all radios in this question
            questionEl.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.disabled = true;
            });
        } else {
            // No answer selected
            if (resultEl) {
                resultEl.innerHTML = '<span style="color: #ffc107;">‚≠ï Ch∆∞a ch·ªçn</span>';
            }
        }
    });
    
    // Show final score
    const percentage = (score / total * 100).toFixed(1);
    const finalScoreDiv = document.createElement('div');
    finalScoreDiv.innerHTML = `
        <div style="margin-top: 30px; padding: 20px; background: ${score === total ? '#d4edda' : '#fff3cd'}; border-radius: 12px; border: 2px solid ${score === total ? '#28a745' : '#ffc107'};">
            <h4 style="color: ${score === total ? '#155724' : '#856404'}; margin-bottom: 15px;">üìä K·∫æT QU·∫¢:</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                    <div style="font-size: 2em; font-weight: bold; color: #1a237e;">${score}/${total}</div>
                    <div style="font-size: 0.9em; color: #666;">S·ªë c√¢u ƒë√∫ng</div>
                </div>
                <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                    <div style="font-size: 2em; font-weight: bold; color: ${getScoreColor(percentage)}">${percentage}%</div>
                    <div style="font-size: 0.9em; color: #666;">T·ªâ l·ªá ƒë√∫ng</div>
                </div>
                <div style="text-align: center; padding: 15px; background: white; border-radius: 8px;">
                    <div style="font-size: 2em; font-weight: bold; color: ${score === total ? '#28a745' : '#ffc107'}">${(score * 0.25).toFixed(2)}</div>
                    <div style="font-size: 0.9em; color: #666;">ƒêi·ªÉm s·ªë</div>
                </div>
            </div>
            <div style="margin-top: 15px; text-align: center;">
                ${score === total ? 
                    '<span style="color: #28a745; font-weight: bold;">üéâ Xu·∫•t s·∫Øc! T·∫•t c·∫£ ƒë·ªÅu ƒë√∫ng!</span>' :
                    score >= total * 0.7 ?
                    '<span style="color: #ffc107; font-weight: bold;">üëç Kh√° t·ªët! H√£y √¥n l·∫°i c√°c c√¢u sai.</span>' :
                    '<span style="color: #dc3545; font-weight: bold;">üí™ C·∫ßn c·ªë g·∫Øng h∆°n! Xem l·∫°i l√Ω thuy·∫øt.</span>'
                }
            </div>
        </div>
    `;
    
    // Remove existing score display if any
    const existingScore = quizEl.querySelector('.score-display');
    if (existingScore) existingScore.remove();
    
    finalScoreDiv.classList.add('score-display');
    quizEl.appendChild(finalScoreDiv);
    
    // Save overall result
    if (currentUser) {
        const answers = {};
        questions.forEach((q, idx) => {
            const selected = q.querySelector(`input[name="tf-${uniqueId}-${idx}"]:checked`);
            answers[`q${idx}`] = selected ? (selected.value === 'true') : null;
        });
        
        savePartial(`tf-quiz-${uniqueId}`, answers, correctAnswers, score === total);
    }
    
    // Play sound based on score
    if (score === total) {
        playSound('correct');
        showNotification(`üéâ Ho√†n h·∫£o! ${score}/${total} c√¢u ƒë√∫ng!`, 'success');
    } else if (score >= total * 0.7) {
        playSound('partial');
        showNotification(`üëç T·ªët l·∫Øm! ƒê√∫ng ${score}/${total} c√¢u`, 'warning');
    } else {
        playSound('wrong');
        showNotification(`üí™ C·ªë g·∫Øng nh√©! ƒê√∫ng ${score}/${total} c√¢u`, 'error');
    }
};

// Helper function
function getScoreColor(percentage) {
    if (percentage >= 80) return '#28a745';
    if (percentage >= 50) return '#ffc107';
    return '#dc3545';
}
// ===== INITIALIZE =====
console.log("üöÄ H·ªá th·ªëng L·ªõp To√°n Th·∫ßy B√¨nh (Scroll Mode) ƒë√£ s·∫µn s√†ng!");
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<title>GI·ªÆA K·ª≤ 1 ƒê·ªÄ 1 </title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta name="description" content="H·ªá th·ªëng d·∫°y h·ªçc To√°n tr·ª±c tuy·∫øn ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng - L·ªõp To√°n Th·∫ßy B√¨nh">
<meta name="keywords" content="to√°n, h·ªçc tr·ª±c tuy·∫øn, l·ªõp 12, √¥n thi, firebase, real-time, canvas, b·∫£ng v·∫Ω">

<!-- Reveal.js CSS -->
<link href="https://unpkg.com/reveal.js/dist/reveal.css" rel="stylesheet"/>
<link href="https://unpkg.com/reveal.js/dist/theme/white.css" id="theme" rel="stylesheet"/>

<!-- Firebase SDK (Compat version for easier integration) -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

<!-- Reveal.js & Plugins -->
<script src="https://unpkg.com/reveal.js/dist/reveal.js"></script>
<script src="https://unpkg.com/reveal.js/plugin/notes/notes.js"></script>
<script src="https://unpkg.com/reveal.js/plugin/markdown/markdown.js"></script>
<script src="https://unpkg.com/reveal.js/plugin/highlight/highlight.js"></script>
<script src="https://unpkg.com/reveal.js/plugin/math/math.js"></script>
<link href="https://unpkg.com/reveal.js/plugin/highlight/monokai.css" rel="stylesheet"/>

<!-- MathJax (Fixed Configuration) -->
<script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']]
      },
      svg: {
        fontCache: 'global'
      }
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ===== CSS C∆† B·∫¢N ===== */
* {

    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    overflow: hidden;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #333;
}

/* ===== TOPBAR ƒê∆Ø·ª¢C T·ªêI ∆ØU ===== */
.topbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 70px;
    background: linear-gradient(135deg, #1a237e, #283593);
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 25px;
    z-index: 10000;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border-bottom: 3px solid #3949ab;
}

.topbar-title {
    font-size: 1.4rem;
    font-weight: bold;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 10px;
}

.topbar-title::before {
    content: "üßÆ";
    font-size: 1.6rem;
}

.topbar-controls {
    display: flex;
    align-items: center;
    gap: 12px;
}

.topbar-controls select,
.topbar-controls button {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    background: rgba(255,255,255,0.15);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    border: 1px solid rgba(255,255,255,0.1);
}

.topbar-controls select:hover,
.topbar-controls button:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.topbar-controls select option {
    background: #283593;
    color: white;
}

/* ƒê·ªìng h·ªì */
.clock {
    font-family: 'Courier New', monospace;
    font-size: 1.2rem;
    background: rgba(255,255,255,0.2);
    padding: 8px 15px;
    border-radius: 10px;
    color: white;
    font-weight: bold;
    border: 1px solid rgba(255,255,255,0.1);
}

/* ===== REVEAL.JS SLIDES ===== */
.reveal {
    height: calc(100vh - 70px);
    margin-top: 70px;
    background: white;
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -5px 30px rgba(0,0,0,0.1);
}

.reveal .slides {
    text-align: left;
    font-size: 1.8rem;
    color: #2c3e50;
}

.reveal .slides section {
    padding: 30px 40px;
    height: 100%;
    overflow-y: auto;
    background: white;
}

.reveal h2 {
    color: #1a237e;
    margin-bottom: 25px;
    border-bottom: 3px solid #1a237e;
    padding-bottom: 15px;
    font-weight: 700;
}

.reveal h3 {
    color: #3949ab;
    margin: 20px 0 15px 0;
    font-weight: 600;
}

.reveal p, .reveal li {
    color: #34495e;
    line-height: 1.6;
    margin-bottom: 15px;
}

.reveal ul, .reveal ol {
    margin-left: 30px;
    margin-bottom: 20px;
}

/* ===== C√ÇU H·ªéI ===== */
.question {
    margin: 25px 0;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
    border-radius: 15px;
    border-left: 6px solid #1a237e;
    color: #2c3e50;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    transition: transform 0.3s ease;
}

.question:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
}

.question-title {
    margin-bottom: 20px;
    font-weight: 700;
    color: #1a237e;
    font-size: 1.1em;
    line-height: 1.5;
}

.option-row {
    margin: 12px 0;
    padding: 12px 15px;
    background: rgba(255,255,255,0.8);
    border-radius: 10px;
    color: #2c3e50;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.option-row:hover {
    background: rgba(255,255,255,1);
    border-color: #1a237e;
    transform: translateX(5px);
}

.option-row label {
    margin-left: 10px;
    cursor: pointer;
    font-weight: 500;
}

.option-row input[type="radio"] {
    transform: scale(1.2);
    margin-right: 8px;
}

.answer-check {
    margin-top: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

.answer-check input {
    padding: 12px 15px;
    border: 2px solid #ddd;
    border-radius: 10px;
    background: white;
    color: #2c3e50;
    width: 250px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.answer-check input:focus {
    outline: none;
    border-color: #1a237e;
    box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
}

.answer-check button {
    padding: 12px 25px;
    background: linear-gradient(135deg, #1a237e, #3949ab);
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.answer-check button:hover {
    background: linear-gradient(135deg, #3949ab, #1a237e);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(26, 35, 126, 0.3);
}

/* === SLIDE MENU === */
.slide-menu {
    position: fixed;
    top: 0;
    left: -400px;
    width: 400px;
    height: 100vh;
    background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
    z-index: 11000;
    transition: left 0.4s ease;
    box-shadow: 5px 0 25px rgba(0,0,0,0.3);
    color: white;
}

.slide-menu.active {
    left: 0;
}

.menu-header {
    padding: 25px;
    background: rgba(0,0,0,0.2);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid rgba(255,255,255,0.1);
}

.menu-header h3 {
    color: white;
    margin: 0;
    font-size: 1.4rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 2rem;
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    transition: background 0.3s ease;
}

.close-btn:hover {
    background: rgba(255,255,255,0.1);
}

.menu-content {
    padding: 20px;
    height: calc(100% - 80px);
    overflow-y: auto;
}

.slide-item {
    padding: 15px 20px;
    margin-bottom: 10px;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: white;
    border: 1px solid rgba(255,255,255,0.1);
}

.slide-item:hover {
    background: rgba(255,255,255,0.2);
    transform: translateX(10px);
}

.slide-item.active {
    background: rgba(255,255,255,0.25);
    border-left: 5px solid #ffd54f;
    font-weight: 600;
}

.slide-number {
    display: inline-block;
    width: 35px;
    height: 35px;
    text-align: center;
    line-height: 35px;
    margin-right: 15px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    font-weight: bold;
}

.menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 10500;
    display: none;
    backdrop-filter: blur(5px);
}

.menu-overlay.active {
    display: block;
}

/* === CANVAS V·∫º === */
#drawCanvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9000;
    display: none;
    pointer-events: none; /* kh√¥ng ch·∫∑n b·∫•m slide */
    background: transparent; /* trong su·ªët ƒë·ªÉ th·∫•y n·ªôi dung */
}


.toolbar {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.9);
    padding: 15px 25px;
    border-radius: 15px;
    display: none;
    align-items: center;
    gap: 15px;
    z-index: 9100;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
}

.toolbar select,
.toolbar input,
.toolbar button {
    padding: 8px 15px;
    border: none;
    border-radius: 8px;
    background: white;
    color: #333;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
}

.toolbar select:hover,
.toolbar input:hover,
.toolbar button:hover {
    background: #f0f0f0;
    transform: translateY(-2px);
}

.toolbar input[type="color"] {
    padding: 4px;
    height: 40px;
    width: 60px;
}

.toolbar input[type="range"] {
    width: 100px;
}

/* ===== MODAL SYSTEM C·∫¢I TI·∫æN ===== */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 12000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    color: #333;
    padding: 30px;
    border-radius: 20px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.2);
    animation: modalAppear 0.4s ease;
    position: relative;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-content-scrollable {
    max-width: 900px;
    display: flex;
    flex-direction: column;
    max-height: 85vh;
    overflow-y: hidden; 
}

.modal-content-scrollable .table-container {
    flex: 1;
    min-height: 150px;
}

.modal-close {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.modal-close:hover {
    background: #f0f0f0;
    color: #333;
}

@keyframes modalAppear {
    from {
        opacity: 0;
        transform: scale(0.8) translateY(-50px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.modal-content h3 {
    color: #1a237e;
    margin-bottom: 20px;
    text-align: center;
    font-size: 1.5rem;
    padding-right: 30px;
}

.modal-content input {
    width: 100%;
    padding: 15px;
    margin: 10px 0;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.modal-content input:focus {
    outline: none;
    border-color: #1a237e;
}

.modal-content button {
    padding: 12px 25px;
    margin: 5px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.modal-content button[type="submit"] {
    background: linear-gradient(135deg, #1a237e, #3949ab);
    color: white;
}

.modal-content button[type="submit"]:hover {
    background: linear-gradient(135deg, #3949ab, #1a237e);
    transform: translateY(-2px);
}

/* ===== TEACHER MONITOR ===== */
#teacher-monitor {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 25px 80px rgba(0,0,0,0.3);
    z-index: 20000;
    width: 95vw;
    height: 85vh;
    overflow: auto;
    color: #333;
    border: 1px solid rgba(255,255,255,0.2);
}

/* ===== B·∫¢NG ƒê·∫∏P V·ªöI STICKY HEADER ===== */
.table-container {
    max-height: 60vh;
    overflow-y: auto;
    border-radius: 15px;
    border: 2px solid #f0f0f0;
    position: relative;
}

/* Custom scrollbar ƒë·∫πp */
.table-container::-webkit-scrollbar {
    width: 8px;
}

.table-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.table-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

.table-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

th, td {
    padding: 15px;
    border: 1px solid #e0e0e0;
    text-align: left;
    color: #333;
}

th {
    background: linear-gradient(135deg, #1a237e, #3949ab);
    color: white;
    position: sticky;
    top: 0;
    font-weight: 600;
    z-index: 10;
}

tr:nth-child(even) {
    background: #f8f9ff;
}

tr:hover {
    background: #e8eaff;
    transform: scale(1.01);
    transition: all 0.2s ease;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .topbar {
        padding: 0 10px;
        height: auto;
        flex-direction: column;
    }
    .topbar-title {
        font-size: 1.1rem;
        padding: 5px 0;
    }
    .topbar-controls {
        gap: 5px;
        flex-wrap: wrap;
        justify-content: center;
    }
    .topbar-controls button, .topbar-controls select {
        padding: 6px 10px;
        font-size: 0.85rem;
    }
    .reveal {
        margin-top: 110px;
        height: calc(100vh - 110px);
    }
    .slide-menu { width: 300px; left: -300px; }
    .reveal .slides { font-size: 1.5rem; }
    .reveal .slides section { padding: 20px; }
    .modal-content {
        padding: 20px;
        width: 95%;
    }
    .modal-content-scrollable {
        max-width: 95%;
    }
}

/* N√∫t t∆∞∆°ng t√°c h·ªçc sinh */
#studentInteractBtn {
    display: none;
}

/* Teacher controls */
#teacher-controls {
    display: none;
    position: fixed;
    top: 80px;
    right: 30px;
    z-index: 22000;
    gap: 10px;
    flex-direction: column;
    background: rgba(255,255,255,0.95);
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
}

#teacher-controls button {
    padding: 12px 20px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

#create-session-btn {
    background: linear-gradient(135deg, #17a2b8, #138496);
    color: #fff;
}

#start-poll-btn {
    background: linear-gradient(135deg, #ffc107, #e0a800);
    color: #000;
}

#view-poll-results-btn {
    background: linear-gradient(135deg, #6f42c1, #5a2d91);
    color: #fff;
}

#teacher-controls button:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

/* Firebase status indicator */
.firebase-status {
    position: fixed;
    top: 75px;
    right: 15px;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.85rem;
    z-index: 10001;
    font-weight: 600;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
}

.firebase-connected {
    background: rgba(40, 167, 69, 0.9);
    color: white;
}

.firebase-disconnected {
    background: rgba(220, 53, 69, 0.9);
    color: white;
}

/* Poll options */
.poll-option {
    padding: 15px;
    margin: 10px 0;
    background: #f8f9fa;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.poll-option:hover {
    background: #e9ecef;
    transform: translateX(10px);
}

.poll-option.selected {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border-color: #0056b3;
    transform: translateX(15px);
}

/* Status indicators */
.status-active, .status-finished, .status-not-started {
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    border: 1px solid transparent;
}
.status-active {
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    color: #155724;
    border-color: #c3e6cb;
}
.status-finished {
    background: linear-gradient(135deg, #cce5ff, #b8daff);
    color: #004085;
    border-color: #b8daff;
}
.status-not-started {
    background: linear-gradient(135deg, #f8d7da, #f5c6cb);
    color: #721c24;
    border-color: #f5c6cb;
}

/* Solution Box */
.solution-box {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    border-left: 6px solid #1976d2;
    padding: 20px;
    margin: 20px 0;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(25, 118, 210, 0.1);
}

.solution-title {
    color: #1976d2;
    font-weight: 700;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.solution-title::before {
    content: "üí°";
    font-size: 1.2em;
}

.solution-content {
    color: #1565c0;
    line-height: 1.6;
}

/* Progress bar */
.progress-bar {
    width: 100%;
    height: 8px;
    background: #e0e0e0;
    border-radius: 10px;
    margin: 20px 0;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(135deg, #1a237e, #3949ab);
    border-radius: 10px;
    transition: width 0.5s ease;
}

/* Loading spinner */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #1a237e;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Notification system */
.notification {
    position: fixed;
    top: 80px;
    right: 20px;
    padding: 15px 25px;
    border-radius: 10px;
    color: white;
    font-weight: 600;
    z-index: 100000;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    transform: translateX(400px);
    transition: transform 0.4s ease;
}

.notification.show {
    transform: translateX(0);
}

.notification.success {
    background: linear-gradient(135deg, #28a745, #20c997);
}

.notification.error {
    background: linear-gradient(135deg, #dc3545, #c82333);
}

.notification.warning {
    background: linear-gradient(135deg, #ffc107, #e0a800);
    color: #000;
}

.notification.info {
    background: linear-gradient(135deg, #17a2b8, #138496);
}

/* CSS cho icon ƒë√°p √°n */
.option-icon {
    margin-left: 10px;
    font-weight: bold;
    font-size: 1.1em;
    min-width: 20px;
    display: inline-block;
}

.option-row {
    display: flex;
    align-items: center;
    margin: 12px 0;
    padding: 12px 15px;
    background: rgba(255,255,255,0.8);
    border-radius: 10px;
    color: #2c3e50;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.option-row:hover {
    background: rgba(255,255,255,1);
    border-color: #1a237e;
    transform: translateX(5px);
}

.option-row label {
    margin-left: 10px;
    cursor: pointer;
    font-weight: 500;
    flex: 1;
}

.option-row input[type="radio"] {
    transform: scale(1.2);
    margin-right: 8px;
    cursor: pointer;
}

/* Confirm Modal */
.confirm-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 13000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.confirm-modal.active {
    display: flex;
}

.confirm-content {
    background: white;
    padding: 30px;
    border-radius: 15px;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.confirm-content h3 {
    color: #1a237e;
    margin-bottom: 15px;
}

.confirm-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
}

.confirm-buttons button {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.confirm-yes {
    background: #dc3545;
    color: white;
}

.confirm-no {
    background: #6c757d;
    color: white;
}

.confirm-yes:hover {
    background: #c82333;
    transform: translateY(-2px);
}

.confirm-no:hover {
    background: #5a6268;
    transform: translateY(-2px);
}
/* ===== S·ª¨A L·ªñI GIAO DI·ªÜN DANH S√ÅCH H·ªåC SINH ===== */
#class-management-modal .modal-content-scrollable {
    max-height: 85vh !important;
    overflow-y: auto !important;
}

#class-management-modal .table-container {
    max-height: 400px !important;
    overflow-y: auto !important;
}

/* ƒê·∫£m b·∫£o modal kh√¥ng b·ªã che */
.modal-content {
    z-index: 12001 !important;
}

.modal {
    z-index: 12000 !important;
}

/* S·ª≠a l·ªói sticky header */
.table-container thead th {
    position: sticky !important;
    top: 0 !important;
    z-index: 10 !important;
}

/* ƒê·∫£m b·∫£o n·ªôi dung hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß */
#students-list-body tr {
    height: auto !important;
    min-height: 60px !important;
}

#students-list-body td {
    padding: 12px 8px !important;
    vertical-align: middle !important;
}

/* Responsive cho mobile */
@media (max-width: 768px) {
    #class-management-modal .modal-content-scrollable {
        max-height: 90vh !important;
        padding: 15px !important;
    }
    
    #class-management-modal .table-container {
        max-height: 300px !important;
        font-size: 12px !important;
    }
    
    #students-list-body td {
        padding: 8px 4px !important;
        font-size: 11px !important;
    }
    
    #students-list-body button {
        padding: 4px 8px !important;
        font-size: 10px !important;
        margin: 1px !important;
    }
}

/* Scrollbar t√πy ch·ªânh */
#class-management-modal .modal-content-scrollable::-webkit-scrollbar {
    width: 8px;
}

#class-management-modal .modal-content-scrollable::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

#class-management-modal .modal-content-scrollable::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

#class-management-modal .modal-content-scrollable::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
#teacherMonitorBtn {
    display: none !important;
}
.poll-class-item:hover {
    background: #e3f2fd !important;
    border-color: #2196f3 !important;
    transform: translateY(-2px);
}

.table-container {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
}
.interaction-item:hover {
    background: #e3f2fd !important;
    transform: translateY(-2px);
    transition: all 0.3s ease;
}

.class-interactions-section {
    background: white;
    padding: 15px;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
}
/* ===== DARK MODE ===== */
.dark-mode body,
.dark-mode .reveal,
.dark-mode .reveal .slides section {
    background: #000 !important;
    color: #fff !important;
}

.dark-mode .reveal h1,
.dark-mode .reveal h2,
.dark-mode .reveal h3,
.dark-mode .reveal p,
.dark-mode .reveal li,
.dark-mode .reveal strong {
    color: #fff !important;
    font-weight: 700 !important;
}

.dark-mode .question {
    background: rgba(20, 20, 20, 0.9) !important;
    color: #fff !important;
    border-left: 6px solid #00bcd4 !important;
}

.dark-mode .solution-box {
    background: rgba(33, 33, 33, 0.9) !important;
    color: #e0e0e0 !important;
    border-left: 6px solid #4caf50 !important;
}

.dark-mode .option-row {
    background: rgba(40,40,40,0.9) !important;
    color: #fff !important;
    border: 1px solid #555 !important;
}

.dark-mode .option-row:hover {
    background: rgba(80,80,80,1) !important;
}

.dark-mode .topbar {
    background: linear-gradient(135deg, #000, #333) !important;
}

.dark-mode .topbar-controls button {
    background: rgba(255,255,255,0.15) !important;
    color: #fff !important;
}

.dark-mode .slide-menu {
    background: #111 !important;
}

.dark-mode img {
    filter: brightness(0.8) contrast(1.2);
}

.dark-mode .MathJax {
    color: #fff !important;
}

.dark-mode #toggleStyleBtn {
    background: linear-gradient(135deg, #4caf50, #2e7d32) !important;
    color: #fff !important;
}

</style>
<style>
/* CSS cho T·∫§T C·∫¢ c√°c b·∫£ng trong ƒë·ªÅ thi - KH√îNG C·∫¶N ƒê·ªîI CODE */
.reveal .slides section table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 1.2em;
    font-weight: bold;
    background: #000 !important;
    color: #fff !important;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

.reveal .slides section table th {
    background: linear-gradient(135deg, #1a237e, #3949ab) !important;
    color: #fff !important;
    padding: 15px 12px !important;
    text-align: center;
    font-size: 1.1em;
    font-weight: 700;
    border: 2px solid #3949ab !important;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.reveal .slides section table td {
    padding: 14px 12px !important;
    text-align: center;
    border: 2px solid #333 !important;
    background: #111 !important;
    color: #fff !important;
    font-weight: bold;
    transition: all 0.3s ease;
}

.reveal .slides section table tr:hover td {
    background: #222 !important;
    transform: scale(1.02);
}

.reveal .slides section table tr:nth-child(even) td {
    background: #1a1a1a !important;
}

.reveal .slides section table tr:nth-child(even):hover td {
    background: #2a2a2a !important;
}

/* ƒê·∫£m b·∫£o override m·ªçi inline style */
.reveal .slides section table[style*="border-collapse"],
.reveal .slides section table[style*="width"],
.reveal .slides section table[style*="margin"] {
    background: #000 !important;
    color: #fff !important;
    font-size: 1.2em !important;
    font-weight: bold !important;
}

.reveal .slides section table th[style*="border"],
.reveal .slides section table td[style*="border"] {
    border: 2px solid #333 !important;
    background: #111 !important;
    color: #fff !important;
}

/* Responsive */
@media (max-width: 768px) {
    .reveal .slides section table {
        font-size: 1em !important;
    }
}
/* Fullscreen Button */
#fullscreenBtn {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    background: rgba(255,255,255,0.15);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    border: 1px solid rgba(255,255,255,0.1);
}

#fullscreenBtn:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-2px);
}

/* Fullscreen mode */
body:fullscreen .topbar,
body:-webkit-full-screen .topbar,
body:-moz-full-screen .topbar,
body:-ms-fullscreen .topbar {
    display: none;
}

body:fullscreen .reveal,
body:-webkit-full-screen .reveal,
body:-moz-full-screen .reveal,
body:-ms-fullscreen .reveal {
    margin-top: 0;
    height: 100vh;
    border-radius: 0;
}

.answer-check input[type="text"]::placeholder {
    opacity: 0 !important;
    visibility: hidden !important;
}
/* ·∫®N HO√ÄN TO√ÄN T·∫§T C·∫¢ L·ªúI GI·∫¢I KHI M·ªû TRANG */
.solution-box {
    display: none !important;
}
/* === FIX ƒêI·ªÜN THO·∫†I === */
@media (max-width: 768px) {
    .reveal .slides section {
        padding: 15px !important;
        height: auto !important;
        min-height: calc(100vh - 120px) !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch !important;
    }
    
    .question {
        margin: 15px 0 !important;
        padding: 15px !important;
    }
    
    .reveal .slides {
        font-size: 1.4rem !important;
        height: auto !important;
    }
    
    /* Cho ph√©p cu·ªôn n·ªôi dung d√†i */
    .question-title, .solution-content {
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
    }
    
    /* ƒê·∫£m b·∫£o input kh√¥ng b·ªã zoom */
    input[type="text"], input[type="email"] {
        font-size: 16px !important;
    }
}
/* CSS ƒë·ªÉ kh√≥a giao di·ªán khi ch∆∞a ƒëƒÉng nh·∫≠p - CH·ªà KH√ìA C√ÅC PH·∫¶N C·∫¶N THI·∫æT */
.not-logged-in .reveal,
.not-logged-in .topbar-controls select,
.not-logged-in .topbar-controls button:not(#loginBtn),
.not-logged-in #scoreBtn,
.not-logged-in #studentInteractBtn,
.not-logged-in #teacherMonitorBtn,
.not-logged-in #classManagementBtn {
    pointer-events: none;
    opacity: 0.5;
}

/* KH√îNG KH√ìA MODAL ƒêƒÇNG NH·∫¨P */
.not-logged-in .modal,
.not-logged-in .modal-content,
.not-logged-in #login-modal,
.not-logged-in #login-modal * {
    pointer-events: auto !important;
    opacity: 1 !important;
}

.not-logged-in .reveal .slides section {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    text-align: center !important;
}
</style>

</head>
<body class="not-logged-in">
<!-- ===== Thanh ti√™u ƒë·ªÅ c·ªë ƒë·ªãnh ===== -->
<div class="topbar">
    <div class="topbar-title">L·ªöP TO√ÅN TH·∫¶Y B√åNH</div>
  
    <div class="topbar-controls">
        <button id="slideMenuBtn">üìã DS Slide</button>
        <select id="selectExam">
            <option value="mm">-- Ch·ªçn ƒë·ªÅ --</option>
            <option value="gk1de1.html">ƒê·ªÅ 1: Gi·ªØa HK1</option>
            <option value="gk1de2.html">ƒê·ªÅ 2:Gi·ªØa HK1</option>
            <option value="PTMPDT.html">PTMP:DS</option>
            <option value="hk1de7.html">ƒê·ªÅ 7: HK1</option>
        </select>
        <button id="studentInteractBtn">üéÆ T∆∞∆°ng t√°c</button>
        <button id="teacherMonitorBtn">üëÅÔ∏è Theo d√µi</button>
        <button id="loginBtn">üîë ƒêƒÉng nh·∫≠p</button>
        <button id="scoreBtn">üìä T√≠nh ƒëi·ªÉm</button>
        <button id="toggleMenu">‚úèÔ∏è B·∫£ng v·∫Ω</button>
        <button id="classManagementBtn">üè´ Qu·∫£n l√Ω L·ªõp</button>
        <button id="toggleStyleBtn">üåô Ch·∫ø ƒë·ªô t·ªëi</button>
        <button id="fullscreenBtn">üì∫ Fullscreen</button>

       
    </div>
</div>

<!-- Firebase Status Indicator -->
<div id="firebaseStatus" class="firebase-status firebase-disconnected">
    <span class="loading-spinner"></span> ƒêang k·∫øt n·ªëi...
</div>

<!-- Notification System -->
<div id="notification" class="notification"></div>

<div class="reveal">
<!-- T√¨m v√† thay th·∫ø ph·∫ßn slides -->
<div class="reveal">
    <div class="slides" id="slides-container">
        <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c t·∫£i ƒë·ªông v√†o ƒë√¢y -->
        <section>
            <h2 style="text-align: center; color: #666; margin-top: 100px;">
                üßÆ L·ªöP TO√ÅN TH·∫¶Y B√åNH
            </h2>
            <p style="text-align: center; color: #888; font-size: 1.2em;">
                Vui l√≤ng ƒëƒÉng nh·∫≠p v√† ch·ªçn m·ªôt ƒë·ªÅ t·ª´ menu ƒë·ªÉ b·∫Øt ƒë·∫ßu.
            </p>
        </section>
    </div>
</div>


<!-- === HTML T√çCH H·ª¢P: SLIDE MENU === -->
<div class="slide-menu" id="slideMenu">
    <div class="menu-header">
        <h3>üìã Danh s√°ch slide</h3>
        <button class="close-btn" id="closeSlideMenu">√ó</button>
    </div>
    <div class="menu-content">
        <div class="slide-list" id="slideList">
            <!-- T·ª± ƒë·ªông t·∫°o b·∫±ng JavaScript -->
        </div>
    </div>
</div>
<div class="menu-overlay" id="menuOverlay"></div>

<!-- === HTML T√çCH H·ª¢P: CANVAS V·∫º === -->
<canvas id="drawCanvas"></canvas>
<div class="toolbar" id="drawToolbar">
    <a href="index.html" title="V·ªÅ trang ch·ªß (demo)">
      <button id="homeBtn" style="font-size:22px;">üè†</button>
    </a>
    <select id="tool">
        <option value="pen">‚úèÔ∏è B√∫t</option>
        <option value="line">üìè ƒê∆∞·ªùng</option>
        <option value="rect">‚¨õ Ch·ªØ nh·∫≠t</option>
        <option value="parallelogram">‚ñ± B√¨nh h√†nh</option>
        <option value="circle">‚ö™ Tr√≤n</option>
        <option value="dashedLineBtn">‚Äì ‚Äì</option>
        <option value="ellipseBtn">‚¨≠ Elip</option>
        <option value="box">üì¶ H·ªôp 3D</option>
        <option value="pyramid3">üî∫ Ch√≥p tam gi√°c</option>
        <option value="pyramid4">üî≤ Ch√≥p t·ª© gi√°c</option>
        <option value="sphere">‚öΩ C·∫ßu</option>
    </select>
    <input id="draw-width" max="10" min="1" type="range" value="2"/>
    <input id="colorPicker" type="color" value="#6b21a8">
    <button id="undoBtn" title="Undo">‚Ü©Ô∏è</button>
    <button id="clearBtn">üßπ Xo√°</button>
    <button id="saveBtn">üíæ L∆∞u</button>
    <button id="exitBtn">‚ùå Tho√°t</button>
</div>

<!-- === MODAL SYSTEM C·∫¢I TI·∫æN === -->
<!-- Modal Qu·∫£n l√Ω L·ªõp v√† H·ªçc sinh -->
<div class="modal" id="class-management-modal">
    <div class="modal-content modal-content-scrollable">
        <button class="modal-close" id="close-class-management">√ó</button>
        <h3>üè´ Qu·∫£n l√Ω L·ªõp v√† H·ªçc sinh</h3>
        
        <div style="display: flex; gap: 20px; margin-bottom: 25px;">
            <button id="create-class-btn" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 10px; font-weight: 600;">
                ‚ûï T·∫°o L·ªõp M·ªõi
            </button>
            <button id="assign-student-btn-main" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #17a2b8, #138496); color: white; border: none; border-radius: 10px; font-weight: 600;">
                üéì C·∫•p M√£ HS
            </button>
            <button id="view-student-codes-btn" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #6f42c1, #5a2d91); color: white; border: none; border-radius: 10px; font-weight: 600;">
                üìã DS M√£ HS
            </button>
            <button id="refresh-classes-btn" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ffc107, #e0a800); color: #000; border: none; border-radius: 10px; font-weight: 600;">
                üîÑ L√†m m·ªõi
            </button>
            <!-- TH√äM V√ÄO SAU N√öT L√ÄM M·ªöI -->
            <button id="class-poll-btn" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ffc107, #e0a800); color: #000; border: none; border-radius: 10px; font-weight: 600;">
                üó≥Ô∏è Poll L·ªõp
            </button>
            <button id="class-sync-btn" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #6f42c1, #5a2d91); color: white; border: none; border-radius: 10px; font-weight: 600;">
                üîÑ ƒê·ªìng b·ªô Slide
            </button>
            <!-- TH√äM N√öT XEM K·∫æT QU·∫¢ POLL -->
            <button id="view-poll-results-btn" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #17a2b8, #138496); color: white; border: none; border-radius: 10px; font-weight: 600;">
                üìä Xem K·∫øt qu·∫£ Poll
            </button>
            <!-- TH√äM N√öT XEM T∆Ø∆†NG T√ÅC -->
            <button id="view-interactions-btn" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #fd7e14, #e55a00); color: white; border: none; border-radius: 10px; font-weight: 600;">
                üí¨ Xem T∆∞∆°ng t√°c
            </button>
        </div>

        <!-- Danh s√°ch l·ªõp -->
        <div style="margin-bottom: 25px;">
            <h4 style="color: #1a237e; margin-bottom: 15px;">üìö Danh s√°ch L·ªõp h·ªçc</h4>
            <div class="table-container" style="max-height: 300px;">
                <table>
                    <thead>
                        <tr>
                            <th>T√™n L·ªõp</th>
                            <th>M√£ L·ªõp</th>
                            <th>S·ªë HS</th>
                            <th>Ng√†y t·∫°o</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="classes-list-body">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                                ƒêang t·∫£i danh s√°ch l·ªõp...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Danh s√°ch h·ªçc sinh -->
        <div>
            <h4 style="color: #1a237e; margin-bottom: 15px;">üë• Danh s√°ch H·ªçc sinh</h4>
            <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                <input type="text" id="search-student-global" placeholder="üîç T√¨m h·ªçc sinh..." style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                <select id="filter-class" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                    <option value="all">T·∫•t c·∫£ l·ªõp</option>
                </select>
            </div>
            <div class="table-container" style="max-height: 400px;">
                <table>
                    <thead>
                        <tr>
                            <th>M√£ HS</th>
                            <th>H·ªç t√™n</th>
                            <th>L·ªõp</th>
                            <th>L·∫ßn cu·ªëi ho·∫°t ƒë·ªông</th>
                            <th>T·ªïng b√†i l√†m</th>
                            <th>ƒêi·ªÉm TB</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="students-list-body">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 20px; color: #666;">
                                ƒêang t·∫£i danh s√°ch h·ªçc sinh...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal t·∫°o l·ªõp m·ªõi -->
<div class="modal" id="create-class-modal">
    <div class="modal-content" style="max-width: 500px;">
        <button class="modal-close" id="cancel-create-class">√ó</button>
        <h3>üè´ T·∫°o L·ªõp M·ªõi</h3>
        <form id="create-class-form">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√™n l·ªõp:</label>
                <input type="text" id="class-name" placeholder="V√≠ d·ª•: 12A1, To√°n N√¢ng cao..." required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">M√¥ t·∫£:</label>
                <textarea id="class-description" placeholder="M√¥ t·∫£ v·ªÅ l·ªõp h·ªçc..." style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; height: 80px;"></textarea>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="submit" style="padding: 12px 25px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 8px; font-weight: 600;">
                    üè´ T·∫°o L·ªõp
                </button>
                <button type="button" id="cancel-create-class-btn" style="padding: 12px 25px; background: #6c757d; color: white; border: none; border-radius: 8px;">H·ªßy</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal c·∫•p m√£ h·ªçc sinh -->
<div class="modal" id="assign-student-modal">
    <div class="modal-content" style="max-width: 600px;">
        <button class="modal-close" id="cancel-assign-student">√ó</button>
        <h3>üéì C·∫•p M√£ H·ªçc Sinh</h3>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ch·ªçn l·ªõp:</label>
            <select id="select-class-for-student" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                <option value="">-- Ch·ªçn l·ªõp --</option>
            </select>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Th√¥ng tin h·ªçc sinh:</label>
            <input type="text" id="student-fullname" placeholder="H·ªç v√† t√™n h·ªçc sinh" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px;">
            <input type="email" id="student-email" placeholder="Email (tu·ª≥ ch·ªçn)" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
        </div>

        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; color: #1a237e;">M√£ h·ªçc sinh s·∫Ω ƒë∆∞·ª£c t·∫°o:</h4>
            <div id="generated-student-code" style="font-family: monospace; font-size: 1.2em; font-weight: bold; color: #1a237e; background: white; padding: 10px; border-radius: 6px; text-align: center;">
                HS_XXXXXX
            </div>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button id="generate-student-code-btn" style="padding: 12px 25px; background: linear-gradient(135deg, #17a2b8, #138496); color: white; border: none; border-radius: 8px; font-weight: 600;">
                üé≤ T·∫°o M√£
            </button>
            <button id="assign-student-btn" style="padding: 12px 25px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 8px; font-weight: 600;">
                ‚úÖ C·∫•p M√£
            </button>
        </div>
    </div>
</div>

<!-- Modal danh s√°ch m√£ h·ªçc sinh -->
<div class="modal" id="student-codes-modal">
    <div class="modal-content" style="max-width: 800px;">
        <button class="modal-close" id="close-student-codes">√ó</button>
        <h3>üìã Danh s√°ch M√£ H·ªçc Sinh</h3>
        
        <div style="display: flex; gap: 15px; margin-bottom: 20px;">
            <select id="filter-class-codes" style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                <option value="all">T·∫•t c·∫£ l·ªõp</option>
            </select>
            <button id="export-codes-btn" style="padding: 10px 20px; background: linear-gradient(135deg, #6f42c1, #5a2d91); color: white; border: none; border-radius: 8px; font-weight: 600;">
                üì§ Xu·∫•t Excel
            </button>
        </div>

        <div class="table-container" style="max-height: 500px;">
            <table>
                <thead>
                    <tr>
                        <th>M√£ HS</th>
                        <th>H·ªç t√™n</th>
                        <th>L·ªõp</th>
                        <th>Ng√†y c·∫•p</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>M·∫≠t kh·∫©u</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="student-codes-list">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px; color: #666;">
                            ƒêang t·∫£i danh s√°ch m√£ h·ªçc sinh...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div class="confirm-modal" id="confirm-delete-modal">
    <div class="confirm-content">
        <h3>‚ö†Ô∏è X√°c nh·∫≠n X√≥a</h3>
        <p id="confirm-delete-message">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?</p>
        <div class="confirm-buttons">
            <button class="confirm-yes" id="confirm-delete-yes">X√≥a</button>
            <button class="confirm-no" id="confirm-delete-no">H·ªßy</button>
        </div>
    </div>
</div>

<!-- LOGIN MODAL -->
<div class="modal" id="login-modal">
    <div class="modal-content">
        <button class="modal-close" id="close-modal">√ó</button>
        <h3>üîê ƒêƒÉng nh·∫≠p h·ªá th·ªëng</h3>
        <form id="code-login-form">
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">M√£ ƒëƒÉng nh·∫≠p:</label>
                <input id="login-code" placeholder="Nh·∫≠p m√£ h·ªçc sinh/gi√°o vi√™n" required type="text"/>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">H·ªç t√™n:</label>
                <input id="student-name" placeholder="Nh·∫≠p h·ªç t√™n c·ªßa b·∫°n" type="text"/>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
                <button type="submit" style="flex: 1;">üöÄ ƒêƒÉng nh·∫≠p</button>
            </div>
        </form>
        <div id="auth-status" style="margin-top: 15px;"></div>
        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
            <p style="margin: 0; font-size: 0.9em; color: #666;">
                <strong>H∆∞·ªõng d·∫´n:</strong><br>
                ‚Ä¢ Gi√°o vi√™n: c·∫•p m√£ g·ªìm m√£ v√† h·ªç t√™n<br>
                ‚Ä¢ H·ªçc sinh nh·∫≠p ch√≠nh x√°c c·∫£ 2 <br>
            </p>
        </div>
    </div>
</div>

<!-- B·∫£ng theo d√µi h·ªçc sinh real-time -->
<div id="teacher-monitor">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h3 style="margin: 0; color: #1a237e;">üìä B·∫£ng theo d√µi h·ªçc sinh - REAL TIME</h3>
        <div>
            <button id="monitor-create-session" style="background: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-right: 10px;">
                üÜî T·∫°o l·ªõp
            </button>
            <button id="monitor-start-poll" style="background: #ffc107; color: black; border: none; padding: 8px 15px; border-radius: 5px; margin-right: 10px;">
                üó≥Ô∏è Poll
            </button>
            <button id="monitor-sync-slides" style="background: #6f42c1; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-right: 10px;">
                üîÑ ƒê·ªìng b·ªô
            </button>
            <button id="closeMonitor" style="background: #ff4757; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600;">
                ‚úï ƒê√≥ng
            </button>
        </div>
    </div>
    
    <div style="margin-bottom: 20px; display: flex; gap: 30px; align-items: center;">
        <div>
            <strong>M√£ l·ªõp:</strong> <code id="monitor-session-code" style="background: #1a237e; color: white; padding: 5px 10px; border-radius: 5px;">Ch∆∞a c√≥</code>
        </div>
        <div>
            <strong>H·ªçc sinh online:</strong> <span id="live-student-count" style="font-size: 1.2em; font-weight: bold; color: #1a237e;">0</span>
        </div>
    </div>

    <!-- B·ªô l·ªçc v√† t√¨m ki·∫øm -->
    <div style="display: flex; gap: 15px; margin-bottom: 20px;">
        <input type="text" id="search-student" placeholder="üîç T√¨m theo t√™n h·ªçc sinh..." style="padding: 12px; border: 2px solid #ddd; border-radius: 10px; flex: 1; font-size: 1rem;">
        <select id="filter-status" style="padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem;">
            <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="active">ƒêang l√†m b√†i</option>
            <option value="finished">ƒê√£ ho√†n th√†nh</option>
            <option value="not-started">Ch∆∞a b·∫Øt ƒë·∫ßu</option>
        </select>
    </div>

    <!-- B·∫£ng k·∫øt qu·∫£ -->
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th style="text-align: left;">H·ªçc sinh</th>
                    <th style="text-align: center;">Tr·∫°ng th√°i</th>
                    <th style="text-align: center;">ƒêi·ªÉm s·ªë</th>
                    <th style="text-align: center;">Th·ªùi gian l√†m</th>
                    <th style="text-align: center;">Ti·∫øn ƒë·ªô</th>
                    <th style="text-align: center;">Chi ti·∫øt</th>
                </tr>
            </thead>
            <tbody id="student-results-body">
                <tr>
                    <td colspan="6" style="text-align: center; padding: 30px; color: #666;">
                        <div style="font-size: 1.2em; margin-bottom: 10px;">üìä</div>
                        Ch∆∞a c√≥ h·ªçc sinh n√†o tham gia l·ªõp h·ªçc
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Th·ªëng k√™ t·ªïng quan -->
    <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%); border-radius: 15px; border: 2px solid #e0e0e0;">
        <h4 style="margin-top: 0; color: #1a237e; margin-bottom: 20px;">üìà Th·ªëng k√™ t·ªïng quan l·ªõp h·ªçc</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px;">
            <div style="text-align: center; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <div style="font-size: 2em; font-weight: bold; color: #17a2b8;" id="stats-total">0</div>
                <div style="font-size: 0.9em; color: #6c757d; font-weight: 600;">T·ªïng s·ªë HS</div>
            </div>
            <div style="text-align: center; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <div style="font-size: 2em; font-weight: bold; color: #28a745;" id="stats-completed">0</div>
                <div style="font-size: 0.9em; color: #6c757d; font-weight: 600;">ƒê√£ ho√†n th√†nh</div>
            </div>
            <div style="text-align: center; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <div style="font-size: 2em; font-weight: bold; color: #ffc107;" id="stats-average">0.0</div>
                <div style="font-size: 0.9em; color: #6c757d; font-weight: 600;">ƒêi·ªÉm TB</div>
            </div>
            <div style="text-align: center; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <div style="font-size: 2em; font-weight: bold; color: #dc3545;" id="stats-failed">0</div>
                <div style="font-size: 0.9em; color: #6c757d; font-weight: 600;">D∆∞·ªõi 5 ƒëi·ªÉm</div>
            </div>
        </div>
    </div>

    <!-- V√πng hi·ªÉn th·ªã k·∫øt qu·∫£ poll -->
    <div id="poll-results-area" style="display: none; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
        <h4 id="poll-results-title" style="color: #1a237e; margin-bottom: 15px;">üìä K·∫øt qu·∫£ kh·∫£o s√°t</h4>
        <canvas id="pollChartInMonitor" width="700" height="300"></canvas>
        <div id="poll-stats-in-monitor" style="margin-top: 15px;"></div>
    </div>
</div>

<!-- Poll modal (hi·ªán cho HS khi c√≥ poll) -->
<div class="modal" id="poll-modal">
  <div class="modal-content">
    <button class="modal-close" id="poll-close-btn">√ó</button>
    <h3 id="poll-title">üó≥Ô∏è Kh·∫£o s√°t nhanh</h3>
    <div id="poll-options"></div>
    <div style="margin-top:20px; display:flex; justify-content:space-between;">
      <button id="poll-submit-btn" style="background:linear-gradient(135deg, #28a745, #20c997); color:#fff; font-weight: 600;">‚úÖ G·ª≠i ph·∫£n h·ªìi</button>
    </div>
  </div>
</div>

<script>
// ===== FIREBASE CONFIGURATION =====
const firebaseConfig = {
  apiKey: "AIzaSyDVRsgVDCKk5lIfCRxhSlWiBetNlZBukcc",
  authDomain: "daytoantructuyen-149d9.firebaseapp.com",
  databaseURL: "https://daytoantructuyen-149d9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "daytoantructuyen-149d9",
  storageBucket: "daytoantructuyen-149d9.firebasestorage.app",
  messagingSenderId: "258454714393",
  appId: "1:258454714393:web:bcf66624668e516934d288"
};

// ===== GLOBAL VARIABLES =====
// ===== BI·∫æN M·ªöI CHO H·ªÜ TH·ªêNG ƒê·ªòNG =====
let examList = [];
let currentExam = null;
let currentQuestions = [];
let revealInitialized = false;
let db = null;
let auth = null;
let currentSessionId = null;
let isTeacherLoggedIn = false;
let currentUser = null;
let pollChart = null;
let studentListeners = {};
let sessionCode = '';

// Bi·∫øn cho h·ªá th·ªëng t√≠nh ƒëi·ªÉm n√¢ng cao
window.isScoreCalculated = false;
window.studentAnswers = {};
window.correctAnswers = {};

// ===== S·ª¨A L·ªñI: BI·∫æN QU·∫¢N L√ù M√É H·ªåC SINH =====
let studentCodesMap = new Map(); // Thay th·∫ø studentCodes object b·∫±ng Map
let inactiveStudents = new Set(); // Theo d√µi h·ªçc sinh kh√¥ng ho·∫°t ƒë·ªông

// ===== MODAL SYSTEM C·∫¢I TI·∫æN =====
let activeModal = null;

function setupModalSystem() {
    // T·∫•t c·∫£ c√°c modal
    const modals = document.querySelectorAll('.modal, .confirm-modal');
    
    // Th√™m s·ª± ki·ªán click overlay ƒë·ªÉ ƒë√≥ng modal
    modals.forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                hideModal(this);
            }
        });
    });
    
    // Th√™m s·ª± ki·ªán ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && activeModal) {
            hideModal(activeModal);
        }
    });
    
    // C·∫≠p nh·∫≠t c√°c n√∫t ƒë√≥ng modal
    document.querySelectorAll('.modal-close, .confirm-no').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = this.closest('.modal, .confirm-modal');
            if (modal) hideModal(modal);
        });
    });
}

function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        // ·∫®n modal ƒëang active (n·∫øu c√≥)
        if (activeModal) {
            hideModal(activeModal);
        }
        
        modal.classList.add('active');
        activeModal = modal;
    }
}

function hideModal(modal) {
    if (modal) {
        modal.classList.remove('active');
        if (modal === activeModal) {
            activeModal = null;
        }
    }
}

function hideAllModals() {
    document.querySelectorAll('.modal.active, .confirm-modal.active').forEach(modal => {
        hideModal(modal);
    });
}

// ===== KH·ªûI T·∫†O V√Ä C√ÅC H√ÄM TI·ªÜN √çCH =====
document.addEventListener('DOMContentLoaded', function() {
    console.log("üöÄ H·ªá th·ªëng L·ªõp To√°n Th·∫ßy B√¨nh kh·ªüi ƒë·ªông...");
    
    if (initializeFirebase()) {
        // 1. KH·ªûI T·∫†O REVEAL C∆† B·∫¢N (ch·ªâ ƒë·ªÉ hi·ªÉn th·ªã m√†n h√¨nh ch·ªù)
        Reveal.initialize({
            width: "100%", height: "100%", margin: 0.02,
            hash: true,
            plugins: [RevealMarkdown, RevealHighlight, RevealNotes, RevealMath],
            math: {
                mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js',
                config: 'TeX-AMS_HTML-full'
            },
            transition: 'slide',
            backgroundTransition: 'fade',
            controls: true,
            progress: false, // T·∫°m t·∫Øt, s·∫Ω b·∫≠t khi c√≥ n·ªôi dung
            center: true,
            slideNumber: false // T·∫°m t·∫Øt, s·∫Ω b·∫≠t khi c√≥ n·ªôi dung
        });
        revealInitialized = true;
        
        // 2. T·∫¢I DANH S√ÅCH ƒê·ªÄ THI (T√çNH NƒÇNG M·ªöI)
        loadExamList();
        
        // 3. KH·ªûI T·∫†O T·∫§T C·∫¢ H·ªÜ TH·ªêNG CON (GI·ªÆ NGUY√äN 100%)
        setupModalSystem();
        setupAuthentication();
        setupSessionManagement();
        setupPollSystem();
        setupStudentInteraction();
        
        // 4. THI·∫æT L·∫¨P S·ª∞ KI·ªÜN SLIDECHANGED (GI·ªÆ NGUY√äN)
        Reveal.addEventListener('slidechanged', function(event) {
            updateGlobalProgress();
            updateActiveSlideInMenu();
            if (!isTeacherLoggedIn && sessionCode) {
                updateStudentProgress(Reveal.getIndices().h);
            }
        });
        
        // 5. THI·∫æT L·∫¨P C√ÅC CONTROLS (GI·ªÆ NGUY√äN)
        setupModalControls();
        setupSlideMenu();
        setupCanvas();
        
        // 6. C·∫¨P NH·∫¨T NG√ÄY TH√ÅNG (GI·ªÆ NGUY√äN)
        

        // 7. X·ª¨ L√ù THAM S·ªê URL SESSION (GI·ªÆ NGUY√äN)
        const urlParams = new URLSearchParams(window.location.search);
        const urlSessionCode = urlParams.get('session');
        if (urlSessionCode) {
            sessionCode = urlSessionCode.toUpperCase();
            document.getElementById('monitor-session-code').textContent = sessionCode;
        }
        
        // 8. TH√äM EVENT LISTENERS CHO CONTROLS MONITOR (GI·ªÆ NGUY√äN)
        document.getElementById('monitor-create-session').addEventListener('click', createNewSession);
        document.getElementById('monitor-start-poll').addEventListener('click', startPoll);
        document.getElementById('monitor-sync-slides').addEventListener('click', syncSlidesWithStudents);
        
        // 9. KH·ªûI T·∫†O QU·∫¢N L√ù L·ªöP (GI·ªÆ NGUY√äN)
        setupClassManagement();
        setupStudentCodeManagement();
        
        // 10. KH·ªûI T·∫†O THEO D√ïI CHI TI·∫æT (GI·ªÆ NGUY√äN)
        setTimeout(() => {
            setupDetailedMonitoring();
        }, 3000);

        // 11. THEO D√ïI H·ªåC SINH KH√îNG HO·∫†T ƒê·ªòNG (GI·ªÆ NGUY√äN)
        setInterval(checkInactiveStudents, 30000);
        
        // 12. TH√äM S·ª∞ KI·ªÜN CHO DROPDOWN CH·ªåN ƒê·ªÄ (T√çNH NƒÇNG M·ªöI)
        document.getElementById('selectExam').addEventListener('change', handleExamSelection);
        
        // 13. HI·ªÇN TH·ªä M√ÄN H√åNH CH√ÄO M·ª™NG BAN ƒê·∫¶U
        showWelcomeScreen();
        
        showNotification('‚úÖ H·ªá th·ªëng ƒë√£ s·∫µn s√†ng! Vui l√≤ng ƒëƒÉng nh·∫≠p v√† ch·ªçn ƒë·ªÅ thi.', 'info');
        
        console.log("‚úÖ H·ªá th·ªëng kh·ªüi ƒë·ªông th√†nh c√¥ng v·ªõi ƒë·∫ßy ƒë·ªß ch·ª©c nƒÉng");
        
    } else {
        showNotification('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn c∆° s·ªü d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.', 'error');
    }
});

// ===== H√ÄM HI·ªÇN TH·ªä M√ÄN H√åNH CH√ÄO M·ª™NG =====
function showWelcomeScreen() {
    const slidesContainer = document.getElementById('slides-container');
    if (!slidesContainer) return;
    
    slidesContainer.innerHTML = `
        <section data-background="linear-gradient(135deg, #667eea 0%, #764ba2 100%)" style="color: white; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">
            <h1 style="color: white; border: none; font-size: 3em; margin-bottom: 20px;">üßÆ L·ªöP TO√ÅN TH·∫¶Y B√åNH</h1>
            <h3 style="color: white; margin-bottom: 40px;">H·ªá Th·ªëng D·∫°y H·ªçc Tr·ª±c Tuy·∫øn To√†n Di·ªán</h3>
            
            <div style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 20px; max-width: 800px; margin: 0 auto;">
                <h4 style="color: white; margin-bottom: 20px;">üìö H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG</h4>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                        <div style="font-size: 2em; margin-bottom: 10px;">üîë</div>
                        <h5 style="color: white; margin-bottom: 10px;">1. ƒêƒÉng nh·∫≠p</h5>
                        <p style="color: rgba(255,255,255,0.9); font-size: 0.9em;">Nh·∫•n n√∫t "ƒêƒÉng nh·∫≠p" v√† nh·∫≠p m√£ h·ªçc sinh/gi√°o vi√™n</p>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                        <div style="font-size: 2em; margin-bottom: 10px;">üìù</div>
                        <h5 style="color: white; margin-bottom: 10px;">2. Ch·ªçn ƒë·ªÅ</h5>
                        <p style="color: rgba(255,255,255,0.9); font-size: 0.9em;">Ch·ªçn ƒë·ªÅ thi t·ª´ menu "Ch·ªçn ƒë·ªÅ" tr√™n thanh c√¥ng c·ª•</p>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                        <div style="font-size: 2em; margin-bottom: 10px;">üéØ</div>
                        <h5 style="color: white; margin-bottom: 10px;">3. L√†m b√†i</h5>
                        <p style="color: rgba(255,255,255,0.9); font-size: 0.9em;">L√†m b√†i v√† ki·ªÉm tra ƒë√°p √°n tr·ª±c ti·∫øp tr√™n h·ªá th·ªëng</p>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <p style="color: rgba(255,255,255,0.9); font-size: 0.9em;">
                        <strong>Gi√°o vi√™n:</strong> C√≥ th·ªÉ qu·∫£n l√Ω l·ªõp, t·∫°o poll, ƒë·ªìng b·ªô slide<br>
                        <strong>H·ªçc sinh:</strong> C√≥ th·ªÉ t∆∞∆°ng t√°c, xem ƒëi·ªÉm, tham gia poll
                    </p>
                </div>
            </div>
        </section>
    `;
    
    // C·∫≠p nh·∫≠t Reveal
    if (revealInitialized) {
        Reveal.sync();
        Reveal.slide(0);
    }
}

// ===== C√ÅC H√ÄM M·ªöI CHO H·ªÜ TH·ªêNG ƒê·ªòNG =====

// =========================================================
// ===== C√ÅC H√ÄM M·ªöI ƒê·ªÇ T·∫¢I N·ªòI DUNG ƒê·ªòNG =====
// =========================================================

// T·∫£i file exam-list.json v√† ƒëi·ªÅn v√†o menu dropdown
async function loadExamList() {
    try {
        const response = await fetch('exam-list.json');
        if (!response.ok) throw new Error('Kh√¥ng t√¨m th·∫•y file exam-list.json');
        
        const data = await response.json();
        examList = data.exams;
        
        const selectMenu = document.getElementById('selectExam');
        selectMenu.innerHTML = '<option value="">-- Ch·ªçn ƒë·ªÅ --</option>'; // Reset
        
        examList.forEach(exam => {
            const option = document.createElement('option');
            option.value = exam.id;
            option.textContent = exam.name;
            selectMenu.appendChild(option);
        });

        console.log("‚úÖ ƒê√£ t·∫£i danh s√°ch ƒë·ªÅ:", examList.length, "ƒë·ªÅ");

    } catch (error) {
        console.error("‚ùå L·ªói t·∫£i danh s√°ch ƒë·ªÅ:", error);
        showNotification('L·ªói t·∫£i danh s√°ch ƒë·ªÅ! Vui l√≤ng ki·ªÉm tra file exam-list.json', 'error');
    }
}

// X·ª≠ l√Ω khi ng∆∞·ªùi d√πng ch·ªçn m·ªôt ƒë·ªÅ t·ª´ menu
async function handleExamSelection() {
    const selectMenu = document.getElementById('selectExam');
    const selectedId = selectMenu.value;
    
    if (!selectedId) {
        // N·∫øu ch·ªçn "-- Ch·ªçn ƒë·ªÅ --", x√≥a n·ªôi dung hi·ªán t·∫°i
        resetToWelcomeScreen();
        return;
    }

    currentExam = examList.find(exam => exam.id === selectedId);
    if (!currentExam) {
        showNotification('Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë·ªÅ thi!', 'error');
        return;
    }

    try {
        showNotification(`üì• ƒêang t·∫£i ƒë·ªÅ: ${currentExam.name}...`, 'info');
        
        // T·∫£i file .json c·ªßa ƒë·ªÅ ƒë∆∞·ª£c ch·ªçn
        const response = await fetch(currentExam.file);
        if (!response.ok) throw new Error(`Kh√¥ng t·∫£i ƒë∆∞·ª£c file ${currentExam.file}`);
        
        currentQuestions = await response.json();
        
        console.log(`‚úÖ ƒê√£ t·∫£i ${currentQuestions.length} slide t·ª´ ${currentExam.file}`);
        
        // Render n·ªôi dung v√†o c√°c slide
        renderContent(currentQuestions);
        
        // Kh·ªüi t·∫°o ho·∫∑c l√†m m·ªõi Reveal.js
        initializeOrRefreshReveal();
        
        // T·∫°o l·∫°i danh s√°ch slide trong menu
        createSlideList();
        
        // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ trang
        document.title = `${currentExam.name} - L·ªõp To√°n Th·∫ßy B√¨nh`;
        
        showNotification(`‚úÖ ƒê√£ t·∫£i ƒë·ªÅ: ${currentExam.name}`, 'success');

    } catch (error) {
        console.error("‚ùå L·ªói khi t·∫£i n·ªôi dung ƒë·ªÅ:", error);
        showNotification(`L·ªói: ${error.message}`, 'error');
        resetToWelcomeScreen();
    }
}

// Reset v·ªÅ m√†n h√¨nh ch√†o m·ª´ng
function resetToWelcomeScreen() {
    const slidesContainer = document.getElementById('slides-container');
    slidesContainer.innerHTML = `
        <section>
            <h2 style="text-align: center; color: #666; margin-top: 100px;">
                üßÆ L·ªöP TO√ÅN TH·∫¶Y B√åNH
            </h2>
            <p style="text-align: center; color: #888; font-size: 1.2em;">
                Vui l√≤ng ch·ªçn m·ªôt ƒë·ªÅ t·ª´ menu ƒë·ªÉ b·∫Øt ƒë·∫ßu.
            </p>
        </section>
    `;
    
    if (revealInitialized) {
        Reveal.sync();
        Reveal.slide(0);
    }
}

// Kh·ªüi t·∫°o ho·∫∑c l√†m m·ªõi Reveal.js
function initializeOrRefreshReveal() {
    if (!revealInitialized) {
        Reveal.initialize({
            width: "100%", height: "100%", margin: 0.02, minScale: 0.2, maxScale: 2,
            slideNumber: true, center: false, hash: true,
            plugins: [RevealMarkdown, RevealHighlight, RevealNotes, RevealMath],
            math: {
                mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js',
                config: 'TeX-AMS_HTML-full'
            },
            transition: 'slide', backgroundTransition: 'fade',
            controls: true, progress: true, center: true, slideNumber: 'c/t'
        });
        revealInitialized = true;
    } else {
        Reveal.sync();
        Reveal.slide(0);
    }
    
    // Th√™m s·ª± ki·ªán slidechanged
    Reveal.addEventListener('slidechanged', function(event) {
        updateActiveSlideInMenu();
        if (!isTeacherLoggedIn && sessionCode) {
            updateStudentProgress(Reveal.getIndices().h);
        }
    });
    
    // Y√™u c·∫ßu MathJax render l·∫°i c√¥ng th·ª©c to√°n
    if (window.MathJax) {
        MathJax.typesetPromise();
    }
}

// "V·∫Ω" n·ªôi dung t·ª´ .json ra th√†nh HTML
function renderContent(contentData) {
    const slidesContainer = document.getElementById('slides-container');
    slidesContainer.innerHTML = ''; // X√≥a n·ªôi dung c≈©

    contentData.forEach((item, index) => {
        const section = document.createElement('section');
        let html = '';
        
        switch(item.type) {
            case 'welcome':
                section.setAttribute('data-background', item.background || '');
                section.style.color = item.color || '';
                html = `
                    <h1 style="color: ${item.color || 'white'}; border: none; font-size: 3em;">
                        ${item.title}
                    </h1>
                    <h3 style="color: ${item.color || 'white'};">${item.subtitle}</h3>
                    <div style="margin-top: 50px;">
                        ${item.content}
                    </div>
                    ${item.extraContent || ''}
                `;
                break;
            
            case 'multiple_choice':
                let optionsHtml = '';
                for (const [key, value] of Object.entries(item.options)) {
                    optionsHtml += `
                        <div class="option-row">
                            <input type="radio" name="${item.id}" value="${key}" id="${item.id}${key}">
                            <label for="${item.id}${key}">${key}. ${value}</label>
                            <span class="option-icon" id="icon-${item.id}-${key}"></span>
                        </div>
                    `;
                }
                
                let solutionHtml = '';
                if (item.solution) {
                    solutionHtml = `
                        <button onclick="toggleSolution('${item.id}')" style="margin-top: 10px; padding: 8px 15px; background: #17a2b8; color: white; border: none; border-radius: 5px;">
                            üëÅÔ∏è Xem gi·∫£i
                        </button>
                        <div id="solution-${item.id}" class="solution-box" style="display: none;">
                            <div class="solution-title">H∆∞·ªõng d·∫´n gi·∫£i ${item.title}</div>
                            <div class="solution-content">${item.solution}</div>
                        </div>
                    `;
                }
                
                html = `
                    <div class="question" id="${item.id}">
                        <p class="question-title"><strong>${item.title}</strong> ${item.text}</p>
                        ${item.image ? `<img src="${item.image}" style="max-width: 100%; margin: 15px 0; border-radius: 10px;">` : ''}
                        <div class="options">${optionsHtml}</div>
                        <div class="answer-check">
                            <button onclick="checkAnswer('${item.id}', '${item.correct}')">‚úÖ Ki·ªÉm tra</button>
                            <span id="result-${item.id}"></span>
                        </div>
                        ${solutionHtml}
                    </div>
                `;
                break;
                
            case 'true_false':
                let statementsHtml = '';
                if (item.statements && Array.isArray(item.statements)) {
                    item.statements.forEach((stmt, idx) => {
                        const letter = String.fromCharCode(97 + idx);
                        statementsHtml += `
                            <div class="option-row">
                                ${stmt}
                                <label><input name="${item.id}${letter}" type="radio" value="True"/> True</label>
                                <label><input name="${item.id}${letter}" type="radio" value="False"/> False</label>
                            </div>
                        `;
                    });
                }
                
                let tfSolutionHtml = '';
                if (item.solution) {
                    tfSolutionHtml = `
                        <button onclick="toggleSolution('${item.id}')" style="margin-top: 10px; padding: 8px 15px; background: #17a2b8; color: white; border: none; border-radius: 5px;">
                            üëÅÔ∏è Xem gi·∫£i
                        </button>
                        <div id="solution-${item.id}" class="solution-box" style="display: none;">
                            <div class="solution-title">H∆∞·ªõng d·∫´n gi·∫£i ${item.title}</div>
                            <div class="solution-content">${item.solution}</div>
                        </div>
                    `;
                }
                
                html = `
                    <div class="question" id="${item.id}">
                        <p class="question-title"><strong>${item.title}</strong> ${item.text}</p>
                        ${item.image ? `<img src="${item.image}" style="max-width: 100%; margin: 15px 0; border-radius: 10px;">` : ''}
                        <div class="options">${statementsHtml}</div>
                        <div class="answer-check">
                            <button onclick="checkTrueFalseAnswer('${item.id}', ${JSON.stringify(item.answers || [])})">‚úÖ Ki·ªÉm tra</button>
                            <span id="result-${item.id}"></span>
                        </div>
                        ${tfSolutionHtml}
                    </div>
                `;
                break;
                
            case 'short_answer':
                html = `
                    <div class="question" id="${item.id}">
                        <p class="question-title"><strong>${item.title}</strong> ${item.text}</p>
                        ${item.image ? `<img src="${item.image}" style="max-width: 100%; margin: 15px 0; border-radius: 10px;">` : ''}
                        <div class="answer-check">
                            <input id="input-${item.id}" placeholder="${item.placeholder || 'Nh·∫≠p k·∫øt qu·∫£...'}" type="text"/>
                            <button onclick="checkShortAnswer('${item.id}', '${item.answer || ''}')">‚úÖ Ki·ªÉm tra</button>
                            <span id="icon-${item.id}"></span>
                        </div>
                        <div id="result-${item.id}"></div>
                        ${item.solution ? `
                            <button onclick="toggleSolution('${item.id}')" style="margin-top: 10px; padding: 8px 15px; background: #17a2b8; color: white; border: none; border-radius: 5px;">
                                üëÅÔ∏è Xem gi·∫£i
                            </button>
                            <div id="solution-${item.id}" class="solution-box" style="display: none;">
                                <div class="solution-title">H∆∞·ªõng d·∫´n gi·∫£i ${item.title}</div>
                                <div class="solution-content">${item.solution}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
                break;
                
            case 'theory':
                html = `
                    <div class="question" id="${item.id}">
                        <h3 style="color: #1a237e; border-bottom: 3px solid #1a237e; padding-bottom: 10px;">
                            ${item.title}
                        </h3>
                        <div style="font-size: 1.1em; line-height: 1.6; margin-top: 20px;">
                            ${item.content}
                        </div>
                        ${item.example ? `
                            <div class="solution-box" style="margin-top: 30px;">
                                <div class="solution-title">üìö V√≠ d·ª• minh h·ªça</div>
                                <div class="solution-content">${item.example}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
                break;
                
            default:
                html = `<div style="padding: 30px; text-align: center; color: #666;">
                    <p>Kh√¥ng th·ªÉ hi·ªÉn th·ªã n·ªôi dung (lo·∫°i: ${item.type})</p>
                </div>`;
        }
        
        section.innerHTML = html;
        slidesContainer.appendChild(section);
    });
    
    // Y√™u c·∫ßu MathJax render l·∫°i c√¥ng th·ª©c to√°n m·ªõi
    if (window.MathJax) {
        setTimeout(() => {
            MathJax.typesetPromise();
        }, 300);
    }
    
    console.log(`‚úÖ ƒê√£ render ${contentData.length} slide`);
}


function initializeFirebase() {
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        auth = firebase.auth();
        console.log("‚úÖ Firebase initialized successfully");
        
        db.ref('.info/connected').on('value', snap => {
            const statusElement = document.getElementById('firebaseStatus');
            if (snap.val() === true) {
                statusElement.innerHTML = "‚úÖ Firebase: ƒê√£ k·∫øt n·ªëi";
                statusElement.className = "firebase-status firebase-connected";
            } else {
                statusElement.innerHTML = '<span class="loading-spinner"></span> Firebase: ƒêang k·∫øt n·ªëi...';
                statusElement.className = "firebase-status firebase-disconnected";
            }
        });
        return true;
    } catch (error) {
        console.error("‚ùå Firebase initialization failed:", error);
        showNotification('L·ªói kh·ªüi t·∫°o Firebase: ' + error.message, 'error');
        return false;
    }
}

// === L∆ØU K·∫æT QU·∫¢ L√ÄM B√ÄI (C√ì CHI TI·∫æT) ===
window.saveAttempt = async function(testId, detailsOrScore, maybeScore) {
    if (!currentUser || !sessionCode) {
        console.warn("‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi l∆∞u!");
        return;
    }

    let answers = {};
    let totalScore = 0;

    // Nh·∫≠n d·∫°ng c√°ch g·ªçi
    if (typeof detailsOrScore === 'object' && maybeScore !== undefined) {
        // G·ªçi d·∫°ng: saveAttempt(testId, { studentAnswers, correctAnswers }, totalScore)
        answers = detailsOrScore.studentAnswers || {};
        totalScore = parseFloat(maybeScore);
    } else {
        // G·ªçi d·∫°ng: saveAttempt(testId, totalScore)
        totalScore = parseFloat(detailsOrScore);
    }

    try {
        // L∆∞u v√†o Firebase
        await db.ref(`attempts/${sessionCode}/${currentUser.uid}`).set({
            code: currentUser.code,
            name: currentUser.name,
            testId,
            score: totalScore,
            answers,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            sessionCode: sessionCode
        });
        
        console.log("‚úÖ ƒê√£ l∆∞u ƒëi·ªÉm:", totalScore);
        showNotification(`‚úÖ ƒê√£ l∆∞u k·∫øt qu·∫£: ${totalScore.toFixed(2)} ƒëi·ªÉm`, 'success');
    } catch (err) {
        console.error("‚ùå L·ªói l∆∞u:", err);
        showNotification('‚ùå L·ªói khi l∆∞u k·∫øt qu·∫£', 'error');
    }
}

// === L∆ØU K·∫æT QU·∫¢ T·ª™NG PH·∫¶N ===
window.savePartial = async function(questionId, userAnswer, correctAnswer, isCorrect) {
    if (!currentUser || !sessionCode) return;

    try {
        await db.ref(`partialResults/${sessionCode}/${currentUser.uid}/${questionId}`).set({
            userAnswer,
            correctAnswer,
            isCorrect,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    } catch (err) {
        console.error("‚ùå L·ªói l∆∞u k·∫øt qu·∫£ t·ª´ng ph·∫ßn:", err);
    }
}

// === H·ªÜ TH·ªêNG THEO D√ïI CHI TI·∫æT ===
function setupDetailedMonitoring() {
    // L·∫Øng nghe k·∫øt qu·∫£ l√†m b√†i real-time
    if (!sessionCode) return;
    
    db.ref(`attempts/${sessionCode}`).on('value', (snapshot) => {
        const attempts = snapshot.val() || {};
        updateDetailedMonitor(attempts);
    });
}

function updateDetailedMonitor(attempts) {
    const tbody = document.getElementById('student-results-body');
    if (!tbody) return;

    let html = '';
    let totalStudents = 0;
    let completedStudents = 0;
    let totalScore = 0;

    Object.entries(attempts).forEach(([studentId, attempt]) => {
        totalStudents++;
        const score = parseFloat(attempt.score) || 0;
        totalScore += score;
        
        if (score > 0) completedStudents++;

        const status = score > 0 ? 'finished' : 'active';
        const statusBadge = getStatusBadge(status);
        const timeAgo = attempt.createdAt ? getTimeAgo(attempt.createdAt) : '--:--';

        html += `
            <tr>
                <td>
                    <strong>${attempt.name || 'Ch∆∞a ƒë·∫∑t t√™n'}</strong><br>
                    <small style="color: #6c757d;">${attempt.code}</small>
                </td>
                <td style="text-align: center;">${statusBadge}</td>
                <td style="text-align: center; font-weight: bold; color: ${getScoreColor(score)}">
                    ${score > 0 ? score.toFixed(2) : '-'}
                </td>
                <td style="text-align: center;">${timeAgo}</td>
                <td style="text-align: center;">
                    <div style="background: #e0e0e0; border-radius: 5px; height: 8px; width: 100px; margin: 0 auto;">
                        <div style="background: linear-gradient(135deg, #1a237e, #3949ab); height: 100%; border-radius: 5px; width: ${calculateProgress(attempt.answers)}%;"></div>
                    </div>
                    <small>${calculateProgress(attempt.answers)}%</small>
                </td>
                <td style="text-align: center;">
                    <button onclick="viewStudentDetail('${studentId}')" style="padding: 6px 12px; border: none; background: #17a2b8; color: white; border-radius: 5px; cursor: pointer; font-size: 12px;">
                        üìä Chi ti·∫øt
                    </button>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html || `
        <tr>
            <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 1.5em; margin-bottom: 10px;">üìä</div>
                Ch∆∞a c√≥ h·ªçc sinh n√†o ho√†n th√†nh b√†i l√†m
            </td>
        </tr>
    `;

    // C·∫≠p nh·∫≠t th·ªëng k√™
    updateStatistics(totalStudents, completedStudents, totalScore);
}

function calculateProgress(answers) {
    if (!answers) return 0;
    const totalQuestions = 22; // T·ªïng s·ªë c√¢u h·ªèi
    const answeredQuestions = Object.keys(answers).length;
    return Math.round((answeredQuestions / totalQuestions) * 100);
}

function getTimeAgo(timestamp) {
    if (!timestamp) return '--:--';
    
    const now = Date.now();
    const time = typeof timestamp === 'number' ? timestamp : timestamp;
    const diffMs = now - time;
    const diffMins = Math.floor(diffMs / 60000);
    
    if (diffMins < 1) return 'V·ª´a xong';
    if (diffMins < 60) return `${diffMins} ph√∫t tr∆∞·ªõc`;
    
    const diffHours = Math.floor(diffMins / 60);
    if (diffHours < 24) return `${diffHours} gi·ªù tr∆∞·ªõc`;
    
    const diffDays = Math.floor(diffHours / 24);
    return `${diffDays} ng√†y tr∆∞·ªõc`;
}

function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    notification.innerHTML = message;
    notification.className = `notification ${type}`;
    notification.classList.add('show');
    setTimeout(() => { notification.classList.remove('show'); }, 6000);
}

function playSound(type) {
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance();
        utterance.text = type === 'correct' ? 'Ch√≠nh x√°c!' : (type === 'partial' ? 'G·∫ßn ƒë√∫ng r·ªìi' : 'Sai r·ªìi!');
        utterance.lang = 'vi-VN';
        utterance.volume = 0.7;
        utterance.rate = 1.2;
        speechSynthesis.speak(utterance);
    }
}

// ===== H·ªÜ TH·ªêNG GIAO DI·ªÜN (UI) =====

function setupModalControls() {
    // C·∫≠p nh·∫≠t ƒë·ªÉ s·ª≠ d·ª•ng h·ªá th·ªëng modal m·ªõi
    document.getElementById('loginBtn').addEventListener('click', () => { showModal('login-modal'); });
    document.getElementById('teacherMonitorBtn').addEventListener('click', () => {
        if (isTeacherLoggedIn) showModal('teacher-monitor');
        else showNotification('Ch·ªâ gi√°o vi√™n m·ªõi c√≥ quy·ªÅn truy c·∫≠p!', 'error');
    });
    document.getElementById('closeMonitor').addEventListener('click', () => { hideModal(document.getElementById('teacher-monitor')); });
    
    // Kh√¥ng c·∫ßn s·ª± ki·ªán change cho selectExam n·ªØa v√¨ ƒë√£ g√°n ·ªü tr√™n
}

function updateGlobalProgress() {
    const currentSlide = Reveal.getCurrentSlide();
    if (!currentSlide) return;
    const slides = document.querySelectorAll('.reveal .slides section');
    const slideIndex = Array.from(slides).indexOf(currentSlide);
    const progress = (slideIndex / (slides.length - 1)) * 100;
    document.getElementById('globalProgress').style.width = progress + '%';
}

// ===== H·ªÜ TH·ªêNG X√ÅC TH·ª∞C (Authentication) =====
function setupAuthentication() {
    document.getElementById('code-login-form').addEventListener('submit', async e => {
        e.preventDefault();
        const code = document.getElementById('login-code').value.trim();
        const name = document.getElementById('student-name').value.trim() || 'H·ªçc sinh';
        
        if (!code) {
            showNotification('Vui l√≤ng nh·∫≠p m√£ ƒëƒÉng nh·∫≠p', 'error');
            return;
        }

        try {
            if (code === 'admin79') {
                await loginAsTeacher(name);
            } else if (code.startsWith('HS')) {
                // ===== S·ª¨A L·ªñI QUAN TR·ªåNG: CHO PH√âP ƒêƒÇNG NH·∫¨P NHI·ªÄU L·∫¶N V·ªöI C√ôNG M√É H·ªåC SINH =====
                await loginAsStudent(code, name);
            } else {
                showNotification('M√£ ƒëƒÉng nh·∫≠p kh√¥ng h·ª£p l·ªá', 'error');
            }
        } catch (error) {
            console.error('Login error:', error);
            showNotification('L·ªói ƒëƒÉng nh·∫≠p: ' + error.message, 'error');
        }
    });
}

async function loginAsTeacher(name) {
    isTeacherLoggedIn = true;
    currentUser = { uid: 'teacher_admin_79', name, role: 'teacher', code: 'admin79' };
    await db.ref('users/' + currentUser.uid).set({ name, role: 'teacher', lastLogin: firebase.database.ServerValue.TIMESTAMP });
    showNotification(`‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng - GV: ${name}`, 'success');
    updateUIAfterLogin();
}

async function loginAsStudent(code, name) {
    // ===== S·ª¨A L·ªñI QUAN TR·ªåNG: CHO PH√âP ƒêƒÇNG NH·∫¨P NHI·ªÄU L·∫¶N V·ªöI C√ôNG M√É H·ªåC SINH =====
    try {
        const studentSnapshot = await db.ref(`studentCodes/${code}`).once('value');
        const studentData = studentSnapshot.val();
        
        if (!studentData) {
            showNotification('M√£ h·ªçc sinh kh√¥ng t·ªìn t·∫°i!', 'error');
            return;
        }
        
        // ===== S·ª¨A L·ªñI: LO·∫†I B·ªé KI·ªÇM TRA TR·∫†NG TH√ÅI "USED" - CHO PH√âP ƒêƒÇNG NH·∫¨P NHI·ªÄU L·∫¶N =====
        // KH√îNG KI·ªÇM TRA studentData.status === 'used' N·ªÆA
        
        if (studentData.name !== name) {
            showNotification('H·ªç t√™n kh√¥ng kh·ªõp v·ªõi m√£ h·ªçc sinh!', 'error');
            return;
        }

        // ===== S·ª¨A L·ªñI: KH√îNG C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI TH√ÄNH "USED" N·ªÆA =====
        // Ch·ªâ c·∫≠p nh·∫≠t th·ªùi gian ƒëƒÉng nh·∫≠p cu·ªëi
        await db.ref(`studentCodes/${code}`).update({
            lastLogin: firebase.database.ServerValue.TIMESTAMP,
            studentName: name
        });

        isTeacherLoggedIn = false;
        currentUser = { uid: 'student_' + code + '_' + Date.now(), name, role: 'student', code };
        await db.ref('users/' + currentUser.uid).set({ 
            name, 
            role: 'student', 
            code, 
            lastLogin: firebase.database.ServerValue.TIMESTAMP 
        });
        
        showNotification(`‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng - HS: ${name}`, 'success');
        updateUIAfterLogin();
        
        const sessionToJoin = prompt("Nh·∫≠p m√£ l·ªõp h·ªçc ƒë·ªÉ tham gia:");
        if (sessionToJoin) {
            sessionCode = sessionToJoin.toUpperCase();
            joinSessionAsStudent();
        }
    } catch (error) {
        console.error('Student login error:', error);
        showNotification('L·ªói ƒëƒÉng nh·∫≠p h·ªçc sinh: ' + error.message, 'error');
    }
}

function updateUIAfterLogin() {
    hideModal(document.getElementById('login-modal'));
    
    // M·ªû KH√ìA GIAO DI·ªÜN
    document.body.classList.remove('not-logged-in');
    
    const loginBtn = document.getElementById('loginBtn');
    if (isTeacherLoggedIn) {
        loginBtn.innerHTML = 'üë®‚Äçüè´ ' + currentUser.name;
        loginBtn.style.background = '#28a745';
        document.getElementById('teacherMonitorBtn').style.display = 'inline-block';
        document.getElementById('classManagementBtn').style.display = 'inline-block';
        document.getElementById('teacherMonitorBtn').style.display = 'inline-block';
        showNotification('Ch√†o m·ª´ng gi√°o vi√™n! B·∫°n c√≥ th·ªÉ t·∫°o l·ªõp h·ªçc m·ªõi.', 'success');
    } else {
        loginBtn.innerHTML = 'üë§ ' + currentUser.name;
        document.getElementById('studentInteractBtn').style.display = 'inline-block';
        showNotification('Ch√†o m·ª´ng h·ªçc sinh! H√£y ch·ªçn ƒë·ªÅ ƒë·ªÉ b·∫Øt ƒë·∫ßu.', 'success');
    }
}

// ===== QU·∫¢N L√ù L·ªöP H·ªåC (Session Management) =====
function setupSessionManagement() {
    // ƒê√£ chuy·ªÉn event listeners v√†o modal teacher-monitor
}

function generateSessionCode() {
    return Math.random().toString(36).substr(2, 6).toUpperCase();
}

async function createNewSession() {
    if (!isTeacherLoggedIn) return showNotification('Ch·ªâ gi√°o vi√™n m·ªõi c√≥ th·ªÉ t·∫°o l·ªõp h·ªçc', 'error');
    sessionCode = generateSessionCode();
    try {
        await db.ref('sessions/' + sessionCode).set({
            created: firebase.database.ServerValue.TIMESTAMP,
            teacher: currentUser.name,
            status: 'active',
            currentSlide: 0
        });
        document.getElementById('monitor-session-code').textContent = sessionCode;
        showNotification(`‚úÖ ƒê√£ t·∫°o l·ªõp h·ªçc! M√£ l·ªõp: <strong>${sessionCode}</strong>`, 'success');
        startMonitoringSession();
    } catch (error) {
        console.error('Error creating session:', error);
        showNotification('L·ªói t·∫°o l·ªõp h·ªçc: ' + error.message, 'error');
    }
}

function joinSessionAsStudent() {
    if (!sessionCode || !currentUser) return showNotification('Vui l√≤ng ƒëƒÉng nh·∫≠p v√† c√≥ m√£ l·ªõp h·ªçc', 'error');
    const studentRef = db.ref('sessions/' + sessionCode + '/students/' + currentUser.uid);
    studentRef.set({
        name: currentUser.name, code: currentUser.code,
        joined: firebase.database.ServerValue.TIMESTAMP,
        status: 'active', score: 0, progress: 0, currentSlide: 0,
        lastActivity: firebase.database.ServerValue.TIMESTAMP // Th√™m th·ªùi gian ho·∫°t ƒë·ªông cu·ªëi
    }).then(() => {
        showNotification(`‚úÖ ƒê√£ tham gia l·ªõp h·ªçc: ${sessionCode}`, 'success');
        listenToSessionChanges();
    }).catch(error => {
        console.error('Error joining session:', error);
        showNotification('L·ªói tham gia l·ªõp h·ªçc: ' + error.message, 'error');
    });
}

function listenToSessionChanges() {
    db.ref('sessions/' + sessionCode + '/currentSlide').on('value', snapshot => {
        const slideIndex = snapshot.val();
        if (slideIndex !== null && slideIndex !== undefined && Reveal.getIndices().h !== slideIndex) {
            Reveal.slide(slideIndex);
        }
    });
    db.ref('sessions/' + sessionCode + '/poll').on('value', snapshot => {
    const pollData = snapshot.val();
    if (pollData && pollData.active) showPoll(pollData);
    else hidePoll();
    });
// X√ìA PH·∫¶N const pollData = {...} B·ªä TR√ôNG ·ªû ƒê√ÇY
}

function syncSlidesWithStudents() {
    if (!isTeacherLoggedIn || !sessionCode) return showNotification('Vui l√≤ng t·∫°o l·ªõp h·ªçc tr∆∞·ªõc', 'error');
    const slideIndex = Reveal.getIndices().h;
    db.ref('sessions/' + sessionCode + '/currentSlide').set(slideIndex)
        .then(() => showNotification(`‚úÖ ƒê√£ ƒë·ªìng b·ªô slide ${slideIndex + 1}`, 'success'))
        .catch(error => showNotification('L·ªói ƒë·ªìng b·ªô slide: ' + error.message, 'error'));
}

// === QU·∫¢N L√ù L·ªöP V√Ä H·ªåC SINH - C·∫¢I TI·∫æN V·ªöI MODAL SYSTEM ===
function setupClassManagement() {
    console.log("üîß Kh·ªüi t·∫°o qu·∫£n l√Ω l·ªõp...");
    
    // S·ª± ki·ªán m·ªü modal qu·∫£n l√Ω l·ªõp
    document.getElementById('classManagementBtn').addEventListener('click', () => {
        if (!isTeacherLoggedIn) {
            showNotification('Ch·ªâ gi√°o vi√™n m·ªõi c√≥ quy·ªÅn qu·∫£n l√Ω l·ªõp!', 'error');
            return;
        }
        showModal('class-management-modal');
        loadClassesList();
        loadStudentsList();
    });

    // S·ª± ki·ªán t·∫°o l·ªõp m·ªõi
    document.getElementById('create-class-btn').addEventListener('click', () => {
        showModal('create-class-modal');
    });

    // Form t·∫°o l·ªõp
    document.getElementById('create-class-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await createNewClass();
    });

    // L√†m m·ªõi danh s√°ch
    document.getElementById('refresh-classes-btn').addEventListener('click', () => {
        loadClassesList();
        loadStudentsList();
    });

    // T√¨m ki·∫øm h·ªçc sinh
    document.getElementById('search-student-global').addEventListener('input', loadStudentsList);
    document.getElementById('filter-class').addEventListener('change', loadStudentsList);
}
// TH√äM V√ÄO CU·ªêI H√ÄM setupClassManagement()
        document.getElementById('class-poll-btn').addEventListener('click', startClassPoll);
        document.getElementById('class-sync-btn').addEventListener('click', syncClassSlides);
        document.getElementById('view-poll-results-btn').addEventListener('click', viewClassPollResults);
        document.getElementById('view-interactions-btn').addEventListener('click', viewClassInteractions);

// T·∫°o l·ªõp m·ªõi
async function createNewClass() {
    const className = document.getElementById('class-name').value.trim();
    const classDescription = document.getElementById('class-description').value.trim();

    if (!className) {
        showNotification('Vui l√≤ng nh·∫≠p t√™n l·ªõp!', 'error');
        return;
    }

    try {
        // T·∫°o backup tr∆∞·ªõc khi t·∫°o l·ªõp
        await createBackup('T·∫°o l·ªõp m·ªõi: ' + className);
        
        const classCode = generateClassCode();
        const classData = {
            name: className,
            description: classDescription,
            code: classCode,
            teacher: currentUser.name,
            teacherId: currentUser.uid,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            studentCount: 0,
            status: 'active'
        };

        await db.ref(`classes/${classCode}`).set(classData);
        
        hideModal(document.getElementById('create-class-modal'));
        document.getElementById('create-class-form').reset();
        
        showNotification(`‚úÖ ƒê√£ t·∫°o l·ªõp "${className}" v·ªõi m√£: ${classCode}`, 'success');
        loadClassesList();
        
    } catch (error) {
        console.error('L·ªói t·∫°o l·ªõp:', error);
        showNotification('‚ùå L·ªói khi t·∫°o l·ªõp!', 'error');
    }
}

// T·∫°o m√£ l·ªõp ng·∫´u nhi√™n
function generateClassCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
        code += chars[Math.floor(Math.random() * chars.length)];
    }
    return code;
}

// T·∫£i danh s√°ch l·ªõp
async function loadClassesList() {
    try {
        const snapshot = await db.ref('classes').orderByChild('createdAt').once('value');
        const classes = snapshot.val() || {};
        
        const tbody = document.getElementById('classes-list-body');
        let html = '';
        
        Object.entries(classes).forEach(([classCode, classData]) => {
            // Ch·ªâ hi·ªÉn th·ªã l·ªõp c·ªßa gi√°o vi√™n hi·ªán t·∫°i
            if (classData.teacherId !== currentUser.uid) return;
            
            const createDate = classData.createdAt ? 
                new Date(classData.createdAt).toLocaleDateString('vi-VN') : 'N/A';
            
            html += `
                <tr>
                    <td>
                        <strong>${classData.name}</strong>
                        ${classData.description ? `<br><small style="color: #666;">${classData.description}</small>` : ''}
                    </td>
                    <td><code style="background: #1a237e; color: white; padding: 4px 8px; border-radius: 4px;">${classCode}</code></td>
                    <td style="text-align: center;">
                        <span style="font-weight: bold; color: #1a237e;">${classData.studentCount || 0}</span>
                    </td>
                    <td>${createDate}</td>
                    <td style="text-align: center;">
                        <span class="status-active">üü¢ Ho·∫°t ƒë·ªông</span>
                    </td>
                    <td style="text-align: center;">
                        <button onclick="viewClassDetails('${classCode}')" style="padding: 6px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin: 2px;">
                            üëÅÔ∏è Xem
                        </button>
                        <button onclick="confirmDeleteClass('${classCode}')" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin: 2px;">
                            üóëÔ∏è X√≥a
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html || `
            <tr>
                <td colspan="6" style="text-align: center; padding: 30px; color: #666;">
                    Ch∆∞a c√≥ l·ªõp h·ªçc n√†o. H√£y t·∫°o l·ªõp ƒë·∫ßu ti√™n!
                </td>
            </tr>
        `;
        
        // C·∫≠p nh·∫≠t dropdown l·ªçc l·ªõp
        updateClassFilter(classes);
        
    } catch (error) {
        console.error('L·ªói t·∫£i danh s√°ch l·ªõp:', error);
        document.getElementById('classes-list-body').innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 30px; color: #dc3545;">
                    ‚ùå L·ªói khi t·∫£i danh s√°ch l·ªõp
                </td>
            </tr>
        `;
    }
}

// X√°c nh·∫≠n x√≥a l·ªõp
function confirmDeleteClass(classCode) {
    const classData = classes[classCode];
    if (!classData) return;
    
    document.getElementById('confirm-delete-message').textContent = 
        `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a l·ªõp "${classData.name}"? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`;
    
    document.getElementById('confirm-delete-yes').onclick = function() {
        deleteClass(classCode);
        hideModal(document.getElementById('confirm-delete-modal'));
    };
    
    showModal('confirm-delete-modal');
}

// X√≥a l·ªõp
async function deleteClass(classCode) {
    try {
        // T·∫°o backup tr∆∞·ªõc khi x√≥a
        await createBackup('X√≥a l·ªõp: ' + classes[classCode].name);
        
        await db.ref(`classes/${classCode}`).remove();
        showNotification('‚úÖ ƒê√£ x√≥a l·ªõp th√†nh c√¥ng!', 'success');
        loadClassesList();
    } catch (error) {
        console.error('L·ªói x√≥a l·ªõp:', error);
        showNotification('‚ùå L·ªói khi x√≥a l·ªõp!', 'error');
    }
}

// === QU·∫¢N L√ù M√É H·ªåC SINH - C·∫¢I TI·∫æN V·ªöI LU·ªíNG M·ªöI ===
function setupStudentCodeManagement() {
    console.log("üîß Kh·ªüi t·∫°o qu·∫£n l√Ω m√£ h·ªçc sinh...");
    
    // M·ªü modal c·∫•p m√£
    document.getElementById('assign-student-btn-main').addEventListener('click', () => {
        if (!isTeacherLoggedIn) {
            showNotification('Ch·ªâ gi√°o vi√™n m·ªõi c√≥ quy·ªÅn c·∫•p m√£!', 'error');
            return;
        }
        showModal('assign-student-modal');
        loadClassesForAssignment();
        generateStudentCode();
    });

    // M·ªü modal danh s√°ch m√£
    document.getElementById('view-student-codes-btn').addEventListener('click', () => {
        showModal('student-codes-modal');
        loadStudentCodesList();
    });

    // T·∫°o m√£ m·ªõi
    document.getElementById('generate-student-code-btn').addEventListener('click', generateStudentCode);

    // C·∫•p m√£ h·ªçc sinh
    document.getElementById('assign-student-btn').addEventListener('click', assignStudentCode);
}

// T·∫£i danh s√°ch l·ªõp ƒë·ªÉ g√°n m√£
async function loadClassesForAssignment() {
    try {
        const snapshot = await db.ref('classes').once('value');
        const classes = snapshot.val() || {};
        const select = document.getElementById('select-class-for-student');
        
        let options = '<option value="">-- Ch·ªçn l·ªõp --</option>';
        
        Object.entries(classes).forEach(([classCode, classData]) => {
            if (classData.teacherId === currentUser.uid) {
                options += `<option value="${classCode}">${classData.name} (${classCode})</option>`;
            }
        });
        
        select.innerHTML = options;
        
    } catch (error) {
        console.error('L·ªói t·∫£i danh s√°ch l·ªõp:', error);
    }
}

// T·∫°o m√£ h·ªçc sinh ng·∫´u nhi√™n
function generateStudentCode() {
    const prefix = 'HS';
    const randomNum = Math.floor(100000 + Math.random() * 900000);
    const studentCode = `${prefix}${randomNum}`;
    
    document.getElementById('generated-student-code').textContent = studentCode;
    return studentCode;
}

// T·∫°o m·∫≠t kh·∫©u ng·∫´u nhi√™n
function generatePassword(length = 6) {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let password = '';
    for (let i = 0; i < length; i++) {
        password += chars[Math.floor(Math.random() * chars.length)];
    }
    return password;
}

// C·∫•p m√£ h·ªçc sinh - LU·ªíNG M·ªöI T·ªêI ∆ØU
async function assignStudentCode() {
    const classCode = document.getElementById('select-class-for-student').value;
    const studentName = document.getElementById('student-fullname').value.trim();
    const studentCode = document.getElementById('generated-student-code').textContent;

    if (!classCode) {
        showNotification('Vui l√≤ng ch·ªçn l·ªõp!', 'error');
        return;
    }

    if (!studentName) {
        showNotification('Vui l√≤ng nh·∫≠p h·ªç t√™n h·ªçc sinh!', 'error');
        return;
    }

    try {
        const password = generatePassword();
        
        // 1. L∆ØU M√É H·ªåC SINH v·ªõi th√¥ng tin l·ªõp
        const studentCodeData = {
            code: studentCode,
            name: studentName,
            classCode: classCode,
            className: await getClassName(classCode), // L·∫•y t√™n l·ªõp
            password: password,
            teacherId: currentUser.uid,
            teacherName: currentUser.name,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            status: 'active' // ===== S·ª¨A L·ªñI: LU√îN ƒê·ªÇ STATUS L√Ä 'active' THAY V√å 'used' =====
        };

        await db.ref(`studentCodes/${studentCode}`).set(studentCodeData);

        // 2. C·∫¨P NH·∫¨T S·ªê L∆Ø·ª¢NG H·ªåC SINH TRONG L·ªöP
        await updateStudentCountInClass(classCode);

        // 3. T·∫†O USER H·ªåC SINH (n·∫øu c·∫ßn)
        await createStudentUser(studentCode, studentName, classCode);

        showNotification(`‚úÖ ƒê√£ c·∫•p m√£ ${studentCode} cho ${studentName} trong l·ªõp`, 'success');
        loadStudentCodesList();
        loadStudentsList(); // Refresh danh s√°ch h·ªçc sinh
        
        document.getElementById('student-fullname').value = '';
        document.getElementById('student-fullname').focus();
        generateStudentCode();

    } catch (error) {
        console.error('L·ªói c·∫•p m√£ h·ªçc sinh:', error);
        showNotification('‚ùå L·ªói khi c·∫•p m√£ h·ªçc sinh!', 'error');
    }
}

// H√†m l·∫•y t√™n l·ªõp t·ª´ m√£ l·ªõp
async function getClassName(classCode) {
    try {
        const snapshot = await db.ref(`classes/${classCode}/name`).once('value');
        return snapshot.val() || 'Unknown Class';
    } catch (error) {
        return 'Unknown Class';
    }
}

// H√†m c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng h·ªçc sinh trong l·ªõp
async function updateStudentCountInClass(classCode) {
    try {
        // ƒê·∫øm s·ªë h·ªçc sinh trong l·ªõp
        const snapshot = await db.ref('studentCodes').orderByChild('classCode').equalTo(classCode).once('value');
        const students = snapshot.val() || {};
        const studentCount = Object.keys(students).length;
        
        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
        await db.ref(`classes/${classCode}/studentCount`).set(studentCount);
    } catch (error) {
        console.error('L·ªói c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng h·ªçc sinh:', error);
    }
}

// H√†m t·∫°o user h·ªçc sinh
async function createStudentUser(studentCode, studentName, classCode) {
    try {
        const userId = `student_${studentCode}`;
        const userData = {
            name: studentName,
            role: 'student',
            code: studentCode,
            classCode: classCode,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            status: 'active'
        };
        
        await db.ref(`users/${userId}`).set(userData);
    } catch (error) {
        console.error('L·ªói t·∫°o user h·ªçc sinh:', error);
    }
}
// T·∫£i danh s√°ch m√£ h·ªçc sinh
async function loadStudentCodesList() {
    try {
        const snapshot = await db.ref('studentCodes').once('value');
        const studentCodes = snapshot.val() || {};
        
        const tbody = document.getElementById('student-codes-list');
        let html = '';
        
        Object.entries(studentCodes).forEach(([code, data]) => {
            if (data.teacherId !== currentUser.uid) return;
            
            const createDate = data.createdAt ? 
                new Date(data.createdAt).toLocaleDateString('vi-VN') : 'N/A';
            
            // ===== S·ª¨A L·ªñI: HI·ªÇN TH·ªä TR·∫†NG TH√ÅI LU√îN L√Ä 'active' =====
            const status = '<span class="status-active">Ho·∫°t ƒë·ªông</span>';
            
            html += `
                <tr>
                    <td><strong>${code}</strong></td>
                    <td>${data.name}</td>
                    <td>${data.classCode}</td>
                    <td>${createDate}</td>
                    <td>${status}</td>
                    <td>${data.password}</td>
                    <td>
                        <button onclick="revokeStudentCode('${code}')" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            üîí Kh√≥a
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html || `
            <tr>
                <td colspan="7" style="text-align: center; padding: 30px; color: #666;">
                    Ch∆∞a c√≥ m√£ h·ªçc sinh n√†o ƒë∆∞·ª£c c·∫•p
                </td>
            </tr>
        `;
        
    } catch (error) {
        console.error('L·ªói t·∫£i danh s√°ch m√£ h·ªçc sinh:', error);
    }
}

// === H·ªÜ TH·ªêNG BACKUP ===
async function createBackup(description) {
    try {
        const timestamp = new Date().toISOString();
        const backupData = {
            timestamp: timestamp,
            description: description,
            createdBy: currentUser.uid,
            userName: currentUser.name
        };

        await db.ref('backupHistory').push(backupData);
        console.log('‚úÖ Backup created:', description);
    } catch (error) {
        console.error('‚ùå Backup failed:', error);
    }
}

// ===== S·ª¨A L·ªñI: THEO D√ïI H·ªåC SINH KH√îNG HO·∫†T ƒê·ªòNG =====
function checkInactiveStudents() {
    if (!isTeacherLoggedIn || !sessionCode) return;
    
    const now = Date.now();
    const inactiveThreshold = 2 * 60 * 1000; // 2 ph√∫t
    
    db.ref(`sessions/${sessionCode}/students`).once('value').then(snapshot => {
        const students = snapshot.val() || {};
        
        Object.entries(students).forEach(([studentId, student]) => {
            if (student.lastActivity) {
                const timeSinceLastActivity = now - student.lastActivity;
                if (timeSinceLastActivity > inactiveThreshold) {
                    if (!inactiveStudents.has(studentId)) {
                        inactiveStudents.add(studentId);
                        showNotification(`‚ö†Ô∏è H·ªçc sinh ${student.name} kh√¥ng ho·∫°t ƒë·ªông trong ${Math.floor(timeSinceLastActivity/60000)} ph√∫t`, 'warning');
                    }
                } else {
                    inactiveStudents.delete(studentId);
                }
            }
        });
    });
}

// C·∫≠p nh·∫≠t ho·∫°t ƒë·ªông c·ªßa h·ªçc sinh
function updateStudentActivity() {
    if (!currentUser || !sessionCode || isTeacherLoggedIn) return;
    
    db.ref(`sessions/${sessionCode}/students/${currentUser.uid}`).update({
        lastActivity: firebase.database.ServerValue.TIMESTAMP
    });
}

// Th√™m event listeners ƒë·ªÉ theo d√µi ho·∫°t ƒë·ªông
document.addEventListener('mousemove', updateStudentActivity);
document.addEventListener('keydown', updateStudentActivity);
document.addEventListener('click', updateStudentActivity);

// ===== KI·ªÇM TRA ƒê√ÅP √ÅN & ƒêI·ªÇM S·ªê =====
// T·∫§T C·∫¢ C√ÅC H√ÄM KI·ªÇM TRA ƒê√ÅP √ÅN G·ªêC ƒê∆Ø·ª¢C GI·ªÆ NGUY√äN
window.checkAnswer = function(qid, correct) {
    try {
        const container = document.getElementById(qid);
        if (!container) {
            console.error(`Kh√¥ng t√¨m th·∫•y container cho c√¢u h·ªèi: ${qid}`);
            showNotification('L·ªói: Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi!', 'error');
            return;
        }

        // X√≥a icon c≈©
        container.querySelectorAll('.option-icon').forEach(el => el.textContent = '');

        // L·∫•y l·ª±a ch·ªçn
        const chosen = container.querySelector(`input[name="${qid}"]:checked`);
        if (!chosen) {
            showNotification("H√£y ch·ªçn m·ªôt ƒë√°p √°n!", 'warning');
            playSound('wrong');
            return;
        }

        const chosenVal = chosen.value;
        const resultArea = container.querySelector(".answer-check");

        // T·∫°o v√πng th√¥ng b√°o n·∫øu ch∆∞a c√≥
        let feedback = resultArea.querySelector(".result");
        if (!feedback) {
            feedback = document.createElement("div");
            feedback.className = "result";
            feedback.style.marginTop = "10px";
            feedback.style.padding = "12px";
            feedback.style.background = "rgba(255,255,255,0.9)";
            feedback.style.borderRadius = "8px";
            feedback.style.border = "1px solid #e0e0e0";
            feedback.style.fontSize = "0.95em";
            resultArea.appendChild(feedback);
        }

        // Hi·ªÉn th·ªã k·∫øt qu·∫£
        if (chosenVal === correct) {
            // ƒê√°p √°n ƒë√∫ng
            const userOption = chosen.closest('.option-row');
            const icon = userOption.querySelector('.option-icon');
            if (icon) icon.textContent = '‚úÖ';
            
            feedback.innerHTML = `
                <div style="color: #28a745; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                    <span>‚úÖ</span>
                    <span><b>Ch√≠nh x√°c!</b></span>
                </div>
                <div style="margin-top: 8px; padding: 8px; background: #d4edda; border-radius: 6px;">
                    ƒê√°p √°n c·ªßa b·∫°n: <b>${chosenVal}</b>
                </div>
            `;
            
            // ƒê√°nh d·∫•u t·∫•t c·∫£ options
            container.querySelectorAll('.option-row').forEach(row => {
                const radio = row.querySelector('input[type="radio"]');
                radio.disabled = true;
                if (radio.value === correct) {
                    row.style.background = 'linear-gradient(135deg, #d4edda, #c3e6cb)';
                    row.style.borderColor = '#28a745';
                }
            });
            
            playSound('correct');
            
            if (currentUser && sessionCode) {
                savePartial(qid, chosenVal, correct, true);
            }
            
            showNotification(`‚úÖ C√¢u ${qid}: Ch√≠nh x√°c! (+0.25 ƒëi·ªÉm)`, 'success');
            
        } else {
            // ƒê√°p √°n sai
            const userOption = chosen.closest('.option-row');
            const correctOption = container.querySelector(`input[value="${correct}"]`).closest('.option-row');
            
            const userIcon = userOption?.querySelector('.option-icon');
            const correctIcon = correctOption?.querySelector('.option-icon');
            
            if (userIcon) userIcon.textContent = '‚ùå';
            if (correctIcon) correctIcon.textContent = '‚úÖ';
            
            feedback.innerHTML = `
                <div style="color: #dc3545; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                    <span>‚ùå</span>
                    <span><b>Sai r·ªìi.</b></span>
                </div>
                <div style="margin-top: 8px; padding: 8px; background: #f8d7da; border-radius: 6px;">
                    B·∫°n ch·ªçn: <b>${chosenVal}</b>
                </div>
                <div style="margin-top: 5px; padding: 8px; background: #d4edda; border-radius: 6px;">
                    ƒê√°p √°n ƒë√∫ng: <b style="color: #28a745">${correct}</b>
                </div>
            `;
            
            // ƒê√°nh d·∫•u t·∫•t c·∫£ options
            container.querySelectorAll('.option-row').forEach(row => {
                const radio = row.querySelector('input[type="radio"]');
                radio.disabled = true;
                const value = radio.value;
                if (value === correct) {
                    row.style.background = 'linear-gradient(135deg, #d4edda, #c3e6cb)';
                    row.style.borderColor = '#28a745';
                } else if (value === chosenVal) {
                    row.style.background = 'linear-gradient(135deg, #f8d7da, #f5c6cb)';
                    row.style.borderColor = '#dc3545';
                }
            });
            
            playSound('wrong');
            
            if (currentUser && sessionCode) {
                savePartial(qid, chosenVal, correct, false);
            }
            
            showNotification(`‚ùå C√¢u ${qid}: Ch∆∞a ch√≠nh x√°c`, 'error');
        }
        
    } catch (error) {
        console.error('L·ªói trong checkAnswer:', error);
        showNotification('C√≥ l·ªói x·∫£y ra khi ki·ªÉm tra ƒë√°p √°n!', 'error');
    }
};

window.checkTrueFalseAnswer = function(questionId, correctAnswers) {
    // X·ª≠ l√Ω ƒë·∫ßu v√†o correctAnswers
    if (typeof correctAnswers === 'string') {
        try { 
            correctAnswers = JSON.parse(correctAnswers); 
        } catch(e) { 
            correctAnswers = correctAnswers.replace(/^\[|\]$/g, '').split(',').map(s => s.trim().replace(/^["']|["']$/g, '')); 
        }
    }
    
    if (!Array.isArray(correctAnswers)) {
        console.warn('Invalid correctAnswers for', questionId);
        return;
    }

    const container = document.getElementById(questionId);
    if (!container) {
        console.warn('No container', questionId);
        return;
    }

    const optionRows = container.querySelectorAll(".option-row");
    let allCorrect = true;
    let feedbackHtml = '';
    let score = 0;

    optionRows.forEach((row, idx) => {
        const radios = row.querySelectorAll("input[type='radio']");
        let selected = null;
        radios.forEach(r => { if (r.checked) selected = r.value; });

        const expected = (correctAnswers[idx] && String(correctAnswers[idx]).toLowerCase().startsWith('t')) ? 'True' : 'False';
        const letter = String.fromCharCode(97 + idx); // a, b, c, d

        if (selected === null) {
            feedbackHtml += `M·ªánh ƒë·ªÅ ${letter}) ‚≠ï Ch∆∞a ch·ªçn<br>`;
            allCorrect = false;
        } else if (selected === expected) {
            feedbackHtml += `M·ªánh ƒë·ªÅ ${letter}) ‚úÖ ƒê√∫ng<br>`;
            score += 0.25;
            const icon = row.querySelector('.option-icon');
            if (icon) icon.textContent = '‚úÖ';
        } else {
            feedbackHtml += `M·ªánh ƒë·ªÅ ${letter}) ‚ùå Sai (ch·ªçn ${selected})<br>`;
            const icon = row.querySelector('.option-icon');
            if (icon) icon.textContent = '‚ùå';
            allCorrect = false;
        }
    });

    // Hi·ªÉn th·ªã k·∫øt qu·∫£
    let resultBox = container.querySelector(".answer-check .result");
    if (!resultBox) {
        resultBox = document.createElement('div');
        resultBox.className = 'result';
        resultBox.style.marginTop = '8px';
        resultBox.style.padding = '12px';
        resultBox.style.background = 'rgba(255,255,255,0.9)';
        resultBox.style.borderRadius = '8px';
        resultBox.style.border = '1px solid #e0e0e0';
        container.querySelector(".answer-check").appendChild(resultBox);
    }
    
    resultBox.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 8px;">üìä K·∫øt qu·∫£ ki·ªÉm tra:</div>
        ${feedbackHtml}
        <div style="margin-top: 8px; font-weight: bold; color: ${allCorrect ? '#28a745' : '#ffc107'}">
            ƒêi·ªÉm: ${score}/1.00
        </div>
    `;

    // Kh√≥a inputs c·ªßa c√¢u n√†y
    container.querySelectorAll("input[type='radio']").forEach(r => r.disabled = true);

    // L∆∞u partial t·ª´ng m·ªánh ƒë·ªÅ n·∫øu ƒëƒÉng nh·∫≠p
    if (currentUser && sessionCode) {
        optionRows.forEach((row, idx) => {
            const sel = row.querySelector("input[type='radio']:checked");
            const user = sel ? sel.value : '';
            const expected = (correctAnswers[idx] && String(correctAnswers[idx]).toLowerCase().startsWith('t')) ? 'True' : 'False';
            try { 
                savePartial(questionId + '_' + idx, user, expected, user === expected); 
            } catch(e){}
        });
        
        // L∆∞u t·ªïng ƒëi·ªÉm cho c√¢u h·ªèi
        savePartial(questionId, score, 1, allCorrect);
    }

    if (allCorrect) {
        playSound('correct');
        showNotification(`‚úÖ C√¢u ${questionId}: Ho√†n to√†n ch√≠nh x√°c!`, 'success');
    } else {
        playSound('partial');
        showNotification(`‚ö†Ô∏è C√¢u ${questionId}: ƒê√∫ng ${score * 4}/4 m·ªánh ƒë·ªÅ`, 'warning');
    }
};

window.checkShortAnswer = function(qid, correct) {
    const input = document.getElementById(`input-${qid}`);
    const icon = document.getElementById(`icon-${qid}`);
    const resultBox = input?.closest(".answer-check");

    if (!input) return;

    const userAnswer = input.value.trim();

    // T·∫°o v√πng th√¥ng b√°o n·∫øu ch∆∞a c√≥
    let feedback = resultBox.querySelector(".result");
    if (!feedback) {
        feedback = document.createElement("div");
        feedback.className = "result";
        feedback.style.marginTop = "10px";
        feedback.style.padding = "12px";
        feedback.style.borderRadius = "8px";
        feedback.style.background = "rgba(255,255,255,0.9)";
        feedback.style.border = "1px solid #e0e0e0";
        feedback.style.fontSize = "0.95em";
        resultBox.appendChild(feedback);
    }

    if (userAnswer === "") {
        icon.textContent = "‚ö†Ô∏è";
        feedback.innerHTML = "‚ùó <b>B√°o th·∫ßy ki·ªÉm tr·ª±c ti·∫øp v√¨ ch∆∞a gi·∫£i.</b>";
        playSound('wrong');
        return;
    }

    // Chu·∫©n h√≥a ƒë√°p √°n ƒë·ªÉ so s√°nh
    const normalizedUser = userAnswer.toLowerCase().replace(/\s+/g, '');
    const normalizedCorrect = correct.trim().toLowerCase().replace(/\s+/g, '');

    if (normalizedUser === normalizedCorrect) {
        icon.textContent = "‚úÖ";
        feedback.innerHTML = `
            <div style="color: #28a745; font-weight: bold;">
                üéØ <b>ƒê√∫ng r·ªìi!</b>
            </div>
            <div style="margin-top: 5px;">ƒê√°p √°n c·ªßa b·∫°n: <b>${userAnswer}</b></div>
        `;
        input.style.borderColor = '#28a745';
        input.style.background = '#d4edda';
        input.disabled = true;
        
        if (currentUser && sessionCode) {
            try { savePartial(qid, userAnswer, correct, true); } catch(e){}
        }
        playSound('correct');
        showNotification(`‚úÖ C√¢u ${qid}: Ch√≠nh x√°c!`, 'success');
    } else {
        icon.textContent = "‚ùå";
        feedback.innerHTML = `
            <div style="color: #dc3545; font-weight: bold;">
                ‚ùå <b>Sai r·ªìi.</b>
            </div>
            <div style="margin-top: 5px;">ƒê√°p √°n c·ªßa b·∫°n: <b>${userAnswer}</b></div>
            <div>ƒê√°p √°n ƒë√∫ng l√†: <b style="color: #28a745">${correct}</b></div>
        `;
        input.style.borderColor = '#dc3545';
        input.style.background = '#f8d7da';
        input.disabled = true;
        
        if (currentUser && sessionCode) {
            try { savePartial(qid, userAnswer, correct, false); } catch(e){}
        }
        playSound('wrong');
        showNotification(`‚ùå C√¢u ${qid}: Ch∆∞a ch√≠nh x√°c`, 'error');
    }
};

// === T√çNH ƒêI·ªÇM T·ªîNG H·ª¢P N√ÇNG CAO ===
window.calculateFinalScore = async function() {
    if (isTeacherLoggedIn) {
        showNotification("Gi√°o vi√™n kh√¥ng t√≠nh ƒëi·ªÉm.", "info");
        return;
    }
    
    if (!currentUser || !sessionCode) {
        showNotification("Vui l√≤ng ƒëƒÉng nh·∫≠p v√† tham gia l·ªõp h·ªçc.", "warning");
        return;
    }

    // Reset flag ƒë·ªÉ cho ph√©p t√≠nh l·∫°i n·∫øu c·∫ßn
    window.isScoreCalculated = false;
    
    const studentAnswers = {};
    const correctAnswers = {};
    let totalScore = 0;

    // Thu th·∫≠p ƒë√°p √°n ƒë√∫ng t·ª´ onclick ho·∫∑c data-correct
    document.querySelectorAll('.question').forEach(q => {
        const qid = q.id;
        if (!qid) return;
        
        const btn = q.querySelector('button[onclick*="check"]');
        const onclickStr = btn ? (btn.getAttribute('onclick') || '') : '';

        if (onclickStr.includes('checkTrueFalseAnswer')) {
            const arrMatch = onclickStr.match(/\[(.*?)\]/);
            if (arrMatch) {
                const arr = arrMatch[1].split(',').map(s => s.replace(/['"\s\[\]]/g, '').trim());
                if (arr.length) correctAnswers[qid] = arr;
            }
        } else if (onclickStr.includes('checkShortAnswer')) {
            const m = onclickStr.match(/checkShortAnswer\(['"]([^'"]+)['"]\s*,\s*['"]([^'"]+)['"]\)/);
            if (m) correctAnswers[m[1]] = m[2];
        } else if (onclickStr.includes('checkAnswer')) {
            const m = onclickStr.match(/checkAnswer\(['"]([^'"]+)['"]\s*,\s*['"]([A-Za-z0-9]+)['"]\)/);
            if (m) correctAnswers[m[1]] = m[2].toString().toUpperCase();
        }

        // Fallback data-correct
        if (!correctAnswers[qid]) {
            const dataCorrect = q.getAttribute('data-correct');
            if (dataCorrect) {
                try { 
                    correctAnswers[qid] = JSON.parse(dataCorrect); 
                } catch(e) { 
                    correctAnswers[qid] = dataCorrect; 
                }
            }
        }
    });

    // Thu th·∫≠p ƒë√°p √°n h·ªçc sinh
    // C√¢u h·ªèi tr·∫Øc nghi·ªám ƒë∆°n (1-12)
    for (let i = 1; i <= 12; i++) {
        const name = 'q' + i;
        const selected = document.querySelector(`input[name="${name}"]:checked`);
        studentAnswers[name] = selected ? selected.value.trim() : '';
    }

    // C√¢u h·ªèi True/False (13-16)
    for (let i = 13; i <= 16; i++) {
        const sub = [];
        ['a','b','c','d'].forEach(letter => {
            const sel = document.querySelector(`input[name="q${i}${letter}"]:checked`);
            sub.push(sel ? sel.value.trim() : '');
        });
        studentAnswers['q' + i] = sub;
    }

    // C√¢u h·ªèi tr·∫£ l·ªùi ng·∫Øn (17-22)
    for (let i = 17; i <= 22; i++) {
        const el = document.getElementById(`input-q${i}`);
        studentAnswers['q' + i] = el ? el.value.trim().replace(',', '.') : '';
    }

    // T√≠nh ƒëi·ªÉm
    for (let i = 1; i <= 22; i++) {
        const key = 'q' + i;
        const userAns = studentAnswers[key];
        const corr = correctAnswers[key];
        
        if (i >= 1 && i <= 12) {
            // C√¢u tr·∫Øc nghi·ªám ƒë∆°n: 0.25 ƒëi·ªÉm m·ªói c√¢u
            if (!corr) continue;
            if (userAns && String(userAns).toUpperCase() === String(corr).toUpperCase()) {
                totalScore += 0.25;
            }
        } else if (i >= 13 && i <= 16) {
            // C√¢u True/False: t√≠nh theo s·ªë m·ªánh ƒë·ªÅ ƒë√∫ng
            if (!Array.isArray(corr) || !Array.isArray(userAns)) continue;
            
            let correctCount = 0;
            for (let j = 0; j < corr.length && j < userAns.length; j++) {
                const exp = String(corr[j]).toLowerCase();
                const u = String(userAns[j]).toLowerCase();
                if (u && (u === exp || 
                    (exp.startsWith('t') && u.startsWith('t')) || 
                    (exp.startsWith('ƒë') && u.startsWith('ƒë')))) {
                    correctCount++;
                }
            }
            
            // T√≠nh ƒëi·ªÉm theo s·ªë m·ªánh ƒë·ªÅ ƒë√∫ng
            if (correctCount === 1) totalScore += 0.1;
            else if (correctCount === 2) totalScore += 0.25;
            else if (correctCount === 3) totalScore += 0.5;
            else if (correctCount === 4) totalScore += 1;
        } else if (i >= 17 && i <= 22) {
            // C√¢u tr·∫£ l·ªùi ng·∫Øn: 0.5 ƒëi·ªÉm m·ªói c√¢u
            if (typeof corr === 'undefined') continue;
            
            const userNum = parseFloat((userAns || '').toString().replace(',', '.'));
            const corrNum = parseFloat((corr || '').toString().replace(',', '.'));
            
            if (!isNaN(userNum) && !isNaN(corrNum)) {
                if (Math.abs(userNum - corrNum) < 0.001) {
                    totalScore += 0.5;
                }
            } else {
                if ((userAns || '').toString().trim().toLowerCase() === 
                    (corr || '').toString().trim().toLowerCase()) {
                    totalScore += 0.5;
                }
            }
        }
    }

    // Hi·ªÉn th·ªã k·∫øt qu·∫£
    const finalScore = totalScore.toFixed(2);
    let resultBox = document.getElementById('score-result');
    
    if (!resultBox) {
        resultBox = document.createElement('div');
        resultBox.id = 'score-result';
        resultBox.style.cssText = `
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            background: rgba(0,0,0,0.9); 
            color: #fff; 
            padding: 20px; 
            border-radius: 12px; 
            z-index: 99999; 
            font-size: 16px;
            max-width: 300px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 2px solid ${finalScore >= 5 ? '#28a745' : '#dc3545'};
        `;
        document.body.appendChild(resultBox);
    }
    
    const scoreColor = finalScore >= 8 ? '#28a745' : finalScore >= 5 ? '#ffc107' : '#dc3545';
    const scoreEmoji = finalScore >= 8 ? 'üèÜ' : finalScore >= 5 ? '‚úÖ' : '‚ùå';
    
    resultBox.innerHTML = `
        <div style="text-align: center; margin-bottom: 10px;">
            <div style="font-size: 2em;">${scoreEmoji}</div>
            <div style="font-size: 1.2em; font-weight: bold; color: ${scoreColor};">
                ${finalScore} / 10.00
            </div>
        </div>
        <div style="font-size: 0.9em; text-align: center;">
            ${finalScore >= 8 ? 'Xu·∫•t s·∫Øc! üéâ' : finalScore >= 5 ? 'ƒê·∫°t y√™u c·∫ßu! üëç' : 'C·∫ßn c·ªë g·∫Øng th√™m! üí™'}
        </div>
    `;

    // Ph√°t √¢m thanh v√† l∆∞u k·∫øt qu·∫£
    try { 
        playSound(finalScore >= 5 ? 'correct' : 'wrong'); 
    } catch(e){}
    
    if (currentUser && sessionCode && typeof saveAttempt === 'function') {
        await saveAttempt(document.title || 'de1', { studentAnswers, correctAnswers }, finalScore);
        resultBox.innerHTML += `
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3); font-size: 0.8em; text-align: center;">
                ‚úÖ K·∫øt qu·∫£ ƒë√£ l∆∞u v√†o h·ªá th·ªëng
            </div>
        `;
    } else {
        resultBox.innerHTML += `
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3); font-size: 0.8em; text-align: center;">
                ‚ÑπÔ∏è Ch∆∞a ƒëƒÉng nh·∫≠p ‚Äî k·∫øt qu·∫£ ch·ªâ hi·ªÉn th·ªã t·∫°m th·ªùi
            </div>
        `;
    }

    console.log('=== correctAnswers ===', correctAnswers);
    console.log('=== studentAnswers ===', studentAnswers);
    console.log('=== totalScore ===', finalScore);
    
    window.isScoreCalculated = true;
    
    // C·∫≠p nh·∫≠t tr·∫°ng th√°i ho√†n th√†nh
    if (currentUser && sessionCode) {
        await db.ref(`sessions/${sessionCode}/students/${currentUser.uid}`).update({
            score: parseFloat(finalScore),
            status: 'finished',
            finished: firebase.database.ServerValue.TIMESTAMP
        });
    }
};

window.toggleSolution = function(questionId) {
    const solution = document.getElementById('solution-' + questionId);
    solution.style.display = solution.style.display === 'none' ? 'block' : 'none';
}

// ===== THEO D√ïI H·ªåC SINH (Teacher Monitoring) =====
function startMonitoringSession() {
    if (!sessionCode) return;
    db.ref('sessions/' + sessionCode + '/students').on('value', snapshot => updateStudentMonitor(snapshot.val()));
    db.ref('sessions/' + sessionCode + '/interactions').on('child_added', snapshot => showInteractionAlert(snapshot.val()));
}

function updateStudentMonitor(students) {
    const tbody = document.getElementById('student-results-body');
    const stats = {
        total: document.getElementById('stats-total'),
        completed: document.getElementById('stats-completed'),
        average: document.getElementById('stats-average'),
        failed: document.getElementById('stats-failed')
    };
    const liveCount = document.getElementById('live-student-count');
    
    if (!students || Object.keys(students).length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px; color: #666;">Ch∆∞a c√≥ h·ªçc sinh n√†o tham gia.</td></tr>`;
        Object.values(stats).forEach(el => el.textContent = '0');
        liveCount.textContent = '0';
        return;
    }
    
    let html = '';
    let total = 0, completed = 0, totalScore = 0, failed = 0;
    
    Object.entries(students).forEach(([studentId, student]) => {
        total++;
        const studentScore = student.score || 0;
        if (student.status === 'finished') {
             completed++;
             totalScore += studentScore;
        }
        if (studentScore < 1) failed++; // Assuming passing score is 1 out of 2 for this demo
        
        const timeSpent = student.joined && student.finished ? calculateTimeSpent(student.joined, student.finished) : '--:--';
        
        // ===== S·ª¨A L·ªñI: HI·ªÇN TH·ªä TR·∫†NG TH√ÅI KH√îNG HO·∫†T ƒê·ªòNG =====
        let status = student.status || 'not-started';
        let statusText = getStatusText(status);
        
        // Ki·ªÉm tra n·∫øu h·ªçc sinh kh√¥ng ho·∫°t ƒë·ªông
        if (inactiveStudents.has(studentId)) {
            statusText = '‚ùå Kh√¥ng ho·∫°t ƒë·ªông';
        }
        
        html += `
            <tr>
                <td><strong>${student.name}</strong><br><small>${student.code}</small></td>
                <td style="text-align: center;"><span class="status-${status}">${statusText}</span></td>
                <td style="text-align: center; font-weight: bold;">${studentScore.toFixed(2)}</td>
                <td style="text-align: center;">${timeSpent}</td>
                <td style="text-align: center;">
                    <div style="background: #e0e0e0; border-radius: 5px; height: 8px;"><div style="background: linear-gradient(135deg, #1a237e, #3949ab); height: 100%; border-radius: 5px; width: ${student.progress || 0}%;"></div></div>
                    <small>${student.progress || 0}%</small>
                </td>
                <td style="text-align: center;"><button onclick="viewStudentDetail('${studentId}')" style="padding: 5px 10px; border: none; background: #17a2b8; color: white; border-radius: 5px; cursor: pointer;">üìä</button></td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    stats.total.textContent = total;
    stats.completed.textContent = completed;
    stats.average.textContent = completed > 0 ? (totalScore / completed).toFixed(1) : '0.0';
    stats.failed.textContent = failed;
    liveCount.textContent = total;
}

function getStatusText(status) {
    return { 'active': 'ƒêang l√†m', 'finished': 'ƒê√£ n·ªôp', 'not-started': 'Ch∆∞a b·∫Øt ƒë·∫ßu' }[status] || '...';
}

function calculateTimeSpent(startTime, endTime) {
    const diff = endTime - startTime;
    const minutes = Math.floor(diff / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);
    return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

function showInteractionAlert(interaction) {
    if (!isTeacherLoggedIn) return;
    
    let message = '';
    let type = 'warning';
    
    switch(interaction.type) {
        case 'hand_raised': 
            message = `‚úã ${interaction.student} ƒëang gi∆° tay!`;
            type = 'info';
            break;
        case 'question': 
            message = `‚ùì ${interaction.student}: ${interaction.content}`;
            type = 'warning';
            break;
        case 'need_help': 
            message = `üÜò ${interaction.student} c·∫ßn h·ªó tr·ª£ g·∫•p!`;
            type = 'error';
            break;
        default: return;
    }
    
    // Hi·ªÉn th·ªã notification
    showNotification(message, type);
    
    // N·∫øu ƒëang m·ªü modal qu·∫£n l√Ω l·ªõp, refresh t∆∞∆°ng t√°c
    if (document.getElementById('class-management-modal').classList.contains('active')) {
        setTimeout(viewClassInteractions, 1000);
    }
}

window.viewStudentDetail = function(studentId) {
    showNotification('T√≠nh nƒÉng xem chi ti·∫øt h·ªçc sinh ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.', 'info');
}

function updateStudentProgress(slideIndex) {
    if (!sessionCode || !currentUser || isTeacherLoggedIn) return;
    const totalSlides = document.querySelectorAll('.reveal .slides section').length;
    const progress = Math.round((slideIndex / (totalSlides - 1)) * 100);
    db.ref(`sessions/${sessionCode}/students/${currentUser.uid}`).update({
        currentSlide: slideIndex, progress, lastActivity: firebase.database.ServerValue.TIMESTAMP
    });
}

// ===== H·ªÜ TH·ªêNG KH·∫¢O S√ÅT (Poll System) =====
function setupPollSystem() {
    document.getElementById('poll-submit-btn').addEventListener('click', submitPollResponse);
}

function startPoll() {
    if (!isTeacherLoggedIn || !sessionCode) return showNotification('Vui l√≤ng ƒëƒÉng nh·∫≠p GV v√† t·∫°o l·ªõp', 'error');
    const question = prompt('Nh·∫≠p c√¢u h·ªèi kh·∫£o s√°t:');
    if (!question) return;
    const options = prompt('Nh·∫≠p c√°c l·ª±a ch·ªçn, c√°ch nhau b·ªüi d·∫•u ph·∫©y (vd: A,B,C):')?.split(',') || [];
    if (options.length < 2) return showNotification('C·∫ßn √≠t nh·∫•t 2 l·ª±a ch·ªçn!', 'error');

    // ƒê·ªîI T√äN: pollData -> sessionPollData
    const sessionPollData = {
        question, options: options.map(o => o.trim()), active: true,
        created: firebase.database.ServerValue.TIMESTAMP
    };
    db.ref('sessions/' + sessionCode + '/poll').set(sessionPollData)
        .then(() => showNotification('‚úÖ Kh·∫£o s√°t ƒë√£ b·∫Øt ƒë·∫ßu!', 'success'));
}

function showPoll(pollData) {
    document.getElementById('poll-title').textContent = pollData.question;
    const optionsDiv = document.getElementById('poll-options');
    optionsDiv.innerHTML = pollData.options.map((option, index) =>
        `<div class="poll-option" data-index="${index}">${String.fromCharCode(65 + index)}. ${option}</div>`
    ).join('');
    
    optionsDiv.querySelectorAll('.poll-option').forEach(el => {
        el.onclick = () => {
            optionsDiv.querySelectorAll('.poll-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
        };
    });
    showModal('poll-modal');
}

function hidePoll() {
    hideModal(document.getElementById('poll-modal'));
}

function submitPollResponse() {
    const selectedOption = document.querySelector('.poll-option.selected');
    if (!selectedOption) return showNotification('Vui l√≤ng ch·ªçn m·ªôt ph∆∞∆°ng √°n!', 'warning');
    if (!sessionCode || !currentUser) return showNotification('Vui l√≤ng ƒëƒÉng nh·∫≠p!', 'error');

    const responseIndex = parseInt(selectedOption.dataset.index);
    db.ref(`sessions/${sessionCode}/poll/responses/${currentUser.uid}`).set({
        name: currentUser.name, choice: responseIndex
    }).then(() => {
        showNotification('‚úÖ ƒê√£ g·ª≠i ph·∫£n h·ªìi!', 'success');
        hidePoll();
    });
}

async function viewPollResults() {
    if (!isTeacherLoggedIn || !sessionCode) return showNotification('Ch·ªâ d√†nh cho GV!', 'error');
    const snapshot = await db.ref('sessions/' + sessionCode + '/poll').once('value');
    const pollData = snapshot.val();
    if (!pollData) return showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu kh·∫£o s√°t!', 'warning');
    showPollResultsInMonitor(pollData);
}

function showPollResultsInMonitor(pollData) {
    const pollArea = document.getElementById('poll-results-area');
    const pollTitle = document.getElementById('poll-results-title');
    const pollStats = document.getElementById('poll-stats-in-monitor');
    
    pollTitle.textContent = `üìä K·∫øt qu·∫£ kh·∫£o s√°t: ${pollData.question}`;
    pollArea.style.display = 'block';
    
    const counts = new Array(pollData.options.length).fill(0);
    const responses = pollData.responses || {};
    Object.values(responses).forEach(res => { if (counts[res.choice] !== undefined) counts[res.choice]++; });

    const totalResponses = counts.reduce((a, b) => a + b, 0);
    pollStats.innerHTML = `<strong>T·ªïng s·ªë phi·∫øu:</strong> ${totalResponses}`;
    
    const ctx = document.getElementById('pollChartInMonitor').getContext('2d');
    if (window.pollChartInstance) window.pollChartInstance.destroy();
    
    window.pollChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: pollData.options,
            datasets: [{
                label: 'S·ªë phi·∫øu', data: counts,
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });
}

// ===== T∆Ø∆†NG T√ÅC H·ªåC SINH (Student Interaction) =====
function setupStudentInteraction() {
    document.getElementById('studentInteractBtn').addEventListener('click', () => {
        if (!currentUser || !sessionCode) return showNotification('Vui l√≤ng ƒëƒÉng nh·∫≠p v√† v√†o l·ªõp!', 'error');
        const choice = prompt(`Ch·ªçn t∆∞∆°ng t√°c:\n1-‚úã Gi∆° tay\n2-‚ùì ƒê·∫∑t c√¢u h·ªèi\n3-üÜò C·∫ßn h·ªó tr·ª£`);
        if (choice === '1') sendInteraction('hand_raised');
        else if (choice === '2') {
            const question = prompt('Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n:');
            if (question) sendInteraction('question', question);
        } else if (choice === '3') sendInteraction('need_help');
    });
}

function sendInteraction(type, content = '') {
    const interactionData = { student: currentUser.name, type, timestamp: firebase.database.ServerValue.TIMESTAMP };
    if (content) interactionData.content = content;
    db.ref('sessions/' + sessionCode + '/interactions').push(interactionData)
        .then(() => showNotification('‚úÖ ƒê√£ g·ª≠i t∆∞∆°ng t√°c!', 'success'));
}

// ===== T√çCH H·ª¢P: MENU SLIDE =====
function setupSlideMenu() {
    const slideMenu = document.getElementById('slideMenu');
    const slideMenuBtn = document.getElementById('slideMenuBtn');
    const closeSlideMenuBtn = document.getElementById('closeSlideMenu');
    const menuOverlay = document.getElementById('menuOverlay');
    
    function toggleSlideMenu() {
        slideMenu.classList.toggle('active');
        menuOverlay.classList.toggle('active');
    }
    slideMenuBtn.addEventListener('click', toggleSlideMenu);
    closeSlideMenuBtn.addEventListener('click', toggleSlideMenu);
    menuOverlay.addEventListener('click', toggleSlideMenu);
    
    createSlideList();
}


function createSlideList() {
    const slideList = document.getElementById('slideList');
    const slides = document.querySelectorAll('.reveal .slides section');
    slideList.innerHTML = Array.from(slides).map((slide, index) => {
        const title = slide.querySelector('h2')?.textContent.substring(0, 30) || `Slide ${index + 1}`;
        return `<div class="slide-item" data-slide-index="${index}">
                    <span class="slide-number">${index + 1}</span>${title}
                </div>`;
    }).join('');

    slideList.querySelectorAll('.slide-item').forEach(item => {
        item.addEventListener('click', () => {
            Reveal.slide(parseInt(item.dataset.slideIndex));
            document.getElementById('slideMenu').classList.remove('active');
            document.getElementById('menuOverlay').classList.remove('active');
        });
    });
    updateActiveSlideInMenu();
}

function updateActiveSlideInMenu() {
    const indices = Reveal.getIndices();
    if (!indices) return;
    const currentIndex = indices.h;
    document.querySelectorAll('.slide-item').forEach((item, index) => {
        item.classList.toggle('active', index === currentIndex);
    });
}

// ===== T√çCH H·ª¢P: B·∫¢NG V·∫º CANVAS =====
function setupCanvas() {
    const canvas = document.getElementById("drawCanvas");
    const ctx = canvas.getContext("2d");
    const toggleBtn = document.getElementById("toggleMenu");
    const toolbar = document.getElementById("drawToolbar");
    const exitBtn = document.getElementById("exitBtn");

    let isDrawMode = false;
    let isDrawing = false;
    let history = [];
    let currentTool = "pen";
    let startX, startY, lastX, lastY;
    let imageBeforeShape;

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        ctx.lineJoin = "round";
        ctx.lineCap = "round";
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    toggleBtn.onclick = () => {
        isDrawMode = !isDrawMode;
        canvas.style.display = isDrawMode ? "block" : "none";
        toolbar.style.display = isDrawMode ? "flex" : "none";
        canvas.style.pointerEvents = isDrawMode ? "auto" : "none";

    };
    exitBtn.onclick = toggleBtn.onclick;

    document.getElementById("tool").onchange = e => currentTool = e.target.value;
    document.getElementById("clearBtn").onclick = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        history = [];
    };
    document.getElementById("saveBtn").onclick = () => {
        const link = document.createElement("a");
        link.download = "ban_ve.png";
        link.href = canvas.toDataURL();
        link.click();
    };
    document.getElementById("undoBtn").onclick = () => {
        if (history.length > 0) ctx.putImageData(history.pop(), 0, 0);
    };

    const getPos = e => {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches && e.touches[0];
        const clientX = touch ? touch.clientX : e.clientX;
        const clientY = touch ? touch.clientY : e.clientY;
        return { x: (clientX - rect.left) * (canvas.width / rect.width), 
                 y: (clientY - rect.top) * (canvas.height / rect.height) };
    };

    const startDraw = e => {
        if (!isDrawMode) return;
        e.preventDefault();
        history.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
        isDrawing = true;
        const pos = getPos(e);
        startX = lastX = pos.x;
        startY = lastY = pos.y;
        if (currentTool !== 'pen') {
            imageBeforeShape = ctx.getImageData(0, 0, canvas.width, canvas.height);
        }
        ctx.beginPath();
    };

    const drawMove = e => {
        if (!isDrawing || !isDrawMode) return;
        e.preventDefault();
        ctx.strokeStyle = document.getElementById("colorPicker").value;
        ctx.lineWidth = document.getElementById("draw-width").value;
        const pos = getPos(e);
        
        if (currentTool !== "pen" && imageBeforeShape) {
            ctx.putImageData(imageBeforeShape, 0, 0);
        }

        ctx.beginPath();
        switch (currentTool) {
            case "pen":
                ctx.moveTo(lastX, lastY); ctx.lineTo(pos.x, pos.y); ctx.stroke();
                [lastX, lastY] = [pos.x, pos.y];
                break;
            case "line":
                ctx.moveTo(startX, startY); ctx.lineTo(pos.x, pos.y); ctx.stroke();
                break;
            case "dashedLineBtn":
                ctx.setLineDash([8, 6]); ctx.moveTo(startX, startY); ctx.lineTo(pos.x, pos.y); ctx.stroke(); ctx.setLineDash([]);
                break;
            case "rect":
                ctx.strokeRect(startX, startY, pos.x - startX, pos.y - startY);
                break;
            case "circle":
                ctx.arc(startX, startY, Math.hypot(pos.x - startX, pos.y - startY), 0, Math.PI * 2); ctx.stroke();
                break;
            case "ellipseBtn":
                ctx.ellipse(startX, startY, Math.abs(pos.x - startX), Math.abs(pos.y - startY), 0, 0, Math.PI * 2); ctx.stroke();
                break;
             case "parallelogram":
                const width_p = pos.x - startX, height_p = pos.y - startY, offset_p = width_p * 0.3;
                ctx.moveTo(startX + offset_p, startY); ctx.lineTo(startX + width_p + offset_p, startY);
                ctx.lineTo(startX + width_p - offset_p, startY + height_p); ctx.lineTo(startX - offset_p, startY + height_p);
                ctx.closePath(); ctx.stroke();
                break;
            case "box":
                const w = pos.x - startX, h = pos.y - startY, d = Math.min(Math.abs(w), Math.abs(h)) * 0.4;
                ctx.strokeRect(startX, startY, w, h); ctx.strokeRect(startX + d, startY - d, w, h);
                [[startX, startY, startX + d, startY - d], [startX + w, startY, startX + w + d, startY - d],
                 [startX, startY + h, startX + d, startY + h - d], [startX + w, startY + h, startX + w + d, startY + h - d]].forEach(c => {
                    ctx.moveTo(c[0], c[1]); ctx.lineTo(c[2], c[3]);
                });
                ctx.stroke();
                break;
            case "pyramid3":
                const baseLeft = { x: startX, y: pos.y }; const baseRight = { x: pos.x, y: pos.y };
                const apex = { x: (startX + pos.x) / 2, y: startY };
                ctx.moveTo(apex.x, apex.y); ctx.lineTo(baseLeft.x, baseLeft.y); ctx.lineTo(baseRight.x, baseRight.y); ctx.closePath(); ctx.stroke();
                break;
            case "pyramid4":
                 const w4 = pos.x - startX, h4 = pos.y - startY;
                 const apex4 = {x: startX + w4 / 2, y: startY - h4 };
                 ctx.strokeRect(startX, startY, w4, h4);
                 [[startX, startY], [startX+w4, startY], [startX, startY+h4], [startX+w4, startY+h4]].forEach(([bx,by])=>{
                    ctx.moveTo(apex4.x, apex4.y); ctx.lineTo(bx,by);
                 });
                 ctx.stroke();
                break;
            case "sphere":
                const rs = Math.abs(pos.x-startX);
                ctx.arc(startX, startY, rs, 0, Math.PI * 2); ctx.stroke();
                ctx.beginPath(); ctx.setLineDash([6,4]);
                ctx.ellipse(startX, startY, rs, rs / 2.5, 0, 0, Math.PI*2); ctx.stroke();
                ctx.setLineDash([]);
                break;
        }
    };

    const endDraw = () => { if(isDrawing) { isDrawing = false; ctx.beginPath();} };

    canvas.addEventListener("mousedown", startDraw);
    canvas.addEventListener("mousemove", drawMove);
    canvas.addEventListener("mouseup", endDraw);
    canvas.addEventListener("mouseleave", endDraw);
    canvas.addEventListener("touchstart", startDraw, { passive: false });
    canvas.addEventListener("touchmove", drawMove, { passive: false });
    canvas.addEventListener("touchend", endDraw);
}


// C·∫≠p nh·∫≠t s·ª± ki·ªán click cho n√∫t t√≠nh ƒëi·ªÉm
document.addEventListener('DOMContentLoaded', function() {
    const scoreBtn = document.getElementById('scoreBtn');
    if (scoreBtn) {
        scoreBtn.addEventListener('click', () => {
            // Reset flag ƒë·ªÉ cho ph√©p t√≠nh l·∫°i
            window.isScoreCalculated = false;
            window.calculateFinalScore();
        });
    }
});

// H√†m h·ªó tr·ª£ th·ªëng k√™
function updateStatistics(total, completed, totalScore) {
    document.getElementById('stats-total').textContent = total;
    document.getElementById('stats-completed').textContent = completed;
    document.getElementById('stats-average').textContent = completed > 0 ? (totalScore / completed).toFixed(1) : '0.0';
    document.getElementById('stats-failed').textContent = total - completed;
}

function getStatusBadge(status) {
    const badges = {
        'active': '<span class="status-active">üü¢ ƒêang l√†m</span>',
        'finished': '<span class="status-finished">‚úÖ ƒê√£ n·ªôp</span>', 
        'not-started': '<span class="status-not-started">‚è≥ Ch∆∞a b·∫Øt ƒë·∫ßu</span>'
    };
    return badges[status] || '<span class="status-not-started">‚ùì Kh√¥ng x√°c ƒë·ªãnh</span>';
}

// ===== S·ª¨A L·ªñI: TH√äM C√ÅC H√ÄM B·ªä THI·∫æU =====

// H√†m t·∫£i danh s√°ch h·ªçc sinh
async function loadStudentsList() {
    try {
        const searchTerm = document.getElementById('search-student-global').value.toLowerCase();
        const selectedClass = document.getElementById('filter-class').value;
        
        // L·∫§Y D·ªÆ LI·ªÜU ƒê·ªíNG B·ªò T·ª™ 3 NGU·ªíN
        const [studentCodesSnapshot, usersSnapshot, attemptsSnapshot] = await Promise.all([
            db.ref('studentCodes').once('value'),
            db.ref('users').once('value'),
            db.ref('attempts').once('value')
        ]);
        
        const studentCodes = studentCodesSnapshot.val() || {};
        const allUsers = usersSnapshot.val() || {};
        const allAttempts = attemptsSnapshot.val() || {};
        
        const tbody = document.getElementById('students-list-body');
        let html = '';
        let studentCount = 0;

        // T·∫†O MAP ƒê·ªíNG B·ªò H√ìA D·ªÆ LI·ªÜU
        const synchronizedStudents = new Map();

        // 1. D·ªÆ LI·ªÜU T·ª™ STUDENTCODES (ngu·ªìn ch√≠nh)
        Object.entries(studentCodes).forEach(([code, codeData]) => {
            if (codeData.teacherId !== currentUser.uid) return;
            
            const studentId = `student_${code}`;
            synchronizedStudents.set(code, {
                code: code,
                name: codeData.name,
                classCode: codeData.classCode,
                className: codeData.className || 'Ch∆∞a c√≥ l·ªõp',
                status: codeData.status || 'active',
                createdAt: codeData.createdAt,
                lastLogin: null,
                attempts: [],
                totalScore: 0
            });
        });

        // 2. B·ªî SUNG T·ª™ USERS (th√¥ng tin ƒëƒÉng nh·∫≠p)
        Object.entries(allUsers).forEach(([userId, userData]) => {
            if (userData.role === 'student' && userData.code) {
                const code = userData.code;
                if (synchronizedStudents.has(code)) {
                    // C·∫≠p nh·∫≠t th√¥ng tin t·ª´ user
                    const student = synchronizedStudents.get(code);
                    student.lastLogin = userData.lastLogin;
                    student.status = userData.status || student.status;
                } else {
                    // Th√™m h·ªçc sinh m·ªõi t·ª´ users
                    synchronizedStudents.set(code, {
                        code: code,
                        name: userData.name,
                        classCode: userData.classCode || 'Ch∆∞a c√≥ l·ªõp',
                        className: userData.className || 'Ch∆∞a c√≥ l·ªõp',
                        status: userData.status || 'active',
                        createdAt: userData.createdAt,
                        lastLogin: userData.lastLogin,
                        attempts: [],
                        totalScore: 0
                    });
                }
            }
        });

        // 3. B·ªî SUNG TH·ªêNG K√ä T·ª™ ATTEMPTS
        Object.values(allAttempts).forEach(sessionAttempts => {
            Object.entries(sessionAttempts).forEach(([studentId, attempt]) => {
                const code = attempt.code;
                if (synchronizedStudents.has(code)) {
                    const student = synchronizedStudents.get(code);
                    student.attempts.push(attempt);
                    student.totalScore += parseFloat(attempt.score) || 0;
                    
                    // C·∫≠p nh·∫≠t th·ªùi gian ho·∫°t ƒë·ªông
                    if (attempt.createdAt > (student.lastActivity || 0)) {
                        student.lastActivity = attempt.createdAt;
                    }
                }
            });
        });

        // HI·ªÇN TH·ªä DANH S√ÅCH ƒê√É ƒê·ªíNG B·ªò
        synchronizedStudents.forEach((student, code) => {
            // L·ªçc theo t√¨m ki·∫øm
            if (searchTerm && 
                !student.name.toLowerCase().includes(searchTerm) && 
                !student.code.toLowerCase().includes(searchTerm)) {
                return;
            }
            
            // L·ªçc theo l·ªõp
            if (selectedClass !== 'all' && student.classCode !== selectedClass) {
                return;
            }
            
            studentCount++;
            
            const attemptCount = student.attempts.length;
            const avgScore = attemptCount > 0 ? (student.totalScore / attemptCount).toFixed(2) : '0.00';
            const lastActivity = student.lastActivity ? getTimeAgo(student.lastActivity) : 
                              student.lastLogin ? getTimeAgo(student.lastLogin) : 'Ch∆∞a ho·∫°t ƒë·ªông';
            
            html += `
                <tr>
                    <td><strong>${student.code}</strong></td>
                    <td>${student.name}</td>
                    <td>
                        ${student.classCode}
                        ${student.className !== 'Ch∆∞a c√≥ l·ªõp' ? `<br><small style="color: #666;">${student.className}</small>` : ''}
                    </td>
                    <td>${lastActivity}</td>
                    <td style="text-align: center;">
                        <span style="font-weight: bold; color: #1a237e;">${attemptCount}</span>
                    </td>
                    <td style="text-align: center;">
                        <span style="font-weight: bold; color: ${getScoreColor(parseFloat(avgScore))}">
                            ${avgScore}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <button onclick="viewStudentProfile('${code}')" style="padding: 6px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin: 2px;">
                            üìä
                        </button>
                        <button onclick="editStudent('${code}')" style="padding: 6px 12px; background: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin: 2px;">
                            ‚úèÔ∏è
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html || `
            <tr>
                <td colspan="7" style="text-align: center; padding: 30px; color: #666;">
                    Kh√¥ng t√¨m th·∫•y h·ªçc sinh n√†o.
                </td>
            </tr>
        `;
        
    } catch (error) {
        console.error('L·ªói t·∫£i danh s√°ch h·ªçc sinh:', error);
        document.getElementById('students-list-body').innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 30px; color: #dc3545;">
                    ‚ùå L·ªói khi t·∫£i danh s√°ch h·ªçc sinh
                </td>
            </tr>
        `;
    }
}
// H√†m ch·ªânh s·ª≠a th√¥ng tin h·ªçc sinh
async function editStudent(studentCode) {
    try {
        const snapshot = await db.ref(`studentCodes/${studentCode}`).once('value');
        const studentData = snapshot.val();
        
        if (!studentData) {
            showNotification('Kh√¥ng t√¨m th·∫•y h·ªçc sinh!', 'error');
            return;
        }

        const newName = prompt('Nh·∫≠p t√™n m·ªõi cho h·ªçc sinh:', studentData.name);
        if (!newName || newName.trim() === '') return;

        const newClassCode = prompt('Nh·∫≠p m√£ l·ªõp m·ªõi:', studentData.classCode);
        if (!newClassCode) return;

        // C·∫¨P NH·∫¨T TRONG STUDENTCODES
        await db.ref(`studentCodes/${studentCode}`).update({
            name: newName.trim(),
            classCode: newClassCode,
            className: await getClassName(newClassCode)
        });

        // C·∫¨P NH·∫¨T TRONG USERS (n·∫øu c√≥)
        const userId = `student_${studentCode}`;
        await db.ref(`users/${userId}`).update({
            name: newName.trim(),
            classCode: newClassCode
        });

        // C·∫¨P NH·∫¨T S·ªê L∆Ø·ª¢NG H·ªåC SINH
        await updateStudentCountInClass(studentData.classCode); // L·ªõp c≈©
        await updateStudentCountInClass(newClassCode); // L·ªõp m·ªõi

        showNotification(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin h·ªçc sinh ${studentCode}`, 'success');
        loadStudentsList();
        
    } catch (error) {
        console.error('L·ªói ch·ªânh s·ª≠a h·ªçc sinh:', error);
        showNotification('‚ùå L·ªói khi c·∫≠p nh·∫≠t th√¥ng tin h·ªçc sinh!', 'error');
    }
}
async function removeStudent(code) {
    try {
        // 1. L·∫•y th√¥ng tin l·ªõp c·ªßa h·ªçc sinh
        const snapshot = await db.ref(`studentCodes/${code}`).once('value');
        const studentData = snapshot.val();
        const classCode = studentData?.classCode;

        // 2. X√≥a trong studentCodes
        await db.ref(`studentCodes/${code}`).remove();

        // 3. X√≥a trong users
        const userId = `student_${code}`;
        await db.ref(`users/${userId}`).remove();

        // 4. C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng h·ªçc sinh trong l·ªõp
        if (classCode) {
            await updateStudentCountInClass(classCode);
        }

        showNotification('‚úÖ ƒê√£ x√≥a h·ªçc sinh th√†nh c√¥ng!', 'success');
        loadStudentsList();
        loadStudentCodesList();
        
    } catch (error) {
        console.error('L·ªói x√≥a h·ªçc sinh:', error);
        showNotification('‚ùå L·ªói khi x√≥a h·ªçc sinh!', 'error');
    }
}
// H√†m c·∫≠p nh·∫≠t dropdown l·ªçc l·ªõp
function updateClassFilter(classes) {
    const filterSelect = document.getElementById('filter-class');
    let options = '<option value="all">T·∫•t c·∫£ l·ªõp</option>';
    
    Object.entries(classes).forEach(([classCode, classData]) => {
        if (classData.teacherId === currentUser.uid) {
            options += `<option value="${classCode}">${classData.name} (${classCode})</option>`;
        }
    });
    
    filterSelect.innerHTML = options;
}

// H√†m xem chi ti·∫øt l·ªõp
async function viewClassDetails(classCode) {
    try {
        const snapshot = await db.ref(`classes/${classCode}`).once('value');
        const classData = snapshot.val();
        
        if (!classData) {
            showNotification('Kh√¥ng t√¨m th·∫•y th√¥ng tin l·ªõp!', 'error');
            return;
        }
        
        const message = `
            üè´ <b>${classData.name}</b>
            üìã M√£ l·ªõp: <code>${classCode}</code>
            üë®‚Äçüè´ Gi√°o vi√™n: ${classData.teacher}
            üë• S·ªë h·ªçc sinh: ${classData.studentCount || 0}
            ${classData.description ? `üìù M√¥ t·∫£: ${classData.description}` : ''}
        `;
        
        showNotification(message, 'info');
        
    } catch (error) {
        console.error('L·ªói xem chi ti·∫øt l·ªõp:', error);
        showNotification('‚ùå L·ªói khi t·∫£i th√¥ng tin l·ªõp!', 'error');
    }
}

// H√†m xem h·ªì s∆° h·ªçc sinh
async function viewStudentProfile(studentId) {
    try {
        // L·∫•y th√¥ng tin h·ªçc sinh
        const userSnapshot = await db.ref(`users/${studentId}`).once('value');
        const userData = userSnapshot.val();
        
        // L·∫•y l·ªãch s·ª≠ l√†m b√†i
        const attemptsSnapshot = await db.ref('attempts').once('value');
        const allAttempts = attemptsSnapshot.val() || {};
        
        let studentAttempts = [];
        Object.values(allAttempts).forEach(sessionAttempts => {
            if (sessionAttempts[studentId]) {
                studentAttempts.push(sessionAttempts[studentId]);
            }
        });
        
        // T√≠nh th·ªëng k√™
        const totalAttempts = studentAttempts.length;
        const totalScore = studentAttempts.reduce((sum, attempt) => sum + parseFloat(attempt.score || 0), 0);
        const avgScore = totalAttempts > 0 ? (totalScore / totalAttempts).toFixed(2) : '0.00';
        const bestScore = Math.max(...studentAttempts.map(a => parseFloat(a.score || 0)));
        const lastAttempt = studentAttempts.length > 0 ? 
            new Date(studentAttempts[studentAttempts.length - 1].createdAt).toLocaleDateString('vi-VN') : 'Ch∆∞a c√≥';
        
        const message = `
            üë§ <b>H·ªì s∆° H·ªçc sinh</b>
            üìõ T√™n: ${userData?.name || 'N/A'}
            üÜî M√£: ${userData?.code || 'N/A'}
            
            üìä <b>Th·ªëng k√™:</b>
            üìù T·ªïng b√†i l√†m: ${totalAttempts}
            üéØ ƒêi·ªÉm trung b√¨nh: ${avgScore}
            üèÜ ƒêi·ªÉm cao nh·∫•t: ${bestScore.toFixed(2)}
            ‚è∞ L·∫ßn cu·ªëi l√†m b√†i: ${lastAttempt}
            
            üí° Nh·∫•n "Theo d√µi HS" ƒë·ªÉ xem chi ti·∫øt real-time.
        `;
        
        showNotification(message, 'info');
        
    } catch (error) {
        console.error('L·ªói xem h·ªì s∆° h·ªçc sinh:', error);
        showNotification('‚ùå L·ªói khi t·∫£i th√¥ng tin h·ªçc sinh!', 'error');
    }
}

// H√†m h·ªó tr·ª£ cho ƒëi·ªÉm s·ªë
function getScoreColor(score) {
    if (score >= 8) return '#28a745';
    if (score >= 5) return '#ffc107';
    return '#dc3545';
}

// H√†m thu h·ªìi m√£ h·ªçc sinh
async function revokeStudentCode(codeId) {
    try {
        await db.ref(`studentCodes/${codeId}/status`).set('revoked');
        showNotification(`‚úÖ ƒê√£ thu h·ªìi m√£ ${codeId}!`, 'success');
        loadStudentCodesList();
    } catch (error) {
        console.error('L·ªói thu h·ªìi m√£ h·ªçc sinh:', error);
        showNotification('‚ùå L·ªói khi thu h·ªìi m√£!', 'error');
    }
}

// H√†m xu·∫•t Excel (placeholder)
document.getElementById('export-codes-btn').addEventListener('click', function() {
    showNotification('T√≠nh nƒÉng xu·∫•t Excel ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!', 'info');
});

// H√†m x·ª≠ l√Ω s·ª± ki·ªán cho c√°c n√∫t modal c√≤n thi·∫øu
document.getElementById('cancel-create-class-btn').addEventListener('click', function() {
    hideModal(document.getElementById('create-class-modal'));
});

// Kh·ªüi t·∫°o c√°c event listeners c√≤n thi·∫øu
document.addEventListener('DOMContentLoaded', function() {
    // Th√™m event listener cho n√∫t refresh classes
    document.getElementById('refresh-classes-btn').addEventListener('click', function() {
        loadClassesList();
        loadStudentsList();
    });
    
    // Th√™m event listener cho search student
    document.getElementById('search-student-global').addEventListener('input', loadStudentsList);
    document.getElementById('filter-class').addEventListener('change', loadStudentsList);
});
// ===== T√çCH H·ª¢P POLL V√Ä ƒê·ªíNG B·ªò SLIDE V√ÄO QU·∫¢N L√ù L·ªöP =====
async function startClassPoll() {
    if (!isTeacherLoggedIn) {
        showNotification('Ch·ªâ gi√°o vi√™n m·ªõi c√≥ quy·ªÅn t·∫°o poll!', 'error');
        return;
    }

    // Hi·ªÉn th·ªã modal ch·ªçn l·ªõp
    const classSelectModal = `
        <div style="padding: 20px;">
            <h4 style="color: #1a237e; margin-bottom: 15px;">üó≥Ô∏è Ch·ªçn l·ªõp ƒë·ªÉ t·∫°o Poll</h4>
            <select id="select-class-for-poll" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px;">
                <option value="">-- Ch·ªçn l·ªõp --</option>
            </select>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="createPollForSelectedClass()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    T·∫°o Poll
                </button>
                <button onclick="hideModal(this.closest('.modal'))" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    H·ªßy
                </button>
            </div>
        </div>
    `;

    showCustomModal('Ch·ªçn l·ªõp cho Poll', classSelectModal);
    await loadClassesForPoll();
}

async function loadClassesForPoll() {
    try {
        const snapshot = await db.ref('classes').once('value');
        const classes = snapshot.val() || {};
        const select = document.getElementById('select-class-for-poll');
        
        let options = '<option value="">-- Ch·ªçn l·ªõp --</option>';
        
        Object.entries(classes).forEach(([classCode, classData]) => {
            if (classData.teacherId === currentUser.uid) {
                options += `<option value="${classCode}">${classData.name} (${classCode})</option>`;
            }
        });
        
        select.innerHTML = options;
    } catch (error) {
        console.error('L·ªói t·∫£i danh s√°ch l·ªõp:', error);
    }
}

async function createPollForSelectedClass() {
    const classCode = document.getElementById('select-class-for-poll').value;
    if (!classCode) {
        showNotification('Vui l√≤ng ch·ªçn l·ªõp!', 'error');
        return;
    }

    const question = prompt('Nh·∫≠p c√¢u h·ªèi kh·∫£o s√°t:');
    if (!question) return;
    
    const options = prompt('Nh·∫≠p c√°c l·ª±a ch·ªçn, c√°ch nhau b·ªüi d·∫•u ph·∫©y (vd: A,B,C):')?.split(',') || [];
    if (options.length < 2) {
        showNotification('C·∫ßn √≠t nh·∫•t 2 l·ª±a ch·ªçn!', 'error');
        return;
    }

    // ƒê·ªîI T√äN: pollData -> classPollData
    const classPollData = {
        question, 
        options: options.map(o => o.trim()), 
        active: true,
        created: firebase.database.ServerValue.TIMESTAMP,
        classCode: classCode,
        responses: {} // L∆∞u tr·ªØ ph·∫£n h·ªìi
    };

    try {
        await db.ref(`classes/${classCode}/poll`).set(classPollData);
        showNotification(`‚úÖ ƒê√£ t·∫°o poll cho l·ªõp ${classCode}`, 'success');
        hideAllModals();
    } catch (error) {
        console.error('L·ªói t·∫°o poll:', error);
        showNotification('‚ùå L·ªói khi t·∫°o poll!', 'error');
    }
}
async function syncClassSlides() {
    if (!isTeacherLoggedIn) {
        showNotification('Ch·ªâ gi√°o vi√™n m·ªõi c√≥ quy·ªÅn ƒë·ªìng b·ªô slide!', 'error');
        return;
    }

    // Hi·ªÉn th·ªã modal ch·ªçn l·ªõp
    const classSelectModal = `
        <div style="padding: 20px;">
            <h4 style="color: #1a237e; margin-bottom: 15px;">üîÑ Ch·ªçn l·ªõp ƒë·ªÉ ƒë·ªìng b·ªô Slide</h4>
            <select id="select-class-for-sync" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px;">
                <option value="">-- Ch·ªçn l·ªõp --</option>
            </select>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="syncSlidesToSelectedClass()" style="padding: 10px 20px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    ƒê·ªìng b·ªô
                </button>
                <button onclick="hideModal(this.closest('.modal'))" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    H·ªßy
                </button>
            </div>
        </div>
    `;

    showCustomModal('Ch·ªçn l·ªõp ƒë·ªìng b·ªô', classSelectModal);
    await loadClassesForSync();
}

async function loadClassesForSync() {
    try {
        const snapshot = await db.ref('classes').once('value');
        const classes = snapshot.val() || {};
        const select = document.getElementById('select-class-for-sync');
        
        let options = '<option value="">-- Ch·ªçn l·ªõp --</option>';
        
        Object.entries(classes).forEach(([classCode, classData]) => {
            if (classData.teacherId === currentUser.uid) {
                options += `<option value="${classCode}">${classData.name} (${classCode})</option>`;
            }
        });
        
        select.innerHTML = options;
    } catch (error) {
        console.error('L·ªói t·∫£i danh s√°ch l·ªõp:', error);
    }
}

async function syncSlidesToSelectedClass() {
    const classCode = document.getElementById('select-class-for-sync').value;
    if (!classCode) {
        showNotification('Vui l√≤ng ch·ªçn l·ªõp!', 'error');
        return;
    }

    const slideIndex = Reveal.getIndices().h;
    
    try {
        // ƒê·ªìng b·ªô slide ƒë·∫øn l·ªõp ƒë∆∞·ª£c ch·ªçn
        await db.ref(`classes/${classCode}/currentSlide`).set(slideIndex);
        showNotification(`‚úÖ ƒê√£ ƒë·ªìng b·ªô slide ${slideIndex + 1} ƒë·∫øn l·ªõp ${classCode}`, 'success');
        hideAllModals();
    } catch (error) {
        console.error('L·ªói ƒë·ªìng b·ªô slide:', error);
        showNotification('‚ùå L·ªói khi ƒë·ªìng b·ªô slide!', 'error');
    }
}

// H√†m hi·ªÉn th·ªã modal t√πy ch·ªânh
function showCustomModal(title, content) {
    let modal = document.getElementById('custom-class-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'custom-class-modal';
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 500px;">
                <button class="modal-close" onclick="hideModal(this.closest('.modal'))">√ó</button>
                <div id="custom-class-content"></div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    document.getElementById('custom-class-content').innerHTML = content;
    // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ n·∫øu c√≥
    const header = document.querySelector('#custom-class-modal .modal-content h3');
    if (header) {
        header.textContent = title;
    }
    
    showModal('custom-class-modal');
}
// ===== XEM K·∫æT QU·∫¢ POLL C·ª¶A C√ÅC L·ªöP =====
async function viewClassPollResults() {
    if (!isTeacherLoggedIn) {
        showNotification('Ch·ªâ gi√°o vi√™n m·ªõi c√≥ quy·ªÅn xem k·∫øt qu·∫£ poll!', 'error');
        return;
    }

    try {
        // L·∫•y t·∫•t c·∫£ l·ªõp c·ªßa gi√°o vi√™n
        const classesSnapshot = await db.ref('classes').once('value');
        const classes = classesSnapshot.val() || {};
        
        let classesWithPolls = [];
        
        // Ki·ªÉm tra l·ªõp n√†o c√≥ poll
        Object.entries(classes).forEach(([classCode, classData]) => {
            if (classData.teacherId === currentUser.uid && classData.poll) {
                classesWithPolls.push({
                    classCode,
                    className: classData.name,
                    poll: classData.poll
                });
            }
        });
        
        if (classesWithPolls.length === 0) {
            showNotification('Kh√¥ng c√≥ l·ªõp n√†o c√≥ poll!', 'info');
            return;
        }
        
        // Hi·ªÉn th·ªã modal ch·ªçn l·ªõp c√≥ poll
        showPollResultsSelectionModal(classesWithPolls);
        
    } catch (error) {
        console.error('L·ªói t·∫£i k·∫øt qu·∫£ poll:', error);
        showNotification('‚ùå L·ªói khi t·∫£i k·∫øt qu·∫£ poll!', 'error');
    }
}

function showPollResultsSelectionModal(classesWithPolls) {
    let optionsHTML = '';
    
    classesWithPolls.forEach((classData, index) => {
        const poll = classData.poll;
        const responseCount = poll.responses ? Object.keys(poll.responses).length : 0;
        
        optionsHTML += `
            <div class="poll-class-item" style="padding: 15px; margin: 10px 0; background: #f8f9fa; border-radius: 10px; cursor: pointer; border: 2px solid #e9ecef; transition: all 0.3s ease;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${classData.className}</strong><br>
                        <small>M√£ l·ªõp: ${classData.classCode}</small>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: bold; color: #1a237e;">${responseCount} phi·∫øu</div>
                        <small>${poll.question.substring(0, 30)}...</small>
                    </div>
                </div>
            </div>
        `;
    });
    
    const modalContent = `
        <div style="padding: 20px;">
            <h4 style="color: #1a237e; margin-bottom: 15px;">üìä Ch·ªçn poll ƒë·ªÉ xem k·∫øt qu·∫£</h4>
            <div id="poll-classes-list">
                ${optionsHTML}
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="hideModal(this.closest('.modal'))" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    ƒê√≥ng
                </button>
            </div>
        </div>
    `;
    
    showCustomModal('K·∫øt qu·∫£ Kh·∫£o s√°t', modalContent);
    
    // Th√™m event listeners cho c√°c item
    setTimeout(() => {
        document.querySelectorAll('.poll-class-item').forEach((item, index) => {
            item.addEventListener('click', () => {
                showPollResultsDetailed(classesWithPolls[index]);
            });
        });
    }, 100);
}

async function showPollResultsDetailed(classData) {
    try {
        // L·∫•y d·ªØ li·ªáu poll m·ªõi nh·∫•t
        const pollSnapshot = await db.ref(`classes/${classData.classCode}/poll`).once('value');
        const poll = pollSnapshot.val();
        
        if (!poll) {
            showNotification('Poll kh√¥ng t·ªìn t·∫°i!', 'error');
            return;
        }
        
        const responses = poll.responses || {};
        const counts = new Array(poll.options.length).fill(0);
        const studentResponses = [];
        
        // ƒê·∫øm phi·∫øu b·∫ßu
        Object.values(responses).forEach(response => {
            if (counts[response.choice] !== undefined) {
                counts[response.choice]++;
            }
            studentResponses.push({
                name: response.name,
                choice: poll.options[response.choice],
                choiceIndex: response.choice
            });
        });
        
        const totalResponses = counts.reduce((a, b) => a + b, 0);
        
        // T·∫°o bi·ªÉu ƒë·ªì
        const chartHTML = createPollChartHTML(poll, counts, totalResponses);
        
        // T·∫°o b·∫£ng chi ti·∫øt
        const tableHTML = createPollTableHTML(studentResponses, poll.options);
        
        const modalContent = `
            <div style="padding: 20px; max-width: 800px;">
                <h4 style="color: #1a237e; margin-bottom: 10px;">üìä ${poll.question}</h4>
                <p style="color: #666; margin-bottom: 20px;">
                    L·ªõp: <strong>${classData.className}</strong> (${classData.classCode}) | 
                    T·ªïng phi·∫øu: <strong>${totalResponses}</strong>
                </p>
                
                ${chartHTML}
                
                <div style="margin-top: 30px;">
                    <h5 style="color: #1a237e; margin-bottom: 15px;">üìã Chi ti·∫øt phi·∫øu b·∫ßu</h5>
                    ${tableHTML}
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="hideModal(this.closest('.modal'))" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        ƒê√≥ng
                    </button>
                </div>
            </div>
        `;
        
        showCustomModal('K·∫øt qu·∫£ Chi ti·∫øt', modalContent);
        
    } catch (error) {
        console.error('L·ªói hi·ªÉn th·ªã k·∫øt qu·∫£ chi ti·∫øt:', error);
        showNotification('‚ùå L·ªói khi t·∫£i k·∫øt qu·∫£ chi ti·∫øt!', 'error');
    }
}

function createPollChartHTML(poll, counts, totalResponses) {
    let chartHTML = '<div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">';
    
    poll.options.forEach((option, index) => {
        const percentage = totalResponses > 0 ? ((counts[index] / totalResponses) * 100).toFixed(1) : 0;
        const width = totalResponses > 0 ? (counts[index] / totalResponses) * 100 : 0;
        
        chartHTML += `
            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: between; margin-bottom: 5px;">
                    <span style="flex: 1;"><strong>${String.fromCharCode(65 + index)}.</strong> ${option}</span>
                    <span style="font-weight: bold; color: #1a237e;">${counts[index]} phi·∫øu (${percentage}%)</span>
                </div>
                <div style="background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden;">
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); height: 100%; width: ${width}%; border-radius: 10px; transition: width 0.5s ease;"></div>
                </div>
            </div>
        `;
    });
    
    chartHTML += '</div>';
    return chartHTML;
}

function createPollTableHTML(studentResponses, options) {
    if (studentResponses.length === 0) {
        return '<p style="text-align: center; color: #666; padding: 20px;">Ch∆∞a c√≥ phi·∫øu b·∫ßu n√†o</p>';
    }
    
    let tableHTML = `
        <div class="table-container" style="max-height: 300px;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="padding: 12px; background: #1a237e; color: white; text-align: left;">H·ªçc sinh</th>
                        <th style="padding: 12px; background: #1a237e; color: white; text-align: left;">L·ª±a ch·ªçn</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    studentResponses.forEach(response => {
        tableHTML += `
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid #e0e0e0;">${response.name}</td>
                <td style="padding: 10px; border-bottom: 1px solid #e0e0e0;">
                    <strong>${String.fromCharCode(65 + response.choiceIndex)}.</strong> ${response.choice}
                </td>
            </tr>
        `;
    });
    
    tableHTML += `
                </tbody>
            </table>
        </div>
    `;
    
    return tableHTML;
}
// ===== HI·ªÇN TH·ªä T∆Ø∆†NG T√ÅC H·ªåC SINH CHO GI√ÅO VI√äN =====
async function viewClassInteractions() {
    if (!isTeacherLoggedIn) {
        showNotification('Ch·ªâ gi√°o vi√™n m·ªõi c√≥ quy·ªÅn xem t∆∞∆°ng t√°c!', 'error');
        return;
    }

    try {
        // L·∫•y t·∫•t c·∫£ l·ªõp c·ªßa gi√°o vi√™n
        const classesSnapshot = await db.ref('classes').once('value');
        const classes = classesSnapshot.val() || {};
        
        let classesWithInteractions = [];
        
        // Ki·ªÉm tra l·ªõp n√†o c√≥ t∆∞∆°ng t√°c
        const promises = Object.entries(classes).map(async ([classCode, classData]) => {
            if (classData.teacherId === currentUser.uid) {
                // Ki·ªÉm tra sessions c·ªßa l·ªõp n√†y c√≥ interactions kh√¥ng
                const sessionsSnapshot = await db.ref('sessions').orderByChild('teacher').equalTo(currentUser.name).once('value');
                const sessions = sessionsSnapshot.val() || {};
                
                let classInteractions = [];
                
                Object.entries(sessions).forEach(([sessionCode, sessionData]) => {
                    if (sessionData.interactions) {
                        Object.entries(sessionData.interactions).forEach(([interactionId, interaction]) => {
                            classInteractions.push({
                                ...interaction,
                                sessionCode: sessionCode,
                                interactionId: interactionId
                            });
                        });
                    }
                });
                
                if (classInteractions.length > 0) {
                    classesWithInteractions.push({
                        classCode,
                        className: classData.name,
                        interactions: classInteractions
                    });
                }
            }
        });
        
        await Promise.all(promises);
        
        if (classesWithInteractions.length === 0) {
            showNotification('Kh√¥ng c√≥ t∆∞∆°ng t√°c n√†o t·ª´ h·ªçc sinh!', 'info');
            return;
        }
        
        // Hi·ªÉn th·ªã modal t∆∞∆°ng t√°c
        showInteractionsModal(classesWithInteractions);
        
    } catch (error) {
        console.error('L·ªói t·∫£i t∆∞∆°ng t√°c:', error);
        showNotification('‚ùå L·ªói khi t·∫£i t∆∞∆°ng t√°c!', 'error');
    }
}

function showInteractionsModal(classesWithInteractions) {
    let interactionsHTML = '';
    
    classesWithInteractions.forEach(classData => {
        interactionsHTML += `
            <div class="class-interactions-section" style="margin-bottom: 25px;">
                <h5 style="color: #1a237e; margin-bottom: 15px; border-bottom: 2px solid #1a237e; padding-bottom: 8px;">
                    üè´ ${classData.className} (${classData.classCode})
                </h5>
        `;
        
        classData.interactions.forEach(interaction => {
            const timeAgo = getTimeAgo(interaction.timestamp);
            let interactionIcon = 'üí¨';
            let interactionColor = '#17a2b8';
            
            switch(interaction.type) {
                case 'hand_raised':
                    interactionIcon = '‚úã';
                    interactionColor = '#ffc107';
                    break;
                case 'question':
                    interactionIcon = '‚ùì';
                    interactionColor = '#28a745';
                    break;
                case 'need_help':
                    interactionIcon = 'üÜò';
                    interactionColor = '#dc3545';
                    break;
            }
            
            interactionsHTML += `
                <div class="interaction-item" style="padding: 15px; margin: 10px 0; background: #f8f9fa; border-radius: 10px; border-left: 4px solid ${interactionColor};">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="font-size: 1.5em;">${interactionIcon}</div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: between; margin-bottom: 8px;">
                                <strong>${interaction.student}</strong>
                                <small style="color: #666;">${timeAgo}</small>
                            </div>
                            <div style="color: #555;">
                                ${getInteractionText(interaction)}
                            </div>
                            ${interaction.content ? `
                                <div style="background: white; padding: 10px; border-radius: 8px; margin-top: 8px; border: 1px solid #e0e0e0;">
                                    <strong>N·ªôi dung:</strong> ${interaction.content}
                                </div>
                            ` : ''}
                            <div style="margin-top: 10px; font-size: 0.8em; color: #888;">
                                L·ªõp: ${classData.classCode} | Phi√™n: ${interaction.sessionCode}
                            </div>
                        </div>
                        <button onclick="markInteractionResolved('${interaction.sessionCode}', '${interaction.interactionId}')" 
                                style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8em;">
                            ‚úÖ ƒê√£ x·ª≠ l√Ω
                        </button>
                    </div>
                </div>
            `;
        });
        
        interactionsHTML += `</div>`;
    });
    
    const modalContent = `
        <div style="padding: 20px; max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <h4 style="color: #1a237e; margin-bottom: 20px;">üí¨ T∆∞∆°ng t√°c t·ª´ H·ªçc sinh</h4>
            
            ${interactionsHTML}
            
            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <button onclick="hideModal(this.closest('.modal'))" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    ƒê√≥ng
                </button>
            </div>
        </div>
    `;
    
    showCustomModal('T∆∞∆°ng t√°c H·ªçc sinh', modalContent);
}

function getInteractionText(interaction) {
    switch(interaction.type) {
        case 'hand_raised':
            return 'ƒëang gi∆° tay ph√°t bi·ªÉu';
        case 'question':
            return 'c√≥ c√¢u h·ªèi';
        case 'need_help':
            return 'c·∫ßn h·ªó tr·ª£ g·∫•p';
        default:
            return 'c√≥ t∆∞∆°ng t√°c';
    }
}

async function markInteractionResolved(sessionCode, interactionId) {
    try {
        await db.ref(`sessions/${sessionCode}/interactions/${interactionId}`).remove();
        showNotification('‚úÖ ƒê√£ ƒë√°nh d·∫•u t∆∞∆°ng t√°c ƒë√£ x·ª≠ l√Ω', 'success');
        
        // Refresh l·∫°i modal
        setTimeout(viewClassInteractions, 500);
    } catch (error) {
        console.error('L·ªói x√≥a t∆∞∆°ng t√°c:', error);
        showNotification('‚ùå L·ªói khi x·ª≠ l√Ω t∆∞∆°ng t√°c!', 'error');
    }
}
console.log("üöÄ H·ªá th·ªëng L·ªõp To√°n Th·∫ßy B√¨nh ƒë√£ kh·ªüi ch·∫°y v·ªõi c√°c l·ªói ƒë√£ ƒë∆∞·ª£c s·ª≠a!");
</script>
<script>
// === DARK MODE TOGGLE ===
document.addEventListener("DOMContentLoaded", () => {
    const toggleBtn = document.getElementById("toggleStyleBtn");
    let isDark = false;

    toggleBtn.addEventListener("click", () => {
        isDark = !isDark;
        document.documentElement.classList.toggle("dark-mode", isDark);
        toggleBtn.textContent = isDark ? "‚òÄÔ∏è Ch·∫ø ƒë·ªô s√°ng" : "üåô Ch·∫ø ƒë·ªô t·ªëi";

        // C·∫≠p nh·∫≠t l·∫°i MathJax khi chuy·ªÉn ƒë·ªïi
        if (window.MathJax) {
            MathJax.typesetPromise();
        }
    });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    if (typeof setupCanvas === "function") setupCanvas();
});

</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    try {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        if (typeof setupCanvas === "function") setupCanvas();
        if (typeof setupToolbar === "function") setupToolbar();
        if (typeof setupModalSystem === "function") setupModalSystem();
        if (typeof setupClassManagement === "function") setupClassManagement();
    } catch (err) {
        console.error("‚ö†Ô∏è L·ªói kh·ªüi t·∫°o:", err);
    }
});
// T·ª± ƒë·ªông √°p d·ª•ng style cho t·∫•t c·∫£ c√°c b·∫£ng
function styleAllTables() {
    const tables = document.querySelectorAll('.reveal .slides section table');
    
    tables.forEach(table => {
        // X√≥a inline style c≈©
        table.removeAttribute('style');
        
        // Th√™m class ho·∫∑c style m·ªõi
        table.style.cssText = `
            width: 100% !important;
            border-collapse: collapse !important;
            margin: 20px 0 !important;
            font-size: 1.2em !important;
            font-weight: bold !important;
            background: #000 !important;
            color: #fff !important;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        `;
        
        // Style cho th
        const ths = table.querySelectorAll('th');
        ths.forEach(th => {
            th.style.cssText = `
                background: linear-gradient(135deg, #1a237e, #3949ab) !important;
                color: #fff !important;
                padding: 15px 12px !important;
                text-align: center;
                font-size: 1.1em;
                font-weight: 700;
                border: 2px solid #3949ab !important;
                text-transform: uppercase;
                letter-spacing: 1px;
            `;
        });
        
        // Style cho td
        const tds = table.querySelectorAll('td');
        tds.forEach(td => {
            td.style.cssText = `
                padding: 14px 12px !important;
                text-align: center;
                border: 2px solid #333 !important;
                background: #111 !important;
                color: #fff !important;
                font-weight: bold;
            `;
        });
    });
}
// ===== FULLSCREEN ƒê∆†N GI·∫¢N =====
function setupFullscreen() {
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    if (!fullscreenBtn) return;
    
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    
    // Theo d√µi thay ƒë·ªïi fullscreen
    document.addEventListener('fullscreenchange', updateFullscreenButton);
}

function toggleFullscreen() {
    if (!document.fullscreenElement) {
        // V√†o fullscreen
        if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen();
        }
    } else {
        // Tho√°t fullscreen
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
    }
}

function updateFullscreenButton() {
    const btn = document.getElementById('fullscreenBtn');
    if (document.fullscreenElement) {
        btn.textContent = 'üì∫ Exit';
    } else {
        btn.textContent = 'üì∫ Fullscreen';
    }
}

// Ph√≠m t·∫Øt F11
document.addEventListener('keydown', function(e) {
    if (e.key === 'F11') {
        e.preventDefault();
        toggleFullscreen();
    }
});
// Ch·∫°y khi trang load v√† m·ªói khi slide thay ƒë·ªïi
document.addEventListener('DOMContentLoaded', styleAllTables);
Reveal.addEventListener('slidechanged', styleAllTables);
setupFullscreen();
// ===== H·ªÜ TH·ªêNG L∆ØU K·∫æT QU·∫¢ ƒê·ªòC L·∫¨P =====
class ResultManager {
    constructor() {
        this.currentTest = window.location.pathname.split('/').pop() || 'unknown';
        this.studentData = null;
    }

    // L∆∞u k·∫øt qu·∫£ ho√†n ch·ªânh
    async saveCompleteResult() {
        if (!this.checkLogin()) return;

        try {
            const resultData = this.collectResultData();
            await this.saveToFirebase(resultData);
            console.log('‚úÖ ƒê√£ l∆∞u k·∫øt qu·∫£ ho√†n ch·ªânh');
        } catch (error) {
            console.error('‚ùå L·ªói l∆∞u k·∫øt qu·∫£:', error);
        }
    }

    // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
    checkLogin() {
        if (!currentUser || currentUser.role !== 'student') {
            console.log('‚ö†Ô∏è Ch∆∞a ƒëƒÉng nh·∫≠p h·ªçc sinh');
            return false;
        }
        this.studentData = currentUser;
        return true;
    }

    // Thu th·∫≠p d·ªØ li·ªáu k·∫øt qu·∫£
    collectResultData() {
        const answers = this.collectAllAnswers();
        const score = this.calculateScore(answers);
        
        return {
            studentCode: this.studentData.code,
            studentName: this.studentData.name,
            testFile: this.currentTest,
            testName: document.title,
            answers: answers,
            totalScore: score,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            sessionCode: sessionCode || 'no_session'
        };
    }

    // Thu th·∫≠p t·∫•t c·∫£ ƒë√°p √°n
    collectAllAnswers() {
        const answers = {};
        
        // C√¢u h·ªèi tr·∫Øc nghi·ªám (1-12)
        for (let i = 1; i <= 12; i++) {
            const qid = 'q' + i;
            const selected = document.querySelector(`input[name="${qid}"]:checked`);
            answers[qid] = selected ? selected.value : '';
        }

        // C√¢u True/False (13-16)
        for (let i = 13; i <= 16; i++) {
            const subAnswers = [];
            ['a','b','c','d'].forEach(letter => {
                const sel = document.querySelector(`input[name="q${i}${letter}"]:checked`);
                subAnswers.push(sel ? sel.value : '');
            });
            answers['q' + i] = subAnswers;
        }

        // C√¢u tr·∫£ l·ªùi ng·∫Øn (17-22)
        for (let i = 17; i <= 22; i++) {
            const el = document.getElementById(`input-q${i}`);
            answers['q' + i] = el ? el.value.trim() : '';
        }

        return answers;
    }

    // T√≠nh ƒëi·ªÉm (t·∫°m th·ªùi, c√≥ th·ªÉ c·∫£i ti·∫øn sau)
    calculateScore(answers) {
        let score = 0;
        // Logic t√≠nh ƒëi·ªÉm c√≥ th·ªÉ th√™m sau
        return score;
    }

    // L∆∞u l√™n Firebase
    async saveToFirebase(resultData) {
        const timestamp = new Date().getTime();
        const recordId = `${resultData.studentCode}_${timestamp}`;
        
        await db.ref(`completeResults/${recordId}`).set(resultData);
    }
}

// Kh·ªüi t·∫°o v√† t·ª± ƒë·ªông l∆∞u
const resultManager = new ResultManager();

// T·ª± ƒë·ªông l∆∞u khi click ki·ªÉm tra (kh√¥ng ·∫£nh h∆∞·ªüng JS hi·ªán t·∫°i)
document.addEventListener('click', function(e) {
    if (e.target.matches('button[onclick*="checkAnswer"], button[onclick*="checkTrueFalseAnswer"], button[onclick*="checkShortAnswer"]')) {
        setTimeout(() => resultManager.saveCompleteResult(), 1000);
    }
});

// L∆∞u khi t√≠nh ƒëi·ªÉm
const originalCalculateScore = window.calculateFinalScore;
window.calculateFinalScore = function() {
    resultManager.saveCompleteResult();
    return originalCalculateScore.apply(this, arguments);
};
</script>


</body>
</html>
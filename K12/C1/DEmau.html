<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="utf-8"/>
<title> LỚP TOÁN THẦY BÌNH </title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<!-- Reveal.js CSS -->
<link href="https://unpkg.com/reveal.js/dist/reveal.css" rel="stylesheet"/>
<link href="https://unpkg.com/reveal.js/dist/theme/black.css" id="theme" rel="stylesheet"/>
<!-- Thêm vào phần head, sau các link CSS hiện có -->
<script src="https://unpkg.com/reveal.js/dist/reveal.js"></script>
<script src="https://unpkg.com/reveal.js/plugin/notes/notes.js"></script>
<script src="https://unpkg.com/reveal.js/plugin/markdown/markdown.js"></script>
<script src="https://unpkg.com/reveal.js/plugin/highlight/highlight.js"></script>
<script src="https://unpkg.com/reveal.js/plugin/math/math.js"></script>
<link href="https://unpkg.com/reveal.js/plugin/highlight/monokai.css" rel="stylesheet"/>
<!-- MathJax -->
<script>
    MathJax = {
      tex: { 
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']]
      },
      svg: { fontCache: 'global', linebreaks: { automatic: true } },
      chtml: { linebreaks: { automatic: true } }
    };
  </script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<link rel="stylesheet" href="styless.css">
<!-- ===== style chuyên đề  ===== -->
</head>
<body>
<!-- ===== Thanh tiêu đề cố định ===== -->
<div class="topbar">
<div class="topbar-title">LỚP TOÁN THẦY BÌNH</div>
<div class="clock" id="clock">--:--:--</div>
<button id="toggleMenu">☰</button>
<!-- ==== Thanh công cụ: Chọn đề / Đăng nhập / Tính điểm ==== -->
<div class="topbar-controls">
  
<select id="selectExam">
<option value="">-- Chọn đề --</option>
<option value="de1">Đề 1</option>
<option value="de2">Đề 2</option>
</select>
<button id="loginBtn">🔑 Đăng nhập</button>
<button id="scoreBtn">📊 Tính điểm</button>
</div>

</div>
<div class="reveal">
<div class="slides">
<!-------------BẮT ĐẦU NỘI DUNG CÁC SLIDE-->
<!-- TÊN BÀI -->
<section>
<h2>📘 ĐỀ KIỂM TRA</h2>
<p>Môn Toán - Lớp 12</p>
</section>
<section>
<h2>📘 PHẦN  TRẮC NGHIỆM </h2>
</section>
<!--@@@@-->
<h2>📘 PHẦN  ĐÚNG SAI (4 CÂU) </h2>
<section>
<section>
<div class="question" id="q13">
<p class="question-title"><strong>Question 1.</strong> (THPT Triệu Quang Phục - Hưng Yên 2025) Cho đồ thị hàm số $y=\cos x/\left[-\dfrac{5\pi}{2};\dfrac{5\pi}{2}\right]$ dưới đây. Xét tính đúng sai của các phát biểu sau:</p>
<div class="options">
<div class="option-row">a) a) Hàm số đã cho đồng biến trên các khoảng $(-\pi;0)$ và $(\pi;2\pi)$
          <label><input name="q13a" type="radio" value="True"/> True</label>
<label><input name="q13a" type="radio" value="False"/> False</label>
</div>
<div class="option-row">b) b) Giá trị lớn nhất, giá trị nhỏ nhất của hàm số là $Max y=1; Min y=-1$
          <label><input name="q13b" type="radio" value="True"/> True</label>
<label><input name="q13b" type="radio" value="False"/> False</label>
</div>
<div class="option-row">c) c) Hàm số đã cho là hàm tuần hoàn với chu kì $2\pi$
          <label><input name="q13c" type="radio" value="True"/> True</label>
<label><input name="q13c" type="radio" value="False"/> False</label>
</div>
<div class="option-row">d) d) Phương trình $\cos x=a$ với $0<a<\dfrac{1}{2}$ $\left[-\dfrac{5\pi}{2};\dfrac{5\pi}{2}\right]$="" 4="" <label="" có="" nghiệm="" trên="" đoạn=""><input name="q13d" type="radio" value="True"/> True
<label><input name="q13d" type="radio" value="False"/> False</label>
</a<\dfrac{1}{2}$></div>
</div>
<div class="answer-check">
<button onclick="checkTrueFalseAnswer('q13',['True','True','True','False'])">Check</button>
</div>
</div>
</section>
</section>
<section>
<section>
<h2>📘 PHẦN  TRẢ LỜI NGẮN ( 6 CÂU) </h2>
<section>
<section>
<div class="question" id="q22">
<p><strong>Question 2</strong>. Biết đồ thị hàm số $y=ax^3+bx^2+cx+d$ có hai điểm cực trị $A(1;-7), B(2;-8)$. Tính $y(-1)$.</p>
<div class="answer-check">
<input id="input-q22" placeholder="Enter your answer" type="text"/>
<button onclick="checkShortAnswer('q22','-35')">Check</button>
<span id="icon-q22"></span>
</div>
</div>
</section>
</section>
<!---------------------------------------------------------THE END----------------------------------------------------->
</div>
</div>
<!-- Slide Navigation Menu -->
<div class="slide-menu" id="slideMenu">
<div class="menu-header">
<h3>📋 Danh sách slide</h3>
<button class="close-btn" onclick="closeSlideMenu()">×</button>
</div>
<div class="menu-content">
<div class="slide-list" id="slideList">
<!-- Danh sách slide sẽ được tạo tự động bằng JavaScript -->
</div>
</div>
</div>
<!-- Nút mở menu -->
<button class="menu-toggle" id="menuToggle" onclick="toggleSlideMenu()">📋</button>
<!-- Canvas -->

<!-- ==== Canvas + Toolbar ==== -->
<canvas id="drawCanvas" style="display:none;"></canvas>
<div class="toolbar" id="drawToolbar" style="display:none;">
<a href="../index.html" title="Về trang chủ">
  <button id="homeBtn" style="font-size:22px;">🏠</button>
</a>
<select id="tool">
<option value="pen">✏️ Bút</option>
<option value="line">📏 Đường</option>
<option value="rect">⬛ Chữ nhật</option>
<option value="parallelogram">▱ Bình hành</option>
<option value="circle">⚪ Tròn</option>
<option value="dashedLineBtn">– –</option>
<option value="ellipseBtn">⬭ Elip</option>
<!-- Thêm 3 công cụ mới -->
<option value="box">📦 Hộp 3D</option>
<option value="pyramid3">🔺 Chóp tam giác</option>
<option value="pyramid4">🔲 Chóp tứ giác</option>
<option value="sphere">⚽ Cầu</option>
</select>
<input id="draw-width" max="5" min="1" type="range" value="2"/>
<input id="colorPicker" type="color" value="#6b21a8">
<button id="undoBtn" title="Undo">↩️</button>
<button id="clearBtn">🧹 Xoá</button>
<button id="saveBtn">💾 Lưu</button>
<button id="exitBtn">❌ Thoát</button>
</input></div>
<script>
/* === SCRIPT VẼ (bắt nguồn từ b2ds) === */
/* Mình chỉ thêm: history (undo), và 3 case vẽ: box, pyramid3, pyramid4.
   Không sửa logic vẽ khác. */

const canvas = document.getElementById("drawCanvas");
const ctx = canvas.getContext("2d");
const toggleBtn = document.getElementById("toggleMenu");
const toolbar = document.getElementById("drawToolbar");
const clearBtn = document.getElementById("clearBtn");
const saveBtn = document.getElementById("saveBtn");
const exitBtn = document.getElementById("exitBtn");
const colorPicker = document.getElementById("colorPicker");
const toolSelect = document.getElementById("tool");
const widthPicker = document.getElementById("draw-width");
const undoBtn = document.getElementById("undoBtn");

let lineWidth = 2;
widthPicker.oninput = () => lineWidth = parseInt(widthPicker.value);

let isDrawing = false;
let isDrawMode = false;
let startX = 0, startY = 0, lastX = 0, lastY = 0;
let currentTool = "pen";
let imageBeforeShape;

// HISTORY cho Undo (hoàn tác nét gần nhất)
let history = [];

// mượt hơn
ctx.lineJoin = "round";
ctx.lineCap = "round";

// kích thước canvas (đơn giản, giữ nguyên như b2ds)
function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

// bật/tắt vẽ
toggleBtn.onclick = () => {
  isDrawMode = !isDrawMode;
  if (isDrawMode) {
    canvas.style.display = "block";
    toolbar.style.display = "flex";
    canvas.style.pointerEvents = "auto"; // bật tương tác khi vẽ
  } else {
    canvas.style.display = "none";
    toolbar.style.display = "none";
    canvas.style.pointerEvents = "none";
  }
};

// thoát
exitBtn.onclick = () => {
  isDrawMode = false;
  canvas.style.display = "none";
  toolbar.style.display = "none";
  canvas.style.pointerEvents = "none";
};

// chọn công cụ
toolSelect.onchange = () => currentTool = toolSelect.value;

// undo: hoàn tác 1 bước (nét gần nhất)
undoBtn.onclick = () => {
  if (history.length > 0) {
    const last = history.pop();
    try {
      ctx.putImageData(last, 0, 0);
    } catch (e) {
      // nếu putImageData lỗi do mismatch kích thước, clear và ignore
      ctx.clearRect(0,0,canvas.width,canvas.height);
    }
  }
};

// xoá toàn bộ
clearBtn.onclick = () => ctx.clearRect(0, 0, canvas.width, canvas.height);

// lưu ảnh
saveBtn.onclick = () => {
  const link = document.createElement("a");
  link.download = "ban_ve.png";
  link.href = canvas.toDataURL();
  link.click();
};

// fullscreen button (giữ nguyên)
const fullBtn = document.createElement("button");
fullBtn.textContent = "⛶ Full";
fullBtn.title = "Toàn màn hình";
fullBtn.onclick = () => {
  if (!document.fullscreenElement)
    document.documentElement.requestFullscreen().catch(() => {});
  else
    document.exitFullscreen();
};
toolbar.appendChild(fullBtn);

// lấy vị trí chính xác
function getPos(e) {
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  if (e.touches && e.touches.length > 0)
    return { x: (e.touches[0].clientX - rect.left) * scaleX, y: (e.touches[0].clientY - rect.top) * scaleY };
  return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
}

// bắt đầu vẽ
function startDraw(e) {
  if (!isDrawMode) return;
  e.preventDefault();
  const pos = getPos(e);

  // LƯU trạng thái trước khi vẽ (cho Undo: hoàn tác nét gần nhất)
  try {
    history.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
  } catch (err) {
    // ignore nếu getImageData lỗi (ví dụ canvas chưa có kích thước)
  }

  isDrawing = true;
  startX = lastX = pos.x;
  startY = lastY = pos.y;
  ctx.strokeStyle = colorPicker.value;
  ctx.lineWidth = lineWidth;
  ctx.beginPath();
  ctx.moveTo(startX, startY);
  if (currentTool !== "pen") {
    try { imageBeforeShape = ctx.getImageData(0, 0, canvas.width, canvas.height); } catch(e){ imageBeforeShape = null; }
  } else {
    imageBeforeShape = null;
  }
}

// vẽ khi rê
function drawMove(e) {
  if (!isDrawing || !isDrawMode) return;
  e.preventDefault();
  const pos = getPos(e);
  ctx.strokeStyle = colorPicker.value;
  ctx.lineWidth = lineWidth;
  ctx.setLineDash([]);

  if (currentTool === "pen") {
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    lastX = pos.x; lastY = pos.y;
  } else {
    // khôi phục nền trước shape live preview
    if (imageBeforeShape) {
      try { ctx.putImageData(imageBeforeShape, 0, 0); } catch(e){ /* ignore */ }
    } else {
      // nếu không có imageBeforeShape, xóa phần vẽ tạm
      // (để tránh chồng lớp)
      // ctx.clearRect(0,0,canvas.width,canvas.height);
    }

    switch (currentTool) {
      case "line":
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        break;

      case "dashedLineBtn":
        ctx.setLineDash([8,6]);
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        ctx.setLineDash([]);
        break;

      case "rect":
        ctx.strokeRect(startX, startY, pos.x - startX, pos.y - startY);
        break;

      case "circle":
        const r = Math.hypot(pos.x - startX, pos.y - startY);
        ctx.beginPath();
        ctx.arc(startX, startY, r, 0, Math.PI*2);
        ctx.stroke();
        break;

      case "ellipseBtn":
        ctx.setLineDash([6,4]);
        ctx.beginPath();
        ctx.ellipse(startX, startY, Math.abs(pos.x - startX), Math.abs(pos.y - startY), 0, 0, Math.PI*2);
        ctx.stroke();
        ctx.setLineDash([]);
        break;

      case "sphere":
        const rs = Math.abs(pos.x - startX);
        ctx.beginPath();
        ctx.arc(startX, startY, rs, 0, Math.PI*2);
        ctx.stroke();
        ctx.setLineDash([6,4]);
        ctx.beginPath();
        ctx.ellipse(startX, startY, rs, rs/2, 0, Math.PI, 2 * Math.PI);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.beginPath();
        ctx.ellipse(startX, startY, rs, rs/2, 0, 0, Math.PI);
        ctx.stroke();
        break;

      case "parallelogram":
        const width = pos.x - startX;
        const height = pos.y - startY;
        const offset = width * 0.3;
        ctx.beginPath();
        ctx.moveTo(startX + offset, startY);
        ctx.lineTo(startX + width + offset, startY);
        ctx.lineTo(startX + width - offset, startY + height);
        ctx.lineTo(startX - offset, startY + height);
        ctx.closePath();
        ctx.stroke();
        break;

      /* ==== THÊM: BOX (HỘP 3D) ==== */
      case "box":
        {
          const w = pos.x - startX;
          const h = pos.y - startY;
          const depth = Math.min(Math.abs(w), Math.abs(h)) * 0.3;
          // front face
          ctx.beginPath();
          ctx.strokeRect(startX, startY, w, h);
          // back face (offset by depth up-left)
          ctx.strokeRect(startX + depth, startY - depth, w, h);
          // connect corners
          ctx.beginPath();
          ctx.moveTo(startX, startY);
          ctx.lineTo(startX + depth, startY - depth);
          ctx.moveTo(startX + w, startY);
          ctx.lineTo(startX + w + depth, startY - depth);
          ctx.moveTo(startX, startY + h);
          ctx.lineTo(startX + depth, startY + h - depth);
          ctx.moveTo(startX + w, startY + h);
          ctx.lineTo(startX + w + depth, startY + h - depth);
          ctx.stroke();
        }
        break;

      /* ==== THÊM: CHÓP TAM GIÁC (pyramid3) ==== */
      /* ==== CẢI TIẾN: CHÓP TAM GIÁC 3D (pyramid3) ==== */
        case "pyramid3": {
          // xác định 3 đỉnh đáy (tam giác nằm trên mặt phẳng đáy)
          const baseLeft = { x: startX, y: pos.y };
          const baseRight = { x: pos.x, y: pos.y };
          const baseMid = { x: (startX + pos.x) / 2, y: pos.y - (pos.y - startY) * 0.2 };

          // đỉnh chóp (cao hơn đáy)
          const apex = { 
            x: (startX + pos.x) / 2, 
            y: startY - Math.abs(pos.y - startY) * 0.7 
          };

          ctx.beginPath();
          ctx.setLineDash([]); // nét liền

          // vẽ mặt trước (2 cạnh bên + cạnh đáy trước)
          ctx.moveTo(apex.x, apex.y);
          ctx.lineTo(baseLeft.x, baseLeft.y);
          ctx.lineTo(baseRight.x, baseRight.y);
          ctx.closePath();
          ctx.stroke();

          // vẽ cạnh phía sau (ẩn - nét đứt)
          ctx.setLineDash([6, 4]);
          ctx.beginPath();
          ctx.moveTo(apex.x, apex.y);
          ctx.lineTo(baseMid.x, baseMid.y);
          ctx.stroke();
          ctx.setLineDash([]);
          break;
        }


      /* ==== THÊM: CHÓP TỨ GIÁC (pyramid4) ==== */
      case "pyramid4":
        {
          const w4 = pos.x - startX, h4 = pos.y - startY;
          const apexX = startX + w4 / 2;
          const apexY = startY - h4 / 1.5; // apex above the rectangle
          ctx.beginPath();
          // base rectangle (front)
          ctx.rect(startX, startY, w4, h4);
          ctx.stroke();
          // connect base corners to apex
          ctx.beginPath();
          ctx.moveTo(startX, startY);
          ctx.lineTo(apexX, apexY);
          ctx.moveTo(startX + w4, startY);
          ctx.lineTo(apexX, apexY);
          ctx.moveTo(startX, startY + h4);
          ctx.lineTo(apexX, apexY);
          ctx.moveTo(startX + w4, startY + h4);
          ctx.lineTo(apexX, apexY);
          ctx.stroke();
        }
        break;

      case "pyramid3": // duplicate safe-guard
        break;

      default:
        break;
    }
  }
}

// kết thúc
function endDraw() { isDrawing = false; }

canvas.addEventListener("mousedown", startDraw);
canvas.addEventListener("mousemove", drawMove);
canvas.addEventListener("mouseup", endDraw);
canvas.addEventListener("mouseleave", endDraw);
canvas.addEventListener("touchstart", startDraw, { passive: false });
canvas.addEventListener("touchmove", drawMove, { passive: false });
canvas.addEventListener("touchend", endDraw);
  </script>
<!-- Reveal.js -->
<script src="https://unpkg.com/reveal.js/dist/reveal.js"></script>
<script>
  Reveal.initialize({
  width: "100%",   // 👈 chiều rộng = full trình duyệt
  height: "100%",  // 👈 chiều cao = full trình duyệt
  margin: 0.02,    // khoảng trống xung quanh (0 → không viền trắng)
  minScale: 0.2,
  maxScale: 2,
  slideNumber: true,
  center: false,
  hash: true,
  // các cấu hình khác...
 
    hash: true,
    plugins: [RevealMarkdown, RevealHighlight, RevealNotes, RevealMath],
    math: {
        mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js',
        config: 'TeX-AMS_HTML-full',
        tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            displayMath: [['$$','$$'], ['\\[','\\]']],
            balanceBraces: true,
            processEscapes: true,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
        }
    },
    transition: 'slide',
    backgroundTransition: 'fade',
    controls: true,
    progress: true,
    center: true,
    slideNumber: 'c/t'
});

</script>
<!-- ========== SCRIPT VẼ - BẢN ĐÃ SỬA ỔN ĐỊNH (KHÔNG MẤT LOGIC) ========== -->
<!-- ========== KẾT THÚC SCRIPT VẼ ========== -->
<script>
  // Hàm phát âm thanh
  function playSound(src) {
    const audio = new Audio(src);
    audio.play();
  }

  // =====================
  // 1️⃣ TRẮC NGHIỆM 4 LỰA CHỌN
  // =====================
  function showOptionIcon(qid, selected, correct) {
    document.querySelectorAll(`#${qid} .option-icon`).forEach(ic => ic.textContent = "");
    const icon = document.getElementById(`icon-${qid}-${selected}`);
    if (icon) icon.textContent = (selected === correct) ? "✅" : "❌";
  }

  function checkAnswer(qid, correct) {
    // Xóa icon cũ
    document.querySelectorAll(`#${qid} .option-icon`).forEach(el => el.textContent = '');
    
    // Lấy lựa chọn
    const chosen = document.querySelector(`input[name="${qid}"]:checked`);
    if (!chosen) {
      alert("Hãy chọn một đáp án!");
      playSound("../audio/wrong.mp3");
      return;
    }

    const chosenVal = chosen.value;
    const iconId = `icon-${qid}-${chosenVal}`;

    // Hiển thị đúng/sai + phát âm thanh
    if (chosenVal === correct) {
      document.getElementById(iconId).textContent = '✅';
      playSound("../audio/correct.mp3");
    } else {
      document.getElementById(iconId).textContent = '❌';
      document.getElementById(`icon-${qid}-${correct}`).textContent = '✅';
      playSound("../audio/wrong.mp3");
    }
  }

  // =====================
  // 2️⃣ CÂU HỎI ĐÚNG / SAI
  // =====================
  
</script>
<script>
function playSound(src){
  try{
    const a = new Audio(src);
    a.volume = 0.9;
    a.play().catch(()=>{/* muted or user gesture required */});
  }catch(e){}
}

/**
 * checkTrueFalseAnswer:
 * - questionId: 'q1'
 * - correctAnswers: either an Array like ['True','False','True','True'] OR a string '["True","False",...]'
 */
function checkTrueFalseAnswer(questionId, correctAnswers){
  // normalize correctAnswers to array of strings
  if(typeof correctAnswers === 'string'){
    try{ correctAnswers = JSON.parse(correctAnswers); }
    catch(e){ 
      // fallback: try to split by comma (robust)
      correctAnswers = correctAnswers.replace(/^\[|\]$/g,'').split(',').map(s=>s.trim().replace(/^["']|["']$/g,'')); 
    }
  }
  if(!Array.isArray(correctAnswers)) return console.warn('Invalid correctAnswers for', questionId);

  const container = document.getElementById(questionId);
  if(!container){ console.warn('No container', questionId); return; }

  const optionRows = container.querySelectorAll(".option-row");
  let allCorrect = true;
  let feedbackHtml = '';

  optionRows.forEach((row, idx) => {
    const radios = row.querySelectorAll("input[type='radio']");
    let selected = null;
    radios.forEach(r => { if (r.checked) selected = r.value; });

    const expected = (correctAnswers[idx] && String(correctAnswers[idx]).toLowerCase().startsWith('t')) ? 'True' : 'False';
    const letter = String.fromCharCode(97 + idx); // a, b, c, d

    if (selected === null) {
      feedbackHtml += `Mệnh đề ${letter}) ⭕ Chưa chọn<br>`;
      allCorrect = false;
    } else if (selected === expected) {
      feedbackHtml += `Mệnh đề ${letter}) ✅ Đúng<br>`;
      // add icon near selected radio (if option-icon exists)
      const icon = row.querySelector('.option-icon');
      if(icon) icon.textContent = '✅';
    } else {
      feedbackHtml += `Mệnh đề ${letter}) ❌ Sai (chọn ${selected})<br>`;
      const icon = row.querySelector('.option-icon');
      if(icon) icon.textContent = '❌';
      allCorrect = false;
    }
  });

  // render feedback in .answer-check .result (create if missing)
  let resultBox = container.querySelector(".answer-check .result");
  if(!resultBox){
    resultBox = document.createElement('div');
    resultBox.className = 'result';
    resultBox.style.marginTop = '8px';
    resultBox.style.padding = '8px';
    resultBox.style.background = 'rgba(255,255,255,0.06)';
    resultBox.style.borderRadius = '6px';
    container.querySelector(".answer-check").appendChild(resultBox);
  }
  resultBox.innerHTML = feedbackHtml;

  // play sound
  if(allCorrect) playSound('../audio/correct.mp3'); else playSound('../audio/wrong.mp3');
}
</script>
<script>
function checkShortAnswer(qid, correct) {
  const input = document.getElementById(`input-${qid}`);
  const icon = document.getElementById(`icon-${qid}`);
  const resultBox = input?.closest(".answer-check");

  if (!input) return;

  const userAnswer = input.value.trim();

  // Tạo vùng thông báo nếu chưa có
  let feedback = resultBox.querySelector(".result");
  if (!feedback) {
    feedback = document.createElement("div");
    feedback.className = "result";
    feedback.style.marginTop = "6px";
    feedback.style.padding = "6px";
    feedback.style.borderRadius = "6px";
    feedback.style.fontSize = "0.95em";
    resultBox.appendChild(feedback);
  }

  if (userAnswer === "") {
    icon.textContent = "⚠️";
    feedback.innerHTML = "❗ <b>Báo thầy kiểm trực tiếp vì chưa giải.</b>";
    playSound("../audio/wrong.mp3");
    return;
  }

  // So sánh không phân biệt khoảng trắng / chữ hoa
  if (userAnswer.toLowerCase() === correct.trim().toLowerCase()) {
    icon.textContent = "✅";
    feedback.innerHTML = "🎯 <b>Đúng rồi!</b>";
    playSound("../audio/correct.mp3");
  } else {
    icon.textContent = "❌";
    feedback.innerHTML = `❌ Sai rồi. Đáp án đúng là: <b>${correct}</b>`;
    playSound("../audio/wrong.mp3");
  }
}
</script>
<script>
// Biến toàn cục
let slideMenu, menuToggle, slideList, menuOverlay;

// Khởi tạo khi DOM ready
document.addEventListener('DOMContentLoaded', function() {
    slideMenu = document.getElementById('slideMenu');
    menuToggle = document.getElementById('menuToggle');
    slideList = document.getElementById('slideList');
    
    // Tạo overlay
    menuOverlay = document.createElement('div');
    menuOverlay.className = 'menu-overlay';
    menuOverlay.onclick = closeSlideMenu;
    document.body.appendChild(menuOverlay);
    
    // Tạo danh sách slide
    createSlideList();
    
    // Lắng nghe sự kiện chuyển slide
    Reveal.addEventListener('slidechanged', updateActiveSlide);
});

// Tạo danh sách slide
function createSlideList() {
    const slides = document.querySelectorAll('.reveal .slides section');
    let html = '';
    
    slides.forEach((slide, index) => {
        const slideTitle = getSlideTitle(slide);
        const isVertical = slide.parentNode.classList.contains('stack');
        
        if (!isVertical) {
            html += `
                <div class="slide-item" data-slide-index="${index}" onclick="goToSlide(${index})">
                    <span class="slide-number">${index + 1}</span>
                    ${slideTitle}
                </div>
            `;
        }
    });
    
    slideList.innerHTML = html;
    updateActiveSlide();
}

// Lấy tiêu đề slide
function getSlideTitle(slide) {
    // Ưu tiên tìm h2 đầu tiên
    const h2 = slide.querySelector('h2');
    if (h2) return h2.textContent;
    
    // Nếu không có h2, tìm đoạn đầu tiên
    const p = slide.querySelector('p');
    if (p) return p.textContent.substring(0, 30) + '...';
    
    // Mặc định
    return `Slide ${Array.from(slide.parentNode.children).indexOf(slide) + 1}`;
}

// Cập nhật slide đang active
function updateActiveSlide() {
    const currentSlide = Reveal.getCurrentSlide();
    const slides = document.querySelectorAll('.reveal .slides section');
    const currentIndex = Array.from(slides).indexOf(currentSlide);
    
    // Cập nhật active class
    document.querySelectorAll('.slide-item').forEach((item, index) => {
        if (index === currentIndex) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });
}

// Chuyển đến slide cụ thể
function goToSlide(index) {
    Reveal.slide(index);
    closeSlideMenu();
}

// Mở/đóng menu
function toggleSlideMenu() {
    slideMenu.classList.toggle('active');
    menuOverlay.classList.toggle('active');
}

function closeSlideMenu() {
    slideMenu.classList.remove('active');
    menuOverlay.classList.remove('active');
}

// Đóng menu bằng phím ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeSlideMenu();
    }
});
</script>
<script>
function updateClock() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2, '0');
  const m = String(now.getMinutes()).padStart(2, '0');
  const s = String(now.getSeconds()).padStart(2, '0');
  document.getElementById("clock").textContent = `${h}:${m}:${s}`;
}
setInterval(updateClock, 1000);
updateClock(); // chạy ngay khi tải trang
</script>
<script>
// === AUTO FIX SLIDE STRUCTURE ===
// Mục đích: Đưa mọi <img> (hoặc <center><img>...</center>) nằm ngoài <section> vào slide hợp lệ
document.addEventListener("DOMContentLoaded", () => {
  const slides = document.querySelector(".reveal .slides");
  if (!slides) return;

  // Tạo slide mới chứa node
  const makeSlide = (node) => {
    const sec = document.createElement("section");
    sec.appendChild(node);
    return sec;
  };

  // 1️⃣ Di chuyển ảnh hoặc center chưa nằm trong slide nào vào slide mới
  const imgs = [...document.querySelectorAll(".reveal .slides img")];
  imgs.forEach(img => {
    // Kiểm tra có nằm trong slide hợp lệ không
    let ancestor = img.closest(".reveal .slides > section");
    if (!ancestor) {
      // Nếu nằm trong <center>, di chuyển cả center
      const wrap = img.closest("center") || img;
      slides.appendChild(makeSlide(wrap));
    }
  });

  // 2️⃣ Sửa các <section> bị lồng hoặc đóng sai
  const badNested = [...slides.querySelectorAll("section section")];
  badNested.forEach(sec => slides.appendChild(sec));

  // 3️⃣ Xóa các section rỗng (chỉ chứa khoảng trắng)
  [...slides.querySelectorAll("section")].forEach(sec => {
    if (!sec.innerHTML.trim()) sec.remove();
  });

  console.log("✅ Slide structure fixed: images moved into valid slides.");
});
</script>
<!----------------->
<!-- LOGIN MODAL (thêm vào nếu chưa có) -->
<div id="login-modal" style="display:none; position:fixed; inset:0; z-index:12000; 
     background: rgba(0,0,0,0.5); align-items:center; justify-content:center;">
<div style="background:#fff; color:#000; padding:20px; border-radius:8px; width:340px;">
<h3>Đăng nhập học sinh</h3>
<form id="code-login-form">
<input id="login-code" placeholder="Mã học sinh" required="" style="width:100%;padding:8px;margin:6px 0;" type="text"/>
<input id="student-name" placeholder="Họ tên (tùy chọn)" style="width:100%;padding:8px;margin:6px 0;" type="text"/>
<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
<button style="padding:6px 10px;" type="submit">Đăng nhập</button>
<button id="close-modal" style="padding:6px 10px;" type="button">Đóng</button>
</div>
</form>
<div id="auth-status" style="margin-top:8px;color:#333;font-weight:600;"></div>
</div>
</div>
<script type="module">
// Nếu chưa khai báo global flag, khởi tạo
if (typeof window.isScoreCalculated === 'undefined') window.isScoreCalculated = false;

function calculateScore() {
  if (window.isScoreCalculated) return;
  const studentAnswers = {};
  const correctAnswers = {};
  let totalScore = 0;

  document.querySelectorAll('.question').forEach(q => {
    const qid = q.id;
    if (!qid) return;
    const btn = q.querySelector('button[onclick*="check"]');
    const onclickStr = btn ? (btn.getAttribute('onclick') || '') : '';

    if (onclickStr.includes('checkTrueFalseAnswer')) {
      const arrMatch = onclickStr.match(/\[(.*?)\]/);
      if (arrMatch) {
        const arr = arrMatch[1].split(',').map(s => s.replace(/['"\s\[\]]/g, '').trim());
        if (arr.length) correctAnswers[qid] = arr;
      }
    } else if (onclickStr.includes('checkShortAnswer')) {
      const m = onclickStr.match(/checkShortAnswer\(['"]([^'"]+)['"]\s*,\s*['"]([^'"]+)['"]\)/);
      if (m) correctAnswers[m[1]] = m[2];
    } else if (onclickStr.includes('checkAnswer')) {
      const m = onclickStr.match(/checkAnswer\(['"]([^'"]+)['"]\s*,\s*['"]([A-Za-z0-9]+)['"]\)/);
      if (m) correctAnswers[m[1]] = m[2].toString().toUpperCase();
    }
  });

  for (let i = 1; i <= 12; i++) {
    const name = 'q' + i;
    const selected = document.querySelector(`input[name="${name}"]:checked`);
    studentAnswers[name] = selected ? selected.value.trim() : '';
  }

  for (let i = 13; i <= 16; i++) {
    const sub = [];
    ['a','b','c','d'].forEach(letter => {
      const sel = document.querySelector(`input[name="q${i}${letter}"]:checked`);
      sub.push(sel ? sel.value.trim() : '');
    });
    studentAnswers['q' + i] = sub;
  }

  for (let i = 17; i <= 22; i++) {
    const el = document.getElementById(`input-q${i}`);
    studentAnswers['q' + i] = el ? el.value.trim().replace(',', '.') : '';
  }

  document.querySelectorAll('.question').forEach(q => {
    const qid = q.id;
    if (!correctAnswers[qid]) {
      const dataCorrect = q.getAttribute('data-correct');
      if (dataCorrect) {
        try {
          const parsed = JSON.parse(dataCorrect);
          correctAnswers[qid] = parsed;
        } catch (e) {
          correctAnswers[qid] = dataCorrect;
        }
      }
    }
  });

  for (let i = 1; i <= 22; i++) {
    const key = 'q' + i;
    const userAns = studentAnswers[key];
    const corr = correctAnswers[key];
    if (i >= 1 && i <= 12) {
      if (!corr) continue;
      if (userAns && String(userAns).toUpperCase() === String(corr).toUpperCase()) totalScore += 0.25;
    } else if (i >= 13 && i <= 16) {
      if (!Array.isArray(corr) || !Array.isArray(userAns)) continue;
      let correctCount = 0;
      for (let j = 0; j < corr.length && j < userAns.length; j++) {
        const exp = String(corr[j]).toLowerCase();
        const u = String(userAns[j]).toLowerCase();
        if (u && (u === exp || (exp.startsWith('t') && u.startsWith('t')) || (exp.startsWith('đ') && u.startsWith('đ')))) {
          correctCount++;
        }
      }
      if (correctCount === 1) totalScore += 0.1;
      else if (correctCount === 2) totalScore += 0.25;
      else if (correctCount === 3) totalScore += 0.5;
      else if (correctCount === 4) totalScore += 1;
    } else if (i >= 17 && i <= 22) {
      if (typeof corr === 'undefined') continue;
      const userNum = parseFloat((userAns || '').toString().replace(',', '.'));
      const corrNum = parseFloat((corr || '').toString().replace(',', '.'));
      if (!isNaN(userNum) && !isNaN(corrNum)) {
        if (Math.abs(userNum - corrNum) < 0.001) totalScore += 0.5;
      } else {
        if ((userAns || '').toString().trim().toLowerCase() === (corr || '').toString().trim().toLowerCase()) {
          totalScore += 0.5;
        }
      }
    }
  }

  let box = document.getElementById('score-result');
  if (!box) {
    box = document.createElement('div');
    box.id = 'score-result';
    box.style.cssText = 'position:fixed; bottom:15px; right:15px; background:rgba(0,0,0,0.8); color:#fff; padding:10px 14px; border-radius:8px; z-index:99999; font-size:16px;';
    document.body.appendChild(box);
  }
  box.innerHTML = `📊 Tổng điểm của bạn: <b>${totalScore.toFixed(2)}</b> / 10`;

  try { playSound(totalScore >= 5 ? "../audio/correct.mp3" : "../audio/wrong.mp3"); } catch(e){}
  if (typeof saveAttempt === 'function') {
    saveAttempt(document.title || 'de1', { studentAnswers, correctAnswers }, totalScore.toFixed(2));
  }
  console.log('=== correctAnswers ===', correctAnswers);
  console.log('=== studentAnswers ===', studentAnswers);
  console.log('=== totalScore ===', totalScore);
  window.isScoreCalculated = true;
}

document.getElementById('scoreBtn')?.addEventListener('click', calculateScore);
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// === CẤU HÌNH FIREBASE ===
const firebaseConfig = {
  apiKey: "AIzaSyDDACFZgZazMOnjzmGM_lrKswVcsoTFHxA",
  authDomain: "veonline-3bcbf.firebaseapp.com",
  projectId: "veonline-3bcbf",
  storageBucket: "veonline-3bcbf.appspot.com",
  messagingSenderId: "83902304195",
  appId: "1:83902304195:web:2f9ec1ee0c23d6e21bb776"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// === XỬ LÝ ĐĂNG NHẬP ===
const codeForm = document.getElementById('code-login-form');
if (codeForm) {
  codeForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const code = document.getElementById('login-code').value.trim();
    const name = document.getElementById('student-name').value.trim();

    try {
      const codesRef = collection(db, "codes");
      const q = query(codesRef, where("code", "==", code));
      const querySnapshot = await getDocs(q);

      if (!querySnapshot.empty) {
        localStorage.setItem("studentCode", code);
        localStorage.setItem("studentName", name);
        document.getElementById('login-modal').style.display = 'none';
        alert('✅ Đăng nhập thành công!');
      } else {
        alert('❌ Mã không hợp lệ!');
      }
    } catch (err) {
      alert('❌ Lỗi: ' + err.message);
    }
  });
}

document.getElementById('loginBtn')?.addEventListener('click', (e) => {
  e.preventDefault();
  const studentCode = localStorage.getItem("studentCode");
  if (studentCode) {
    localStorage.removeItem("studentCode");
    localStorage.removeItem("studentName");
    alert('Đã đăng xuất');
  } else {
    document.getElementById('login-modal').style.display = 'flex';
  }
});

document.getElementById('close-modal')?.addEventListener('click', () => {
  document.getElementById('login-modal').style.display = 'none';
});

// === LƯU KẾT QUẢ LÀM BÀI (CÓ CHI TIẾT) ===

window.saveAttempt = async function saveAttempt(testId, detailsOrScore, maybeScore) {
  const code = localStorage.getItem("studentCode");
  const name = localStorage.getItem("studentName");
  if (!code || !name) {
    alert("⚠️ Vui lòng đăng nhập trước khi lưu!");
    return;
  }

  let answers = {};
  let totalScore = 0;

  // Nhận dạng cách gọi
  if (typeof detailsOrScore === "object" && maybeScore !== undefined) {
    // Gọi dạng: saveAttempt(testId, { studentAnswers, correctAnswers }, totalScore)
    answers = detailsOrScore.studentAnswers || {};
    totalScore = parseFloat(maybeScore);
  } else {
    // Gọi dạng: saveAttempt(testId, totalScore)
    totalScore = parseFloat(detailsOrScore);
  }

  try {
    await addDoc(collection(db, "attempts"), {
      code,
      name,
      testId,
      score: totalScore,         // ✅ Ghi rõ cột điểm tổng kết
      answers,                   // Có thể bỏ nếu không cần chi tiết
      createdAt: serverTimestamp()
    });
    console.log("✅ Đã lưu điểm:", totalScore);
  } catch (err) {
    console.error("❌ Lỗi lưu:", err);
  }
}

// Override checkAnswer, checkTrueFalseAnswer, checkShortAnswer to lock and optionally savePartial
window.checkAnswer = function(qid, correct) {
  // Xóa icon cũ
  document.querySelectorAll(`#${qid} .option-icon`).forEach(el => el.textContent = '');

  // Lấy lựa chọn
  const chosen = document.querySelector(`input[name="${qid}"]:checked`);
  if (!chosen) {
    alert("Hãy chọn một đáp án!");
    playSound("../audio/wrong.mp3");
    return;
  }

  const chosenVal = chosen.value;
  const iconId = `icon-${qid}-${chosenVal}`;

  // Hiển thị đúng/sai + phát âm thanh
  if (chosenVal === correct) {
    const el = document.getElementById(iconId);
    if (el) el.textContent = '✅';
    playSound("../audio/correct.mp3");
    // khóa lựa chọn
    document.querySelectorAll(`input[name="${qid}"]`).forEach(el=>el.disabled=true);
    if (isLoggedIn()) {
      try { savePartial(qid, chosenVal, correct, true); } catch(e){}
    }
  } else {
    const el = document.getElementById(iconId);
    if (el) el.textContent = '❌';
    const corrEl = document.getElementById(`icon-${qid}-${correct}`);
    if (corrEl) corrEl.textContent = '✅';
    playSound("../audio/wrong.mp3");
    document.querySelectorAll(`input[name="${qid}"]`).forEach(el=>el.disabled=true);
    if (isLoggedIn()) {
      try { savePartial(qid, chosenVal, correct, false); } catch(e){}
    }
  }
};

// Override checkTrueFalseAnswer
window.checkTrueFalseAnswer = function(questionId, correctAnswers) {
  if(typeof correctAnswers === 'string'){
    try{ correctAnswers = JSON.parse(correctAnswers); }
    catch(e){ 
      correctAnswers = correctAnswers.replace(/^\[|\]$/g,'').split(',').map(s=>s.trim().replace(/^["']|["']$/g,'')); 
    }
  }
  if(!Array.isArray(correctAnswers)) return console.warn('Invalid correctAnswers for', questionId);

  const container = document.getElementById(questionId);
  if(!container){ console.warn('No container', questionId); return; }

  const optionRows = container.querySelectorAll(".option-row");
  let allCorrect = true;
  let feedbackHtml = '';

  optionRows.forEach((row, idx) => {
    const radios = row.querySelectorAll("input[type='radio']");
    let selected = null;
    radios.forEach(r => { if (r.checked) selected = r.value; });

    const expected = (correctAnswers[idx] && String(correctAnswers[idx]).toLowerCase().startsWith('t')) ? 'True' : 'False';
    const letter = String.fromCharCode(97 + idx); // a, b, c, d

    if (selected === null) {
      feedbackHtml += `Mệnh đề ${letter}) ⭕ Chưa chọn<br>`;
      allCorrect = false;
    } else if (selected === expected) {
      feedbackHtml += `Mệnh đề ${letter}) ✅ Đúng<br>`;
      const icon = row.querySelector('.option-icon');
      if(icon) icon.textContent = '✅';
    } else {
      feedbackHtml += `Mệnh đề ${letter}) ❌ Sai (chọn ${selected})<br>`;
      const icon = row.querySelector('.option-icon');
      if(icon) icon.textContent = '❌';
      allCorrect = false;
    }
  });

  let resultBox = container.querySelector(".answer-check .result");
  if(!resultBox){
    resultBox = document.createElement('div');
    resultBox.className = 'result';
    resultBox.style.marginTop = '8px';
    resultBox.style.padding = '8px';
    resultBox.style.background = 'rgba(255,255,255,0.06)';
    resultBox.style.borderRadius = '6px';
    container.querySelector(".answer-check").appendChild(resultBox);
  }
  resultBox.innerHTML = feedbackHtml;

  // khóa inputs của câu này
  container.querySelectorAll("input[type='radio']").forEach(r=>r.disabled=true);

  // lưu partial từng mệnh đề nếu đăng nhập
  if (isLoggedIn()) {
    optionRows.forEach((row, idx) => {
      const sel = row.querySelector("input[type='radio']:checked");
      const user = sel ? sel.value : '';
      const expected = (correctAnswers[idx] && String(correctAnswers[idx]).toLowerCase().startsWith('t')) ? 'True' : 'False';
      try { savePartial(questionId + '_' + idx, user, expected, user === expected); } catch(e){}
    });
  }

  if(allCorrect) playSound('../audio/correct.mp3'); else playSound('../audio/wrong.mp3');
};

// Override checkShortAnswer
window.checkShortAnswer = function(qid, correct) {
  const input = document.getElementById(`input-${qid}`);
  const icon = document.getElementById(`icon-${qid}`);
  const resultBox = input?.closest(".answer-check");

  if (!input) return;

  const userAnswer = input.value.trim();

  // Tạo vùng thông báo nếu chưa có
  let feedback = resultBox.querySelector(".result");
  if (!feedback) {
    feedback = document.createElement("div");
    feedback.className = "result";
    feedback.style.marginTop = "6px";
    feedback.style.padding = "6px";
    feedback.style.borderRadius = "6px";
    feedback.style.fontSize = "0.95em";
    resultBox.appendChild(feedback);
  }

  if (userAnswer === "") {
    icon.textContent = "⚠️";
    feedback.innerHTML = "❗ <b>Báo thầy kiểm trực tiếp vì chưa giải.</b>";
    playSound("../audio/wrong.mp3");
    return;
  }

  if (userAnswer.toLowerCase() === correct.trim().toLowerCase()) {
    icon.textContent = "✅";
    feedback.innerHTML = "🎯 <b>Đúng rồi!</b>";
    input.disabled = true;
    if (isLoggedIn()) {
      try { savePartial(qid, userAnswer, correct, true); }catch(e){}
    }
    playSound("../audio/correct.mp3");
  } else {
    icon.textContent = "❌";
    feedback.innerHTML = `❌ Sai rồi. Đáp án đúng là: <b>${correct}</b>`;
    input.disabled = true;
    if (isLoggedIn()) {
      try { savePartial(qid, userAnswer, correct, false); }catch(e){}
    }
    playSound("../audio/wrong.mp3");
  }
};

// Override calculateScore: only save if logged in
if (typeof window.isScoreCalculated === 'undefined') window.isScoreCalculated = false;
window.calculateScore = function() {
  if (window.isScoreCalculated) return;
  const studentAnswers = {};
  const correctAnswers = {};
  let totalScore = 0;

  // gather correct answers from onclicks or data-correct
  document.querySelectorAll('.question').forEach(q => {
    const qid = q.id;
    if (!qid) return;
    const btn = q.querySelector('button[onclick*="check"]');
    const onclickStr = btn ? (btn.getAttribute('onclick') || '') : '';

    if (onclickStr.includes('checkTrueFalseAnswer')) {
      const arrMatch = onclickStr.match(/\[(.*?)\]/);
      if (arrMatch) {
        const arr = arrMatch[1].split(',').map(s => s.replace(/['"\s\[\]]/g, '').trim());
        if (arr.length) correctAnswers[qid] = arr;
      }
    } else if (onclickStr.includes('checkShortAnswer')) {
      const m = onclickStr.match(/checkShortAnswer\(['"]([^'"]+)['"]\s*,\s*['"]([^'"]+)['"]\)/);
      if (m) correctAnswers[m[1]] = m[2];
    } else if (onclickStr.includes('checkAnswer')) {
      const m = onclickStr.match(/checkAnswer\(['"]([^'"]+)['"]\s*,\s*['"]([A-Za-z0-9]+)['"]\)/);
      if (m) correctAnswers[m[1]] = m[2].toString().toUpperCase();
    }

    // fallback data-correct
    if (!correctAnswers[qid]) {
      const dataCorrect = q.getAttribute('data-correct');
      if (dataCorrect) {
        try { correctAnswers[qid] = JSON.parse(dataCorrect); } catch(e) { correctAnswers[qid] = dataCorrect; }
      }
    }
  });

  for (let i = 1; i <= 12; i++) {
    const name = 'q' + i;
    const selected = document.querySelector(`input[name="${name}"]:checked`);
    studentAnswers[name] = selected ? selected.value.trim() : '';
  }

  for (let i = 13; i <= 16; i++) {
    const sub = [];
    ['a','b','c','d'].forEach(letter => {
      const sel = document.querySelector(`input[name="q${i}${letter}"]:checked`);
      sub.push(sel ? sel.value.trim() : '');
    });
    studentAnswers['q' + i] = sub;
  }

  for (let i = 17; i <= 22; i++) {
    const el = document.getElementById(`input-q${i}`);
    studentAnswers['q' + i] = el ? el.value.trim().replace(',', '.') : '';
  }

  for (let i = 1; i <= 22; i++) {
    const key = 'q' + i;
    const userAns = studentAnswers[key];
    const corr = correctAnswers[key];
    if (i >= 1 && i <= 12) {
      if (!corr) continue;
      if (userAns && String(userAns).toUpperCase() === String(corr).toUpperCase()) totalScore += 0.25;
    } else if (i >= 13 && i <= 16) {
      if (!Array.isArray(corr) || !Array.isArray(userAns)) continue;
      let correctCount = 0;
      for (let j = 0; j < corr.length && j < userAns.length; j++) {
        const exp = String(corr[j]).toLowerCase();
        const u = String(userAns[j]).toLowerCase();
        if (u && (u === exp || (exp.startsWith('t') && u.startsWith('t')) || (exp.startsWith('đ') && u.startsWith('đ')))) {
          correctCount++;
        }
      }
      if (correctCount === 1) totalScore += 0.1;
      else if (correctCount === 2) totalScore += 0.25;
      else if (correctCount === 3) totalScore += 0.5;
      else if (correctCount === 4) totalScore += 1;
    } else if (i >= 17 && i <= 22) {
      if (typeof corr === 'undefined') continue;
      const userNum = parseFloat((userAns || '').toString().replace(',', '.'));
      const corrNum = parseFloat((corr || '').toString().replace(',', '.'));
      if (!isNaN(userNum) && !isNaN(corrNum)) {
        if (Math.abs(userNum - corrNum) < 0.001) totalScore += 0.5;
      } else {
        if ((userAns || '').toString().trim().toLowerCase() === (corr || '').toString().trim().toLowerCase()) {
          totalScore += 0.5;
        }
      }
    }
  }

  let box = document.getElementById('score-result');
  if (!box) {
    box = document.createElement('div');
    box.id = 'score-result';
    box.style.cssText = 'position:fixed; bottom:15px; right:15px; background:rgba(0,0,0,0.8); color:#fff; padding:10px 14px; border-radius:8px; z-index:99999; font-size:16px;';
    document.body.appendChild(box);
  }
  box.innerHTML = `📊 Tổng điểm của bạn: <b>${totalScore.toFixed(2)}</b> / 10`;

  try { playSound(totalScore >= 5 ? "../audio/correct.mp3" : "../audio/wrong.mp3"); } catch(e){}
  if (isLoggedIn() && typeof saveAttempt === 'function') {
    saveAttempt(document.title || 'de1', { studentAnswers, correctAnswers }, totalScore.toFixed(2));
    box.innerHTML += '<br/><small style="opacity:0.95">✅ Kết quả đã lưu (tài khoản đăng nhập)</small>';
  } else {
    box.innerHTML += '<br/><small style="opacity:0.8">ℹ️ Chưa đăng nhập — kết quả chỉ hiển thị trên trình duyệt.</small>';
  }
  console.log('=== correctAnswers ===', correctAnswers);
  console.log('=== studentAnswers ===', studentAnswers);
  console.log('=== totalScore ===', totalScore);
  window.isScoreCalculated = true;
};

document.getElementById('scoreBtn')?.addEventListener('click', () => {
  // reset flag to allow re-calc during testing if desired
  window.isScoreCalculated = false;
  window.calculateScore();
});
</script>
<!-- Bảng theo dõi học sinh real-time -->
<div id="teacher-monitor" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 30px rgba(0,0,0,0.5); z-index: 20000; width: 90vw; height: 80vh; overflow: auto;">
    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">📊 Bảng theo dõi học sinh - REAL TIME</h3>
        <button onclick="closeMonitor()" style="background: #ff4757; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-left: auto;">✕ Đóng</button>
    </div>
    
    <div style="margin-bottom: 15px;">
        <strong>Mã lớp:</strong> <code id="monitor-session-code"></code>
        <span style="margin-left: 20px;">
            <strong>Học sinh online:</strong> <span id="live-student-count">0</span>
        </span>
    </div>

    <!-- Bộ lọc và tìm kiếm -->
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <input type="text" id="search-student" placeholder="🔍 Tìm học sinh..." style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; flex: 1;">
        <select id="filter-status" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            <option value="all">Tất cả trạng thái</option>
            <option value="active">Đang làm bài</option>
            <option value="finished">Đã hoàn thành</option>
            <option value="not-started">Chưa bắt đầu</option>
        </select>
    </div>

    <!-- Bảng kết quả -->
    <div class="table-container" style="max-height: 60vh; overflow-y: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
            <thead style="background: #f8f9fa; position: sticky; top: 0;">
                <tr>
                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Học sinh</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">Trạng thái</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">Điểm số</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">Thời gian</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">Chi tiết</th>
                </tr>
            </thead>
            <tbody id="student-results-body">
                <!-- Dữ liệu sẽ được cập nhật real-time -->
            </tbody>
        </table>
    </div>

    <!-- Thống kê tổng quan -->
    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <h4 style="margin-top: 0;">📈 Thống kê tổng quan</h4>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #17a2b8;" id="stats-total">0</div>
                <div style="font-size: 12px; color: #6c757d;">Tổng số HS</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="stats-completed">0</div>
                <div style="font-size: 12px; color: #6c757d;">Đã hoàn thành</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #ffc107;" id="stats-average">0.0</div>
                <div style="font-size: 12px; color: #6c757d;">Điểm TB</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #dc3545;" id="stats-failed">0</div>
                <div style="font-size: 12px; color: #6c757d;">Dưới 5 điểm</div>
            </div>
        </div>
    </div>
</div>

<!-- Nút mở bảng theo dõi (cho giáo viên) -->
<button id="toggle-monitor" style="position: fixed; bottom: 20px; left: 20px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 12px 18px; border-radius: 25px; cursor: pointer; z-index: 9999; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
    👁️ Theo dõi HS
</button>

<script>
// =====================
// THEO DÕI HỌC SINH REAL-TIME
// =====================
let monitorStudents = new Map();

function setupStudentMonitoring() {
    const monitorBtn = document.getElementById('toggle-monitor');
    if (monitorBtn) {
        monitorBtn.addEventListener('click', toggleMonitor);
    }

    // Lắng nghe kết quả làm bài real-time
    const attemptsRef = collection(db, 'attempts');
    const q = query(attemptsRef, where('testId', '==', document.title || 'de1'));
    
    onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            const data = change.doc.data();
            const studentId = data.code;
            
            if (change.type === 'added' || change.type === 'modified') {
                // Cập nhật thông tin học sinh
                monitorStudents.set(studentId, {
                    id: studentId,
                    name: data.name || 'Chưa đặt tên',
                    score: parseFloat(data.score) || 0,
                    status: data.score !== undefined ? 'finished' : 'active',
                    timestamp: data.createdAt?.toDate() || new Date(),
                    answers: data.answers || {},
                    lastActivity: new Date()
                });
            } else if (change.type === 'removed') {
                monitorStudents.delete(studentId);
            }
        });
        
        updateMonitorDisplay();
        updateStatistics();
    });

    // Lắng nghe hoạt động real-time của học sinh
    setupActivityTracking();
}

function setupActivityTracking() {
    // Theo dõi khi học sinh tương tác với câu hỏi
    const activityRef = collection(db, 'classSessions', currentSessionId, 'activities');
    
    onSnapshot(activityRef, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            if (change.type === 'added') {
                const data = change.doc.data();
                updateStudentActivity(data.studentId, data.questionId, data.action);
            }
        });
    });
}

function updateStudentActivity(studentId, questionId, action) {
    if (!monitorStudents.has(studentId)) {
        monitorStudents.set(studentId, {
            id: studentId,
            name: 'Học sinh mới',
            score: 0,
            status: 'active',
            timestamp: new Date(),
            answers: {},
            lastActivity: new Date(),
            currentQuestion: questionId
        });
    }
    
    const student = monitorStudents.get(studentId);
    student.lastActivity = new Date();
    student.currentQuestion = questionId;
    
    if (action === 'answer') {
        student.answers[questionId] = 'answered';
    }
    
    updateMonitorDisplay();
}

function updateMonitorDisplay() {
    const tbody = document.getElementById('student-results-body');
    if (!tbody) return;
    
    const searchTerm = document.getElementById('search-student')?.value.toLowerCase() || '';
    const filterStatus = document.getElementById('filter-status')?.value || 'all';
    
    let html = '';
    let displayedCount = 0;
    
    monitorStudents.forEach((student) => {
        // Lọc theo tìm kiếm
        if (searchTerm && !student.name.toLowerCase().includes(searchTerm)) {
            return;
        }
        
        // Lọc theo trạng thái
        if (filterStatus !== 'all' && student.status !== filterStatus) {
            return;
        }
        
        displayedCount++;
        
        const statusBadge = getStatusBadge(student.status);
        const scoreDisplay = student.score > 0 ? student.score.toFixed(2) : '-';
        const timeAgo = getTimeAgo(student.lastActivity);
        
        html += `
            <tr style="border-bottom: 1px solid #dee2e6;">
                <td style="padding: 12px;">
                    <strong>${escapeHtml(student.name)}</strong><br>
                    <small style="color: #6c757d;">ID: ${student.id}</small>
                </td>
                <td style="padding: 12px; text-align: center;">
                    ${statusBadge}
                    ${student.currentQuestion ? `<br><small>Đang làm: ${student.currentQuestion}</small>` : ''}
                </td>
                <td style="padding: 12px; text-align: center; font-weight: bold; color: ${getScoreColor(student.score)}">
                    ${scoreDisplay}
                </td>
                <td style="padding: 12px; text-align: center;">
                    ${timeAgo}
                </td>
                <td style="padding: 12px; text-align: center;">
                    <button onclick="viewStudentDetails('${student.id}')" style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                        👁️ Chi tiết
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html || '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #6c757d;">Chưa có học sinh nào tham gia</td></tr>';
    
    // Cập nhật số lượng học sinh online
    document.getElementById('live-student-count').textContent = displayedCount;
}

function updateStatistics() {
    const students = Array.from(monitorStudents.values());
    const total = students.length;
    const completed = students.filter(s => s.status === 'finished').length;
    const average = total > 0 ? students.reduce((sum, s) => sum + (s.score || 0), 0) / total : 0;
    const failed = students.filter(s => s.score < 5).length;
    
    document.getElementById('stats-total').textContent = total;
    document.getElementById('stats-completed').textContent = completed;
    document.getElementById('stats-average').textContent = average.toFixed(1);
    document.getElementById('stats-failed').textContent = failed;
}

function getStatusBadge(status) {
    const badges = {
        'active': '<span style="background: #ffc107; color: #000; padding: 4px 8px; border-radius: 12px; font-size: 12px;">🟡 Đang làm</span>',
        'finished': '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">✅ Hoàn thành</span>',
        'not-started': '<span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">⚫ Chưa bắt đầu</span>'
    };
    return badges[status] || badges['not-started'];
}

function getScoreColor(score) {
    if (score >= 8) return '#28a745';
    if (score >= 5) return '#ffc107';
    return '#dc3545';
}

function getTimeAgo(timestamp) {
    const now = new Date();
    const diffMs = now - timestamp;
    const diffMins = Math.floor(diffMs / 60000);
    
    if (diffMins < 1) return 'Vừa xong';
    if (diffMins < 60) return `${diffMins} phút trước`;
    
    const diffHours = Math.floor(diffMins / 60);
    return `${diffHours} giờ trước`;
}

function toggleMonitor() {
    const monitor = document.getElementById('teacher-monitor');
    if (monitor.style.display === 'none') {
        monitor.style.display = 'block';
        document.getElementById('monitor-session-code').textContent = currentSessionId;
        updateMonitorDisplay();
        updateStatistics();
    } else {
        monitor.style.display = 'none';
    }
}

function closeMonitor() {
    document.getElementById('teacher-monitor').style.display = 'none';
}

function viewStudentDetails(studentId) {
    const student = monitorStudents.get(studentId);
    if (!student) return;
    
    alert(`
Chi tiết học sinh:
📛 Tên: ${student.name}
🎯 Mã: ${student.id}
📊 Điểm: ${student.score || 'Chưa có'}
📝 Trạng thái: ${student.status === 'finished' ? 'Đã hoàn thành' : 'Đang làm bài'}
⏰ Hoạt động cuối: ${student.lastActivity.toLocaleTimeString()}

Câu hỏi đã làm: ${Object.keys(student.answers).length}
    `);
}

// Thêm sự kiện tìm kiếm và lọc
document.addEventListener('DOMContentLoaded', function() {
    // Tìm kiếm học sinh
    const searchInput = document.getElementById('search-student');
    if (searchInput) {
        searchInput.addEventListener('input', updateMonitorDisplay);
    }
    
    // Lọc trạng thái
    const filterSelect = document.getElementById('filter-status');
    if (filterSelect) {
        filterSelect.addEventListener('change', updateMonitorDisplay);
    }
});

// Khởi tạo monitoring khi trang load
setTimeout(() => {
    setupStudentMonitoring();
}, 2000);

// Hàm escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Make functions globally available
window.toggleMonitor = toggleMonitor;
window.closeMonitor = closeMonitor;
window.viewStudentDetails = viewStudentDetails;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<title>B√ÄI GI·∫¢NG TO√ÅN - CHUY√äN ƒê·ªÄ</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta name="description" content="Trang b√†i gi·∫£ng To√°n chuy√™n ƒë·ªÅ - L·ªõp To√°n Th·∫ßy B√¨nh">
<meta name="keywords" content="to√°n, b√†i gi·∫£ng, chuy√™n ƒë·ªÅ, l·ªõp 12, √¥n thi">

<!-- MathJax -->
<script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']]
      },
      svg: { fontCache: 'global' },
      startup: {
        ready: function () {
          MathJax.startup.defaultReady();
          MathJax.startup.promise.then(() => {
            console.log('MathJax ready');
          });
        }
      }
    };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<style>
/* ===== RESET & BASE ===== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #333;
    min-height: 100vh;
}

/* ===== TOPBAR ===== */
.topbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 70px;
    background: linear-gradient(135deg, #1a237e, #283593);
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    z-index: 10000;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border-bottom: 3px solid #3949ab;
}

.topbar-title {
    font-size: 1.2rem;
    font-weight: bold;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 40%;
}

.topbar-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: nowrap;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.topbar-controls select,
.topbar-controls button {
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    background: rgba(255,255,255,0.15);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    border: 1px solid rgba(255,255,255,0.1);
    white-space: nowrap;
    font-size: 0.9rem;
    min-height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.topbar-controls select:hover,
.topbar-controls button:hover {
    background: rgba(255,255,255,0.25);
}

.topbar-controls select:active,
.topbar-controls button:active {
    transform: translateY(1px);
}

.topbar-controls select option {
    background: #283593;
    color: white;
}

#lessonSelector {
    min-width: 140px;
    max-width: 160px;
    font-size: 0.85rem;
}

/* ===== SCROLL PROGRESS ===== */
.scroll-progress {
    position: fixed;
    top: 70px;
    left: 0;
    width: 100%;
    height: 3px;
    background: #e0e0e0;
    z-index: 9999;
}

.scroll-progress-bar {
    height: 100%;
    background: linear-gradient(135deg, #1a237e, #3949ab);
    width: 0%;
    transition: width 0.3s ease;
}

/* ===== PAGE CONTAINER ===== */
.page-container {
    position: fixed;
    top: 73px;
    left: 0;
    right: 0;
    bottom: 0;
    background: white;
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -5px 30px rgba(0,0,0,0.1);
    overflow-y: auto;
    padding: 15px;
    z-index: 1;
    -webkit-overflow-scrolling: touch;
}

/* ===== SLIDES CONTAINER ===== */
.slides {
    font-size: 1.1rem;
    color: #2c3e50;
    max-width: 1200px;
    margin: 0 auto;
    padding-bottom: 50px;
}

/* ===== CHUY√äN ƒê·ªÄ STYLES ===== */
.slide-section {
    padding: 25px;
    margin-bottom: 20px;
    background: linear-gradient(135deg, #f8f9ff 0%, #eef1ff 100%);
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    border-left: 5px solid transparent;
}

.slide-section.active-section {
    background: linear-gradient(135deg, #f0f2ff 0%, #e6e9ff 100%);
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    border-left: 6px solid #ffd54f;
}

.slide-section h2 {
    color: #1a237e;
    margin-bottom: 25px;
    border-bottom: 3px solid #1a237e;
    padding-bottom: 15px;
    font-weight: 800;
    font-size: 1.8rem;
    word-wrap: break-word;
}

.slide-section h3 {
    color: #3949ab;
    margin: 20px 0 15px 0;
    font-weight: 700;
    font-size: 1.5rem;
}

.slide-section h4 {
    color: #4d5cb6;
    margin: 15px 0 12px 0;
    font-weight: 600;
    font-size: 1.2rem;
}

.slide-section p, .slide-section li {
    color: #34495e;
    line-height: 1.7;
    margin-bottom: 15px;
    font-size: 1.05rem;
    word-wrap: break-word;
}

/* ===== SECTION TYPE STYLES ===== */
.theory-section {
    background: linear-gradient(135deg, #f0f7ff 0%, #e6f0ff 100%) !important;
    border-left: 6px solid #4dabf7 !important;
}

.problem-type-section {
    background: linear-gradient(135deg, #f0fff4 0%, #e6ffe6 100%) !important;
    border-left: 6px solid #28a745 !important;
}

.practice-section {
    background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%) !important;
    border-left: 6px solid #dc3545 !important;
}

/* ===== L√ù THUY·∫æT COMPONENTS ===== */
.definition-box, .theorem-box, .note-box {
    margin: 20px 0;
    padding: 20px;
    background: white;
    border-radius: 12px;
    border-left: 5px solid;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}

.definition-box {
    border-left-color: #17a2b8;
    background: #e8f4f8 !important;
}

.theorem-box {
    border-left-color: #1c7ed6;
    background: #e8f4f8 !important;
}

.note-box {
    border-left-color: #ffc107;
    background: #fff3cd !important;
}

.definition-box h4, .theorem-box h4, .note-box h4 {
    color: inherit !important;
    margin-top: 0 !important;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* ===== FORMULA BOX ===== */
.formula-box {
    text-align: center;
    margin: 15px 0;
    padding: 20px;
    background: white;
    border-radius: 10px;
    border: 2px solid #4dabf7;
    overflow-x: auto;
    font-size: 1.1em;
}

/* ===== D·∫†NG TO√ÅN COMPONENTS ===== */
.problem-type-box {
    margin: 25px 0;
    padding: 25px;
    background: white;
    border-radius: 15px;
    border-left: 6px solid #28a745;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.method-step {
    margin: 12px 0;
    padding: 12px 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #4dabf7;
    counter-increment: step;
}

.method-step::before {
    content: counter(step) ". ";
    font-weight: bold;
    color: #1a237e;
    margin-right: 8px;
}

.example-box {
    margin: 20px 0;
    padding: 20px;
    background: #fff3cd;
    border-radius: 12px;
    border: 2px solid #ffc107;
}

.example-question {
    font-weight: bold;
    color: #856404;
    margin-bottom: 10px;
    font-size: 1.1em;
}

.example-solution {
    color: #666;
    padding-left: 20px;
    border-left: 3px solid #28a745;
}

/* ===== B√ÄI T·∫¨P COMPONENTS ===== */
.practice-box {
    margin: 30px 0;
    padding: 25px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    border-left: 6px solid #dc3545;
}

.quiz-title {
    color: #1a237e;
    font-size: 1.4rem;
    font-weight: 700;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #1a237e;
    display: flex;
    align-items: center;
    gap: 12px;
}

/* ===== QUESTION STYLES ===== */
.question {
    margin: 25px 0;
    padding: 20px;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
    border-radius: 15px;
    border-left: 6px solid #1a237e;
    color: #2c3e50;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.question-header {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    margin-bottom: 20px;
}

.question-number {
    background: #1a237e;
    color: white;
    min-width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.1em;
    flex-shrink: 0;
}

.question-content {
    flex: 1;
    font-weight: 600;
    color: #1a237e;
    font-size: 1.1em;
    line-height: 1.6;
}

/* ===== IMAGE STYLES ===== */
.question-image {
    max-width: 100%;
    height: auto;
    border-radius: 12px;
    margin: 20px 0;
    display: block;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    border: 2px solid #e0e0e0;
}

.image-container {
    text-align: center;
    margin: 25px 0;
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
}

.image-caption {
    font-style: italic;
    color: #666;
    margin-top: 10px;
    font-size: 0.95rem;
}

/* ===== OPTION STYLES ===== */
.option-row {
    margin: 12px 0;
    padding: 15px 20px;
    background: white;
    border-radius: 12px;
    color: #2c3e50;
    border: 2px solid #e0e0e0;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    cursor: pointer;
    min-height: 60px;
    touch-action: manipulation;
}

.option-row:hover {
    border-color: #1a237e;
    background: #f8f9ff;
}

.option-row:active {
    background: #e8f4f8;
    border-color: #17a2b8;
    transform: translateX(5px);
}

.option-label {
    background: #f0f0f0;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-weight: bold;
    font-size: 1.1em;
    flex-shrink: 0;
}

.option-text {
    flex: 1;
    font-weight: 500;
    font-size: 1.05rem;
}

/* ===== TRUE/FALSE STATEMENTS ===== */
.statement-list {
    margin: 25px 0;
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}

.statement-item {
    margin: 18px 0;
    padding: 18px;
    background: #f8f9fa;
    border-radius: 10px;
    border-left: 4px solid #e0e0e0;
}

.statement-text {
    margin-bottom: 15px;
    font-weight: 500;
    color: #2c3e50;
    font-size: 1.05em;
    line-height: 1.6;
}

.statement-controls {
    display: flex;
    gap: 15px;
}

.tf-option {
    padding: 12px 20px;
    border: 2px solid #ddd;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
    flex: 1;
    text-align: center;
    font-weight: 600;
    font-size: 1em;
}

.tf-option:hover {
    background: #f0f0f0;
    transform: translateY(-2px);
}

.tf-option.selected-true {
    background: #d4edda;
    border-color: #28a745;
    color: #155724;
    box-shadow: 0 4px 10px rgba(40, 167, 69, 0.2);
}

.tf-option.selected-false {
    background: #f8d7da;
    border-color: #dc3545;
    color: #721c24;
    box-shadow: 0 4px 10px rgba(220, 53, 69, 0.2);
}

/* ===== ANSWER INPUT ===== */
.answer-input {
    width: 100%;
    padding: 15px;
    border: 2px solid #ddd;
    border-radius: 10px;
    background: white;
    color: #2c3e50;
    font-size: 1.05rem;
    transition: all 0.3s ease;
    min-height: 50px;
    margin: 20px 0;
    font-family: inherit;
}

.answer-input:focus {
    outline: none;
    border-color: #1a237e;
    box-shadow: 0 0 0 4px rgba(26, 35, 126, 0.1);
}

/* ===== CHECK BUTTON ===== */
.check-btn {
    padding: 15px 25px;
    background: linear-gradient(135deg, #1a237e, #3949ab);
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1.05rem;
    transition: all 0.3s ease;
    min-height: 50px;
    margin-top: 15px;
    display: inline-flex;
    align-items: center;
    gap: 10px;
}

.check-btn:hover {
    background: linear-gradient(135deg, #3949ab, #1a237e);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(26, 35, 126, 0.3);
}

.check-btn:active {
    transform: translateY(0);
}

/* ===== RESULT DISPLAY ===== */
.result-display {
    margin-top: 20px;
    padding: 15px;
    border-radius: 10px;
    font-weight: 600;
    display: none;
}

.result-correct {
    background: #d4edda;
    border: 2px solid #28a745;
    color: #155724;
}

.result-incorrect {
    background: #f8d7da;
    border: 2px solid #dc3545;
    color: #721c24;
}

/* ===== SOLUTION BOX ===== */
.solution-box { 
    display: none; 
    margin-top: 25px;
    padding: 20px;
    background: #e8f4f8;
    border-radius: 12px;
    border-left: 5px solid #17a2b8;
    animation: slideIn 0.3s ease;
}

.solution-title {
    color: #1976d2;
    font-weight: 700;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1.2rem;
}

.solution-content {
    color: #1565c0;
    line-height: 1.7;
    font-size: 1.05rem;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .topbar {
        padding: 0 15px;
        height: 60px;
    }
    
    .topbar-title {
        font-size: 1rem;
        max-width: 35%;
    }
    
    .topbar-controls {
        gap: 6px;
    }
    
    .topbar-controls select,
    .topbar-controls button {
        padding: 6px 10px;
        font-size: 0.85rem;
        min-height: 35px;
    }
    
    #lessonSelector {
        min-width: 120px;
        max-width: 140px;
    }
    
    .page-container {
        top: 63px;
        padding: 12px;
    }
    
    .scroll-progress {
        top: 60px;
    }
    
    .slides {
        font-size: 1rem;
    }
    
    .slide-section {
        padding: 18px;
        margin-bottom: 15px;
    }
    
    .slide-section h2 {
        font-size: 1.5rem;
        margin-bottom: 20px;
        padding-bottom: 12px;
    }
    
    .slide-section h3 {
        font-size: 1.3rem;
    }
    
    .slide-section h4 {
        font-size: 1.1rem;
    }
    
    .statement-controls {
        flex-direction: column;
    }
    
    .tf-option {
        width: 100%;
    }
    
    .question {
        padding: 15px;
        margin: 20px 0;
    }
    
    .question-number {
        min-width: 35px;
        height: 35px;
        font-size: 1em;
    }
    
    .option-row {
        padding: 12px 15px;
        min-height: 55px;
    }
    
    .option-label {
        width: 35px;
        height: 35px;
        margin-right: 12px;
    }
    
    .check-btn {
        padding: 12px 20px;
        font-size: 1rem;
        width: 100%;
        justify-content: center;
    }
}

/* ===== ANIMATIONS ===== */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* ===== DARK MODE ===== */
.dark-mode body {
    background: #121212 !important;
}

.dark-mode .page-container {
    background: #1e1e1e !important;
    color: #e0e0e0 !important;
}

.dark-mode .slide-section {
    background: #2d2d2d !important;
    color: #e0e0e0 !important;
}

.dark-mode .slide-section h2,
.dark-mode .slide-section h3,
.dark-mode .slide-section h4 {
    color: #bb86fc !important;
}

.dark-mode .slide-section p,
.dark-mode .slide-section li {
    color: #e0e0e0 !important;
}

.dark-mode .theory-section {
    background: #2c3e50 !important;
}

.dark-mode .problem-type-section {
    background: #1b5e20 !important;
}

.dark-mode .practice-section {
    background: #b71c1c !important;
}

.dark-mode .definition-box,
.dark-mode .theorem-box {
    background: #37474f !important;
    color: #e0e0e0 !important;
}

.dark-mode .note-box {
    background: #5d4037 !important;
    color: #ffecb3 !important;
}

.dark-mode .formula-box {
    background: #37474f !important;
    border-color: #4dabf7 !important;
    color: #e0e0e0 !important;
}

.dark-mode .question {
    background: #2d2d2d !important;
    color: #e0e0e0 !important;
}

.dark-mode .option-row {
    background: #3d3d3d !important;
    color: #e0e0e0 !important;
    border-color: #555 !important;
}

.dark-mode .statement-item {
    background: #3d3d3d !important;
}

.dark-mode .answer-input {
    background: #3d3d3d !important;
    color: #e0e0e0 !important;
    border-color: #555 !important;
}

.dark-mode .solution-box {
    background: #37474f !important;
}

/* ===== UTILITY CLASSES ===== */
.hidden {
    display: none !important;
}

.text-center {
    text-align: center;
}

.mt-20 {
    margin-top: 20px;
}

.mb-20 {
    margin-bottom: 20px;
}

.p-20 {
    padding: 20px;
}

.pulse {
    animation: pulse 0.3s ease;
}
</style>
</head>
<body>
<!-- ===== TOPBAR ===== -->
<div class="topbar">
    <div class="topbar-title">üìö L·ªõp To√°n Th·∫ßy B√¨nh</div>
    <div class="topbar-controls">
        <select id="lessonSelector">
            <option value="">üìö Ch·ªçn b√†i gi·∫£ng</option>
        </select>
        <button id="toggleDarkModeBtn">üåô Ch·∫ø ƒë·ªô t·ªëi</button>
        <button id="printBtn">üñ®Ô∏è In</button>
    </div>
</div>

<!-- Scroll Progress Bar -->
<div class="scroll-progress">
    <div class="scroll-progress-bar" id="scrollProgress"></div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay hidden">
    <div class="spinner"></div>
    <div id="loadingText">ƒêang t·∫£i...</div>
</div>

<!-- ===== MAIN CONTENT ===== -->
<div class="page-container">
    <div class="slides" id="slides-container">
        <!-- Content will be loaded here -->
    </div>
</div>

<script>
// ===== GLOBAL VARIABLES =====
let currentLesson = null;
let userAnswers = {};

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
    console.log("üöÄ H·ªá th·ªëng chuy√™n ƒë·ªÅ To√°n kh·ªüi ƒë·ªông...");
    
    showWelcomePage();
    setupEventListeners();
    loadExamList();
    setTimeout(setupScrollTracking, 100);
    showNotification('‚úÖ H·ªá th·ªëng ƒë√£ s·∫µn s√†ng!', 'info');
});

// ===== WELCOME PAGE =====
function showWelcomePage() {
    const slidesContainer = document.getElementById('slides-container');
    
    const welcomeHTML = `
        <section class="slide-section active-section" id="section-0">
            <div class="welcome-container">
                <div style="font-size: 5rem; margin-bottom: 25px; animation: pulse 2s infinite;">üßÆ</div>
                <h1 style="color: #1a237e; border: none; font-size: 2.5rem; margin-bottom: 20px; text-align: center;">
                    L·ªöP TO√ÅN TH·∫¶Y B√åNH
                </h1>
                <h3 style="color: #3949ab; margin-bottom: 30px; text-align: center; font-weight: 400;">
                    H·ªá th·ªëng h·ªçc t·∫≠p To√°n tr·ª±c tuy·∫øn chuy√™n s√¢u
                </h3>
                
                <div style="margin-top: 40px; max-width: 600px; width: 100%; margin: 0 auto;">
                    <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.1);">
                        <h4 style="color: #1a237e; margin-bottom: 20px; text-align: center;">üìö Chuy√™n ƒë·ªÅ n·ªïi b·∫≠t</h4>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin: 25px 0;">
                            <div style="flex: 1; min-width: 140px; padding: 15px; background: #f8f9ff; border-radius: 10px; text-align: center;">
                                <div style="font-size: 1.2rem; color: #1a237e; font-weight: bold;">ƒê·∫°o h√†m</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">L·ªõp 12</div>
                            </div>
                            <div style="flex: 1; min-width: 140px; padding: 15px; background: #f0fff4; border-radius: 10px; text-align: center;">
                                <div style="font-size: 1.2rem; color: #28a745; font-weight: bold;">T√≠ch ph√¢n</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">L·ªõp 12</div>
                            </div>
                            <div style="flex: 1; min-width: 140px; padding: 15px; background: #fff5f5; border-radius: 10px; text-align: center;">
                                <div style="font-size: 1.2rem; color: #dc3545; font-weight: bold;">H√¨nh h·ªçc</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">L·ªõp 12</div>
                            </div>
                        </div>
                        
                        <p style="color: #666; margin: 25px 0; text-align: center; font-size: 1.05rem;">
                            <strong>üìù H∆∞·ªõng d·∫´n:</strong> Ch·ªçn chuy√™n ƒë·ªÅ t·ª´ menu tr√™n c√πng ƒë·ªÉ b·∫Øt ƒë·∫ßu h·ªçc
                        </p>
                        
                        <button onclick="openLessonSelector()" 
                                style="padding: 15px 30px; background: linear-gradient(135deg, #1a237e, #3949ab); 
                                       color: white; border: none; border-radius: 12px; font-size: 1.1rem; 
                                       font-weight: 600; cursor: pointer; width: 100%; margin-top: 15px;">
                            üìö Ch·ªçn chuy√™n ƒë·ªÅ ƒë·ªÉ h·ªçc
                        </button>
                    </div>
                </div>
            </div>
        </section>
    `;
    
    slidesContainer.innerHTML = welcomeHTML;
}

function openLessonSelector() {
    const selector = document.getElementById('lessonSelector');
    selector.focus();
    selector.click();
}

// ===== LOAD EXAM LIST =====
async function loadExamList() {
    try {
        showLoading('ƒêang t·∫£i danh s√°ch chuy√™n ƒë·ªÅ...');
        
        const response = await fetch('exam-list.json');
        if (!response.ok) {
            throw new Error('Kh√¥ng t√¨m th·∫•y exam-list.json');
        }
        
        const data = await response.json();
        const examList = data.exams || data.lessons || data;
        
        updateLessonSelector(examList);
        showNotification(`‚úÖ ƒê√£ t·∫£i ${examList.length} chuy√™n ƒë·ªÅ`, 'success');
        
    } catch (error) {
        console.warn('Kh√¥ng th·ªÉ t·∫£i exam-list.json:', error);
        
        const examList = [
            {
                "id": "dao-ham",
                "name": "üìò Chuy√™n ƒë·ªÅ ƒê·∫°o h√†m",
                "file": "chuyen-de-dao-ham.json",
                "type": "lesson_collection"
            },
            {
                "id": "tich-phan",
                "name": "üìô Chuy√™n ƒë·ªÅ T√≠ch ph√¢n",
                "file": "chuyen-de-tich-phan.json",
                "type": "lesson_collection"
            }
        ];
        
        updateLessonSelector(examList);
        showNotification('‚ö†Ô∏è T·∫°o file "exam-list.json" ƒë·ªÉ c√≥ danh s√°ch chuy√™n ƒë·ªÅ ri√™ng', 'warning');
        
    } finally {
        hideLoading();
    }
}

function updateLessonSelector(examList) {
    const selector = document.getElementById('lessonSelector');
    if (!selector) return;
    
    while (selector.options.length > 1) {
        selector.remove(1);
    }
    
    examList.forEach((lesson, index) => {
        const option = document.createElement('option');
        const lessonName = lesson.name || lesson.title || `Chuy√™n ƒë·ªÅ ${index + 1}`;
        option.value = lesson.file || lesson.id + '.json';
        option.textContent = `${index + 1}. ${lessonName}`;
        option.dataset.type = lesson.type || 'lesson_collection';
        selector.appendChild(option);
    });
}

// ===== LOAD LESSON =====
async function loadLesson(lessonUrl) {
    try {
        showLoading('ƒêang t·∫£i chuy√™n ƒë·ªÅ...');
        
        const response = await fetch(lessonUrl);
        if (!response.ok) {
            throw new Error(`Kh√¥ng t√¨m th·∫•y file: ${lessonUrl}`);
        }
        
        const lessonData = await response.json();
        currentLesson = lessonData;
        userAnswers = {}; // Reset answers
        
        // Ki·ªÉm tra ƒë·ªãnh d·∫°ng chuy√™n ƒë·ªÅ
        if (lessonData.type === 'lesson_collection') {
            renderLessonCollection(lessonData);
        } else {
            // Fallback cho ƒë·ªãnh d·∫°ng c≈©
            renderSimpleQuestions(lessonData);
        }
        
        showNotification('‚úÖ ƒê√£ t·∫£i chuy√™n ƒë·ªÅ th√†nh c√¥ng', 'success');
        
    } catch (error) {
        console.error('L·ªói t·∫£i chuy√™n ƒë·ªÅ:', error);
        showNotification(`‚ùå L·ªói: ${error.message}`, 'error');
        showErrorPage(error.message);
    } finally {
        hideLoading();
    }
}

// ===== RENDER CHUY√äN ƒê·ªÄ M·ªöI (lesson_collection) =====
function renderLessonCollection(lessonData) {
    const slidesContainer = document.getElementById('slides-container');
    slidesContainer.innerHTML = '';
    
    // 1. Cover page
    const coverSection = document.createElement('section');
    coverSection.className = 'slide-section active-section theory-section';
    coverSection.id = 'section-0';
    
    coverSection.innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">üìò</div>
            <h1 style="color: #1a237e; border: none; font-size: 2.5em; margin-bottom: 20px;">
                ${lessonData.title || 'CHUY√äN ƒê·ªÄ TO√ÅN'}
            </h1>
            <h3 style="color: #3949ab; margin-bottom: 30px; font-weight: 400;">
                ${lessonData.description || ''}
            </h3>
            
            ${lessonData.subject ? `
                <div style="margin: 25px 0; padding: 20px; background: #f8f9fa; border-radius: 12px; display: inline-block; text-align: left;">
                    <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
                        <div>
                            <strong style="color: #1a237e;">üìö M√¥n:</strong> ${lessonData.subject}
                        </div>
                        ${lessonData.chapter ? `
                            <div>
                                <strong style="color: #1a237e;">üìñ Ch∆∞∆°ng:</strong> ${lessonData.chapter}
                            </div>
                        ` : ''}
                        ${lessonData.grade ? `
                            <div>
                                <strong style="color: #1a237e;">üéì L·ªõp:</strong> ${lessonData.grade}
                            </div>
                        ` : ''}
                    </div>
                </div>
            ` : ''}
            
            ${lessonData.sections ? `
                <div style="margin: 30px 0; padding: 25px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 600px; margin: 30px auto;">
                    <h4 style="color: #1a237e; margin-bottom: 20px; text-align: center;">üìã N·ªôi dung chuy√™n ƒë·ªÅ</h4>
                    <ul style="text-align: left; padding-left: 20px; color: #555;">
                        ${lessonData.sections.map((section, index) => `
                            <li style="margin: 10px 0; padding: 8px 0; border-bottom: 1px solid #eee;">
                                <strong>Ph·∫ßn ${index + 1}:</strong> ${section.title}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            ` : ''}
            
            <div style="margin-top: 40px;">
                <button onclick="scrollToSection(1)" 
                        style="padding: 18px 35px; background: linear-gradient(135deg, #1a237e, #3949ab); 
                               color: white; border: none; border-radius: 12px; font-size: 1.2em; 
                               font-weight: bold; cursor: pointer; box-shadow: 0 6px 20px rgba(26, 35, 126, 0.3);">
                    üöÄ B·∫Øt ƒë·∫ßu h·ªçc
                </button>
            </div>
        </div>
    `;
    
    slidesContainer.appendChild(coverSection);
    
    // 2. Render c√°c sections
    if (lessonData.sections && Array.isArray(lessonData.sections)) {
        lessonData.sections.forEach((section, sectionIndex) => {
            renderLessonSection(section, sectionIndex + 1);
        });
    }
    
    // 3. Initialize systems
    setTimeout(() => {
        if (window.MathJax) {
            MathJax.typesetPromise();
        }
        setupScrollTracking();
    }, 100);
}

function renderLessonSection(section, sectionNumber) {
    const slidesContainer = document.getElementById('slides-container');
    
    const sectionElement = document.createElement('section');
    sectionElement.className = `slide-section ${getSectionClass(section.type)}`;
    sectionElement.id = `section-${sectionNumber}`;
    
    // Th√™m s·ªë th·ª© t·ª± ph·∫ßn
    const sectionNumberHtml = `
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
            <div style="background: ${getSectionColor(section.type)}; color: white; 
                        width: 50px; height: 50px; border-radius: 50%; 
                        display: flex; align-items: center; justify-content: center; 
                        font-size: 1.4rem; font-weight: bold;">
                ${sectionNumber}
            </div>
            <h2 style="margin: 0; border: none; padding: 0; color: ${getSectionColor(section.type)};">
                ${section.title}
            </h2>
        </div>
    `;
    
    let contentHtml = sectionNumberHtml;
    
    // Render content based on section type
    if (section.content && Array.isArray(section.content)) {
        section.content.forEach((item, itemIndex) => {
            contentHtml += renderContentItem(item, sectionNumber, itemIndex);
        });
    }
    
    sectionElement.innerHTML = contentHtml;
    slidesContainer.appendChild(sectionElement);
}

function getSectionClass(sectionType) {
    switch(sectionType) {
        case 'theory_section': return 'theory-section';
        case 'problem_types': return 'problem-type-section';
        case 'practice_section': return 'practice-section';
        default: return '';
    }
}

function getSectionColor(sectionType) {
    switch(sectionType) {
        case 'theory_section': return '#4dabf7';
        case 'problem_types': return '#28a745';
        case 'practice_section': return '#dc3545';
        default: return '#1a237e';
    }
}

// ===== RENDER CONTENT ITEMS =====
function renderContentItem(item, sectionNum, itemIndex) {
    const uniqueId = `s${sectionNum}-i${itemIndex}`;
    
    switch(item.type) {
        case 'definition':
            return renderDefinition(item, uniqueId);
        case 'theorem':
            return renderTheorem(item, uniqueId);
        case 'note':
            return renderNote(item, uniqueId);
        case 'problem_type':
            return renderProblemType(item, uniqueId);
        case 'multiple_choice':
            return renderMultipleChoiceQuiz(item, uniqueId);
        case 'true_false':
            return renderTrueFalseQuiz(item, uniqueId);
        case 'short_answer':
            return renderShortAnswerQuiz(item, uniqueId);
        default:
            return `<div style="padding: 20px; background: #f8f9fa; border-radius: 10px; margin: 15px 0;">
                <div style="color: #666; font-style: italic;">
                    ${JSON.stringify(item, null, 2)}
                </div>
            </div>`;
    }
}

// ===== RENDER L√ù THUY·∫æT =====
function renderDefinition(item, uniqueId) {
    return `
        <div class="definition-box">
            <h4 style="display: flex; align-items: center; gap: 12px;">
                <span>üìò</span> ${item.title || 'ƒê·ªãnh nghƒ©a'}
            </h4>
            <div style="line-height: 1.7; margin-top: 15px;">
                ${item.content || ''}
                ${item.formula ? `
                    <div class="formula-box" style="margin: 20px 0;">
                        ${item.formula}
                    </div>
                ` : ''}
                ${item.note ? `
                    <div style="margin-top: 15px; padding: 15px; background: rgba(255, 193, 7, 0.1); 
                                border-radius: 8px; border-left: 4px solid #ffc107;">
                        <strong style="color: #856404;">üí° Ch√∫ √Ω:</strong> ${item.note}
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

function renderTheorem(item, uniqueId) {
    let statementsHtml = '';
    
    if (item.statements && Array.isArray(item.statements)) {
        statementsHtml = item.statements.map((stmt, idx) => {
            const statementHtml = `
                <div style="margin: 15px 0; padding: 18px; background: white; border-radius: 10px; 
                            border: 2px solid #e0e0e0; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    <div style="display: flex; align-items: flex-start; gap: 15px;">
                        <div style="background: #1c7ed6; color: white; min-width: 35px; height: 35px; 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; font-weight: bold; flex-shrink: 0;">
                            ${idx + 1}
                        </div>
                        <div>
                            <div style="font-weight: 500; margin-bottom: ${stmt.proof ? '10px' : '0'};">
                                ${stmt.content}
                            </div>
                            ${stmt.proof ? `
                                <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; 
                                            border-radius: 8px; border-left: 3px solid #28a745;">
                                    <strong style="color: #155724;">üìù Ch·ª©ng minh:</strong> ${stmt.proof}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            return statementHtml;
        }).join('');
    }
    
    return `
        <div class="theorem-box">
            <h4 style="display: flex; align-items: center; gap: 12px;">
                <span>üìñ</span> ${item.title || 'ƒê·ªãnh l√Ω'}
            </h4>
            <div style="line-height: 1.7; margin-top: 15px;">
                ${item.content || ''}
                ${statementsHtml}
                ${item.note ? `
                    <div style="margin-top: 20px; padding: 18px; background: rgba(255, 193, 7, 0.1); 
                                border-radius: 10px; border-left: 4px solid #ffc107;">
                        <strong style="color: #856404;">üí° Nh·∫≠n x√©t:</strong> ${item.note}
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

function renderNote(item, uniqueId) {
    return `
        <div class="note-box">
            <h4 style="display: flex; align-items: center; gap: 12px;">
                <span>üí°</span> ${item.title || 'Ch√∫ √Ω'}
            </h4>
            <div style="line-height: 1.7; margin-top: 15px;">
                ${item.content || ''}
            </div>
        </div>
    `;
}

// ===== RENDER D·∫†NG TO√ÅN =====
function renderProblemType(item, uniqueId) {
    let stepsHtml = '';
    let examplesHtml = '';
    
    if (item.steps && Array.isArray(item.steps)) {
        stepsHtml = `
            <div style="margin: 25px 0;">
                <h4 style="color: #4d5cb6; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span>üìã</span> C√°c b∆∞·ªõc gi·∫£i
                </h4>
                <div style="counter-reset: step;">
                    ${item.steps.map((step, idx) => `
                        <div class="method-step">
                            ${step}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    if (item.examples && Array.isArray(item.examples)) {
        examplesHtml = `
            <div style="margin: 30px 0;">
                <h4 style="color: #4d5cb6; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <span>üìù</span> V√≠ d·ª• minh h·ªça
                </h4>
                ${item.examples.map((example, idx) => `
                    <div class="example-box">
                        <div class="example-question" style="display: flex; align-items: flex-start; gap: 12px;">
                            <div style="background: #ffc107; color: #856404; min-width: 35px; height: 35px; 
                                        border-radius: 50%; display: flex; align-items: center; 
                                        justify-content: center; font-weight: bold; flex-shrink: 0;">
                                ${idx + 1}
                            </div>
                            <div>${example.question || `V√≠ d·ª• ${idx + 1}`}</div>
                        </div>
                        <div class="example-solution" style="margin-top: 15px;">
                            <strong style="color: #28a745;">‚úçÔ∏è L·ªùi gi·∫£i:</strong> ${example.solution || ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    return `
        <div class="problem-type-box">
            <h3 style="color: #28a745; margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
                <span>üéØ</span> ${item.title || 'D·∫°ng to√°n'}
            </h3>
            
            ${item.method ? `
                <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px; 
                            border-left: 4px solid #4dabf7; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    <strong style="color: #1a237e;">üìò Ph∆∞∆°ng ph√°p gi·∫£i:</strong> ${item.method}
                </div>
            ` : ''}
            
            ${stepsHtml}
            ${examplesHtml}
        </div>
    `;
}

// ===== RENDER B√ÄI T·∫¨P T·ª∞ LUY·ªÜN =====
function renderMultipleChoiceQuiz(item, uniqueId) {
    const questionId = item.id || uniqueId;
    
    // T·∫°o HTML cho c√°c l·ª±a ch·ªçn
    let optionsHtml = '';
    if (item.options && typeof item.options === 'object') {
        Object.entries(item.options).forEach(([key, value]) => {
            optionsHtml += `
                <div class="option-row" onclick="selectMCOption(this, '${questionId}', '${key}')">
                    <div class="option-label">${key}</div>
                    <div class="option-text">${value}</div>
                </div>
            `;
        });
    }
    
    return `
        <div class="question">
            <div class="question-header">
                <div class="question-number">${item.id ? item.id.replace('q', '') : '?'}</div>
                <div class="question-content">
                    <strong>${item.title || ''}</strong> ${item.text || ''}
                </div>
            </div>
            
            <div style="margin: 25px 0;">
                ${optionsHtml}
            </div>
            
            <div style="margin-top: 25px;">
                <button onclick="checkMCAnswer('${questionId}', '${item.correct}')" class="check-btn">
                    <span>‚úÖ</span> Ki·ªÉm tra ƒë√°p √°n
                </button>
                <div id="result-${questionId}" class="result-display"></div>
            </div>
            
            ${item.solution ? `
                <div id="solution-${questionId}" class="solution-box">
                    <div class="solution-title">
                        <span>üìñ</span> H∆∞·ªõng d·∫´n gi·∫£i
                    </div>
                    <div class="solution-content">${item.solution}</div>
                </div>
            ` : ''}
        </div>
    `;
}

function renderTrueFalseQuiz(item, uniqueId) {
    const questionId = item.id || uniqueId;
    
    // X·ª≠ l√Ω h√¨nh ·∫£nh
    let imageHtml = '';
    if (item.image) {
        imageHtml = `
            <div class="image-container">
                <img src="${item.image}" alt="H√¨nh v·∫Ω" class="question-image"
                     onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"400\" height=\"200\"><rect width=\"100%\" height=\"100%\" fill=\"%23f0f0f0\"/><text x=\"50%\" y=\"50%\" text-anchor=\"middle\" dy=\".3em\" fill=\"%23999\">Kh√¥ng t·∫£i ƒë∆∞·ª£c h√¨nh ·∫£nh</text></svg>'">
                ${item.image_caption ? `<div class="image-caption">${item.image_caption}</div>` : ''}
            </div>
        `;
    }
    
    // X·ª≠ l√Ω c√°c kh·∫≥ng ƒë·ªãnh (statements)
    let statementsHtml = '';
    if (item.statements && Array.isArray(item.statements)) {
        statementsHtml = `
            <div class="statement-list">
                ${item.statements.map((statement, idx) => {
                    const statementId = `${questionId}-stmt${idx}`;
                    return `
                        <div class="statement-item">
                            <div class="statement-text">
                                <strong>${idx + 1}.</strong> ${statement}
                            </div>
                            <div class="statement-controls">
                                <div class="tf-option" onclick="selectTFOption(this, '${statementId}', true)">
                                    ‚úÖ ƒê√öNG
                                </div>
                                <div class="tf-option" onclick="selectTFOption(this, '${statementId}', false)">
                                    ‚ùå SAI
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
    
    return `
        <div class="question">
            <div class="question-header">
                <div class="question-number">${item.id ? item.id.replace('q', '') : '?'}</div>
                <div class="question-content">
                    <strong>${item.title || ''}</strong> ${item.text || ''}
                </div>
            </div>
            
            ${imageHtml}
            ${statementsHtml}
            
            <div style="margin-top: 25px;">
                <button onclick="checkTFAnswer('${questionId}')" class="check-btn">
                    <span>‚úÖ</span> Ki·ªÉm tra ƒë√°p √°n
                </button>
                <div id="result-${questionId}" class="result-display"></div>
            </div>
            
            ${item.solution ? `
                <div id="solution-${questionId}" class="solution-box">
                    <div class="solution-title">
                        <span>üìñ</span> Gi·∫£i th√≠ch
                    </div>
                    <div class="solution-content">${item.solution}</div>
                </div>
            ` : ''}
        </div>
    `;
}

function renderShortAnswerQuiz(item, uniqueId) {
    const questionId = item.id || uniqueId;
    
    return `
        <div class="question">
            <div class="question-header">
                <div class="question-number">${item.id ? item.id.replace('q', '') : '?'}</div>
                <div class="question-content">
                    <strong>${item.title || ''}</strong> ${item.question || item.text || ''}
                </div>
            </div>
            
            <div style="margin: 25px 0;">
                <textarea id="input-${questionId}" class="answer-input" 
                          placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n..."></textarea>
            </div>
            
            <div style="margin-top: 25px;">
                <button onclick="checkSAAnswer('${questionId}', '${item.answer}')" class="check-btn">
                    <span>‚úÖ</span> Ki·ªÉm tra ƒë√°p √°n
                </button>
                <div id="result-${questionId}" class="result-display"></div>
            </div>
            
            ${item.solution ? `
                <div id="solution-${questionId}" class="solution-box">
                    <div class="solution-title">
                        <span>üìñ</span> L·ªùi gi·∫£i
                    </div>
                    <div class="solution-content">${item.solution}</div>
                </div>
            ` : ''}
        </div>
    `;
}

// ===== RENDER SIMPLE QUESTIONS (cho ƒë·ªãnh d·∫°ng c≈©) =====
function renderSimpleQuestions(questions) {
    const slidesContainer = document.getElementById('slides-container');
    slidesContainer.innerHTML = '';
    
    // Cover page cho ƒë·ªãnh d·∫°ng c≈©
    const coverSection = document.createElement('section');
    coverSection.className = 'slide-section active-section';
    coverSection.id = 'section-0';
    
    coverSection.innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
            <h1 style="color: #1a237e; border: none; font-size: 2.5em; margin-bottom: 20px;">
                B√ÄI T·∫¨P TO√ÅN
            </h1>
            <h3 style="color: #3949ab; margin-bottom: 30px;">
                T·ªïng s·ªë: ${Array.isArray(questions) ? questions.length : 1} c√¢u h·ªèi
            </h3>
            
            <div style="margin-top: 40px;">
                <button onclick="scrollToSection(1)" 
                        style="padding: 18px 35px; background: linear-gradient(135deg, #1a237e, #3949ab); 
                               color: white; border: none; border-radius: 12px; font-size: 1.2em; 
                               font-weight: bold; cursor: pointer;">
                    üöÄ B·∫Øt ƒë·∫ßu l√†m b√†i
                </button>
            </div>
        </div>
    `;
    
    slidesContainer.appendChild(coverSection);
    
    // Render t·ª´ng c√¢u h·ªèi
    const questionArray = Array.isArray(questions) ? questions : [questions];
    questionArray.forEach((question, index) => {
        const section = document.createElement('section');
        section.className = 'slide-section practice-section';
        section.id = `section-${index + 1}`;
        
        let content = '';
        switch(question.type) {
            case 'multiple_choice':
                content = renderMultipleChoiceQuiz(question, index + 1);
                break;
            case 'true_false':
                content = renderTrueFalseQuiz(question, index + 1);
                break;
            case 'short_answer':
                content = renderShortAnswerQuiz(question, index + 1);
                break;
            default:
                content = `
                    <div class="question">
                        <div class="question-header">
                            <div class="question-number">${index + 1}</div>
                            <div class="question-content">
                                ${JSON.stringify(question, null, 2)}
                            </div>
                        </div>
                    </div>
                `;
        }
        
        section.innerHTML = content;
        slidesContainer.appendChild(section);
    });
    
    // Kh·ªüi t·∫°o MathJax
    setTimeout(() => {
        if (window.MathJax) {
            MathJax.typesetPromise();
        }
        setupScrollTracking();
    }, 100);
}

// ===== ANSWER HANDLING FUNCTIONS =====
window.selectMCOption = function(element, questionId, optionKey) {
    const container = element.closest('.question');
    container.querySelectorAll('.option-row').forEach(row => {
        row.style.background = '';
        row.style.borderColor = '';
        row.querySelector('.option-label').style.background = '#f0f0f0';
        row.querySelector('.option-label').style.color = '';
    });
    
    element.style.background = '#e8f4f8';
    element.style.borderColor = '#17a237e';
    element.querySelector('.option-label').style.background = '#1a237e';
    element.querySelector('.option-label').style.color = 'white';
    
    userAnswers[questionId] = optionKey;
};

window.checkMCAnswer = function(questionId, correctAnswer) {
    const userAnswer = userAnswers[questionId];
    const resultEl = document.getElementById(`result-${questionId}`);
    const solutionEl = document.getElementById(`solution-${questionId}`);
    
    if (!userAnswer) {
        showNotification('‚ö†Ô∏è Vui l√≤ng ch·ªçn ƒë√°p √°n', 'warning');
        return;
    }
    
    const isCorrect = userAnswer === correctAnswer;
    
    // Highlight ƒë√°p √°n ƒë√∫ng v√† ƒë√°p √°n ng∆∞·ªùi d√πng ch·ªçn
    const container = document.querySelector(`[onclick*="selectMCOption(this, '${questionId}'"]`)?.closest('.question');
    if (container) {
        container.querySelectorAll('.option-row').forEach(row => {
            const label = row.querySelector('.option-label');
            if (label) {
                const letter = label.textContent.trim();
                if (letter === correctAnswer) {
                    row.style.background = '#d4edda';
                    row.style.borderColor = '#28a745';
                    label.style.background = '#28a745';
                    label.style.color = 'white';
                } else if (letter === userAnswer && !isCorrect) {
                    row.style.background = '#f8d7da';
                    row.style.borderColor = '#dc3545';
                    label.style.background = '#dc3545';
                    label.style.color = 'white';
                }
            }
        });
    }
    
    if (isCorrect) {
        resultEl.innerHTML = '<span style="color: #28a745; font-weight: bold;">‚úÖ Ch√≠nh x√°c!</span>';
        resultEl.className = 'result-display result-correct';
        playSound('correct');
    } else {
        resultEl.innerHTML = `<span style="color: #dc3545; font-weight: bold;">‚ùå Sai! ƒê√°p √°n ƒë√∫ng: ${correctAnswer}</span>`;
        resultEl.className = 'result-display result-incorrect';
        playSound('wrong');
    }
    
    resultEl.style.display = 'block';
    
    if (solutionEl) {
        solutionEl.style.display = 'block';
    }
};

window.selectTFOption = function(element, statementId, value) {
    // B·ªè ch·ªçn t·∫•t c·∫£ trong c√πng statement
    const container = element.closest('.statement-item');
    container.querySelectorAll('.tf-option').forEach(opt => {
        opt.classList.remove('selected-true', 'selected-false');
    });
    
    // Ch·ªçn ƒë√°p √°n
    element.classList.add(value ? 'selected-true' : 'selected-false');
    
    userAnswers[statementId] = value;
};

window.checkTFAnswer = function(questionId) {
    const resultEl = document.getElementById(`result-${questionId}`);
    const solutionEl = document.getElementById(`solution-${questionId}`);
    
    // T√¨m c√¢u h·ªèi trong currentLesson
    let question = null;
    let statementCount = 0;
    
    if (currentLesson && currentLesson.sections) {
        currentLesson.sections.forEach(section => {
            if (section.content) {
                section.content.forEach(item => {
                    if (item.id === questionId || item.id?.includes(questionId)) {
                        question = item;
                        statementCount = item.statements?.length || 0;
                    }
                });
            }
        });
    }
    
    if (!question || !question.answers || statementCount === 0) {
        showNotification('Kh√¥ng t√¨m th·∫•y ƒë√°p √°n cho c√¢u h·ªèi n√†y', 'error');
        return;
    }
    
    let allCorrect = true;
    let allAnswered = true;
    let resultsHtml = '';
    
    for (let idx = 0; idx < statementCount; idx++) {
        const statementId = `${questionId}-stmt${idx}`;
        const userAnswer = userAnswers[statementId];
        const correctAnswer = question.answers[idx] === "True";
        
        if (userAnswer === undefined) {
            allAnswered = false;
            resultsHtml += `<div style="color: #ffc107;">‚ö†Ô∏è C√¢u ${idx + 1}: Ch∆∞a ch·ªçn</div>`;
            allCorrect = false;
        } else if (userAnswer === correctAnswer) {
            resultsHtml += `<div style="color: #28a745;">‚úÖ C√¢u ${idx + 1}: ƒê√∫ng</div>`;
        } else {
            resultsHtml += `<div style="color: #dc3545;">‚ùå C√¢u ${idx + 1}: Sai (ƒê√°p √°n: ${correctAnswer ? 'ƒê√öNG' : 'SAI'})</div>`;
            allCorrect = false;
        }
    }
    
    if (!allAnswered) {
        showNotification('‚ö†Ô∏è Vui l√≤ng tr·∫£ l·ªùi t·∫•t c·∫£ c√°c kh·∫≥ng ƒë·ªãnh', 'warning');
        return;
    }
    
    resultEl.innerHTML = `
        <div style="margin-top: 10px;">
            ${resultsHtml}
            ${allCorrect ? '<div style="color: #28a745; font-weight: bold; margin-top: 10px;">üéâ T·∫•t c·∫£ ƒë·ªÅu ƒë√∫ng!</div>' : ''}
        </div>
    `;
    
    resultEl.className = allCorrect ? 'result-display result-correct' : 'result-display result-incorrect';
    resultEl.style.display = 'block';
    
    if (allCorrect) {
        playSound('correct');
    } else {
        playSound('wrong');
    }
    
    if (solutionEl) {
        solutionEl.style.display = 'block';
    }
};

window.checkSAAnswer = function(questionId, correctAnswer) {
    const inputEl = document.getElementById(`input-${questionId}`);
    const resultEl = document.getElementById(`result-${questionId}`);
    const solutionEl = document.getElementById(`solution-${questionId}`);
    
    if (!inputEl) return;
    
    const userAnswer = inputEl.value.trim();
    
    if (!userAnswer) {
        showNotification('‚ö†Ô∏è Vui l√≤ng nh·∫≠p c√¢u tr·∫£ l·ªùi', 'warning');
        return;
    }
    
    // Chu·∫©n h√≥a ƒë·ªÉ so s√°nh
    const normalize = (str) => str.toLowerCase()
        .replace(/\s+/g, ' ')
        .replace(/[.,;:!?]/g, '')
        .trim();
    
    const normalizedUser = normalize(userAnswer);
    const normalizedCorrect = normalize(correctAnswer);
    
    const isCorrect = normalizedUser === normalizedCorrect;
    
    if (isCorrect) {
        resultEl.innerHTML = '<span style="color: #28a745; font-weight: bold;">‚úÖ Ch√≠nh x√°c!</span>';
        resultEl.className = 'result-display result-correct';
        inputEl.style.borderColor = '#28a745';
        inputEl.style.background = '#d4edda';
        playSound('correct');
    } else {
        resultEl.innerHTML = '<span style="color: #dc3545; font-weight: bold;">‚ùå Ch∆∞a ch√≠nh x√°c</span>';
        resultEl.className = 'result-display result-incorrect';
        inputEl.style.borderColor = '#dc3545';
        inputEl.style.background = '#f8d7da';
        playSound('wrong');
        
        // Hi·ªÉn th·ªã ƒë√°p √°n ƒë√∫ng sau 1 gi√¢y
        setTimeout(() => {
            if (resultEl) {
                resultEl.innerHTML += `
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <strong style="color: #1a237e;">ƒê√°p √°n ƒë√∫ng:</strong> 
                        <code style="background: white; padding: 4px 8px; border-radius: 4px; 
                              border: 1px solid #ddd; margin-left: 10px;">
                            ${correctAnswer}
                        </code>
                    </div>
                `;
            }
        }, 1000);
    }
    
    resultEl.style.display = 'block';
    inputEl.disabled = true;
    
    if (solutionEl) {
        solutionEl.style.display = 'block';
    }
};

// ===== UTILITY FUNCTIONS =====
function showLoading(message = 'ƒêang t·∫£i...') {
    const overlay = document.getElementById('loadingOverlay');
    const text = document.getElementById('loadingText');
    
    if (overlay && text) {
        text.textContent = message;
        overlay.classList.remove('hidden');
    }
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.classList.add('hidden');
    }
}

function showErrorPage(errorMessage) {
    const slidesContainer = document.getElementById('slides-container');
    slidesContainer.innerHTML = `
        <section class="slide-section active-section">
            <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 5rem; margin-bottom: 20px;">‚ùå</div>
                <h2 style="color: #dc3545;">Kh√¥ng th·ªÉ t·∫£i chuy√™n ƒë·ªÅ</h2>
                <p style="color: #666; margin: 20px 0; max-width: 500px; margin: 20px auto;">${errorMessage}</p>
                <button onclick="showWelcomePage()" 
                        style="padding: 15px 30px; background: #1a237e; color: white; border: none; 
                               border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 1.1rem;">
                    Quay l·∫°i trang ch·ªß
                </button>
            </div>
        </section>
    `;
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        z-index: 100000;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        animation: slideIn 0.3s ease;
        max-width: 400px;
        backdrop-filter: blur(10px);
    `;
    
    if (type === 'success') notification.style.background = 'linear-gradient(135deg, rgba(40, 167, 69, 0.95), rgba(32, 201, 151, 0.95))';
    else if (type === 'error') notification.style.background = 'linear-gradient(135deg, rgba(220, 53, 69, 0.95), rgba(200, 35, 51, 0.95))';
    else if (type === 'warning') notification.style.background = 'linear-gradient(135deg, rgba(255, 193, 7, 0.95), rgba(224, 168, 0, 0.95))';
    else notification.style.background = 'linear-gradient(135deg, rgba(23, 162, 184, 0.95), rgba(19, 132, 150, 0.95))';
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function playSound(type) {
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance();
        utterance.text = type === 'correct' ? 'Ch√≠nh x√°c!' : 'Sai r·ªìi!';
        utterance.lang = 'vi-VN';
        utterance.volume = 0.3;
        utterance.rate = 1.0;
        speechSynthesis.speak(utterance);
    }
}

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    document.getElementById('toggleDarkModeBtn').innerHTML = isDark ? '‚òÄÔ∏è S√°ng' : 'üåô T·ªëi';
    showNotification(isDark ? 'üåô ƒê√£ b·∫≠t ch·∫ø ƒë·ªô t·ªëi' : '‚òÄÔ∏è ƒê√£ b·∫≠t ch·∫ø ƒë·ªô s√°ng', 'info');
    
    if (window.MathJax) {
        MathJax.typesetPromise();
    }
}

// ===== EVENT LISTENERS =====
function setupEventListeners() {
    // Lesson selector
    document.getElementById('lessonSelector').addEventListener('change', function() {
        const selectedUrl = this.value;
        if (selectedUrl) {
            loadLesson(selectedUrl);
            this.selectedIndex = 0;
        }
    });
    
    // Dark mode
    document.getElementById('toggleDarkModeBtn').addEventListener('click', toggleDarkMode);
    
    // Print
    document.getElementById('printBtn').addEventListener('click', () => window.print());
}

// ===== SCROLL TRACKING =====
function setupScrollTracking() {
    const pageContainer = document.querySelector('.page-container');
    if (!pageContainer) return;
    
    const observer = new IntersectionObserver(
        (entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    document.querySelectorAll('.slide-section').forEach(section => {
                        section.classList.remove('active-section');
                    });
                    entry.target.classList.add('active-section');
                    updateScrollProgress();
                }
            });
        },
        {
            root: pageContainer,
            rootMargin: '-20% 0px -60% 0px',
            threshold: 0.1
        }
    );
    
    document.querySelectorAll('.slide-section').forEach(section => {
        observer.observe(section);
    });
    
    pageContainer.addEventListener('scroll', updateScrollProgress);
}

function updateScrollProgress() {
    const pageContainer = document.querySelector('.page-container');
    if (!pageContainer) return;
    
    const scrollTop = pageContainer.scrollTop;
    const scrollHeight = pageContainer.scrollHeight - pageContainer.clientHeight;
    const scrollPercentage = (scrollTop / scrollHeight) * 100;
    
    const progressBar = document.getElementById('scrollProgress');
    if (progressBar) {
        progressBar.style.width = scrollPercentage + '%';
    }
}

window.scrollToSection = function(sectionIndex) {
    const section = document.getElementById(`section-${sectionIndex}`);
    if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
};
</script>
</body>
</html>
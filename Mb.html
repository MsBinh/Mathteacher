<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EduBoard Pro - NguyenThanhBinh</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$']], processEscapes: true },
            svg: { fontCache: 'global' },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src='https://meet.jit.si/external_api.js'></script>

    <style>
        :root { --board-bg: #2c3e50; --toolbar-bg: #34495e; --accent: #2ecc71; --yellow: #f1c40f; }
        body, html { 
            margin: 0; padding: 0; 
            width: 100%; height: 100%; 
            overflow: hidden; 
            background: #252526; 
            font-family: 'Times New Roman', serif; 
            user-select: none; 
            touch-action: none; 
        }
        
        .app-layout { 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden;
        }
        
        /* TOOLBAR - B·ªé THANH TR∆Ø·ª¢T */
        .toolbar { 
            height: 50px; 
            background: var(--toolbar-bg); 
            padding: 0 10px; 
            display: flex; 
            align-items: center; 
            border-bottom: 1px solid #555; 
            z-index: 9999; 
            flex-shrink: 0; 
            font-family: 'Segoe UI', sans-serif;
            overflow: visible !important;
        }
        
        .toolbar-content { 
            display: flex; 
            gap: 8px; 
            align-items: center; 
            width: 100%;
            overflow: visible;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        
        /* --- S·ª¨A CLASS .btn ƒê·ªÇ N√öT G·ªåN H∆†N --- */
        .btn {
            width: 40px;           /* C·ªë ƒë·ªãnh chi·ªÅu r·ªông */
            height: 36px;          /* C·ªë ƒë·ªãnh chi·ªÅu cao */
            padding: 0;            /* B·ªè ƒë·ªám th·ª´a */
            border-radius: 6px;
            border: 1px solid #555;
            cursor: pointer;
            font-weight: bold;
            color: #fff;
            background: #444;
            font-size: 18px;       /* TƒÉng c·ª° icon l√™n cho d·ªÖ nh√¨n */
            display: flex;
            align-items: center;
            justify-content: center; /* CƒÉn gi·ªØa icon */
            white-space: nowrap;
            flex-shrink: 0;
            transition: background 0.2s; /* Hi·ªáu ·ª©ng r√™ chu·ªôt m∆∞·ª£t */
        }

        .btn:hover {
            background: #555;      /* M√†u s√°ng h∆°n khi r√™ chu·ªôt */
        }

        /* S·ª≠a l·∫°i √¥ ch·ªçn b√∫t v·∫Ω cho g·ªçn */
        #drawTool {
            width: 60px; /* Thu nh·ªè √¥ ch·ªçn b√∫t */
            height: 36px;
            padding: 0 5px;
            font-size: 18px;
            text-align: center;
            background: #eee;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn.active { background: var(--accent); border-color: var(--accent); }
        .sep { width: 1px; height: 25px; background: #666; margin: 0 4px; flex-shrink: 0; }

        .math-toolbar { 
            height: 40px; 
            background: #2c2c2c; 
            display: flex; 
            align-items: center; 
            padding: 0 10px; 
            gap: 8px; 
            border-bottom: 1px solid #444; 
            overflow-x: auto; 
            z-index: 9998; 
            white-space: nowrap; 
            flex-shrink: 0; 
            font-family: 'Segoe UI', sans-serif;
        }
        
        .snippet-btn { 
            padding: 4px 10px; 
            font-size: 14px; 
            background: #3a3a3a; 
            color: #ddd; 
            border: 1px solid #555; 
            border-radius: 4px; 
            cursor: pointer; 
            flex-shrink: 0;
        }

        /* BOARD & LAYERS */
        #boardWrapper { 
            flex: 1; 
            position: relative; 
            background-color: #0b6b3a; 
            background-image: linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px), 
                            linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 25px 25px;
            overflow: auto; 
            cursor: crosshair; 
            touch-action: pan-y;
        }
        
        #contentContainer {
            position: relative;
            min-height: 5000px; /* CHI·ªÄU CAO L·ªöN ƒê·ªÇ HI·ªÇN TH·ªä WEB */
            width: 100%;
        }
        
        /* LAYER: PDF GHIM D√çNH T·∫§T C·∫¢ TRANG */
        .pdf-container {
            position: relative;
            width: 100%;
            background: white;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .pdf-page {
            position: relative;
            width: 100%;
            display: block;
            border-bottom: 1px solid #ddd;
        }
        
        .pdf-page:last-child {
            border-bottom: none;
        }
        
        /* --- C·∫§U H√åNH H·ªòP ·∫¢NH & WEB (ƒê√É S·ª¨A L·ªñI) --- */
        .media-box {
            position: absolute;
            z-index: 100; /* M·∫∑c ƒë·ªãnh th·∫•p h∆°n Canvas m·ªôt ch√∫t */
            cursor: move;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
        }

        /* KHI ƒê∆Ø·ª¢C CH·ªåN: N·ªïi l√™n tr√™n c√πng (Z-Index 1000) ƒë·ªÉ b·∫•m ƒë∆∞·ª£c n√∫t */
        .media-box.selected {
            border: 2px dashed var(--yellow);
            z-index: 1000 !important;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        /* N·ªôi dung ·∫£nh/web */
        .media-content { width: 100%; height: 100%; position: relative; }
        .media-content img { width: 100%; display: block; pointer-events: none; } /* Ch·∫∑n chu·ªôt v√†o ·∫£nh ƒë·ªÉ d·ªÖ k√©o */
        .media-content iframe { width: 100%; height: 100%; border: none; }

        /* --- THANH ƒêI·ªÄU KHI·ªÇN (ZOOM/XOAY) --- */
        .img-controls {
            position: absolute;
            top: -40px; /* N·ªïi l√™n tr√™n ƒë·∫ßu ·∫£nh */
            right: 0;
            background: rgba(44, 62, 80, 0.95);
            border-radius: 4px;
            padding: 4px;
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
            gap: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            pointer-events: auto; /* ƒê·∫£m b·∫£o nh·∫≠n chu·ªôt */
        }

        /* Ch·ªâ hi·ªán thanh n√†y khi h·ªôp ·∫£nh C√ì class .selected */
        .media-box.selected .img-controls {
            display: flex;
        }

        .img-btn {
            width: 30px; height: 30px;
            background: #34495e; color: white;
            border: 1px solid #7f8c8d; border-radius: 3px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; font-weight: bold;
        }
        .img-btn:hover { background: var(--accent); border-color: var(--accent); }
        
        /* LAYER: WEB IFRAME CAO */
        .web-container {
            position: relative;
            width: 100%;
            height: 2000px; /* CHI·ªÄU CAO L·ªöN CHO WEB */
            background: white;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .web-header {
            padding: 8px 12px;
            background: #2c3e50;
            color: white;
            cursor: move;
            font-weight: bold;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .web-iframe {
            width: 100%;
            height: calc(100% - 40px);
            border: none;
        }

        .web-blocker {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 10;
        }

        .t-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            background: var(--accent);
            cursor: nw-resize;
            border-radius: 2px;
        }
        
        /* LAYER: CANVAS V·∫º */
        #mainCanvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 200; 
            pointer-events: none; 
        }
        
        .drawing-mode #mainCanvas { 
            pointer-events: auto; 
            background: transparent; 
            z-index: 300; 
        }
        
        /* MATH BOX */
        .math-box { 
            position: absolute; 
            min-width: 50px; 
            z-index: 400; 
            background-color: rgba(21, 76, 39, 0.95); 
            border-left: 4px solid var(--yellow); 
            border-radius: 4px; 
            box-shadow: 3px 3px 10px rgba(0,0,0,0.5); 
            color: white; 
            font-family: 'Times New Roman', serif; 
            font-size: 14.5pt; 
            display: flex; 
            flex-direction: column; 
            cursor: pointer;
            transform-origin: center center;
        }
        
        .math-box.active { 
            border: 2px dashed var(--accent); 
            background-color: rgba(21, 76, 39, 1);
            z-index: 500;
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.6);
        }
        
        .math-handle { 
            height: 20px; 
            background: rgba(0,0,0,0.3); 
            cursor: move; 
            width: 100%; 
            display: flex; 
            justify-content: flex-end; 
            align-items: center; 
            padding: 0 8px;
            display: none;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }
        
        .math-box.active .math-handle { display: flex; }
        
        .stamp-btn { 
            cursor: pointer; 
            font-size: 14px; 
            margin-left: 5px; 
            color: #fff; 
            background: none; 
            border: none; 
            transition: transform 0.2s;
        }
        
        .stamp-btn:hover { color: var(--yellow); transform: scale(1.3); }
        
        .math-content { 
            padding: 8px 12px; 
            outline: none; 
            border: none; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            min-height: 1.5em; 
            line-height: 1.5; 
            pointer-events: none;
        }
        
        /* EDITOR PANEL */
        #editor-panel {
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            width: 350px; 
            height: 200px;
            background: rgba(44, 62, 80, 0.97); 
            border: 2px solid var(--accent); 
            border-radius: 8px;
            z-index: 10000; 
            display: none; 
            flex-direction: column;
            padding: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
            font-family: 'Segoe UI', sans-serif;
        }
        
        #editor-title { 
            color: var(--accent); 
            font-size: 14px; 
            margin-bottom: 8px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        
        #latex-input { 
            flex: 1; 
            background: #fff; 
            color: #000; 
            padding: 10px; 
            border-radius: 6px; 
            resize: none; 
            font-family: 'Consolas', monospace; 
            font-size: 14px; 
            border: 1px solid #555;
            outline: none;
            line-height: 1.4;
        }
        
        #editor-controls { 
            margin-top: 10px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .hint { color: #ccc; font-size: 12px; }
        
        /* MATH STICKER */
        .math-sticker { 
            position: absolute; 
            z-index: 350; 
            pointer-events: none; 
        }
        
        /* UI PH·ª§ */
        .pagination-bar { 
            position: fixed; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: rgba(51, 51, 51, 0.9); 
            padding: 8px 20px; 
            border-radius: 25px; 
            display: flex; 
            gap: 12px; 
            align-items: center; 
            z-index: 8000; 
            border: 2px solid #555; 
            font-family: 'Segoe UI', sans-serif;
            backdrop-filter: blur(5px);
        }
        
        #pageIndicator { 
            color: var(--yellow); 
            font-weight: bold; 
            font-size: 15px; 
            min-width: 60px;
            text-align: center;
        }
        
        #colorStatus { 
            width: 28px; 
            height: 28px; 
            border-radius: 50%; 
            border: 2px solid #fff; 
            margin-left: 5px; 
            cursor: pointer; 
            flex-shrink: 0; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .modal { 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 90%; 
            max-width: 400px; 
            background: #333; 
            padding: 25px; 
            border-radius: 12px; 
            display: none; 
            z-index: 9000; 
            color: white; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.9); 
            font-family: 'Segoe UI', sans-serif;
            border: 1px solid var(--accent);
        }
        
        #loading { 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%,-50%); 
            background: rgba(0,0,0,0.9); 
            color: white; 
            padding: 20px 40px; 
            border-radius: 12px; 
            display: none; 
            z-index: 9999; 
            font-family: 'Segoe UI', sans-serif;
            border: 2px solid var(--accent);
            font-size: 16px;
        }
        
        #jitsi-container { 
            position: fixed; 
            bottom: 10px; 
            right: 10px; 
            width: 400px; 
            height: 300px; 
            background: #000; 
            border: 3px solid var(--yellow); 
            z-index: 9000; 
            display: none; 
            resize: both; 
            overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); 
            border-radius: 8px;
        }
        
        .jitsi-header { 
            height: 35px; 
            background: #222; 
            cursor: move; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 12px; 
            color: white; 
            font-size: 14px; 
            border-bottom: 1px solid #444; 
            font-family: 'Segoe UI', sans-serif;
        }
        
        /* SCROLLBAR STYLING */
        #boardWrapper::-webkit-scrollbar {
            width: 10px;
        }
        
        #boardWrapper::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        #boardWrapper::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 5px;
        }
        
        #boardWrapper::-webkit-scrollbar-thumb:hover {
            background: #27ae60;
        }

        /* --- TH√äM CODE CSS CHO LABEL BOX (T√äN ƒê·ªàNH) --- */
        .label-box {
            position: absolute;
            z-index: 600; /* Cao h∆°n Canvas (300) v√† MathBox (500) */
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #333;
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: move;
            min-width: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .label-box:focus {
            border: 2px solid var(--accent); /* Vi·ªÅn xanh khi ƒëang g√µ */
            outline: none;
        }
    </style>
</head>
<body class="drawing-mode">

<div id="loading">‚è≥ ƒêang t·∫£i PDF...</div>

<div class="app-layout">
    <div class="toolbar">
        <div class="toolbar-content">
            <button class="btn" onclick="toggleFullScreen()" title="To√†n m√†n h√¨nh">üñ•Ô∏è</button>

            <button class="btn" id="btnHand" onclick="setTool('hand')" title="Ch·∫ø ƒë·ªô Cu·ªôn trang (Hand)">üñêÔ∏è</button>
            <button class="btn" onclick="loadProjectFile()" title="M·ªü Project c≈© (.json)">üìÇ</button>
            <button class="btn" onclick="saveProjectFile()" title="L∆∞u Project ƒë·ªÉ s·ª≠a sau">üíæ</button>

            <div class="sep"></div>
            <button class="btn" onclick="undoApp()" title="Ho√†n t√°c (Undo)">‚Ü©Ô∏è</button>
            <button class="btn" onclick="redoApp()" title="L√†m l·∫°i (Redo)">‚Ü™Ô∏è</button>
            <div class="sep"></div>

            <select id="drawTool" onchange="setTool(this.value)" title="Ch·ªçn c√¥ng c·ª• v·∫Ω">
                <optgroup label="C∆° b·∫£n">
                    <option value="pen" selected>‚úèÔ∏è</option>
                    <option value="highlighter">üñçÔ∏è</option>
                    <option value="line">üìè</option>
                    <option value="dashedLine"> -- </option>
                </optgroup>
                <optgroup label="H√¨nh h·ªçc">
                    <option value="rect">‚¨õ</option>
                    <option value="circle">‚ö™</option>
                    <option value="cube">üì¶</option>
                    <option value="tri_pyramid">üî∫</option>
                    <option value="cone">üç¶</option>
                    <option value="cylinder">üõ¢Ô∏è</option>
                    <option value="sphere">‚öΩ</option>
                </optgroup>
            </select>

            <div id="colorStatus" onclick="cycleColor()" title="ƒê·ªïi m√†u b√∫t (Click)"></div>
            <button class="btn" id="btnMath" onclick="createCenteredMathBox()" style="color: var(--yellow);" title="T·∫°o h·ªôp c√¥ng th·ª©c (Math Box)">Œ£</button>
            <div class="sep"></div>

            <button class="btn" id="btnAnnotate" onclick="toggleAnnotation()" style="background:#d35400" title="B·∫≠t/T·∫Øt ch·∫ø ƒë·ªô v·∫Ω ƒë√®">üìù</button>

            <button class="btn" style="background:#27ae60" onclick="document.getElementById('imageInput').click()" title="Ch√®n ·∫¢nh">üñºÔ∏è</button>
            <button class="btn" style="background:#8e44ad" onclick="addWebsite()" title="Ch√®n Web">üåê</button>
            <button class="btn" style="background:#3498db" onclick="document.getElementById('pdfInput').click()" title="Ch√®n PDF">üìÑ</button>

            <div class="sep"></div>
            <button class="btn" style="background:var(--accent)" onclick="exportFullPDF()" title="Xu·∫•t file PDF b√†i gi·∫£ng">üì•</button>
            <button class="btn" style="color:#c0392b; background:#333;" onclick="toggleLiveModal()" title="Ph√°t tr·ª±c tuy·∫øn (Live)">üì°</button>
            <button class="btn" onclick="toggleHelp()" title="H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng">‚ùì</button>
        </div>
    </div>

    <div class="math-toolbar">
        <button class="snippet-btn" onmousedown="event.preventDefault()" onclick="insertMath('\\frac{}{}')">Ph√¢n s·ªë</button>
        <button class="snippet-btn" onmousedown="event.preventDefault()" onclick="insertMath('\\sqrt{}')">CƒÉn</button>
        <button class="snippet-btn" onmousedown="event.preventDefault()" onclick="insertMath('^{}')">M≈©</button>
        <button class="snippet-btn" onmousedown="event.preventDefault()" onclick="insertMath('\\begin{cases} \\end{cases}')">H·ªá PT</button>
        <button class="snippet-btn" onmousedown="event.preventDefault()" onclick="insertMath('\\int_{}^{}')">T√≠ch ph√¢n</button>
        <button class="snippet-btn" onmousedown="event.preventDefault()" onclick="insertMath('\\vec{}')">Vecto</button>
        <button class="snippet-btn" onmousedown="event.preventDefault()" onclick="insertMath('\\widehat{}')">G√≥c</button>
        <button class="snippet-btn" onmousedown="event.preventDefault()" onclick="insertMath('\\perp')">Vu√¥ng g√≥c</button>
        <button class="snippet-btn" onmousedown="event.preventDefault()" onclick="insertMath('\\parallel')">Song song</button>
        <button class="snippet-btn" onmousedown="event.preventDefault()" onclick="insertMath('\\in')">Thu·ªôc</button>
        <button class="snippet-btn" onmousedown="event.preventDefault()" onclick="insertMath('^\\circ')">ƒê·ªô</button>
        <button class="snippet-btn" onmousedown="event.preventDefault()" onclick="insertMath('\\Delta')">Tam gi√°c</button>
        <button class="snippet-btn" onmousedown="event.preventDefault()" onclick="insertMath('\\Rightarrow')">Suy ra</button>
        <button class="snippet-btn" onmousedown="event.preventDefault()" onclick="insertMath('\\Leftrightarrow')">T∆∞∆°ng ƒë∆∞∆°ng</button>
        <button class="snippet-btn" onmousedown="event.preventDefault()" onclick="insertMath('\\infty')">V√¥ c·ª±c</button>
    </div>

    <div id="editor-panel">
        <div id="editor-title">
            <span>üíª NH·∫¨P LATEX / TEXT</span>
            <span onclick="closeEditor()" style="cursor:pointer; color:#e74c3c; font-weight:bold;">‚úï</span>
        </div>
        <textarea id="latex-input" placeholder="G√µ text th∆∞·ªùng ho·∫∑c c√¥ng th·ª©c Latex trong $...$"></textarea>
        <div id="editor-controls">
            <span class="hint">Ctrl+R: Render | Ctrl+Enter: ƒê√≥ng | Ctrl+X: X√≥a</span>
            <button class="btn" style="font-size:13px; padding:6px 15px; background:var(--accent)" onclick="renderCurrentBox()">‚ñ∂Ô∏è HI·ªÜN</button>
        </div>
    </div>

    <div id="boardWrapper" ondblclick="handleDoubleClick(event)">
        <div id="contentContainer">
            <canvas id="mainCanvas"></canvas>
        </div>
        
        
    </div>

    <div class="pagination-bar">
        <button class="btn" onclick="prevPage()" style="padding:6px 15px;">‚óÄ</button>
        <span id="pageIndicator">1/1</span>
        <button class="btn" onclick="nextPage()" style="padding:6px 15px;">‚ñ∂</button>
        <button class="btn" onclick="addPage()" style="background:var(--accent); padding:6px 15px;">‚ûï</button>
    </div>
    
    <input type="file" id="imageInput" accept="image/*" style="display: none;">
    <input type="file" id="pdfInput" accept=".pdf" style="display: none;">
</div>

<div id="liveModal" class="modal">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
        <strong style="color:#e74c3c; font-size:18px;">üé• L·ªöP H·ªåC TR·ª∞C TUY·∫æN</strong>
        <span onclick="toggleLiveModal()" style="cursor:pointer; font-size:20px; color:#e74c3c;">‚úï</span>
    </div>
    <div style="background:#444; padding:15px; border-radius:8px; margin-bottom:15px;">
        <strong style="color:var(--yellow); display:block; margin-bottom:8px;">1. Gi√°o Vi√™n:</strong>
        <button class="btn" onclick="startJitsi()" style="width:100%; background:#e74c3c; margin-top:5px; padding:10px; font-size:15px;">üé• T·∫°o & B·∫Øt ƒê·∫ßu</button>
        <div id="roomInfo" style="margin-top:10px; display:none; font-size:14px; background:rgba(0,0,0,0.3); padding:10px; border-radius:5px;">
            M√£ l·ªõp: <b id="roomNameDisplay" style="color:var(--accent); font-size:18px; margin:0 5px;">...</b> 
            <button onclick="copyId()" class="btn" style="display:inline-block; padding:5px 10px; margin-left:10px; background:#3498db;">Copy</button>
        </div>
    </div>
    <div style="background:#444; padding:15px; border-radius:8px;">
        <strong style="color:#3498db; display:block; margin-bottom:8px;">2. H·ªçc Sinh:</strong>
        <input type="text" id="roomNameInput" placeholder="Nh·∫≠p m√£ l·ªõp..." style="width:100%; padding:10px; margin:8px 0; box-sizing: border-box; border-radius:6px; border:1px solid #555; background:#333; color:white;">
        <button class="btn" onclick="joinJitsi()" style="width:100%; background:#3498db; padding:10px; font-size:15px;">üëÄ V√†o L·ªõp Ngay</button>
    </div>
</div>

<div id="jitsi-container">
    <div class="jitsi-header">
        <div style="display:flex; align-items:center;">
            <span style="color:var(--accent);">üé• M√£ L·ªõp: </span>
            <b id="displayRoomCode" style="color:var(--yellow); margin:0 8px; font-size:15px;">...</b>
            <button onclick="openExternalJitsi()" style="background:#2ecc71; color:white; border:none; border-radius:4px; padding:4px 8px; font-size:12px; cursor:pointer; margin-left:5px">‚ÜóÔ∏è Tab M·ªõi</button>
        </div>
        <span onclick="closeJitsi()" style="color:red; cursor:pointer; font-weight:bold; font-size:20px;">‚úï</span>
    </div>
    <div id="meet" style="width:100%; height:calc(100% - 35px);"></div>
</div>

<div id="helpModal" class="modal">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
        <strong style="color:#f1c40f; font-size:18px;">üìö H∆Ø·ªöNG D·∫™N v26.0</strong>
        <span onclick="toggleHelp()" style="cursor:pointer; font-size:20px; color:#f1c40f;">‚úï</span>
    </div>
    <ul style="padding-left: 20px; margin: 0; font-size:14px; line-height:1.6;">
        <li><b>üñºÔ∏è ·∫¢nh:</b> Click ch·ªçn ‚Üí N√∫t Zoom (+/-) & Xoay (‚Üª) hi·ªán l√™n</li>
        <li><b>üìÑ PDF:</b> T·ª± ƒë·ªông ch√®n d√≠nh t·∫•t c·∫£ trang v√†o b·∫£ng</li>
        <li><b>üåê Web:</b> Iframe cao ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß trang web</li>
        <li><b>Œ£ Box:</b> Click ƒë√∫p t·∫°o ‚Üí Click box m·ªü editor</li>
        <li><b>Ctrl+R:</b> Render c√¥ng th·ª©c Latex ngay</li>
        <li><b>Ctrl+Enter:</b> ƒê√≥ng editor</li>
        <li><b>Ctrl+X:</b> X√≥a box ƒëang active</li>
        <li><b>Ctrl+D:</b> T·∫°o t√™n ƒë·ªânh (label)</li>
        <li><b>üìå Ghim:</b> D√≠nh Math Box v√†o PDF vƒ©nh vi·ªÖn</li>
    </ul>
</div>

<script>
    const canvas = document.getElementById('mainCanvas'); 
    const ctx = canvas.getContext('2d');
    const wrapper = document.getElementById('boardWrapper');
    const contentContainer = document.getElementById('contentContainer');
    const colorStatus = document.getElementById('colorStatus');
    const editorPanel = document.getElementById('editor-panel');
    const latexInput = document.getElementById('latex-input');

    let isDrawing = false, points = [], snapshot;
    let currentColor = '#ffffff';
    let currentTool = 'pen'; 
    let activeMathBox = null;
    let selectedMediaBox = null; // Media box ƒëang ƒë∆∞·ª£c ch·ªçn (·∫£nh/web)
    let jitsiApi = null;
    let currentRoomName = ""; 
    let mouseX = 0, mouseY = 0; 
    let currentPage = 0;
    let pages = [{ canvasData: null }];
    let history = []; 
    let historyStep = -1;

    function init() {
        resizeCanvas();
        ctx.strokeStyle = currentColor; 
        ctx.lineWidth = 2.5; 
        ctx.lineCap = 'round'; 
        ctx.lineJoin = 'round';
        colorStatus.style.background = currentColor;
        document.body.classList.add('drawing-mode');
        updateToolState();
        makeElementDraggable(document.getElementById('jitsi-container'), document.querySelector('.jitsi-header'));
        
        // Setup editor (ƒêO·∫†N ƒê√É S·ª¨A T√äN CLASS)
        document.addEventListener('mousedown', (e) => {
            // S·ª¨A L·ªñI QUAN TR·ªåNG:
            // Ph·∫£i d√πng ƒë√∫ng t√™n class l√† '.math-toolbar' (kh·ªõp v·ªõi HTML) thay v√¨ '.math-bar'
            if (!editorPanel.contains(e.target) &&
                !e.target.closest('.math-box') &&
                !e.target.closest('.math-toolbar') && // <--- S·ª¨A D√íNG N√ÄY (math-bar -> math-toolbar)
                !e.target.closest('.toolbar') &&
                !e.target.closest('.img-controls') && // Th√™m c√°i n√†y ƒë·ªÉ n√∫t ·∫£nh kh√¥ng t·∫Øt editor
                editorPanel.style.display === 'flex') {
                closeEditor();
            }

            // B·ªè ch·ªçn media box khi click ra ngo√†i
            if (!e.target.closest('.media-box') && selectedMediaBox) {
                // N·∫øu click v√†o n√∫t ƒëi·ªÅu khi·ªÉn ·∫£nh th√¨ ƒë·ª´ng b·ªè ch·ªçn
                if (!e.target.closest('.img-controls')) {
                    selectMedia(null);
                }
            }
        });
        
        latexInput.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'r') { 
                e.preventDefault(); 
                renderCurrentBox(); 
            }
            if (e.ctrlKey && e.key === 'Enter') { 
                e.preventDefault(); 
                closeEditor(); 
            }
        });
        
        window.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'x' && activeMathBox) {
                e.preventDefault();
                activeMathBox.remove();
                closeEditor();
                saveAppState();
            }
        });

        updatePageIndicator();
        saveAppState(); // L∆∞u trang tr·∫Øng ƒë·∫ßu ti√™n
    }

    function resizeCanvas() {
        const rect = contentContainer.getBoundingClientRect();
        canvas.width = wrapper.offsetWidth;
        canvas.height = Math.max(rect.height, 5000);
        canvas.style.width = '100%';
        canvas.style.height = 'auto';
    }
    
    window.onload = init; 
    window.onresize = () => {
        // L∆∞u l·∫°i k√≠ch th∆∞·ªõc c≈©
        resizeCanvas();

        // Thay v√¨ ch·ª•p ·∫£nh, ta v·∫Ω l·∫°i t·ª´ tr·∫°ng th√°i l·ªãch s·ª≠ g·∫ßn nh·∫•t (n·∫øu c√≥)
        // C√°ch n√†y ƒë·∫£m b·∫£o khi b√†n ph√≠m hi·ªán l√™n, h√¨nh kh√¥ng b·ªã m·∫•t
        if (appHistory.length > 0 && appStep >= 0) {
            restoreState(appHistory[appStep]);
        } else {
            // N·∫øu ch∆∞a c√≥ l·ªãch s·ª≠ th√¨ gi·ªØ nguy√™n (th∆∞·ªùng l√† l√∫c m·ªõi m·ªü)
        }

        // Thi·∫øt l·∫≠p l·∫°i n√©t v·∫Ω
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = 2.5;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
    };
    
    wrapper.addEventListener('mousemove', (e) => { 
        mouseX = e.clientX; 
        mouseY = e.clientY; 
    });

    // --- EDITOR FUNCTIONS ---
    function openEditorFor(box) {
        if (activeMathBox) activeMathBox.classList.remove('active');
        activeMathBox = box;
        activeMathBox.classList.add('active');
        editorPanel.style.display = 'flex';
        latexInput.value = box.dataset.raw || "";
        latexInput.focus();
    }

    function closeEditor() {
        if (activeMathBox && latexInput.value.trim() !== "") {
            activeMathBox.dataset.raw = latexInput.value;
            renderCurrentBox();
        }
        
        editorPanel.style.display = 'none';
        if (activeMathBox) {
            activeMathBox.classList.remove('active');
            activeMathBox = null;
        }
    }

    function renderCurrentBox() {
        if (!activeMathBox) return;
        const raw = latexInput.value;
        activeMathBox.dataset.raw = raw;
        const contentDiv = activeMathBox.querySelector('.math-content');
        
        contentDiv.innerHTML = raw;
        
        MathJax.typesetPromise([contentDiv]).then(() => {
            contentDiv.querySelectorAll('svg').forEach(svg => {
                svg.style.fill = currentColor;
                svg.style.color = currentColor;
                svg.style.stroke = currentColor;
            });
        }).catch((err) => console.log("MathJax error:", err));
    }

    // --- TOOL MANAGEMENT ---
    function setTool(toolName) {
        if(toolName === 'hand') { 
            currentTool = 'hand'; 
            document.getElementById('btnHand').classList.add('active'); 
            wrapper.style.cursor = 'grab';
        } else { 
            currentTool = toolName; 
            document.getElementById('btnHand').classList.remove('active'); 
            wrapper.style.cursor = 'crosshair'; 
        }
        updateToolState();
    }
    
    function updateToolState() {
        if (currentTool === 'hand') { 
            wrapper.classList.remove('drawing-active'); 
            wrapper.classList.add('hand-active'); 
        } else { 
            wrapper.classList.add('drawing-active'); 
            wrapper.classList.remove('hand-active'); 
        }
    }

    // --- COLOR ---
    const colorPalette = ['#ffffff', '#ff4757', '#ffeb3b', '#3498db', '#2ecc71', '#9b59b6', '#e74c3c', '#1abc9c'];
    let colorIndex = 0;
    
    function cycleColor() { 
        colorIndex = (colorIndex + 1) % colorPalette.length; 
        updateColor(colorPalette[colorIndex]); 
    }
    
    function updateColor(color) { 
        currentColor = color; 
        ctx.strokeStyle = color; 
        colorStatus.style.background = color; 
        
        if(activeMathBox) { 
            activeMathBox.style.color = color; 
            activeMathBox.querySelectorAll('svg').forEach(svg => {
                svg.style.fill = color;
                svg.style.color = color;
                svg.style.stroke = color;
            }); 
        }
    }

    // --- H√ÄM TH√äM ·∫¢NH/WEB (ƒê√É S·ª¨A LOGIC ZOOM) ---
    function addMedia(type, src) {
        const div = document.createElement('div');
        div.className = 'media-box';

        // V·ªã tr√≠ xu·∫•t hi·ªán
        div.style.left = '100px';
        div.style.top = (wrapper.scrollTop + 100) + 'px';

        // Kh·ªüi t·∫°o th√¥ng s·ªë bi·∫øn h√¨nh (Quan tr·ªçng)
        div.dataset.scale = 1;
        div.dataset.rotation = 0;

        let contentHtml = '';
        let controlsHtml = '';

        if(type === 'img') {
            // C·∫•u h√¨nh ·∫¢NH: K√≠ch th∆∞·ªõc t·ª± ƒë·ªông, gi·ªõi h·∫°n max
            div.style.width = 'auto';
            div.style.maxWidth = '600px';

            contentHtml = `<div class="media-content"><img src="${src}"></div>`;

            // THANH C√îNG C·ª§: Zoom +, Zoom -, Xoay, X√≥a
            controlsHtml = `
                <div class="img-controls">
                    <button class="img-btn" onclick="transformMedia(this, 0.1, 0)" title="Ph√≥ng to">+</button>
                    <button class="img-btn" onclick="transformMedia(this, -0.1, 0)" title="Thu nh·ªè">-</button>
                    <button class="img-btn" onclick="transformMedia(this, 0, 45)" title="Xoay 45 ƒë·ªô">‚Üª</button>
                    <button class="img-btn" onclick="this.closest('.media-box').remove(); saveAppState();" style="background:#c0392b; border-color:#e74c3c" title="X√≥a">‚úï</button>
                </div>
            `;
        } else {
            // C·∫•u h√¨nh WEB
            div.style.width = '500px';
            div.style.height = '400px';
            contentHtml = `
                <div class="web-header">
                    <span>üåê Web</span>
                    <div>
                        <button onclick="toggleWebInteraction(this)" style="font-size:10px;cursor:pointer;margin-right:5px">üîì M·ªü</button>
                        <span onclick="this.closest('.media-box').remove(); saveAppState();" style="cursor:pointer; color:#ff5555; font-weight:bold">‚úï</span>
                    </div>
                </div>
                <div class="media-content"><iframe src="${src}"></iframe><div class="web-blocker"></div></div>
                <div class="t-handle th-se"></div>
            `;
        }

        div.innerHTML = controlsHtml + contentHtml;
        contentContainer.appendChild(div); // D√°n v√†o container ch√≠nh

        // X·ª≠ l√Ω s·ª± ki·ªán K√©o th·∫£ (Drag)
        div.onmousedown = (e) => {
            // N·∫øu b·∫•m v√†o n√∫t ƒëi·ªÅu khi·ªÉn th√¨ KH√îNG k√≠ch ho·∫°t k√©o
            if(e.target.tagName === 'BUTTON' || e.target.closest('.img-controls') || e.target.classList.contains('t-handle')) return;

            e.stopPropagation();
            selectMedia(div);
            initDrag(e, div);
        };

        // Resize cho Web
        if (type === 'web') {
            const resizer = div.querySelector('.th-se');
            if(resizer) resizer.onmousedown = (e) => { e.stopPropagation(); initResize(e, div); };
        }

        selectMedia(div); // T·ª± ƒë·ªông ch·ªçn khi m·ªõi t·∫°o
        saveAppState(); // <-- TH√äM D√íNG N√ÄY ·ªû CU·ªêI H√ÄM
    }

    // --- H√ÄM X·ª¨ L√ù BI·∫æN H√åNH (ZOOM / XOAY) ---
    function transformMedia(btn, scaleDelta, rotateDelta) {
        // NgƒÉn kh√¥ng cho s·ª± ki·ªán click xuy√™n qua l√†m m·∫•t ch·ªçn ·∫£nh
        if(window.event) window.event.stopPropagation();

        const box = btn.closest('.media-box');

        // 1. L·∫•y gi√° tr·ªã hi·ªán t·∫°i
        let currentScale = parseFloat(box.dataset.scale) || 1;
        let currentRotation = parseFloat(box.dataset.rotation) || 0;

        // 2. T√≠nh to√°n m·ªõi
        currentScale += scaleDelta;
        currentRotation += rotateDelta;

        // Gi·ªõi h·∫°n zoom (Min 0.2, Max 5)
        if (currentScale < 0.2) currentScale = 0.2;
        if (currentScale > 5) currentScale = 5;

        // 3. L∆∞u l·∫°i v√†o dataset
        box.dataset.scale = currentScale;
        box.dataset.rotation = currentRotation;

        // 4. √Åp d·ª•ng CSS Transform (Ch·ªâ t√°c ƒë·ªông l√™n ·∫£nh b√™n trong ho·∫∑c c·∫£ h·ªôp)
        // ·ªû ƒë√¢y ta t√°c ƒë·ªông l√™n c·∫£ h·ªôp ƒë·ªÉ khung vi·ªÅn xoay theo
        box.style.transform = `scale(${currentScale}) rotate(${currentRotation}deg)`;

        // C·∫≠p nh·∫≠t l·∫°i UI selection
        selectMedia(box);
        saveAppState(); // <-- TH√äM D√íNG N√ÄY ·ªû CU·ªêI H√ÄM (T√ôY CH·ªåN)
    }

    // --- H√ÄM CH·ªåN ƒê·ªêI T∆Ø·ª¢NG (QUAN TR·ªåNG) ---
    function selectMedia(box) {
        // B·ªè ch·ªçn c√°i c≈©
        if(selectedMediaBox && selectedMediaBox !== box) {
            selectedMediaBox.classList.remove('selected');
        }

        selectedMediaBox = box;

        if(box) {
            box.classList.add('selected');
            // N·∫øu ƒëang b·∫≠t v·∫Ω, t·∫°m th·ªùi t·∫Øt ƒë·ªÉ thao t√°c ·∫£nh d·ªÖ h∆°n (T√πy ch·ªçn)
            if(isAnnotationMode) {
                // document.body.classList.remove('drawing-mode'); // B·ªè d√≤ng n√†y n·∫øu mu·ªën v·ª´a v·∫Ω v·ª´a ch·ªânh
            }
        }
    }

    // --- X·ª¨ L√ù CH·ªåN ·∫¢NH (C≈®, CHUY·ªÇN SANG addMedia) ---
    document.getElementById('imageInput').onchange = function(e) {
        if (!e.target.files[0]) return;

        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
            addMedia('img', event.target.result);
        };
        reader.readAsDataURL(file);

        e.target.value = '';
    };

    // --- PDF CH√àN D√çNH T·∫§T C·∫¢ TRANG ---
    document.getElementById('pdfInput').onchange = async function(e) {
        if (!e.target.files[0]) return;
        
        document.getElementById('loading').style.display = 'block';
        
        try {
            const file = e.target.files[0];
            const pdfContainer = document.createElement('div');
            pdfContainer.className = 'pdf-container';
            pdfContainer.dataset.page = currentPage;
            
            const pdfData = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
            let totalHeight = 0;
            const containerWidth = wrapper.offsetWidth - 40;
            
            for (let i = 1; i <= pdfData.numPages; i++) {
                const page = await pdfData.getPage(i);
                const viewport = page.getViewport({ scale: 1 });
                const scale = containerWidth / viewport.width;
                const scaledViewport = page.getViewport({ scale: scale });
                
                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-page';
                const context = canvas.getContext('2d');
                
                canvas.width = scaledViewport.width;
                canvas.height = scaledViewport.height;
                
                await page.render({
                    canvasContext: context,
                    viewport: scaledViewport
                }).promise;
                
                pdfContainer.appendChild(canvas);
                totalHeight += scaledViewport.height;
            }
            
            contentContainer.appendChild(pdfContainer);
            makeElementDraggable(pdfContainer, pdfContainer);
            
            const closeBtn = document.createElement('div');
            closeBtn.innerHTML = '‚úï';
            closeBtn.style.cssText = 'position:absolute; top:10px; right:10px; background:rgba(255,0,0,0.7); color:white; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:bold; z-index:10;';
            closeBtn.onclick = () => pdfContainer.remove();
            pdfContainer.appendChild(closeBtn);
            
            updateContainerHeight();
            
            if (!document.body.classList.contains('drawing-mode')) {
                toggleAnnotation();
            }
            
        } catch (error) {
            alert("L·ªói khi t·∫£i PDF: " + error.message);
        }
        
        document.getElementById('loading').style.display = 'none';
        e.target.value = '';
    };

    // --- MATH BOX ---
    function handleDoubleClick(e) { 
        if (e.target === canvas || e.target === contentContainer) {
            const rect = wrapper.getBoundingClientRect();
            createMathBox(e.clientX - rect.left + wrapper.scrollLeft, e.clientY - rect.top + wrapper.scrollTop);
        }
    }
    
    function createCenteredMathBox() { 
        const rect = wrapper.getBoundingClientRect();
        createMathBox(rect.width/2 - 100, rect.height/2 - 50 + wrapper.scrollTop); 
    }

    function createMathBox(x, y) {
        const box = document.createElement('div'); 
        box.className = 'math-box';
        box.style.left = x + 'px'; 
        box.style.top = y + 'px'; 
        box.style.color = currentColor;
        box.dataset.page = currentPage;
        
        const handle = document.createElement('div');
        handle.className = 'math-handle';

        // --- X√ìA HO·∫∂C ·∫®N ƒêO·∫†N T·ª™ ƒê√ÇY ---
        /* const stampBtn = document.createElement('button');
        stampBtn.className = 'stamp-btn';
        stampBtn.innerHTML = 'üìå';
        stampBtn.title = "D√°n d√≠nh v√†o PDF";
        stampBtn.onclick = (e) => {
            e.stopPropagation();
            flattenBox(box);
        };
        handle.appendChild(stampBtn);
        */
        // --- ƒê·∫æN ƒê√ÇY ---

        // Th√™m n√∫t X√≥a (N√™n gi·ªØ l·∫°i n√∫t n√†y ƒë·ªÉ x√≥a box)
        const delBtn = document.createElement('button');
        delBtn.className = 'stamp-btn';
        delBtn.innerHTML = '‚úï';
        delBtn.style.color = '#ff4757'; // M√†u ƒë·ªè cho d·ªÖ nh√¨n
        delBtn.onclick = (e) => {
            e.stopPropagation();
            box.remove();
            closeEditor();
            saveAppState(); // L∆∞u l·ªãch s·ª≠ khi x√≥a
        };
        handle.appendChild(delBtn);

        box.appendChild(handle);
        
        const content = document.createElement('div'); 
        content.className = 'math-content'; 
        box.appendChild(content); 
        
        contentContainer.appendChild(box);

        box.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            openEditorFor(box);
        });
        
        openEditorFor(box);
        makeElementDraggable(box, box);
        updateContainerHeight();
        saveAppState(); // <-- TH√äM D√íNG N√ÄY ·ªû CU·ªêI H√ÄM
    }

    // --- FLATTEN BOX (GHIM V√ÄO PDF) ---
    async function flattenBox(box) {
        if (activeMathBox === box) {
            box.dataset.raw = latexInput.value;
            renderCurrentBox();
            closeEditor();
        }
        
        const handle = box.querySelector('.math-handle'); 
        handle.style.display = 'none';
        box.style.border = 'none'; 
        box.style.boxShadow = 'none'; 
        box.style.background = 'transparent';
        
        try {
            const canvasImg = await html2canvas(box, { backgroundColor: null, scale: 1.5 });
            const img = document.createElement('img');
            img.src = canvasImg.toDataURL();
            img.className = 'math-sticker';
            
            const pdfContainers = document.querySelectorAll('.pdf-container');
            let targetContainer = null;
            
            pdfContainers.forEach(container => {
                const boxRect = box.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                
                const overlap = !(boxRect.right < containerRect.left || 
                                 boxRect.left > containerRect.right || 
                                 boxRect.bottom < containerRect.top || 
                                 boxRect.top > containerRect.bottom);
                
                if (overlap) {
                    targetContainer = container;
                }
            });
            
            if (targetContainer) {
                img.style.left = (parseFloat(box.style.left) - parseFloat(targetContainer.style.left) || 0) + 'px';
                img.style.top = (parseFloat(box.style.top) - parseFloat(targetContainer.style.top) || 0) + 'px';
                img.style.width = box.offsetWidth + 'px';
                img.style.height = 'auto';
                targetContainer.appendChild(img);
            } else {
                const rect = box.getBoundingClientRect();
                const wrapperRect = wrapper.getBoundingClientRect();
                const x = rect.left - wrapperRect.left;
                const y = rect.top - wrapperRect.top + wrapper.scrollTop;
                ctx.drawImage(canvasImg, x, y, rect.width, rect.height);
                saveHistory();
            }
            
            box.remove();
        } catch(e) { 
            alert("L·ªói khi ghim: " + e); 
        }
    }

    // --- INSERT MATH SNIPPETS ---
    function insertMath(code) {
        if (!activeMathBox) { 
            createCenteredMathBox(); 
            setTimeout(() => insertMath(code), 100); 
            return; 
        }
        
        const inp = document.getElementById('latex-input'); 
        inp.value += code; 
        inp.focus();
    }

    // --- DRAWING ENGINE ---
    function getPointerPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function startDraw(e) {
        if (currentTool === 'hand') return; 
        if(e.target.closest('.math-box') || e.target.closest('#editor-panel') || 
           e.target.closest('.pasted-image') || e.target.closest('.web-header')) return;
        if(e.cancelable) e.preventDefault(); 
        
        isDrawing = true;
        points = [getPointerPos(e)];
        snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
        ctx.beginPath(); 
        ctx.moveTo(points[0].x, points[0].y);
    }

    function moveDraw(e) {
        if (!isDrawing) return;
        if(e.cancelable) e.preventDefault();

        const cur = getPointerPos(e);
        ctx.putImageData(snapshot, 0, 0);

        if (currentTool === 'pen' || currentTool === 'highlighter') {
            ctx.save();
            if (currentTool === 'highlighter') { 
                ctx.globalAlpha = 0.3; 
                ctx.lineWidth = 20; 
                ctx.strokeStyle = "yellow"; 
                ctx.lineCap = "butt"; 
            } else { 
                ctx.lineWidth = 2.5; 
                ctx.strokeStyle = currentColor; 
            }
            
            points.push(cur); 
            ctx.beginPath(); 
            ctx.moveTo(points[0].x, points[0].y);
            
            for (let i = 1; i < points.length - 2; i++) {
                const xc = (points[i].x + points[i+1].x) / 2;
                const yc = (points[i].y + points[i+1].y) / 2;
                ctx.quadraticCurveTo(points[i].x, points[i].y, xc, yc);
            }
            
            if (points.length > 2) {
                ctx.quadraticCurveTo(
                    points[points.length-2].x, 
                    points[points.length-2].y, 
                    points[points.length-1].x, 
                    points[points.length-1].y
                );
            }
            
            ctx.stroke(); 
            ctx.restore();
        } else {
            if (currentTool === 'dashedLine') { 
                ctx.save(); 
                ctx.setLineDash([8, 8]); 
                ctx.beginPath(); 
                ctx.moveTo(points[0].x, points[0].y); 
                ctx.lineTo(cur.x, cur.y); 
                ctx.stroke(); 
                ctx.restore(); 
            } else {
                ctx.beginPath();
                if (currentTool === 'line') { 
                    ctx.moveTo(points[0].x, points[0].y); 
                    ctx.lineTo(cur.x, cur.y); 
                }
                else if (currentTool === 'rect') 
                    ctx.rect(points[0].x, points[0].y, cur.x - points[0].x, cur.y - points[0].y);
                else if (currentTool === 'circle') { 
                    let r = Math.sqrt((cur.x - points[0].x)**2 + (cur.y - points[0].y)**2); 
                    ctx.arc(points[0].x, points[0].y, r, 0, 2 * Math.PI); 
                }
                
                else if (currentTool === 'cube') drawCube3D(points[0].x, points[0].y, cur.x, cur.y);
                else if (currentTool === 'tri_pyramid') drawTriPyramid3D(points[0].x, points[0].y, cur.x, cur.y);
                else if (currentTool === 'quad_pyramid') drawQuadPyramid3D(points[0].x, points[0].y, cur.x, cur.y);
                else if (currentTool === 'cone') drawCone3D(points[0].x, points[0].y, cur.x, cur.y);
                else if (currentTool === 'cylinder') drawCylinder3D(points[0].x, points[0].y, cur.x, cur.y);
                else if (currentTool === 'sphere') drawSphere3D(points[0].x, points[0].y, cur.x, cur.y);
                
                ctx.stroke();
            }
        }
    }

    function endDraw() {
        if(isDrawing) {
            isDrawing = false;
            saveAppState(); // <-- TH√äM D√íNG M·ªöI N√ÄY
        }
    }

    canvas.addEventListener('mousedown', startDraw); 
    canvas.addEventListener('mousemove', moveDraw); 
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('touchstart', startDraw, {passive: false}); 
    canvas.addEventListener('touchmove', moveDraw, {passive: false}); 
    canvas.addEventListener('touchend', endDraw);

    // --- 3D DRAWING FUNCTIONS ---
    function drawTriPyramid3D(x1, y1, x2, y2) {
        const S = {x: x1, y: y1}, width = x2 - x1, height = y2 - y1;
        const B = {x: x1 - width, y: y1 + height}, C = {x: x1 + width, y: y1 + height}, A = {x: x1 - width * 0.3, y: y1 + height - height * 0.3};
        ctx.beginPath(); ctx.setLineDash([8, 8]); ctx.moveTo(S.x, S.y); ctx.lineTo(A.x, A.y); ctx.moveTo(B.x, B.y); ctx.lineTo(A.x, A.y); ctx.lineTo(C.x, C.y); ctx.stroke(); 
        ctx.setLineDash([]); ctx.beginPath(); ctx.moveTo(S.x, S.y); ctx.lineTo(B.x, B.y); ctx.lineTo(C.x, C.y); ctx.lineTo(S.x, S.y); ctx.stroke();
    }
    
    function drawQuadPyramid3D(x1, y1, x2, y2) {
        const baseW = Math.abs(x2 - x1), baseH = Math.abs(y2 - y1), cx = x1, cy = y2, top = {x: cx, y: y1};
        const p1 = {x: cx - baseW, y: cy + baseH*0.2}, p2 = {x: cx + baseW, y: cy + baseH*0.2}, p3 = {x: cx + baseW*1.3, y: cy - baseH*0.2}, p4 = {x: cx - baseW*0.7, y: cy - baseH*0.2};
        ctx.beginPath(); ctx.setLineDash([8, 8]); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p4.x, p4.y); ctx.lineTo(p3.x, p3.y); ctx.moveTo(top.x, top.y); ctx.lineTo(p4.x, p4.y); ctx.stroke();
        ctx.setLineDash([]); ctx.beginPath(); ctx.moveTo(top.x, top.y); ctx.lineTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.lineTo(top.x, top.y); ctx.lineTo(p3.x, p3.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
    }
    
    function drawCube3D(x1, y1, x2, y2) {
        const w = x2 - x1, h = y2 - y1, d = w * 0.4;
        ctx.beginPath(); ctx.setLineDash([8, 8]); ctx.moveTo(x1, y1+h); ctx.lineTo(x1+d, y1+h-d); ctx.lineTo(x1+d, y1-d); ctx.moveTo(x1+d, y1+h-d); ctx.lineTo(x1+w+d, y1+h-d); ctx.stroke();
        ctx.setLineDash([]); ctx.beginPath(); ctx.rect(x1, y1, w, h); ctx.moveTo(x1, y1); ctx.lineTo(x1+d, y1-d); ctx.lineTo(x1+w+d, y1-d); ctx.lineTo(x1+w, y1); ctx.moveTo(x1+w, y1); ctx.lineTo(x1+w+d, y1-d); ctx.lineTo(x1+w+d, y1+h-d); ctx.lineTo(x1+w, y1+h); ctx.stroke();
    }
    
    function drawCylinder3D(x1, y1, x2, y2) {
        const rx = Math.abs(x2-x1)/2, ry=rx*0.3, cx=(x1+x2)/2, tY=Math.min(y1,y2), bY=Math.max(y1,y2);
        ctx.beginPath(); ctx.setLineDash([8, 8]); ctx.ellipse(cx, bY, rx, ry, 0, Math.PI, 2*Math.PI); ctx.stroke(); 
        ctx.setLineDash([]); ctx.beginPath(); ctx.ellipse(cx, tY, rx, ry, 0, 0, 2*Math.PI); ctx.moveTo(cx-rx, tY); ctx.lineTo(cx-rx, bY); ctx.moveTo(cx+rx, tY); ctx.lineTo(cx+rx, bY); ctx.ellipse(cx, bY, rx, ry, 0, 0, Math.PI); ctx.stroke();
    }
    
    function drawCone3D(x1, y1, x2, y2) {
        const rx = Math.abs(x2-x1)/2, ry=rx*0.3, cx=(x1+x2)/2, tY=y1, bY=y2;
        ctx.beginPath(); ctx.setLineDash([8, 8]); ctx.ellipse(cx, bY, rx, ry, 0, Math.PI, 2*Math.PI); ctx.stroke();
        ctx.setLineDash([]); ctx.beginPath(); ctx.moveTo(cx-rx, bY); ctx.lineTo(cx, tY); ctx.lineTo(cx+rx, bY); ctx.ellipse(cx, bY, rx, ry, 0, 0, Math.PI); ctx.stroke();
    }
    
    function drawSphere3D(x1, y1, x2, y2) {
        const r=Math.sqrt((x2-x1)**2+(y2-y1)**2); 
        ctx.beginPath(); ctx.setLineDash([8, 8]); ctx.ellipse(x1, y1, r, r*0.3, 0, Math.PI, 2*Math.PI); ctx.stroke();
        ctx.setLineDash([]); ctx.beginPath(); ctx.arc(x1, y1, r, 0, 2*Math.PI); ctx.moveTo(x1+r, y1); ctx.ellipse(x1, y1, r, r*0.3, 0, 0, Math.PI); ctx.stroke();
    }

    // --- C·∫¨P NH·∫¨T CHI·ªÄU CAO CONTAINER ---
    function updateContainerHeight() {
        let maxBottom = 0;
        
        const elements = contentContainer.querySelectorAll('.pdf-container, .web-container, .math-box, .media-box');
        elements.forEach(el => {
            const rect = el.getBoundingClientRect();
            const bottom = parseFloat(el.style.top) + rect.height;
            if (bottom > maxBottom) {
                maxBottom = bottom;
            }
        });
        
        contentContainer.style.minHeight = Math.max(maxBottom + 200, 5000) + 'px';
        resizeCanvas();
    }

    // --- WEB IFRAME CAO ---
    function addWebsite() {
        let url = prompt("Nh·∫≠p URL trang web:", "https://nguyenthanhbinh.edu.vn");
        if (!url) return;
        
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            url = 'https://' + url;
        }
        
        const webContainer = document.createElement('div');
        webContainer.className = 'web-container';
        webContainer.dataset.page = currentPage;
        
        const header = document.createElement('div');
        header.className = 'web-header';
        header.innerHTML = `
            <span>üåê ${url}</span>
            <span style="cursor:pointer;color:#ff4757;font-weight:bold;" onclick="this.parentElement.parentElement.remove()">‚úï</span>
        `;
        
        const iframe = document.createElement('iframe');
        iframe.className = 'web-iframe';
        iframe.src = url;
        iframe.sandbox = "allow-same-origin allow-scripts allow-popups allow-forms";
        
        webContainer.appendChild(header);
        webContainer.appendChild(iframe);
        
        contentContainer.appendChild(webContainer);
        makeElementDraggable(webContainer, header);
        updateContainerHeight();
        
        if (!document.body.classList.contains('drawing-mode')) {
            toggleAnnotation();
        }
    }

    // --- OTHER UTILS ---
    function toggleFullScreen() { 
        if(!document.fullscreenElement) document.documentElement.requestFullscreen(); 
        else document.exitFullscreen(); 
    }
    
    let isAnnotationMode = true; 
    /* --- S·ª¨A H√ÄM toggleAnnotation ƒê·ªÇ KH√îNG CH√àN CH·ªÆ V√ÄO N√öT --- */
    function toggleAnnotation() {
        isAnnotationMode = !isAnnotationMode;
        const btn = document.getElementById('btnAnnotate');

        if (isAnnotationMode) {
            // Ch·ªâ ƒë·ªïi m√†u n·ªÅn, kh√¥ng ƒë·ªïi n·ªôi dung text n·ªØa
            btn.style.background = "#d35400"; // M√†u cam ƒë·∫≠m (B·∫≠t)
            btn.style.border = "1px solid #fff";
            document.body.classList.add('drawing-mode');
        } else {
            btn.style.background = "#333";    // M√†u t·ªëi (T·∫Øt)
            btn.style.border = "1px solid #555";
            document.body.classList.remove('drawing-mode');
        }
    }

    // --- PAGINATION ---
    function updatePageIndicator() { 
        document.getElementById('pageIndicator').innerText = `${currentPage + 1} / ${pages.length}`; 
    }
    
    function saveCurrentPageState() { 
        pages[currentPage].canvasData = canvas.toDataURL(); 
    }
    
    function switchPage(index) {
        if(index < 0 || index >= pages.length) return;
        
        saveCurrentPageState(); 
        currentPage = index; 
        const p = pages[currentPage];
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        if(p.canvasData) { 
            const img = new Image(); 
            img.src = p.canvasData; 
            img.onload = () => ctx.drawImage(img, 0, 0); 
        }
        
        document.querySelectorAll('.pdf-container, .web-container, .math-box, .media-box').forEach(el => {
            if(!el.dataset.page) el.dataset.page = 0; 
            el.style.display = (parseInt(el.dataset.page) === currentPage) ? 'block' : 'none';
        });
        
        updatePageIndicator();
    }
    
    function nextPage() { 
        if(currentPage < pages.length - 1) switchPage(currentPage + 1); 
        else if(confirm("T·∫°o trang m·ªõi?")) addPage(); 
    }
    
    function prevPage() { 
        if(currentPage > 0) switchPage(currentPage - 1); 
    }
    
    function addPage() { 
        saveCurrentPageState(); 
        pages.push({canvasData: null}); 
        switchPage(pages.length - 1); 
    }

    // --- LABEL BOX ---
    function createLabelBox(x, y) {
        const box = document.createElement('div'); 
        box.className = 'label-box';
        box.contentEditable = "true"; 
        box.spellcheck = false; 
        box.dataset.page = currentPage; 
        box.innerText = "A"; 
        
        const rect = wrapper.getBoundingClientRect();
        let finalX = x - rect.left; 
        let finalY = y - rect.top + wrapper.scrollTop; 
        
        if(finalX < 0) finalX = 10; 
        if(finalY < 0) finalY = 10;
        
        box.style.left = finalX + 'px'; 
        box.style.top = finalY + 'px';
        contentContainer.appendChild(box); 
        
        makeElementDraggable(box, box);
        
        setTimeout(() => { 
            box.focus(); 
            document.execCommand('selectAll', false, null); 
        }, 10);
        
        updateContainerHeight();
    }
    
    window.addEventListener('keydown', (e) => { 
        if ((e.ctrlKey || e.metaKey) && (e.key === 'd' || e.key === 'D')) { 
            e.preventDefault(); 
            createLabelBox(mouseX, mouseY); 
        } 
    });

    // --- DRAGGABLE ELEMENTS ---
    function makeElementDraggable(el, handle) {
        let isDrag = false, startX, startY, startLeft, startTop;
        
        handle.addEventListener('mousedown', (e) => { 
            if(e.target.tagName === 'BUTTON' || e.target.className === 'img-btn') return; 
            e.preventDefault(); 
            e.stopPropagation();
            
            isDrag = true; 
            startX = e.clientX; 
            startY = e.clientY; 
            startLeft = parseFloat(el.style.left) || 0; 
            startTop = parseFloat(el.style.top) || 0; 
            
            document.addEventListener('mousemove', onMouseMove); 
            document.addEventListener('mouseup', onMouseUp); 
        });
        
        function onMouseMove(e) {
            if(!isDrag) return;
            e.preventDefault();
            
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            
            el.style.left = (startLeft + dx) + 'px';
            el.style.top = (startTop + dy) + 'px';
        }
        
        function onMouseUp() {
            isDrag = false;
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }
    }

    // --- HISTORY ---
    function saveHistory() { 
        if(historyStep < history.length - 1) {
            history = history.slice(0, historyStep + 1); 
        }
        history.push(canvas.toDataURL()); 
        historyStep++; 
    }
    
    function undo() { 
        if(historyStep > 0){ 
            historyStep--; 
            const img = new Image(); 
            img.src = history[historyStep]; 
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
        } else if(historyStep === 0){ 
            historyStep = -1; 
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
        } 
    }
    
    function redo() { 
        if(historyStep < history.length - 1){ 
            historyStep++; 
            const img = new Image(); 
            img.src = history[historyStep]; 
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
        } 
    }

    // --- EXPORT PDF (LOGIC M·ªöI: T·ª∞ ƒê·ªòNG C·∫ÆT TRANG A4) ---
    async function exportFullPDF() {
        const loading = document.getElementById('loading');
        loading.style.display = 'block';
        loading.innerText = "ƒêang x·ª≠ l√Ω ·∫£nh..."; // C·∫≠p nh·∫≠t text cho th·∫ßy bi·∫øt

        try {
            // 1. Ch·ª•p to√†n b·ªô n·ªôi dung b·∫£ng (contentContainer)
            // L∆∞u √Ω: D√πng scale 1.5 ho·∫∑c 2 ƒë·ªÉ n√©t h∆°n
            const canvasFull = await html2canvas(contentContainer, {
                scale: 1.5,
                useCORS: true,
                backgroundColor: '#ffffff', // ƒê·∫∑t n·ªÅn tr·∫Øng cho PDF ƒë·∫πp
                // B·ªè qua c√°c n√∫t ƒëi·ªÅu khi·ªÉn khi ch·ª•p
                ignoreElements: (el) => el.classList.contains('pagination-bar') ||
                                      el.classList.contains('img-controls') ||
                                      el.classList.contains('t-handle') ||
                                      el.id === 'welcome'
            });

            loading.innerText = "ƒêang t·∫°o file PDF...";

            const { jsPDF } = window.jspdf;
            // T·∫°o file PDF kh·ªï A4 d·ªçc ('p' = portrait)
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfW = pdf.internal.pageSize.getWidth();
            const pdfH = pdf.internal.pageSize.getHeight();

            // L·∫•y k√≠ch th∆∞·ªõc ·∫£nh ch·ª•p ƒë∆∞·ª£c
            const imgData = canvasFull.toDataURL("image/jpeg", 0.9);
            const imgW = canvasFull.width;
            const imgH = canvasFull.height;

            // T√≠nh chi·ªÅu cao c·ªßa 1 trang PDF khi quy ƒë·ªïi t·ª´ ·∫£nh sang
            const pageImgH = (imgW * pdfH) / pdfW;
            let heightLeft = imgH; // Chi·ªÅu cao c√≤n l·∫°i ch∆∞a in

            // 2. IN TRANG ƒê·∫¶U TI√äN
            pdf.addImage(imgData, 'JPEG', 0, 0, pdfW, (imgH * pdfW) / imgW);
            heightLeft -= pageImgH;

            // 3. V√íNG L·∫∂P: C·∫ÆT C√ÅC TRANG TI·∫æP THEO (N·∫øu b·∫£ng d√†i)
            while (heightLeft > 0) {
                pdf.addPage(); // Th√™m trang gi·∫•y m·ªõi

                // B√≠ thu·∫≠t: V·∫Ω l·∫°i ·∫£nh ƒë√≥ nh∆∞ng d·ªãch t·ªça ƒë·ªô Y l√™n tr√™n (√¢m) ƒë·ªÉ ch·ªâ hi·ªán ph·∫ßn d∆∞·ªõi
                const shiftY = -(imgH * pdfW / imgW) + (heightLeft * pdfW / imgW);

                // ƒêi·ªÅu ch·ªânh m·ªôt ch√∫t (-1) ƒë·ªÉ kh·ªõp n·ªëi gi·ªØa 2 trang kh√¥ng b·ªã h·ªü tr·∫Øng
                pdf.addImage(imgData, 'JPEG', 0, shiftY - 1, pdfW, (imgH * pdfW) / imgW);

                heightLeft -= pageImgH;
            }

            // 4. L∆∞u file
            pdf.save("BaiGiang_DayDu.pdf");

        } catch (error) {
            alert("L·ªói xu·∫•t PDF: " + error.message);
            console.error(error);
        }

        loading.style.display = 'none';
        loading.innerText = "‚è≥ ƒêang x·ª≠ l√Ω..."; // Tr·∫£ l·∫°i text c≈©
    }

    // --- JITSI FUNCTIONS ---
    function toggleLiveModal() { 
        const m = document.getElementById('liveModal'); 
        m.style.display = m.style.display === 'block' ? 'none' : 'block'; 
    }
    
    function startJitsi() {
        if(jitsiApi) return alert("ƒêang ph√°t r·ªìi!");
        currentRoomName = 'LopHoc_' + Math.floor(Math.random() * 100000); 
        document.getElementById('roomNameDisplay').innerText = currentRoomName;
        document.getElementById('displayRoomCode').innerText = currentRoomName;
        document.getElementById('roomInfo').style.display = 'block';
        openJitsiFrame(currentRoomName, true); 
    }
    
    function joinJitsi() {
        currentRoomName = document.getElementById('roomNameInput').value.trim();
        if(!currentRoomName) return alert("Vui l√≤ng nh·∫≠p m√£ l·ªõp!");
        document.getElementById('displayRoomCode').innerText = currentRoomName;
        openJitsiFrame(currentRoomName, false); 
    }
    
    function openJitsiFrame(roomName, isTeacher) {
        document.getElementById('liveModal').style.display = 'none';
        document.getElementById('jitsi-container').style.display = 'block';
        const domain = 'meet.jit.si';
        const options = {
            roomName: roomName, 
            width: '100%', 
            height: '100%', 
            parentNode: document.getElementById('meet'), 
            lang: 'vi',
            configOverwrite: { 
                startWithAudioMuted: !isTeacher, 
                startWithVideoMuted: !isTeacher, 
                prejoinPageEnabled: false 
            },
            interfaceConfigOverwrite: { 
                SHOW_JITSI_WATERMARK: false, 
                TOOLBAR_BUTTONS: [ 'microphone', 'camera', 'desktop', 'chat', 'raisehand', 'tileview', 'fullscreen', 'hangup' ] 
            }
        };
        jitsiApi = new JitsiMeetExternalAPI(domain, options);
    }
    
    function openExternalJitsi() { 
        if(currentRoomName) window.open('https://meet.jit.si/' + currentRoomName, '_blank'); 
        else alert("Ch∆∞a c√≥ m√£ ph√≤ng!"); 
    }
    
    function closeJitsi() { 
        if(jitsiApi) { 
            jitsiApi.dispose(); 
            jitsiApi = null; 
        } 
        document.getElementById('jitsi-container').style.display = 'none'; 
    }
    
    function copyId() {
        navigator.clipboard.writeText(document.getElementById('roomNameDisplay').innerText);
        alert("ƒê√£ copy m√£ l·ªõp!");
    }

    // --- H√ÄM K√âO TH·∫¢ V√Ä RESIZE (CHO MEDIA BOX) ---
    function initDrag(e, element) {
        let startX = e.clientX;
        let startY = e.clientY;
        let startLeft = parseFloat(element.style.left) || 0;
        let startTop = parseFloat(element.style.top) || 0;

        function onMouseMove(e) {
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            element.style.left = (startLeft + dx) + 'px';
            element.style.top = (startTop + dy) + 'px';
        }

        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    }

    function initResize(e, element) {
        e.preventDefault();
        const startX = e.clientX;
        const startY = e.clientY;
        const startWidth = element.offsetWidth;
        const startHeight = element.offsetHeight;

        function onMouseMove(e) {
            const newWidth = Math.max(200, startWidth + (e.clientX - startX));
            const newHeight = Math.max(150, startHeight + (e.clientY - startY));
            element.style.width = newWidth + 'px';
            element.style.height = newHeight + 'px';
        }

        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    }

    // --- X·ª¨ L√ù WEB INTERACTION ---
    function toggleWebInteraction(btn) {
        const iframe = btn.closest('.media-box').querySelector('iframe');
        const blocker = btn.closest('.media-box').querySelector('.web-blocker');

        if (iframe.style.pointerEvents === 'auto') {
            iframe.style.pointerEvents = 'none';
            if (blocker) blocker.style.display = 'block';
            btn.textContent = 'üîì M·ªü';
        } else {
            iframe.style.pointerEvents = 'auto';
            if (blocker) blocker.style.display = 'none';
            btn.textContent = 'üîí Kh√≥a';
        }
    }

    function toggleHelp(){
        const m = document.getElementById('helpModal');
        m.style.display = m.style.display === 'block' ? 'none' : 'block';
    }

    // ============================================================
    // PH·∫¶N 1: H·ªÜ TH·ªêNG QU·∫¢N L√ù TR·∫†NG TH√ÅI (STATE MANAGEMENT)
    // ============================================================

    // 1. H√†m l·∫•y to√†n b·ªô tr·∫°ng th√°i hi·ªán t·∫°i (Snapshot)
    function getCurrentState() {
        // L∆∞u Canvas
        const canvasData = canvas.toDataURL();

        // L∆∞u c√°c ƒë·ªëi t∆∞·ª£ng DOM (Math box, ·∫¢nh, Web...)
        const elements = [];

        // a. L∆∞u Math Boxes
        document.querySelectorAll('.math-box').forEach(el => {
            elements.push({
                type: 'math',
                x: el.style.left,
                y: el.style.top,
                raw: el.dataset.raw || "",
                color: el.style.color,
                html: el.querySelector('.math-content').innerHTML
            });
        });

        // b. L∆∞u Media Boxes (·∫¢nh & Web)
        document.querySelectorAll('.media-box').forEach(el => {
            const img = el.querySelector('img');
            const iframe = el.querySelector('iframe');
            let contentSrc = "";
            let mediaType = "";

            if (img) { mediaType = 'img'; contentSrc = img.src; }
            else if (iframe) { mediaType = 'web'; contentSrc = iframe.src; }

            elements.push({
                type: mediaType,
                x: el.style.left,
                y: el.style.top,
                src: contentSrc,
                scale: el.dataset.scale || 1,
                rotation: el.dataset.rotation || 0,
                width: el.style.width,
                height: el.style.height
            });
        });

        return { canvasData, elements };
    }

    // 2. H√†m kh√¥i ph·ª•c tr·∫°ng th√°i t·ª´ d·ªØ li·ªáu (Restore)
    function restoreState(state) {
        // a. X√≥a s·∫°ch b·∫£ng hi·ªán t·∫°i
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        document.querySelectorAll('.math-box, .media-box').forEach(el => el.remove());
        activeMathBox = null;
        selectedMediaBox = null;

        // b. V·∫Ω l·∫°i Canvas
        if (state.canvasData) {
            const img = new Image();
            img.src = state.canvasData;
            img.onload = () => ctx.drawImage(img, 0, 0);
        }

        // c. T√°i t·∫°o c√°c ƒë·ªëi t∆∞·ª£ng DOM
        if (state.elements) {
            state.elements.forEach(data => {
                if (data.type === 'math') {
                    createMathBox(parseFloat(data.x), parseFloat(data.y));
                    // C·∫≠p nh·∫≠t n·ªôi dung sau khi t·∫°o
                    const box = document.querySelector('.math-box:last-child'); // L·∫•y c√°i v·ª´a t·∫°o
                    if (box) {
                        box.style.color = data.color;
                        box.dataset.raw = data.raw;
                        box.querySelector('.math-content').innerHTML = data.html;
                        // Render l·∫°i MathJax n·∫øu c·∫ßn
                        MathJax.typesetPromise([box]);
                    }
                }
                else if (data.type === 'img' || data.type === 'web') {
                    addMedia(data.type, data.src);
                    // C·∫≠p nh·∫≠t v·ªã tr√≠ & bi·∫øn h√¨nh
                    const box = document.querySelector('.media-box:last-child');
                    if (box) {
                        box.style.left = data.x;
                        box.style.top = data.y;
                        box.style.width = data.width;
                        box.style.height = data.height;

                        box.dataset.scale = data.scale;
                        box.dataset.rotation = data.rotation;
                        box.style.transform = `scale(${data.scale}) rotate(${data.rotation}deg)`;
                    }
                }
            });
        }
    }

    // ============================================================
    // PH·∫¶N 2: UNDO / REDO ƒê·ªíNG B·ªò (DOM + CANVAS)
    // ============================================================

    // Thay th·∫ø logic m·∫£ng history c≈© ch·ª©a string th√†nh m·∫£ng object
    let appHistory = [];
    let appStep = -1;

    // G·ªçi h√†m n√†y M·ªñI KHI th·ª±c hi·ªán h√†nh ƒë·ªông xong (V·∫Ω xong, Ch√®n ·∫£nh xong, X√≥a box xong...)
    function saveAppState() {
        // C·∫Øt ƒëu√¥i n·∫øu ƒëang ·ªü gi·ªØa
        if (appStep < appHistory.length - 1) {
            appHistory = appHistory.slice(0, appStep + 1);
        }
        appHistory.push(getCurrentState());
        appStep++;
        console.log("Saved State. Step:", appStep);
    }

    function undoApp() {
        if (appStep > 0) {
            appStep--;
            restoreState(appHistory[appStep]);
        }
    }

    function redoApp() {
        if (appStep < appHistory.length - 1) {
            appStep++;
            restoreState(appHistory[appStep]);
        }
    }

    // ============================================================
    // PH·∫¶N 3: L∆ØU & M·ªû PROJECT (JSON FILE)
    // ============================================================

    function saveProjectFile() {
        const data = getCurrentState();
        const json = JSON.stringify(data);
        const blob = new Blob([json], {type: "application/json"});
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = "BaiGiang_" + new Date().toISOString().slice(0,10) + ".json";
        a.click();
        URL.revokeObjectURL(url);
    }

    function loadProjectFile() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = event => {
                try {
                    const state = JSON.parse(event.target.result);
                    restoreState(state);
                    // Reset l·ªãch s·ª≠ khi n·∫°p file m·ªõi
                    appHistory = [state];
                    appStep = 0;
                    alert("ƒê√£ t·∫£i b√†i gi·∫£ng th√†nh c√¥ng!");
                } catch (err) {
                    alert("File l·ªói: " + err);
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <title>B·∫¢NG D·∫†Y FULL SCREEN - V2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        /* T·ªêI ∆ØU H√ìA KH√îNG GIAN */
        body, html { 
            margin: 0; padding: 0; 
            width: 100%; height: 100%; 
            overflow: hidden; 
            background: #2c3e50; 
            font-family: 'Segoe UI', sans-serif; 
        }

        /* B·ªê C·ª§C FLEX: THANH C√îNG C·ª§ + V√ôNG HI·ªÇN TH·ªä */
        .app-layout {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* THANH C√îNG C·ª§ */
        .toolbar {
            height: 45px; /* Gi·ªØ nh·ªè g·ªçn */
            background: #ecf0f1; 
            display: flex; 
            align-items: center; 
            padding: 0 10px; 
            gap: 8px; 
            border-bottom: 1px solid #bdc3c7; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            z-index: 100;
            flex-shrink: 0; /* Kh√¥ng b·ªã co l·∫°i */
        }
        .btn {
            padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; 
            font-weight: bold; font-size: 13px; background: white; white-space: nowrap;
        }
        .btn:hover { background: #e0e0e0; }
        .btn.active { background: #3498db; color: white; border-color: #2980b9; }
        
        .color-group { display: flex; gap: 5px; margin-left: auto; margin-right: 10px;}
        .color-btn { width: 25px; height: 25px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .color-btn.active { transform: scale(1.2); border-color: #333; }

        /* V√ôNG CH·ª®A PDF CH√çNH (KH√îNG VI·ªÄN TH·ª™A) */
        #mainContainer {
            flex: 1; /* Chi·∫øm to√†n b·ªô kh√¥ng gian c√≤n l·∫°i */
            overflow-y: auto; 
            overflow-x: hidden; 
            position: relative; 
            text-align: center; /* ƒê·ªÉ cƒÉn gi·ªØa trang PDF */
            background-color: #555; /* M√†u n·ªÅn t·ªëi ƒë·ªÉ n·ªïi b·∫≠t b√†i gi·∫£ng */
            padding-bottom: 50px; /* Ch·ª´a ch√∫t ch·ªó ·ªü d∆∞·ªõi ƒë·ªÉ cu·ªôn cho d·ªÖ */
        }

        /* TRANG PDF & L·ªöP V·∫º (QUAN TR·ªåNG: PAGE WRAPPER) */
        /* ƒê√¢y l√† "khung tranh" ch·ª©a c·∫£ PDF v√† N√©t v·∫Ω */
        .page-wrapper {
            display: inline-block; 
            position: relative; 
            margin: 0 auto; /* CƒÉn gi·ªØa */
            margin-bottom: 10px; /* Kho·∫£ng c√°ch gi·ªØa c√°c trang */
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); 
            line-height: 0; /* Lo·∫°i b·ªè kho·∫£ng tr·∫Øng th·ª´a c·ªßa th·∫ª img/canvas */
        }
        
        .pdf-canvas { display: block; background: white; width: 100%; height: auto; }
        
        /* L·ªöP V·∫º N·∫∞M ƒê√à L√äN TR√äN */
        .draw-canvas {
            position: absolute; top: 0; left: 0; 
            cursor: crosshair; touch-action: none; 
            width: 100%; height: 100%;
        }

        /* C·ª¨A S·ªî WEB */
        .web-window {
            position: absolute; width: 800px; height: 600px; background: white; border: 2px solid #3498db; top: 60px; left: 60px; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 2000; resize: both; overflow: auto;
        }
        .web-header { padding: 8px; background: #3498db; color: white; cursor: move; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .web-content { flex: 1; position: relative; }
        iframe { width: 100%; height: 100%; border: none; }
        .web-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .drawing-web .web-overlay { pointer-events: auto; background: rgba(0,0,0,0.05); cursor: crosshair; }

        /* HI·ªÜU ·ª®NG FULL SCREEN */
        :fullscreen .toolbar { display: flex; } /* V·∫´n hi·ªán toolbar khi fullscreen (ho·∫∑c ·∫©n n·∫øu mu·ªën) */
    </style>
</head>
<body>

<div class="app-layout" id="app">
    <div class="toolbar">
        <button class="btn" onclick="toggleFullScreen()" style="background: #8e44ad; color: white;">üñ•Ô∏è Tr√¨nh Chi·∫øu</button>
        <div style="width: 1px; height: 25px; background: #ccc;"></div>

        <button class="btn" onclick="document.getElementById('pdfInput').click()">üìÑ T·∫£i PDF</button>
        <button class="btn" onclick="addWebsite()">üåê Web</button>
        <input type="file" id="pdfInput" accept=".pdf" style="display: none;">

        <div style="width: 1px; height: 25px; background: #ccc;"></div>
        <button class="btn active" id="btnPen" onclick="setTool('pen')">‚úèÔ∏è B√∫t</button>
        <button class="btn" id="btnHighlighter" onclick="setTool('highlighter')">üñçÔ∏è Nh·ªõ d√≤ng</button>
        <button class="btn" id="btnEraser" onclick="setTool('eraser')">T·∫©y</button>
        <button class="btn" onclick="clearInk()" style="color: #c0392b;">‚ùå X√≥a Trang</button>

        <div class="color-group">
            <div class="color-btn active" style="background: #e74c3c;" onclick="setColor('#e74c3c', this)"></div>
            <div class="color-btn" style="background: #2ecc71;" onclick="setColor('#2ecc71', this)"></div>
            <div class="color-btn" style="background: #3498db;" onclick="setColor('#3498db', this)"></div>
            <div class="color-btn" style="background: #2c3e50;" onclick="setColor('#2c3e50', this)"></div>
            <div class="color-btn" style="background: #f1c40f;" onclick="setColor('#f1c40f', this)"></div>
        </div>
    </div>

    <div id="mainContainer">
        <div style="margin-top: 20%; color: #bbb; font-size: 18px;">
            B·∫•m <b>üìÑ T·∫£i PDF</b> ƒë·ªÉ b·∫Øt ƒë·∫ßu.<br>
            B·∫•m <b>üñ•Ô∏è Tr√¨nh Chi·∫øu</b> ƒë·ªÉ full m√†n h√¨nh.
        </div>
    </div>
</div>

<script>
    let currentTool = 'pen';
    let currentColor = '#e74c3c';
    let isDrawing = false;
    let lastX = 0, lastY = 0;

    // --- FULL SCREEN LOGIC ---
    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                alert(`L·ªói kh√¥ng th·ªÉ full m√†n h√¨nh: ${err.message}`);
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }

    // --- C√îNG C·ª§ V·∫º ---
    function setTool(tool) {
        currentTool = tool;
        document.querySelectorAll('.toolbar .btn').forEach(b => b.classList.remove('active'));
        if(tool === 'pen') document.getElementById('btnPen').classList.add('active');
        if(tool === 'highlighter') document.getElementById('btnHighlighter').classList.add('active');
        if(tool === 'eraser') document.getElementById('btnEraser').classList.add('active');
    }

    function setColor(color, element) {
        currentColor = color;
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
        element.classList.add('active');
        if (currentTool === 'eraser') setTool('pen'); 
    }

    function clearInk() {
        if(confirm("X√≥a n√©t v·∫Ω trang n√†y?")) {
            // T√¨m trang ƒëang n·∫±m trong v√πng nh√¨n th·∫•y nhi·ªÅu nh·∫•t ƒë·ªÉ x√≥a (c·∫£i ti·∫øn nh·ªè)
            // Ho·∫∑c x√≥a t·∫•t c·∫£ (ƒë∆°n gi·∫£n nh·∫•t cho th·∫ßy d√πng)
            document.querySelectorAll('.draw-canvas').forEach(canvas => {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });
        }
    }

    // --- X·ª¨ L√ù PDF (L√ïI) ---
    document.getElementById('pdfInput').onchange = async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const container = document.getElementById('mainContainer');
        container.innerHTML = '<div style="color:white; margin-top:50px;">‚è≥ ƒêang t·∫£i PDF Full HD...</div>';

        const pdfData = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(pdfData).promise;
        container.innerHTML = ''; 

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            const page = await pdf.getPage(pageNum);
            
            // --- T·ª∞ ƒê·ªòNG PH√ìNG TO PDF ƒê·ªÇ KH·ªöP CHI·ªÄU R·ªòNG M√ÄN H√åNH ---
            // L·∫•y chi·ªÅu r·ªông v√πng ch·ª©a (tr·ª´ thanh cu·ªôn)
            const containerWidth = container.clientWidth - 20; 
            // L·∫•y viewport g·ªëc c·ªßa PDF (scale 1)
            const unscaledViewport = page.getViewport({ scale: 1 });
            // T√≠nh to√°n scale c·∫ßn thi·∫øt ƒë·ªÉ fit chi·ªÅu r·ªông
            const scale = containerWidth / unscaledViewport.width;
            
            // Gi·ªõi h·∫°n scale t·ªëi thi·ªÉu l√† 1.5 ƒë·ªÉ n√©t kh√¥ng b·ªã m·ªù tr√™n m√†n to
            const finalScale = Math.max(scale, 1.5);

            const viewport = page.getViewport({ scale: finalScale });

            // T·∫°o khung ch·ª©a trang
            const wrapper = document.createElement('div');
            wrapper.className = 'page-wrapper';
            wrapper.style.width = viewport.width + 'px';
            wrapper.style.height = viewport.height + 'px';

            // Canvas hi·ªÉn th·ªã PDF
            const pdfCanvas = document.createElement('canvas');
            pdfCanvas.className = 'pdf-canvas';
            pdfCanvas.width = viewport.width;
            pdfCanvas.height = viewport.height;
            const pdfCtx = pdfCanvas.getContext('2d');
            page.render({ canvasContext: pdfCtx, viewport: viewport });

            // Canvas ƒë·ªÉ v·∫Ω
            const drawCanvas = document.createElement('canvas');
            drawCanvas.className = 'draw-canvas';
            drawCanvas.width = viewport.width;
            drawCanvas.height = viewport.height;

            setupDrawing(drawCanvas);

            wrapper.appendChild(pdfCanvas);
            wrapper.appendChild(drawCanvas);
            container.appendChild(wrapper);
        }
    };

    // --- LOGIC V·∫º (GI·ªÆ NGUY√äN) ---
    function setupDrawing(canvas) {
        const ctx = canvas.getContext('2d');
        
        // H√†m l·∫•y t·ªça ƒë·ªô ch√≠nh x√°c b·∫•t k·ªÉ cu·ªôn
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            // rect.left/top ƒë√£ t·ª± ƒë·ªông t√≠nh to√°n v·ªã tr√≠ sau khi cu·ªôn trang
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            const pos = getPos(e);
            lastX = pos.x; lastY = pos.y;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            // N·∫øu chu·ªôt ƒëi ra ngo√†i canvas n√†y (sang trang kh√°c), d·ª´ng v·∫Ω trang n√†y
            if (e.target !== canvas) return; 
            
            const pos = getPos(e);
            ctx.lineCap = 'round'; ctx.lineJoin = 'round';

            if (currentTool === 'pen') {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = 2;
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            } else if (currentTool === 'highlighter') {
                ctx.globalCompositeOperation = 'multiply';
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = 25; // B√∫t nh·ªõ to h∆°n t√≠ cho s∆∞·ªõng
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                ctx.globalCompositeOperation = 'source-over';
            } else if (currentTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = 30;
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                ctx.globalCompositeOperation = 'source-over';
            }
            lastX = pos.x; lastY = pos.y;
        });

        canvas.addEventListener('mouseup', () => isDrawing = false);
        // Quan tr·ªçng: Khi chu·ªôt r·ªùi kh·ªèi trang n√†y, ng·∫Øt v·∫Ω ƒë·ªÉ tr√°nh l·ªói
        canvas.addEventListener('mouseleave', () => isDrawing = false);
    }

    // --- C·ª¨A S·ªî WEB ---
    function addWebsite() {
        let url = prompt("Nh·∫≠p Link Web:", "https://google.com");
        if (!url) return;
        if (!url.startsWith('http')) url = 'https://' + url;

        const win = document.createElement('div');
        win.className = 'web-window';
        
        const header = document.createElement('div');
        header.className = 'web-header';
        header.innerHTML = `<span>${url}</span>`;
        
        const controls = document.createElement('div');
        const btnDrawWeb = document.createElement('button');
        btnDrawWeb.innerText = '‚úèÔ∏è V·∫Ω ƒë√®';
        btnDrawWeb.style.marginRight = '10px';
        btnDrawWeb.onclick = () => {
            win.classList.toggle('drawing-web');
            btnDrawWeb.style.background = win.classList.contains('drawing-web') ? '#f1c40f' : '';
        };
        const btnClose = document.createElement('button');
        btnClose.innerText = '‚úï';
        btnClose.onclick = () => win.remove();

        controls.appendChild(btnDrawWeb);
        controls.appendChild(btnClose);
        header.appendChild(controls);

        const content = document.createElement('div');
        content.className = 'web-content';
        const iframe = document.createElement('iframe');
        iframe.src = url;

        const overlay = document.createElement('canvas');
        overlay.className = 'web-overlay';
        new ResizeObserver(() => { overlay.width = content.offsetWidth; overlay.height = content.offsetHeight; }).observe(content);
        setupDrawing(overlay);

        content.appendChild(iframe);
        content.appendChild(overlay);
        win.appendChild(header);
        win.appendChild(content);
        document.body.appendChild(win);
        makeDraggable(win, header);
    }

    function makeDraggable(element, handle) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        handle.onmousedown = dragMouseDown;
        function dragMouseDown(e) {
            e = e || window.event; e.preventDefault();
            pos3 = e.clientX; pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }
        function elementDrag(e) {
            e = e || window.event; e.preventDefault();
            pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
            pos3 = e.clientX; pos4 = e.clientY;
            element.style.top = (element.offsetTop - pos2) + "px";
            element.style.left = (element.offsetLeft - pos1) + "px";
        }
        function closeDragElement() { document.onmouseup = null; document.onmousemove = null; }
    }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Kê Khai Thành tích nghề nghiệp xét Thăng Hạng GV - THPT Trần Trường Sinh</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
   <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --info-color: #2980b9;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --gray-color: #7f8c8d;
            --border-color: #ddd;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            padding: 20px 40px;
            position: relative;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .view-public-btn, .admin-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .view-public-btn:hover, .admin-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .status-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Teacher ID Check */
        .teacher-check-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
            display: none;
        }

        .teacher-check-section h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .teacher-check-option {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .teacher-check-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .teacher-check-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: var(--secondary-color);
        }

        .teacher-check-card.selected {
            border-color: var(--success-color);
            background: rgba(39, 174, 96, 0.05);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.2);
        }

        .check-card-icon {
            font-size: 3rem;
            color: var(--secondary-color);
            margin-bottom: 15px;
        }

        .check-card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .check-card-desc {
            color: var(--gray-color);
            font-size: 0.95rem;
            line-height: 1.5;
            max-width: 90%;
        }

        .id-input-group {
            display: flex;
            gap: 10px;
            max-width: 500px;
            margin: 20px auto;
        }

        .id-input-group input {
            flex: 1;
            padding: 12px 15px;
            font-size: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
        }

        .id-input-group input:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .teacher-id-display {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px dashed var(--success-color);
            text-align: center;
        }

        .teacher-id-code {
            font-family: 'Courier New', monospace;
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--success-color);
            letter-spacing: 2px;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            display: inline-block;
        }

        .teacher-id-note {
            font-size: 0.9rem;
            color: #666;
            margin-top: 15px;
            font-style: italic;
        }

        /* Admin Panel */
        .admin-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .admin-panel.open {
            right: 0;
        }

        .admin-header {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-content {
            padding: 20px;
        }

        .admin-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .admin-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }

        .teacher-list-admin {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .teacher-item-admin {
            padding: 12px 15px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .teacher-item-admin:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.1);
        }

        .teacher-info-admin {
            flex: 1;
        }

        .teacher-name-admin {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 5px;
        }

        .teacher-code-admin {
            font-size: 0.85rem;
            color: var(--gray-color);
        }

        .edit-code-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px dashed var(--secondary-color);
            margin-top: 20px;
        }

        .edit-code-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--success-color);
            text-align: center;
            letter-spacing: 2px;
            border: 1px solid var(--border-color);
        }

        /* Main Content */
        .main-content {
            padding: 30px 40px;
        }

        /* Tabs Navigation */
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 30px;
            flex-wrap: wrap;
            position: relative;
        }

        .tab {
            padding: 15px 30px;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-color);
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            justify-content: center;
            min-width: 200px;
            position: relative;
        }

        .tab:hover {
            color: var(--secondary-color);
            background: rgba(52, 152, 219, 0.05);
        }

        .tab.active {
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
            background: rgba(52, 152, 219, 0.05);
        }

        .tab.completed::after {
            content: '✓';
            position: absolute;
            top: 5px;
            right: 5px;
            color: var(--success-color);
            font-weight: bold;
            font-size: 0.9rem;
        }

        .tab.error::after {
            content: '!';
            position: absolute;
            top: 5px;
            right: 5px;
            color: var(--accent-color);
            font-weight: bold;
            font-size: 0.9rem;
            background: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--accent-color);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
            padding: 20px 0;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Styles */
        .form-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .section-header h2 {
            color: var(--primary-color);
            font-size: 1.4rem;
        }

        .section-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 1.1rem;
        }

        .form-group label.required::after {
            content: ' *';
            color: var(--accent-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-group input[readonly] {
            background-color: #f8f9fa;
            color: #666;
            cursor: not-allowed;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Year Achievement Section */
        .year-achievement-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .year-achievement-section.missing {
            border-color: var(--accent-color);
            background: rgba(231, 76, 60, 0.05);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

        .year-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .year-title {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .year-status {
            font-size: 0.9rem;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }

        .status-not-done {
            background: rgba(231, 76, 60, 0.1);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }

        .status-done {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .khaikai-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .khaikai-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .khaikai-btn.done {
            background: var(--success-color);
        }

        .khaikai-btn.done:hover {
            background: #219653;
        }

        .achievement-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        /* NÚT CAM KẾT RẤT LỚN - QUAN TRỌNG */
        .achievement-option {
            background: white;
            border: 3px solid var(--border-color);
            border-radius: 10px;
            padding: 25px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 120px;
        }

        /* NÚT CAM KẾT ĐẶC BIỆT LỚN */
        #standardCommitment {
            padding: 35px 30px !important;
            min-height: 160px !important;
            border-width: 4px !important;
            background: linear-gradient(135deg, #f0f7ff, #d4e4ff) !important;
            border-color: var(--secondary-color) !important;
            cursor: pointer;
            transition: all 0.3s ease !important;
            margin-top: 20px !important;
        }

        #standardCommitment:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 10px 25px rgba(52, 152, 219, 0.3) !important;
            border-color: var(--info-color) !important;
        }

        #standardCommitment.selected {
            background: linear-gradient(135deg, #e8f5e9, #d0ebd0) !important;
            border-color: var(--success-color) !important;
        }

        #standardCommitment .achievement-title {
            font-size: 1.6rem !important;
            font-weight: 800 !important;
            color: #1a3c6e !important;
            margin-bottom: 20px !important;
            padding-right: 40px !important;
        }

        #standardCommitment .achievement-description {
            font-size: 1.2rem !important;
            line-height: 1.8 !important;
            color: #2c3e50 !important;
            font-weight: 500 !important;
        }

        #standardCommitment .achievement-radio {
            width: 30px !important;
            height: 30px !important;
            top: 25px !important;
            right: 25px !important;
            border-width: 3px !important;
        }

        #standardCommitment.selected .achievement-radio::after {
            width: 16px !important;
            height: 16px !important;
        }

        /* Các nút thành tích khác giữ bình thường */
        .achievement-option:not(#standardCommitment) {
            min-height: 100px;
            padding: 20px;
        }

        .achievement-option:hover {
            border-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .achievement-option.selected {
            border-color: var(--success-color);
            background: rgba(39, 174, 96, 0.05);
        }

        .achievement-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .achievement-radio {
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-color);
            border-radius: 50%;
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .achievement-option.selected .achievement-radio {
            border-color: var(--success-color);
        }

        .achievement-option.selected .achievement-radio::after {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success-color);
        }

        .achievement-title {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 8px;
            padding-right: 30px;
        }

        .achievement-description {
            color: var(--gray-color);
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .no-achievement-option {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            text-align: center;
        }

        .no-achievement-option:hover {
            border-color: var(--gray-color);
        }

        .no-achievement-option.selected {
            border-color: var(--gray-color);
            background: rgba(127, 140, 141, 0.05);
        }

        .custom-achievement {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .custom-achievement textarea {
            min-height: 80px;
            font-size: 0.9rem;
        }

        /* Task Selection */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .task-item {
            background: #f8f9fa;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .task-item.missing {
            border-color: var(--accent-color);
            background: rgba(231, 76, 60, 0.05);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .task-title {
            font-weight: 600;
            color: var(--dark-color);
            font-size: 1.1rem;
            flex: 1;
        }

        .task-number {
            background: var(--secondary-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            margin-right: 15px;
        }

        .task-description {
            color: var(--gray-color);
            margin-bottom: 20px;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .task-options {
            display: flex;
            gap: 20px;
        }

        .task-option {
            flex: 1;
        }

        .task-option label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 100%;
        }

        .task-option label:hover {
            border-color: var(--secondary-color);
        }

        .task-option input[type="radio"] {
            display: none;
        }

        .task-radio {
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .task-option input[type="radio"]:checked + .task-radio {
            border-color: var(--success-color);
        }

        .task-option input[type="radio"]:checked + .task-radio::after {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success-color);
        }

        .task-option input[type="radio"]:checked ~ .task-label {
            font-weight: 600;
            color: var(--success-color);
        }

        .task-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: var(--dark-color);
        }

        /* Navigation Buttons */
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-primary:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--gray-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #6c7b7d;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #219653);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--accent-color), #c0392b);
            color: white;
            padding: 8px 15px;
            font-size: 0.85rem;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
            padding: 8px 15px;
            font-size: 0.85rem;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Missing Fields Alert */
        .missing-fields-alert {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .missing-fields-alert.show {
            display: block;
        }

        .missing-fields-alert h4 {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .missing-list {
            margin-left: 20px;
            font-size: 0.95rem;
        }

        .missing-list li {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Lock Message */
        #lockMessage {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
            color: white;
        }

        /* Public View - Ranking Lists */
        .ranking-lists {
            display: block;
            margin-top: 30px;
        }

        .ranking-list {
            width: 100%;
            margin-bottom: 50px;
        }

        .ranking-list:last-child {
            margin-bottom: 0;
        }

        .list-header {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            padding: 25px 30px;
        }

        .list-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
        }

        .list-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 8px;
        }

        /* BẢNG XẾP HẠNG FULL WIDTH */
        .ranking-table-container {
            width: 100%;
            overflow-x: auto;
        }

        .ranking-table {
            width: 100%;
            min-width: 100%;
            border-collapse: collapse;
        }

        .ranking-table thead {
            background: var(--light-color);
        }

        .ranking-table th {
            padding: 20px;
            text-align: left;
            font-weight: 600;
            color: var(--dark-color);
            border-bottom: 2px solid var(--border-color);
            font-size: 1.1rem;
            background: #f1f8ff;
        }

        .ranking-table tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s ease;
        }

        .ranking-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .ranking-table td {
            padding: 20px;
            vertical-align: top;
        }

        .rank-number {
            width: 60px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--secondary-color);
        }

        .teacher-rank-info {
            flex: 1;
        }

        .teacher-rank-name {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .teacher-rank-details {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-bottom: 8px;
        }

        .achievement-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }

        .achievement-badge {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid var(--success-color);
        }

        .achievement-badge.high {
            background: rgba(231, 76, 60, 0.1);
            color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .achievement-badge.medium {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
            border-color: var(--warning-color);
        }

        .task-count {
            text-align: center;
            font-weight: bold;
            font-size: 1.3rem;
            color: var(--secondary-color);
        }

        /* Cột thành tích chi tiết RỘNG */
        .achievement-details {
            min-width: 500px;
            max-width: none;
        }
        
        .achievement-year {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding-bottom: 3px;
            border-bottom: 1px dashed #eee;
        }
        
        .achievement-year:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .year-label {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.9rem;
        }
        
        .achievement-name {
            color: var(--dark-color);
            font-size: 0.9rem;
            text-align: right;
            flex: 1;
            margin-left: 10px;
        }
        
        .achievement-name.high {
            color: var(--accent-color);
            font-weight: 600;
        }
        
        .achievement-name.medium {
            color: var(--warning-color);
            font-weight: 600;
        }
        
        .achievement-name.low {
            color: var(--success-color);
        }
        
        .duplicate-warning {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: pulse 2s infinite;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        /* MODAL BẢNG XẾP HẠNG RỘNG HƠN */
        #publicViewModal .modal-content {
            background: white;
            border-radius: 15px;
            width: 95%;
            max-width: 1300px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h3 {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #publicViewModal .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            background: #f8f9fa;
            border-radius: 0 0 15px 15px;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1002;
        }

        .loading.spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Overlay for admin panel */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .overlay.show {
            display: block;
        }

        .info-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-year {
            font-weight: 600;
            color: var(--primary-color);
            min-width: 150px;
        }

        .summary-achievement {
            flex: 1;
            color: var(--dark-color);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            #publicViewModal .modal-content {
                width: 98%;
                max-width: 95vw;
            }
            
            .achievement-details {
                min-width: 450px;
            }
            
            /* Nút cam kết trên tablet */
            #standardCommitment {
                padding: 30px 25px !important;
                min-height: 150px !important;
            }
            
            #standardCommitment .achievement-title {
                font-size: 1.5rem !important;
            }
            
            #standardCommitment .achievement-description {
                font-size: 1.1rem !important;
            }
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 10px;
            }
            
            .header,
            .main-content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .header-top {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                width: 100%;
                justify-content: flex-start;
                border-bottom: 1px solid var(--border-color);
                min-width: unset;
            }
            
            .tab.active {
                border-bottom: 3px solid var(--secondary-color);
            }
            
            .form-section {
                padding: 20px;
            }
            
            .teacher-check-option {
                grid-template-columns: 1fr;
            }
            
            .id-input-group {
                flex-direction: column;
            }
            
            .admin-panel {
                width: 100%;
                right: -100%;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .btn {
                width: 100%;
            }
            
            .task-options {
                flex-direction: column;
            }

            /* Bảng xếp hạng trên mobile */
            #publicViewModal .modal-content {
                width: 100%;
                margin: 10px;
                max-height: 80vh;
            }
            
            #publicViewModal .modal-body {
                padding: 20px;
            }
            
            .achievement-details {
                min-width: 350px;
            }
            
            .ranking-table th,
            .ranking-table td {
                padding: 12px 15px;
                font-size: 0.9rem;
            }
            
            .list-header {
                padding: 20px;
            }
            
            .list-header h3 {
                font-size: 1.3rem;
            }
            
            .list-subtitle {
                font-size: 1rem;
            }
            
            /* Nút cam kết trên mobile */
            #standardCommitment {
                padding: 25px 20px !important;
                min-height: 130px !important;
            }
            
            #standardCommitment .achievement-title {
                font-size: 1.3rem !important;
                margin-bottom: 15px !important;
            }
            
            #standardCommitment .achievement-description {
                font-size: 1rem !important;
                line-height: 1.6 !important;
            }
            
            #standardCommitment .achievement-radio {
                width: 25px !important;
                height: 25px !important;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.1rem;
            }
            
            .section-header {
                flex-direction: column;
                text-align: center;
            }
            
            .year-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .khaikai-btn {
                align-self: stretch;
                justify-content: center;
            }
            
            .modal-content {
                margin: 10px;
            }
            
            .modal-header,
            .modal-body,
            .modal-footer {
                padding: 20px;
            }
            
            .achievement-options {
                grid-template-columns: 1fr;
            }

            /* Bảng xếp hạng trên mobile nhỏ */
            #publicViewModal .modal-body {
                padding: 15px;
            }
            
            .achievement-details {
                min-width: 280px;
            }
            
            .ranking-table th,
            .ranking-table td {
                padding: 10px 12px;
                font-size: 0.85rem;
            }
            
            /* Nút cam kết trên mobile nhỏ */
            #standardCommitment {
                padding: 20px 15px !important;
                min-height: 120px !important;
            }
            
            #standardCommitment .achievement-title {
                font-size: 1.2rem !important;
            }
            
            #standardCommitment .achievement-description {
                font-size: 0.95rem !important;
            }
        }
    </style>H
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-top">
                <div>
                    <h1>
                        <i class="fas fa-chalkboard-teacher"></i>
                        HỆ THỐNG KÊ KHAI THÀNH TÍCH TRONG HOẠT ĐỘNG NGHỀ NGHIỆP 
                    </h1>
                    <p>Trường THPT Trần Trường Sinh - Vĩnh Long</p>
                    
                </div>
                
                <div class="header-actions">
                    <div class="status-badge" id="submissionStatus">
                        <i class="fas fa-user"></i>
                        <span>Chưa đăng nhập</span>
                    </div>
                    
                    <button class="view-public-btn" id="viewPublicBtn">
                        <i class="fas fa-eye"></i> Xem xếp hạng
                    </button>
                    
                    <button class="admin-btn" id="adminBtn">
                        <i class="fas fa-cog"></i> Quản trị
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Lock Message (shown when submission is locked) -->
            <div class="missing-fields-alert" id="lockMessage">
                <h4><i class="fas fa-lock"></i> HỒ SƠ ĐÃ ĐƯỢC LƯU VÀ KHÓA</h4>
                <p>Bạn đã hoàn thành kê khai và đã lưu hồ sơ. Để chỉnh sửa, vui lòng liên hệ Admin để xin mã chỉnh sửa.</p>
                <p style="margin-top: 10px;">
                    <strong>Mã giáo viên của bạn:</strong> 
                    <span id="lockedTeacherCode" style="font-weight: bold; color: #FFD700;"></span>
                </p>
                <div style="margin-top: 15px;">
                    <button class="btn btn-warning" id="editLockedProfile" style="margin-right: 10px;">
                        <i class="fas fa-key"></i> Nhập mã chỉnh sửa
                    </button>
                    <button class="btn btn-secondary" id="startNewProfile">
                        <i class="fas fa-plus"></i> Tạo hồ sơ mới
                    </button>
                </div>
            </div>

            <!-- Missing Fields Alert -->
            <div class="missing-fields-alert" id="missingFieldsAlert">
                <h4><i class="fas fa-exclamation-triangle"></i> THIẾU THÔNG TIN</h4>
                <p>Vui lòng hoàn thành các thông tin sau trước khi tiếp tục:</p>
                <ul class="missing-list" id="missingFieldsList"></ul>
            </div>

            <!-- Duplicate Warning -->
            <div class="duplicate-warning" id="duplicateWarning" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <strong>GIÁO VIÊN ĐÃ KÊ KHAI</strong>
                    <p style="margin-top: 5px; font-size: 0.85rem;">Họ tên và ngày sinh đã tồn tại trong hệ thống. Nếu đây là bạn, vui lòng liên hệ Quản lý để chỉnh sửa.</p>
                </div>
            </div>

            <!-- Teacher ID Check Section - HIỆN KHI CẦN -->
            <div class="teacher-check-section" id="teacherCheckSection">
                <h3><i class="fas fa-user-check"></i> TÙY CHỌN KÊ KHAI</h3>
                <p>Chọn một trong các tùy chọn sau để bắt đầu:</p>
                
                <div class="teacher-check-option">
                    <div class="teacher-check-card" id="newTeacherCard">
                        <div class="check-card-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="check-card-title">KÊ KHAI MỚI</div>
                        <div class="check-card-desc">
                            Tạo hồ sơ mới nếu đây là lần đầu kê khai hoặc muốn tạo hồ sơ mới
                        </div>
                    </div>
                    
                    <div class="teacher-check-card" id="existingTeacherCard">
                        <div class="check-card-icon">
                            <i class="fas fa-user-edit"></i>
                        </div>
                        <div class="check-card-title">TIẾP TỤC CHỈNH SỬA</div>
                        <div class="check-card-desc">
                            Nếu đã có mã giáo viên và muốn tiếp tục chỉnh sửa hồ sơ hiện có
                        </div>
                    </div>
                </div>
                
                <!-- Phần nhập mã cho giáo viên đã có -->
                <div id="existingTeacherSection" style="display: none; margin-top: 30px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                        <i class="fas fa-key"></i> NHẬP MÃ GIÁO VIÊN
                    </h4>
                    <div class="id-input-group">
                        <input type="text" id="teacherIdInput" placeholder="Nhập mã giáo viên (VD: GV123456)" maxlength="20">
                        <button class="btn btn-primary" id="checkTeacherId">
                            <i class="fas fa-search"></i> Kiểm tra
                        </button>
                    </div>
                    
                    <div id="idCheckResult" style="display: none; margin-top: 20px;">
                        <div class="teacher-id-display">
                            <div id="existingTeacherInfo"></div>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-success" id="useExistingId">
                                    <i class="fas fa-edit"></i> Tiếp tục chỉnh sửa
                                </button>
                                <button class="btn btn-secondary" id="backToOptions" style="margin-left: 10px;">
                                    <i class="fas fa-arrow-left"></i> Quay lại
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Tabs - HIỆN NGAY KHI BẮT ĐẦU KÊ KHAI MỚI -->
            <div id="formTabs" style="display: none;">
                <!-- Teacher ID Display (when creating new) -->
                <div class="teacher-id-display" id="newTeacherIdDisplay">
                    <h4 style="color: var(--success-color); margin-bottom: 10px;">
                        <i class="fas fa-id-card"></i> MÃ GIÁO VIÊN CỦA BẠN
                    </h4>
                    <p>Vui lòng ghi nhớ mã này để chỉnh sửa hồ sơ sau này:</p>
                    <div class="teacher-id-code" id="generatedTeacherCode"></div>
                    <div class="teacher-id-note">
                        <i class="fas fa-exclamation-triangle"></i> Lưu mã này cẩn thận. Nếu quên mã, bạn sẽ không thể chỉnh sửa hồ sơ sau này.
                    </div>
                </div>

                <!-- Progress Tabs -->
                <div class="tabs" id="progressTabs">
                    <button class="tab active" data-tab="info" id="tabInfo">
                        <i class="fas fa-user-edit"></i>
                        <span>I. THÔNG TIN CÁ NHÂN</span>
                    </button>
                    <button class="tab" data-tab="achievements" id="tabAchievements">
                        <i class="fas fa-trophy"></i>
                        <span>II. THÀNH TÍCH THI ĐUA</span>
                    </button>
                    <button class="tab" data-tab="tasks" id="tabTasks">
                        <i class="fas fa-tasks"></i>
                        <span>III. THÔNG TIN VỀ NĂNG LỰC THỰC HIỆN NHIỆM VỤ GV HẠNG II</span>
                    </button>
                    <button class="tab" data-tab="review" id="tabReview">
                        <i class="fas fa-clipboard-check"></i>
                        <span>KIỂM TRA & LƯU HỒ SƠ</span>
                    </button>
                </div>

                <!-- Tab 1: Personal Information - ĐÃ BỔ SUNG GIỚI TÍNH VÀ NGÀY SINH -->
                <div class="tab-content active" id="infoTab">
                    <div class="form-section">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-user-edit"></i>
                            </div>
                            <h2>I. KHAI BÁO THÔNG TIN CÁ NHÂN</h2>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="required">1. Họ tên giáo viên</label>
                                <input type="text" id="teacherName" placeholder="Nhập họ tên đầy đủ (không dấu cách thừa)">
                                <div id="nameValidation" style="font-size: 0.85rem; margin-top: 5px; display: none;"></div>
                            </div>

                            <div class="form-group">
                                <label class="required">2. Ngày tháng năm sinh</label>
                                <input type="date" id="birthDate" max="2006-12-31">
                                <div id="birthDateValidation" style="font-size: 0.85rem; margin-top: 5px; display: none;"></div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="required">3. Giới tính</label>
                                <select id="gender">
                                    <option value="">Chọn giới tính</option>
                                    <option value="nam">Nam</option>
                                    <option value="nu">Nữ</option>
                                    
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="required">4. Năm vào ngành</label>
                                <select id="startYear">
                                    <option value="">Chọn năm vào ngành</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="required">5. Cam kết đạt tiêu chuẩn, điều kiện xét thăng hạng</label>
                            <div class="achievement-option" style="cursor: pointer;" id="standardCommitment">
                                <div class="achievement-title">
                                    <i class="fas fa-file-signature"></i>
                                    Cam kết đạt đủ tiêu chuẩn theo Điều 9 Thông tư 13/2024/TT-BGDĐT
                                </div>
                                <div class="achievement-description">
                                    Tôi cam kết đã đạt đầy đủ các tiêu chuẩn về trình độ đào tạo, bồi dưỡng, năng lực chuyên môn, nghiệp vụ và các điều kiện khác theo quy định.
                                </div>
                                <div class="achievement-radio"></div>
                            </div>
                            <input type="radio" name="commitment" id="standardCommitmentRadio" style="display: none;">
                        </div>

                        <p class="required-fields">* Các trường bắt buộc phải hoàn thành</p>
                    </div>

                    <div class="navigation-buttons">
                        <div></div>
                        <button class="btn btn-primary" id="nextToAchievements">
                            Tiếp theo: Kê khai thành tích <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Tab 2: Achievements -->
                <div class="tab-content" id="achievementsTab">
                    <div class="form-section">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <h2>II. KÊ KHAI THÀNH TÍCH THI ĐUA (9 năm gần nhất)</h2>
                        </div>

                        <p style="color: #666; margin-bottom: 20px; font-style: italic;">
                            <i class="fas fa-info-circle"></i> Mỗi năm học phải kê khai một thành tích cao nhất. Nhấn nút "Kê khai" để bắt đầu cho từng năm.
                        </p>

                        <div id="yearAchievementsContainer"></div>

                        <div class="form-group custom-achievement">
                            <label>Thành tích khác (nếu có, không thuộc danh mục trên)</label>
                            <p style="color: #666; margin-bottom: 10px; font-size: 0.9rem;">
                                <i class="fas fa-edit"></i> Ghi rõ: Giáo viên dạy giỏi các cấp, Giáo viên chủ nhiệm giỏi, giấy khen có xác nhận từ cấp trường trở lên, các thành tích chuyên môn khác...
                            </p>
                            <textarea id="otherAchievements" placeholder="Ví dụ: Giáo viên dạy giỏi cấp tỉnh năm học 2020-2021, Giấy khen của Hiệu trưởng năm 2019-2020..."></textarea>
                        </div>

                        <p class="required-fields">* Phải kê khai đầy đủ cho tất cả 9 năm học</p>
                    </div>

                    <div class="navigation-buttons">
                        <button class="btn btn-secondary" id="backToInfo">
                            <i class="fas fa-arrow-left"></i> Quay lại thông tin
                        </button>
                        <button class="btn btn-primary" id="nextToTasks">
                            Tiếp theo: Nhiệm vụ chuyên môn <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Tab 3: Tasks -->
                <div class="tab-content" id="tasksTab">
                    <div class="form-section">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <h2>III. ĐÁNH GIÁ NĂNG LỰC THỰC HIỆN NHIỆM VỤ GIÁO VIÊN HẠNG II</h2>
                        </div>

                        <div class="task-list" id="taskList"></div>

                        <p class="required-fields">* Phải đánh giá tất cả 07 nhiệm vụ</p>
                    </div>

                    <div class="navigation-buttons">
                        <button class="btn btn-secondary" id="backToAchievements">
                            <i class="fas fa-arrow-left"></i> Quay lại thành tích
                        </button>
                        <button class="btn btn-primary" id="nextToReview">
                            Tiếp theo: Kiểm tra & Lưu hồ sơ <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Tab 4: Review and Submit -->
                <div class="tab-content" id="reviewTab">
                    <div class="form-section">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                            <h2>KIỂM TRA THÔNG TIN VÀ LƯU HỒ SƠ</h2>
                        </div>

                        <div id="validationMessage"></div>

                        <div class="form-group">
                            <h3 style="color: var(--primary-color); margin-bottom: 20px;">Tóm tắt thông tin đã kê khai:</h3>
                            
                            <div class="info-summary">
                                <h4 style="color: var(--secondary-color); margin-bottom: 15px;">
                                    <i class="fas fa-user"></i> Thông tin cá nhân
                                </h4>
                                <div id="summaryPersonal"></div>
                            </div>

                            <div class="info-summary">
                                <h4 style="color: var(--secondary-color); margin-bottom: 15px;">
                                    <i class="fas fa-trophy"></i> Thành tích thi đua (theo từng năm)
                                </h4>
                                <div id="summaryAchievements"></div>
                            </div>

                            <div class="info-summary">
                                <h4 style="color: var(--secondary-color); margin-bottom: 15px;">
                                    <i class="fas fa-tasks"></i> Năng lực thực hiện nhiệm vụ
                                </h4>
                                <div id="summaryTasks"></div>
                            </div>

                     <div class="form-group">
    <!-- KHUNG BAO ĐẸP -->
    <div style="margin: 30px 0; padding: 25px; background: linear-gradient(135deg, #fff9e6, #fff3d1); 
                border-radius: 12px; border: 3px solid #f39c12; box-shadow: 0 5px 15px rgba(243, 156, 18, 0.1);">
        
        <!-- CHECKBOX VÀ LABEL CŨ - GIỮ NGUYÊN ĐỂ JS HOẠT ĐỘNG -->
        <label class="required" style="display: flex; align-items: flex-start; cursor: pointer; 
               font-size: 1.2rem; color: #d35400; margin: 0; padding: 0;">
            
            <!-- CHECKBOX THẬT - QUAN TRỌNG: KHÔNG BỎ -->
            <input type="checkbox" id="finalConfirmation" 
                   style="width: 25px; height: 25px; margin-right: 20px; margin-top: 5px;">
            
            <!-- NỘI DUNG MỚI ĐẸP HƠN -->
            <span style="flex: 1;">
                <strong style="display: block; margin-bottom: 10px; font-size: 1.4rem;">
                    <i class="fas fa-file-signature"></i> XÁC NHẬN TÍNH CHÍNH XÁC
                </strong>
                <span style="font-size: 1.2rem; color: #2c3e50; line-height: 1.6; display: block;">
                    Tôi xác nhận tất cả thông tin kê khai trên là đúng sự thật và chịu trách nhiệm trước pháp luật về tính chính xác của thông tin.
                </span>
            </span>
        </label>
    </div>
</div>

                    <div class="navigation-buttons">
                        <button class="btn btn-secondary" id="backToTasks">
                            <i class="fas fa-arrow-left"></i> Quay lại nhiệm vụ
                        </button>
                        <button class="btn btn-success" id="submitForm" disabled>
                            <i class="fas fa-save"></i> LƯU HỒ SƠ VÀ KẾT THÚC
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-header">
            <h3><i class="fas fa-user-shield"></i> QUẢN TRỊ HỆ THỐNG</h3>
            <button class="view-public-btn" id="closeAdminPanel">
                <i class="fas fa-times"></i> Đóng
            </button>
        </div>
        
        <div class="admin-content">
            <!-- Admin Login -->
            <div class="admin-section" id="adminLoginSection">
                <h3><i class="fas fa-lock"></i> ĐĂNG NHẬP QUẢN TRỊ</h3>
                <div class="form-group">
                    <label>Mã Admin</label>
                    <input type="password" id="adminCodeInput" placeholder="Nhập mã admin">
                </div>
                <button class="btn btn-primary" id="adminLoginBtn">
                    <i class="fas fa-sign-in-alt"></i> Đăng nhập
                </button>
            </div>

            <!-- Admin Functions (hidden by default) -->
            <div id="adminFunctions" style="display: none;">
                <!-- Delete Teachers -->
                <div class="admin-section">
                    <h3><i class="fas fa-trash-alt"></i> QUẢN LÝ GIÁO VIÊN</h3>
                    <div class="teacher-list-admin" id="teacherListAdmin"></div>
                </div>

                <!-- Generate Edit Codes -->
                <div class="admin-section">
                    <h3><i class="fas fa-key"></i> CẤP MÃ CHỈNH SỬA</h3>
                    <div class="form-group">
                        <label>Chọn giáo viên cần cấp mã</label>
                        <select id="teacherSelectForEdit" style="margin-bottom: 15px;">
                            <option value="">Chọn giáo viên</option>
                        </select>
                    </div>
                    <button class="btn btn-warning" id="generateEditCodeBtn">
                        <i class="fas fa-key"></i> Tạo mã chỉnh sửa
                    </button>
                    
                    <div class="edit-code-section" id="editCodeResult" style="display: none;">
                        <h4><i class="fas fa-key"></i> MÃ CHỈNH SỬA ĐÃ TẠO</h4>
                        <p>Mã này chỉ sử dụng được 1 lần. Cung cấp cho giáo viên để chỉnh sửa hồ sơ.</p>
                        <div class="edit-code-display" id="generatedEditCode"></div>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 10px;">
                            <i class="fas fa-info-circle"></i> Mã sẽ tự động xóa sau khi sử dụng
                        </p>
                    </div>
                </div>

                <!-- View Edit Codes -->
                <div class="admin-section">
                    <h3><i class="fas fa-list"></i> MÃ CHỈNH SỬA ĐANG HOẠT ĐỘNG</h3>
                    <div class="teacher-list-admin" id="activeEditCodes"></div>
                </div>

                <!-- Statistics -->
                <div class="admin-section">
                    <h3><i class="fas fa-chart-bar"></i> THỐNG KÊ HỆ THỐNG</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--secondary-color); text-align: center;" id="totalTeachersCount">0</div>
                            <div style="text-align: center; color: var(--gray-color); font-size: 0.9rem;">Tổng số GV</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--success-color); text-align: center;" id="completedSubmissionsCount">0</div>
                            <div style="text-align: center; color: var(--gray-color); font-size: 0.9rem;">Đã hoàn thành</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--warning-color); text-align: center;" id="activeEditCodesCount">0</div>
                            <div style="text-align: center; color: var(--gray-color); font-size: 0.9rem;">Mã chỉnh sửa</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--accent-color); text-align: center;" id="incompleteSubmissionsCount">0</div>
                            <div style="text-align: center; color: var(--gray-color); font-size: 0.9rem;">Chưa hoàn thành</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Public View Modal (XEM XẾP HẠNG) - CẢI TIẾN BẢNG CHI TIẾT -->
    <div class="modal" id="publicViewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-trophy"></i> XẾP HẠNG TOÀN TRƯỜNG</h3>
                <button class="view-public-btn" id="closePublicView">
                    <i class="fas fa-times"></i> Đóng
                </button>
            </div>
            <div class="modal-body">
                <div class="ranking-lists">
                    <!-- Danh sách 1: Xếp hạng theo thành tích - CHI TIẾT -->
                    <div class="ranking-list">
                        <div class="list-header">
                            <h3><i class="fas fa-crown"></i> DANH SÁCH 1</h3>
                            <div class="list-subtitle">Xếp hạng theo thành tích thi đua (chi tiết)</div>
                        </div>
                        <div class="ranking-table-container" style="overflow-x: auto;">
                            <table class="ranking-table">
                                <thead>
                                    <tr>
                                        <th width="60">STT</th>
                                        <th width="180">Họ tên</th>
                                        <th>Thành tích chi tiết theo năm</th>
                                        <th width="100">Tổng kết</th>
                                    </tr>
                                </thead>
                                <tbody id="rankingByAchievements"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Danh sách 2: Xếp hạng theo nhiệm vụ -->
                    <div class="ranking-list">
                        <div class="list-header">
                            <h3><i class="fas fa-tasks"></i> DANH SÁCH 2</h3>
                            <div class="list-subtitle">Xếp hạng theo nhiệm vụ đã thực hiện</div>
                        </div>
                        <div class="ranking-table-container">
                            <table class="ranking-table">
                                <thead>
                                    <tr>
                                        <th width="60">STT</th>
                                        <th>Giáo viên</th>
                                        <th width="120">Thông tin</th>
                                        <th width="100">Nhiệm vụ</th>
                                    </tr>
                                </thead>
                                <tbody id="rankingByTasks"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                        <i class="fas fa-info-circle"></i> QUY TẮC XẾP HẠNG THAM KHẢO ( 02 quy tắc xếp)
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h5 style="color: var(--secondary-color); margin-bottom: 10px;">Danh sách 1 (Thành tích):</h5>
                            <ol style="margin-left: 20px; font-size: 0.9rem; color: #555;">
                                <li>Xét thành tích cao nhất (cấp độ 1-5)</li>
                                <li>Số lượng thành tích cao nhất</li>
                                <li>Thành tích cao tiếp theo</li>
                                <li>Nếu vẫn bằng: Ưu tiên NỮ</li>
                                <li>Tiếp theo: Lớn tuổi hơn</li>
                                <li>Cuối cùng: Công tác lâu hơn</li>
                            </ol>
                        </div>
                        <div>
                            <h5 style="color: var(--secondary-color); margin-bottom: 10px;">Danh sách 2 (Nhiệm vụ):</h5>
                            <ul style="margin-left: 20px; font-size: 0.9rem; color: #555;">
                                <li>Số lượng nhiệm vụ đã thực hiện (7 nhiệm vụ)</li>
                                <li>Nếu bằng nhau: Xét thành tích</li>
                                <li>Tiếp theo: Ưu tiên NỮ</li>
                                <li>Tiếp theo: Lớn tuổi hơn</li>
                                <li>Cuối cùng: Công tác lâu hơn</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Code Modal -->
    <div class="modal" id="editCodeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-key"></i> NHẬP MÃ CHỈNH SỬA</h3>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-lock" style="font-size: 3rem; color: var(--warning-color); margin-bottom: 20px;"></i>
                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">CHỈNH SỬA HỒ SƠ ĐÃ KHÓA</h4>
                    <p>Hồ sơ của bạn đã được khóa. Để chỉnh sửa, vui lòng nhập mã chỉnh sửa do Admin cung cấp.</p>
                    
                    <div style="margin: 30px 0;">
                        <input type="text" id="editCodeInput" placeholder="Nhập mã chỉnh sửa" 
                               style="width: 100%; padding: 15px; font-size: 1.1rem; text-align: center; letter-spacing: 2px; border: 2px solid var(--border-color); border-radius: 8px;">
                    </div>
                    
                    <p style="font-size: 0.9rem; color: #666;">
                        <i class="fas fa-exclamation-triangle"></i> Mỗi mã chỉ sử dụng được 1 lần
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditCode">
                    Hủy
                </button>
                <button class="btn btn-primary" id="submitEditCode">
                    <i class="fas fa-check"></i> Xác nhận
                </button>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Đang xử lý...</p>
    </div>

    <!-- Overlay for admin panel -->
    <div class="overlay" id="adminOverlay"></div>

    <!-- JavaScript -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDVRsgVDCKk5lIfCRxhSlWiBetNlZBukcc",
            authDomain: "daytoantructuyen-149d9.firebaseapp.com",
            databaseURL: "https://daytoantructuyen-149d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "daytoantructuyen-149d9",
            storageBucket: "daytoantructuyen-149d9.firebasestorage.app",
            messagingSenderId: "258454714393",
            appId: "1:258454714393:web:bcf66624668e516934d288"
        };

        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Biến toàn cục
        let currentTeacherCode = null;
        let currentSubmission = null;
        let isLocked = false;
        let isAdmin = false;
        let allSubmissions = {};
        let editCodes = {};

        // Mã admin cố định
        const ADMIN_CODE = "admin79";

        // Cấp độ thành tích
        const achievementLevels = {
            'chien_si_thi_dua_toan_quoc': 1,
            'huan_chuong_lao_dong_nhat': 2,
            'huan_chuong_lao_dong_nhi': 3,
            'huan_chuong_lao_dong_ba': 4,
            'bang_khen_thu_tuong': 5,
            'chien_si_thi_dua_tinh': 6,
            'bang_khen_bo_tinh': 7,
            'chien_si_thi_dua_co_so': 8,
            'other': 9,
            'none': 10
        };

        // Thành tích thi đua
        const achievementTypes = [
            { id: 'chien_si_thi_dua_toan_quoc', name: 'Chiến sĩ Thi đua Toàn quốc' },
            { id: 'huan_chuong_lao_dong_nhat', name: 'Huân chương Lao động hạng Nhất' },
            { id: 'huan_chuong_lao_dong_nhi', name: 'Huân chương Lao động hạng Nhì' },
            { id: 'huan_chuong_lao_dong_ba', name: 'Huân chương Lao động hạng Ba' },
            { id: 'bang_khen_thu_tuong', name: 'Bằng khen của Thủ tướng Chính phủ' },
            { id: 'chien_si_thi_dua_tinh', name: 'Chiến sĩ thi đua cấp tỉnh/Bộ, Ngành' },
            { id: 'bang_khen_bo_tinh', name: 'Bằng khen của Bộ, ban, ngành, tỉnh' },
            { id: 'chien_si_thi_dua_co_so', name: 'Chiến sĩ thi đua cơ sở' }
        ];

        // Nhiệm vụ giáo viên hạng II
        const teacherTasks = [
            {
                id: 1,
                title: "Làm báo cáo viên hoặc dạy minh họa ở các lớp bồi dưỡng giáo viên từ cấp trường trở lên",
                description: "Hoặc dạy thử nghiệm các mô hình, phương pháp, công nghệ mới; chủ trì các nội dung bồi dưỡng và sinh hoạt chuyên đề ở tổ chuyên môn hoặc tham gia xây dựng học liệu điện tử"
            },
            {
                id: 2,
                title: "Tham gia hướng dẫn hoặc đánh giá các sản phẩm nghiên cứu khoa học và công nghệ",
                description: "Từ cấp trường trở lên"
            },
            {
                id: 3,
                title: "Tham gia đánh giá ngoài hoặc công tác kiểm tra chuyên môn, nghiệp vụ",
                description: "Cho giáo viên từ cấp trường trở lên"
            },
            {
                id: 4,
                title: "Tham gia ban giám khảo hội thi giáo viên dạy giỏi hoặc giáo viên chủ nhiệm lớp giỏi",
                description: "Cấp trường trở lên"
            },
            {
                id: 5,
                title: "Tham gia ra đề hoặc chấm thi học sinh giỏi trung học phổ thông",
                description: "Từ cấp trường trở lên"
            },
            {
                id: 6,
                title: "Tham gia hướng dẫn hoặc đánh giá các hội thi hoặc các sản phẩm nghiên cứu khoa học kỹ thuật",
                description: "Của học sinh trung học phổ thông từ cấp trường trở lên"
            },
            {
                id: 7,
                title: "Tham gia các hoạt động xã hội, phục vụ cộng đồng",
                description: "Thu hút sự tham gia của các tổ chức, cá nhân trong việc tổ chức các hoạt động dạy học, giáo dục học sinh"
            }
        ];

        // Hàm tiện ích
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showMessage(message, type = 'error', duration = 5000) {
            const validationDiv = document.getElementById('validationMessage');
            validationDiv.innerHTML = `
                <div class="missing-fields-alert ${type === 'error' ? 'show' : ''}" 
                     style="background: ${type === 'error' ? 'linear-gradient(135deg, #ff6b6b, #ee5a24)' : 
                              type === 'success' ? 'linear-gradient(135deg, #4CAF50, #219653)' : 
                              'linear-gradient(135deg, #3498db, #2980b9)'};">
                    <h4><i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 
                                        type === 'success' ? 'check-circle' : 'info-circle'}"></i> 
                        ${type === 'error' ? 'LỖI' : type === 'success' ? 'THÀNH CÔNG' : 'THÔNG BÁO'}
                    </h4>
                    <p>${message}</p>
                </div>
            `;
            
            setTimeout(() => {
                validationDiv.innerHTML = '';
            }, duration);
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function generateYears(startYear = 1980, endYear = new Date().getFullYear()) {
            const years = [];
            for (let year = endYear; year >= startYear; year--) {
                years.push(year.toString());
            }
            return years;
        }

        function generateSchoolYears() {
            const currentYear = new Date().getFullYear();
            const years = [];
            for (let i = 8; i >= 0; i--) {
                const year = currentYear - i - 1;
                years.push({
                    value: `${year}-${year + 1}`,
                    label: `Năm học ${year}-${year + 1}`,
                    shortLabel: `${year}-${year + 1}`,
                    sortKey: year
                });
            }
            return years.sort((a, b) => b.sortKey - a.sortKey);
        }

        // Tạo mã giáo viên ngẫu nhiên
        function generateTeacherCode() {
            const prefix = 'GV';
            const timestamp = Date.now().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }

        // Tạo mã chỉnh sửa ngẫu nhiên
        function generateEditCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return 'EDIT-' + code;
        }

        // Hàm chuẩn hóa tên (loại bỏ khoảng trắng thừa, chuyển về chữ thường)
        function normalizeName(name) {
            return name.trim().toLowerCase().replace(/\s+/g, ' ');
        }

        // Hàm chuẩn hóa ngày sinh
        function normalizeBirthDate(dateString) {
            if (!dateString) return '';
            return dateString.split('T')[0]; // Chỉ lấy phần YYYY-MM-DD
        }

        // Kiểm tra trùng lặp giáo viên
        function checkDuplicateTeacher(name, birthDate, currentCode = null) {
            const normalizedName = normalizeName(name);
            const normalizedBirthDate = normalizeBirthDate(birthDate);
            
            if (!normalizedName || !normalizedBirthDate) return null;
            
            const submissions = Object.entries(allSubmissions);
            
            for (const [code, submission] of submissions) {
                // Bỏ qua chính bản thân nếu đang chỉnh sửa
                if (currentCode && code === currentCode) continue;
                
                const existingName = normalizeName(submission.name || '');
                const existingBirthDate = normalizeBirthDate(submission.birthDate || '');
                
                if (existingName === normalizedName && existingBirthDate === normalizedBirthDate) {
                    return {
                        code: code,
                        name: submission.name,
                        birthDate: submission.birthDate
                    };
                }
            }
            
            return null;
        }

        // Hiển thị cảnh báo trùng lặp
        function showDuplicateWarning(duplicateInfo) {
            const warningDiv = document.getElementById('duplicateWarning');
            if (duplicateInfo) {
                warningDiv.style.display = 'block';
                warningDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong>GIÁO VIÊN ĐÃ KÊ KHAI</strong>
                        <p style="margin-top: 5px; font-size: 0.85rem;">
                            Họ tên và ngày sinh đã tồn tại trong hệ thống (Mã: ${duplicateInfo.code}). 
                            Nếu đây là bạn, vui lòng liên hệ Quản lý để chỉnh sửa.
                        </p>
                    </div>
                `;
            } else {
                warningDiv.style.display = 'none';
            }
        }

        // Hàm tính tuổi từ ngày sinh
        function calculateAge(birthDate) {
            if (!birthDate) return 0;
            const birth = new Date(birthDate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }

        // Hàm tính thâm niên từ năm vào ngành
        function calculateSeniority(startYear) {
            if (!startYear) return 0;
            const currentYear = new Date().getFullYear();
            return currentYear - parseInt(startYear);
        }

        // So sánh theo thành tích CẢI TIẾN
        function compareByAchievements(a, b) {
            const aAchievements = a.achievementScore;
            const bAchievements = b.achievementScore;
            
            // Lấy thành tích cao nhất
            const aTop = aAchievements[0];
            const bTop = bAchievements[0];
            
            // So sánh thành tích cao nhất
            if (!bTop && aTop) return -1;
            if (!aTop && bTop) return 1;
            if (aTop && bTop) {
                if (aTop.level !== bTop.level) {
                    return aTop.level - bTop.level;
                }
            }
            
            // Nếu cùng thành tích cao nhất, đếm số lượng thành tích cao nhất
            const aTopCount = aAchievements.filter(ach => ach.level === (aTop?.level || 10)).length;
            const bTopCount = bAchievements.filter(ach => ach.level === (bTop?.level || 10)).length;
            
            if (aTopCount !== bTopCount) {
                return bTopCount - aTopCount;
            }
            
            // Nếu số lượng thành tích cao nhất bằng nhau, xét thành tích tiếp theo
            const aNext = aAchievements[aTopCount];
            const bNext = bAchievements[bTopCount];
            
            if (!bNext && aNext) return -1;
            if (!aNext && bNext) return 1;
            if (aNext && bNext) {
                if (aNext.level !== bNext.level) {
                    return aNext.level - bNext.level;
                }
            }
            
            // Tiếp tục so sánh các thành tích tiếp theo
            let index = aTopCount;
            while (index < Math.max(aAchievements.length, bAchievements.length)) {
                const aAch = aAchievements[index];
                const bAch = bAchievements[index];
                
                if (!bAch && aAch) return -1;
                if (!aAch && bAch) return 1;
                if (aAch && bAch) {
                    if (aAch.level !== bAch.level) {
                        return aAch.level - bAch.level;
                    }
                }
                index++;
            }
            
            // Nếu tất cả thành tích đều bằng nhau, xét số lượng thành tích tổng
            if (aAchievements.length !== bAchievements.length) {
                return bAchievements.length - aAchievements.length;
            }
            
            // Nếu vẫn bằng: Ưu tiên NỮ
            if (a.gender === 'nu' && b.gender !== 'nu') return -1;
            if (a.gender !== 'nu' && b.gender === 'nu') return 1;
            
            // Tiếp theo: Lớn tuổi hơn
            const aAge = calculateAge(a.birthDate);
            const bAge = calculateAge(b.birthDate);
            if (aAge !== bAge) {
                return bAge - aAge; // Lớn tuổi hơn xếp trên
            }
            
            // Cuối cùng: Công tác lâu hơn
            const aSeniority = calculateSeniority(a.startYear);
            const bSeniority = calculateSeniority(b.startYear);
            if (aSeniority !== bSeniority) {
                return bSeniority - aSeniority; // Công tác lâu hơn xếp trên
            }
            
            // Nếu tất cả đều bằng, xét theo mã
            return a.code.localeCompare(b.code);
        }

        // So sánh theo nhiệm vụ CẢI TIẾN
        function compareByTasks(a, b) {
            // Ưu tiên số nhiệm vụ đã thực hiện
            if (b.completedTasks !== a.completedTasks) {
                return b.completedTasks - a.completedTasks;
            }
            
            // Nếu số nhiệm vụ bằng nhau, xét thành tích
            const achievementCompare = compareByAchievements(a, b);
            if (achievementCompare !== 0) {
                return achievementCompare;
            }
            
            // Nếu thành tích bằng nhau, ưu tiên NỮ
            if (a.gender === 'nu' && b.gender !== 'nu') return -1;
            if (a.gender !== 'nu' && b.gender === 'nu') return 1;
            
            // Tiếp theo: Lớn tuổi hơn
            const aAge = calculateAge(a.birthDate);
            const bAge = calculateAge(b.birthDate);
            if (aAge !== bAge) {
                return bAge - aAge;
            }
            
            // Cuối cùng: Công tác lâu hơn
            const aSeniority = calculateSeniority(a.startYear);
            const bSeniority = calculateSeniority(b.startYear);
            if (aSeniority !== bSeniority) {
                return bSeniority - aSeniority;
            }
            
            // Nếu tất cả đều bằng, xét theo mã
            return a.code.localeCompare(b.code);
        }

        // Khởi tạo ứng dụng
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        function initApp() {
            setupEventListeners();
            loadAllSubmissions();
            loadEditCodes();
            setupYearAchievements();
            populateFormFields();
            setupDuplicateChecking(); // Thêm kiểm tra trùng lặp
            
            // Hiển thị form kê khai mới ngay từ đầu
            startNewSubmission();
        }

        function startNewSubmission() {
            // Tạo mã mới cho giáo viên
            currentTeacherCode = generateTeacherCode();
            
            // Cập nhật status badge
            document.getElementById('submissionStatus').innerHTML = `
                <i class="fas fa-user-plus"></i>
                <span>Kê khai mới - Mã: ${currentTeacherCode}</span>
            `;
            
            // Hiển thị mã giáo viên
            document.getElementById('newTeacherIdDisplay').style.display = 'block';
            document.getElementById('generatedTeacherCode').textContent = currentTeacherCode;
            
            // Reset form
            resetForm();
            
            // Ẩn phần kiểm tra mã
            document.getElementById('teacherCheckSection').style.display = 'none';
            
            // Hiển thị tabs form
            document.getElementById('formTabs').style.display = 'block';
            document.getElementById('progressTabs').style.display = 'flex';
            
            // Ẩn lock message nếu có
            document.getElementById('lockMessage').style.display = 'none';
            
            // Ẩn cảnh báo trùng lặp
            document.getElementById('duplicateWarning').style.display = 'none';
            
            // Lưu vào localStorage
            localStorage.setItem('currentTeacherCode', currentTeacherCode);
            localStorage.setItem('isEditing', 'true');
            
            // Focus vào ô tên
            setTimeout(() => {
                document.getElementById('teacherName').focus();
            }, 300);
        }

        function resetForm() {
            // Reset tất cả các trường
            document.getElementById('teacherName').value = '';
            document.getElementById('birthDate').value = '';
            document.getElementById('gender').value = '';
            document.getElementById('startYear').value = '';
            document.getElementById('standardCommitmentRadio').checked = false;
            document.getElementById('standardCommitment').classList.remove('selected');
            document.getElementById('otherAchievements').value = '';
            
            // Reset validation messages
            document.getElementById('nameValidation').style.display = 'none';
            document.getElementById('birthDateValidation').style.display = 'none';
            
            // Reset các năm
            const schoolYears = generateSchoolYears();
            schoolYears.forEach(yearData => {
                const yearValue = yearData.value;
                const radio = document.querySelector(`input[name="achievement_${yearValue}"]:checked`);
                if (radio) radio.checked = false;
                
                const option = document.querySelector(`[data-year="${yearValue}"].selected`);
                if (option) option.classList.remove('selected');
                
                const customText = document.querySelector(`.custom-achievement-text[data-year="${yearValue}"]`);
                if (customText) customText.value = '';
                
                updateYearStatus(yearValue);
            });
            
            // Reset tasks
            for (let i = 1; i <= 7; i++) {
                const radio = document.querySelector(`input[name="task_${i}"]:checked`);
                if (radio) radio.checked = false;
                updateTaskStatus(i);
            }
            
            // Reset confirmation
            document.getElementById('finalConfirmation').checked = false;
            document.getElementById('submitForm').disabled = true;
            
            // Reset tabs
            switchTab('info');
            updateTabErrors();
        }

        function setupEventListeners() {
            // Card lựa chọn
            document.getElementById('newTeacherCard').addEventListener('click', function() {
                selectCard('new');
                startNewSubmission();
            });
            
            document.getElementById('existingTeacherCard').addEventListener('click', function() {
                selectCard('existing');
                document.getElementById('existingTeacherSection').style.display = 'block';
            });
            
            // Back to options
            document.getElementById('backToOptions').addEventListener('click', function() {
                document.getElementById('existingTeacherSection').style.display = 'none';
                document.getElementById('idCheckResult').style.display = 'none';
                document.getElementById('teacherIdInput').value = '';
                selectCard(null);
            });
            
            // Check teacher ID
            document.getElementById('checkTeacherId').addEventListener('click', checkTeacherId);
            document.getElementById('teacherIdInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkTeacherId();
            });
            
            // Use existing ID
            document.getElementById('useExistingId').addEventListener('click', useExistingId);
            
            // Edit locked profile
            document.getElementById('editLockedProfile').addEventListener('click', function() {
                openModal('editCodeModal');
            });
            
            // Start new profile
            document.getElementById('startNewProfile').addEventListener('click', function() {
                document.getElementById('lockMessage').style.display = 'none';
                document.getElementById('teacherCheckSection').style.display = 'block';
                selectCard('new');
            });

            // Navigation between tabs - THÊM KIỂM TRA TRÙNG LẶP
            document.getElementById('nextToAchievements').addEventListener('click', () => {
                if (validatePersonalInfoWithDetails()) {
                    // Kiểm tra trùng lặp trước khi chuyển tab
                    const name = document.getElementById('teacherName').value;
                    const birthDate = document.getElementById('birthDate').value;
                    
                    if (name && birthDate) {
                        const duplicate = checkDuplicateTeacher(name, birthDate, currentTeacherCode);
                        if (duplicate && !currentSubmission) {
                            // Nếu là kê khai mới và bị trùng
                            showDuplicateWarning(duplicate);
                            showMessage('Giáo viên đã kê khai. Vui lòng liên hệ Quản lý để chỉnh sửa.', 'error');
                            return false;
                        }
                    }
                    
                    switchTab('achievements');
                    return true;
                }
                return false;
            });

            document.getElementById('nextToTasks').addEventListener('click', () => {
                if (validateCurrentTab('achievements')) {
                    switchTab('tasks');
                }
            });

            document.getElementById('nextToReview').addEventListener('click', () => {
                if (validateCurrentTab('tasks')) {
                    switchTab('review');
                    updateSummary();
                }
            });

            document.getElementById('backToInfo').addEventListener('click', () => switchTab('info'));
            document.getElementById('backToAchievements').addEventListener('click', () => switchTab('achievements'));
            document.getElementById('backToTasks').addEventListener('click', () => switchTab('tasks'));

            // Submit form - THÊM KIỂM TRA TRÙNG LẶP
            document.getElementById('submitForm').addEventListener('click', submitForm);
            
            // Final confirmation checkbox
            document.getElementById('finalConfirmation').addEventListener('change', function() {
                document.getElementById('submitForm').disabled = !this.checked;
            });

            // Standard commitment
            document.getElementById('standardCommitment').addEventListener('click', function() {
                const radio = document.getElementById('standardCommitmentRadio');
                radio.checked = !radio.checked;
                this.classList.toggle('selected', radio.checked);
            });

            // Admin panel
            document.getElementById('adminBtn').addEventListener('click', toggleAdminPanel);
            document.getElementById('closeAdminPanel').addEventListener('click', closeAdminPanel);
            document.getElementById('adminOverlay').addEventListener('click', closeAdminPanel);
            document.getElementById('adminLoginBtn').addEventListener('click', adminLogin);

            // Public view
            document.getElementById('viewPublicBtn').addEventListener('click', showPublicRanking);
            document.getElementById('closePublicView').addEventListener('click', () => closeModal('publicViewModal'));

            // Edit code modal
            document.getElementById('cancelEditCode').addEventListener('click', () => closeModal('editCodeModal'));
            document.getElementById('submitEditCode').addEventListener('click', verifyEditCode);
            document.getElementById('editCodeInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    verifyEditCode();
                }
            });

            // Generate edit code button
            document.getElementById('generateEditCodeBtn').addEventListener('click', generateEditCodeForTeacher);
            
            // Validation real-time cho tên
            document.getElementById('teacherName').addEventListener('input', function() {
                validateNameRealTime(this.value);
            });
            
            // Validation real-time cho ngày sinh
            document.getElementById('birthDate').addEventListener('change', function() {
                validateBirthDateRealTime(this.value);
            });
        }

        // Kiểm tra trùng lặp real-time khi nhập
        function setupDuplicateChecking() {
            const nameInput = document.getElementById('teacherName');
            const birthDateInput = document.getElementById('birthDate');
            
            let checkTimeout;
            
            function checkDuplicate() {
                const name = nameInput.value;
                const birthDate = birthDateInput.value;
                
                if (name && birthDate) {
                    clearTimeout(checkTimeout);
                    checkTimeout = setTimeout(() => {
                        const duplicate = checkDuplicateTeacher(name, birthDate, currentTeacherCode);
                        showDuplicateWarning(duplicate);
                    }, 500);
                }
            }
            
            nameInput.addEventListener('input', checkDuplicate);
            birthDateInput.addEventListener('change', checkDuplicate);
        }

        // Validation real-time cho tên
        function validateNameRealTime(name) {
            const validationDiv = document.getElementById('nameValidation');
            const normalized = normalizeName(name);
            
            if (!normalized) {
                validationDiv.style.display = 'none';
                return;
            }
            
            // Kiểm tra khoảng trắng thừa
            if (name !== normalized) {
                validationDiv.style.display = 'block';
                validationDiv.innerHTML = `<i class="fas fa-info-circle" style="color: var(--warning-color);"></i> Đã chuẩn hóa tên`;
                validationDiv.style.color = 'var(--warning-color)';
            } else {
                validationDiv.style.display = 'none';
            }
        }

        // Validation real-time cho ngày sinh
        function validateBirthDateRealTime(dateString) {
            const validationDiv = document.getElementById('birthDateValidation');
            
            if (!dateString) {
                validationDiv.style.display = 'none';
                return;
            }
            
            const birthDate = new Date(dateString);
            const today = new Date();
            const minDate = new Date('1960-01-01');
            const maxDate = new Date('2006-12-31');
            
            if (birthDate < minDate) {
                validationDiv.style.display = 'block';
                validationDiv.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: var(--accent-color);"></i> Ngày sinh không hợp lệ`;
                validationDiv.style.color = 'var(--accent-color)';
            } else if (birthDate > maxDate) {
                validationDiv.style.display = 'block';
                validationDiv.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: var(--accent-color);"></i> Giáo viên phải trên 18 tuổi`;
                validationDiv.style.color = 'var(--accent-color)';
            } else {
                validationDiv.style.display = 'none';
            }
        }

        function selectCard(type) {
            // Remove selection from all cards
            document.querySelectorAll('.teacher-check-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to chosen card
            if (type === 'new') {
                document.getElementById('newTeacherCard').classList.add('selected');
            } else if (type === 'existing') {
                document.getElementById('existingTeacherCard').classList.add('selected');
            }
        }

        async function checkTeacherId() {
            const teacherId = document.getElementById('teacherIdInput').value.trim().toUpperCase();
            
            if (!teacherId) {
                showMessage('Vui lòng nhập mã giáo viên', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                // Kiểm tra trong Firebase
                const snapshot = await database.ref(`submissions/${teacherId}`).once('value');
                const submission = snapshot.val();
                
                const resultDiv = document.getElementById('idCheckResult');
                const infoDiv = document.getElementById('existingTeacherInfo');
                
                if (submission) {
                    // Đã tồn tại
                    if (submission.status === 'locked') {
                        infoDiv.innerHTML = `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning-color);">
                                <p><strong>${submission.name}</strong> - Mã: ${teacherId}</p>
                                <p>Ngày sinh: ${submission.birthDate ? new Date(submission.birthDate).toLocaleDateString('vi-VN') : 'Chưa có'}</p>
                                <p>Trạng thái: <span style="color: var(--warning-color); font-weight: bold;">Đã khóa</span></p>
                                <p>Thời gian kê khai: ${new Date(submission.submittedAt).toLocaleDateString('vi-VN')}</p>
                                <p><i class="fas fa-info-circle"></i> Hồ sơ đã khóa. Bạn cần mã chỉnh sửa từ Admin.</p>
                            </div>
                        `;
                    } else {
                        infoDiv.innerHTML = `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid var(--info-color);">
                                <p><strong>${submission.name}</strong> - Mã: ${teacherId}</p>
                                <p>Ngày sinh: ${submission.birthDate ? new Date(submission.birthDate).toLocaleDateString('vi-VN') : 'Chưa có'}</p>
                                <p>Trạng thái: <span style="color: var(--info-color); font-weight: bold;">Đang kê khai</span></p>
                                <p><i class="fas fa-info-circle"></i> Tiếp tục chỉnh sửa hồ sơ hiện có.</p>
                            </div>
                        `;
                    }
                    
                    resultDiv.style.display = 'block';
                    currentTeacherCode = teacherId;
                    currentSubmission = submission;
                    isLocked = submission.status === 'locked';
                    
                } else {
                    // Chưa tồn tại
                    infoDiv.innerHTML = `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid var(--success-color);">
                            <p>Mã <strong>${teacherId}</strong> chưa được sử dụng.</p>
                            <p><i class="fas fa-info-circle"></i> Bạn có thể tạo hồ sơ mới với mã này.</p>
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    currentTeacherCode = teacherId;
                    currentSubmission = null;
                    isLocked = false;
                }
                
                showLoading(false);
                
            } catch (error) {
                console.error('Lỗi khi kiểm tra mã:', error);
                showMessage('Lỗi khi kiểm tra mã giáo viên', 'error');
                showLoading(false);
            }
        }

        function useExistingId() {
            if (!currentTeacherCode) return;
            
            if (isLocked) {
                // Yêu cầu mã chỉnh sửa
                openModal('editCodeModal');
            } else {
                // Tiếp tục chỉnh sửa
                continueWithExistingId();
            }
        }

        function continueWithExistingId() {
            // Cập nhật status badge
            document.getElementById('submissionStatus').innerHTML = `
                <i class="fas fa-edit"></i>
                <span>Đang chỉnh sửa - Mã: ${currentTeacherCode}</span>
            `;
            
            // Ẩn phần kiểm tra
            document.getElementById('teacherCheckSection').style.display = 'none';
            document.getElementById('newTeacherIdDisplay').style.display = 'none';
            
            // Hiển thị tabs form
            document.getElementById('formTabs').style.display = 'block';
            document.getElementById('progressTabs').style.display = 'flex';
            
            // Tải dữ liệu nếu có
            if (currentSubmission) {
                loadFormData(currentSubmission);
            } else {
                // Khởi tạo form mới với mã đã nhập
                document.getElementById('newTeacherIdDisplay').style.display = 'block';
                document.getElementById('generatedTeacherCode').textContent = currentTeacherCode;
            }
            
            // Cập nhật trạng thái tabs
            updateTabErrors();
            
            // Lưu vào localStorage
            localStorage.setItem('currentTeacherCode', currentTeacherCode);
            localStorage.setItem('isEditing', 'true');
        }

        async function verifyEditCode() {
            const editCode = document.getElementById('editCodeInput').value.trim().toUpperCase();
            
            if (!editCode) {
                showMessage('Vui lòng nhập mã chỉnh sửa', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                // Kiểm tra mã chỉnh sửa
                const editCodeSnapshot = await database.ref(`editCodes/${editCode}`).once('value');
                const editCodeData = editCodeSnapshot.val();
                
                if (!editCodeData) {
                    showMessage('Mã chỉnh sửa không đúng', 'error');
                    showLoading(false);
                    return;
                }
                
                if (editCodeData.teacherCode !== currentTeacherCode) {
                    showMessage('Mã chỉnh sửa không khớp với giáo viên này', 'error');
                    showLoading(false);
                    return;
                }
                
                if (editCodeData.used) {
                    showMessage('Mã chỉnh sửa đã được sử dụng', 'error');
                    showLoading(false);
                    return;
                }
                
                // Đánh dấu mã đã sử dụng
                await database.ref(`editCodes/${editCode}`).update({
                    used: true,
                    usedAt: new Date().toISOString()
                });
                
                // Mở khóa hồ sơ
                await database.ref(`submissions/${currentTeacherCode}`).update({
                    status: 'editing',
                    unlockedAt: new Date().toISOString(),
                    editCodeUsed: editCode
                });
                
                // Cập nhật local
                currentSubmission.status = 'editing';
                isLocked = false;
                
                // Cập nhật editCodes
                editCodes[editCode].used = true;
                
                // Đóng modal và bắt đầu chỉnh sửa
                closeModal('editCodeModal');
                continueWithExistingId();
                
                showLoading(false);
                showMessage('Mở khóa thành công. Bạn có thể chỉnh sửa hồ sơ.', 'success');
                
            } catch (error) {
                console.error('Lỗi khi xác minh mã:', error);
                showMessage('Lỗi khi xác minh mã chỉnh sửa', 'error');
                showLoading(false);
            }
        }

        async function loadAllSubmissions() {
            try {
                const snapshot = await database.ref('submissions').once('value');
                allSubmissions = snapshot.val() || {};
                
                // Cập nhật thống kê admin nếu đang đăng nhập
                if (isAdmin) {
                    updateAdminStatistics();
                    updateTeacherListAdmin();
                    updateTeacherSelectForEdit();
                }
                
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
            }
        }

        async function loadEditCodes() {
            try {
                const snapshot = await database.ref('editCodes').once('value');
                editCodes = snapshot.val() || {};
                
                if (isAdmin) {
                    updateActiveEditCodes();
                }
                
            } catch (error) {
                console.error('Lỗi khi tải mã chỉnh sửa:', error);
            }
        }

        // Admin functions
        function toggleAdminPanel() {
            const panel = document.getElementById('adminPanel');
            const overlay = document.getElementById('adminOverlay');
            
            if (panel.classList.contains('open')) {
                panel.classList.remove('open');
                overlay.classList.remove('show');
            } else {
                panel.classList.add('open');
                overlay.classList.add('show');
            }
        }

        function closeAdminPanel() {
            document.getElementById('adminPanel').classList.remove('open');
            document.getElementById('adminOverlay').classList.remove('show');
        }

        async function adminLogin() {
            const adminCode = document.getElementById('adminCodeInput').value.trim();
            
            if (adminCode !== ADMIN_CODE) {
                alert('Mã admin không đúng');
                return;
            }
            
            isAdmin = true;
            
            // Hiển thị chức năng admin
            document.getElementById('adminLoginSection').style.display = 'none';
            document.getElementById('adminFunctions').style.display = 'block';
            
            // Cập nhật dữ liệu
            updateAdminStatistics();
            updateTeacherListAdmin();
            updateTeacherSelectForEdit();
            updateActiveEditCodes();
            
            showMessage('Đăng nhập quản trị thành công', 'success', 3000);
        }

        function updateAdminStatistics() {
            const submissions = Object.values(allSubmissions);
            const totalTeachers = submissions.length;
            const completedSubmissions = submissions.filter(s => s.status === 'locked').length;
            const incompleteSubmissions = totalTeachers - completedSubmissions;
            
            const activeEditCodesCount = Object.values(editCodes).filter(ec => !ec.used).length;
            
            document.getElementById('totalTeachersCount').textContent = totalTeachers;
            document.getElementById('completedSubmissionsCount').textContent = completedSubmissions;
            document.getElementById('incompleteSubmissionsCount').textContent = incompleteSubmissions;
            document.getElementById('activeEditCodesCount').textContent = activeEditCodesCount;
        }

        function updateTeacherListAdmin() {
            const container = document.getElementById('teacherListAdmin');
            const submissions = Object.entries(allSubmissions);
            
            if (submissions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Chưa có dữ liệu.</p>';
                return;
            }
            
            // Sắp xếp theo thời gian
            submissions.sort((a, b) => b[1].timestamp - a[1].timestamp);
            
            let html = '';
            submissions.forEach(([code, submission]) => {
                const statusColor = submission.status === 'locked' ? 'var(--success-color)' : 
                                  submission.status === 'editing' ? 'var(--warning-color)' : 'var(--info-color)';
                const statusText = submission.status === 'locked' ? 'Đã khóa' : 
                                 submission.status === 'editing' ? 'Đang chỉnh sửa' : 'Chưa hoàn thành';
                
                // Tính số nhiệm vụ đã thực hiện
                const completedTasks = submission.tasks ? 
                    submission.tasks.filter(t => t.status === 'done').length : 0;
                
                // Tính số năm có thành tích
                let yearsWithAchievements = 0;
                if (submission.yearAchievements) {
                    yearsWithAchievements = Object.values(submission.yearAchievements)
                        .filter(a => a.id !== 'none').length;
                }
                
                html += `
                    <div class="teacher-item-admin">
                        <div class="teacher-info-admin">
                            <div class="teacher-name-admin">${submission.name}</div>
                            <div class="teacher-code-admin">Mã: ${code} | Ngày sinh: ${submission.birthDate ? new Date(submission.birthDate).toLocaleDateString('vi-VN') : 'Chưa có'} | Năm vào ngành: ${submission.startYear}</div>
                            <div style="font-size: 0.8rem; margin-top: 5px;">
                                <span style="color: ${statusColor}; font-weight: 600;">${statusText}</span>
                                | Nhiệm vụ: ${completedTasks}/7 | Thành tích: ${yearsWithAchievements}/9 năm
                            </div>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="deleteTeacher('${code}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateTeacherSelectForEdit() {
            const select = document.getElementById('teacherSelectForEdit');
            const submissions = Object.entries(allSubmissions)
                .filter(([_, s]) => s.status === 'locked') // Chỉ những người đã khóa
                .sort((a, b) => a[1].name.localeCompare(b[1].name));
            
            // Giữ option đầu tiên
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            submissions.forEach(([code, submission]) => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${submission.name} (${code})`;
                select.appendChild(option);
            });
        }

        function updateActiveEditCodes() {
            const container = document.getElementById('activeEditCodes');
            const activeCodes = Object.entries(editCodes)
                .filter(([_, ec]) => !ec.used)
                .sort((a, b) => b[1].createdAt - a[1].createdAt);
            
            if (activeCodes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Không có mã nào đang hoạt động.</p>';
                return;
            }
            
            let html = '';
            activeCodes.forEach(([code, data]) => {
                const teacherName = allSubmissions[data.teacherCode]?.name || 'Không xác định';
                const createdAt = new Date(data.createdAt).toLocaleDateString('vi-VN');
                
                html += `
                    <div class="teacher-item-admin">
                        <div class="teacher-info-admin">
                            <div class="teacher-name-admin">Mã: ${code}</div>
                            <div class="teacher-code-admin">Giáo viên: ${teacherName} (${data.teacherCode})</div>
                            <div style="font-size: 0.8rem; margin-top: 5px;">
                                Tạo ngày: ${createdAt}
                            </div>
                        </div>
                        <button class="btn btn-warning btn-sm" onclick="revokeEditCode('${code}')">
                            <i class="fas fa-ban"></i>
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Xóa giáo viên
        async function deleteTeacher(teacherCode) {
            if (!confirm(`Bạn có chắc chắn muốn xóa giáo viên ${teacherCode}?`)) {
                return;
            }
            
            showLoading(true);
            
            try {
                // Xóa từ Firebase
                await database.ref(`submissions/${teacherCode}`).remove();
                
                // Xóa mã chỉnh sửa liên quan
                const editCodesToDelete = Object.entries(editCodes)
                    .filter(([_, ec]) => ec.teacherCode === teacherCode)
                    .map(([code, _]) => code);
                
                for (const code of editCodesToDelete) {
                    await database.ref(`editCodes/${code}`).remove();
                }
                
                // Cập nhật local
                delete allSubmissions[teacherCode];
                
                // Cập nhật giao diện
                updateAdminStatistics();
                updateTeacherListAdmin();
                updateTeacherSelectForEdit();
                updateActiveEditCodes();
                
                showLoading(false);
                showMessage(`Đã xóa giáo viên ${teacherCode}`, 'success');
                
            } catch (error) {
                console.error('Lỗi khi xóa giáo viên:', error);
                showMessage('Lỗi khi xóa giáo viên', 'error');
                showLoading(false);
            }
        }

        // Tạo mã chỉnh sửa
        async function generateEditCodeForTeacher() {
            const teacherCode = document.getElementById('teacherSelectForEdit').value;
            
            if (!teacherCode) {
                alert('Vui lòng chọn giáo viên');
                return;
            }
            
            const teacher = allSubmissions[teacherCode];
            if (!teacher || teacher.status !== 'locked') {
                alert('Giáo viên này chưa khóa hồ sơ');
                return;
            }
            
            showLoading(true);
            
            try {
                // Tạo mã mới
                const editCode = generateEditCode();
                const editCodeData = {
                    teacherCode: teacherCode,
                    teacherName: teacher.name,
                    createdAt: new Date().toISOString(),
                    used: false,
                    createdBy: 'admin'
                };
                
                // Lưu vào Firebase
                await database.ref(`editCodes/${editCode}`).set(editCodeData);
                
                // Cập nhật local
                editCodes[editCode] = editCodeData;
                
                // Hiển thị mã
                document.getElementById('editCodeResult').style.display = 'block';
                document.getElementById('generatedEditCode').textContent = editCode;
                
                // Cập nhật danh sách
                updateActiveEditCodes();
                updateAdminStatistics();
                
                showLoading(false);
                showMessage(`Đã tạo mã chỉnh sửa: ${editCode}`, 'success');
                
            } catch (error) {
                console.error('Lỗi khi tạo mã chỉnh sửa:', error);
                showMessage('Lỗi khi tạo mã chỉnh sửa', 'error');
                showLoading(false);
            }
        }

        // Thu hồi mã chỉnh sửa
        async function revokeEditCode(editCode) {
            if (!confirm(`Bạn có chắc chắn muốn thu hồi mã ${editCode}?`)) {
                return;
            }
            
            showLoading(true);
            
            try {
                // Xóa mã từ Firebase
                await database.ref(`editCodes/${editCode}`).remove();
                
                // Cập nhật local
                delete editCodes[editCode];
                
                // Cập nhật giao diện
                updateActiveEditCodes();
                updateAdminStatistics();
                
                showLoading(false);
                showMessage(`Đã thu hồi mã ${editCode}`, 'success');
                
            } catch (error) {
                console.error('Lỗi khi thu hồi mã:', error);
                showMessage('Lỗi khi thu hồi mã chỉnh sửa', 'error');
                showLoading(false);
            }
        }

        function setupYearAchievements() {
            const container = document.getElementById('yearAchievementsContainer');
            const schoolYears = generateSchoolYears();
            
            schoolYears.forEach(yearData => {
                const yearSection = document.createElement('div');
                yearSection.className = 'year-achievement-section';
                yearSection.id = `year-${yearData.value.replace('-', '_')}`;
                
                yearSection.innerHTML = `
                    <div class="year-header">
                        <div class="year-title">
                            <i class="fas fa-calendar-alt"></i> ${yearData.label}
                        </div>
                        <div class="year-status status-not-done" id="status-${yearData.value}">
                            Chưa kê khai
                        </div>
                    </div>
                    
                    <button class="khaikai-btn" type="button" data-year="${yearData.value}" id="btn-${yearData.value}">
                        <i class="fas fa-edit"></i> Kê khai thành tích
                    </button>
                    
                    <div class="year-collapsible" id="collapse-${yearData.value}" style="display: none; margin-top: 20px;">
                        <div style="margin-bottom: 15px; color: #666; font-style: italic;">
                            <i class="fas fa-info-circle"></i> Chọn thành tích cao nhất của năm ${yearData.label}
                        </div>
                        <div class="achievement-options">
                            ${achievementTypes.map(achievement => `
                                <div class="achievement-option" data-year="${yearData.value}" data-achievement="${achievement.id}">
                                    <div class="achievement-title">${achievement.name}</div>
                                    <div class="achievement-description">Thành tích cấp ${achievementLevels[achievement.id] <= 5 ? 'cao' : achievementLevels[achievement.id] <= 7 ? 'trung bình' : 'cơ sở'}</div>
                                    <div class="achievement-radio"></div>
                                    <input type="radio" name="achievement_${yearData.value}" value="${achievement.id}" style="display: none;">
                                </div>
                            `).join('')}
                            
                            <div class="no-achievement-option" data-year="${yearData.value}" data-achievement="none">
                                <div class="achievement-title">Không có thành tích trong năm này</div>
                                <div class="achievement-description">Chọn nếu không có thành tích nào trong năm ${yearData.label}</div>
                                <div class="achievement-radio"></div>
                                <input type="radio" name="achievement_${yearData.value}" value="none" style="display: none;">
                            </div>
                            
                            <div class="achievement-option" data-year="${yearData.value}" data-achievement="other">
                                <div class="achievement-title">Thành tích khác (không có trong danh sách)</div>
                                <div class="achievement-description">Chọn nếu có thành tích đặc biệt khác không có trong danh sách</div>
                                <div class="achievement-radio"></div>
                                <input type="radio" name="achievement_${yearData.value}" value="other" style="display: none;">
                            </div>
                        </div>
                        
                        <div class="custom-achievement" id="custom-${yearData.value}" style="display: none;">
                            <label>Mô tả thành tích đặc biệt</label>
                            <textarea class="custom-achievement-text" data-year="${yearData.value}" 
                                placeholder="Ghi rõ thành tích đặc biệt không có trong danh sách trên..."></textarea>
                        </div>
                    </div>
                `;
                
                container.appendChild(yearSection);
                
                // Thêm sự kiện cho nút KÊ KHAI
                const khaikaiBtn = yearSection.querySelector('.khaikai-btn');
                khaikaiBtn.addEventListener('click', function() {
                    const year = this.dataset.year;
                    const collapsible = document.getElementById(`collapse-${year}`);
                    const isVisible = collapsible.style.display !== 'none';
                    
                    if (isVisible) {
                        collapsible.style.display = 'none';
                        this.innerHTML = '<i class="fas fa-edit"></i> Kê khai thành tích';
                    } else {
                        collapsible.style.display = 'block';
                        this.innerHTML = '<i class="fas fa-times"></i> Đóng';
                    }
                });
                
                // Thêm sự kiện cho các lựa chọn thành tích
                yearSection.querySelectorAll('.achievement-option, .no-achievement-option').forEach(option => {
                    option.addEventListener('click', function() {
                        const year = this.dataset.year;
                        const achievementId = this.dataset.achievement;
                        
                        // Bỏ chọn tất cả các option trong cùng năm
                        const yearOptions = document.querySelectorAll(`[data-year="${year}"]`);
                        yearOptions.forEach(opt => {
                            opt.classList.remove('selected');
                            const radio = opt.querySelector('input[type="radio"]');
                            if (radio) radio.checked = false;
                        });
                        
                        // Chọn option hiện tại
                        this.classList.add('selected');
                        const radio = this.querySelector('input[type="radio"]');
                        if (radio) radio.checked = true;
                        
                        // Cập nhật trạng thái năm
                        updateYearStatus(year);
                        
                        // Hiển thị/ẩn ô thành tích đặc biệt
                        const customDiv = document.getElementById(`custom-${year}`);
                        if (achievementId === 'other') {
                            customDiv.style.display = 'block';
                        } else {
                            customDiv.style.display = 'none';
                        }
                    });
                });
                
                // Thêm sự kiện cho textarea thành tích đặc biệt
                const customTextarea = yearSection.querySelector('.custom-achievement-text');
                if (customTextarea) {
                    customTextarea.addEventListener('input', function() {
                        const year = this.dataset.year;
                        updateYearStatus(year);
                    });
                }
            });
        }

        function updateYearStatus(year) {
            const selectedAchievement = document.querySelector(`input[name="achievement_${year}"]:checked`);
            const statusElement = document.getElementById(`status-${year}`);
            const khaikaiBtn = document.getElementById(`btn-${year}`);
            const yearSection = document.getElementById(`year-${year.replace('-', '_')}`);
            
            if (selectedAchievement) {
                if (selectedAchievement.value === 'other') {
                    const customText = document.querySelector(`.custom-achievement-text[data-year="${year}"]`)?.value.trim();
                    if (customText) {
                        statusElement.textContent = 'Đã kê khai';
                        statusElement.className = 'year-status status-done';
                        khaikaiBtn.innerHTML = '<i class="fas fa-check"></i> Đã kê khai';
                        khaikaiBtn.className = 'khaikai-btn done';
                        yearSection.classList.remove('missing');
                    } else {
                        statusElement.textContent = 'Thiếu mô tả';
                        statusElement.className = 'year-status status-not-done';
                        khaikaiBtn.innerHTML = '<i class="fas fa-edit"></i> Kê khai thành tích';
                        khaikaiBtn.className = 'khaikai-btn';
                        yearSection.classList.add('missing');
                    }
                } else {
                    statusElement.textContent = 'Đã kê khai';
                    statusElement.className = 'year-status status-done';
                    khaikaiBtn.innerHTML = '<i class="fas fa-check"></i> Đã kê khai';
                    khaikaiBtn.className = 'khaikai-btn done';
                    yearSection.classList.remove('missing');
                }
            } else {
                statusElement.textContent = 'Chưa kê khai';
                statusElement.className = 'year-status status-not-done';
                khaikaiBtn.innerHTML = '<i class="fas fa-edit"></i> Kê khai thành tích';
                khaikaiBtn.className = 'khaikai-btn';
                yearSection.classList.add('missing');
            }
        }

        function populateFormFields() {
            // Populate start years
            const startYearSelect = document.getElementById('startYear');
            const years = generateYears(1980, new Date().getFullYear());
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                startYearSelect.appendChild(option);
            });

            // Populate tasks
            const taskList = document.getElementById('taskList');
            teacherTasks.forEach((task, index) => {
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                taskItem.id = `task-${task.id}`;
                taskItem.innerHTML = `
                    <div class="task-header">
                        <div class="task-number">${index + 1}</div>
                        <div class="task-title">${task.title}</div>
                    </div>
                    <div class="task-description">${task.description}</div>
                    <div class="task-options">
                        <div class="task-option">
                            <label>
                                <input type="radio" name="task_${task.id}" value="done">
                                <div class="task-radio"></div>
                                <span class="task-label">
                                    <i class="fas fa-check-circle"></i>
                                    Đã thực hiện
                                </span>
                            </label>
                        </div>
                        <div class="task-option">
                            <label>
                                <input type="radio" name="task_${task.id}" value="capable">
                                <div class="task-radio"></div>
                                <span class="task-label">
                                    <i class="fas fa-lightbulb"></i>
                                    Có khả năng thực hiện
                                </span>
                            </label>
                        </div>
                    </div>
                `;
                taskList.appendChild(taskItem);
                
                // Thêm sự kiện cho radio buttons
                const radioButtons = taskItem.querySelectorAll('input[type="radio"]');
                radioButtons.forEach(radio => {
                    radio.addEventListener('change', function() {
                        updateTaskStatus(task.id);
                        
                        // Đảm bảo chỉ có một cái được chọn
                        radioButtons.forEach(rb => {
                            const label = rb.closest('label');
                            if (rb.checked) {
                                label.style.borderColor = 'var(--success-color)';
                                label.style.background = 'rgba(39, 174, 96, 0.05)';
                            } else {
                                label.style.borderColor = 'var(--border-color)';
                                label.style.background = 'white';
                            }
                        });
                    });
                });
            });
        }

        function updateTaskStatus(taskId) {
            const taskItem = document.getElementById(`task-${taskId}`);
            const selectedRadio = document.querySelector(`input[name="task_${taskId}"]:checked`);
            
            if (selectedRadio) {
                taskItem.classList.remove('missing');
            } else {
                taskItem.classList.add('missing');
            }
        }

        function validateCurrentTab(tabName) {
            let missingFields = [];
            
            if (tabName === 'info') {
                missingFields = validatePersonalInfoWithDetails();
            } else if (tabName === 'achievements') {
                missingFields = validateAchievementsWithDetails();
            } else if (tabName === 'tasks') {
                missingFields = validateTasksWithDetails();
            }
            
            if (missingFields.length > 0) {
                showMissingFieldsAlert(tabName, missingFields);
                highlightMissingFields(missingFields);
                return false;
            }
            
            return true;
        }

        function validatePersonalInfoWithDetails() {
            const missingFields = [];
            const errors = [];
            
            const name = document.getElementById('teacherName').value.trim();
            if (!name) missingFields.push('Họ tên giáo viên');
            
            const birthDate = document.getElementById('birthDate').value;
            if (!birthDate) missingFields.push('Ngày tháng năm sinh');
            
            const gender = document.getElementById('gender').value;
            if (!gender) missingFields.push('Giới tính');
            
            const startYear = document.getElementById('startYear').value;
            if (!startYear) missingFields.push('Năm vào ngành');
            
            const commitment = document.getElementById('standardCommitmentRadio').checked;
            if (!commitment) missingFields.push('Cam kết đạt tiêu chuẩn');
            
            // Kiểm tra ngày sinh hợp lệ
            if (birthDate) {
                const birthDateObj = new Date(birthDate);
                const minDate = new Date('1960-01-01');
                const maxDate = new Date('2006-12-31');
                
                if (birthDateObj < minDate) {
                    errors.push('Ngày sinh không hợp lệ (phải sau 01/01/1960)');
                } else if (birthDateObj > maxDate) {
                    errors.push('Giáo viên phải trên 18 tuổi');
                }
            }
            
            if (missingFields.length > 0) {
                showMissingFieldsAlert('Thông tin cá nhân', missingFields);
                return false;
            }
            
            if (errors.length > 0) {
                showMessage(errors.join(', '), 'error');
                return false;
            }
            
            return true;
        }

        function validateAchievementsWithDetails() {
            const missingFields = [];
            const schoolYears = generateSchoolYears();
            
            schoolYears.forEach(yearData => {
                const yearValue = yearData.value;
                const selectedAchievement = document.querySelector(`input[name="achievement_${yearValue}"]:checked`);
                
                if (!selectedAchievement) {
                    missingFields.push(`Năm học ${yearData.shortLabel} chưa kê khai`);
                } else if (selectedAchievement.value === 'other') {
                    const customText = document.querySelector(`.custom-achievement-text[data-year="${yearValue}"]`)?.value.trim();
                    if (!customText) {
                        missingFields.push(`Năm học ${yearData.shortLabel} thiếu mô tả thành tích đặc biệt`);
                    }
                }
            });
            
            return missingFields;
        }

        function validateTasksWithDetails() {
            const missingFields = [];
            
            for (let i = 1; i <= 7; i++) {
                const taskRadio = document.querySelector(`input[name="task_${i}"]:checked`);
                if (!taskRadio) {
                    missingFields.push(`Nhiệm vụ số ${i} chưa đánh giá`);
                }
            }
            
            return missingFields;
        }

        function showMissingFieldsAlert(section, missingFields) {
            const alertDiv = document.getElementById('missingFieldsAlert');
            const listDiv = document.getElementById('missingFieldsList');
            
            listDiv.innerHTML = '';
            missingFields.forEach(field => {
                const li = document.createElement('li');
                li.innerHTML = `<i class="fas fa-times-circle"></i> ${field}`;
                listDiv.appendChild(li);
            });
            
            alertDiv.classList.add('show');
            
            setTimeout(() => {
                alertDiv.classList.remove('show');
            }, 10000);
        }

        function highlightMissingFields(missingFields) {
            // Reset tất cả highlight
            document.querySelectorAll('.year-achievement-section, .task-item').forEach(el => {
                el.classList.remove('missing');
            });
            
            // Highlight các năm học thiếu
            missingFields.forEach(field => {
                if (field.includes('Năm học')) {
                    const yearMatch = field.match(/Năm học (\d{4}-\d{4})/);
                    if (yearMatch) {
                        const year = yearMatch[1];
                        const yearSection = document.getElementById(`year-${year.replace('-', '_')}`);
                        if (yearSection) {
                            yearSection.classList.add('missing');
                            // Tự động mở phần kê khai
                            const khaikaiBtn = document.getElementById(`btn-${year}`);
                            if (khaikaiBtn) khaikaiBtn.click();
                        }
                    }
                } else if (field.includes('Nhiệm vụ số')) {
                    const taskMatch = field.match(/Nhiệm vụ số (\d+)/);
                    if (taskMatch) {
                        const taskId = taskMatch[1];
                        const taskItem = document.getElementById(`task-${taskId}`);
                        if (taskItem) {
                            taskItem.classList.add('missing');
                            // Cuộn đến task
                            taskItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                }
            });
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Update active tab in navigation
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            
            // Hide missing fields alert
            document.getElementById('missingFieldsAlert').classList.remove('show');
        }

        function updateTabErrors() {
            // Update errors on tabs
            const tabs = ['info', 'achievements', 'tasks'];
            
            tabs.forEach(tabName => {
                const tab = document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
                
                if (tabName === 'info') {
                    const missingFields = validatePersonalInfoWithDetails();
                    tab.classList.toggle('error', missingFields.length > 0);
                    tab.classList.toggle('completed', missingFields.length === 0);
                } else if (tabName === 'achievements') {
                    const missingFields = validateAchievementsWithDetails();
                    tab.classList.toggle('error', missingFields.length > 0);
                    tab.classList.toggle('completed', missingFields.length === 0);
                } else if (tabName === 'tasks') {
                    const missingFields = validateTasksWithDetails();
                    tab.classList.toggle('error', missingFields.length > 0);
                    tab.classList.toggle('completed', missingFields.length === 0);
                }
            });
        }

        function loadFormData(data) {
            if (!data) return;
            
            // Personal info
            document.getElementById('teacherName').value = data.name || '';
            document.getElementById('birthDate').value = data.birthDate || '';
            document.getElementById('gender').value = data.gender || '';
            document.getElementById('startYear').value = data.startYear || '';
            
            if (data.commitment) {
                document.getElementById('standardCommitmentRadio').checked = true;
                document.getElementById('standardCommitment').classList.add('selected');
            }
            
            // Achievements
            if (data.yearAchievements) {
                Object.entries(data.yearAchievements).forEach(([year, achievementData]) => {
                    const achievementId = achievementData.id;
                    const customText = achievementData.customText;
                    
                    if (achievementId === 'other') {
                        const otherOption = document.querySelector(`[data-year="${year}"][data-achievement="other"]`);
                        if (otherOption) {
                            otherOption.click();
                            const textarea = document.querySelector(`.custom-achievement-text[data-year="${year}"]`);
                            if (textarea) textarea.value = customText || '';
                        }
                    } else {
                        const option = document.querySelector(`[data-year="${year}"][data-achievement="${achievementId}"]`);
                        if (option) option.click();
                    }
                    
                    updateYearStatus(year);
                });
            }
            
            document.getElementById('otherAchievements').value = data.otherAchievements || '';
            
            // Tasks
            if (data.tasks) {
                data.tasks.forEach(task => {
                    const radio = document.querySelector(`input[name="task_${task.id}"][value="${task.status}"]`);
                    if (radio) {
                        radio.checked = true;
                        radio.dispatchEvent(new Event('change'));
                    }
                });
            }
            
            // Kiểm tra trùng lặp khi load dữ liệu cũ
            if (data.name && data.birthDate) {
                const duplicate = checkDuplicateTeacher(data.name, data.birthDate, currentTeacherCode);
                showDuplicateWarning(duplicate);
            }
        }

        function updateSummary() {
            // Personal info summary
            const name = document.getElementById('teacherName').value;
            const birthDate = document.getElementById('birthDate').value;
            const gender = document.getElementById('gender').value;
            const startYear = document.getElementById('startYear').value;
            
            const genderText = gender === 'nu' ? 'Nữ' : gender === 'nam' ? 'Nam' : 'Khác';
            const birthDateText = birthDate ? new Date(birthDate).toLocaleDateString('vi-VN') : '';
            const age = birthDate ? calculateAge(birthDate) : 0;
            const seniority = startYear ? calculateSeniority(startYear) : 0;
            
            document.getElementById('summaryPersonal').innerHTML = `
                <p><strong>Họ tên:</strong> ${name}</p>
                <p><strong>Ngày sinh:</strong> ${birthDateText} (${age} tuổi)</p>
                <p><strong>Giới tính:</strong> ${genderText}</p>
                <p><strong>Năm vào ngành:</strong> ${startYear} (${seniority} năm công tác)</p>
                <p><strong>Cam kết đạt chuẩn:</strong> Đã xác nhận</p>
            `;
            
            // Achievements summary
            const schoolYears = generateSchoolYears();
            let achievementsHtml = '';
            let yearsWithAchievements = 0;
            
            schoolYears.forEach(yearData => {
                const yearValue = yearData.value;
                const selectedAchievement = document.querySelector(`input[name="achievement_${yearValue}"]:checked`);
                
                if (selectedAchievement) {
                    let achievementText = '';
                    if (selectedAchievement.value === 'none') {
                        achievementText = 'Không có thành tích';
                    } else if (selectedAchievement.value === 'other') {
                        const customText = document.querySelector(`.custom-achievement-text[data-year="${yearValue}"]`)?.value.trim();
                        achievementText = `Thành tích đặc biệt: ${customText}`;
                        yearsWithAchievements++;
                    } else {
                        const achievement = achievementTypes.find(a => a.id === selectedAchievement.value);
                        achievementText = achievement ? achievement.name : selectedAchievement.value;
                        yearsWithAchievements++;
                    }
                    
                    achievementsHtml += `
                        <div class="summary-item">
                            <div class="summary-year">
                                <i class="fas fa-calendar-alt"></i> ${yearData.label}
                            </div>
                            <div class="summary-achievement">${achievementText}</div>
                        </div>
                    `;
                }
            });
            
            const otherAchievements = document.getElementById('otherAchievements').value.trim();
            if (otherAchievements) {
                achievementsHtml += `
                    <div class="summary-item">
                        <div class="summary-year">
                            <i class="fas fa-star"></i> Thành tích khác
                        </div>
                        <div class="summary-achievement">${otherAchievements}</div>
                    </div>
                `;
            }
            
            achievementsHtml = `
                <div style="background: #e8f4fc; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                    <strong>Tổng hợp:</strong> ${yearsWithAchievements}/9 năm có thành tích
                </div>
                ${achievementsHtml}
            `;
            
            document.getElementById('summaryAchievements').innerHTML = achievementsHtml;
            
            // Tasks summary
            let tasksHtml = '';
            let completedCount = 0;
            
            for (let i = 1; i <= 7; i++) {
                const taskRadio = document.querySelector(`input[name="task_${i}"]:checked`);
                if (taskRadio) {
                    const taskTitle = teacherTasks[i-1].title;
                    const status = taskRadio.value === 'done' ? 'Đã thực hiện' : 'Có khả năng thực hiện';
                    const statusIcon = taskRadio.value === 'done' ? 'fa-check-circle' : 'fa-lightbulb';
                    const statusColor = taskRadio.value === 'done' ? 'var(--success-color)' : 'var(--warning-color)';
                    
                    if (taskRadio.value === 'done') completedCount++;
                    
                    tasksHtml += `
                        <div class="summary-item">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas ${statusIcon}" style="color: ${statusColor};"></i>
                                <div>
                                    <strong>${i}. ${taskTitle}:</strong> ${status}
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            tasksHtml = `
                <div style="background: #e8f4fc; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                    <strong>Tổng hợp:</strong> ${completedCount}/7 nhiệm vụ đã thực hiện
                </div>
                ${tasksHtml}
            `;
            
            document.getElementById('summaryTasks').innerHTML = tasksHtml;
        }

        async function submitForm() {
            // Final validation
            const personalMissing = validatePersonalInfoWithDetails();
            const achievementsMissing = validateAchievementsWithDetails();
            const tasksMissing = validateTasksWithDetails();
            
            if (personalMissing.length > 0 || achievementsMissing.length > 0 || tasksMissing.length > 0) {
                showMessage('Vui lòng hoàn thành tất cả thông tin bắt buộc', 'error');
                return;
            }
            
            // Kiểm tra trùng lặp lần cuối
            const name = document.getElementById('teacherName').value;
            const birthDate = document.getElementById('birthDate').value;
            
            if (name && birthDate) {
                const duplicate = checkDuplicateTeacher(name, birthDate, currentTeacherCode);
                if (duplicate && !currentSubmission) {
                    showDuplicateWarning(duplicate);
                    showMessage('Giáo viên đã kê khai. Vui lòng liên hệ Quản lý để chỉnh sửa.', 'error');
                    return;
                }
            }
            
            showLoading(true);
            
            // Collect form data - THÊM THÔNG TIN MỚI
            const submissionData = {
                code: currentTeacherCode,
                name: document.getElementById('teacherName').value.trim(),
                birthDate: document.getElementById('birthDate').value,
                gender: document.getElementById('gender').value,
                startYear: document.getElementById('startYear').value,
                commitment: document.getElementById('standardCommitmentRadio').checked,
                yearAchievements: {},
                otherAchievements: document.getElementById('otherAchievements').value.trim(),
                tasks: [],
                status: 'locked',
                submittedAt: new Date().toISOString(),
                timestamp: Date.now()
            };
            
            // Collect achievements by year
            const schoolYears = generateSchoolYears();
            schoolYears.forEach(yearData => {
                const yearValue = yearData.value;
                const selectedAchievement = document.querySelector(`input[name="achievement_${yearValue}"]:checked`);
                
                if (selectedAchievement) {
                    const achievementData = {
                        id: selectedAchievement.value
                    };
                    
                    if (selectedAchievement.value === 'other') {
                        const customText = document.querySelector(`.custom-achievement-text[data-year="${yearValue}"]`)?.value.trim();
                        achievementData.customText = customText;
                    }
                    
                    submissionData.yearAchievements[yearValue] = achievementData;
                }
            });
            
            // Collect task data
            for (let i = 1; i <= 7; i++) {
                const taskRadio = document.querySelector(`input[name="task_${i}"]:checked`);
                if (taskRadio) {
                    const taskTitle = teacherTasks[i-1].title;
                    submissionData.tasks.push({
                        id: i,
                        title: taskTitle,
                        status: taskRadio.value
                    });
                }
            }
            
            try {
                // Save to Firebase
                await database.ref(`submissions/${currentTeacherCode}`).set(submissionData);
                
                // Update local
                currentSubmission = submissionData;
                isLocked = true;
                
                // Update all submissions
                allSubmissions[currentTeacherCode] = submissionData;
                
                // Clear localStorage
                localStorage.removeItem('currentTeacherCode');
                localStorage.removeItem('isEditing');
                
                showLoading(false);
                
                // Show success message
                showMessage('Hồ sơ đã được lưu và khóa thành công!', 'success', 5000);
                
                // Show lock message
                document.getElementById('formTabs').style.display = 'none';
                document.getElementById('lockMessage').style.display = 'block';
                document.getElementById('lockedTeacherCode').textContent = currentTeacherCode;
                
                document.getElementById('submissionStatus').innerHTML = `
                    <i class="fas fa-lock"></i>
                    <span>Đã khóa - Mã: ${currentTeacherCode}</span>
                `;
                
                // If admin is logged in, update admin data
                if (isAdmin) {
                    updateAdminStatistics();
                    updateTeacherListAdmin();
                    updateTeacherSelectForEdit();
                }
                
            } catch (error) {
                console.error('Lỗi khi lưu hồ sơ:', error);
                showMessage('Lỗi khi lưu hồ sơ. Vui lòng thử lại.', 'error');
                showLoading(false);
            }
        }

        // Hàm sắp xếp và hiển thị xếp hạng
        async function showPublicRanking() {
            showLoading(true);
            
            try {
                // Tải lại dữ liệu
                await loadAllSubmissions();
                
                const submissions = Object.values(allSubmissions).filter(s => s.status === 'locked');
                
                if (submissions.length === 0) {
                    showMessage('Chưa có dữ liệu kê khai nào để xếp hạng', 'info');
                    showLoading(false);
                    return;
                }
                
                // Tính điểm cho từng giáo viên
                const scoredTeachers = submissions.map(submission => {
                    // Tính điểm thành tích
                    const achievementScore = calculateAchievementScore(submission);
                    
                    // Tính số nhiệm vụ đã thực hiện
                    const completedTasks = submission.tasks ? 
                        submission.tasks.filter(t => t.status === 'done').length : 0;
                    
                    return {
                        ...submission,
                        achievementScore,
                        completedTasks,
                        yearAchievements: submission.yearAchievements || {}
                    };
                });
                
                // Danh sách 1: Xếp hạng theo thành tích
                const rankedByAchievements = [...scoredTeachers].sort((a, b) => {
                    return compareByAchievements(a, b);
                });
                
                // Danh sách 2: Xếp hạng theo nhiệm vụ
                const rankedByTasks = [...scoredTeachers].sort((a, b) => {
                    return compareByTasks(a, b);
                });
                
                // Hiển thị danh sách 1
                displayRankingList('rankingByAchievements', rankedByAchievements, 'achievements');
                
                // Hiển thị danh sách 2
                displayRankingList('rankingByTasks', rankedByTasks, 'tasks');
                
                // Hiển thị modal
                openModal('publicViewModal');
                showLoading(false);
                
            } catch (error) {
                console.error('Lỗi khi hiển thị xếp hạng:', error);
                showMessage('Lỗi khi tải dữ liệu xếp hạng', 'error');
                showLoading(false);
            }
        }

        // Tính điểm thành tích
        function calculateAchievementScore(submission) {
            if (!submission.yearAchievements) return [];
            
            const achievements = Object.values(submission.yearAchievements)
                .filter(a => a.id !== 'none' && a.id !== 'other')
                .map(a => ({
                    id: a.id,
                    level: achievementLevels[a.id] || 9
                }));
            
            // Sắp xếp theo level (thấp = cao nhất)
            achievements.sort((a, b) => a.level - b.level);
            
            return achievements;
        }

        // Hiển thị danh sách xếp hạng CHI TIẾT
        function displayRankingList(elementId, rankedList, type) {
            const container = document.getElementById(elementId);
            
            if (rankedList.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-info-circle"></i> Chưa có dữ liệu
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            rankedList.forEach((teacher, index) => {
                // Chuẩn bị thông tin
                const genderIcon = teacher.gender === 'nu' ? 
                    '<i class="fas fa-venus" style="color: #E91E63;"></i>' : 
                    teacher.gender === 'nam' ? 
                    '<i class="fas fa-mars" style="color: #2196F3;"></i>' : 
                    '<i class="fas fa-user" style="color: #9C27B0;"></i>';
                
                const age = calculateAge(teacher.birthDate);
                const seniority = calculateSeniority(teacher.startYear);
                
                if (type === 'achievements') {
                    // Hiển thị chi tiết thành tích theo năm
                    const achievementDetails = getAchievementDetailsByYear(teacher);
                    
                    html += `
                        <tr>
                            <td class="rank-number">${index + 1}</td>
                            <td>
                                <div class="teacher-rank-name">${teacher.name}</div>
                                <div class="teacher-rank-details">
                                    ${genderIcon} ${teacher.gender === 'nu' ? 'Nữ' : teacher.gender === 'nam' ? 'Nam' : 'Khác'} | 
                                    ${age} tuổi | CT: ${seniority} năm
                                </div>
                            </td>
                            <td class="achievement-details">
                                ${achievementDetails}
                            </td>
                            <td>
                                <div style="font-weight: 600; color: var(--dark-color);">
                                    ${teacher.achievementScore.length} thành tích
                                </div>
                                <div style="font-size: 0.85rem; color: var(--gray-color); margin-top: 5px;">
                                    ${getTopAchievementName(teacher.achievementScore)}
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    // Hiển thị cho danh sách nhiệm vụ
                    html += `
                        <tr>
                            <td class="rank-number">${index + 1}</td>
                            <td>
                                <div class="teacher-rank-name">${teacher.name}</div>
                                <div class="teacher-rank-details">
                                    ${genderIcon} ${teacher.gender === 'nu' ? 'Nữ' : teacher.gender === 'nam' ? 'Nam' : 'Khác'}
                                </div>
                            </td>
                            <td>
                                <div style="font-size: 0.9rem;">
                                    ${age} tuổi | CT: ${seniority} năm
                                </div>
                                <div class="achievement-badges">
                                    ${getAchievementBadges(teacher.achievementScore)}
                                </div>
                            </td>
                            <td class="task-count">
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--secondary-color);">
                                    ${teacher.completedTasks}/7
                                </div>
                            </td>
                        </tr>
                    `;
                }
            });
            
            container.innerHTML = html;
        }

        // Lấy chi tiết thành tích theo năm
        function getAchievementDetailsByYear(teacher) {
            if (!teacher.yearAchievements || Object.keys(teacher.yearAchievements).length === 0) {
                return '<div style="color: #666; font-style: italic;">Chưa có thành tích</div>';
            }
            
            const schoolYears = generateSchoolYears();
            let detailsHtml = '<div style="max-height: 200px; overflow-y: auto;">';
            
            schoolYears.forEach(yearData => {
                const yearValue = yearData.value;
                const achievement = teacher.yearAchievements[yearValue];
                
                if (achievement && achievement.id !== 'none') {
                    let achievementName = '';
                    let achievementClass = '';
                    
                    if (achievement.id === 'other') {
                        achievementName = achievement.customText || 'Thành tích khác';
                        achievementClass = 'low';
                    } else {
                        const achievementInfo = achievementTypes.find(a => a.id === achievement.id);
                        achievementName = achievementInfo ? achievementInfo.name : achievement.id;
                        
                        const level = achievementLevels[achievement.id] || 9;
                        if (level <= 5) achievementClass = 'high';
                        else if (level <= 7) achievementClass = 'medium';
                        else achievementClass = 'low';
                    }
                    
                    detailsHtml += `
                        <div class="achievement-year">
                            <span class="year-label">${yearData.shortLabel}:</span>
                            <span class="achievement-name ${achievementClass}">${achievementName}</span>
                        </div>
                    `;
                }
            });
            
            detailsHtml += '</div>';
            return detailsHtml;
        }

        // Lấy tên thành tích cao nhất
        function getTopAchievementName(achievementScore) {
            if (!achievementScore || achievementScore.length === 0) {
                return 'Không có thành tích';
            }
            
            const topAchievement = achievementScore[0];
            const achievementInfo = achievementTypes.find(a => a.id === topAchievement.id);
            return achievementInfo ? achievementInfo.name : 'Thành tích khác';
        }

        // Lấy badges thành tích
        function getAchievementBadges(achievementScore) {
            if (!achievementScore || achievementScore.length === 0) {
                return '<span class="achievement-badge">Không có</span>';
            }
            
            let badges = '';
            const top3 = achievementScore.slice(0, 3);
            
            top3.forEach((ach, index) => {
                let badgeClass = 'achievement-badge';
                if (ach.level <= 5) badgeClass += ' high';
                else if (ach.level <= 7) badgeClass += ' medium';
                
                badges += `<span class="${badgeClass}">${getAchievementLevelLabel(ach.level)}</span>`;
            });
            
            if (achievementScore.length > 3) {
                badges += `<span class="achievement-badge">+${achievementScore.length - 3}</span>`;
            }
            
            return badges;
        }

        // Lấy nhãn cấp độ thành tích
        function getAchievementLevelLabel(level) {
            if (level <= 2) return 'Cao nhất';
            if (level <= 5) return 'Cao';
            if (level <= 7) return 'Trung bình';
            return 'Cơ sở';
        }

        // Make functions available globally for event handlers
        window.deleteTeacher = deleteTeacher;
        window.revokeEditCode = revokeEditCode;
// ============================================
// XỬ LÝ NÚT XÁC NHẬN ĐẸP HƠN
// ============================================

document.addEventListener('DOMContentLoaded', function() {
    const finalConfirmation = document.getElementById('finalConfirmation');
    const confirmationLabel = finalConfirmation ? finalConfirmation.closest('label') : null;
    
    if (finalConfirmation && confirmationLabel) {
        // 1. Thêm sự kiện click cho toàn bộ label
        confirmationLabel.addEventListener('click', function(e) {
            // Chỉ xử lý nếu không click trực tiếp vào checkbox
            if (e.target !== finalConfirmation) {
                // Đảo trạng thái checkbox
                finalConfirmation.checked = !finalConfirmation.checked;
                
                // Tạo sự kiện change để JS cũ nhận biết
                const changeEvent = new Event('change');
                finalConfirmation.dispatchEvent(changeEvent);
                
                // Thông báo (tuỳ chọn)
                if (finalConfirmation.checked) {
                    console.log('✅ Đã xác nhận');
                } else {
                    console.log('⚠️ Đã hủy xác nhận');
                }
            }
        });
        
        // 2. Đổi màu khi checked/unchecked
        finalConfirmation.addEventListener('change', function() {
            const container = confirmationLabel.closest('div[style*="background"]');
            if (container) {
                if (this.checked) {
                    // Khi đã check: đổi sang màu xanh
                    container.style.background = 'linear-gradient(135deg, #e8f6ef, #d4efdf)';
                    container.style.borderColor = '#27ae60';
                    container.style.boxShadow = '0 5px 15px rgba(39, 174, 96, 0.2)';
                } else {
                    // Khi bỏ check: trở lại màu vàng
                    container.style.background = 'linear-gradient(135deg, #fff9e6, #fff3d1)';
                    container.style.borderColor = '#f39c12';
                    container.style.boxShadow = '0 5px 15px rgba(243, 156, 18, 0.1)';
                }
            }
        });
        
        // 3. Cập nhật giao diện ban đầu nếu checkbox đã checked
        if (finalConfirmation.checked) {
            const container = confirmationLabel.closest('div[style*="background"]');
            if (container) {
                container.style.background = 'linear-gradient(135deg, #e8f6ef, #d4efdf)';
                container.style.borderColor = '#27ae60';
                container.style.boxShadow = '0 5px 15px rgba(39, 174, 96, 0.2)';
            }
        }
    }
});
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <title>L·ªöP TO√ÅN TH·∫¶Y B√åNH - QU·∫¢N L√ù GI√ÅO VI√äN</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta name="description" content="H·ªá th·ªëng qu·∫£n l√Ω l·ªõp h·ªçc - L·ªõp To√°n Th·∫ßy B√¨nh">
    <meta name="keywords" content="qu·∫£n l√Ω l·ªõp h·ªçc, gi√°o vi√™n, h·ªçc sinh, k·∫øt qu·∫£, excel">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <!-- SheetJS (Excel Export) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        /* ===== CSS C∆† B·∫¢N ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        /* ===== TOPBAR ===== */
        .topbar {
            width: 100%;
            height: 80px;
            background: linear-gradient(135deg, #1a237e, #283593);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-bottom: 3px solid #3949ab;
        }

        .topbar-title {
            font-size: 1.6rem;
            font-weight: bold;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .topbar-title::before {
            content: "üë®‚Äçüè´";
            font-size: 1.8rem;
        }

        .topbar-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .topbar-controls button {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.15);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .topbar-controls button:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
        }

        .dashboard-card h2 {
            color: #1a237e;
            margin-bottom: 20px;
            border-bottom: 2px solid #1a237e;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            border: 1px solid #e0e0e0;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #1a237e;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* ===== TABLE STYLES ===== */
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 10px;
            border: 2px solid #f0f0f0;
            margin-top: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th, td {
            padding: 15px;
            border: 1px solid #e0e0e0;
            text-align: left;
            color: #333;
        }

        th {
            background: linear-gradient(135deg, #1a237e, #3949ab);
            color: white;
            position: sticky;
            top: 0;
            font-weight: 600;
            z-index: 10;
        }

        tr:nth-child(even) {
            background: #f8f9ff;
        }

        tr:hover {
            background: #e8eaff;
        }

        /* ===== BUTTON STYLES ===== */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1a237e, #3949ab);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #000;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* ===== MODAL STYLES ===== */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            animation: modalAppear 0.4s ease;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-lg {
            max-width: 900px;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-content h3 {
            color: #1a237e;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1a237e;
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        /* ===== NOTIFICATION ===== */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 100000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.4s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .notification.error {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .notification.warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #000;
        }

        .notification.info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }

        /* ===== FIREBASE STATUS ===== */
        .firebase-status {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            z-index: 10001;
            font-weight: 600;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .firebase-connected {
            background: rgba(40, 167, 69, 0.9);
            color: white;
        }

        .firebase-disconnected {
            background: rgba(220, 53, 69, 0.9);
            color: white;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .topbar {
                flex-direction: column;
                height: auto;
                padding: 15px;
                gap: 15px;
            }
            
            .topbar-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 20px;
                width: 95%;
            }
        }

        /* ===== LOADING SPINNER ===== */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1a237e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== DETAIL RESULTS ===== */
        .results-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-top: 25px;
        }

        .student-info {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #1a237e;
        }

        .answer-details {
            margin-top: 15px;
        }

        .answer-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            background: #f8f9fa;
        }

        .answer-item.correct {
            border-left: 4px solid #28a745;
            background: #d4edda;
        }

        .answer-item.incorrect {
            border-left: 4px solid #dc3545;
            background: #f8d7da;
        }

        .answer-item.partial {
            border-left: 4px solid #ffc107;
            background: #fff3cd;
        }

        .question-detail {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }

        .time-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .test-name {
            font-weight: bold;
            color: #1a237e;
            background: #e8eaff;
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* ===== SEARCH AND FILTER ===== */
        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-filter input,
        .search-filter select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            min-width: 200px;
        }

        .search-filter input:focus,
        .search-filter select:focus {
            outline: none;
            border-color: #1a237e;
        }
    </style>
</head>
<body>
    <!-- Firebase Status Indicator -->
    <div id="firebaseStatus" class="firebase-status firebase-disconnected">
        <span class="loading-spinner"></span> ƒêang k·∫øt n·ªëi...
    </div>

    <!-- Notification System -->
    <div id="notification" class="notification"></div>

    <!-- Top Bar -->
    <div class="topbar">
        <div class="topbar-title">L·ªöP TO√ÅN TH·∫¶Y B√åNH - QU·∫¢N L√ù GI√ÅO VI√äN</div>
        <div class="topbar-controls">
            <button id="loginBtn" class="btn btn-primary">üîë ƒêƒÉng nh·∫≠p</button>
            <button id="refreshBtn" class="btn btn-info">üîÑ L√†m m·ªõi</button>
            <button id="exportAllBtn" class="btn btn-success">üìä Xu·∫•t Excel</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Th·ªëng k√™ t·ªïng quan -->
        <div class="dashboard-card">
            <h2>üìä Th·ªëng k√™ t·ªïng quan</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalClasses">0</div>
                    <div class="stat-label">L·ªõp h·ªçc</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalStudents">0</div>
                    <div class="stat-label">H·ªçc sinh</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalAttempts">0</div>
                    <div class="stat-label">B√†i l√†m</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgScore">0.0</div>
                    <div class="stat-label">ƒêi·ªÉm TB</div>
                </div>
            </div>
        </div>

        <!-- Qu·∫£n l√Ω l·ªõp h·ªçc -->
        <div class="dashboard-card">
            <h2>üè´ Qu·∫£n l√Ω l·ªõp h·ªçc</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button id="createClassBtn" class="btn btn-success">‚ûï T·∫°o l·ªõp m·ªõi</button>
                <button id="manageClassesBtn" class="btn btn-primary">üìö Qu·∫£n l√Ω l·ªõp</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>T√™n l·ªõp</th>
                            <th>M√£ l·ªõp</th>
                            <th>S·ªë HS</th>
                            <th>Ng√†y t·∫°o</th>
                        </tr>
                    </thead>
                    <tbody id="classesTableBody">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px; color: #666;">
                                ƒêang t·∫£i danh s√°ch l·ªõp...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Qu·∫£n l√Ω h·ªçc sinh -->
        <div class="dashboard-card">
            <h2>üë• Qu·∫£n l√Ω h·ªçc sinh</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button id="assignStudentBtn" class="btn btn-success">üéì C·∫•p m√£ HS</button>
                <button id="viewStudentCodesBtn" class="btn btn-info">üìã DS M√£ HS</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>M√£ HS</th>
                            <th>H·ªç t√™n</th>
                            <th>L·ªõp</th>
                            <th>Tr·∫°ng th√°i</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px; color: #666;">
                                ƒêang t·∫£i danh s√°ch h·ªçc sinh...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- K·∫øt qu·∫£ b√†i l√†m -->
        <div class="dashboard-card">
            <h2>üìù K·∫øt qu·∫£ b√†i l√†m</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button id="viewResultsBtn" class="btn btn-primary">üìä Xem k·∫øt qu·∫£</button>
                <button id="exportResultsBtn" class="btn btn-success">üì§ Xu·∫•t Excel</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>H·ªçc sinh</th>
                            <th>ƒê·ªÅ thi</th>
                            <th>ƒêi·ªÉm</th>
                            <th>Th·ªùi gian</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px; color: #666;">
                                ƒêang t·∫£i k·∫øt qu·∫£...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Chi ti·∫øt k·∫øt qu·∫£ h·ªçc sinh -->
    <div class="results-container" id="studentResultsDetail" style="display: none;">
        <h2>üìã Chi ti·∫øt k·∫øt qu·∫£ h·ªçc sinh</h2>
        <div class="student-info" id="studentInfo"></div>
        <div class="answer-details" id="answerDetails"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button id="closeDetailsBtn" class="btn btn-primary">ƒê√≥ng</button>
            <button id="exportStudentResultsBtn" class="btn btn-success">üì§ Xu·∫•t Excel</button>
        </div>
    </div>

    <!-- MODALS -->
    <!-- Login Modal -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <button class="modal-close" id="close-login-modal">√ó</button>
            <h3>üîê ƒêƒÉng nh·∫≠p gi√°o vi√™n</h3>
            <form id="teacher-login-form">
                <div class="form-group">
                    <label for="teacher-code">M√£ gi√°o vi√™n:</label>
                    <input type="text" id="teacher-code" placeholder="Nh·∫≠p m√£ gi√°o vi√™n" required>
                </div>
                <div class="form-group">
                    <label for="teacher-name">H·ªç t√™n:</label>
                    <input type="text" id="teacher-name" placeholder="Nh·∫≠p h·ªç t√™n" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üöÄ ƒêƒÉng nh·∫≠p</button>
                    <button type="button" class="btn btn-danger" id="cancel-login">H·ªßy</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Class Modal -->
    <div class="modal" id="create-class-modal">
        <div class="modal-content">
            <button class="modal-close" id="close-create-class-modal">√ó</button>
            <h3>üè´ T·∫°o l·ªõp m·ªõi</h3>
            <form id="create-class-form">
                <div class="form-group">
                    <label for="class-name">T√™n l·ªõp:</label>
                    <input type="text" id="class-name" placeholder="V√≠ d·ª•: 12A1, To√°n N√¢ng cao..." required>
                </div>
                <div class="form-group">
                    <label for="class-description">M√¥ t·∫£:</label>
                    <textarea id="class-description" placeholder="M√¥ t·∫£ v·ªÅ l·ªõp h·ªçc..." rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">üè´ T·∫°o L·ªõp</button>
                    <button type="button" class="btn btn-danger" id="cancel-create-class">H·ªßy</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assign Student Modal -->
    <div class="modal" id="assign-student-modal">
        <div class="modal-content">
            <button class="modal-close" id="close-assign-student-modal">√ó</button>
            <h3>üéì C·∫•p m√£ h·ªçc sinh</h3>
            <form id="assign-student-form">
                <div class="form-group">
                    <label for="select-class-for-student">Ch·ªçn l·ªõp:</label>
                    <select id="select-class-for-student" required>
                        <option value="">-- Ch·ªçn l·ªõp --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="student-fullname">H·ªç t√™n h·ªçc sinh:</label>
                    <input type="text" id="student-fullname" placeholder="Nh·∫≠p h·ªç t√™n h·ªçc sinh" required>
                </div>
                <div class="form-group">
                    <label for="student-email">Email (tu·ª≥ ch·ªçn):</label>
                    <input type="email" id="student-email" placeholder="Nh·∫≠p email h·ªçc sinh">
                </div>
                <div class="form-group">
                    <label>M√£ h·ªçc sinh s·∫Ω ƒë∆∞·ª£c t·∫°o:</label>
                    <div id="generated-student-code" style="font-family: monospace; font-size: 1.2em; font-weight: bold; color: #1a237e; background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
                        HS_XXXXXX
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" id="generate-student-code-btn" class="btn btn-info">üé≤ T·∫°o M√£</button>
                    <button type="submit" class="btn btn-success">‚úÖ C·∫•p M√£</button>
                    <button type="button" class="btn btn-danger" id="cancel-assign-student">H·ªßy</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Student Codes Modal -->
    <div class="modal" id="student-codes-modal">
        <div class="modal-content modal-lg">
            <button class="modal-close" id="close-student-codes-modal">√ó</button>
            <h3>üìã Danh s√°ch m√£ h·ªçc sinh</h3>
            <div class="search-filter">
                <select id="filter-class-codes">
                    <option value="all">T·∫•t c·∫£ l·ªõp</option>
                </select>
                <input type="text" id="search-student-codes" placeholder="üîç T√¨m h·ªçc sinh...">
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>M√£ HS</th>
                            <th>H·ªç t√™n</th>
                            <th>L·ªõp</th>
                            <th>Ng√†y c·∫•p</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="student-codes-list">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 30px; color: #666;">
                                ƒêang t·∫£i danh s√°ch m√£ h·ªçc sinh...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="export-codes-btn" class="btn btn-success">üì§ Xu·∫•t Excel</button>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div class="modal" id="results-modal">
        <div class="modal-content modal-lg">
            <button class="modal-close" id="close-results-modal">√ó</button>
            <h3>üìä K·∫øt qu·∫£ b√†i l√†m chi ti·∫øt</h3>
            <div class="search-filter">
                <input type="text" id="search-student-results" placeholder="üîç T√¨m h·ªçc sinh...">
                <select id="filter-class-results">
                    <option value="all">T·∫•t c·∫£ l·ªõp</option>
                </select>
                <select id="filter-test-results">
                    <option value="all">T·∫•t c·∫£ ƒë·ªÅ</option>
                </select>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>H·ªçc sinh</th>
                            <th>L·ªõp</th>
                            <th>ƒê·ªÅ thi</th>
                            <th>ƒêi·ªÉm</th>
                            <th>Th·ªùi gian</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="detailed-results-list">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 30px; color: #666;">
                                ƒêang t·∫£i k·∫øt qu·∫£ chi ti·∫øt...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="export-detailed-results-btn" class="btn btn-success">üì§ Xu·∫•t Excel</button>
            </div>
        </div>
    </div>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyDVRsgVDCKk5lIfCRxhSlWiBetNlZBukcc",
            authDomain: "daytoantructuyen-149d9.firebaseapp.com",
            databaseURL: "https://daytoantructuyen-149d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "daytoantructuyen-149d9",
            storageBucket: "daytoantructuyen-149d9.firebasestorage.app",
            messagingSenderId: "258454714393",
            appId: "1:258454714393:web:bcf66624668e516934d288"
        };

        // ===== GLOBAL VARIABLES =====
        let db = null;
        let auth = null;
        let isTeacherLoggedIn = false;
        let currentUser = null;

        // ===== TEST NAME MAPPING =====
        const testNames = {
            'gk1de1.html': 'ƒê·ªÅ 1: Gi·ªØa HK1',
            'gk1de2.html': 'ƒê·ªÅ 2: Gi·ªØa HK1',
            'gk2de1.html': 'ƒê·ªÅ 1: Gi·ªØa HK2',
            'hk1de1.html': 'ƒê·ªÅ 1: HK1',
            'hk2de1.html': 'ƒê·ªÅ 1: HK2'
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            if (initializeFirebase()) {
                setupAuthentication();
                setupEventListeners();
                setupModalSystem();
                showNotification('H·ªá th·ªëng ƒë√£ s·∫µn s√†ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.', 'info');
            } else {
                showNotification('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn c∆° s·ªü d·ªØ li·ªáu.', 'error');
            }
        });

        function initializeFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                auth = firebase.auth();
                console.log("‚úÖ Firebase initialized successfully");
                
                db.ref('.info/connected').on('value', snap => {
                    const statusElement = document.getElementById('firebaseStatus');
                    if (snap.val() === true) {
                        statusElement.innerHTML = "‚úÖ Firebase: ƒê√£ k·∫øt n·ªëi";
                        statusElement.className = "firebase-status firebase-connected";
                    } else {
                        statusElement.innerHTML = '<span class="loading-spinner"></span> Firebase: ƒêang k·∫øt n·ªëi...';
                        statusElement.className = "firebase-status firebase-disconnected";
                    }
                });
                return true;
            } catch (error) {
                console.error("‚ùå Firebase initialization failed:", error);
                showNotification('L·ªói kh·ªüi t·∫°o Firebase: ' + error.message, 'error');
                return false;
            }
        }

        // ===== AUTHENTICATION =====
        function setupAuthentication() {
            document.getElementById('teacher-login-form').addEventListener('submit', async e => {
                e.preventDefault();
                const code = document.getElementById('teacher-code').value.trim();
                const name = document.getElementById('teacher-name').value.trim();
                
                if (!code || !name) {
                    showNotification('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
                    return;
                }

                if (code === 'admin79') {
                    await loginAsTeacher(name);
                } else {
                    showNotification('M√£ gi√°o vi√™n kh√¥ng h·ª£p l·ªá!', 'error');
                }
            });

            document.getElementById('loginBtn').addEventListener('click', () => {
                showModal('login-modal');
            });

            document.getElementById('cancel-login').addEventListener('click', () => {
                hideModal('login-modal');
            });

            document.getElementById('close-login-modal').addEventListener('click', () => {
                hideModal('login-modal');
            });
        }

        async function loginAsTeacher(name) {
            try {
                isTeacherLoggedIn = true;
                currentUser = { uid: 'teacher_admin_79', name, role: 'teacher', code: 'admin79' };
                
                await db.ref('users/' + currentUser.uid).set({ 
                    name, 
                    role: 'teacher', 
                    lastLogin: firebase.database.ServerValue.TIMESTAMP 
                });
                
                showNotification(`‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng - GV: ${name}`, 'success');
                hideModal('login-modal');
                updateUIAfterLogin();
                loadAllData();
                
            } catch (error) {
                console.error('Teacher login error:', error);
                showNotification('L·ªói ƒëƒÉng nh·∫≠p: ' + error.message, 'error');
            }
        }

        function updateUIAfterLogin() {
            document.getElementById('loginBtn').innerHTML = 'üë®‚Äçüè´ ' + currentUser.name;
            document.getElementById('loginBtn').style.background = '#28a745';
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', loadAllData);
            
            // Class management
            document.getElementById('createClassBtn').addEventListener('click', () => {
                if (!checkLogin()) return;
                showModal('create-class-modal');
            });
            
            document.getElementById('manageClassesBtn').addEventListener('click', () => {
                if (!checkLogin()) return;
                loadClassesList();
            });
            
            // Student management
            document.getElementById('assignStudentBtn').addEventListener('click', () => {
                if (!checkLogin()) return;
                showModal('assign-student-modal');
                loadClassesForAssignment();
                generateStudentCode();
            });
            
            document.getElementById('viewStudentCodesBtn').addEventListener('click', () => {
                if (!checkLogin()) return;
                showModal('student-codes-modal');
                loadStudentCodesList();
            });
            
            // Results management
            document.getElementById('viewResultsBtn').addEventListener('click', () => {
                if (!checkLogin()) return;
                showModal('results-modal');
                loadDetailedResults();
            });
            
            document.getElementById('exportResultsBtn').addEventListener('click', () => {
                if (!checkLogin()) return;
                exportResultsToExcel();
            });
            
            document.getElementById('exportAllBtn').addEventListener('click', () => {
                if (!checkLogin()) return;
                exportAllDataToExcel();
            });
            
            // Form submissions
            document.getElementById('create-class-form').addEventListener('submit', createNewClass);
            document.getElementById('assign-student-form').addEventListener('submit', assignStudentCode);
            
            // Generate student code
            document.getElementById('generate-student-code-btn').addEventListener('click', generateStudentCode);
            
            // Export buttons
            document.getElementById('export-codes-btn').addEventListener('click', exportStudentCodesToExcel);
            document.getElementById('export-detailed-results-btn').addEventListener('click', exportDetailedResultsToExcel);
            document.getElementById('exportStudentResultsBtn').addEventListener('click', exportStudentDetailToExcel);
            
            // Close buttons
            document.getElementById('close-create-class-modal').addEventListener('click', () => hideModal('create-class-modal'));
            document.getElementById('close-assign-student-modal').addEventListener('click', () => hideModal('assign-student-modal'));
            document.getElementById('close-student-codes-modal').addEventListener('click', () => hideModal('student-codes-modal'));
            document.getElementById('close-results-modal').addEventListener('click', () => hideModal('results-modal'));
            document.getElementById('cancel-create-class').addEventListener('click', () => hideModal('create-class-modal'));
            document.getElementById('cancel-assign-student').addEventListener('click', () => hideModal('assign-student-modal'));
            document.getElementById('closeDetailsBtn').addEventListener('click', () => {
                document.getElementById('studentResultsDetail').style.display = 'none';
            });
            
            // Search and filter
            document.getElementById('search-student-results').addEventListener('input', loadDetailedResults);
            document.getElementById('filter-class-results').addEventListener('change', loadDetailedResults);
            document.getElementById('filter-test-results').addEventListener('change', loadDetailedResults);
            document.getElementById('filter-class-codes').addEventListener('change', loadStudentCodesList);
            document.getElementById('search-student-codes').addEventListener('input', loadStudentCodesList);
        }

        function checkLogin() {
            if (!isTeacherLoggedIn) {
                showNotification('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!', 'error');
                return false;
            }
            return true;
        }

        // ===== MODAL SYSTEM =====
        function setupModalSystem() {
            // Close modals when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        hideModal(this.id);
                    }
                });
            });
            
            // ESC key to close modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        hideModal(modal.id);
                    });
                }
            });
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ===== DATA LOADING =====
        function loadAllData() {
            if (!checkLogin()) return;
            
            loadStatistics();
            loadClassesList();
            loadStudentsList();
            loadResultsList();
        }

        async function loadStatistics() {
            try {
                // Load classes
                const classesSnapshot = await db.ref('classes').once('value');
                const classesData = classesSnapshot.val() || {};
                
                // Filter classes for current teacher
                const teacherClasses = {};
                Object.entries(classesData).forEach(([classCode, classData]) => {
                    if (classData.teacherId === currentUser.uid) {
                        teacherClasses[classCode] = classData;
                    }
                });
                
                // Load student codes
                const codesSnapshot = await db.ref('studentCodes').once('value');
                const codesData = codesSnapshot.val() || {};
                
                // Filter student codes for current teacher
                const teacherStudents = {};
                Object.entries(codesData).forEach(([code, studentData]) => {
                    if (studentData.teacherId === currentUser.uid) {
                        teacherStudents[code] = studentData;
                    }
                });
                
                // Load results from attempts
                const attemptsSnapshot = await db.ref('attempts').once('value');
                const attemptsData = attemptsSnapshot.val() || {};
                
                // Filter results for current teacher's students
                let totalScore = 0;
                let resultCount = 0;
                
                Object.values(attemptsData).forEach(sessionData => {
                    Object.values(sessionData).forEach(attempt => {
                        if (teacherStudents[attempt.code]) {
                            totalScore += parseFloat(attempt.score) || 0;
                            resultCount++;
                        }
                    });
                });
                
                // Update statistics
                document.getElementById('totalClasses').textContent = Object.keys(teacherClasses).length;
                document.getElementById('totalStudents').textContent = Object.keys(teacherStudents).length;
                document.getElementById('totalAttempts').textContent = resultCount;
                document.getElementById('avgScore').textContent = resultCount > 0 ? (totalScore / resultCount).toFixed(2) : '0.00';
                
            } catch (error) {
                console.error('Error loading statistics:', error);
                showNotification('L·ªói khi t·∫£i th·ªëng k√™!', 'error');
            }
        }

        async function loadClassesList() {
            try {
                const snapshot = await db.ref('classes').once('value');
                const classesData = snapshot.val() || {};
                
                const tbody = document.getElementById('classesTableBody');
                let html = '';
                
                Object.entries(classesData).forEach(([classCode, classData]) => {
                    if (classData.teacherId !== currentUser.uid) return;
                    
                    const createDate = classData.createdAt ? 
                        new Date(classData.createdAt).toLocaleDateString('vi-VN') : 'N/A';
                    
                    html += `
                        <tr>
                            <td>${classData.name}</td>
                            <td><code>${classCode}</code></td>
                            <td>${classData.studentCount || 0}</td>
                            <td>${createDate}</td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html || `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px; color: #666;">
                            Ch∆∞a c√≥ l·ªõp h·ªçc n√†o.
                        </td>
                    </tr>
                `;
                
            } catch (error) {
                console.error('Error loading classes:', error);
                document.getElementById('classesTableBody').innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px; color: #dc3545;">
                            ‚ùå L·ªói khi t·∫£i danh s√°ch l·ªõp
                        </td>
                    </tr>
                `;
            }
        }

        async function loadStudentsList() {
            try {
                const snapshot = await db.ref('studentCodes').once('value');
                const studentsData = snapshot.val() || {};
                
                const tbody = document.getElementById('studentsTableBody');
                let html = '';
                
                Object.entries(studentsData).forEach(([code, studentData]) => {
                    if (studentData.teacherId !== currentUser.uid) return;
                    
                    const status = studentData.status === 'active' ? 
                        '<span style="color: #28a745;">üü¢ Ho·∫°t ƒë·ªông</span>' : 
                        '<span style="color: #dc3545;">üî¥ ƒê√£ kh√≥a</span>';
                    
                    html += `
                        <tr>
                            <td><strong>${code}</strong></td>
                            <td>${studentData.name}</td>
                            <td>${studentData.classCode || 'Ch∆∞a c√≥ l·ªõp'}</td>
                            <td>${status}</td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html || `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px; color: #666;">
                            Ch∆∞a c√≥ h·ªçc sinh n√†o.
                        </td>
                    </tr>
                `;
                
            } catch (error) {
                console.error('Error loading students:', error);
                document.getElementById('studentsTableBody').innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px; color: #dc3545;">
                            ‚ùå L·ªói khi t·∫£i danh s√°ch h·ªçc sinh
                        </td>
                    </tr>
                `;
            }
        }

        async function loadResultsList() {
            try {
                // Load results from attempts
                const attemptsSnapshot = await db.ref('attempts').once('value');
                const attemptsData = attemptsSnapshot.val() || {};
                
                // Get student codes for this teacher
                const codesSnapshot = await db.ref('studentCodes').once('value');
                const codesData = codesSnapshot.val() || {};
                
                const teacherStudentCodes = new Set();
                Object.entries(codesData).forEach(([code, studentData]) => {
                    if (studentData.teacherId === currentUser.uid) {
                        teacherStudentCodes.add(code);
                    }
                });
                
                const tbody = document.getElementById('resultsTableBody');
                let html = '';
                
                // Collect all results
                let allResults = [];
                
                Object.values(attemptsData).forEach(sessionData => {
                    Object.values(sessionData).forEach(attempt => {
                        if (teacherStudentCodes.has(attempt.code)) {
                            allResults.push(attempt);
                        }
                    });
                });
                
                // Sort by timestamp (newest first)
                allResults.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                
                // Display latest 10 results
                allResults.slice(0, 10).forEach(attempt => {
                    const timestamp = attempt.createdAt ? 
                        new Date(attempt.createdAt).toLocaleDateString('vi-VN') : 'N/A';
                    
                    const testName = getTestDisplayName(attempt.testId);
                    
                    html += `
                        <tr>
                            <td>${attempt.name} (${attempt.code})</td>
                            <td><span class="test-name">${testName}</span></td>
                            <td style="font-weight: bold; color: ${getScoreColor(attempt.score)}">
                                ${parseFloat(attempt.score).toFixed(2)}
                            </td>
                            <td>${timestamp}</td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html || `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px; color: #666;">
                            Ch∆∞a c√≥ k·∫øt qu·∫£ n√†o.
                        </td>
                    </tr>
                `;
                
            } catch (error) {
                console.error('Error loading results:', error);
                document.getElementById('resultsTableBody').innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px; color: #dc3545;">
                            ‚ùå L·ªói khi t·∫£i k·∫øt qu·∫£
                        </td>
                    </tr>
                `;
            }
        }

        // ===== TEST NAME MANAGEMENT =====
        function getTestDisplayName(testId) {
            if (!testId) return 'Kh√¥ng x√°c ƒë·ªãnh';
            
            // Check if testId is a full URL and extract filename
            let filename = testId;
            if (testId.includes('/')) {
                filename = testId.split('/').pop();
            }
            
            // Return mapped name or original filename
            return testNames[filename] || filename;
        }

        function getTestFileName(testId) {
            if (!testId) return 'unknown';
            
            // Extract filename from URL if needed
            let filename = testId;
            if (testId.includes('/')) {
                filename = testId.split('/').pop();
            }
            
            return filename;
        }

        // ===== CLASS MANAGEMENT =====
        async function createNewClass(e) {
            e.preventDefault();
            
            const className = document.getElementById('class-name').value.trim();
            const classDescription = document.getElementById('class-description').value.trim();

            if (!className) {
                showNotification('Vui l√≤ng nh·∫≠p t√™n l·ªõp!', 'error');
                return;
            }

            try {
                const classCode = generateClassCode();
                const classData = {
                    name: className,
                    description: classDescription,
                    code: classCode,
                    teacher: currentUser.name,
                    teacherId: currentUser.uid,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    studentCount: 0,
                    status: 'active'
                };

                await db.ref(`classes/${classCode}`).set(classData);
                
                hideModal('create-class-modal');
                document.getElementById('create-class-form').reset();
                
                showNotification(`‚úÖ ƒê√£ t·∫°o l·ªõp "${className}" v·ªõi m√£: ${classCode}`, 'success');
                loadAllData();
                
            } catch (error) {
                console.error('Error creating class:', error);
                showNotification('‚ùå L·ªói khi t·∫°o l·ªõp!', 'error');
            }
        }

        function generateClassCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars[Math.floor(Math.random() * chars.length)];
            }
            return code;
        }

        // ===== STUDENT MANAGEMENT =====
        async function loadClassesForAssignment() {
            try {
                const snapshot = await db.ref('classes').once('value');
                const classesData = snapshot.val() || {};
                const select = document.getElementById('select-class-for-student');
                
                let options = '<option value="">-- Ch·ªçn l·ªõp --</option>';
                
                Object.entries(classesData).forEach(([classCode, classData]) => {
                    if (classData.teacherId === currentUser.uid) {
                        options += `<option value="${classCode}">${classData.name} (${classCode})</option>`;
                    }
                });
                
                select.innerHTML = options;
                
            } catch (error) {
                console.error('Error loading classes for assignment:', error);
            }
        }

        function generateStudentCode() {
            const prefix = 'HS';
            const randomNum = Math.floor(100000 + Math.random() * 900000);
            const studentCode = `${prefix}${randomNum}`;
            
            document.getElementById('generated-student-code').textContent = studentCode;
            return studentCode;
        }

        async function assignStudentCode(e) {
            e.preventDefault();
            
            const classCode = document.getElementById('select-class-for-student').value;
            const studentName = document.getElementById('student-fullname').value.trim();
            const studentCode = document.getElementById('generated-student-code').textContent;

            if (!classCode) {
                showNotification('Vui l√≤ng ch·ªçn l·ªõp!', 'error');
                return;
            }

            if (!studentName) {
                showNotification('Vui l√≤ng nh·∫≠p h·ªç t√™n h·ªçc sinh!', 'error');
                return;
            }

            try {
                const classSnapshot = await db.ref(`classes/${classCode}`).once('value');
                const classData = classSnapshot.val();
                
                if (!classData) {
                    showNotification('L·ªõp h·ªçc kh√¥ng t·ªìn t·∫°i!', 'error');
                    return;
                }

                const studentCodeData = {
                    code: studentCode,
                    name: studentName,
                    classCode: classCode,
                    className: classData.name,
                    teacherId: currentUser.uid,
                    teacherName: currentUser.name,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    status: 'active'
                };

                await db.ref(`studentCodes/${studentCode}`).set(studentCodeData);

                // Update student count in class
                await updateStudentCountInClass(classCode);

                showNotification(`‚úÖ ƒê√£ c·∫•p m√£ ${studentCode} cho ${studentName}`, 'success');
                hideModal('assign-student-modal');
                document.getElementById('assign-student-form').reset();
                loadAllData();
                
            } catch (error) {
                console.error('Error assigning student code:', error);
                showNotification('‚ùå L·ªói khi c·∫•p m√£ h·ªçc sinh!', 'error');
            }
        }

        async function updateStudentCountInClass(classCode) {
            try {
                // Count students in this class
                const snapshot = await db.ref('studentCodes').orderByChild('classCode').equalTo(classCode).once('value');
                const students = snapshot.val() || {};
                const studentCount = Object.keys(students).length;
                
                // Update count
                await db.ref(`classes/${classCode}/studentCount`).set(studentCount);
            } catch (error) {
                console.error('Error updating student count:', error);
            }
        }

        async function loadStudentCodesList() {
            try {
                const snapshot = await db.ref('studentCodes').once('value');
                const studentCodesData = snapshot.val() || {};
                const filterClass = document.getElementById('filter-class-codes').value;
                const searchTerm = document.getElementById('search-student-codes').value.toLowerCase();
                
                const tbody = document.getElementById('student-codes-list');
                let html = '';
                
                Object.entries(studentCodesData).forEach(([code, data]) => {
                    if (data.teacherId !== currentUser.uid) return;
                    if (filterClass !== 'all' && data.classCode !== filterClass) return;
                    if (searchTerm && !data.name.toLowerCase().includes(searchTerm) && !code.toLowerCase().includes(searchTerm)) return;
                    
                    const createDate = data.createdAt ? 
                        new Date(data.createdAt).toLocaleDateString('vi-VN') : 'N/A';
                    
                    const status = data.status === 'active' ? 
                        '<span style="color: #28a745;">üü¢ Ho·∫°t ƒë·ªông</span>' : 
                        '<span style="color: #dc3545;">üî¥ ƒê√£ kh√≥a</span>';
                    
                    html += `
                        <tr>
                            <td><strong>${code}</strong></td>
                            <td>${data.name}</td>
                            <td>${data.classCode}</td>
                            <td>${createDate}</td>
                            <td>${status}</td>
                            <td>
                                <button onclick="revokeStudentCode('${code}')" class="btn btn-danger btn-sm">
                                    üîí Kh√≥a
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html || `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px; color: #666;">
                            Kh√¥ng t√¨m th·∫•y m√£ h·ªçc sinh n√†o.
                        </td>
                    </tr>
                `;
                
                // Update class filter options
                updateClassFilterOptions('filter-class-codes');
                
            } catch (error) {
                console.error('Error loading student codes:', error);
            }
        }

        async function revokeStudentCode(codeId) {
            try {
                await db.ref(`studentCodes/${codeId}/status`).set('revoked');
                showNotification(`‚úÖ ƒê√£ thu h·ªìi m√£ ${codeId}!`, 'success');
                loadStudentCodesList();
                loadAllData();
            } catch (error) {
                console.error('Error revoking student code:', error);
                showNotification('‚ùå L·ªói khi thu h·ªìi m√£!', 'error');
            }
        }

        // ===== RESULTS MANAGEMENT =====
        async function loadDetailedResults() {
            try {
                // Load results from attempts
                const attemptsSnapshot = await db.ref('attempts').once('value');
                const attemptsData = attemptsSnapshot.val() || {};
                
                // Get search and filter values
                const searchTerm = document.getElementById('search-student-results').value.toLowerCase();
                const filterClass = document.getElementById('filter-class-results').value;
                const filterTest = document.getElementById('filter-test-results').value;
                
                // Get student codes for this teacher
                const codesSnapshot = await db.ref('studentCodes').once('value');
                const codesData = codesSnapshot.val() || {};
                
                const teacherStudents = {};
                Object.entries(codesData).forEach(([code, studentData]) => {
                    if (studentData.teacherId === currentUser.uid) {
                        teacherStudents[code] = studentData;
                    }
                });
                
                const tbody = document.getElementById('detailed-results-list');
                let html = '';
                let testSet = new Set();
                
                // Collect all results
                let allResults = [];
                
                Object.values(attemptsData).forEach(sessionData => {
                    Object.values(sessionData).forEach(attempt => {
                        if (!teacherStudents[attempt.code]) return;
                        
                        const student = teacherStudents[attempt.code];
                        const testFile = getTestFileName(attempt.testId);
                        
                        // Apply filters
                        if (searchTerm && 
                            !student.name.toLowerCase().includes(searchTerm) && 
                            !attempt.code.toLowerCase().includes(searchTerm)) {
                            return;
                        }
                        
                        if (filterClass !== 'all' && student.classCode !== filterClass) {
                            return;
                        }
                        
                        if (filterTest !== 'all' && testFile !== filterTest) {
                            return;
                        }
                        
                        // Add test to set for filter
                        testSet.add(testFile);
                        
                        allResults.push({
                            ...attempt,
                            student: student,
                            testFile: testFile
                        });
                    });
                });
                
                // Sort by timestamp (newest first)
                allResults.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                
                // Display results
                allResults.forEach(attempt => {
                    const timestamp = attempt.createdAt ? 
                        new Date(attempt.createdAt).toLocaleString('vi-VN') : 'N/A';
                    
                    const testName = getTestDisplayName(attempt.testId);
                    
                    html += `
                        <tr>
                            <td>${attempt.student.name} (${attempt.code})</td>
                            <td>${attempt.student.classCode || 'N/A'}</td>
                            <td><span class="test-name">${testName}</span></td>
                            <td style="font-weight: bold; color: ${getScoreColor(attempt.score)}">
                                ${parseFloat(attempt.score).toFixed(2)}
                            </td>
                            <td>${timestamp}</td>
                            <td>
                                <button onclick="viewStudentResultDetail('${attempt.code}', '${attempt.testId}', ${attempt.createdAt})" class="btn btn-info btn-sm">
                                    üëÅÔ∏è Xem
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html || `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px; color: #666;">
                            Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o.
                        </td>
                    </tr>
                `;
                
                // Update filter options
                updateClassFilterOptions('filter-class-results');
                updateTestFilterOptions(testSet);
                
            } catch (error) {
                console.error('Error loading detailed results:', error);
            }
        }

        async function viewStudentResultDetail(studentCode, testId, timestamp) {
            try {
                // Load student info
                const studentSnapshot = await db.ref(`studentCodes/${studentCode}`).once('value');
                const studentData = studentSnapshot.val();
                
                if (!studentData) {
                    showNotification('Kh√¥ng t√¨m th·∫•y th√¥ng tin h·ªçc sinh!', 'error');
                    return;
                }
                
                // Load attempts data to find the specific attempt
                const attemptsSnapshot = await db.ref('attempts').once('value');
                const attemptsData = attemptsSnapshot.val() || {};
                
                let attemptData = null;
                
                // Find the specific attempt
                Object.values(attemptsData).forEach(sessionData => {
                    Object.values(sessionData).forEach(attempt => {
                        if (attempt.code === studentCode && attempt.testId === testId && attempt.createdAt === timestamp) {
                            attemptData = attempt;
                        }
                    });
                });
                
                if (!attemptData) {
                    showNotification('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu b√†i l√†m!', 'error');
                    return;
                }
                
                const testName = getTestDisplayName(testId);
                
                // Display student info
                document.getElementById('studentInfo').innerHTML = `
                    <h3>Th√¥ng tin h·ªçc sinh</h3>
                    <p><strong>H·ªç t√™n:</strong> ${studentData.name}</p>
                    <p><strong>M√£ h·ªçc sinh:</strong> ${studentCode}</p>
                    <p><strong>L·ªõp:</strong> ${studentData.classCode || 'N/A'}</p>
                    <p><strong>ƒê·ªÅ thi:</strong> <span class="test-name">${testName}</span></p>
                    <p><strong>ƒêi·ªÉm s·ªë:</strong> <span style="font-weight: bold; color: ${getScoreColor(attemptData.score)}">${parseFloat(attemptData.score).toFixed(2)}</span></p>
                    <p><strong>Th·ªùi gian l√†m b√†i:</strong> ${timestamp ? new Date(timestamp).toLocaleString('vi-VN') : 'N/A'}</p>
                `;
                
                // Display answer details
                let answersHTML = '<h3>Chi ti·∫øt b√†i l√†m</h3>';
                
                if (attemptData.answers) {
                    Object.entries(attemptData.answers).forEach(([questionId, answer]) => {
                        const isCorrect = checkAnswerCorrectness(questionId, answer, attemptData.correctAnswers);
                        const answerClass = isCorrect === 'correct' ? 'correct' : 
                                           isCorrect === 'partial' ? 'partial' : 'incorrect';
                        
                        answersHTML += `
                            <div class="answer-item ${answerClass}">
                                <p><strong>C√¢u ${questionId}:</strong> ${formatAnswer(answer)}</p>
                                ${isCorrect !== 'correct' && attemptData.correctAnswers && attemptData.correctAnswers[questionId] ? 
                                    `<div class="question-detail">
                                        <strong>ƒê√°p √°n ƒë√∫ng:</strong> ${formatAnswer(attemptData.correctAnswers[questionId])}
                                    </div>` : ''}
                                <div class="time-info">
                                    Tr·∫°ng th√°i: ${isCorrect === 'correct' ? '‚úÖ ƒê√∫ng' : isCorrect === 'partial' ? '‚ö†Ô∏è M·ªôt ph·∫ßn' : '‚ùå Sai'}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    answersHTML += '<p>Kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt v·ªÅ b√†i l√†m.</p>';
                }
                
                document.getElementById('answerDetails').innerHTML = answersHTML;
                
                // Store current result for export
                window.currentStudentResult = {
                    ...attemptData,
                    studentCode: studentCode,
                    testId: testId,
                    timestamp: timestamp,
                    testName: testName
                };
                window.currentStudentInfo = studentData;
                
                // Show details section
                document.getElementById('studentResultsDetail').style.display = 'block';
                hideModal('results-modal');
                
            } catch (error) {
                console.error('Error viewing student result:', error);
                showNotification('‚ùå L·ªói khi t·∫£i chi ti·∫øt k·∫øt qu·∫£!', 'error');
            }
        }

        function checkAnswerCorrectness(questionId, studentAnswer, correctAnswers) {
            if (!correctAnswers || !correctAnswers[questionId]) return 'unknown';
            
            const correctAnswer = correctAnswers[questionId];
            
            if (Array.isArray(studentAnswer) && Array.isArray(correctAnswer)) {
                // For True/False questions
                let correctCount = 0;
                for (let i = 0; i < studentAnswer.length; i++) {
                    if (studentAnswer[i] === correctAnswer[i]) {
                        correctCount++;
                    }
                }
                
                if (correctCount === studentAnswer.length) return 'correct';
                if (correctCount > 0) return 'partial';
                return 'incorrect';
            } else {
                // For single answer questions
                return studentAnswer === correctAnswer ? 'correct' : 'incorrect';
            }
        }

        function formatAnswer(answer) {
            if (Array.isArray(answer)) {
                return answer.map((a, i) => {
                    const letter = String.fromCharCode(97 + i);
                    return `${letter}) ${a || 'Ch∆∞a tr·∫£ l·ªùi'}`;
                }).join('; ');
            }
            return answer || 'Ch∆∞a tr·∫£ l·ªùi';
        }

        function getScoreColor(score) {
            if (score >= 8) return '#28a745';
            if (score >= 5) return '#ffc107';
            return '#dc3545';
        }

        // ===== FILTER MANAGEMENT =====
        async function updateClassFilterOptions(filterId) {
            try {
                const snapshot = await db.ref('classes').once('value');
                const classesData = snapshot.val() || {};
                const select = document.getElementById(filterId);
                
                let options = '<option value="all">T·∫•t c·∫£ l·ªõp</option>';
                
                Object.entries(classesData).forEach(([classCode, classData]) => {
                    if (classData.teacherId === currentUser.uid) {
                        options += `<option value="${classCode}">${classData.name} (${classCode})</option>`;
                    }
                });
                
                // Preserve current selection
                const currentValue = select.value;
                select.innerHTML = options;
                if (currentValue) {
                    select.value = currentValue;
                }
                
            } catch (error) {
                console.error('Error updating class filter:', error);
            }
        }

        function updateTestFilterOptions(testSet) {
            const select = document.getElementById('filter-test-results');
            let options = '<option value="all">T·∫•t c·∫£ ƒë·ªÅ</option>';
            
            testSet.forEach(test => {
                if (test && test !== 'undefined') {
                    const displayName = getTestDisplayName(test);
                    options += `<option value="${test}">${displayName}</option>`;
                }
            });
            
            // Preserve current selection
            const currentValue = select.value;
            select.innerHTML = options;
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // ===== EXPORT FUNCTIONS =====
        function exportStudentCodesToExcel() {
            try {
                const codesSnapshot = db.ref('studentCodes').once('value').then(snapshot => {
                    const codesData = snapshot.val() || {};
                    const filterClass = document.getElementById('filter-class-codes').value;
                    const searchTerm = document.getElementById('search-student-codes').value.toLowerCase();
                    
                    const data = [];
                    data.push(['M√£ HS', 'H·ªç t√™n', 'L·ªõp', 'Ng√†y c·∫•p', 'Tr·∫°ng th√°i']);
                    
                    Object.entries(codesData).forEach(([code, studentData]) => {
                        if (studentData.teacherId !== currentUser.uid) return;
                        if (filterClass !== 'all' && studentData.classCode !== filterClass) return;
                        if (searchTerm && !studentData.name.toLowerCase().includes(searchTerm) && !code.toLowerCase().includes(searchTerm)) return;
                        
                        const createDate = studentData.createdAt ? 
                            new Date(studentData.createdAt).toLocaleDateString('vi-VN') : 'N/A';
                        
                        data.push([
                            code,
                            studentData.name,
                            studentData.classCode || 'N/A',
                            createDate,
                            studentData.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'ƒê√£ kh√≥a'
                        ]);
                    });
                    
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'M√£ h·ªçc sinh');
                    XLSX.writeFile(wb, `MaHocSinh_${new Date().toISOString().split('T')[0]}.xlsx`);
                    
                    showNotification('‚úÖ ƒê√£ xu·∫•t danh s√°ch m√£ h·ªçc sinh!', 'success');
                });
            } catch (error) {
                console.error('Error exporting student codes:', error);
                showNotification('‚ùå L·ªói khi xu·∫•t danh s√°ch m√£ h·ªçc sinh!', 'error');
            }
        }

        function exportDetailedResultsToExcel() {
            try {
                const attemptsSnapshot = db.ref('attempts').once('value').then(snapshot => {
                    const attemptsData = snapshot.val() || {};
                    
                    // Get student codes for this teacher
                    const codesSnapshot = db.ref('studentCodes').once('value').then(codesSnapshot => {
                        const codesData = codesSnapshot.val() || {};
                        
                        const teacherStudents = {};
                        Object.entries(codesData).forEach(([code, studentData]) => {
                            if (studentData.teacherId === currentUser.uid) {
                                teacherStudents[code] = studentData;
                            }
                        });
                        
                        const data = [];
                        data.push(['H·ªçc sinh', 'M√£ HS', 'L·ªõp', 'ƒê·ªÅ thi', 'ƒêi·ªÉm', 'Th·ªùi gian l√†m b√†i']);
                        
                        Object.values(attemptsData).forEach(sessionData => {
                            Object.values(sessionData).forEach(attempt => {
                                if (!teacherStudents[attempt.code]) return;
                                
                                const student = teacherStudents[attempt.code];
                                const timestamp = attempt.createdAt ? 
                                    new Date(attempt.createdAt).toLocaleString('vi-VN') : 'N/A';
                                const testName = getTestDisplayName(attempt.testId);
                                
                                data.push([
                                    student.name,
                                    attempt.code,
                                    student.classCode || 'N/A',
                                    testName,
                                    parseFloat(attempt.score).toFixed(2),
                                    timestamp
                                ]);
                            });
                        });
                        
                        const ws = XLSX.utils.aoa_to_sheet(data);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, 'K·∫øt qu·∫£ b√†i l√†m');
                        XLSX.writeFile(wb, `KetQuaBaiLam_${new Date().toISOString().split('T')[0]}.xlsx`);
                        
                        showNotification('‚úÖ ƒê√£ xu·∫•t k·∫øt qu·∫£ b√†i l√†m!', 'success');
                    });
                });
            } catch (error) {
                console.error('Error exporting results:', error);
                showNotification('‚ùå L·ªói khi xu·∫•t k·∫øt qu·∫£ b√†i l√†m!', 'error');
            }
        }

        function exportStudentDetailToExcel() {
            try {
                if (!window.currentStudentResult || !window.currentStudentInfo) {
                    showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!', 'error');
                    return;
                }
                
                const resultData = window.currentStudentResult;
                const studentData = window.currentStudentInfo;
                
                const data = [];
                data.push(['TH√îNG TIN H·ªåC SINH V√Ä K·∫æT QU·∫¢ B√ÄI L√ÄM']);
                data.push([]);
                data.push(['H·ªç t√™n:', studentData.name]);
                data.push(['M√£ h·ªçc sinh:', resultData.studentCode]);
                data.push(['L·ªõp:', studentData.classCode || 'N/A']);
                data.push(['ƒê·ªÅ thi:', resultData.testName]);
                data.push(['ƒêi·ªÉm s·ªë:', parseFloat(resultData.score).toFixed(2)]);
                data.push(['Th·ªùi gian l√†m b√†i:', resultData.timestamp ? new Date(resultData.timestamp).toLocaleString('vi-VN') : 'N/A']);
                data.push([]);
                data.push(['CHI TI·∫æT B√ÄI L√ÄM']);
                data.push(['C√¢u h·ªèi', 'ƒê√°p √°n h·ªçc sinh', 'ƒê√°p √°n ƒë√∫ng', 'K·∫øt qu·∫£']);
                
                if (resultData.answers) {
                    Object.entries(resultData.answers).forEach(([questionId, answer]) => {
                        const correctAnswer = resultData.correctAnswers ? resultData.correctAnswers[questionId] : 'Kh√¥ng x√°c ƒë·ªãnh';
                        const isCorrect = checkAnswerCorrectness(questionId, answer, resultData.correctAnswers);
                        const resultText = isCorrect === 'correct' ? 'ƒê√∫ng' : 
                                          isCorrect === 'partial' ? 'M·ªôt ph·∫ßn' : 'Sai';
                        
                        data.push([
                            `C√¢u ${questionId}`,
                            formatAnswer(answer),
                            formatAnswer(correctAnswer),
                            resultText
                        ]);
                    });
                }
                
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Chi ti·∫øt b√†i l√†m');
                XLSX.writeFile(wb, `ChiTietBaiLam_${resultData.studentCode}_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                showNotification('‚úÖ ƒê√£ xu·∫•t chi ti·∫øt b√†i l√†m!', 'success');
            } catch (error) {
                console.error('Error exporting student detail:', error);
                showNotification('‚ùå L·ªói khi xu·∫•t chi ti·∫øt b√†i l√†m!', 'error');
            }
        }

        function exportResultsToExcel() {
            exportDetailedResultsToExcel();
        }

        function exportAllDataToExcel() {
            try {
                // Create a new workbook
                const wb = XLSX.utils.book_new();
                
                // Export classes
                const classesSnapshot = db.ref('classes').once('value').then(snapshot => {
                    const classesData = snapshot.val() || {};
                    
                    const classData = [];
                    classData.push(['M√£ l·ªõp', 'T√™n l·ªõp', 'S·ªë h·ªçc sinh', 'Ng√†y t·∫°o', 'M√¥ t·∫£']);
                    
                    Object.entries(classesData).forEach(([classCode, classDataItem]) => {
                        if (classDataItem.teacherId !== currentUser.uid) return;
                        
                        const createDate = classDataItem.createdAt ? 
                            new Date(classDataItem.createdAt).toLocaleDateString('vi-VN') : 'N/A';
                        
                        classData.push([
                            classCode,
                            classDataItem.name,
                            classDataItem.studentCount || 0,
                            createDate,
                            classDataItem.description || ''
                        ]);
                    });
                    
                    const classWs = XLSX.utils.aoa_to_sheet(classData);
                    XLSX.utils.book_append_sheet(wb, classWs, 'L·ªõp h·ªçc');
                    
                    // Export student codes
                    return db.ref('studentCodes').once('value');
                }).then(snapshot => {
                    const codesData = snapshot.val() || {};
                    
                    const studentData = [];
                    studentData.push(['M√£ HS', 'H·ªç t√™n', 'L·ªõp', 'Ng√†y c·∫•p', 'Tr·∫°ng th√°i']);
                    
                    Object.entries(codesData).forEach(([code, studentDataItem]) => {
                        if (studentDataItem.teacherId !== currentUser.uid) return;
                        
                        const createDate = studentDataItem.createdAt ? 
                            new Date(studentDataItem.createdAt).toLocaleDateString('vi-VN') : 'N/A';
                        
                        studentData.push([
                            code,
                            studentDataItem.name,
                            studentDataItem.classCode || 'N/A',
                            createDate,
                            studentDataItem.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'ƒê√£ kh√≥a'
                        ]);
                    });
                    
                    const studentWs = XLSX.utils.aoa_to_sheet(studentData);
                    XLSX.utils.book_append_sheet(wb, studentWs, 'H·ªçc sinh');
                    
                    // Export results
                    return db.ref('attempts').once('value');
                }).then(snapshot => {
                    const attemptsData = snapshot.val() || {};
                    
                    // Get student codes for this teacher
                    return db.ref('studentCodes').once('value').then(codesSnapshot => {
                        const codesData = codesSnapshot.val() || {};
                        
                        const teacherStudents = {};
                        Object.entries(codesData).forEach(([code, studentData]) => {
                            if (studentData.teacherId === currentUser.uid) {
                                teacherStudents[code] = studentData;
                            }
                        });
                        
                        const resultData = [];
                        resultData.push(['H·ªçc sinh', 'M√£ HS', 'L·ªõp', 'ƒê·ªÅ thi', 'ƒêi·ªÉm', 'Th·ªùi gian l√†m b√†i']);
                        
                        Object.values(attemptsData).forEach(sessionData => {
                            Object.values(sessionData).forEach(attempt => {
                                if (!teacherStudents[attempt.code]) return;
                                
                                const student = teacherStudents[attempt.code];
                                const timestamp = attempt.createdAt ? 
                                    new Date(attempt.createdAt).toLocaleString('vi-VN') : 'N/A';
                                const testName = getTestDisplayName(attempt.testId);
                                
                                resultData.push([
                                    student.name,
                                    attempt.code,
                                    student.classCode || 'N/A',
                                    testName,
                                    parseFloat(attempt.score).toFixed(2),
                                    timestamp
                                ]);
                            });
                        });
                        
                        const resultWs = XLSX.utils.aoa_to_sheet(resultData);
                        XLSX.utils.book_append_sheet(wb, resultWs, 'K·∫øt qu·∫£ b√†i l√†m');
                        
                        // Save the workbook
                        XLSX.writeFile(wb, `BaoCaoToanBo_${new Date().toISOString().split('T')[0]}.xlsx`);
                        
                        showNotification('‚úÖ ƒê√£ xu·∫•t to√†n b·ªô d·ªØ li·ªáu!', 'success');
                    });
                });
            } catch (error) {
                console.error('Error exporting all data:', error);
                showNotification('‚ùå L·ªói khi xu·∫•t to√†n b·ªô d·ªØ li·ªáu!', 'error');
            }
        }
function calcScoreFromPartial(partialAnswers, answerKey) {
    if (!partialAnswers || !answerKey) return 0;

    let score = 0;
    let totalQuestions = 0;

    Object.keys(answerKey).forEach(qid => {
        if (!answerKey[qid] || answerKey[qid].type === 'welcome') return;
        totalQuestions++;

        const pa = partialAnswers[qid];
        if (pa && pa.isCorrect) score++;
    });

    if (totalQuestions === 0) return 0;
    return (score / totalQuestions) * 10;
}

        // ===== NOTIFICATION SYSTEM =====
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.innerHTML = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            setTimeout(() => { notification.classList.remove('show'); }, 5000);
        }

        // Make functions available globally
        window.revokeStudentCode = revokeStudentCode;
        window.viewStudentResultDetail = viewStudentResultDetail;
    </script>
    
</body>
</html>
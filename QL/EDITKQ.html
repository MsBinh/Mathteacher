<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Qu·∫£n l√Ω d·ªØ li·ªáu ch·∫•m ƒëi·ªÉm - Admin</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background:#f8f9fa; padding-top:20px; }
  .container { max-width:1400px; }
  .card-header { font-weight:bold; }
  .table th { vertical-align:middle; }
  .stats-card { text-align:center; }
  .stats-number { font-size:1.5rem; font-weight:bold; }
  /* N√∫t quay v·ªÅ trang ch·ªß */
.home-button {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1000;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 50px;
  padding: 12px 20px;
  font-weight: 600;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.home-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  color: white;
  text-decoration: none;
}

.home-button:active {
  transform: translateY(0);
}

/* Responsive cho mobile */
@media (max-width: 768px) {
  .home-button {
    top: 10px;
    left: 10px;
    padding: 10px 16px;
    font-size: 14px;
  }
}

/* Phi√™n b·∫£n n√∫t nh·ªè h∆°n cho c√°c trang c·∫ßn nhi·ªÅu kh√¥ng gian */
.home-button-sm {
  padding: 8px 16px;
  font-size: 14px;
}
</style>
</head>
<body>
<div class="container">
  <h1 class="text-center text-danger mb-4">üîê TRANG QU·∫¢N L√ù D·ªÆ LI·ªÜU CH·∫§M ƒêI·ªÇM</h1>
  <p class="text-center text-muted mb-4">Ch·ªâ d√†nh cho qu·∫£n tr·ªã vi√™n - Thao t√°c x√≥a kh√¥ng th·ªÉ ho√†n t√°c</p>
  <a href="index.html" class="home-button" title="Quay v·ªÅ trang ch√≠nh">
  üè† Trang ch√≠nh
</a>

  <!-- Th·ªëng k√™ t·ªïng quan -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">üìä TH·ªêNG K√ä D·ªÆ LI·ªÜU HI·ªÜN T·∫†I</div>
    <div class="card-body">
      <div class="row text-center">
        <div class="col-md-3 mb-3">
          <div class="card bg-light h-100">
            <div class="card-body">
              <div class="stats-number text-primary" id="total-projects">0</div>
              <small class="text-muted">T·ªïng d·ª± √°n</small>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card bg-light h-100">
            <div class="card-body">
              <div class="stats-number text-info" id="total-scores">0</div>
              <small class="text-muted">T·ªïng l∆∞·ª£t ch·∫•m</small>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card bg-light h-100">
            <div class="card-body">
              <div class="stats-number text-success" id="stem-scores">0</div>
              <small class="text-muted">L∆∞·ª£t ch·∫•m STEM</small>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card bg-light h-100">
            <div class="card-body">
              <div class="stats-number text-warning" id="science-scores">0</div>
              <small class="text-muted">L∆∞·ª£t ch·∫•m KHKT</small>
            </div>
          </div>
        </div>
      </div>
      <div class="text-center mt-3">
        <button class="btn btn-outline-primary btn-sm" onclick="refreshStats()">
          üîÑ C·∫≠p nh·∫≠t th·ªëng k√™
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="loadAllData()">
          üì• T·∫£i l·∫°i to√†n b·ªô d·ªØ li·ªáu
        </button>
      </div>
    </div>
  </div>

  <!-- Qu·∫£n l√Ω theo d·ª± √°n -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-warning text-dark">üóÇÔ∏è QU·∫¢N L√ù D·ªÆ LI·ªÜU THEO D·ª∞ √ÅN</div>
    <div class="card-body">
      <div class="alert alert-warning">
        <strong>‚ö†Ô∏è L∆∞u √Ω:</strong> Ch·ªâ x√≥a d·ªØ li·ªáu ch·∫•m ƒëi·ªÉm, kh√¥ng x√≥a th√¥ng tin d·ª± √°n
      </div>
      
      <div class="row mb-3">
        <div class="col-md-6">
          <input type="text" class="form-control" id="project-filter" placeholder="üîç T√¨m ki·∫øm d·ª± √°n..." onkeyup="filterProjects()">
        </div>
        <div class="col-md-6">
          <select class="form-control" id="type-filter" onchange="filterProjects()">
            <option value="">T·∫•t c·∫£ lo·∫°i</option>
            <option value="STEM">STEM</option>
            <option value="KHKT">KHKT</option>
          </select>
        </div>
      </div>

      <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
        <table class="table table-sm table-hover table-striped">
          <thead class="table-light sticky-top">
            <tr>
              <th width="40">
                <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)">
              </th>
              <th width="60">STT</th>
              <th>T√™n d·ª± √°n</th>
              <th width="100">Lo·∫°i</th>
              <th width="100" class="text-center">L∆∞·ª£t ch·∫•m</th>
              <th width="100" class="text-center">ƒêi·ªÉm TB</th>
              <th width="120" class="text-center">H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody id="projects-list">
            <tr><td colspan="7" class="text-center text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-3 p-3 bg-light rounded">
        <div>
          <span id="selected-count" class="text-muted">ƒê√£ ch·ªçn: 0 d·ª± √°n</span>
        </div>
        <div>
          <button class="btn btn-outline-secondary btn-sm me-2" onclick="clearSelection()">
            üîÑ B·ªè ch·ªçn
          </button>
          <button class="btn btn-danger" onclick="deleteSelectedProjects()" id="delete-selected-btn" disabled>
            üóëÔ∏è X√≥a d·ªØ li·ªáu ch·∫•m ƒë√£ ch·ªçn
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- C√¥ng c·ª• n√¢ng cao -->
  <div class="card shadow-sm">
    <div class="card-header bg-danger text-white">‚öôÔ∏è C√îNG C·ª§ N√ÇNG CAO</div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <div class="card border-danger h-100">
            <div class="card-body text-center">
              <h5 class="text-danger">üîÑ X√≥a theo lo·∫°i</h5>
              <p class="text-muted">X√≥a to√†n b·ªô d·ªØ li·ªáu ch·∫•m ƒëi·ªÉm theo lo·∫°i cu·ªôc thi</p>
              <button class="btn btn-outline-danger btn-sm me-2" onclick="deleteByType('STEM')">
                X√≥a t·∫•t c·∫£ STEM
              </button>
              <button class="btn btn-outline-danger btn-sm" onclick="deleteByType('KHKT')">
                X√≥a t·∫•t c·∫£ KHKT
              </button>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card border-dark h-100">
            <div class="card-body text-center">
              <h5 class="text-dark">üíÄ X√≥a to√†n b·ªô</h5>
              <p class="text-muted">X√≥a t·∫•t c·∫£ d·ªØ li·ªáu ch·∫•m ƒëi·ªÉm (c·ª±c k·ª≥ nguy hi·ªÉm)</p>
              <button class="btn btn-dark" onclick="deleteAllScores()">
                üíÄ X√ìA TO√ÄN B·ªò
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// C·∫•u h√¨nh Firebase (d√πng chung v·ªõi file ch√≠nh)
const firebaseConfig = {
  apiKey: "AIzaSyDDACFZgZazMOnjzmGM_lrKswVcsoTFHxA",
  authDomain: "veonline-3bcbf.firebaseapp.com",
  projectId: "veonline-3bcbf",
  storageBucket: "veonline-3bcbf.firebasestorage.app",
  messagingSenderId: "1097751337006",
  appId: "1:1097751337006:web:8d4e6d9c2b2d4c3d8d4e6d"
};

// Kh·ªüi t·∫°o Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Bi·∫øn to√†n c·ª•c
let allProjectsData = [];
let allScoresData = [];

// H√†m ti·ªán √≠ch
function escapeHtml(s) { 
  return s ? s.replace(/[&<>]/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;"}[m])) : ""; 
}

// T·∫£i to√†n b·ªô d·ªØ li·ªáu
async function loadAllData() {
  try {
    console.log('üîÑ ƒêang t·∫£i d·ªØ li·ªáu...');
    
    // L·∫•y d·ªØ li·ªáu projects
    const projectsSnapshot = await db.collection('projects').get();
    allProjectsData = [];
    projectsSnapshot.forEach(doc => {
      allProjectsData.push({
        id: doc.id,
        ...doc.data()
      });
    });

    // L·∫•y d·ªØ li·ªáu scores
    const scoresSnapshot = await db.collection('scores').get();
    allScoresData = [];
    scoresSnapshot.forEach(doc => {
      allScoresData.push({
        id: doc.id,
        ...doc.data()
      });
    });

    console.log(`‚úÖ ƒê√£ t·∫£i: ${allProjectsData.length} d·ª± √°n, ${allScoresData.length} l∆∞·ª£t ch·∫•m`);
    
    refreshStats();
    renderProjectsList();
    
  } catch (error) {
    console.error('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
    alert('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message);
  }
}

// L√†m m·ªõi th·ªëng k√™
function refreshStats() {
  const stemScores = allScoresData.filter(s => !s.type || s.type === 'STEM');
  const scienceScores = allScoresData.filter(s => s.type === 'KHKT');
  
  document.getElementById('total-projects').textContent = allProjectsData.length;
  document.getElementById('total-scores').textContent = allScoresData.length;
  document.getElementById('stem-scores').textContent = stemScores.length;
  document.getElementById('science-scores').textContent = scienceScores.length;
}

// Hi·ªÉn th·ªã danh s√°ch d·ª± √°n
function renderProjectsList() {
  const tbody = document.getElementById('projects-list');
  
  if (allProjectsData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Kh√¥ng c√≥ d·ª± √°n n√†o</td></tr>';
    return;
  }

  tbody.innerHTML = '';

  allProjectsData.forEach(project => {
    const projectScores = allScoresData.filter(score => score.projectId === project.id);
    const avgScore = projectScores.length > 0 
      ? (projectScores.reduce((sum, score) => sum + (score.total || 0), 0) / projectScores.length).toFixed(2)
      : '0.00';
    
    const projectType = project.type === 'KHKT' ? 'KHKT' : 'STEM';
    const typeBadge = projectType === 'STEM' ? 'bg-success' : 'bg-info';
    
    const row = `
      <tr>
        <td>
          <input type="checkbox" class="project-checkbox" value="${project.id}" onchange="updateSelection()" ${projectScores.length === 0 ? 'disabled' : ''}>
        </td>
        <td>${project.order || '?'}</td>
        <td>${escapeHtml(project.title || 'Kh√¥ng t√™n')}</td>
        <td><span class="badge ${typeBadge}">${projectType}</span></td>
        <td class="text-center">${projectScores.length}</td>
        <td class="text-center"><strong>${avgScore}</strong></td>
        <td class="text-center">
          <button class="btn btn-sm btn-outline-danger" onclick="deleteProjectScores('${project.id}')" ${projectScores.length === 0 ? 'disabled' : ''}>
            üóëÔ∏è X√≥a
          </button>
        </td>
      </tr>
    `;
    tbody.innerHTML += row;
  });
}

// L·ªçc d·ª± √°n
function filterProjects() {
  const nameFilter = document.getElementById('project-filter').value.toLowerCase();
  const typeFilter = document.getElementById('type-filter').value;
  
  const rows = document.querySelectorAll('#projects-list tr');
  
  rows.forEach(row => {
    const projectName = row.cells[2].textContent.toLowerCase();
    const projectType = row.cells[3].textContent;
    
    const nameMatch = projectName.includes(nameFilter);
    const typeMatch = !typeFilter || projectType === typeFilter;
    
    row.style.display = nameMatch && typeMatch ? '' : 'none';
  });
}

// Ch·ªçn/b·ªè ch·ªçn t·∫•t c·∫£
function toggleSelectAll(checkbox) {
  const checkboxes = document.querySelectorAll('.project-checkbox:not(:disabled)');
  checkboxes.forEach(cb => {
    cb.checked = checkbox.checked;
  });
  updateSelection();
}

// C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ƒë√£ ch·ªçn
function updateSelection() {
  const selected = document.querySelectorAll('.project-checkbox:checked');
  const count = selected.length;
  
  document.getElementById('selected-count').textContent = `ƒê√£ ch·ªçn: ${count} d·ª± √°n`;
  document.getElementById('delete-selected-btn').disabled = count === 0;
  document.getElementById('select-all').checked = count > 0 && 
    count === document.querySelectorAll('.project-checkbox:not(:disabled)').length;
}

// B·ªè ch·ªçn t·∫•t c·∫£
function clearSelection() {
  document.getElementById('select-all').checked = false;
  const checkboxes = document.querySelectorAll('.project-checkbox');
  checkboxes.forEach(cb => {
    cb.checked = false;
  });
  updateSelection();
}

// X√≥a d·ªØ li·ªáu ch·∫•m c·ªßa d·ª± √°n ƒë√£ ch·ªçn
async function deleteSelectedProjects() {
  const selected = document.querySelectorAll('.project-checkbox:checked');
  const projectIds = Array.from(selected).map(cb => cb.value);
  
  if (projectIds.length === 0) return;

  const projectNames = projectIds.map(id => {
    const project = allProjectsData.find(p => p.id === id);
    return project?.title || 'Kh√¥ng t√™n';
  });

  const totalScores = projectIds.reduce((total, id) => {
    return total + allScoresData.filter(score => score.projectId === id).length;
  }, 0);

  if (!confirm(`üóëÔ∏è X√ìA ${totalScores} L∆Ø·ª¢T CH·∫§M?\n\n${projectNames.join('\n')}\n\n‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
    return;
  }

  try {
    let totalDeleted = 0;
    
    for (const projectId of projectIds) {
      const scoresToDelete = allScoresData.filter(score => score.projectId === projectId);
      
      for (const score of scoresToDelete) {
        await db.collection('scores').doc(score.id).delete();
        totalDeleted++;
      }
    }
    
    alert(`‚úÖ ƒê√£ x√≥a ${totalDeleted} l∆∞·ª£t ch·∫•m ƒëi·ªÉm!`);
    loadAllData(); // Reload d·ªØ li·ªáu
    
  } catch (error) {
    console.error('L·ªói khi x√≥a:', error);
    alert('‚ùå L·ªói khi x√≥a d·ªØ li·ªáu: ' + error.message);
  }
}

// X√≥a d·ªØ li·ªáu ch·∫•m c·ªßa m·ªôt d·ª± √°n
async function deleteProjectScores(projectId) {
  const project = allProjectsData.find(p => p.id === projectId);
  const projectScores = allScoresData.filter(score => score.projectId === projectId);
  
  if (projectScores.length === 0) {
    alert('‚ÑπÔ∏è D·ª± √°n n√†y ch∆∞a c√≥ d·ªØ li·ªáu ch·∫•m ƒëi·ªÉm');
    return;
  }

  if (!confirm(`üóëÔ∏è X√≥a ${projectScores.length} l∆∞·ª£t ch·∫•m c·ªßa:\n"${project?.title || 'Kh√¥ng t√™n'}"\n\n‚ö†Ô∏è Kh√¥ng th·ªÉ ho√†n t√°c!`)) {
    return;
  }

  try {
    for (const score of projectScores) {
      await db.collection('scores').doc(score.id).delete();
    }
    
    alert(`‚úÖ ƒê√£ x√≥a ${projectScores.length} l∆∞·ª£t ch·∫•m ƒëi·ªÉm!`);
    loadAllData();
    
  } catch (error) {
    console.error('L·ªói khi x√≥a:', error);
    alert('‚ùå L·ªói: ' + error.message);
  }
}

// X√≥a theo lo·∫°i
async function deleteByType(type) {
  const typeScores = allScoresData.filter(score => 
    type === 'STEM' ? (!score.type || score.type === 'STEM') : score.type === type
  );
  
  if (typeScores.length === 0) {
    alert(`‚ÑπÔ∏è Kh√¥ng c√≥ d·ªØ li·ªáu ch·∫•m ${type} n√†o`);
    return;
  }

  if (!confirm(`üóëÔ∏è X√ìA ${typeScores.length} L∆Ø·ª¢T CH·∫§M ${type}?\n\n‚ö†Ô∏è Kh√¥ng th·ªÉ ho√†n t√°c!`)) {
    return;
  }

  try {
    for (const score of typeScores) {
      await db.collection('scores').doc(score.id).delete();
    }
    
    alert(`‚úÖ ƒê√£ x√≥a ${typeScores.length} l∆∞·ª£t ch·∫•m ${type}!`);
    loadAllData();
    
  } catch (error) {
    console.error('L·ªói khi x√≥a:', error);
    alert('‚ùå L·ªói: ' + error.message);
  }
}

// X√≥a to√†n b·ªô d·ªØ li·ªáu ch·∫•m ƒëi·ªÉm
async function deleteAllScores() {
  if (allScoresData.length === 0) {
    alert('‚ÑπÔ∏è Kh√¥ng c√≥ d·ªØ li·ªáu ch·∫•m ƒëi·ªÉm n√†o');
    return;
  }

  if (!confirm(`üíÄ X√ìA TO√ÄN B·ªò ${allScoresData.length} L∆Ø·ª¢T CH·∫§M?\n\nüö® C·ª∞C K·ª≤ NGUY HI·ªÇM - KH√îNG TH·ªÇ KH√îI PH·ª§C!`)) {
    return;
  }

  const confirmText = prompt(`‚ö†Ô∏è X√ÅC NH·∫¨N CU·ªêI:\nNh·∫≠p "X√ìA H·∫æT" ƒë·ªÉ x√°c nh·∫≠n:`);
  
  if (confirmText !== "X√ìA H·∫æT") {
    alert('‚ùå ƒê√£ h·ªßy!');
    return;
  }

  try {
    for (const score of allScoresData) {
      await db.collection('scores').doc(score.id).delete();
    }
    
    alert(`‚úÖ ƒê√£ x√≥a to√†n b·ªô ${allScoresData.length} l∆∞·ª£t ch·∫•m ƒëi·ªÉm!`);
    loadAllData();
    
  } catch (error) {
    console.error('L·ªói khi x√≥a to√†n b·ªô:', error);
    alert('‚ùå L·ªói: ' + error.message);
  }
}

// T·ª± ƒë·ªông t·∫£i d·ªØ li·ªáu khi trang load
document.addEventListener('DOMContentLoaded', loadAllData);
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üß™ H·ªá th·ªëng Ch·∫•m D·ª± √°n KHKT - Tr∆∞·ªùng THPT Tr·∫ßn Tr∆∞·ªùng Sinh</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body {
  background: linear-gradient(135deg, #17a2b8, #6610f2);
  min-height: 100vh;
  font-family: "Segoe UI", Roboto, sans-serif;
  color: #333;
}
.container {
  margin-top: 30px;
  margin-bottom: 40px;
}
.card {
  border-radius: 15px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.2);
  border: none;
}
.section-title {
  font-weight: bold;
  color: #6610f2;
  margin-top: 20px;
  border-bottom: 3px solid #6610f2;
  display: inline-block;
  padding-bottom: 5px;
}
.table th {
  background-color: #f8f9fa;
}
.login-required {
  filter: blur(3px);
  pointer-events: none;
  user-select: none;
}
.highlight-row {
  background-color: #fff3cd !important;
}
.medal-gold { color: #ffd700; font-weight: bold; }
.medal-silver { color: #c0c0c0; font-weight: bold; }
.medal-bronze { color: #cd7f32; font-weight: bold; }
.progress {
  height: 10px;
}
.score-input:focus {
  border-color: #6610f2;
  box-shadow: 0 0 0 0.2rem rgba(102, 16, 242, 0.25);
}
/* N√∫t quay v·ªÅ trang ch·ªß */
.home-button {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1000;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 50px;
  padding: 12px 20px;
  font-weight: 600;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.home-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  color: white;
  text-decoration: none;
}

.home-button:active {
  transform: translateY(0);
}

/* Responsive cho mobile */
@media (max-width: 768px) {
  .home-button {
    top: 10px;
    left: 10px;
    padding: 10px 16px;
    font-size: 14px;
  }
}

/* Phi√™n b·∫£n n√∫t nh·ªè h∆°n cho c√°c trang c·∫ßn nhi·ªÅu kh√¥ng gian */
.home-button-sm {
  padding: 8px 16px;
  font-size: 14px;
}
</style>
</head>
<body>
<div class="container">
  <div class="text-center mb-4">
    <h2 class="fw-bold text-white">üß™ H·ªÜ TH·ªêNG CH·∫§M D·ª∞ √ÅN KHOA H·ªåC K·ª∏ THU·∫¨T</h2>
    <h5 class="text-white">Tr∆∞·ªùng THPT Tr·∫ßn Tr∆∞·ªùng Sinh - S·ªü GD&ƒêT Vƒ©nh Long</h5>
  </div>
<a href="index.html" class="home-button" title="Quay v·ªÅ trang ch√≠nh">
  üè† Trang ch√≠nh
</a>
  <!-- ƒêƒÉng nh·∫≠p -->
  <div id="login-area" class="card p-4 mb-4">
    <h4 class="text-primary text-center mb-3">üéì ƒêƒÉng nh·∫≠p Gi√°m kh·∫£o</h4>
    <form id="login-form">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label fw-semibold">M√£ gi√°m kh·∫£o</label>
          <input type="text" id="judgeCodeInput" class="form-control" placeholder="M√£ do BTC c·∫•p" required>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">H·ªç v√† t√™n</label>
          <input type="text" id="judgeNameInput" class="form-control" placeholder="Nh·∫≠p h·ªç t√™n gi√°m kh·∫£o" required>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">ƒêƒÉng nh·∫≠p</button>
        </div>
      </div>
    </form>
    <p id="login-msg" class="text-danger mt-3" style="display:none"></p>
  </div>

  <!-- Khu v·ª±c ch√≠nh -->
  <div id="main-area" class="login-required" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="text-white">Xin ch√†o, <span id="judgeNameDisplay"></span> <span id="admin-badge" class="badge bg-danger ms-2" style="display:none">ADMIN</span></h4>
      <div>
        <button id="btn-export-data" class="btn btn-info btn-sm me-2">üìä Xu·∫•t d·ªØ li·ªáu</button>
        <button id="btn-logout" class="btn btn-outline-light">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <!-- Form th√™m d·ª± √°n -->
    <div id="project-form-section" class="card p-3 mb-4" style="display:none;">
      <h5 class="section-title">‚ûï Th√™m / S·ª≠a D·ª± √°n</h5>
      <form id="project-form" class="row g-2">
        <div class="col-md-1"><input type="number" id="p-order" class="form-control" placeholder="STT" required></div>
        <div class="col-md-3"><input type="text" id="p-title" class="form-control" placeholder="T√™n d·ª± √°n" required></div>
        <div class="col-md-2"><input type="text" id="p-authors" class="form-control" placeholder="Nh√≥m t√°c gi·∫£" required></div>
        <div class="col-md-2"><input type="text" id="p-teacher" class="form-control" placeholder="GV h∆∞·ªõng d·∫´n"></div>
        <div class="col-md-3"><input type="text" id="p-note" class="form-control" placeholder="Ghi ch√∫"></div>
        <div class="col-md-1"><button class="btn btn-success w-100">L∆∞u</button></div>
      </form>
    </div>

    <!-- Danh s√°ch d·ª± √°n -->
    <div class="card p-3 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="section-title mb-0">üìã Danh s√°ch D·ª± √°n</h5>
        <button id="refresh-projects" class="btn btn-outline-secondary btn-sm">üîÑ L√†m m·ªõi</button>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered align-middle" id="projectsTable">
          <thead class="table-light">
            <tr>
              <th class="text-center">STT</th>
              <th>T√™n d·ª± √°n</th>
              <th>Nh√≥m t√°c gi·∫£</th>
              <th>GVHD</th>
              <th>Ghi ch√∫</th>
              <th class="text-center" style="width: 180px;">Thao t√°c</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- D·ª± √°n ƒë√£ ch·∫•m -->
    <div class="card p-3 mb-4">
      <h5 class="section-title">üßæ C√°c d·ª± √°n b·∫°n ƒë√£ ch·∫•m</h5>
      <div class="table-responsive">
        <table class="table table-bordered align-middle" id="myScoresTable">
          <thead class="table-light">
            <tr>
              <th class="text-center">STT</th>
              <th>T√™n d·ª± √°n</th>
              <th class="text-center">C√¢u h·ªèi NC</th>
              <th class="text-center">Thi·∫øt k·∫ø & PP</th>
              <th class="text-center">Th·ª±c hi·ªán NC</th>
              <th class="text-center">S√°ng t·∫°o</th>
              <th class="text-center">Poster</th>
              <th class="text-center">Ph·ªèng v·∫•n</th>
              <th class="text-center">T·ªïng</th>
              <th>Nh·∫≠n x√©t</th>
              <th class="text-center">Ch·∫•m l·∫°i</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Khu admin -->
    <div id="admin-section" style="display:none;">
      <!-- B·∫£ng ch·∫•m c·ªßa t·∫•t c·∫£ GK -->
      <div class="card p-3 mb-4">
        <h5 class="section-title">üìä B·∫£ng ch·∫•m c·ªßa t·∫•t c·∫£ Gi√°m kh·∫£o</h5>
        <div class="table-responsive">
          <div id="allScoresTable"></div>
        </div>
      </div>
      
      <!-- B·∫£ng x·∫øp h·∫°ng TB -->
      <div class="card p-3 mb-4">
        <h5 class="section-title">üèÜ B·∫£ng x·∫øp h·∫°ng trung b√¨nh</h5>
        <div class="table-responsive">
          <div id="leaderboard"></div>
        </div>
      </div>
      
      <!-- B·∫£ng x·∫øp h·∫°ng IQR -->
      <div class="card p-3 mb-4">
        <h5 class="section-title text-success">üìà B·∫£ng x·∫øp h·∫°ng sau khi l·ªçc ngo·∫°i l·ªá (IQR)</h5>
        <div class="table-responsive">
          <div id="iqrLeaderboard"></div>
        </div>
      </div>
      
      <!-- Th·ªëng k√™ -->
      <div class="card p-3 mb-4">
        <h5 class="section-title">üìä Th·ªëng k√™ d·ªØ li·ªáu</h5>
        <div class="row text-center" id="stats-panel">
          <div class="col-md-3">
            <h4 id="total-projects" class="text-primary">0</h4>
            <small class="text-muted">T·ªïng d·ª± √°n</small>
          </div>
          <div class="col-md-3">
            <h4 id="total-scores" class="text-success">0</h4>
            <small class="text-muted">T·ªïng l∆∞·ª£t ch·∫•m</small>
          </div>
          <div class="col-md-3">
            <h4 id="total-judges" class="text-info">0</h4>
            <small class="text-muted">S·ªë gi√°m kh·∫£o</small>
          </div>
          <div class="col-md-3">
            <h4 id="outliers-removed" class="text-warning">0</h4>
            <small class="text-muted">ƒêi·ªÉm ngo·∫°i l·ªá ƒë√£ lo·∫°i</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal ch·∫•m ƒëi·ªÉm -->
<div class="modal fade" id="scoreModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">üßÆ Ch·∫•m ƒëi·ªÉm D·ª± √°n KHKT</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="score-form">
          <div class="mb-3">
            <label class="form-label fw-semibold">D·ª± √°n ƒëang ch·∫•m</label>
            <div id="project-info" class="alert alert-light"></div>
          </div>
          <div id="criteria-area" class="row g-3"></div>
          <div class="mt-3">
            <label class="form-label fw-semibold">T·ªïng ƒëi·ªÉm: <span id="score-total-display" class="fw-bold text-primary">0</span>/100</label>
            <div class="progress mt-1">
              <div id="score-progress-bar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label fw-semibold">Nh·∫≠n x√©t (tu·ª≥ ch·ªçn)</label>
            <textarea id="score-note" class="form-control" rows="3" placeholder="Nh·∫≠n x√©t v·ªÅ d·ª± √°n..."></textarea>
          </div>
          <button type="submit" class="btn btn-primary mt-3 w-100">L∆∞u ƒëi·ªÉm</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ====== C·∫§U H√åNH ====== */
const API_KEY = "AIzaSyDDACFZgZazMOnjzmGM_lrKswVcsoTFHxA";
const PROJECT_ID = "veonline-3bcbf";
const ADMIN_CODE = "yennhi2008";

/* ====== TR·∫†NG TH√ÅI ====== */
let judgeCode = null;
let judgeName = null;
let isAdmin = false;
let PROJECTS_MAP = new Map();
let leaderboardData = [];
let iqrData = [];

/* ====== TI√äU CH√ç CH·∫§M KHKT ====== */
const criteriaKHKT = [
  {id:"c1", label:"1. C√¢u h·ªèi (v·∫•n ƒë·ªÅ) nghi√™n c·ª©u", max:10, desc:"T√≠nh r√µ r√†ng, kh·∫£ thi v√† √Ω nghƒ©a c·ªßa c√¢u h·ªèi nghi√™n c·ª©u"},
  {id:"c2", label:"2. Thi·∫øt k·∫ø v√† ph∆∞∆°ng ph√°p", max:15, desc:"T√≠nh ph√π h·ª£p v√† hi·ªáu qu·∫£ c·ªßa ph∆∞∆°ng ph√°p nghi√™n c·ª©u"},
  {id:"c3", label:"3. Th·ª±c hi·ªán nghi√™n c·ª©u", max:20, desc:"Quy tr√¨nh th·ª±c hi·ªán, thu th·∫≠p v√† x·ª≠ l√Ω d·ªØ li·ªáu"},
  {id:"c4", label:"4. S√°ng t·∫°o", max:20, desc:"T√≠nh m·ªõi, s√°ng t·∫°o v√† ƒë·ªôt ph√° c·ªßa d·ª± √°n"},
  {id:"c5", label:"5. Poster v√† tr√¨nh b√†y", max:10, desc:"Thi·∫øt k·∫ø poster v√† kh·∫£ nƒÉng tr√¨nh b√†y tr·ª±c quan"},
  {id:"c6", label:"6. Ph·ªèng v·∫•n v√† b·∫£o v·ªá", max:25, desc:"Kh·∫£ nƒÉng tr·∫£ l·ªùi ph·ªèng v·∫•n, b·∫£o v·ªá k·∫øt qu·∫£ nghi√™n c·ª©u"}
];

/* ====== TI·ªÜN √çCH ====== */
function qs(id){ return document.getElementById(id); }
function show(el){ el.style.display = 'block'; }
function hide(el){ el.style.display = 'none'; }
function escapeHtml(s){ if(!s) return ""; return String(s).replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m])); }

function showToast(msg){ 
  const toast = document.createElement('div');
  toast.className = 'toast align-items-center text-bg-info border-0 position-fixed top-0 end-0 m-3';
  toast.style.zIndex = '1060';
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${msg}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  `;
  document.body.appendChild(toast);
  const bsToast = new bootstrap.Toast(toast);
  bsToast.show();
  setTimeout(() => {
    if (toast.parentNode) document.body.removeChild(toast);
  }, 3000);
}

/* ====== FIRESTORE REST HELPERS ====== */
async function fetchCollection(coll, pageSize=1000){
  try{
    const url = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/${coll}?pageSize=${pageSize}&key=${API_KEY}`;
    const r = await fetch(url);
    if(!r.ok){
      console.error('fetchCollection failed', coll, r.status, await r.text());
      return null;
    }
    return await r.json();
  }catch(err){ console.error('fetchCollection error', err); return null; }
}

async function fetchDocument(coll, docId){
  try{
    const url = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/${coll}/${encodeURIComponent(docId)}?key=${API_KEY}`;
    const r = await fetch(url);
    if(!r.ok) return null;
    return await r.json();
  }catch(err){ console.error('fetchDocument', err); return null; }
}

async function createDocument(coll, body){
  const url = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/${coll}?key=${API_KEY}`;
  const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  return r;
}

async function patchDocument(coll, docId, body){
  const url = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/${coll}/${encodeURIComponent(docId)}?key=${API_KEY}`;
  const r = await fetch(url, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  return r;
}

async function deleteDocument(coll, docId){
  const url = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/${coll}/${encodeURIComponent(docId)}?key=${API_KEY}`;
  return await fetch(url, { method:'DELETE' });
}

/* ====== X√ÅC TH·ª∞C GI√ÅM KH·∫¢O (GI·ªêNG STEM) ====== */
async function verifyJudgeCode(code){
  if(code === ADMIN_CODE) return true;
  // try direct doc
  const doc = await fetchDocument('codes', code);
  if(doc) return true;
  // search field 'code' in collection
  const list = await fetchCollection('codes', 500);
  if(!list || !list.documents) return false;
  for(const d of list.documents){
    const f = d.fields || {};
    if(f.code && f.code.stringValue === code) return true;
  }
  return false;
}

/* ====== LOGIN + SESSION (GI·ªêNG STEM) ====== */
const loginForm = qs('login-form');
const btnLogout = qs('btn-logout');

loginForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const code = qs('judgeCodeInput').value.trim();
  const name = qs('judgeNameInput').value.trim();
  if(!code || !name) return showToast('Vui l√≤ng nh·∫≠p m√£ v√† h·ªç t√™n');
  qs('login-msg').style.display = 'block'; qs('login-msg').textContent = 'ƒêang x√°c th·ª±c...';
  const ok = await verifyJudgeCode(code);
  if(!ok){ qs('login-msg').textContent = 'M√£ kh√¥ng h·ª£p l·ªá'; return; }
  judgeCode = code; judgeName = name; isAdmin = (code === ADMIN_CODE);
  localStorage.setItem('judgeCode', judgeCode); localStorage.setItem('judgeName', judgeName);
  qs('login-msg').style.display = 'none';
  await afterLogin();
});

btnLogout.addEventListener('click', ()=>{
  localStorage.removeItem('judgeCode'); localStorage.removeItem('judgeName'); location.reload();
});

async function afterLogin(){
  // show user info and controls
  loginForm.style.display = 'none';
  show(qs('main-area'));
  qs('main-area').classList.remove('login-required');
  btnLogout.classList.remove('d-none');
  qs('judgeNameDisplay').innerHTML = `<b>${escapeHtml(judgeName)}</b> (${escapeHtml(judgeCode)}) ${isAdmin?'<span class="text-danger">[ADMIN]</span>':''}`;
  
  // show admin sections only if admin
  if(isAdmin) {
    show(qs('admin-section'));
    show(qs('project-form-section'));
    qs('admin-badge').style.display = 'inline';
  } else {
    hide(qs('project-form-section'));
  }
  
  await loadProjects();
  await loadMyScores();
  if(isAdmin) { 
    await loadAllScores(); 
    await computeLeaderboard(); 
    await computeLeaderboardIQR(); 
  }
}

/* restore session if exists */
(function restore(){
  const c = localStorage.getItem('judgeCode');
  const n = localStorage.getItem('judgeName');
  if(c && n){
    judgeCode = c; judgeName = n; isAdmin = (c === ADMIN_CODE);
    afterLogin();
  }
})();


// ========== QU·∫¢N L√ù D·ª∞ √ÅN ==========
async function loadProjects() {
  const tbody = qs("#projectsTable tbody");
  tbody.innerHTML = "<tr><td colspan='6' class='text-center text-muted'>ƒêang t·∫£i...</td></tr>";
  
  const docs = await fetchCollection("projects");
  PROJECTS_MAP.clear();
  
  if (docs.length === 0) {
    tbody.innerHTML = "<tr><td colspan='6' class='text-center text-muted'>Ch∆∞a c√≥ d·ª± √°n n√†o</td></tr>";
    return;
  }
  
  // S·∫Øp x·∫øp theo STT
  docs.sort((a, b) => {
    const aOrder = parseInt(a.fields.order?.integerValue || a.fields.order?.stringValue || 0);
    const bOrder = parseInt(b.fields.order?.integerValue || b.fields.order?.stringValue || 0);
    return aOrder - bOrder;
  });
  
  tbody.innerHTML = "";
  docs.forEach((doc, index) => {
    const fields = doc.fields;
    const docId = doc.name.split('/').pop();
    
    PROJECTS_MAP.set(docId, {
      id: docId,
      order: parseInt(fields.order?.integerValue || fields.order?.stringValue || 0),
      title: fields.title?.stringValue || "",
      authors: fields.authors?.stringValue || "",
      teacher: fields.teacher?.stringValue || "",
      note: fields.note?.stringValue || ""
    });
    
    const row = document.createElement("tr");
    
    // Ch·ªâ hi·ªÉn th·ªã n√∫t s·ª≠a/x√≥a cho admin
    const adminButtons = isAdmin ? 
      `<button class="btn btn-sm btn-warning me-1" onclick="editProject('${docId}')">S·ª≠a</button>
       <button class="btn btn-sm btn-danger" onclick="deleteProject('${docId}')">X√≥a</button>` : '';
    
    row.innerHTML = `
      <td class="text-center">${fields.order?.integerValue || ""}</td>
      <td>${escapeHtml(fields.title?.stringValue || "")}</td>
      <td>${escapeHtml(fields.authors?.stringValue || "")}</td>
      <td>${escapeHtml(fields.teacher?.stringValue || "")}</td>
      <td>${escapeHtml(fields.note?.stringValue || "")}</td>
      <td class="text-center">
        <button class="btn btn-sm btn-primary me-1" onclick="openScoreModal('${docId}')">Ch·∫•m</button>
        ${adminButtons}
      </td>`;
    tbody.appendChild(row);
  });
}

qs("#project-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  
  // Ki·ªÉm tra quy·ªÅn admin
  if (!isAdmin) {
    showToast("Ch·ªâ admin m·ªõi c√≥ quy·ªÅn th√™m/s·ª≠a d·ª± √°n", "warning");
    return;
  }
  
  const order = qs("#order").value.trim();
  const title = qs("#title").value.trim();
  const authors = qs("#authors").value.trim();
  const teacher = qs("#teacher").value.trim();
  const note = qs("#note").value.trim();
  
  if (!order || !title || !authors) {
    showToast("Vui l√≤ng nh·∫≠p STT, t√™n d·ª± √°n v√† nh√≥m t√°c gi·∫£", "warning");
    return;
  }
  
  const fields = {
    order: { integerValue: parseInt(order) },
    title: { stringValue: title },
    authors: { stringValue: authors },
    teacher: { stringValue: teacher },
    note: { stringValue: note }
  };
  
  const editId = qs("#project-form").dataset.editId;
  let success = false;
  
  if (editId) {
    // S·ª≠a d·ª± √°n
    success = await patchDocument("projects", editId, fields);
    delete qs("#project-form").dataset.editId;
  } else {
    // Th√™m d·ª± √°n m·ªõi
    success = await createDocument("projects", fields);
  }
  
  if (success) {
    showToast(editId ? "C·∫≠p nh·∫≠t d·ª± √°n th√†nh c√¥ng" : "Th√™m d·ª± √°n th√†nh c√¥ng", "success");
    e.target.reset();
    loadProjects();
    if (isAdmin) {
      computeLeaderboard();
      computeLeaderboardIQR();
      updateStatistics();
    }
  } else {
    showToast("L·ªói khi l∆∞u d·ª± √°n", "danger");
  }
});

async function deleteProject(docId) {
  if (!isAdmin) {
    showToast("Ch·ªâ admin m·ªõi c√≥ quy·ªÅn x√≥a d·ª± √°n", "warning");
    return;
  }
  
  if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a d·ª± √°n n√†y?")) return;
  
  const success = await deleteDocument("projects", docId);
  if (success) {
    showToast("ƒê√£ x√≥a d·ª± √°n th√†nh c√¥ng", "success");
    loadProjects();
    if (isAdmin) {
      computeLeaderboard();
      computeLeaderboardIQR();
      updateStatistics();
    }
  } else {
    showToast("L·ªói khi x√≥a d·ª± √°n", "danger");
  }
}

function editProject(docId) {
  if (!isAdmin) {
    showToast("Ch·ªâ admin m·ªõi c√≥ quy·ªÅn s·ª≠a d·ª± √°n", "warning");
    return;
  }
  
  const project = PROJECTS_MAP.get(docId);
  if (!project) {
    showToast("Kh√¥ng t√¨m th·∫•y d·ª± √°n", "warning");
    return;
  }
  
  qs("#order").value = project.order;
  qs("#title").value = project.title;
  qs("#authors").value = project.authors;
  qs("#teacher").value = project.teacher;
  qs("#note").value = project.note;
  qs("#project-form").dataset.editId = docId;
  
  // Cu·ªôn ƒë·∫øn form
  qs("#project-form").scrollIntoView({ behavior: 'smooth' });
}

// ========== CH·∫§M ƒêI·ªÇM ==========
function updateScoreDisplay() {
  let total = 0;
  criteriaKHKT.forEach(criterion => {
    const value = parseFloat(qs(`#${criterion.id}`).value) || 0;
    total += value;
  });
  
  qs("#score-total-display").textContent = total;
  
  // C·∫≠p nh·∫≠t thanh ti·∫øn tr√¨nh
  const progressBar = qs("#score-progress-bar");
  const percentage = total;
  progressBar.style.width = `${percentage}%`;
  progressBar.textContent = `${total}%`;
  
  // Thay ƒë·ªïi m√†u theo ƒëi·ªÉm
  if (total < 50) {
    progressBar.className = "progress-bar bg-danger";
  } else if (total < 70) {
    progressBar.className = "progress-bar bg-warning";
  } else {
    progressBar.className = "progress-bar bg-success";
  }
}

function openScoreModal(projectId) {
  if (!judgeCode) {
    showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi ch·∫•m ƒëi·ªÉm", "warning");
    return;
  }
  
  const project = PROJECTS_MAP.get(projectId);
  if (!project) {
    showToast("Kh√¥ng t√¨m th·∫•y th√¥ng tin d·ª± √°n", "warning");
    return;
  }
  
  // Hi·ªÉn th·ªã th√¥ng tin d·ª± √°n
  qs("#project-info").innerHTML = `
    <strong>#${project.order} - ${project.title}</strong><br>
    <small class="text-muted">Nh√≥m t√°c gi·∫£: ${project.authors} | GVHD: ${project.teacher || "Kh√¥ng c√≥"}</small>
  `;
  
  // T·∫°o form ch·∫•m ƒëi·ªÉm
  const criteriaArea = qs("#criteria-area");
  criteriaArea.innerHTML = "";
  
  criteriaKHKT.forEach(criterion => {
    const col = document.createElement("div");
    col.className = "col-md-6";
    col.innerHTML = `
      <div class="mb-3">
        <label class="form-label">
          <strong>${criterion.label}</strong> 
          <small class="text-muted">(T·ªëi ƒëa: ${criterion.max})</small>
        </label>
        <input type="number" 
               min="0" 
               max="${criterion.max}" 
               id="${criterion.id}" 
               class="form-control score-input" 
               placeholder="0-${criterion.max}"
               required>
        <small class="form-text text-muted">${criterion.desc}</small>
      </div>
    `;
    criteriaArea.appendChild(col);
  });
  
  // Th√™m s·ª± ki·ªán c·∫≠p nh·∫≠t ƒëi·ªÉm
  criteriaKHKT.forEach(criterion => {
    qs(`#${criterion.id}`).addEventListener("input", updateScoreDisplay);
  });
  
  // Reset form
  qs("#score-form").reset();
  qs("#criteria-area").dataset.projectId = projectId;
  updateScoreDisplay();
  
  // Hi·ªÉn th·ªã modal
  const modal = new bootstrap.Modal("#scoreModal");
  modal.show();
}

qs("#score-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  
  if (!judgeCode) {
    showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc", "warning");
    return;
  }
  
  const projectId = qs("#criteria-area").dataset.projectId;
  if (!projectId) {
    showToast("L·ªói: Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c d·ª± √°n", "danger");
    return;
  }
  
  // T√≠nh t·ªïng ƒëi·ªÉm
  let total = 0;
  const fields = {
    projectId: { stringValue: projectId },
    judgeCode: { stringValue: judgeCode },
    judgeName: { stringValue: judgeName },
    note: { stringValue: qs("#score-note").value || "" },
    createdAt: { timestampValue: new Date().toISOString() }
  };
  
  criteriaKHKT.forEach(criterion => {
    const value = parseFloat(qs(`#${criterion.id}`).value) || 0;
    if (value < 0 || value > criterion.max) {
      showToast(`ƒêi·ªÉm ${criterion.label} kh√¥ng h·ª£p l·ªá (0-${criterion.max})`, "warning");
      return;
    }
    total += value;
    fields[criterion.id] = { doubleValue: value };
  });
  
  fields.total = { doubleValue: total };
  
  // Ki·ªÉm tra xem gi√°m kh·∫£o ƒë√£ ch·∫•m d·ª± √°n n√†y ch∆∞a
  const allScores = await fetchCollection("scores_khkt");
  const existingScore = allScores.find(doc => 
    doc.fields.projectId?.stringValue === projectId && 
    doc.fields.judgeCode?.stringValue === judgeCode
  );
  
  let success = false;
  
  if (existingScore) {
    // C·∫≠p nh·∫≠t ƒëi·ªÉm
    const scoreId = existingScore.name.split('/').pop();
    if (!confirm("B·∫°n ƒë√£ ch·∫•m d·ª± √°n n√†y. C·∫≠p nh·∫≠t ƒëi·ªÉm m·ªõi?")) return;
    success = await patchDocument("scores_khkt", scoreId, fields);
  } else {
    // Th√™m ƒëi·ªÉm m·ªõi
    success = await createDocument("scores_khkt", fields);
  }
  
  if (success) {
    showToast("L∆∞u ƒëi·ªÉm th√†nh c√¥ng", "success");
    bootstrap.Modal.getInstance("#scoreModal").hide();
    loadMyScores();
    if (isAdmin) {
      loadAllScores();
      computeLeaderboard();
      computeLeaderboardIQR();
      updateStatistics();
    }
  } else {
    showToast("L·ªói khi l∆∞u ƒëi·ªÉm", "danger");
  }
});

// ========== ƒêI·ªÇM C·ª¶A T√îI ==========
async function loadMyScores() {
  const tbody = qs("#myScoresTable tbody");
  tbody.innerHTML = "<tr><td colspan='11' class='text-center text-muted'>ƒêang t·∫£i...</td></tr>";
  
  const allScores = await fetchCollection("scores_khkt");
  const myScores = allScores.filter(doc => 
    doc.fields.judgeCode?.stringValue === judgeCode
  );
  
  if (myScores.length === 0) {
    tbody.innerHTML = "<tr><td colspan='11' class='text-center text-muted'>B·∫°n ch∆∞a ch·∫•m d·ª± √°n n√†o</td></tr>";
    return;
  }
  
  // L·∫•y th√¥ng tin d·ª± √°n
  const projects = await fetchCollection("projects");
  const projectMap = new Map();
  projects.forEach(doc => {
    const id = doc.name.split('/').pop();
    projectMap.set(id, {
      order: parseInt(doc.fields.order?.integerValue || doc.fields.order?.stringValue || 0),
      title: doc.fields.title?.stringValue || ""
    });
  });
  
  // S·∫Øp x·∫øp theo STT d·ª± √°n
  myScores.sort((a, b) => {
    const aProject = projectMap.get(a.fields.projectId?.stringValue) || { order: 0 };
    const bProject = projectMap.get(b.fields.projectId?.stringValue) || { order: 0 };
    return aProject.order - bProject.order;
  });
  
  tbody.innerHTML = "";
  myScores.forEach((doc, index) => {
    const fields = doc.fields;
    const projectId = fields.projectId?.stringValue;
    const project = projectMap.get(projectId) || { order: "?", title: "Kh√¥ng x√°c ƒë·ªãnh" };
    
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="text-center">${index + 1}</td>
      <td><strong>#${project.order}</strong> - ${escapeHtml(project.title)}</td>
      <td class="text-center">${(fields.c1?.doubleValue || 0).toFixed(1)}</td>
      <td class="text-center">${(fields.c2?.doubleValue || 0).toFixed(1)}</td>
      <td class="text-center">${(fields.c3?.doubleValue || 0).toFixed(1)}</td>
      <td class="text-center">${(fields.c4?.doubleValue || 0).toFixed(1)}</td>
      <td class="text-center">${(fields.c5?.doubleValue || 0).toFixed(1)}</td>
      <td class="text-center">${(fields.c6?.doubleValue || 0).toFixed(1)}</td>
      <td class="text-center fw-bold text-primary">${(fields.total?.doubleValue || 0).toFixed(1)}</td>
      <td>${escapeHtml(fields.note?.stringValue || "")}</td>
      <td class="text-center">
        <button class="btn btn-sm btn-outline-primary" onclick="openScoreModal('${projectId}')">Ch·∫•m l·∫°i</button>
      </td>`;
    tbody.appendChild(row);
  });
}

// ========== ADMIN: T·∫§T C·∫¢ ƒêI·ªÇM ==========
async function loadAllScores() {
  if (!isAdmin) return;
  
  const container = qs("#allScoresTable");
  container.innerHTML = "<div class='text-center text-muted'>ƒêang t·∫£i...</div>";
  
  const [projects, scores] = await Promise.all([
    fetchCollection("projects"),
    fetchCollection("scores_khkt")
  ]);
  
  if (scores.length === 0) {
    container.innerHTML = "<div class='text-center text-muted'>Ch∆∞a c√≥ ƒëi·ªÉm n√†o</div>";
    return;
  }
  
  // T·∫°o b·∫£ng
  let html = `
    <table class="table table-bordered table-sm">
      <thead class="table-light">
        <tr>
          <th class="text-center">#</th>
          <th class="text-center">STT</th>
          <th>T√™n d·ª± √°n</th>
          <th class="text-center">M√£ GK</th>
          <th>T√™n GK</th>
          <th class="text-center">C1</th>
          <th class="text-center">C2</th>
          <th class="text-center">C3</th>
          <th class="text-center">C4</th>
          <th class="text-center">C5</th>
          <th class="text-center">C6</th>
          <th class="text-center">T·ªïng</th>
        </tr>
      </thead>
      <tbody>`;
  
  // T·∫°o map d·ª± √°n
  const projectMap = new Map();
  projects.forEach(doc => {
    const id = doc.name.split('/').pop();
    projectMap.set(id, {
      order: parseInt(doc.fields.order?.integerValue || doc.fields.order?.stringValue || 0),
      title: doc.fields.title?.stringValue || ""
    });
  });
  
  // S·∫Øp x·∫øp ƒëi·ªÉm
  scores.sort((a, b) => {
    const aProject = projectMap.get(a.fields.projectId?.stringValue) || { order: 0 };
    const bProject = projectMap.get(b.fields.projectId?.stringValue) || { order: 0 };
    return aProject.order - bProject.order;
  });
  
  // Th√™m h√†ng
  scores.forEach((doc, index) => {
    const fields = doc.fields;
    const projectId = fields.projectId?.stringValue;
    const project = projectMap.get(projectId) || { order: "?", title: "Kh√¥ng x√°c ƒë·ªãnh" };
    
    html += `
      <tr>
        <td class="text-center">${index + 1}</td>
        <td class="text-center">${project.order}</td>
        <td>${escapeHtml(project.title)}</td>
        <td class="text-center">${escapeHtml(fields.judgeCode?.stringValue || "")}</td>
        <td>${escapeHtml(fields.judgeName?.stringValue || "")}</td>
        <td class="text-center">${(fields.c1?.doubleValue || 0).toFixed(1)}</td>
        <td class="text-center">${(fields.c2?.doubleValue || 0).toFixed(1)}</td>
        <td class="text-center">${(fields.c3?.doubleValue || 0).toFixed(1)}</td>
        <td class="text-center">${(fields.c4?.doubleValue || 0).toFixed(1)}</td>
        <td class="text-center">${(fields.c5?.doubleValue || 0).toFixed(1)}</td>
        <td class="text-center">${(fields.c6?.doubleValue || 0).toFixed(1)}</td>
        <td class="text-center fw-bold">${(fields.total?.doubleValue || 0).toFixed(1)}</td>
      </tr>`;
  });
  
  html += `</tbody></table>`;
  container.innerHTML = html;
}

// ========== B·∫¢NG X·∫æP H·∫†NG ==========
async function computeLeaderboard() {
  if (!isAdmin) return;
  
  const container = qs("#leaderboard");
  container.innerHTML = "<div class='text-center text-muted'>ƒêang t√≠nh to√°n...</div>";
  
  const [projects, scores] = await Promise.all([
    fetchCollection("projects"),
    fetchCollection("scores_khkt")
  ]);
  
  if (projects.length === 0) {
    container.innerHTML = "<div class='text-center text-muted'>Ch∆∞a c√≥ d·ª± √°n n√†o</div>";
    return;
  }
  
  // T√≠nh ƒëi·ªÉm trung b√¨nh
  const scoreMap = {};
  scores.forEach(doc => {
    const fields = doc.fields;
    const projectId = fields.projectId?.stringValue;
    if (!projectId) return;
    
    if (!scoreMap[projectId]) {
      scoreMap[projectId] = { sum: 0, count: 0 };
    }
    scoreMap[projectId].sum += fields.total?.doubleValue || 0;
    scoreMap[projectId].count++;
  });
  
  // T·∫°o danh s√°ch x·∫øp h·∫°ng
  const rankings = [];
  projects.forEach(doc => {
    const id = doc.name.split('/').pop();
    const fields = doc.fields;
    const scoreData = scoreMap[id] || { sum: 0, count: 0 };
    const avg = scoreData.count > 0 ? scoreData.sum / scoreData.count : 0;
    
    rankings.push({
      id: id,
      order: parseInt(fields.order?.integerValue || fields.order?.stringValue || 0),
      title: fields.title?.stringValue || "",
      count: scoreData.count,
      avg: avg
    });
  });
  
  // S·∫Øp x·∫øp theo ƒëi·ªÉm trung b√¨nh
  rankings.sort((a, b) => b.avg - a.avg || a.order - b.order);
  leaderboardData = [...rankings];
  
  // Hi·ªÉn th·ªã
  let html = `
    <table class="table table-hover">
      <thead class="table-light">
        <tr>
          <th class="text-center">H·∫°ng</th>
          <th class="text-center">STT</th>
          <th>T√™n d·ª± √°n</th>
          <th class="text-center">S·ªë l∆∞·ª£t</th>
          <th class="text-center">ƒêi·ªÉm TB</th>
        </tr>
      </thead>
      <tbody>`;
  
  rankings.forEach((item, index) => {
    let rankClass = "";
    if (index === 0) rankClass = "medal-gold";
    else if (index === 1) rankClass = "medal-silver";
    else if (index === 2) rankClass = "medal-bronze";
    
    html += `
      <tr>
        <td class="text-center ${rankClass}">${index + 1}</td>
        <td class="text-center">${item.order}</td>
        <td>${escapeHtml(item.title)}</td>
        <td class="text-center">${item.count}</td>
        <td class="text-center fw-bold text-success">${item.avg.toFixed(2)}</td>
      </tr>`;
  });
  
  html += `</tbody></table>`;
  container.innerHTML = html;
}

// ========== B·∫¢NG X·∫æP H·∫†NG IQR ==========
function quantile(sortedArr, q) {
  if (!sortedArr.length) return 0;
  const pos = (sortedArr.length - 1) * q;
  const base = Math.floor(pos);
  const rest = pos - base;
  if (base + 1 < sortedArr.length) {
    return sortedArr[base] + (sortedArr[base + 1] - sortedArr[base]) * rest;
  }
  return sortedArr[base];
}

async function computeLeaderboardIQR() {
  if (!isAdmin) return;
  
  const container = qs("#iqrLeaderboard");
  container.innerHTML = "<div class='text-center text-muted'>ƒêang t√≠nh to√°n IQR...</div>";
  
  const [projects, scores] = await Promise.all([
    fetchCollection("projects"),
    fetchCollection("scores_khkt")
  ]);
  
  if (projects.length === 0) {
    container.innerHTML = "<div class='text-center text-muted'>Ch∆∞a c√≥ d·ª± √°n n√†o</div>";
    return;
  }
  
  // Gom ƒëi·ªÉm theo d·ª± √°n
  const scoresByProject = {};
  scores.forEach(doc => {
    const fields = doc.fields;
    const projectId = fields.projectId?.stringValue;
    if (!projectId) return;
    
    if (!scoresByProject[projectId]) {
      scoresByProject[projectId] = [];
    }
    scoresByProject[projectId].push(fields.total?.doubleValue || 0);
  });
  
  // T√≠nh IQR v√† l·ªçc ngo·∫°i l·ªá
  const results = [];
  let totalOutliers = 0;
  
  projects.forEach(doc => {
    const id = doc.name.split('/').pop();
    const fields = doc.fields;
    const scores = scoresByProject[id] || [];
    
    if (scores.length === 0) {
      results.push({
        id: id,
        order: parseInt(fields.order?.integerValue || fields.order?.stringValue || 0),
        title: fields.title?.stringValue || "",
        totalCount: 0,
        validCount: 0,
        avg: 0,
        outlierCount: 0,
        regularRank: null
      });
      return;
    }
    
    // S·∫Øp x·∫øp ƒëi·ªÉm
    const sortedScores = [...scores].sort((a, b) => a - b);
    
    // T√≠nh IQR
    const Q1 = quantile(sortedScores, 0.25);
    const Q3 = quantile(sortedScores, 0.75);
    const IQR = Q3 - Q1;
    const lowerBound = Q1 - 1.5 * IQR;
    const upperBound = Q3 + 1.5 * IQR;
    
    // L·ªçc ngo·∫°i l·ªá
    const filteredScores = sortedScores.filter(score => 
      score >= lowerBound && score <= upperBound
    );
    
    // ƒê·∫øm ngo·∫°i l·ªá
    const outlierCount = sortedScores.length - filteredScores.length;
    totalOutliers += outlierCount;
    
    // T√≠nh ƒëi·ªÉm trung b√¨nh (sau khi l·ªçc)
    let avg;
    if (filteredScores.length >= 2) {
      avg = filteredScores.reduce((sum, score) => sum + score, 0) / filteredScores.length;
    } else {
      // N·∫øu kh√¥ng ƒë·ªß ƒëi·ªÉm h·ª£p l·ªá, d√πng t·∫•t c·∫£ ƒëi·ªÉm
      avg = sortedScores.reduce((sum, score) => sum + score, 0) / sortedScores.length;
    }
    
    // T√¨m h·∫°ng trong b·∫£ng x·∫øp h·∫°ng th∆∞·ªùng
    const regularRank = leaderboardData.findIndex(item => item.id === id);
    
    results.push({
      id: id,
      order: parseInt(fields.order?.integerValue || fields.order?.stringValue || 0),
      title: fields.title?.stringValue || "",
      totalCount: sortedScores.length,
      validCount: filteredScores.length,
      avg: avg,
      outlierCount: outlierCount,
      regularRank: regularRank >= 0 ? regularRank + 1 : null
    });
  });
  
  // S·∫Øp x·∫øp theo ƒëi·ªÉm IQR
  results.sort((a, b) => b.avg - a.avg || a.order - b.order);
  iqrData = [...results];
  
  // Hi·ªÉn th·ªã
  let html = `
    <table class="table table-hover">
      <thead class="table-light">
        <tr>
          <th class="text-center">H·∫°ng</th>
          <th class="text-center">STT</th>
          <th>T√™n d·ª± √°n</th>
          <th class="text-center">T·ªïng l∆∞·ª£t</th>
          <th class="text-center">L∆∞·ª£t h·ª£p l·ªá</th>
          <th class="text-center">ƒêi·ªÉm TB (IQR)</th>
          <th class="text-center">Thay ƒë·ªïi</th>
        </tr>
      </thead>
      <tbody>`;
  
  results.forEach((item, index) => {
    // T√≠nh thay ƒë·ªïi h·∫°ng
    let changeIndicator = "";
    if (item.regularRank !== null) {
      const change = item.regularRank - (index + 1);
      if (change > 0) {
        changeIndicator = `<span class="text-success">‚Üë+${change}</span>`;
      } else if (change < 0) {
        changeIndicator = `<span class="text-danger">‚Üì${change}</span>`;
      } else {
        changeIndicator = `<span class="text-muted">-</span>`;
      }
    }
    
    // Th√™m class highlight cho d·ª± √°n c√≥ ngo·∫°i l·ªá
    const rowClass = item.outlierCount > 0 ? "highlight-row" : "";
    
    // Th√™m huy ch∆∞∆°ng cho top 3
    let rankClass = "";
    if (index === 0) rankClass = "medal-gold";
    else if (index === 1) rankClass = "medal-silver";
    else if (index === 2) rankClass = "medal-bronze";
    
    html += `
      <tr class="${rowClass}">
        <td class="text-center ${rankClass}">${index + 1}</td>
        <td class="text-center">${item.order}</td>
        <td>${escapeHtml(item.title)}</td>
        <td class="text-center">${item.totalCount}</td>
        <td class="text-center">${item.validCount} ${item.outlierCount > 0 ? `<small class="text-danger">(-${item.outlierCount})</small>` : ""}</td>
        <td class="text-center fw-bold text-primary">${item.avg.toFixed(2)}</td>
        <td class="text-center">${changeIndicator}</td>
      </tr>`;
  });
  
  html += `</tbody></table>`;
  container.innerHTML = html;
  
  // C·∫≠p nh·∫≠t th·ªëng k√™
  updateStatistics(totalOutliers);
}

// ========== TH·ªêNG K√ä ==========
async function updateStatistics(totalOutliers = 0) {
  if (!isAdmin) return;
  
  const [projects, scores] = await Promise.all([
    fetchCollection("projects"),
    fetchCollection("scores_khkt")
  ]);
  
  // ƒê·∫øm s·ªë gi√°m kh·∫£o duy nh·∫•t
  const judges = new Set();
  scores.forEach(doc => {
    const judgeCode = doc.fields.judgeCode?.stringValue;
    if (judgeCode) judges.add(judgeCode);
  });
  
  // C·∫≠p nh·∫≠t UI
  qs("#total-projects").textContent = projects.length;
  qs("#total-scores").textContent = scores.length;
  qs("#total-judges").textContent = judges.size;
  qs("#outliers-removed").textContent = totalOutliers;
}

// ========== XU·∫§T D·ªÆ LI·ªÜU ==========
qs("#btn-export-data").addEventListener("click", async function() {
  if (!isAdmin) {
    showToast("Ch·ªâ admin m·ªõi c√≥ quy·ªÅn xu·∫•t d·ªØ li·ªáu", "warning");
    return;
  }
  
  try {
    const [projects, scores] = await Promise.all([
      fetchCollection("projects"),
      fetchCollection("scores_khkt")
    ]);
    
    if (projects.length === 0) {
      showToast("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t", "warning");
      return;
    }
    
    // T·∫°o n·ªôi dung CSV
    let csvContent = "DANH S√ÅCH D·ª∞ √ÅN KHKT\n";
    csvContent += "STT,T√™n d·ª± √°n,Nh√≥m t√°c gi·∫£,Gi√°o vi√™n h∆∞·ªõng d·∫´n,Ghi ch√∫\n";
    
    projects.forEach(project => {
      const fields = project.fields;
      csvContent += `"${fields.order?.integerValue || ''}","${fields.title?.stringValue || ''}","${fields.authors?.stringValue || ''}","${fields.teacher?.stringValue || ''}","${fields.note?.stringValue || ''}"\n`;
    });
    
    csvContent += "\n\nDANH S√ÅCH ƒêI·ªÇM CH·∫§M\n";
    csvContent += "STT,T√™n d·ª± √°n,M√£ GK,T√™n GK,C√¢u h·ªèi NC,Thi·∫øt k·∫ø & PP,Th·ª±c hi·ªán NC,S√°ng t·∫°o,Poster,Ph·ªèng v·∫•n,T·ªïng ƒëi·ªÉm,Nh·∫≠n x√©t\n";
    
    // T·∫°o map d·ª± √°n
    const projectMap = new Map();
    projects.forEach(doc => {
      const id = doc.name.split('/').pop();
      projectMap.set(id, {
        order: doc.fields.order?.integerValue || "",
        title: doc.fields.title?.stringValue || ""
      });
    });
    
    // Th√™m ƒëi·ªÉm
    scores.forEach(doc => {
      const fields = doc.fields;
      const projectId = fields.projectId?.stringValue;
      const project = projectMap.get(projectId) || { order: "?", title: "Kh√¥ng x√°c ƒë·ªãnh" };
      
      csvContent += `"${project.order}","${project.title}","${fields.judgeCode?.stringValue || ''}","${fields.judgeName?.stringValue || ''}",`;
      csvContent += `"${fields.c1?.doubleValue || 0}","${fields.c2?.doubleValue || 0}","${fields.c3?.doubleValue || 0}",`;
      csvContent += `"${fields.c4?.doubleValue || 0}","${fields.c5?.doubleValue || 0}","${fields.c6?.doubleValue || 0}",`;
      csvContent += `"${fields.total?.doubleValue || 0}","${fields.note?.stringValue || ''}"\n`;
    });
    
    // T·∫°o v√† t·∫£i file
    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `KHKT_Scores_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast("D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c xu·∫•t th√†nh c√¥ng", "success");
  } catch (error) {
    console.error("L·ªói xu·∫•t d·ªØ li·ªáu:", error);
    showToast("L·ªói khi xu·∫•t d·ªØ li·ªáu", "danger");
  }
});

// ========== L√ÄM M·ªöI ==========
qs("#refresh-projects").addEventListener("click", async () => {
  await loadProjects();
  await loadMyScores();
  if (isAdmin) {
    await loadAllScores();
    await computeLeaderboard();
    await computeLeaderboardIQR();
    await updateStatistics();
  }
  showToast("ƒê√£ l√†m m·ªõi d·ªØ li·ªáu", "success");
});
</script>
</body>
</html>
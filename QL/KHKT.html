<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üß™ H·ªá th·ªëng Ch·∫•m D·ª± √°n KHKT - Tr∆∞·ªùng THPT Tr·∫ßn Tr∆∞·ªùng Sinh</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body {
  background: linear-gradient(135deg, #17a2b8, #6610f2);
  min-height: 100vh;
  font-family: "Segoe UI", Roboto, sans-serif;
  color: #333;
}
.container {
  margin-top: 30px;
  margin-bottom: 40px;
}
.card {
  border-radius: 15px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.2);
  border: none;
}
.section-title {
  font-weight: bold;
  color: #6610f2;
  margin-top: 20px;
  border-bottom: 3px solid #6610f2;
  display: inline-block;
  padding-bottom: 5px;
}
.table th {
  background-color: #f8f9fa;
}
.login-required {
  filter: blur(3px);
  pointer-events: none;
  user-select: none;
}
.highlight-row {
  background-color: #fff3cd !important;
}
.medal-gold { color: #ffd700; font-weight: bold; }
.medal-silver { color: #c0c0c0; font-weight: bold; }
.medal-bronze { color: #cd7f32; font-weight: bold; }
.progress {
  height: 10px;
}
.score-input:focus {
  border-color: #6610f2;
  box-shadow: 0 0 0 0.2rem rgba(102, 16, 242, 0.25);
}
/* N√∫t quay v·ªÅ trang ch·ªß */
.home-button {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1000;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 50px;
  padding: 12px 20px;
  font-weight: 600;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.home-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  color: white;
  text-decoration: none;
}

.home-button:active {
  transform: translateY(0);
}

/* Responsive cho mobile */
@media (max-width: 768px) {
  .home-button {
    top: 10px;
    left: 10px;
    padding: 10px 16px;
    font-size: 14px;
  }
}

/* Phi√™n b·∫£n n√∫t nh·ªè h∆°n cho c√°c trang c·∫ßn nhi·ªÅu kh√¥ng gian */
.home-button-sm {
  padding: 8px 16px;
  font-size: 14px;
}

/* D·ª± √°n c·∫ßn ch·∫•m */
.project-to-score {
  background-color: #e8f5e8 !important;
  border-left: 4px solid #28a745 !important;
}

/* ·∫®n c·ªôt ph√¢n c√¥ng GK cho ng∆∞·ªùi d√πng th∆∞·ªùng */
.hide-assignment {
  display: none;
}

/* Hi·ªÉn th·ªã c·ªôt ph√¢n c√¥ng GK cho admin */
.show-assignment {
  display: table-cell;
}
</style>
</head>
<body>
<div class="container">
  <div class="text-center mb-4">
    <h2 class="fw-bold text-white">üß™ H·ªÜ TH·ªêNG CH·∫§M D·ª∞ √ÅN KHOA H·ªåC K·ª∏ THU·∫¨T</h2>
    <h5 class="text-white">Tr∆∞·ªùng THPT Tr·∫ßn Tr∆∞·ªùng Sinh - S·ªü GD&ƒêT Vƒ©nh Long</h5>
  </div>
<a href="index.html" class="home-button" title="Quay v·ªÅ trang ch√≠nh">
  üè† Trang ch√≠nh
</a>
  <!-- ƒêƒÉng nh·∫≠p -->
  <div id="login-area" class="card p-4 mb-4">
    <h4 class="text-primary text-center mb-3">üéì ƒêƒÉng nh·∫≠p Gi√°m kh·∫£o</h4>
    <form id="login-form">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label fw-semibold">M√£ gi√°m kh·∫£o</label>
          <input type="text" id="judgeCodeInput" class="form-control" placeholder="M√£ do BTC c·∫•p" required>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">H·ªç v√† t√™n</label>
          <input type="text" id="judgeNameInput" class="form-control" placeholder="Nh·∫≠p h·ªç t√™n gi√°m kh·∫£o" required>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">ƒêƒÉng nh·∫≠p</button>
        </div>
      </div>
    </form>
    <p id="login-msg" class="text-danger mt-3" style="display:none"></p>
  </div>

  <!-- Khu v·ª±c ch√≠nh -->
  <div id="main-area" class="login-required" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="text-white">Xin ch√†o, <span id="judgeNameDisplay"></span> <span id="admin-badge" class="badge bg-danger ms-2" style="display:none">ADMIN</span></h4>
      <div>
        <button id="btn-add-project" class="btn btn-success btn-sm me-2" style="display:none">+ Th√™m d·ª± √°n</button>
        <button id="btn-export-data" class="btn btn-info btn-sm me-2">üìä Xu·∫•t d·ªØ li·ªáu</button>
        <button id="refresh-projects" class="btn btn-outline-light btn-sm me-2">üîÑ L√†m m·ªõi</button>
        <button id="btn-logout" class="btn btn-outline-light btn-sm">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <!-- Danh s√°ch d·ª± √°n -->
    <div class="card p-3 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="section-title mb-0">üìã Danh s√°ch D·ª± √°n</h5>
        <button id="btn-show-my-projects" class="btn btn-info btn-sm">Ch·ªâ hi·ªán d·ª± √°n t√¥i c·∫ßn ch·∫•m</button>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th class="text-center">STT</th>
              <th>T√™n d·ª± √°n</th>
              <th>Nh√≥m t√°c gi·∫£</th>
              <th>GVHD</th>
              <th id="assignment-header" class="hide-assignment">Ph√¢n c√¥ng GK</th>
              <th class="text-center" style="width: 180px;">Thao t√°c</th>
            </tr>
          </thead>
          <tbody id="projects-tbody">
            <tr><td colspan="6" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- D·ª± √°n ƒë√£ ch·∫•m -->
    <div class="card p-3 mb-4">
      <h5 class="section-title">üßæ C√°c d·ª± √°n b·∫°n ƒë√£ ch·∫•m</h5>
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th class="text-center">STT</th>
              <th>T√™n d·ª± √°n</th>
              <th class="text-center">C√¢u h·ªèi NC</th>
              <th class="text-center">Thi·∫øt k·∫ø & PP</th>
              <th class="text-center">Th·ª±c hi·ªán NC</th>
              <th class="text-center">S√°ng t·∫°o</th>
              <th class="text-center">Poster</th>
              <th class="text-center">Ph·ªèng v·∫•n</th>
              <th class="text-center">T·ªïng</th>
              <th>Nh·∫≠n x√©t</th>
              <th class="text-center">Ch·∫•m l·∫°i</th>
            </tr>
          </thead>
          <tbody id="myScores-tbody">
            <tr><td colspan="11" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Khu admin -->
    <div id="admin-section" style="display:none;">
      <!-- B·∫£ng ch·∫•m c·ªßa t·∫•t c·∫£ GK -->
      <div class="card p-3 mb-4">
        <h5 class="section-title">üìä B·∫£ng ch·∫•m c·ªßa t·∫•t c·∫£ Gi√°m kh·∫£o</h5>
        <div class="table-responsive">
          <table class="table table-bordered table-sm">
            <thead class="table-light">
              <tr>
                <th class="text-center">#</th>
                <th class="text-center">STT</th>
                <th>T√™n d·ª± √°n</th>
                <th class="text-center">M√£ GK</th>
                <th>T√™n GK</th>
                <th class="text-center">C√¢u h·ªèi</th>
                <th class="text-center">Thi·∫øt k·∫ø</th>
                <th class="text-center">Th·ª±c hi·ªán</th>
                <th class="text-center">S√°ng t·∫°o</th>
                <th class="text-center">Poster</th>
                <th class="text-center">Ph·ªèng v·∫•n</th>
                <th class="text-center">T·ªïng</th>
              </tr>
            </thead>
            <tbody id="adminScores-tbody">
              <tr><td colspan="12" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- B·∫£ng x·∫øp h·∫°ng TB -->
      <div class="card p-3 mb-4">
        <h5 class="section-title">üèÜ B·∫£ng x·∫øp h·∫°ng theo ƒëi·ªÉm trung b√¨nh</h5>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th class="text-center">H·∫°ng</th>
                <th class="text-center">STT</th>
                <th>T√™n d·ª± √°n</th>
                <th class="text-center">S·ªë l∆∞·ª£t</th>
                <th class="text-center">ƒêi·ªÉm TB</th>
              </tr>
            </thead>
            <tbody id="leaderboard-tbody">
              <tr><td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- B·∫£ng x·∫øp h·∫°ng IQR -->
      <div class="card p-3 mb-4">
        <h5 class="section-title text-success">üìà B·∫£ng x·∫øp h·∫°ng sau khi l·ªçc ngo·∫°i l·ªá (IQR)</h5>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th class="text-center">H·∫°ng</th>
                <th class="text-center">STT</th>
                <th>T√™n d·ª± √°n</th>
                <th class="text-center">T·ªïng l∆∞·ª£t</th>
                <th class="text-center">L∆∞·ª£t h·ª£p l·ªá</th>
                <th class="text-center">ƒêi·ªÉm TB (IQR)</th>
                <th class="text-center">Thay ƒë·ªïi</th>
              </tr>
            </thead>
            <tbody id="iqrLeaderboard-tbody">
              <tr><td colspan="7" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Th·ªëng k√™ -->
      <div class="card p-3 mb-4">
        <h5 class="section-title">üìä Th·ªëng k√™ d·ªØ li·ªáu</h5>
        <div class="row text-center" id="stats-panel">
          <div class="col-md-3">
            <h4 id="total-projects" class="text-primary">0</h4>
            <small class="text-muted">T·ªïng d·ª± √°n</small>
          </div>
          <div class="col-md-3">
            <h4 id="total-scores" class="text-success">0</h4>
            <small class="text-muted">T·ªïng l∆∞·ª£t ch·∫•m</small>
          </div>
          <div class="col-md-3">
            <h4 id="total-judges" class="text-info">0</h4>
            <small class="text-muted">S·ªë gi√°m kh·∫£o</small>
          </div>
          <div class="col-md-3">
            <h4 id="outliers-removed" class="text-warning">0</h4>
            <small class="text-muted">ƒêi·ªÉm ngo·∫°i l·ªá ƒë√£ lo·∫°i</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal th√™m/s·ª≠a d·ª± √°n -->
<div class="modal fade" id="projectModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="project-form">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Th√™m / S·ª≠a D·ª± √Ån KHKT</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3"><label class="form-label">S·ªë th·ª© t·ª±</label><input type="number" id="p-order" class="form-control" required></div>
          <div class="mb-3"><label class="form-label">T√™n d·ª± √°n</label><input id="p-title" class="form-control" required></div>
          <div class="mb-3"><label class="form-label">Nh√≥m t√°c gi·∫£</label><input id="p-authors" class="form-control"></div>
          <div class="mb-3"><label class="form-label">Gi√°o vi√™n h∆∞·ªõng d·∫´n</label><input id="p-teacher" class="form-control"></div>
          <div class="mb-3">
            <label class="form-label">Ph√¢n c√¥ng GK</label>
            <input id="p-note" class="form-control" placeholder="Nh·∫≠p m√£ gi√°m kh·∫£o ph√¢n c√°ch b·∫±ng d·∫•u ph·∫©y (VD: GK01,GK02)">
            <small class="form-text text-muted">Nh·∫≠p m√£ gi√°m kh·∫£o ƒë·ªÉ ch·ªâ ƒë·ªãnh ai s·∫Ω ch·∫•m d·ª± √°n n√†y (ch·ªâ admin xem ƒë∆∞·ª£c)</small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary">L∆∞u</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">ƒê√≥ng</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal ch·∫•m ƒëi·ªÉm -->
<div class="modal fade" id="scoreModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="score-form">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">üßÆ Ch·∫•m ƒëi·ªÉm D·ª± √°n KHKT</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-semibold">Ch·ªçn d·ª± √°n</label>
            <select id="score-project-select" class="form-select" required></select>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">1Ô∏è‚É£ C√¢u h·ªèi NC (0-10)</label>
              <input id="score-c1" type="number" min="0" max="10" class="form-control score-input" value="0">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">2Ô∏è‚É£ Thi·∫øt k·∫ø & PP (0-15)</label>
              <input id="score-c2" type="number" min="0" max="15" class="form-control score-input" value="0">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">3Ô∏è‚É£ Th·ª±c hi·ªán NC (0-20)</label>
              <input id="score-c3" type="number" min="0" max="20" class="form-control score-input" value="0">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">4Ô∏è‚É£ S√°ng t·∫°o (0-20)</label>
              <input id="score-c4" type="number" min="0" max="20" class="form-control score-input" value="0">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">5Ô∏è‚É£ Poster (0-10)</label>
              <input id="score-c5" type="number" min="0" max="10" class="form-control score-input" value="0">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">6Ô∏è‚É£ Ph·ªèng v·∫•n (0-25)</label>
              <input id="score-c6" type="number" min="0" max="25" class="form-control score-input" value="0">
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label fw-semibold">T·ªïng ƒëi·ªÉm: <span id="score-total-display" class="fw-bold text-primary">0</span>/100</label>
            <div class="progress mt-1">
              <div id="score-progress-bar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label fw-semibold">Nh·∫≠n x√©t (tu·ª≥ ch·ªçn)</label>
            <textarea id="score-note" class="form-control" rows="3" placeholder="Nh·∫≠n x√©t v·ªÅ d·ª± √°n..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success w-100">L∆∞u ƒëi·ªÉm</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ====== C·∫§U H√åNH ====== */
const API_KEY = "AIzaSyDDACFZgZazMOnjzmGM_lrKswVcsoTFHxA";
const PROJECT_ID = "veonline-3bcbf";
const ADMIN_CODE = "yennhi2008";

/* ====== TR·∫†NG TH√ÅI ====== */
let judgeCode = null;
let judgeName = null;
let isAdmin = false;
let PROJECTS_MAP = new Map();
let leaderboardData = [];
let iqrData = [];
let showOnlyMyProjects = false; // Tr·∫°ng th√°i hi·ªÉn th·ªã d·ª± √°n c·∫ßn ch·∫•m

/* ====== TI·ªÜN √çCH ====== */
function qs(id){ return document.getElementById(id); }
function show(el){ if(el) el.style.display = 'block'; }
function hide(el){ if(el) el.style.display = 'none'; }
function escapeHtml(s){ if(!s) return ""; return String(s).replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m])); }

function showToast(msg, type = 'info'){ 
  const bgColor = type === 'error' ? 'text-bg-danger' : type === 'success' ? 'text-bg-success' : 'text-bg-info';
  const toast = document.createElement('div');
  toast.className = `toast align-items-center ${bgColor} border-0 position-fixed top-0 end-0 m-3`;
  toast.style.zIndex = '1060';
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${msg}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  `;
  document.body.appendChild(toast);
  const bsToast = new bootstrap.Toast(toast);
  bsToast.show();
  setTimeout(() => {
    if (toast.parentNode) document.body.removeChild(toast);
  }, 4000);
}

/* ====== FIRESTORE REST HELPERS ====== */
async function fetchCollection(coll, pageSize=1000){
  try{
    const url = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/${coll}?pageSize=${pageSize}&key=${API_KEY}`;
    const r = await fetch(url);
    if(!r.ok){
      // N·∫øu l·ªói 404 (collection kh√¥ng t·ªìn t·∫°i) th√¨ tr·∫£ v·ªÅ m·∫£ng r·ªóng
      if (r.status === 404 || r.status === 403) {
        console.warn(`Collection ${coll} kh√¥ng t·ªìn t·∫°i ho·∫∑c kh√¥ng c√≥ quy·ªÅn truy c·∫≠p`);
        return [];
      }
      console.error('fetchCollection failed', coll, r.status, await r.text());
      return [];
    }
    const data = await r.json();
    return data.documents || [];
  }catch(err){ 
    console.error('fetchCollection error', err); 
    return []; 
  }
}

async function fetchDocument(coll, docId){
  try{
    const url = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/${coll}/${encodeURIComponent(docId)}?key=${API_KEY}`;
    const r = await fetch(url);
    if(!r.ok) return null;
    return await r.json();
  }catch(err){ console.error('fetchDocument', err); return null; }
}

async function createDocument(coll, body){
  try {
    const url = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/${coll}?key=${API_KEY}`;
    const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    if (!r.ok) {
      // N·∫øu collection kh√¥ng t·ªìn t·∫°i, th·ª≠ t·∫°o document ƒë·∫ßu ti√™n ƒë·ªÉ t·∫°o collection
      if (r.status === 404 || r.status === 403) {
        console.warn(`Collection ${coll} kh√¥ng t·ªìn t·∫°i, kh√¥ng th·ªÉ t·∫°o document`);
        return false;
      }
      return false;
    }
    return true;
  } catch(err) {
    console.error('createDocument error', err);
    return false;
  }
}

async function patchDocument(coll, docId, body){
  try {
    const url = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/${coll}/${encodeURIComponent(docId)}?key=${API_KEY}`;
    const r = await fetch(url, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    return r.ok;
  } catch(err) {
    console.error('patchDocument error', err);
    return false;
  }
}

async function deleteDocument(coll, docId){
  try {
    const url = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/${coll}/${encodeURIComponent(docId)}?key=${API_KEY}`;
    const r = await fetch(url, { method:'DELETE' });
    return r.ok;
  } catch(err) {
    console.error('deleteDocument error', err);
    return false;
  }
}

/* ====== X√ÅC TH·ª∞C GI√ÅM KH·∫¢O ====== */
async function verifyJudgeCode(code){
  if(code === ADMIN_CODE) return true;
  
  // Th·ª≠ t√¨m trong collection 'codes' tr∆∞·ªõc
  const doc = await fetchDocument('codes', code);
  if(doc) return true;
  
  // N·∫øu kh√¥ng t√¨m th·∫•y, th·ª≠ t√¨m trong to√†n b·ªô collection
  const list = await fetchCollection('codes', 500);
  if(!list || list.length === 0) return false;
  
  for(const d of list){
    const f = d.fields || {};
    if(f.code && f.code.stringValue === code) return true;
  }
  return false;
}

/* ====== LOGIN + SESSION ====== */
const loginForm = qs('login-form');
const btnAddProject = qs('btn-add-project');
const btnRefresh = qs('refresh-projects');
const btnLogout = qs('btn-logout');
const btnExport = qs('btn-export-data');
const btnShowMyProjects = qs('btn-show-my-projects');

// Ki·ªÉm tra s·ª± t·ªìn t·∫°i c·ªßa ph·∫ßn t·ª≠ tr∆∞·ªõc khi th√™m event listener
if (loginForm) {
  loginForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const code = qs('judgeCodeInput').value.trim();
    const name = qs('judgeNameInput').value.trim();
    if(!code || !name) return showToast('Vui l√≤ng nh·∫≠p m√£ v√† h·ªç t√™n', 'error');
    const loginMsg = qs('login-msg');
    if (loginMsg) {
      loginMsg.style.display = 'block'; 
      loginMsg.textContent = 'ƒêang x√°c th·ª±c...';
    }
    const ok = await verifyJudgeCode(code);
    if(!ok){ 
      if (loginMsg) {
        loginMsg.textContent = 'M√£ kh√¥ng h·ª£p l·ªá'; 
      }
      showToast('M√£ gi√°m kh·∫£o kh√¥ng h·ª£p l·ªá', 'error');
      return; 
    }
    judgeCode = code; judgeName = name; isAdmin = (code === ADMIN_CODE);
    localStorage.setItem('judgeCode', judgeCode); localStorage.setItem('judgeName', judgeName);
    if (loginMsg) loginMsg.style.display = 'none';
    await afterLogin();
    showToast(`ƒêƒÉng nh·∫≠p th√†nh c√¥ng! Ch√†o m·ª´ng ${name}`, 'success');
  });
}

if (btnLogout) {
  btnLogout.addEventListener('click', ()=>{
    localStorage.removeItem('judgeCode'); localStorage.removeItem('judgeName'); 
    showToast('ƒê√£ ƒëƒÉng xu·∫•t', 'info');
    setTimeout(() => location.reload(), 1000);
  });
}

if (btnExport) {
  btnExport.addEventListener('click', exportData);
}

if (btnShowMyProjects) {
  btnShowMyProjects.addEventListener('click', toggleMyProjectsView);
}

async function afterLogin(){
  // show user info and controls
  if (loginForm) loginForm.style.display = 'none';
  show(qs('main-area'));
  const mainArea = qs('main-area');
  if (mainArea) mainArea.classList.remove('login-required');
  
  const judgeNameDisplay = qs('judgeNameDisplay');
  if (judgeNameDisplay) {
    judgeNameDisplay.innerHTML = `<b>${escapeHtml(judgeName)}</b> (${escapeHtml(judgeCode)}) ${isAdmin?'<span class="text-danger">[ADMIN]</span>':''}`;
  }
  
  // C·∫≠p nh·∫≠t hi·ªÉn th·ªã c·ªôt ph√¢n c√¥ng GK
  updateAssignmentColumnVisibility();
  
  // show admin sections only if admin
  if(isAdmin) {
    show(qs('admin-section'));
    show(btnAddProject);
    const adminBadge = qs('admin-badge');
    if (adminBadge) adminBadge.style.display = 'inline';
  }
  
  await loadProjects();
  await loadMyScores();
  if(isAdmin) { 
    await loadAdminScores(); 
    await computeLeaderboard(); 
    await computeLeaderboardIQR(); 
    await updateStatistics();
  }
}

// C·∫≠p nh·∫≠t hi·ªÉn th·ªã c·ªôt ph√¢n c√¥ng GK
function updateAssignmentColumnVisibility() {
  const assignmentHeader = qs('assignment-header');
  if (assignmentHeader) {
    if (isAdmin) {
      assignmentHeader.classList.remove('hide-assignment');
      assignmentHeader.classList.add('show-assignment');
    } else {
      assignmentHeader.classList.remove('show-assignment');
      assignmentHeader.classList.add('hide-assignment');
    }
  }
}

/* restore session if exists */
(function restore(){
  const c = localStorage.getItem('judgeCode');
  const n = localStorage.getItem('judgeName');
  if(c && n){
    judgeCode = c; judgeName = n; isAdmin = (c === ADMIN_CODE);
    afterLogin();
  }
})();

/* ====== PROJECT CRUD & RENDER TABLE ====== */
async function loadProjects(){
  const tbody = qs('projects-tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">ƒêang t·∫£i...</td></tr>';
  const data = await fetchCollection('projects', 2000);
  PROJECTS_MAP.clear();
  if(!data || data.length === 0){
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Ch∆∞a c√≥ d·ª± √°n</td></tr>';
    populateProjectSelects();
    return;
  }
  // build array sorted by order
  const arr = data.map(d=>{
    const id = d.name.split('/').pop();
    const f = d.fields || {};
    const order = Number(f.order?.integerValue || f.order?.stringValue || 0);
    const title = f.title?.stringValue || '';
    const authors = f.authors?.stringValue || '';
    const teacher = f.teacher?.stringValue || '';
    const note = f.note?.stringValue || '';
    PROJECTS_MAP.set(id, { id, order, title, authors, teacher, note });
    return { id, order, title, authors, teacher, note };
  }).sort((a,b)=>a.order - b.order);
  
  // render rows
  renderProjectsTable(arr);
  populateProjectSelects();
}

// H√†m render b·∫£ng d·ª± √°n v·ªõi t√≠nh nƒÉng l·ªçc d·ª± √°n c·∫ßn ch·∫•m
function renderProjectsTable(projects) {
  const tbody = qs('projects-tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  if (projects.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Ch∆∞a c√≥ d·ª± √°n</td></tr>';
    return;
  }
  
  let idx = 0;
  let hasMyProjects = false;
  
  for(const p of projects) {
    // Ki·ªÉm tra xem d·ª± √°n n√†y c√≥ c·∫ßn ch·∫•m b·ªüi gi√°m kh·∫£o hi·ªán t·∫°i kh√¥ng
    const isMyProject = isProjectForMe(p.note);
    
    // N·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô ch·ªâ hi·ªán d·ª± √°n c·∫ßn ch·∫•m v√† d·ª± √°n n√†y kh√¥ng ph·∫£i c·ªßa t√¥i, b·ªè qua
    if (showOnlyMyProjects && !isMyProject) continue;
    
    idx++;
    hasMyProjects = true;
    
    const tr = document.createElement('tr');
    
    // Th√™m class highlight n·∫øu l√† d·ª± √°n c·∫ßn ch·∫•m
    if (isMyProject) {
      tr.classList.add('project-to-score');
    }
    
    // Ch·ªâ hi·ªÉn th·ªã n√∫t s·ª≠a/x√≥a cho admin
    const adminButtons = isAdmin ? 
      `<button class="btn btn-sm btn-warning me-1" onclick="editProject('${p.id}')">S·ª≠a</button>
       <button class="btn btn-sm btn-danger" onclick="deleteProject('${p.id}')">X√≥a</button>` : '';
    
    // X√°c ƒë·ªãnh s·ªë c·ªôt hi·ªÉn th·ªã (5 c·ªôt cho user th∆∞·ªùng, 6 c·ªôt cho admin)
    const colCount = isAdmin ? 6 : 5;
    
    let rowContent = `
      <td class="text-center">${idx}</td>
      <td>${escapeHtml(p.title)}</td>
      <td>${escapeHtml(p.authors)}</td>
      <td>${escapeHtml(p.teacher)}</td>
    `;
    
    // Th√™m c·ªôt ph√¢n c√¥ng GK ch·ªâ cho admin
    if (isAdmin) {
      rowContent += `<td>${escapeHtml(p.note)}</td>`;
    }
    
    rowContent += `
      <td class="text-center">
        <button class="btn btn-sm btn-primary me-1" onclick="openScoreModal_select('${p.id}')">Ch·∫•m</button>
        ${adminButtons}
      </td>
    `;
    
    tr.innerHTML = rowContent;
    tbody.appendChild(tr);
  }
  
  // N·∫øu kh√¥ng c√≥ d·ª± √°n n√†o c·∫ßn ch·∫•m trong ch·∫ø ƒë·ªô l·ªçc
  if (showOnlyMyProjects && !hasMyProjects) {
    const colCount = isAdmin ? 6 : 5;
    tbody.innerHTML = `<tr><td colspan="${colCount}" class="text-center text-muted">Kh√¥ng c√≥ d·ª± √°n n√†o b·∫°n c·∫ßn ch·∫•m</td></tr>`;
  }
}

// H√†m ki·ªÉm tra xem d·ª± √°n c√≥ c·∫ßn ch·∫•m b·ªüi gi√°m kh·∫£o hi·ªán t·∫°i kh√¥ng
function isProjectForMe(note) {
  if (!note || !judgeCode) return false;
  
  // T√°ch c√°c m√£ gi√°m kh·∫£o trong ghi ch√∫ (ph√¢n c√°ch b·∫±ng d·∫•u ph·∫©y)
  const judgeCodesInNote = note.split(',').map(code => code.trim());
  
  // Ki·ªÉm tra xem m√£ gi√°m kh·∫£o hi·ªán t·∫°i c√≥ trong danh s√°ch kh√¥ng
  return judgeCodesInNote.includes(judgeCode);
}

// H√†m chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô hi·ªÉn th·ªã d·ª± √°n c·∫ßn ch·∫•m
function toggleMyProjectsView() {
  showOnlyMyProjects = !showOnlyMyProjects;
  
  if (showOnlyMyProjects) {
    btnShowMyProjects.textContent = 'Hi·ªán t·∫•t c·∫£ d·ª± √°n';
    btnShowMyProjects.classList.remove('btn-info');
    btnShowMyProjects.classList.add('btn-warning');
  } else {
    btnShowMyProjects.textContent = 'Ch·ªâ hi·ªán d·ª± √°n t√¥i c·∫ßn ch·∫•m';
    btnShowMyProjects.classList.remove('btn-warning');
    btnShowMyProjects.classList.add('btn-info');
  }
  
  // T·∫£i l·∫°i danh s√°ch d·ª± √°n v·ªõi b·ªô l·ªçc m·ªõi
  loadProjects();
}

/* Add / Edit project */
const projectForm = qs('project-form');
if (projectForm) {
  projectForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    
    // Ki·ªÉm tra quy·ªÅn admin tr∆∞·ªõc khi th·ª±c hi·ªán thao t√°c
    if (!isAdmin) {
      showToast('Ch·ªâ admin m·ªõi c√≥ quy·ªÅn th√™m/s·ª≠a d·ª± √°n', 'error');
      return;
    }
    
    const order = qs('p-order').value.trim();
    const title = qs('p-title').value.trim();
    const authors = qs('p-authors').value.trim();
    const teacher = qs('p-teacher').value.trim();
    const note = qs('p-note').value.trim();
    if(!order || !title) return showToast('S·ªë th·ª© t·ª± v√† t√™n d·ª± √°n l√† b·∫Øt bu·ªôc', 'error');
    const fields = {
      order: { integerValue: parseInt(order) },
      title: { stringValue: title },
      authors: { stringValue: authors },
      teacher: { stringValue: teacher },
      note: { stringValue: note }
    };
    const editId = projectForm.dataset.editId;
    try{
      let success;
      if(editId){
        success = await patchDocument('projects', editId, { fields });
        if(!success) throw new Error('C·∫≠p nh·∫≠t th·∫•t b·∫°i');
      } else {
        success = await createDocument('projects', { fields });
        if(!success) throw new Error('T·∫°o d·ª± √°n th·∫•t b·∫°i');
      }
      const modal = bootstrap.Modal.getInstance(document.getElementById('projectModal'));
      if (modal) modal.hide();
      await loadProjects();
      showToast('L∆∞u d·ª± √°n th√†nh c√¥ng', 'success');
    }catch(err){ showToast(err.message || 'L·ªói l∆∞u d·ª± √°n', 'error'); }
  });
}

window.editProject = function(id){
  // Ki·ªÉm tra quy·ªÅn admin tr∆∞·ªõc khi th·ª±c hi·ªán thao t√°c
  if (!isAdmin) {
    showToast('Ch·ªâ admin m·ªõi c√≥ quy·ªÅn s·ª≠a d·ª± √°n', 'error');
    return;
  }
  
  const p = PROJECTS_MAP.get(id);
  if(!p) return showToast('D·ª± √°n kh√¥ng t·ªìn t·∫°i', 'error');
  qs('p-order').value = p.order || '';
  qs('p-title').value = p.title || '';
  qs('p-authors').value = p.authors || '';
  qs('p-teacher').value = p.teacher || '';
  qs('p-note').value = p.note || '';
  projectForm.dataset.editId = id;
  new bootstrap.Modal(document.getElementById('projectModal')).show();
};

window.deleteProject = async function(id){
  // Ki·ªÉm tra quy·ªÅn admin tr∆∞·ªõc khi th·ª±c hi·ªán thao t√°c
  if (!isAdmin) {
    showToast('Ch·ªâ admin m·ªõi c√≥ quy·ªÅn x√≥a d·ª± √°n', 'error');
    return;
  }
  
  if(!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a d·ª± √°n n√†y?')) return;
  try{
    const success = await deleteDocument('projects', id);
    if(!success) throw new Error('X√≥a th·∫•t b·∫°i');
    await loadProjects();
    await loadMyScores();
    if(isAdmin) {
      await loadAdminScores(); 
      await computeLeaderboard(); 
      await computeLeaderboardIQR(); 
      await updateStatistics();
    }
    showToast('ƒê√£ x√≥a d·ª± √°n th√†nh c√¥ng', 'success');
  }catch(err){ showToast(err.message || 'L·ªói x√≥a', 'error'); }
};

/* ====== CH·∫§M ƒêI·ªÇM ====== */
function populateProjectSelects(){
  const sel = qs('score-project-select');
  if (!sel) return;
  
  sel.innerHTML = '<option value="">-- Ch·ªçn d·ª± √°n --</option>';
  const arr = [...PROJECTS_MAP.values()].sort((a,b)=>a.order-b.order);
  for(const p of arr){
    const opt = document.createElement('option'); opt.value = p.id;
    opt.textContent = `#${p.order} - ${p.title}`;
    sel.appendChild(opt);
  }
}

// Update total score display in real-time
function updateScoreDisplay() {
  const c1 = Number(qs('score-c1')?.value) || 0;
  const c2 = Number(qs('score-c2')?.value) || 0;
  const c3 = Number(qs('score-c3')?.value) || 0;
  const c4 = Number(qs('score-c4')?.value) || 0;
  const c5 = Number(qs('score-c5')?.value) || 0;
  const c6 = Number(qs('score-c6')?.value) || 0;
  
  const total = c1 + c2 + c3 + c4 + c5 + c6;
  const totalDisplay = qs('score-total-display');
  if (totalDisplay) totalDisplay.textContent = total;
  
  // Update progress bar
  const progressBar = qs('score-progress-bar');
  if (progressBar) {
    progressBar.style.width = `${total}%`;
    progressBar.textContent = `${total}%`;
    
    // Change color based on score
    if (total < 50) {
      progressBar.className = 'progress-bar bg-danger';
    } else if (total < 70) {
      progressBar.className = 'progress-bar bg-warning';
    } else {
      progressBar.className = 'progress-bar bg-success';
    }
  }
}

// Add event listeners to score inputs
['score-c1', 'score-c2', 'score-c3', 'score-c4', 'score-c5', 'score-c6'].forEach(id => {
  const element = qs(id);
  if (element) {
    element.addEventListener('input', updateScoreDisplay);
  }
});

window.openScoreModal_select = function(projectId){
  // Ki·ªÉm tra ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi cho ph√©p ch·∫•m ƒëi·ªÉm
  if (!judgeCode) {
    showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi ch·∫•m ƒëi·ªÉm', 'error');
    return;
  }
  
  populateProjectSelects();
  const select = qs('score-project-select');
  if (select) {
    if(projectId) select.value = projectId;
    else select.value = '';
  }
  // reset fields
  const resetField = (id) => { const el = qs(id); if (el) el.value = 0; };
  resetField('score-c1'); resetField('score-c2'); resetField('score-c3');
  resetField('score-c4'); resetField('score-c5'); resetField('score-c6');
  const noteField = qs('score-note');
  if (noteField) noteField.value = '';
  updateScoreDisplay(); // Initialize the display
  const scoreForm = qs('score-form');
  if (scoreForm) delete scoreForm.dataset.editScoreId;
  new bootstrap.Modal(document.getElementById('scoreModal')).show();
};

/* t√¨m document ƒëi·ªÉm n·∫øu gi√°m kh·∫£o ƒë√£ ch·∫•m (tr·∫£ v·ªÅ docId + fields) */
async function findScoreDoc(projectId, judgeCodeLocal){
  const scores = await fetchCollection('scores_khkt', 5000);
  if(!scores || scores.length === 0) return null;
  for(const d of scores){
    const id = d.name.split('/').pop();
    const f = d.fields || {};
    if(f.projectId?.stringValue === projectId && f.judgeCode?.stringValue === judgeCodeLocal){
      return { docId: id, fields: f };
    }
  }
  return null;
}

const scoreForm = qs('score-form');
if (scoreForm) {
  scoreForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!judgeCode) return showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p gi√°m kh·∫£o tr∆∞·ªõc khi ch·∫•m', 'error');
    const pid = qs('score-project-select')?.value;
    if(!pid) return showToast('Vui l√≤ng ch·ªçn d·ª± √°n', 'error');
    // read criteria
    const c1 = Number(qs('score-c1')?.value)||0;
    const c2 = Number(qs('score-c2')?.value)||0;
    const c3 = Number(qs('score-c3')?.value)||0;
    const c4 = Number(qs('score-c4')?.value)||0;
    const c5 = Number(qs('score-c5')?.value)||0;
    const c6 = Number(qs('score-c6')?.value)||0;
    // validate
    if(c1<0||c1>10||c2<0||c2>15||c3<0||c3>20||c4<0||c4>20||c5<0||c5>10||c6<0||c6>25){
      return showToast('M·ªôt ho·∫∑c nhi·ªÅu ƒëi·ªÉm kh√¥ng h·ª£p l·ªá', 'error');
    }
    try{
      const existing = await findScoreDoc(pid, judgeCode);
      const total = c1 + c2 + c3 + c4 + c5 + c6;
      const fields = {
        projectId:{ stringValue: pid },
        judgeCode:{ stringValue: judgeCode },
        judgeName:{ stringValue: judgeName },
        c1:{ doubleValue: c1 },
        c2:{ doubleValue: c2 },
        c3:{ doubleValue: c3 },
        c4:{ doubleValue: c4 },
        c5:{ doubleValue: c5 },
        c6:{ doubleValue: c6 },
        total:{ doubleValue: total },
        note:{ stringValue: qs('score-note')?.value || '' },
        createdAt:{ timestampValue: new Date().toISOString() }
      };
      let success;
      if(existing){
        success = await patchDocument('scores_khkt', existing.docId, { fields });
        if(!success) throw new Error('C·∫≠p nh·∫≠t ƒëi·ªÉm th·∫•t b·∫°i');
      } else {
        success = await createDocument('scores_khkt', { fields });
        if(!success) throw new Error('G·ª≠i ƒëi·ªÉm th·∫•t b·∫°i - c√≥ th·ªÉ collection scores_khkt ch∆∞a ƒë∆∞·ª£c t·∫°o');
      }
      const modal = bootstrap.Modal.getInstance(document.getElementById('scoreModal'));
      if (modal) modal.hide();
      showToast('G·ª≠i ƒëi·ªÉm th√†nh c√¥ng', 'success');
      await loadMyScores();
      if(isAdmin){ 
        await loadAdminScores(); 
        await computeLeaderboard(); 
        await computeLeaderboardIQR(); 
        await updateStatistics();
      }
    }catch(err){ showToast(err.message || 'L·ªói khi g·ª≠i ƒëi·ªÉm', 'error'); }
  });
}

/* ch·∫•m l·∫°i ‚Äî preload n·∫øu c√≥ */
async function prefillScoreForEdit(projectId){
  if(!judgeCode) return showToast('ƒêƒÉng nh·∫≠p tr∆∞·ªõc', 'error');
  const rec = await findScoreDoc(projectId, judgeCode);
  populateProjectSelects();
  const select = qs('score-project-select');
  if (select) select.value = projectId;
  if(rec && rec.fields){
    const f = rec.fields;
    const setField = (id, value) => { const el = qs(id); if (el) el.value = value || 0; };
    setField('score-c1', f.c1?.doubleValue || f.c1?.integerValue);
    setField('score-c2', f.c2?.doubleValue || f.c2?.integerValue);
    setField('score-c3', f.c3?.doubleValue || f.c3?.integerValue);
    setField('score-c4', f.c4?.doubleValue || f.c4?.integerValue);
    setField('score-c5', f.c5?.doubleValue || f.c5?.integerValue);
    setField('score-c6', f.c6?.doubleValue || f.c6?.integerValue);
    const noteField = qs('score-note');
    if (noteField) noteField.value = f.note?.stringValue || '';
  } else {
    const resetField = (id) => { const el = qs(id); if (el) el.value = 0; };
    resetField('score-c1'); resetField('score-c2'); resetField('score-c3');
    resetField('score-c4'); resetField('score-c5'); resetField('score-c6');
    const noteField = qs('score-note');
    if (noteField) noteField.value = '';
  }
  updateScoreDisplay();
  new bootstrap.Modal(document.getElementById('scoreModal')).show();
}
window.prefillScoreForEdit = prefillScoreForEdit;

/* ====== DANH S√ÅCH D·ª∞ √ÅN GI√ÅM KH·∫¢O ƒê√É CH·∫§M (CHI TI·∫æT) ====== */
async function loadMyScores(){
  const tbody = qs('myScores-tbody');
  if (!tbody) return;
  
  if(!judgeCode){ tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted">ƒêƒÉng nh·∫≠p ƒë·ªÉ xem</td></tr>'; return; }
  const scoresData = await fetchCollection('scores_khkt', 5000);
  
  // N·∫øu kh√¥ng c√≥ quy·ªÅn truy c·∫≠p scores_khkt, hi·ªÉn th·ªã th√¥ng b√°o
  if(scoresData && scoresData.length === 0){ 
    tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted">B·∫°n ch∆∞a ch·∫•m d·ª± √°n n√†o ho·∫∑c kh√¥ng c√≥ quy·ªÅn truy c·∫≠p d·ªØ li·ªáu ƒëi·ªÉm</td></tr>'; 
    return; 
  }
  
  // map projects for titles
  const projData = await fetchCollection('projects', 2000);
  const projMap = new Map();
  if(projData && projData.length > 0) for(const d of projData){ projMap.set(d.name.split('/').pop(), d.fields?.title?.stringValue || '(Kh√¥ng t√™n)'); }
  // filter scores by judgeCode
  const mine = [];
  for(const d of scoresData){
    const f = d.fields || {};
    if(f.judgeCode?.stringValue !== judgeCode) continue;
    mine.push(f);
  }
  if(mine.length === 0){ tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted">B·∫°n ch∆∞a ch·∫•m d·ª± √°n n√†o</td></tr>'; return; }
  // render rows sorted by project's order
  // build map project order
  const orderMap = new Map();
  if(projData && projData.length > 0) for(const d of projData){ const id=d.name.split('/').pop(); orderMap.set(id, Number(d.fields?.order?.integerValue||d.fields?.order?.stringValue||0)); }
  // attach project title and order
  const rows = mine.map(f => {
    const pid = f.projectId?.stringValue || '';
    return {
      pid,
      title: projMap.get(pid) || '(Kh√¥ng t√™n)',
      createdAt: f.createdAt?.timestampValue || '',
      c1: Number(f.c1?.doubleValue||f.c1?.integerValue||0),
      c2: Number(f.c2?.doubleValue||f.c2?.integerValue||0),
      c3: Number(f.c3?.doubleValue||f.c3?.integerValue||0),
      c4: Number(f.c4?.doubleValue||f.c4?.integerValue||0),
      c5: Number(f.c5?.doubleValue||f.c5?.integerValue||0),
      c6: Number(f.c6?.doubleValue||f.c6?.integerValue||0),
      total: Number(f.total?.doubleValue||f.total?.integerValue||0),
      note: f.note?.stringValue || '',
      order: orderMap.get(pid) || 0
    };
  }).sort((a,b)=> a.order - b.order);
  // render tbody
  tbody.innerHTML = '';
  let i=0;
  for(const r of rows){
    i++;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="text-center">${i}</td>
      <td>${escapeHtml(r.title)}</td>
      <td class="text-center">${r.c1.toFixed(1)}</td>
      <td class="text-center">${r.c2.toFixed(1)}</td>
      <td class="text-center">${r.c3.toFixed(1)}</td>
      <td class="text-center">${r.c4.toFixed(1)}</td>
      <td class="text-center">${r.c5.toFixed(1)}</td>
      <td class="text-center">${r.c6.toFixed(1)}</td>
      <td class="text-center fw-bold">${r.total.toFixed(1)}</td>
      <td>${escapeHtml(r.note)}</td>
      <td class="text-center"><button class="btn btn-sm btn-outline-primary" onclick="prefillScoreForEdit('${r.pid}')">Ch·∫•m l·∫°i</button></td>
    `;
    tbody.appendChild(tr);
  }
}

/* ====== ADMIN: B·∫¢NG CH·∫§M T·∫§T C·∫¢ GI√ÅM KH·∫¢O (CHI TI·∫æT + TB) ====== */
async function loadAdminScores(){
  const tbody = qs('adminScores-tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted">ƒêang t·∫£i...</td></tr>';
  const [projData, scoreData] = await Promise.all([ fetchCollection('projects', 2000), fetchCollection('scores_khkt', 5000) ]);
  
  // N·∫øu kh√¥ng c√≥ ƒëi·ªÉm, hi·ªÉn th·ªã th√¥ng b√°o
  if(!scoreData || scoreData.length === 0){ 
    tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted">Ch∆∞a c√≥ ƒëi·ªÉm ho·∫∑c kh√¥ng c√≥ quy·ªÅn truy c·∫≠p d·ªØ li·ªáu ƒëi·ªÉm</td></tr>'; 
    return; 
  }
  
  const projMap = new Map();
  if(projData && projData.length > 0) for(const d of projData){ const id=d.name.split('/').pop(); projMap.set(id, { title: d.fields?.title?.stringValue || '(Kh√¥ng t√™n)', order: Number(d.fields?.order?.integerValue || d.fields?.order?.stringValue || 0) }); }
  // assemble rows
  const rows = [];
  for(const d of scoreData){
    const f = d.fields || {}; const pid = f.projectId?.stringValue || '';
    const proj = projMap.get(pid) || { title: '(Kh√¥ng t√™n)', order: 0 };
    const c1 = Number(f.c1?.doubleValue||f.c1?.integerValue||0);
    const c2 = Number(f.c2?.doubleValue||f.c2?.integerValue||0);
    const c3 = Number(f.c3?.doubleValue||f.c3?.integerValue||0);
    const c4 = Number(f.c4?.doubleValue||f.c4?.integerValue||0);
    const c5 = Number(f.c5?.doubleValue||f.c5?.integerValue||0);
    const c6 = Number(f.c6?.doubleValue||f.c6?.integerValue||0);
    const total = Number(f.total?.doubleValue||f.total?.integerValue||0);
    rows.push({
      order: proj.order, title: proj.title,
      pid,
      jcode: f.judgeCode?.stringValue || '',
      jname: f.judgeName?.stringValue || '',
      c1, c2, c3, c4, c5, c6, total
    });
  }
  // sort by project order then by project id
  rows.sort((a,b)=> (a.order - b.order) || (a.title.localeCompare(b.title)));
  // render
  tbody.innerHTML = '';
  let i=0;
  for(const r of rows){
    i++;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="text-center">${i}</td>
      <td class="text-center">${r.order}</td>
      <td>${escapeHtml(r.title)}</td>
      <td class="text-center">${escapeHtml(r.jcode)}</td>
      <td>${escapeHtml(r.jname)}</td>
      <td class="text-center">${r.c1.toFixed(1)}</td>
      <td class="text-center">${r.c2.toFixed(1)}</td>
      <td class="text-center">${r.c3.toFixed(1)}</td>
      <td class="text-center">${r.c4.toFixed(1)}</td>
      <td class="text-center">${r.c5.toFixed(1)}</td>
      <td class="text-center">${r.c6.toFixed(1)}</td>
      <td class="text-center fw-bold">${r.total.toFixed(1)}</td>
    `;
    tbody.appendChild(tr);
  }
}

/* ====== B·∫¢NG X·∫æP H·∫†NG THEO ƒêI·ªÇM TRUNG B√åNH ====== */
async function computeLeaderboard(){
  const tbody = qs('leaderboard-tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ƒêang t·∫£i...</td></tr>';
  const [projData, scoreData] = await Promise.all([ fetchCollection('projects', 2000), fetchCollection('scores_khkt', 5000) ]);
  if(!projData || projData.length === 0){ tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ d·ª± √°n</td></tr>'; return; }
  // proj map
  const projMap = {}; // pid -> {title, order}
  projData.forEach(d=>{ const id = d.name.split('/').pop(); projMap[id] = { title: d.fields?.title?.stringValue || '(Kh√¥ng t√™n)', order: Number(d.fields?.order?.integerValue || d.fields?.order?.stringValue || 0) }; });
  // aggregate
  const agg = {}; // pid -> {sum, cnt}
  if(scoreData && scoreData.length > 0){
    for(const d of scoreData){
      const f = d.fields || {}; const pid = f.projectId?.stringValue; if(!pid) continue;
      const total = Number(f.total?.doubleValue || f.total?.integerValue || 0);
      if(!agg[pid]) agg[pid] = { sum:0, cnt:0 };
      agg[pid].sum += total; agg[pid].cnt++;
    }
  }
  // build list
  const list = [];
  for(const pid in projMap){
    const info = projMap[pid];
    const sum = agg[pid]?.sum || 0;
    const cnt = agg[pid]?.cnt || 0;
    const avg = cnt ? (sum / cnt) : 0;
    list.push({ pid, order: info.order, title: info.title, cnt, avg });
  }
  // sort by avg desc
  list.sort((a,b)=> b.avg - a.avg || a.order - b.order);
  // Store for comparison
  leaderboardData = [...list];
  
  // render
  tbody.innerHTML = '';
  list.forEach((it,i) => {
    const tr = document.createElement('tr');
    // Add medal classes for top 3
    let rankClass = '';
    if (i === 0) rankClass = 'medal-gold';
    else if (i === 1) rankClass = 'medal-silver';
    else if (i === 2) rankClass = 'medal-bronze';
    
    tr.innerHTML = `
      <td class="text-center ${rankClass}">${i+1}</td>
      <td class="text-center">${it.order}</td>
      <td>${escapeHtml(it.title)}</td>
      <td class="text-center">${it.cnt}</td>
      <td class="text-center fw-bold text-success">${it.avg.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ====== B·∫¢NG X·∫æP H·∫†NG SAU KHI L·ªåC NGO·∫†I L·ªÜ (IQR) ====== */
function quantile(sortedArr, q){
  if(!sortedArr.length) return 0;
  const pos = (sortedArr.length - 1) * q;
  const base = Math.floor(pos);
  const rest = pos - base;
  if(base + 1 < sortedArr.length) return sortedArr[base] + (sortedArr[base+1] - sortedArr[base]) * rest;
  return sortedArr[base];
}

async function computeLeaderboardIQR(){
  const tbody = qs('iqrLeaderboard-tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">ƒêang t√≠nh to√°n IQR...</td></tr>';
  const [projData, scoreData] = await Promise.all([ fetchCollection('projects', 2000), fetchCollection('scores_khkt', 5000) ]);
  if(!projData || projData.length === 0){ tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>'; return; }
  
  const pMap = {}; 
  projData.forEach(d => { 
    const id = d.name.split('/').pop(); 
    pMap[id] = { 
      title: d.fields?.title?.stringValue || '(Kh√¥ng t√™n)', 
      order: Number(d.fields?.order?.integerValue || d.fields?.order?.stringValue || 0) 
    }; 
  });
  
  const totalsByPid = {};
  if(scoreData && scoreData.length > 0) scoreData.forEach(d => { 
    const f = d.fields || {}; 
    const pid = f.projectId?.stringValue; 
    if(!pid) return; 
    if(!totalsByPid[pid]) totalsByPid[pid] = []; 
    totalsByPid[pid].push(Number(f.total?.doubleValue || 0)); 
  });
  
  const results = [];
  let totalOutliers = 0;
  
  for(const pid in pMap){
    const arr = (totalsByPid[pid] || []).slice();
    if(arr.length === 0){ 
      results.push({ 
        pid, 
        order: pMap[pid].order, 
        title: pMap[pid].title, 
        totalCount: 0,
        validCount:0, 
        avg:0,
        outlierCount: 0,
        regularRank: null
      }); 
      continue; 
    }
    
    arr.sort((a,b)=>a-b);
    const Q1 = quantile(arr, 0.25), Q3 = quantile(arr, 0.75);
    const IQR = Q3 - Q1;
    const lowerBound = Q1 - 1.5 * IQR, upperBound = Q3 + 1.5 * IQR;
    const filtered = arr.filter(score => score >= lowerBound && score <= upperBound);
    
    // Count outliers
    const outlierCount = arr.length - filtered.length;
    totalOutliers += outlierCount;
    
    // T√≠nh ƒëi·ªÉm trung b√¨nh (sau khi l·ªçc)
    let avg;
    if(filtered.length >= 2) {
      avg = filtered.reduce((sum, score) => sum + score, 0) / filtered.length;
    } else {
      // N·∫øu kh√¥ng ƒë·ªß ƒëi·ªÉm h·ª£p l·ªá, d√πng t·∫•t c·∫£ ƒëi·ªÉm
      avg = arr.reduce((sum, score) => sum + score, 0) / arr.length;
    }
    
    // T√¨m h·∫°ng trong b·∫£ng x·∫øp h·∫°ng th∆∞·ªùng
    const regularRank = leaderboardData.findIndex(item => item.pid === pid);
    
    results.push({
      pid, 
      order: pMap[pid].order, 
      title: pMap[pid].title, 
      totalCount: arr.length,
      validCount: filtered.length, 
      avg: avg,
      outlierCount: outlierCount,
      regularRank: regularRank >= 0 ? regularRank + 1 : null
    });
  }
  
  // Sort by IQR average
  results.sort((a,b) => b.avg - a.avg || a.order - b.order);
  iqrData = [...results];
  
  // render
  tbody.innerHTML = '';
  results.forEach((r,i) => {
    // T√≠nh thay ƒë·ªïi h·∫°ng
    let changeIndicator = "";
    if (r.regularRank !== null) {
      const change = r.regularRank - (i + 1);
      if (change > 0) {
        changeIndicator = `<span class="text-success">‚Üë+${change}</span>`;
      } else if (change < 0) {
        changeIndicator = `<span class="text-danger">‚Üì${change}</span>`;
      } else {
        changeIndicator = `<span class="text-muted">-</span>`;
      }
    }
    
    // Th√™m class highlight cho d·ª± √°n c√≥ ngo·∫°i l·ªá
    const rowClass = r.outlierCount > 0 ? "highlight-row" : "";
    
    // Th√™m huy ch∆∞∆°ng cho top 3
    let rankClass = "";
    if (i === 0) rankClass = "medal-gold";
    else if (i === 1) rankClass = "medal-silver";
    else if (i === 2) rankClass = "medal-bronze";
    
    const tr = document.createElement('tr');
    tr.className = rowClass;
    tr.innerHTML = `
      <td class="text-center ${rankClass}">${i+1}</td>
      <td class="text-center">${r.order}</td>
      <td>${escapeHtml(r.title)}</td>
      <td class="text-center">${r.totalCount}</td>
      <td class="text-center">${r.validCount} ${r.outlierCount > 0 ? `<small class="text-danger">(-${r.outlierCount})</small>` : ""}</td>
      <td class="text-center fw-bold text-primary">${r.avg.toFixed(2)}</td>
      <td class="text-center">${changeIndicator}</td>
    `;
    tbody.appendChild(tr);
  });
  
  // C·∫≠p nh·∫≠t th·ªëng k√™
  await updateStatistics(totalOutliers);
}

/* ====== TH·ªêNG K√ä ====== */
async function updateStatistics(totalOutliers = 0) {
  if (!isAdmin) return;
  
  const [projects, scores] = await Promise.all([
    fetchCollection("projects"),
    fetchCollection("scores_khkt")
  ]);
  
  // ƒê·∫øm s·ªë gi√°m kh·∫£o duy nh·∫•t
  const judges = new Set();
  scores?.forEach(doc => {
    const judgeCode = doc.fields?.judgeCode?.stringValue;
    if (judgeCode) judges.add(judgeCode);
  });
  
  // C·∫≠p nh·∫≠t UI
  const updateStat = (id, value) => { const el = qs(id); if (el) el.textContent = value; };
  updateStat("total-projects", projects?.length || 0);
  updateStat("total-scores", scores?.length || 0);
  updateStat("total-judges", judges.size);
  updateStat("outliers-removed", totalOutliers);
}

/* ====== XU·∫§T D·ªÆ LI·ªÜU ====== */
async function exportData() {
  if (!isAdmin) {
    showToast("Ch·ªâ admin m·ªõi c√≥ quy·ªÅn xu·∫•t d·ªØ li·ªáu", 'error');
    return;
  }
  
  try {
    const [projects, scores] = await Promise.all([
      fetchCollection("projects"),
      fetchCollection("scores_khkt")
    ]);
    
    if (!projects || projects.length === 0) {
      showToast("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t", 'error');
      return;
    }
    
    // T·∫°o n·ªôi dung CSV
    let csvContent = "DANH S√ÅCH D·ª∞ √ÅN KHKT\n";
    csvContent += "STT,T√™n d·ª± √°n,Nh√≥m t√°c gi·∫£,Gi√°o vi√™n h∆∞·ªõng d·∫´n,Ph√¢n c√¥ng GK\n";
    
    projects.forEach(project => {
      const fields = project.fields;
      csvContent += `"${fields.order?.integerValue || ''}","${fields.title?.stringValue || ''}","${fields.authors?.stringValue || ''}","${fields.teacher?.stringValue || ''}","${fields.note?.stringValue || ''}"\n`;
    });
    
    csvContent += "\n\nDANH S√ÅCH ƒêI·ªÇM CH·∫§M\n";
    csvContent += "STT,T√™n d·ª± √°n,M√£ GK,T√™n GK,C√¢u h·ªèi NC,Thi·∫øt k·∫ø & PP,Th·ª±c hi·ªán NC,S√°ng t·∫°o,Poster,Ph·ªèng v·∫•n,T·ªïng ƒëi·ªÉm,Nh·∫≠n x√©t\n";
    
    // T·∫°o map d·ª± √°n
    const projectMap = new Map();
    projects.forEach(doc => {
      const id = doc.name.split('/').pop();
      projectMap.set(id, {
        order: doc.fields.order?.integerValue || "",
        title: doc.fields.title?.stringValue || ""
      });
    });
    
    // Th√™m ƒëi·ªÉm
    scores?.forEach(doc => {
      const fields = doc.fields;
      const projectId = fields.projectId?.stringValue;
      const project = projectMap.get(projectId) || { order: "?", title: "Kh√¥ng x√°c ƒë·ªãnh" };
      
      csvContent += `"${project.order}","${project.title}","${fields.judgeCode?.stringValue || ''}","${fields.judgeName?.stringValue || ''}",`;
      csvContent += `"${fields.c1?.doubleValue || 0}","${fields.c2?.doubleValue || 0}","${fields.c3?.doubleValue || 0}",`;
      csvContent += `"${fields.c4?.doubleValue || 0}","${fields.c5?.doubleValue || 0}","${fields.c6?.doubleValue || 0}",`;
      csvContent += `"${fields.total?.doubleValue || 0}","${fields.note?.stringValue || ''}"\n`;
    });
    
    // T·∫°o v√† t·∫£i file
    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `KHKT_Scores_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast("D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c xu·∫•t th√†nh c√¥ng", 'success');
  } catch (error) {
    console.error("L·ªói xu·∫•t d·ªØ li·ªáu:", error);
    showToast("L·ªói khi xu·∫•t d·ªØ li·ªáu", 'error');
  }
}

/* ====== EVENTS cho N√∫t refresh, add project ====== */
if (btnRefresh) {
  btnRefresh.addEventListener('click', async ()=>{ 
    await loadProjects(); 
    await loadMyScores(); 
    if(isAdmin){ 
      await loadAdminScores(); 
      await computeLeaderboard(); 
      await computeLeaderboardIQR(); 
      await updateStatistics();
    }
    showToast('ƒê√£ l√†m m·ªõi d·ªØ li·ªáu', 'success');
  });
}

if (btnAddProject) {
  btnAddProject.addEventListener('click', ()=>{ 
    // Ki·ªÉm tra quy·ªÅn admin tr∆∞·ªõc khi cho ph√©p th√™m d·ª± √°n
    if (!isAdmin) {
      showToast('Ch·ªâ admin m·ªõi c√≥ quy·ªÅn th√™m d·ª± √°n', 'error');
      return;
    }
    projectForm.reset(); 
    delete projectForm.dataset.editId; 
    new bootstrap.Modal(document.getElementById('projectModal')).show(); 
  });
}
</script>
</body>
</html>
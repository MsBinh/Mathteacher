<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üî• Qu·∫£n l√Ω & C·∫•p m√£ h·ªçc sinh (Firestore)</title>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: linear-gradient(135deg, #1e293b, #0f172a);
    color: #fff;
    margin: 0; padding: 0;
  }
  header {
    background: rgba(0,0,0,0.4);
    padding: 12px 16px;
    text-align: center;
    font-size: 1.4em;
    letter-spacing: 0.5px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  main {
    max-width: 900px;
    margin: 20px auto;
    background: rgba(255,255,255,0.08);
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
  }
  h2 {
    color: #38bdf8;
    border-left: 4px solid #38bdf8;
    padding-left: 8px;
  }
  textarea, input {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: none;
    outline: none;
    font-size: 1em;
    margin-bottom: 12px;
  }
  textarea {
    height: 80px;
    resize: vertical;
  }
  button {
    background: #38bdf8;
    border: none;
    padding: 10px 18px;
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1em;
  }
  button:hover { background: #0ea5e9; }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
  }
  th, td {
    padding: 8px 10px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    text-align: left;
  }
  th {
    background: rgba(255,255,255,0.1);
  }
  .danger {
    background: #ef4444;
  }
  .danger:hover {
    background: #dc2626;
  }
  .info-box {
    background: rgba(255,255,255,0.06);
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 16px;
    font-size: 0.95em;
    line-height: 1.5em;
  }
  footer {
    text-align: center;
    font-size: 0.9em;
    color: rgba(255,255,255,0.6);
    margin: 20px 0;
  }
</style>
</head>
<body>

<header>‚öôÔ∏è Qu·∫£n l√Ω & C·∫•p m√£ h·ªçc sinh (Firebase Firestore)</header>
<main>
  <h2>1Ô∏è‚É£ Nh·∫≠p th√¥ng tin Firebase c·ªßa b·∫°n</h2>
  <div class="info-box">
    <p>üëâ ƒêƒÉng nh·∫≠p <b>Firebase Console ‚Üí Project ‚Üí C√†i ƒë·∫∑t ‚Üí General ‚Üí Config</b> v√† d√°n v√†o ƒë√¢y:</p>
  </div>
  <input id="apiKey" placeholder="apiKey" />
  <input id="authDomain" placeholder="authDomain" />
  <input id="projectId" placeholder="projectId" />

  <button id="connectBtn">üîó K·∫øt n·ªëi Firebase</button>

  <div id="appSection" style="display:none;">
    <h2>2Ô∏è‚É£ C·∫•p m√£ h·ªçc sinh</h2>
    <textarea id="codeInput" placeholder="Nh·∫≠p 1 ho·∫∑c nhi·ªÅu m√£ h·ªçc sinh, c√°ch nhau b·∫±ng d·∫•u ph·∫©y ho·∫∑c xu·ªëng d√≤ng..."></textarea>
    <input id="nameInput" placeholder="T√™n h·ªçc sinh (t√πy ch·ªçn, s·∫Ω √°p d·ª•ng cho t·∫•t c·∫£ m√£ nh·∫≠p)" />
    <button id="addCodeBtn">‚ûï Th√™m m√£</button>

    <h2>3Ô∏è‚É£ Danh s√°ch m√£ hi·ªán c√≥</h2>
    <div id="codeList"><em>Ch∆∞a k·∫øt n·ªëi...</em></div>
  </div>

  <h2>üìò H∆∞·ªõng d·∫´n quy tr√¨nh chi ti·∫øt</h2>
  <div class="info-box">
    <ol>
      <li>V√†o <a href="https://console.firebase.google.com" target="_blank" style="color:#38bdf8;">Firebase Console</a>, t·∫°o project (n·∫øu ch∆∞a c√≥).</li>
      <li>Ch·ªçn menu <b>Firestore Database</b> ‚Üí nh·∫•n ‚ÄúCreate database‚Äù.</li>
      <li>T·∫°o collection <code>codes</code> (d√πng ƒë·ªÉ l∆∞u m√£ h·ªçc sinh).</li>
      <li>T·∫°o collection <code>attempts</code> (d√πng ƒë·ªÉ l∆∞u k·∫øt qu·∫£ l√†m b√†i).</li>
      <li>V√†o tab <b>Rules</b> ‚Üí D√°n quy t·∫Øc sau v√† nh·∫•n ‚ÄúPublish‚Äù:
        <pre style="background:#0f172a;color:#38bdf8;padding:10px;border-radius:8px;">
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /codes/{codeId} {
      allow read: if true;
      allow write: if true;
    }
    match /attempts/{docId} {
      allow read: if true;
      allow write: if request.resource.data.code is string
                   && exists(/databases/$(database)/documents/codes/$(request.resource.data.code));
    }
  }
}
        </pre>
      </li>
      <li>Sau khi ƒë√£ nh·∫≠p xong m√£ h·ªçc sinh, b·∫°n c√≥ th·ªÉ s·ª≠a ph·∫ßn <code>allow write: if true</code> c·ªßa <b>/codes</b> th√†nh <code>false</code> ƒë·ªÉ kh√≥a danh s√°ch m√£.</li>
    </ol>
  </div>
</main>

<footer>¬© 2025 - Trang qu·∫£n l√Ω m√£ h·ªçc sinh | T√≠ch h·ª£p Firebase Firestore</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

let db = null;

document.getElementById("connectBtn").addEventListener("click", () => {
  const apiKey = document.getElementById("apiKey").value.trim();
  const authDomain = document.getElementById("authDomain").value.trim();
  const projectId = document.getElementById("projectId").value.trim();
  if (!apiKey || !authDomain || !projectId) return alert("‚ö†Ô∏è Nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin Firebase!");

  const firebaseConfig = { apiKey, authDomain, projectId };
  const app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  document.getElementById("appSection").style.display = "block";
  loadCodes();
});

// ===== TH√äM M√É H·ªåC SINH =====
document.getElementById("addCodeBtn").addEventListener("click", async () => {
  if (!db) return alert("‚ö†Ô∏è K·∫øt n·ªëi Firebase tr∆∞·ªõc ƒë√£!");
  const codesText = document.getElementById("codeInput").value.trim();
  if (!codesText) return alert("‚ö†Ô∏è Nh·∫≠p √≠t nh·∫•t m·ªôt m√£!");
  const lines = codesText.split(/\n|,/).map(s => s.trim()).filter(Boolean);
  const name = document.getElementById("nameInput").value.trim() || null;

  for (const c of lines) {
    await addDoc(collection(db, "codes"), {
      code: c,
      name: name,
      createdAt: serverTimestamp()
    });
  }

  alert(`‚úÖ ƒê√£ th√™m ${lines.length} m√£ h·ªçc sinh.`);
  document.getElementById("codeInput").value = "";
  document.getElementById("nameInput").value = "";
  loadCodes();
});

// ===== HI·ªÇN TH·ªä DANH S√ÅCH M√É =====
async function loadCodes() {
  if (!db) return;
  const listDiv = document.getElementById("codeList");
  listDiv.innerHTML = "<em>ƒêang t·∫£i...</em>";
  const snapshot = await getDocs(collection(db, "codes"));
  let html = `<table><tr><th>M√£ h·ªçc sinh</th><th>T√™n</th><th>X√≥a</th></tr>`;
  snapshot.forEach(docSnap => {
    const d = docSnap.data();
    html += `<tr>
      <td>${d.code}</td>
      <td>${d.name || ""}</td>
      <td><button class="danger" onclick="deleteCode('${docSnap.id}')">‚ùå</button></td>
    </tr>`;
  });
  html += "</table>";
  listDiv.innerHTML = html;
}

// ===== XO√Å M√É =====
window.deleteCode = async function(id) {
  if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√£ n√†y kh√¥ng?")) return;
  await deleteDoc(doc(db, "codes", id));
  loadCodes();
};
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“Š Quáº£n lÃ½ káº¿t quáº£ há»c sinh</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background:#f5f7fa; padding:20px; font-family:Arial, sans-serif; }
    h2 { margin-bottom:20px; text-align:center; }
    table { font-size:14px; }
    th { background:#34495e; color:white; text-align:center; }
    td { text-align:center; vertical-align:middle; }
    .btn { border-radius:8px; padding:6px 14px; }
    #filterInput { width:200px; display:inline-block; margin-right:10px; }
    .delete-row { color:red; cursor:pointer; font-weight:bold; }
  </style>
</head>
<body>
  <h2>ğŸ“Š Quáº£n lÃ½ káº¿t quáº£ há»c sinh</h2>

  <div class="mb-3 text-center">
    <input id="filterInput" class="form-control d-inline-block" placeholder="Nháº­p mÃ£ lá»›p (code)...">
    <button id="filterBtn" class="btn btn-primary">ğŸ” Lá»c</button>
    <button id="loadBtn" class="btn btn-success">ğŸ”„ LÃ m má»›i</button>
    <button id="exportBtn" class="btn btn-warning">ğŸ“¤ Xuáº¥t Excel</button>
    <button id="deleteAllBtn" class="btn btn-danger">ğŸ—‘ï¸ XoÃ¡ táº¥t cáº£</button>
  </div>

  <table class="table table-bordered table-striped align-middle">
    <thead>
      <tr>
        <th>#</th>
        <th>MÃ£ lá»›p</th>
        <th>Há» tÃªn</th>
        <th>Äá»</th>
        <th>Äiá»ƒm</th>
        <th>Thá»i gian</th>
        <th>XoÃ¡</th>
      </tr>
    </thead>
    <tbody id="resultsBody"></tbody>
  </table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDDACFZgZazMOnjzmGM_lrKswVcsoTFHxA",
  authDomain: "veonline-3bcbf.firebaseapp.com",
  projectId: "veonline-3bcbf"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ========== HIá»‚N THá»Š Dá»® LIá»†U ==========
async function loadResults(filterCode = "") {
  const body = document.getElementById("resultsBody");
  body.innerHTML = "<tr><td colspan='10'>â³ Äang táº£i dá»¯ liá»‡u...</td></tr>";

  const snap = await getDocs(collection(db, "attempts"));
  const rows = [];

  snap.forEach(docSnap => {
    const d = docSnap.data();
    const code = d.code || "";
    const name = d.name || "";
    const testId = d.testId || "";
    const score = d.score || "";
    const createdAt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
    const timeStr = createdAt ? createdAt.toLocaleString("vi-VN") : "";
    const id = docSnap.id;

    if (!filterCode || code.toLowerCase().includes(filterCode.toLowerCase())) {
      rows.push({ id, code, name, testId, score, createdAt, timeStr });
    }
  });

  // Sáº¯p xáº¿p theo thá»i gian (má»›i nháº¥t â†’ cÅ© nháº¥t)
  rows.sort((a, b) => (b.createdAt?.getTime() || 0) - (a.createdAt?.getTime() || 0));

  // Hiá»ƒn thá»‹
  if (rows.length === 0) {
    body.innerHTML = "<tr><td colspan='10'>âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u</td></tr>";
    return;
  }

  body.innerHTML = rows.map((r, i) => `
    <tr data-id="${r.id}">
      <td>${i + 1}</td>
      <td>${r.code}</td>
      <td>${r.name}</td>
      <td>${r.testId}</td>
      <td>${r.score}</td>
      <td>${r.timeStr}</td>
      <td><span class="delete-row" title="XoÃ¡ bÃ i nÃ y">âœ–</span></td>
    </tr>
  `).join("");

  // ThÃªm sá»± kiá»‡n xoÃ¡ tá»«ng hÃ ng
  document.querySelectorAll(".delete-row").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const tr = e.target.closest("tr");
      const id = tr.getAttribute("data-id");
      const name = tr.children[2].textContent;
      if (confirm(`âŒ XoÃ¡ káº¿t quáº£ cá»§a "${name}"?`)) {
        await deleteDoc(doc(db, "attempts", id));
        tr.remove();
      }
    });
  });
}

// ========== XUáº¤T EXCEL ==========
document.getElementById("exportBtn").addEventListener("click", () => {
  const table = document.querySelector("table");
  let csv = [];
  for (const row of table.rows) {
    const cells = Array.from(row.cells).map(cell => `"${cell.textContent.replace(/"/g, '""')}"`);
    csv.push(cells.join(","));
  }
  const blob = new Blob([csv.join("\n")], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ket_qua_hoc_sinh.csv";
  a.click();
});

// ========== XOÃ Táº¤T Cáº¢ ==========
document.getElementById("deleteAllBtn").addEventListener("click", async () => {
  if (!confirm("âš ï¸ Báº¡n cÃ³ cháº¯c muá»‘n xoÃ¡ TOÃ€N Bá»˜ dá»¯ liá»‡u khÃ´ng?")) return;
  const snap = await getDocs(collection(db, "attempts"));
  let deleted = 0;
  for (const docSnap of snap.docs) {
    await deleteDoc(doc(db, "attempts", docSnap.id));
    deleted++;
  }
  alert(`âœ… ÄÃ£ xoÃ¡ ${deleted} báº£n ghi.`);
  loadResults();
});

// ========== Sá»° KIá»†N ==========
document.getElementById("loadBtn").addEventListener("click", () => loadResults());
document.getElementById("filterBtn").addEventListener("click", () => {
  const val = document.getElementById("filterInput").value.trim();
  loadResults(val);
});

// tá»± Ä‘á»™ng táº£i
loadResults();
</script>
</body>
</html>

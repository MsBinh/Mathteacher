<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>T·ªïng h·ª£p k·∫øt qu·∫£ H·ªôi thi STEM & KHKT - THPT Tr·∫ßn Tr∆∞·ªùng Sinh (v2)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background:#f8f9fa; }
  .container { max-width:1400px; margin-top:30px; margin-bottom:40px; }
  h2,h3 { text-align:center; }
  .section-card { margin-bottom:40px; }
  .table th, .table td { vertical-align: middle; }
  .iqr-header { background:#0066cc; color:white; }
  .loading { text-align: center; padding: 20px; }
  .error { color: red; text-align: center; }
</style>
</head>
<body>
<div class="container">
  <h2 class="text-primary mb-4 fw-bold">üèÜ T·ªîNG H·ª¢P K·∫æT QU·∫¢ H·ªòI THI STEM & KHKT<br>Tr∆∞·ªùng THPT Tr·∫ßn Tr∆∞·ªùng Sinh</h2>
  

  <!-- Loading Indicator -->
  <div id="loading" class="loading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">ƒêang t·∫£i...</span>
    </div>
    <p class="mt-2">ƒêang k·∫øt n·ªëi ƒë·∫øn c∆° s·ªü d·ªØ li·ªáu...</p>
  </div>

  <!-- STEM Section -->
  <div class="section-card card shadow-sm" id="stem-section" style="display: none;">
    <div class="card-header bg-success text-white fw-bold text-center fs-5">üåø K·∫æT QU·∫¢ H·ªòI THI STEM</div>
    <div class="card-body">
      <h5 class="text-success">üìã B·∫£ng ch·∫•m ƒëi·ªÉm chi ti·∫øt</h5>
      <div class="table-responsive mb-4">
        <table class="table table-bordered table-striped" id="stem-detailed">
          <thead class="table-light text-center">
            <tr><th>#</th><th>STT</th><th>T√™n d·ª± √°n</th><th>M√£ GK</th><th>Gi√°m kh·∫£o</th>
            <th>√ù t∆∞·ªüng</th><th>STEM</th><th>Quy tr√¨nh</th><th>S·∫£n ph·∫©m</th>
            <th>Thuy·∫øt tr√¨nh</th><th>Nh√≥m</th><th>T·ªïng</th></tr>
          </thead>
          <tbody><tr><td colspan="12" class="text-center text-muted">ƒêang t·∫£i...</td></tr></tbody>
        </table>
      </div>

      <h5 class="text-success">üèÖ B·∫£ng x·∫øp h·∫°ng theo ƒëi·ªÉm trung b√¨nh</h5>
      <div class="table-responsive mb-4">
        <table class="table table-hover" id="stem-leaderboard">
          <thead class="table-light text-center">
            <tr><th>H·∫°ng</th><th>STT</th><th>T√™n d·ª± √°n</th><th>L∆∞·ª£t ch·∫•m</th><th>ƒêi·ªÉm TB</th></tr>
          </thead>
          <tbody><tr><td colspan="5" class="text-center text-muted">ƒêang t·∫£i...</td></tr></tbody>
        </table>
      </div>

      <h5 class="text-primary">üìà B·∫£ng x·∫øp h·∫°ng sau khi l·ªçc ngo·∫°i l·ªá (IQR)</h5>
      <div class="table-responsive">
        <table class="table table-hover" id="stem-iqr">
          <thead class="iqr-header text-center">
            <tr><th>H·∫°ng</th><th>STT</th><th>T√™n d·ª± √°n</th><th>S·ªë ƒëi·ªÉm h·ª£p l·ªá</th><th>ƒêi·ªÉm TB (IQR)</th></tr>
          </thead>
          <tbody><tr><td colspan="5" class="text-center text-muted">ƒêang t·∫£i...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- KHKT Section -->
  <div class="section-card card shadow-sm" id="science-section" style="display: none;">
    <div class="card-header bg-info text-white fw-bold text-center fs-5">üî¨ K·∫æT QU·∫¢ CU·ªòC THI NGHI√äN C·ª®U KHKT</div>
    <div class="card-body">
      <h5 class="text-info">üìã B·∫£ng ch·∫•m ƒëi·ªÉm chi ti·∫øt</h5>
      <div class="table-responsive mb-4">
        <table class="table table-bordered table-striped" id="science-detailed">
          <thead class="table-light text-center">
            <tr><th>#</th><th>STT</th><th>T√™n d·ª± √°n</th><th>M√£ GK</th><th>Gi√°m kh·∫£o</th>
            <th>C√¢u h·ªèi</th><th>Thi·∫øt k·∫ø</th><th>Th·ª±c hi·ªán</th><th>S√°ng t·∫°o</th>
            <th>Poster</th><th>Ph·ªèng v·∫•n</th><th>T·ªïng</th></tr>
          </thead>
          <tbody><tr><td colspan="12" class="text-center text-muted">ƒêang t·∫£i...</td></tr></tbody>
        </table>
      </div>

      <h5 class="text-info">üèÖ B·∫£ng x·∫øp h·∫°ng theo ƒëi·ªÉm trung b√¨nh</h5>
      <div class="table-responsive mb-4">
        <table class="table table-hover" id="science-leaderboard">
          <thead class="table-light text-center">
            <tr><th>H·∫°ng</th><th>STT</th><th>T√™n d·ª± √°n</th><th>L∆∞·ª£t ch·∫•m</th><th>ƒêi·ªÉm TB</th></tr>
          </thead>
          <tbody><tr><td colspan="5" class="text-center text-muted">ƒêang t·∫£i...</td></tr></tbody>
        </table>
      </div>

      <h5 class="text-primary">üìà B·∫£ng x·∫øp h·∫°ng sau khi l·ªçc ngo·∫°i l·ªá (IQR)</h5>
      <div class="table-responsive">
        <table class="table table-hover" id="science-iqr">
          <thead class="iqr-header text-center">
            <tr><th>H·∫°ng</th><th>STT</th><th>T√™n d·ª± √°n</th><th>S·ªë ƒëi·ªÉm h·ª£p l·ªá</th><th>ƒêi·ªÉm TB (IQR)</th></tr>
          </thead>
          <tbody><tr><td colspan="5" class="text-center text-muted">ƒêang t·∫£i...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div id="error-message" class="alert alert-danger" style="display: none;">
    <h4 class="alert-heading">L·ªói k·∫øt n·ªëi</h4>
    <p id="error-text">Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn c∆° s·ªü d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.</p>
  </div>

</div>

<!-- Firebase App & Firestore -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// C·∫•u h√¨nh Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDDACFZgZazMOnjzmGM_lrKswVcsoTFHxA",
  authDomain: "veonline-3bcbf.firebaseapp.com",
  projectId: "veonline-3bcbf",
  storageBucket: "veonline-3bcbf.firebasestorage.app",
  messagingSenderId: "1097751337006",
  appId: "1:1097751337006:web:8d4e6d9c2b2d4c3d8d4e6d"
};

// Kh·ªüi t·∫°o Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// H√†m ti·ªán √≠ch
function escapeHtml(s) { 
  return s ? s.replace(/[&<>]/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;"}[m])) : ""; 
}

function quantile(arr, q) { 
  if (!arr.length) return 0; 
  const sorted = arr.slice().sort((a, b) => a - b);
  const pos = (sorted.length - 1) * q;
  const base = Math.floor(pos);
  const rest = pos - base;
  
  if (sorted[base + 1] !== undefined) {
    return sorted[base] + (sorted[base + 1] - sorted[base]) * rest;
  } else {
    return sorted[base];
  }
}

// H√†m hi·ªÉn th·ªã d·ªØ li·ªáu
function renderForType(type, projMap, scores) {
  const isStem = type === "STEM";
  const typeName = isStem ? "stem" : "science";
  
  console.log(`üéØ Rendering ${type}: ${scores.length} scores`);

  // L·ªçc scores theo type
  const filteredScores = scores.filter(s => {
    const scoreType = s.type;
    if (isStem) {
      return !scoreType || scoreType === "STEM";
    } else {
      return scoreType === "KHKT";
    }
  });

  console.log(`üìã ${type} filtered scores:`, filteredScores.length);

  // 1Ô∏è‚É£ B·∫£ng chi ti·∫øt
  const tbody = document.querySelector(`#${typeName}-detailed tbody`);
  if (!filteredScores.length) { 
    tbody.innerHTML = `<tr><td colspan="12" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu ch·∫•m ƒëi·ªÉm</td></tr>`; 
  } else {
    tbody.innerHTML = "";
    filteredScores.forEach((score, i) => {
      const project = projMap[score.projectId] || {};
      const title = project.title || "(Kh√¥ng t√™n)";
      const order = project.order || "?";
      const judgeName = score.judgeName || "Kh√¥ng x√°c ƒë·ªãnh";
      const judgeCode = score.judgeCode || "???";
      
      const row = isStem ? 
        `<tr>
          <td>${i + 1}</td><td>${order}</td><td>${escapeHtml(title)}</td>
          <td>${judgeCode}</td><td>${escapeHtml(judgeName)}</td>
          <td>${score.idea || 0}</td><td>${score.applySTEM || 0}</td><td>${score.process || 0}</td>
          <td>${score.product || 0}</td><td>${score.presentation || 0}</td>
          <td>${score.teamwork || 0}</td><td class="fw-bold">${score.total || 0}</td>
        </tr>` :
        `<tr>
          <td>${i + 1}</td><td>${order}</td><td>${escapeHtml(title)}</td>
          <td>${judgeCode}</td><td>${escapeHtml(judgeName)}</td>
          <td>${score.question || 0}</td><td>${score.design || 0}</td><td>${score.implementation || 0}</td>
          <td>${score.creativity || 0}</td><td>${score.poster || 0}</td>
          <td>${score.interview || 0}</td><td class="fw-bold">${score.total || 0}</td>
        </tr>`;
      tbody.innerHTML += row;
    });
  }

  // 2Ô∏è‚É£ B·∫£ng x·∫øp h·∫°ng trung b√¨nh
  const byPid = {};
  filteredScores.forEach(score => {
    const pid = score.projectId;
    if (!byPid[pid]) byPid[pid] = [];
    byPid[pid].push(Number(score.total) || 0);
  });

  const leaderboardList = Object.keys(projMap)
    .map(pid => {
      const project = projMap[pid];
      const scoresArr = byPid[pid] || [];
      const avg = scoresArr.length ? scoresArr.reduce((a, b) => a + b, 0) / scoresArr.length : 0;
      
      return {
        pid,
        order: project.order || 0,
        title: project.title || "",
        cnt: scoresArr.length,
        avg: avg
      };
    })
    .filter(x => x.cnt > 0)
    .sort((a, b) => b.avg - a.avg);

  const lbTbody = document.querySelector(`#${typeName}-leaderboard tbody`);
  lbTbody.innerHTML = "";
  
  if (leaderboardList.length === 0) {
    lbTbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu x·∫øp h·∫°ng</td></tr>`;
  } else {
    leaderboardList.forEach((item, index) => {
      lbTbody.innerHTML += `
        <tr>
          <td>${index + 1}</td>
          <td>${item.order}</td>
          <td>${escapeHtml(item.title)}</td>
          <td>${item.cnt}</td>
          <td class="fw-bold text-success">${item.avg.toFixed(2)}</td>
        </tr>`;
    });
  }

  // 3Ô∏è‚É£ B·∫£ng x·∫øp h·∫°ng IQR
  const iqrTbody = document.querySelector(`#${typeName}-iqr tbody`);
  iqrTbody.innerHTML = "";
  
  const iqrList = [];
  for (const pid in byPid) {
    const scoresArr = byPid[pid].slice().sort((a, b) => a - b);
    
    if (scoresArr.length >= 3) {
      const Q1 = quantile(scoresArr, 0.25);
      const Q3 = quantile(scoresArr, 0.75);
      const IQR = Q3 - Q1;
      const lower = Q1 - 1.5 * IQR;
      const upper = Q3 + 1.5 * IQR;
      
      const filtered = scoresArr.filter(x => x >= lower && x <= upper);
      const avg = filtered.length > 0 ? 
        filtered.reduce((a, b) => a + b, 0) / filtered.length : 
        scoresArr.reduce((a, b) => a + b, 0) / scoresArr.length;
      
      iqrList.push({
        pid,
        order: projMap[pid]?.order || 0,
        title: projMap[pid]?.title || "",
        valid: filtered.length,
        avg: avg
      });
    } else {
      // N·∫øu √≠t h∆°n 3 l∆∞·ª£t ch·∫•m, d√πng trung b√¨nh th√¥ng th∆∞·ªùng
      const avg = scoresArr.reduce((a, b) => a + b, 0) / scoresArr.length;
      iqrList.push({
        pid,
        order: projMap[pid]?.order || 0,
        title: projMap[pid]?.title || "",
        valid: scoresArr.length,
        avg: avg
      });
    }
  }

  iqrList.sort((a, b) => b.avg - a.avg);
  
  if (iqrList.length === 0) {
    iqrTbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu IQR</td></tr>`;
  } else {
    iqrList.forEach((item, index) => {
      iqrTbody.innerHTML += `
        <tr>
          <td>${index + 1}</td>
          <td>${item.order}</td>
          <td>${escapeHtml(item.title)}</td>
          <td>${item.valid}</td>
          <td class="fw-bold text-primary">${item.avg.toFixed(2)}</td>
        </tr>`;
    });
  }
}

// H√†m ch√≠nh ƒë·ªÉ t·∫£i v√† hi·ªÉn th·ªã d·ªØ li·ªáu
async function loadAll() {
  try {
    console.log("üöÄ B·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu...");
    
    // L·∫•y d·ªØ li·ªáu projects
    const projectsSnapshot = await db.collection('projects').get();
    const projects = {};
    projectsSnapshot.forEach(doc => {
      projects[doc.id] = doc.data();
    });
    console.log(`üìÅ ƒê√£ t·∫£i ${Object.keys(projects).length} d·ª± √°n`);

    // L·∫•y d·ªØ li·ªáu scores
    const scoresSnapshot = await db.collection('scores').get();
    const scores = [];
    scoresSnapshot.forEach(doc => {
      scores.push({
        id: doc.id,
        ...doc.data()
      });
    });
    console.log(`üìä ƒê√£ t·∫£i ${scores.length} b·∫£n ch·∫•m ƒëi·ªÉm`);

    // ·∫®n loading, hi·ªÉn th·ªã n·ªôi dung
    document.getElementById('loading').style.display = 'none';
    document.getElementById('stem-section').style.display = 'block';
    document.getElementById('science-section').style.display = 'block';

    // Hi·ªÉn th·ªã cho c·∫£ 2 lo·∫°i
    renderForType("STEM", projects, scores);
    renderForType("KHKT", projects, scores);
    
    console.log("üéâ ƒê√£ render xong t·∫•t c·∫£ d·ªØ li·ªáu!");
    
  } catch (error) {
    console.error("üí• L·ªói trong qu√° tr√¨nh x·ª≠ l√Ω:", error);
    
    // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error-message').style.display = 'block';
    document.getElementById('error-text').textContent = `L·ªói: ${error.message}`;
    
    // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói trong c√°c b·∫£ng
    document.querySelectorAll('tbody').forEach(tbody => {
      if (tbody.innerHTML.includes('ƒêang t·∫£i')) {
        tbody.innerHTML = `<tr><td colspan="12" class="text-center text-danger">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>`;
      }
    });
  }
}

// B·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu khi trang load
document.addEventListener('DOMContentLoaded', loadAll);
</script>
</body>
</html>